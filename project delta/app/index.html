<!DOCTYPE html>
<html>
  <head>
    <!-- k teams are bad -->
    <meta charset="UTF-8">
    <title>Template</title>
    <!-- Load ALL THE THINGS! -->
    <script>window.nodeRequire = require; delete window.require; delete window.exports; delete window.module;</script>
    <script src="jquery/dist/jquery.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href="bootstrap-3.3.7-dist/css/bootstrap.css"></script>
    <script src="bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="mathquill-0.10.1/mathquill.css"></script>
    <script src="mathquill-0.10.1/mathquill.min.js"></script>
    <!-- done with the Loading of ALL THE THINGS! -->
    <style type="text/css">
      .bamboo {
        background-image: url('img/bamboo-wood-texture.jpg');
        background-repeat: no-repeat;
        background-attachment: fixed;
      }
      .hat {
        background: rgba(200, 200, 200, 0.9);
        margin: 0px;
        position: fixed;
        width:16cm;
        top: 30px;
        left:50%;
        margin-left: -8cm;
      }
      .outerpaper{
        margin: auto;
        margin-top: 0;
        margin-bottom: 1cm;
        background-image: url('img/paper-lined.png');
        background-size: 100%;
        width:21cm;
        height:25cm;
        padding-left:3.06cm;
        padding-top:2.69cm;
        padding-right:3.24cm;
      }
      .single-line{
        width:14.7cm;
        height:0.68cm;
        margin:0;
        background-color: rgba(255, 0, 0,0.1);
        font-size: 20px;
      }
      .double-line{
        width:14.7cm;
        height:1.34cm;
        margin:0;
        background-color: rgba(200, 255, 200,1);
        font-size: 40px;
      }
      .top-spacer{
        margin:3cm;
      }
    </style>
  </head>
  <body class ="bamboo">
    <div class="hat">
      <a href="javascript:new_page()"><span>New Page</span></a>
      <h1 class="editable" align="center">Title</h1>
    </div>
    <div class="background"></div>
    <div class="top-spacer"></div>
    <div id="sheets">
    </div>

    <script>
      var mathquillify =(selector)=> {
        var mathFieldSpan = selector
        var MQ = MathQuill.getInterface(2); // for backcompat
        var mathField = MQ.MathField(mathFieldSpan, {
          spaceBehavesLikeTab: true, // configurable
          // handlers: {
            // edit: function() { // useful event handlers
            //   //latexSpan.textContent = mathField.latex(); // simple API
            // }
          // }
        });
        return mathField
      }
      function getCaretCharacterOffsetWithin(element) {
        var caretOffset = 0;
        var doc = element.ownerDocument || element.document;
        var win = doc.defaultView || doc.parentWindow;
        var sel;
        if (typeof win.getSelection != "undefined") {
          sel = win.getSelection();
          if (sel.rangeCount > 0) {
            var range = win.getSelection().getRangeAt(0);
            var preCaretRange = range.cloneRange();
            preCaretRange.selectNodeContents(element);
            preCaretRange.setEnd(range.endContainer, range.endOffset);
            caretOffset = preCaretRange.toString().length;
          }
        } else if ( (sel = doc.selection) && sel.type != "Control") {
          var textRange = sel.createRange();
          var preCaretTextRange = doc.body.createTextRange();
          preCaretTextRange.moveToElementText(element);
          preCaretTextRange.setEndPoint("EndToEnd", textRange);
          caretOffset = preCaretTextRange.text.length;
        }
        return caretOffset;
      }
      (function establish_set_cursor_position($, undefined){
        $.fn.selectRange = function(start, end) {
          return this.each(function() {
            if (this.setSelectionRange) {
              this.focus();
              this.setSelectionRange(start, end);
            } else if (this.createTextRange) {
              var range = this.createTextRange();
              range.collapse(true);
              range.moveEnd('character', end);
              range.moveStart('character', start);
              range.select();
            }
          });
        };
      })(jQuery);
      (function establish_keypress_bind(){
        $("body").on('keypress', function (e) {
          if(e.which === 13 && !e.ctrlKey /*enter*/ ){
            event.preventDefault()
            console.log("ENTER PRESSED:\n\n\nline:"+current_line_number)
            if (current_line_number !== false ) { //this means that a line is selected
              var orig_line = current_page.lines[current_line_number];
              var orig_line_num = current_line_number
              var position = getCaretCharacterOffsetWithin(orig_line.span[0]);
              var left_text= orig_line.span.text().substring(0,position);
              var right_text= orig_line.span.text().substring(position);
              var next_line=current_page.injectline("",orig_line_num)
              console.log("position:"+position+"\nleft: \""+left_text+"\",\nright:\""+right_text+"\"")
              orig_line.span.blur()
              next_line.span.text(right_text).focus();
              orig_line.span.empty().text(left_text);
            }
            //$(this).attr("disabled", "disabled");
          }
          if (e.which == 12 && e.ctrlKey){//mathquillify it
            console.log("M")
            if (current_line_number !== false ) {
              console.log("Q")
              var line = current_page.lines[current_line_number];
              line.span.text("").attr("contentEditable",false)
              line.MQ = mathquillify(line.span[0])
              // setTimeout(()=>{line.MQ.focus()},0)
              line.MQ.focus()
            }
          }
        });
      })();
      var current_line_number=false
      var current_page=false
      var pages = [];
      var make_editable =(dom)=>{
        dom.bind('click', function() {
          $(this).focus()
        })
        dom.attr("contentEditable",true)
      }
      function InjectLineAfter(line_x_dom){//todo: separate span and div
        var tempid = Math.floor(Math.random()*Math.pow(2,16))
        line_x_dom.after('<div align="left" class="id'+tempid+' single-line"></div>')
        this.dom = $(".id"+tempid);
        this.dom.removeClass("id"+tempid)
        this.dom.append("<span class='editable id"+tempid+"'></span>")
        this.span=$(".id"+tempid);
        this.span.removeClass("id"+tempid)
        make_editable(this.span)
      }
      function Line(dom){//todo: separate span and div
        var tempid = Math.floor(Math.random()*Math.pow(2,16))
        dom.append('<div align="left" class="id'+tempid+' single-line"></div>')
        this.dom = $(".id"+tempid);
        this.dom.removeClass("id"+tempid)
        this.dom.append("<span class='editable id"+tempid+"'></span>")
        this.span=$(".id"+tempid);
        this.span.removeClass("id"+tempid)
        make_editable(this.span)
      }
      function Page(){
        var tempid = Math.floor(Math.random()*Math.pow(2,16))
        $("#sheets").append('<div class="id'+tempid+' outerpaper" align="center"><div class="innerpaper" align="left">')
        this.dom=$(".id"+tempid)
        this.dom.removeClass("id"+tempid)
        this.lines=[];
/**/    this.injectline=(type,original_line_number)=>{
          var this_line = new InjectLineAfter(this.lines[original_line_number].dom);
          this.lines.splice(original_line_number+1, 0, this_line)
          if (this_line!=this.lines[original_line_number+1]) {
            throw "error in array splicing!"
          }
          var line_dom = this_line.span;
          this_line.getNumber=()=>(
            this_page.lines.indexOf(this_line)
          )
          var this_page= this;
          this_line.set_active = function() {
            current_line_number=this_line.getNumber()
            console.log("focus: "+this_line.getNumber())
            current_page=this_page;
          }
          this_line.set_inactive = function() {
            self_line_number=this_line.getNumber()
            console.log(self_line_number)
            if(current_line_number==self_line_number){
              console.log("de focus: "+current_line_number)
              current_line_number=false;
            };
          }
          this_line.bind=function(){
            this.span.bind('focus',this_line.set_active);
            this.span.bind('blur',this_line.set_inactive);
          };this_line.bind()
          return this_line
        }
        this.addline=(type)=>{
          this.lines.push(new Line(this.dom))
          var this_line=this.lines[this.lines.length-1]
          var line_dom = this_line.span;
          this_line.getNumber=()=>(
            this_page.lines.indexOf(this_line)
          )
          var this_page= this;
          this_line.set_active = function() {
            current_line_number=this_line.getNumber()
            console.log("focus: "+current_line_number)
            current_page=this_page;
          }
          this_line.set_inactive = function() {
            self_line_number=this_line.getNumber()
            console.log(self_line_number)
            if(current_line_number==self_line_number){
              console.log("de focus: "+current_line_number)
              current_line_number=false;
            };
          }
          this_line.bind=function(){
            this.span.bind('focus',this_line.set_active);
            this.span.bind('blur',this_line.set_inactive);
          };this_line.bind()
        }
        this.addline();
        this.lines[0].span.focus()
      }
      var new_page =()=>{
        pages.push(new Page())
      }
      var insert_line_on_page =(page_num)=>{
        var line_num = pages[page_num].internal_divs.length;
        pages[page_num].dom.append('<div align="left" id="pg'+page_num+'ln'+line_num+'" class="editable single-line"><span></span></div>')
        var line_dom = $('#pg'+page_num+'ln'+line_num)
        pages[page_num].internal_divs.push({dom:line_dom,internal_spans:[]})
        make_editable(line_dom)
      }
      make_editable($(".editable"))
      //bind enter key to look for focused element
      //$(':focus');
    </script>
    <script>
      mathquillify(document.getElementById('math-field'));
    </script>
  </body>
</html>
