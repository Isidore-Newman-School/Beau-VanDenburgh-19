var Bb = Backbone,
    Bbc = Backbone.Collection,
    Bbm = Backbone.Model,
    Hb = Handlebars;
(function(b) {
    var k = p3.module("shared/task"),
        c = p3.module("LMS/assignment"),
        e = p3.module("gradebook"),
        l = p3.module("LMS/topic"),
        i = p3.module("LMS/roster"),
        j = p3.module("schedule"),
        h = p3.module("report"),
        f = p3.module("grading"),
        a = p3.module("LMS/shared/academiccalendar"),
        g = p3.module("LMS/groupPageEdit"),
        d = p3.module("faculty/courserecommendations");
    b.Data = {};
    b.Pages = [{
        Id: 1,
        ContentId: 433,
        Label: "Bulletin Board",
        RoutePage: "bulletinboard",
        IconClass: "p3icon-page",
        HTMLID: "bulletin-board-btn",
        LinkId: "bulletin-board-link",
        Display: function(m) {
            var n = new g.Vs.LayoutView({
                sectionId: b.Data.sectionId,
                leadSectionId: b.Data.leadSectionId,
                content: b.Data.contentTypes,
                userHasFullAccess: b.Data.userHasFullAccess,
                isOwner: b.Data.IsOwner,
                isManager: b.Data.isManager,
                associationId: 1,
                contextLabelId: 2,
                preview: false,
                layoutId: b.Data.layoutId,
                pendingInd: false
            });
            p3.rV(n, m, true)
        },
        Active: true
    }, {
        Id: 2,
        ContentId: 386,
        Label: "Topics",
        RoutePage: "topics",
        IconClass: "p3icon-topics",
        HTMLID: "topics-btn",
        LinkId: "topics-link",
        Display: function(m) {
            p3.rV(new l.Vs.TopicManageView({
                sectionId: b.Data.sectionId,
                leadSectionId: b.Data.leadSectionId,
                active: true,
                future: false,
                expired: false,
                userHasFullAccess: b.Data.userHasFullAccess,
                isOwner: b.Data.IsOwner,
                isManager: b.Data.isManager,
                content: b.Data.contentTypes,
                levelNum: b.Data.levelNum || -1,
                durationId: b.Data.durationId,
                schoolYearLabel: b.Data.schoolYear,
                contextLabelId: 2,
                studentId: b.Data.studentId
            }), m, true)
        },
        Active: false
    }, {
        Id: 3,
        ContentId: 58,
        Label: "Assignments",
        RoutePage: "assignments",
        IconClass: "p3icon-assignments",
        HTMLID: "assignments-btn",
        LinkId: "assignments-link",
        Display: function(n) {
            var m = function() {
                var o = p3.Data.Context.getSelectedPersona().Id;
                if (o === 3 || o === 5 || o === 6) {
                    p3.rV(new c.Vs.ClassAssignmentView({
                        sectionId: b.Data.sectionId,
                        leadSectionId: b.Data.leadSectionId,
                        userHasFullAccess: b.Data.userHasFullAccess,
                        isOwner: b.Data.IsOwner,
                        isManager: b.Data.isManager,
                        content: b.Data.contentTypes
                    }), n, true)
                } else {
                    if (o === 2 || o === 1) {
                        p3.rV(new c.Vs.ClassAssignmentStudentView({
                            sectionId: b.Data.sectionId,
                            leadSectionId: b.Data.leadSectionId,
                            studentId: b.Data.studentId
                        }), n, true)
                    }
                }
            };
            h.loadReportList2(m, m)
        },
        Active: false
    }, {
        Id: 4,
        ContentId: 118,
        Label: "Grade Book",
        RoutePage: "gradebook",
        IconClass: "p3icon-gradebook",
        HTMLID: "grade-book-btn",
        LinkId: "grade-book-link",
        Display: function(m) {
            e.Us.OpenGradebook(b.Data.leadSectionId)
        },
        Active: false
    }, {
        Id: 5,
        ContentId: 87,
        Label: "Schedule",
        RoutePage: "schedule",
        IconClass: "p3icon-schedule",
        HTMLID: "schedule-btn",
        LinkId: "schedule-link",
        Display: function(m) {
            p3.rV(new j.Vs.MySchedule({
                data: aP + "DataDirect/ScheduleListSection/?format=json&sectionId=" + b.Data.leadSectionId + "&viewerPersonaId=" + p3.Data.Context.getSelectedPersona().Id,
                scheduleSectionId: b.Data.leadSectionId
            }), m, false)
        },
        Active: false
    }, {
        Id: 6,
        ContentId: 120,
        Label: "Grading",
        RoutePage: "grading",
        IconClass: "p3icon-grading",
        HTMLID: "grading-btn",
        LinkId: "grading-link",
        Display: function(m) {
            p3.rV(new f.Vs.LayoutView({
                sectionId: b.Data.leadSectionId,
                nonLeadsectionId: b.Data.sectionId
            }), m, true)
        },
        Active: false
    }, {
        Id: 7,
        ContentId: 434,
        Label: "Roster",
        RoutePage: "roster",
        IconClass: "p3icon-roster",
        HTMLID: "roster-btn",
        LinkId: "roster-link",
        Display: function(m) {
            p3.rV(new i.Vs.RosterView({
                sectionId: b.Data.sectionId,
                leadSectionId: b.Data.leadSectionId,
                durationId: b.Data.durationId,
                associationId: 1,
                enableSearch: true,
                isOwner: b.Data.IsOwner
            }), m, true)
        },
        Active: false
    }, {
        Id: 8,
        ContentId: 45,
        Label: "Calendar",
        RoutePage: "calendar",
        Hidden: true,
        Display: function(m) {
            p3.rV(new a.Vs.Calendar({
                leadSectionId: b.Data.leadSectionId,
                isOwner: b.Data.IsOwner,
                isManager: b.Data.isManager,
                hasFullAccess: b.Data.userHasFullAccess,
                schoolYear: b.Data.schoolYear,
                containerName: b.Data.containerName
            }), m, true)
        },
        Active: false
    }, {
        Id: 9,
        ContentId: 111,
        Label: "Course Recommendations",
        RoutePage: "courserecommendations",
        IconClass: "p3icon-courseRequest",
        Display: function(m) {
            p3.rV(new d.Vs.LayoutView({
                sectionId: b.Data.leadSectionId,
                sectionName: b.Data.className
            }), m, true)
        },
        Active: false
    }];
    b.Ms.Section = Bbm.extend({
        url: function() {
            return ""
        }
    });
    b.Cs.Section = Bbc.extend({
        model: b.Ms.Section,
        initialize: function(m, n) {
            this.sectionId = n.sectionId || 0
        },
        url: function() {
            return aP + "datadirect/SectionInfoView/?format=json&sectionId=" + this.sectionId + "&associationId=1"
        }
    });
    b.Ms.Content = Bbm.extend({
        idAttribute: "ContentId",
        url: function() {
            return ""
        }
    });
    b.Cs.Content = Bbc.extend({
        model: b.Ms.Content,
        initialize: function(m, n) {
            this.sectionId = n.sectionId || 0;
            this.leadSectionId = n.leadSectionId || 0
        },
        url: function() {
            return aP + "datadirect/GroupPossibleContentGet/?format=json&leadSectionId=" + this.leadSectionId
        }
    });
    b.Data = {};
    b.Data.leadSectionId = 0;
    b.Data.durationId = 0;
    b.Data.sectionId = 0;
    b.Data.contentTypes = null;
    b.Data.MainViewRendered = false;
    b.Data.RenderedSectionId = 0;
    b.Data.teacherId = 0;
    b.Data.schoolYear = "";
    b.Data.containerName = "Calendar";
    b.Vs.MainClassView = Bb.View.extend({
        template: "academicclass/academicclassmainview.template.html",
        initialize: function(m) {
            this.Containers = {};
            if (m) {
                b.Data.sectionId = b.Data.RenderedSectionId = this.SectionId = m.SectionId
            } else {
                b.Data.sectionId = b.Data.RenderedSectionId = this.SectionId = 0
            }
            b.Data.MainViewRendered = true
        },
        dispose: function() {
            b.Data.MainViewRendered = false
        },
        render: function(m) {
            var n = this;
            p3.fT(n.template, function(p) {
                n.$el.html(p({}));
                $(m).html(n.el);
                n.Containers.Navigation = $("#academicclassnavmenu");
                n.Containers.MainContent = $("#academicclassmaincontainer");
                var o = new b.Cs.Section({}, {
                    sectionId: n.SectionId
                });
                p3.rV(new b.Vs.NavigationView({
                    ParentView: n,
                    collection: o
                }), n.Containers.Navigation, false);
                o.fetch({
                    error: function() {
                        p3.displayError("Error loading section information")
                    }
                })
            })
        }
    });
    b.Vs.NavigationView = Bb.View.extend({
        template: "academicclass/academicclassnavigationmenu.template.html",
        initialize: function(m) {
            this.collection.bind("reset change", this.renderTemplate, this);
            this.Containers = {};
            if (m) {
                this.ParentView = m.ParentView
            }
            this.enableScrollNav()
        },
        dispose: function() {
            this.disableScrollNav()
        },
        renderTemplate: function() {
            var H = this,
                F, s, E, t, m, D, q, z, A, y, x, r, G, u, v, w, p, C, o = false,
                n, B = [];
            H.collection.each(function(I) {
                if (I.get("Id") === parseInt(b.Data.sectionId, 10)) {
                    F = I.get("Teacher");
                    s = I.get("GroupName");
                    t = I.get("Identifier");
                    if (I.get("Block") !== "Random") {
                        m = I.get("Block")
                    }
                    D = I.get("Room");
                    q = I.get("Duration");
                    r = I.get("DurationId");
                    p = I.get("Description");
                    z = I.get("Level");
                    A = I.get("LevelNum");
                    E = I.get("SchoolYear");
                    if (I.get("Length") === 1) {
                        y = "1 Term"
                    } else {
                        y = I.get("Length") + " Terms"
                    }
                    F = I.get("Teacher");
                    x = I.get("LeadSectionId");
                    v = I.get("IsOwner");
                    u = I.get("IsManager");
                    G = I.get("TeacherId");
                    w = I.get("LayoutId")
                }
            });
            b.Data.className = s;
            b.Data.IsOwner = v;
            b.Data.leadSectionId = x;
            b.Data.durationId = r;
            b.Data.teacherId = G;
            b.Data.levelNum = A;
            b.Data.schoolYear = E;
            C = p3.Data.Context.getSelectedPersona().Id;
            b.Data.isManager = u;
            b.Data.userHasFullAccess = (C === 3 && b.Data.IsOwner) || b.Data.isManager;
            b.Data.layoutId = w;
            if (F !== "" || t || m || D || q || r || p || z || y) {
                o = true
            }
            n = new b.Cs.Content({}, {
                sectionId: b.Data.sectionId,
                leadSectionId: b.Data.leadSectionId
            });
            n.fetch({
                error: function() {
                    p3.displayError("Error loading available content")
                },
                success: function() {
                    b.Data.contentTypes = n;
                    n.each(function(K) {
                        var J = K.get("ContentId"),
                            L = true,
                            N, M = _.find(b.Pages, function(O) {
                                return O.ContentId === J
                            });
                        L = K.get("ShowContentType");
                        if (L & J === 386) {
                            L = b.Data.userHasFullAccess || K.get("EditorAccess");
                            if (!L) {
                                N = new l.Cs.Topic({}, {
                                    sectionId: 0,
                                    leadSectionId: b.Data.leadSectionId,
                                    active: true,
                                    future: false,
                                    expired: false
                                });
                                N.fetch({
                                    async: false,
                                    success: function() {
                                        if (N.length > 0) {
                                            L = true
                                        }
                                    },
                                    error: function() {
                                        p3.displayError("Error loading topics")
                                    }
                                })
                            }
                        }
                        if (M && L) {
                            B.push({
                                sort: M.Id,
                                title: M.Label,
                                iconClass: M.IconClass,
                                status: M.Active ? "active" : "inactive",
                                link: k.Us.getUrlById(1853, b.Data.sectionId + "/" + (b.Data.studentId || 0) + "/" + M.RoutePage),
                                pId: M.Id,
                                HTMLID: M.HTMLID,
                                LinkId: M.LinkId
                            });
                            M.Enabled = true;
                            if (J === 58) {
                                M = _.find(b.Pages, function(O) {
                                    return O.ContentId === 45
                                });
                                if (M) {
                                    M.Enabled = true
                                }
                            }
                        } else {
                            if (M) {
                                M.Enabled = false
                            }
                        }
                    });
                    B = _.sortBy(B, "sort");
                    p3.fT(H.template, function(J) {
                        H.$el.html(J({
                            Info: o,
                            Teacher: F,
                            GroupName: s,
                            Identifier: t,
                            Block: m,
                            Room: D,
                            Duration: q,
                            Level: z,
                            Length: y,
                            Description: p,
                            navigationItems: B
                        }))
                    });
                    var I = _.find(b.Pages, function(J) {
                        return J.Active
                    });
                    if (I && I.Enabled) {
                        I.Display($("#academicclassmaincontainer"))
                    }
                }
            });
            return this
        },
        events: {
            "click #section-description-toggle": "toggleDescription",
            "click [data-pid]": "switchTab"
        },
        render: function(m) {
            $(m).append(this.el);
            return this
        },
        toggleDescription: function(n) {
            var m = $("#section-description-content");
            if (m) {
                if (m.filter(":visible").length) {
                    m.hide(400)
                } else {
                    m.show(400)
                }
            }
            return false
        },
        switchTab: function(m) {
            if ($(m.currentTarget).attr("data-pid") === "4") {
                _.find(b.Pages, function(n) {
                    return n.Id === 4
                }).Display();
                return false
            }
        },
        enableScrollNav: function(o) {
            var n = $(document),
                m = $(".subnavbar"),
                p = m.length && m.offset().top - 101;

            function q() {
                if (m.length === 0) {
                    m = $(".subnavbar");
                    p = m.length && m.offset().top - 101
                }
                var s = n.scrollTop(),
                    r = m.hasClass("subnavbar-fixed");
                if (s >= p && !r) {
                    m.addClass("subnavbar-fixed")
                } else {
                    if (s <= p && r) {
                        m.removeClass("subnavbar-fixed")
                    }
                }
            }
            n.on("scroll", q)
        },
        disableScrollNav: function(n) {
            var m = $(document);
            m.off("scroll")
        }
    });
    b.Us.LoadPage = function(m, p, o) {
        b.Data.studentId = p || undefined;
        p3.loadingIcon("#academicclassmaincontainer");
        var n;
        _.each(b.Pages, function(q) {
            if (q.RoutePage.toLowerCase() === o.toLowerCase()) {
                q.Active = true;
                n = q
            } else {
                q.Active = false
            }
        });
        if (!b.Data.MainViewRendered || b.Data.RenderedSectionId !== m) {
            p3.renderMainPage(new b.Vs.MainClassView({
                SectionId: m
            }))
        } else {
            if (n && n.Enabled) {
                n.Display($("#academicclassmaincontainer"));
                b.Us.SwitchTabs(n)
            }
        }
    };
    b.Us.SwitchTabs = function(n) {
        var m = (p3.Config.uiVersion === 1) ? $(".nav-pills").children() : $(".nav-tabs").children();
        $.each(m, function() {
            var o = $(this);
            if (o.data("pid") === n.Id || (n.Id === 8 && o.data("pid") === 3)) {
                o.removeClass("inactive");
                o.addClass("active")
            } else {
                if (o.hasClass("active")) {
                    o.removeClass("active");
                    o.addClass("inactive")
                }
            }
        })
    };
    p3.router().route("academicclass/:id", "academicclass", function(m) {
        if (m.indexOf("&pk=") > -1) {
            m = m.substring(4)
        }
        b.Us.LoadPage(m, p3.Data.Context.get("UserInfo").UserId, "bulletinboard")
    });
    p3.router().route("academicclass/:id/:studentId/:page", "academicclasspage", b.Us.LoadPage)
}(p3.module("LMS/academicclass")));
(function(a) {
    var d = p3.module("cms/shared/download"),
        c = p3.module("shared/datepicker"),
        f = p3.module("cms/shared/grouppublish"),
        e = p3.module("shared/fileselection"),
        b = p3.Us.Culture;
    a.Ms.AcademicContent = Bbm.extend({
        idAttribute: "Id",
        url: function() {
            return ""
        }
    });
    a.Cs.AcademicContent = Bbc.extend({
        model: a.Ms.AcademicContent,
        initialize: function(g, h) {
            this.sectionId = h.sectionId || 0;
            this.leadSectionId = h.leadSectionId || 0;
            this.contentId = h.contentId;
            this.active = h.active;
            this.future = h.future;
            this.expired = h.expired
        },
        url: function() {
            var g = "";
            switch (this.contentId) {
                case 78:
                    g = "syllabus";
                    break;
                case 79:
                    g = "gradingrubric";
                    break;
                case 80:
                    g = "expectation";
                    break
            }
            return aP + g + "/forsection/" + this.leadSectionId + "/?format=json&active=" + this.active + "&future=" + this.future + "&expired=" + this.expired
        }
    });
    a.Ms.AcademicContentIndex = Bbm.extend({
        idAttribute: "Id",
        url: function() {
            return ""
        }
    });
    a.Cs.AcademicContentIndex = Bbc.extend({
        model: a.Ms.AcademicContentIndex,
        initialize: function(g, h) {
            this.Id = h.Id || 0;
            this.contentId = h.contentId || 0
        },
        url: function() {
            var g = "";
            switch (this.contentId) {
                case "78":
                    g = "SyllabusIndexGet";
                    break;
                case "79":
                    g = "GradingRubricIndexGet";
                    break;
                case "80":
                    g = "ExpectationIndexGet";
                    break
            }
            return aP + "datadirect/" + g + "/?format=json&Id=" + this.Id
        }
    });
    a.Ms.AcademicContentSave = Bbm.extend({
        idAttribute: "Id",
        url: function() {
            var h = "",
                g = "";
            if (this.get("Id") === 0) {
                h = "create"
            } else {
                h = "update"
            }
            switch (this.get("contentId")) {
                case 78:
                    g = "syllabus";
                    break;
                case 79:
                    g = "gradingrubric";
                    break;
                case 80:
                    g = "expectation";
                    break
            }
            return aP + g + "/" + h + "/?format=json"
        }
    });
    a.Ms.AcademicContentDelete = Bbm.extend({
        idAttribute: "Id",
        url: function() {
            var g = "";
            switch (this.get("contentId")) {
                case "78":
                    g = "syllabus";
                    break;
                case "79":
                    g = "gradingrubric";
                    break;
                case "80":
                    g = "expectation";
                    break
            }
            return aP + g + "/delete/" + this.get("Id") + "/?format=json&filename=" + this.get("FileName") + "&sectionId=" + this.get("SectionId")
        }
    });
    a.Vs.AcademicContentView = Bb.View.extend({
        template: "classpage/basecontent.template.html",
        events: {
            "click input": "refreshContent",
            "click .academic-edit-button": "openEditModal",
            "click .academic-content-add": "openAddModal",
            "click .academic-delete-button": "openDeleteModal",
            "click #syll-show-all": "toggleItems",
            "click #grad-show-all": "toggleItems",
            "click #expe-show-all": "toggleItems"
        },
        renderTemplate: function() {
            var i = this,
                g = i.collection.length > 0,
                j = false,
                h = -1;
            if (g) {
                i.collection.each(function(k) {
                    h += 1;
                    k.set("index", h);
                    if (h < 3) {
                        k.set("hide", false)
                    } else {
                        k.set("hide", true)
                    }
                })
            }
            if (i.collection.length > 3) {
                j = true
            }
            if (i.options.groupPageEdit) {
                i.template = "grouppage/academiccontent.manage.template.html"
            }
            p3.fT(i.template, function(k) {
                i.$el.html(k({
                    collection: i.collection.toJSON(),
                    header: i.options.header,
                    manageTask: i.options.manageTask,
                    haveData: g,
                    prefix: i.options.prefix,
                    viewMode: i.options.editMode === false,
                    active: i.options.active,
                    future: i.options.future,
                    expired: i.options.expired,
                    contentId: i.options.contentId,
                    canEdit: i.options.canEdit,
                    showViewAll: j,
                    expanded: i.options.expanded,
                    customHeader: i.options.customHeader
                }))
            })
        },
        initialize: function() {
            this.collection.bind("reset", this.renderTemplate, this)
        },
        render: function(g) {
            $(g).append(this.el)
        },
        refreshContent: function() {
            a.Us.refreshContent(true, 0, this.collection.leadSectionId, this)
        },
        openEditModal: function(i) {
            var l = this,
                k = i.currentTarget.attributes.getNamedItem("data-id").value,
                g = i.currentTarget.attributes.getNamedItem("data-contentid").value,
                h = l.collection.get(k),
                j = new a.Cs.AcademicContentIndex({}, {
                    Id: k,
                    contentId: g
                });
            j.fetch({
                success: function() {
                    j.each(function(n) {
                        n.set("ContextLabelId", 2)
                    });
                    var m = new a.Cs.AcademicContent({}, {
                        Id: k,
                        contentId: g
                    });
                    m = f.Us.buildPublishGroupList(l.options.sections, j, 2);
                    l.showDialog(k, h, m)
                },
                error: function() {
                    p3.displayError("Error loading academic content index")
                }
            });
            return false
        },
        openAddModal: function(h) {
            var g = new a.Ms.AcademicContent({
                Id: 0,
                FileName: ""
            });
            this.showDialog(0, g, this.options.sections);
            return false
        },
        openDeleteModal: function(j) {
            var m = this,
                l = j.currentTarget.attributes.getNamedItem("data-id").value,
                i = m.collection.get(l),
                h = j.currentTarget.attributes.getNamedItem("data-contentid").value,
                k = new a.Cs.AcademicContentIndex({}, {
                    Id: l,
                    contentId: h
                }),
                g = "";
            switch (this.contentId) {
                case "78":
                    g = "Syllabus";
                    break;
                case "79":
                    g = "Grading Rubric";
                    break;
                case "80":
                    g = "Expectations";
                    break
            }
            k.fetch({
                success: function() {
                    var n = k.length > 1;
                    p3.rV(new a.Vs.AcademicContentDeleteView({
                        groups: k,
                        showRadios: n,
                        contentView: m,
                        Id: l,
                        FileName: i.get("Attachment"),
                        Content: g,
                        contentId: h
                    }), p3.Layout.Containers.Modal, true);
                    p3.showModal(p3.Layout.Containers.Modal, {})
                },
                error: function() {
                    p3.displayError("Error loading academic content index")
                }
            });
            return false
        },
        showDialog: function(h, g, j) {
            var k = this,
                i = b.getDateString(b.localDateTime());
            p3.rV(new a.Vs.AcademicContentEditView({
                Id: h,
                contentItem: g,
                leadSectionId: k.options.leadSectionId,
                sections: j,
                defaultDate: i,
                contentView: k
            }), p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal)
        },
        toggleItems: function(h) {
            var j = h.currentTarget.id,
                g = "",
                i = false;
            switch (j) {
                case "syll-show-all":
                    g = ".syll-region.initial-hide";
                    break;
                case "grad-show-all":
                    g = ".grad-region.initial-hide";
                    break;
                case "expe-show-all":
                    g = ".expe-region.initial-hide";
                    break
            }
            if ($("#" + j).hasClass("show-data")) {
                i = true;
                $("#" + j).removeClass("show-data").addClass("hide-data").html("Show Less");
                $(g).show()
            } else {
                $("#" + j).removeClass("hide-data").addClass("show-data").html("Show All");
                $(g).hide()
            }
            this.options.expanded = i;
            this.trigger("showAll", i)
        }
    });
    a.Vs.AcademicContentEditView = Bb.View.extend({
        template: "academiccontent/academiccontent.edit.template.html",
        events: {
            "click #btnSaveContent": "startContentSave",
            "click #btnSaveAddContent": "startContentSave",
            "change #tb-content-title": "removeValidation",
            "click #btnRemoveFile": "removeFile",
            initPlugins: "initializePlugins",
            templateDone: "renderGroups"
        },
        initialize: function(g) {
            p3.Layout.Containers.Modal.on("hide.contentEdit", function() {
                if (tinyMCE !== undefined) {
                    tinyMCE.execCommand("mceRemoveControl", false, "fldDescription")
                }
                p3.Layout.Containers.Modal.off("hide.contentEdit")
            });
            _.bindAll(this, "finishContentSave", "reflectProcessing")
        },
        dispose: function() {
            var g = tinyMCE.get("fldDescription");
            if (g) {
                g.remove()
            }
        },
        render: function(g) {
            var h = this;
            $(g).append(this.el);
            h.fileSelectionController = new e.Ms.Controller({
                GoogleDriveAllowed: true,
                GoogleLinksPermitted: false,
                ReplaceFile: true,
                VisibleFileLimit: true,
                ReflectProcessingCallback: h.reflectProcessing,
                UniqueId: 1
            });
            h.fileSelectionController.loadSettings(function() {
                h.renderTemplate()
            })
        },
        renderTemplate: function() {
            var g = this;
            p3.fT(g.template, function(k) {
                var h, i = "",
                    j;
                if (g.options.sections.length > 0) {
                    g.options.sections.each(function(l) {
                        if (g.options.contentItem.get("Id") > 0) {
                            if (l.get("IsSelected")) {
                                var m;
                                if (l.get("PublishDate")) {
                                    m = l.get("PublishDate").split(" ");
                                    l.set("PublishDate", m[0])
                                }
                                if (l.get("ExpireDate")) {
                                    m = l.get("ExpireDate").split(" ");
                                    l.set("ExpireDate", m[0])
                                }
                            }
                        }
                    })
                }
                switch (g.options.contentView.options.contentId) {
                    case 78:
                        i = "Syllabus";
                        break;
                    case 79:
                        i = "Grading Rubric";
                        break;
                    case 80:
                        i = "Expectations";
                        break
                }
                g.$el.html(k({
                    Id: g.options.Id,
                    contentItem: g.options.contentItem.toJSON(),
                    groups: g.options.sections.toJSON(),
                    defaultDate: g.options.defaultDate,
                    Header: i
                }));
                j = (g.options.Id > 0);
                g.groupView = new f.Vs.PublishView({
                    groups: g.options.sections,
                    showPublish: true,
                    showExpire: true,
                    isEdit: j,
                    contentId: g.options.contentView.options.contentId,
                    defaultDate: g.options.defaultDate
                });
                if (j && g.options.contentItem.get("Attachment").length > 0) {
                    h = new e.Ms.File();
                    h.populateWithExistingFile(g.options.contentItem.get("Attachment"), 0, 1);
                    g.fileSelectionController.Files.push(h)
                }
                e.Us.RenderFileSelection(g.fileSelectionController, g.$(".fs-input-container"), g.$(".fs-output-container"), g);
                g.$el.trigger($.Event("initPlugins"));
                g.$el.trigger($.Event("templateDone"))
            })
        },
        renderGroups: function() {
            var g = this;
            p3.rV(g.groupView, $("#groups-container"), true);
            p3.setModalHeight(p3.Layout.Containers.Modal)
        },
        initializePlugins: function(g) {
            var h = this;
            window.setTimeout(function() {
                p3.showHtmlEditor("fldDescription", p3.Us.Enum.HtmlEditorCategories.FULL, false, undefined, p3.Us.Enum.HtmlEditorEncoding.NUMERIC)
            }, 200);
            c.Us.LoadPreSelDatePickers(h.options.sections.toJSON())
        },
        removeValidation: function(g) {
            $(".content-title").removeClass("error")
        },
        reflectProcessing: function(g) {
            var h = this;
            if (g) {
                h.$("#btnSaveContent").button("loading");
                h.$("#btnSaveAddContent").button("loading");
                h.$("div.alert-error").remove()
            } else {
                h.$("#btnSaveContent").button("reset");
                h.$("#btnSaveAddContent").button("reset")
            }
        },
        startContentSave: function(g) {
            var k = this,
                j = true,
                i = "",
                h = tinyMCE.get("fldDescription");
            if (h) {
                h.save()
            }
            k.addNew = (g.target.id === "btnSaveAddContent");
            k.groups = [];
            k.saveModel = new a.Ms.AcademicContentSave({
                Id: k.options.Id,
                contentId: k.options.contentView.options.contentId
            });
            k.fileSelectionController.beginProcessing();
            if ($("#tb-content-title").val().length === 0) {
                j = false;
                $(".content-title").addClass("error")
            }
            if (j) {
                j = k.groupView.getSelectedGroupArray();
                if (j) {
                    k.groups = k.groupView.selectedArray
                } else {
                    i = k.groupView.errorMessage
                }
            }
            if (j) {
                k.fileSelectionController.requestFiles(k.finishContentSave)
            } else {
                if (i.length > 0) {
                    p3.Us.InfoMessage.ErrorBox(i, ".modal-body", false)
                }
                k.fileSelectionController.endProcessing()
            }
        },
        finishContentSave: function(m, g) {
            var n = this,
                l = "",
                i, j, h, k;
            if (!m) {
                l = "Error processing the file attachment"
            } else {
                if (g.length > 0 && g.models[0].getFileAdded() === true) {
                    i = g.models[0].getTempFileName();
                    h = i.lastIndexOf(".");
                    n.saveModel.set("Attachment", i);
                    n.saveModel.set("AttachmentExtension", i.substring(h));
                    if (!p3.Data.fileTypes) {
                        k = new d.Cs.FileTypes({}, {});
                        p3.Data.fileTypes = k;
                        k.fetch({
                            async: false,
                            error: function() {
                                p3.displayError("Error loading filetypes")
                            }
                        })
                    }
                    j = p3.Data.fileTypes.get(n.saveModel.get("AttachmentExtension"));
                    if (j) {
                        n.saveModel.set("SaveAttachment", true);
                        n.saveModel.set("OriginalAttachment", n.options.contentItem.get("Attachment"))
                    } else {
                        p3.Us.InfoMessage.ErrorBox("The selected file type is not valid", ".modal-body", true);
                        m = false
                    }
                } else {
                    if (g.length === 0) {
                        if (n.options.contentItem.get("Attachment")) {
                            n.saveModel.set("DeleteAttachment", true);
                            n.saveModel.set("Attachment", n.options.contentItem.get("Attachment"))
                        }
                    }
                }
            }
            if (m) {
                n.saveModel.set({
                    ShortDescription: $("#tb-content-title").val(),
                    Description: $("#fldDescription").val(),
                    Groups: n.groups
                });
                n.saveModel.save({}, {
                    error: function() {
                        p3.showModal(p3.Layout.Containers.Modal, "hide");
                        p3.displayError("Error saving Academic Content")
                    },
                    success: function() {
                        if (n.addNew) {
                            var o = new a.Ms.AcademicContent({
                                    Id: 0,
                                    contentId: n.saveModel.get("contentId")
                                }),
                                p = b.getDateString(b.localDateTime());
                            p3.rV(new a.Vs.AcademicContentEditView({
                                Id: 0,
                                contentItem: o,
                                leadSectionId: n.options.contentView.collection.leadSectionId,
                                sections: n.options.contentView.options.sections,
                                defaultDate: p,
                                contentView: n.options.contentView
                            }), p3.Layout.Containers.Modal, true);
                            c.Us.initialize(".dp-non-pre-pop");
                            p3.showHtmlEditor("fldDescription", p3.Us.Enum.HtmlEditorCategories.FULL, false, undefined, p3.Us.Enum.HtmlEditorEncoding.NUMERIC);
                            p3.setModalHeight(p3.Layout.Containers.Modal)
                        } else {
                            p3.showModal(p3.Layout.Containers.Modal, "hide")
                        }
                        a.Us.refreshContent(true, 0, n.options.contentView.collection.leadSectionId, n.options.contentView)
                    }
                })
            } else {
                if (l.length > 0) {
                    p3.Us.InfoMessage.ErrorBox(l, ".modal-body", false)
                }
                n.fileSelectionController.endProcessing()
            }
            return false
        }
    });
    a.Vs.AcademicContentDeleteView = Bb.View.extend({
        template: "classpage/content.delete.template.html",
        events: {
            "click #btnConfirm": "deleteContent"
        },
        renderTemplate: function() {
            var h = this,
                g;
            h.options.groups.each(function(i) {
                if (i.get("SectionId") === parseInt(h.options.contentView.collection.leadSectionId, 10)) {
                    g = i.get("GroupName")
                }
            });
            p3.fT(h.template, function(i) {
                h.$el.html(i({
                    group: h.options.groups.toJSON(),
                    showRadios: h.options.showRadios,
                    sectionName: g,
                    Content: h.options.Content
                }))
            })
        },
        render: function(g) {
            this.renderTemplate();
            $(g).append(this.el)
        },
        deleteContent: function(h) {
            $("#btnConfirm").button("loading");
            var j = this,
                i = 0,
                g;
            if (j.options.showRadios) {
                if ($("#rdo_remove").is(":checked")) {
                    i = j.options.contentView.collection.leadSectionId
                }
            }
            g = new a.Ms.AcademicContentDelete({
                Id: this.options.Id,
                contentId: this.options.contentId,
                SectionId: i,
                FileName: j.options.FileName
            });
            g.destroy({
                error: function() {
                    p3.showModal(p3.Layout.Containers.Modal, "hide");
                    p3.displayError("Error deleting content")
                },
                success: function() {
                    p3.showModal(p3.Layout.Containers.Modal, "hide");
                    a.Us.refreshContent(true, 0, j.options.contentView.collection.leadSectionId, j.options.contentView)
                }
            });
            return false
        }
    });
    a.Us.refreshContent = function(j, o, n, p) {
        var l = false,
            g = false,
            m = false,
            k = false,
            i = p.options.contentId,
            h;
        if (p.options.groupPageEdit) {
            g = p.collection.active;
            m = p.collection.future;
            k = p.collection.expired
        } else {
            g = true
        }
        if (j === false || g || m || k) {
            l = true
        }
        h = new a.Cs.AcademicContent({}, {
            sectionId: o,
            leadSectionId: n,
            contentId: i,
            active: g,
            future: m,
            expired: k
        });
        p.options.editMode = j;
        p.options.active = g;
        p.options.future = m;
        p.options.expired = k;
        if (l) {
            h.fetch({
                success: function() {
                    p.collection = h;
                    p.renderTemplate();
                    if (j) {
                        $(".academic-edit-button").show();
                        $(".academic-delete-button").show()
                    }
                }
            })
        } else {
            h.remove(h.at(0));
            p.collection = h;
            p.renderTemplate()
        }
    }
}(p3.module("lms/academiccontent")));
(function(a) {
    var b = p3.module("LMS/groupPageEdit");
    p3.router().route("activitypageedit/:sectionId/:leadSectionId", "activitypageedit", function(d, c) {
        p3.setTitle("Edit Bulletinboard");
        b.Us.loadPageEditor(c, d, 8, 24)
    })
}(p3.module("LMS/activitybulletinboard")));
(function(a) {
    var d = p3.module("shared/task"),
        e = p3.module("LMS/topic"),
        c = p3.module("LMS/roster"),
        b = p3.module("LMS/groupPageEdit");
    a.Data = {};
    a.Pages = [{
        Id: 1,
        ContentId: 433,
        Label: "Bulletin Board",
        RoutePage: "bulletinboard",
        IconClass: "p3icon-page",
        HTMLID: "bulletin-board-btn",
        LinkId: "bulletin-board-link",
        Display: function(f) {
            var g = new b.Vs.LayoutView({
                sectionId: a.Data.sectionId,
                leadSectionId: a.Data.leadSectionId,
                content: a.Data.contentTypes,
                userHasFullAccess: a.Data.userHasFullAccess,
                isOwner: a.Data.IsOwner,
                isManager: a.Data.isManager,
                associationId: 8,
                contextLabelId: 24,
                preview: false,
                layoutId: a.Data.layoutId,
                pendingInd: false
            });
            p3.rV(g, f, true)
        },
        Active: true
    }, {
        Id: 2,
        ContentId: 386,
        Label: "Topics",
        RoutePage: "topics",
        IconClass: "p3icon-topics",
        HTMLID: "topics-btn",
        LinkId: "topics-link",
        Display: function(f) {
            p3.rV(new e.Vs.TopicManageView({
                sectionId: a.Data.sectionId,
                leadSectionId: a.Data.leadSectionId,
                active: true,
                future: false,
                expired: false,
                userHasFullAccess: a.Data.userHasFullAccess,
                isOwner: a.Data.IsOwner,
                isManager: a.Data.isManager,
                content: a.Data.contentTypes,
                levelNum: a.Data.levelNum || -1,
                durationId: a.Data.durationId,
                schoolYearLabel: a.Data.schoolYear,
                contextLabelId: 24
            }), f, true)
        },
        Active: false
    }, {
        Id: 3,
        ContentId: 434,
        Label: "Roster",
        RoutePage: "roster",
        IconClass: "p3icon-roster",
        HTMLID: "roster-btn",
        LinkId: "roster-link",
        Display: function(f) {
            p3.rV(new c.Vs.RosterView({
                sectionId: a.Data.sectionId,
                leadSectionId: a.Data.leadSectionId,
                durationId: a.Data.durationId,
                associationId: 8,
                isOwner: a.Data.IsOwner,
                enableSearch: true,
                disableLearningProfiles: true
            }), f, true)
        },
        Active: false
    }];
    a.Cs.Section = Bbc.extend({
        initialize: function(f, g) {
            this.sectionId = g.sectionId || 0
        },
        url: function() {
            return aP + "datadirect/SectionInfoView/?format=json&sectionId=" + this.sectionId + "&associationId=8"
        }
    });
    a.Ms.Content = Bbm.extend({
        idAttribute: "ContentId",
        url: function() {
            return ""
        }
    });
    a.Cs.Content = Bbc.extend({
        model: a.Ms.Content,
        initialize: function(f, g) {
            this.sectionId = g.sectionId || 0;
            this.leadSectionId = g.leadSectionId || 0
        },
        url: function() {
            return aP + "datadirect/GroupPossibleContentGet/?format=json&leadSectionId=" + this.leadSectionId
        }
    });
    a.Data = {};
    a.Data.leadSectionId = 0;
    a.Data.durationId = 0;
    a.Data.sectionId = 0;
    a.Data.contentTypes = null;
    a.Data.MainViewRendered = false;
    a.Data.RenderedSectionId = 0;
    a.Data.schoolYear = "";
    a.Vs.MainGroupView = Bb.View.extend({
        template: "activitygroup/activitygroupmainview.template.html",
        initialize: function(f) {
            this.Containers = {};
            if (f) {
                a.Data.sectionId = a.Data.RenderedSectionId = this.SectionId = f.SectionId
            } else {
                a.Data.sectionId = a.Data.RenderedSectionId = this.SectionId = 0
            }
            a.Data.MainViewRendered = true
        },
        dispose: function() {
            a.Data.MainViewRendered = false
        },
        render: function(f) {
            var g = this;
            p3.fT(g.template, function(i) {
                g.$el.html(i({}));
                $(f).html(g.el);
                g.Containers.Navigation = $("#activitypagenavmenu");
                g.Containers.MainContent = $("#activitypagecontainer");
                var h = new a.Cs.Section({}, {
                    sectionId: g.SectionId
                });
                p3.rV(new a.Vs.NavigationView({
                    ParentView: g,
                    collection: h
                }), g.Containers.Navigation, false);
                h.fetch({
                    error: function() {
                        p3.displayError("Error loading section information")
                    }
                })
            })
        }
    });
    a.Vs.NavigationView = Bb.View.extend({
        template: "activitygroup/activitygroupnavigationmenu.template.html",
        initialize: function(f) {
            this.collection.bind("reset change", this.renderTemplate, this);
            this.Containers = {};
            if (f) {
                this.ParentView = f.ParentView
            }
            this.enableScrollNav()
        },
        dispose: function() {
            this.disableScrollNav()
        },
        renderTemplate: function() {
            var w = this,
                k, u, i, r, s, q, p, j, m, n, h, o, g = false,
                f, t = [],
                l = true,
                v;
            w.collection.each(function(x) {
                if (x.get("Id") === parseInt(a.Data.sectionId, 10)) {
                    k = x.get("GroupName");
                    i = x.get("Duration");
                    j = x.get("DurationId");
                    h = x.get("Description");
                    r = x.get("Level");
                    s = x.get("LevelNum");
                    u = x.get("SchoolYear");
                    if (x.get("Length")) {
                        if (x.get("Length") === 1) {
                            q = "1 Term"
                        } else {
                            q = x.get("Length") + " Terms"
                        }
                    }
                    p = x.get("LeadSectionId");
                    n = x.get("IsOwner");
                    m = x.get("IsManager");
                    o = x.get("LayoutId")
                }
            });
            a.Data.IsOwner = n;
            a.Data.leadSectionId = p;
            a.Data.durationId = j;
            a.Data.levelNum = s;
            a.Data.schoolYear = u;
            a.Data.isManager = m;
            a.Data.userHasFullAccess = a.Data.IsOwner || a.Data.isManager;
            a.Data.layoutId = o;
            if (i || j || h || r || q) {
                g = true
            }
            f = new a.Cs.Content({}, {
                sectionId: a.Data.sectionId,
                leadSectionId: a.Data.leadSectionId
            });
            f.fetch({
                error: function() {
                    p3.displayError("Error loading available content")
                },
                success: function() {
                    var x;
                    a.Data.contentTypes = f;
                    f.each(function(z) {
                        var y = z.get("ContentId");
                        x = _.find(a.Pages, function(A) {
                            return A.ContentId === y
                        });
                        l = z.get("ShowContentType");
                        if (l & y === 386) {
                            l = a.Data.userHasFullAccess || z.get("EditorAccess");
                            if (!l) {
                                v = new e.Cs.Topic({}, {
                                    sectionId: 0,
                                    leadSectionId: a.Data.leadSectionId,
                                    active: true,
                                    future: false,
                                    expired: false
                                });
                                v.fetch({
                                    async: false,
                                    success: function() {
                                        if (v.length > 0) {
                                            l = true
                                        }
                                    },
                                    error: function() {
                                        p3.displayError("Error loading topics")
                                    }
                                })
                            }
                        }
                        if (x && l) {
                            t.push({
                                sort: x.Id,
                                title: x.Label,
                                iconClass: x.IconClass,
                                status: x.Active ? "active" : "inactive",
                                link: d.Us.getUrlById(23139, a.Data.sectionId + "/" + x.RoutePage),
                                pId: x.Id,
                                HTMLID: x.HTMLID,
                                LinkId: x.LinkId
                            });
                            x.Enabled = true
                        } else {
                            if (x) {
                                x.Enabled = false
                            }
                        }
                    });
                    x = undefined;
                    t = _.sortBy(t, "sort");
                    p3.fT(w.template, function(y) {
                        w.$el.html(y({
                            Info: g,
                            GroupName: k,
                            Duration: i,
                            Level: r,
                            Length: q,
                            Description: h,
                            navigationItems: t
                        }))
                    });
                    x = _.find(a.Pages, function(y) {
                        return y.Active
                    });
                    if (x && x.Enabled) {
                        x.Display($("#activitypagecontainer"))
                    }
                }
            });
            return this
        },
        events: {
            "click #section-description-toggle": "toggleDescription",
            "click [data-pid]": "switchTab"
        },
        render: function(f) {
            $(f).append(this.el);
            return this
        },
        toggleDescription: function() {
            var f = $("#section-description-content");
            if (f && f.filter(":visible").length) {
                f.hide(400)
            } else {
                f.show(400)
            }
            return false
        },
        switchTab: function(f) {
            if ($(f.currentTarget).attr("data-pid") === "4") {
                _.find(a.Pages, function(g) {
                    return g.Id === 4
                }).Display();
                return false
            }
        },
        enableScrollNav: function() {
            var g = $(document),
                f = $(".subnavbar"),
                i = f.length && f.offset().top - 101,
                h = false;

            function j() {
                if (f.length === 0) {
                    f = $(".subnavbar");
                    i = f.length && f.offset().top - 101
                }
                var k = g.scrollTop();
                h = f.hasClass("subnavbar-fixed");
                if (k >= i && !h) {
                    f.addClass("subnavbar-fixed")
                } else {
                    if (k <= i && h) {
                        f.removeClass("subnavbar-fixed")
                    }
                }
            }
            g.on("scroll", j)
        },
        disableScrollNav: function() {
            var f = $(document);
            f.off("scroll")
        }
    });
    a.Us.LoadPage = function(f, h) {
        p3.loadingIcon("#activitypagecontainer");
        var g;
        _.each(a.Pages, function(i) {
            if (i.RoutePage.toLowerCase() === h.toLowerCase()) {
                i.Active = true;
                g = i
            } else {
                i.Active = false
            }
        });
        if (!a.Data.MainViewRendered || a.Data.RenderedSectionId !== f) {
            p3.renderMainPage(new a.Vs.MainGroupView({
                SectionId: f
            }))
        } else {
            if (g && g.Enabled) {
                g.Display($("#activitypagecontainer"));
                a.Us.SwitchTabs(g)
            }
        }
    };
    a.Us.SwitchTabs = function(g) {
        var f = (p3.Config.uiVersion === 1) ? $(".nav-pills").children() : $(".nav-tabs").children();
        $.each(f, function() {
            var h = $(this);
            if (h.data("pid") === g.Id || (g.Id === 8 && h.data("pid") === 3)) {
                h.removeClass("inactive");
                h.addClass("active")
            } else {
                if (h.hasClass("active")) {
                    h.removeClass("active");
                    h.addClass("inactive")
                }
            }
        })
    };
    p3.router().route("activitypage/:id", "activitypage", function(f) {
        if (f.indexOf("&pk=") > -1) {
            f = f.substring(4)
        }
        a.Us.LoadPage(f, p3.Data.Context.get("UserInfo").UserId, "bulletinboard")
    });
    p3.router().route("activitypage/:id/:page", "activitypage", function(f, g) {
        a.Us.LoadPage(f, g)
    })
}(p3.module("LMS/activitygroup")));
(function(a) {
    var b = p3.module("LMS/groupPageEdit");
    p3.router().route("advisorypageedit/:sectionId/:leadSectionId", "advisorypageedit", function(d, c) {
        p3.setTitle("Edit Bulletinboard");
        b.Us.loadPageEditor(c, d, 9, 22)
    })
}(p3.module("LMS/advisorybulletinboard")));
(function(a) {
    var f = p3.module("shared/mediaviewer"),
        e = p3.module("cms/shared/media"),
        b = p3.module("LMS/assignment"),
        c = p3.Us.Culture,
        d = p3.Us.InfoMessageLibrary;
    a.Ms.Assessment = Bbm.extend({
        idAttribute: "AssessmentId",
        urlRoot: "assessment/crud"
    });
    a.Cs.AssessmentQuestionTypes = Bbc.extend({
        model: Bbm,
        url: "DataDirect/AssessmentMaterialsGet"
    });
    a.Ms.AssessmentResult = Bbm.extend({
        idAttribute: "AssessmentResultId",
        urlRoot: "assessmentresult/crud"
    });
    a.Ms.AssessmentFacultyResult = Bbm.extend({
        idAttribute: "AssessmentResultId",
        urlRoot: "assessmentresult/StudentResultGet"
    });
    a.Ms.AssessmentCanTake = Bbm.extend({
        urlRoot: "assessment/cantake"
    });
    a.Ms.AssessmentRoster = Bbm.extend({
        idAttribute: "user_id"
    });
    a.Cs.AssessmentRoster = Bbc.extend({
        model: a.Ms.AssessmentRoster,
        url: "DataDirect/AssessmentRosterGet"
    });
    a.Ms.BulkCommit = Bbm.extend({
        url: function() {
            return aP + "assessmentresult/bulksubmit/?format=json&assignmentIndexId=" + this.get("assignmentIndexId")
        }
    });
    a.Ms.AssessmentBreakdown = Bbm.extend({
        url: "assessmentresult/BreakdownGet"
    });
    a.Ms.AlbumGet = Bbm.extend({
        url: function() {
            return aP + "datadirect/assessmentalbumget?format=json&assignmentId=" + this.get("assignmentId") + "&contentId=" + this.get("contentId")
        }
    });
    a.Ms.Album = Bbm.extend({
        idAttribute: "album_id"
    });
    a.Cs.Album = Bbc.extend({
        model: a.Ms.Album,
        url: "DataDirect/AssessmentAlbumsGet"
    });
    a.Ms.AssessmentGet = Bbm.extend({
        idAttribute: "AssessmentId",
        urlRoot: "assessment/takeAssessment/"
    });
    a.Ms.AssessmentStudentReview = Bbm.extend({
        idAttribute: "AssessmentId",
        urlRoot: "assessment/reviewAssessment/"
    });
    a.Cs.StudentInfo = Bbc.extend({
        url: function() {
            return aP + "datadirect/ParentStudentUserInfo/"
        }
    });
    a.Ms.AssessmentReviewCheck = Bbm.extend({
        url: "DataDirect/AssessmentReviewCheck"
    });
    a.Ms.AssessmentPause = Bbm.extend({
        url: "assessmentresult/PauseAssessments"
    });
    a.Vs.EditDetail = Bb.View.extend({
        template: "assessment/assessment.detail.edit.template.html",
        initialize: function() {
            this.Containers = {};
            this.options.editMode = this.options.editMode || "content";
            this.locked = this.options.locked
        },
        dispose: function() {
            var g, h;
            p3.closeFixedSidebar();
            p3.closeFixedFooter();
            for (g in tinyMCE.editors) {
                if (tinyMCE.editors.hasOwnProperty(g)) {
                    h = tinyMCE.editors[g];
                    if (h.editorId.indexOf("question-text-") > -1) {
                        tinyMCE.editors[g].remove()
                    }
                }
            }
        },
        render: function(g) {
            var h = this;
            $(g).html(h.el);
            p3.fT(h.template, function(i) {
                h.$el.html(i({}));
                h.Containers.WorkspaceWrap = $(".assessment-page-wrap");
                h.Containers.Workspace = $("#assessment-workspace");
                h.assignment = new b.Ms.Assignment();
                h.assignment.set("AssignmentId", h.options.assignmentId);
                h.assignment.fetch({
                    error: function() {
                        p3.displayError("Error loading assignment")
                    },
                    success: function(l, m) {
                        var k = h.assignment.get("AssessmentId");
                        var j = new a.Ms.Assessment({
                            AssessmentId: k,
                            AssignmentId: h.options.assignmentId
                        });
                        h.assessment = j;
                        if (k > 0) {
                            j.fetch({
                                async: false,
                                data: {
                                    assessmentId: k
                                }
                            })
                        }
                        h.renderSidebar();
                        h.renderBuilder();
                        h.renderFooter()
                    }
                })
            })
        },
        renderSidebar: function() {
            var g = this;
            g.sidebarView = new a.Vs.Sidebar({
                assignment: g.assignment,
                parentView: g,
                assessment: g.assessment,
                assignmentId: g.options.assignmentId,
                assignmentIndexId: g.options.assignmentIndexId,
                locked: g.locked
            });
            p3.renderFixedSidebar(g.sidebarView)
        },
        renderBuilder: function() {
            var h = this;
            var g = new a.Vs.Builder({
                assessment: h.assessment,
                assignment: h.assignment,
                assignmentIndexId: h.options.assignmentIndexId,
                locked: h.locked
            });
            p3.rV(g, h.Containers.Workspace, true);
            h.builder = g
        },
        renderFooter: function() {
            var j = this,
                i = 0,
                h = 0;
            if (j.assessment.get("Questions")) {
                i = j.assessment.get("Questions").length;
                if (j.assignment.get("MaxScoreInd") == 0) {
                    h = a.Us.getPointsAssigned(j.assessment.get("Questions"))
                }
            }
            var g = new a.Vs.Footer({
                assignmentId: j.options.assignmentId,
                questionCount: i,
                pointsPer: j.assignment.get("MaxScoreInd") == 0,
                totalPoints: j.assignment.get("MaxScore"),
                pointsAssigned: h
            });
            p3.renderFixedFooter(g)
        }
    });
    a.Vs.Footer = Bb.View.extend({
        template: "assessment/assessment.footer.template.html",
        render: function(g) {
            var h = this;
            $(g).html(h.el);
            h.renderTemplate()
        },
        renderTemplate: function() {
            var g = this;
            p3.fT(g.template, function(h) {
                g.$el.html(h({
                    assignmentId: g.options.assignmentId,
                    questionCount: g.options.questionCount,
                    pointsAssigned: g.options.pointsAssigned,
                    pointsPer: g.options.pointsPer,
                    totalPoints: g.options.totalPoints
                }))
            })
        }
    });
    a.Vs.Sidebar = Bb.View.extend({
        template: "assessment/assessment.sidebar.template.html",
        className: "workspace-sidebar",
        events: {
            "click #edit-settings-button": "showEditSettings"
        },
        initialize: function() {
            this.Containers = {}
        },
        render: function(g) {
            var h = this;
            $(g).html(h.el);
            h.renderTemplate()
        },
        renderTemplate: function() {
            var h = this;
            var g = new a.Cs.AssessmentQuestionTypes();
            g.fetch({
                success: function() {
                    p3.fT(h.template, function(i) {
                        h.$el.html(i({
                            Name: h.options.assignment.get("ShortDescription"),
                            QuestionTypes: g.toJSON()
                        }));
                        if (h.options.locked) {
                            $(".pages-layout-draggable").children().attr("disabled", "disabled")
                        }
                    })
                },
                error: function() {
                    p3.displayError("Error loading question types.")
                }
            })
        },
        updateView: function() {
            var i = this,
                h = "unlimited";
            if (i.options.assignment.get("TimeToComplete") > 0) {
                h = i.options.assignment.get("TimeToComplete")
            }
            $("#assignment-name").html(i.options.assignment.get("ShortDescription"));
            $("#assessment-name").html(i.options.assignment.get("ShortDescription"));
            $("#time-span").html(h);
            $("#start-string").html(a.Us.getStartString(i.options.assignment, i.options.assignmentIndexId));
            var g = !i.options.assignment.get("MaxScoreInd");
            if (g) {
                $("#points-display").show();
                $("#total-points").html(i.options.assignment.get("MaxScore"));
                $("#points-assigned").html(a.Us.getPointsAssigned(i.options.assessment.get("Questions")))
            } else {
                $("#points-display").hide()
            }
            i.options.parentView.builder.renderQuestions()
        },
        showEditSettings: function(g) {
            g.preventDefault();
            var i = this;
            var h = b.Us.AddAssessmentView(i.options.assignment);
            if (h !== undefined) {
                h.on("saveAssessment", function(j, k) {
                    i.options.assignment.fetch({
                        error: function() {
                            p3.displayError("Error loading assignment")
                        },
                        success: function(l, m) {
                            i.updateView();
                            i.options.parentView.assignment = k
                        }
                    })
                })
            }
        }
    });
    a.Vs.Builder = Bb.View.extend({
        template: "assessment/assessment.builder.template.html",
        events: {
            "click li.assess-tab": "switchPane",
            "change .question-text-box": "textChange",
            "change .points-box": "integerBoxChange",
            "change .max-character-box": "integerBoxChange",
            "change .fillin-answer-box": "textChange",
            "change .answer-box": "textChange",
            "click .correct-button": "correctChange",
            "click .delete-answer-button": "deleteAnswer",
            "click .add-answer-button": "addAnswer",
            "click .delete-question-button": "deleteQuestion",
            "click .edit-type-button": "editorTypeChange",
            "click .result-setting-btn": "resultSettingChange",
            "click .add-embed-link": "addEmbed",
            "click .edit-embed-link": "editEmbed",
            "click .add-photo-link": "addPhoto",
            "click .edit-photo-link": "editPhoto",
            "click .add-audio-link": "addAudio",
            "click .edit-audio-link": "editAudio"
        },
        initialize: function(g) {
            this.Containers = {};
            this.assignment = g.assignment;
            this.assessment = g.assessment
        },
        dispose: function() {
            var g = tinyMCE.get("description-box");
            if (g) {
                g.remove();
                g = null
            }
        },
        render: function(g) {
            var h = this;
            $(g).html(h.el);
            h.renderTemplate()
        },
        renderTemplate: function() {
            var g = this;
            p3.fT(g.template, function(k) {
                var j = "unlimited",
                    h = 0,
                    i;
                if (g.assignment.get("TimeToComplete") > 0) {
                    j = g.assignment.get("TimeToComplete")
                }
                i = g.assessment.get("AssessmentDescription");
                if (i && i.length > 0) {
                    h = i.length
                }
                g.$el.html(k({
                    Name: g.assignment.get("ShortDescription"),
                    Chars: h,
                    Time: j,
                    Description: i,
                    assessment: g.assessment.toJSON(),
                    StartString: a.Us.getStartString(g.assignment, g.options.assignmentIndexId),
                    locked: g.options.locked
                }));
                g.Containers.QuestionContainer = $("#question-container");
                p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.jQueryUI, function() {
                    window.setTimeout(function() {
                        if (!g.options.locked) {
                            g.initDraggable();
                            g.initSortable()
                        }
                        g.checkAlbumStatus();
                        g.renderQuestions();
                        p3.showHtmlEditor("description-box", p3.Us.Enum.HtmlEditorCategories.FULL, false, function() {
                            var l = tinyMCE.get("description-box");
                            if (l !== undefined) {
                                l.onSetContent.add(function(o, n) {
                                    var m = o.getContent();
                                    if (m.length > 2000) {
                                        $("#assess-description-count").addClass("badge-error")
                                    } else {
                                        $("#assess-description-count").removeClass("badge-error");
                                        g.saveDescription(m)
                                    }
                                    $("#assess-description-count").html(m.length)
                                });
                                l.onChange.add(function(o, n) {
                                    var m = o.getContent();
                                    if (m.length > 2000) {
                                        $("#assess-description-count").addClass("badge-error")
                                    } else {
                                        $("#assess-description-count").removeClass("badge-error");
                                        g.saveDescription(m)
                                    }
                                    $("#assess-description-count").html(m.length)
                                });
                                l.onKeyUp.add(function(o, n) {
                                    var m = o.getContent();
                                    if (m.length > 2000) {
                                        $("#assess-description-count").addClass("badge-error")
                                    } else {
                                        $("#assess-description-count").removeClass("badge-error")
                                    }
                                    $("#assess-description-count").html(m.length)
                                })
                            } else {
                                p3.log("error TinyMCE not loaded yet.")
                            }
                        }, p3.Us.Enum.HtmlEditorEncoding.NUMERIC)
                    }, 400)
                })
            })
        },
        checkAlbumStatus: function() {
            var h = this,
                g = new a.Cs.Album();
            h.albums = g;
            g.fetch({
                async: false,
                data: {
                    assignmentId: h.assignment.get("AssignmentId")
                },
                success: function() {
                    var n = h.assessment.get("Questions"),
                        l = "",
                        k = 0,
                        m, j;
                    if (n) {
                        for (m = 0; m < n.length; m++) {
                            if (n[m].AlbumId > 0) {
                                j = g.get(n[m].AlbumId);
                                if (j !== undefined) {
                                    if (j.get("num_files") > j.get("files_processed")) {
                                        n[m].AlbumLocked = true
                                    }
                                } else {
                                    k = k + 1;
                                    if (l.length > 0) {
                                        l = l + ", "
                                    }
                                    l = l + "ID=" + n[m].AlbumId + "(Q=" + m + ")"
                                }
                            }
                        }
                        if (k > 0) {
                            p3.displayError("Error loading assessment albums (" + k + ")")
                        }
                    }
                },
                error: function() {
                    p3.displayError("Error loading assessment albums")
                }
            })
        },
        saveDescription: function(g) {
            var h = this;
            if (g.length > 0 || h.assessment.get("AssessmentId") > 0) {
                h.assessment.set("AssessmentDescription", g);
                h.assessment.save({}, {
                    success: function() {
                        $("#assess-preview-btn").show()
                    },
                    error: function() {
                        p3.displayError("Error saving assessment")
                    }
                })
            }
        },
        resultSettingChange: function(g) {
            var h = this;
            switch (g.currentTarget.id) {
                case "btn-show-time-on":
                    h.assessment.set("ShowTime", true);
                    break;
                case "btn-show-time-off":
                    h.assessment.set("ShowTime", false);
                    break;
                case "btn-show-score-on":
                    h.assessment.set("ShowScore", true);
                    $("#btn-score-only-on").removeAttr("disabled");
                    $("#btn-show-answers-on").removeAttr("disabled");
                    break;
                case "btn-show-score-off":
                    h.assessment.set({
                        ShowScore: false,
                        ShowAnswers: false,
                        ScoreOnly: false
                    });
                    $("#btn-score-only-off").addClass("active");
                    $("#btn-score-only-on").removeClass("active");
                    $("#btn-score-only-on").attr("disabled", "disabled");
                    $("#btn-show-answers-off").addClass("active");
                    $("#btn-show-answers-on").removeClass("active");
                    $("#btn-show-answers-on").attr("disabled", "disabled");
                    break;
                case "btn-show-again-on":
                    h.assessment.set("ShowTryAgain", true);
                    break;
                case "btn-show-again-off":
                    h.assessment.set("ShowTryAgain", false);
                    break;
                case "btn-show-answers-on":
                    h.assessment.set("ShowAnswers", true);
                    break;
                case "btn-show-answers-off":
                    h.assessment.set("ShowAnswers", false);
                    break;
                case "btn-show-complete-on":
                    h.assessment.set("ShowOnComplete", true);
                    $(".result-setting-btn").removeAttr("disabled");
                    $("#btn-score-only-on").attr("disabled", "disabled");
                    $("#btn-show-answers-on").attr("disabled", "disabled");
                    break;
                case "btn-show-complete-off":
                    h.assessment.set({
                        ShowOnComplete: false,
                        ShowTime: false,
                        ShowScore: false,
                        ShowTryAgain: false,
                        ShowAnswers: false,
                        RestrictResults: false,
                        ScoreOnly: false
                    });
                    $(".result-setting-btn").attr("disabled", "disabled");
                    $(".result-setting-btn.btn-denied").addClass("active");
                    $(".result-setting-btn.btn-approve").removeClass("active");
                    $("#btn-show-complete-off").removeAttr("disabled");
                    $("#btn-show-complete-on").removeAttr("disabled");
                    break;
                case "btn-restrict-results-on":
                    h.assessment.set("RestrictResults", true);
                    break;
                case "btn-restrict-results-off":
                    h.assessment.set("RestrictResults", false);
                    break;
                case "btn-score-only-on":
                    h.assessment.set("ScoreOnly", true);
                    break;
                case "btn-score-only-off":
                    h.assessment.set("ScoreOnly", false);
                    break
            }
            h.assessment.save({}, {
                success: function() {
                    $("#assess-preview-btn").show()
                },
                error: function() {
                    p3.displayError("Error saving assessment")
                }
            })
        },
        switchPane: function(g) {
            $("div.tab-pane").removeClass("active");
            switch (g.target.id) {
                case "intro-tab":
                    $("#intro-pane").addClass("active");
                    break;
                case "question-tab":
                    $("#question-pane").addClass("active");
                    break;
                case "results-tab":
                    $("#results-pane").addClass("active");
                    break
            }
        },
        initDraggable: function() {
            $(".pages-layout-draggable-content").draggable({
                connectToSortable: "#question-container",
                placeholder: "pages-layout-placeholder",
                forcePlaceholderSize: true,
                tolerance: "pointer",
                helper: "clone",
                delay: 300,
                appendTo: "body"
            }).disableSelection()
        },
        initSortable: function() {
            var g = this;
            $("#question-container").sortable({
                items: ".question-region",
                handle: ".question-header-region",
                placeholder: "pages-layout-placeholder",
                forcePlaceholderSize: true,
                tolerance: "pointer",
                delay: 300,
                stop: function(j, n) {
                    var h = $(n.item),
                        l = h.data("id"),
                        m = h.index(),
                        k, i = [];
                    if (h.hasClass("workspace-draggable-item")) {
                        if ($(".question-region").length == 0) {
                            m = 0
                        }
                        _.defer(function() {
                            h.remove()
                        });
                        k = g.getQuestionOrder(m, false);
                        if (l == 4) {
                            i.push({
                                SortOrder: 1,
                                Description: "True"
                            });
                            i.push({
                                SortOrder: 2,
                                Description: "False"
                            })
                        }
                        if (l == 3) {
                            i.push({
                                SortOrder: 1
                            });
                            i.push({
                                SortOrder: 2
                            });
                            i.push({
                                SortOrder: 3
                            })
                        }
                        g.clearEditor();
                        k.push({
                            QuestionTypeId: l,
                            SortOrder: m,
                            QuestionType: a.Us.getQuestionTypeName(l),
                            Answers: i
                        });
                        g.saveQuestions(k, true);
                        g.updateQuestionCount()
                    } else {
                        g.clearEditor();
                        k = g.getQuestionOrder(-1, true);
                        g.saveQuestions(k, true)
                    }
                }
            })
        },
        clearEditor: function() {
            var g, h;
            if (tinyMCE === undefined) {
                return
            }
            for (g in tinyMCE.editors) {
                if (tinyMCE.editors.hasOwnProperty(g)) {
                    h = tinyMCE.editors[g];
                    if (h.editorId.indexOf("question-text-") > -1) {
                        tinyMCE.editors[g].save();
                        tinyMCE.editors[g].remove()
                    }
                }
            }
        },
        getQuestionOrder: function(k, o) {
            var n = [],
                l = -1,
                p = -1,
                q = this,
                m = q.assessment.get("Questions"),
                g = 0,
                h = 0,
                j;
            $(".question-region").each(function(v, w) {
                p = $(w).data("type");
                g = $(w).data("album");
                h = $(w).data("content");
                var y = 0,
                    x = 0,
                    u = "",
                    i = [],
                    A = false,
                    s = "",
                    t = "";
                if (v == k) {
                    l += 2
                } else {
                    l += 1
                }
                if (q.assignment.get("MaxScoreInd") == 0) {
                    y = $(w).find(".points-box").val()
                }
                if (p == 1) {
                    x = $(w).find(".max-character-box").val();
                    A = $(w).find(".use-editor-button").hasClass("active")
                }
                if (p == 2) {
                    u = $(w).find(".fillin-answer-box").val()
                }
                if (p == 3 || p == 4) {
                    $(w).find(".answer-container").each(function(C, B) {
                        i.push({
                            SortOrder: C,
                            Description: $(B).find(".answer-box").val(),
                            IsCorrect: $(B).find(".correct-button").hasClass("active")
                        })
                    })
                }
                if ($(w).find(".edit-embed-link")) {
                    var z = $(w).find(".edit-embed-link").data("sort");
                    $(w).find(".edit-embed-link").data("sort", l);
                    for (j = 0; j < m.length; j++) {
                        if (m[j].SortOrder == z) {
                            s = m[j].Embed;
                            t = m[j].EmbedTitle;
                            break
                        }
                    }
                }
                if (!o) {
                    var r = tinyMCE.get($(w).find(".question-text-box").attr("id"));
                    if (r) {
                        r.save()
                    }
                }
                n.push({
                    QuestionTypeId: p,
                    QuestionType: a.Us.getQuestionTypeName(p),
                    Description: $(w).find(".question-text-box").val() || $(w).find(".question-text-box").html(),
                    Points: y,
                    CharacterLimit: x,
                    PossibleAnswers: u,
                    SortOrder: l,
                    UseEditor: A,
                    Answers: i,
                    Embed: s,
                    EmbedTitle: t,
                    ContentId: h,
                    AlbumId: g
                })
            });
            return n
        },
        saveQuestions: function(g, h) {
            var i = this;
            i.assessment.set({
                Questions: g
            });
            i.assessment.save({}, {
                error: function() {
                    p3.displayError("Error saving questions")
                },
                success: function() {
                    if (h) {
                        i.checkAlbumStatus();
                        i.renderQuestions()
                    }
                }
            })
        },
        renderQuestions: function() {
            var h = this;
            var g = new a.Vs.QuestionView({
                questions: h.assessment.get("Questions"),
                assignment: h.assignment,
                parentView: h,
                locked: h.options.locked
            });
            p3.rV(g, h.Containers.QuestionContainer, true)
        },
        textChange: function(g) {
            this.saveQuestions(this.getQuestionOrder(-1, false), false)
        },
        integerBoxChange: function(h) {
            var g = $(h.currentTarget);
            g.removeClass("box-validate");
            if (/^\d*(\.\d{1,})?$/.test(g.val())) {
                this.saveQuestions(this.getQuestionOrder(-1, false), false);
                if (g.hasClass("points-box")) {
                    $("#points-assigned").html(a.Us.getPointsAssigned(this.assessment.get("Questions")))
                }
            } else {
                g.addClass("box-validate");
                g.val("")
            }
        },
        correctChange: function(i) {
            var h = $(i.currentTarget);
            if (h.hasClass("active")) {
                h.removeClass("active")
            } else {
                if (!h.hasClass("multi")) {
                    var g = h.parentsUntil(".question-region");
                    g.find(".correct-button.active").removeClass("active")
                }
                h.addClass("active")
            }
            this.saveQuestions(this.getQuestionOrder(-1, false), false)
        },
        editorTypeChange: function(h) {
            var g = $(h.currentTarget);
            g.parent().find(".edit-type-button.active").removeClass("active");
            g.addClass("active");
            this.saveQuestions(this.getQuestionOrder(-1, false), false)
        },
        deleteAnswer: function(h) {
            var g = $(h.currentTarget);
            g.parent().parent().remove();
            this.saveQuestions(this.getQuestionOrder(-1, false), false)
        },
        addAnswer: function(h) {
            var g = $(h.currentTarget);
            if (p3.Config.uiVersion === 3) {
                g.parent().siblings(".answer-wrapper").append('<div class="row answer-container" style="margin:0px 0px 0px 20px"><div class="col-md-8"><input class="answer-box form-control" type="text" placeholder="Answer" style="width:100%;"/></div><div class="col-md-4"><button type="button" class="btn btn-default btn-sm btn-approve correct-button multi" style="margin:0px 10px 3px 5px"><i class="fa fa-check"></i> Correct</button>&nbsp;<span class="delete-answer-button" style="cursor:pointer;"><i class="fa fa-trash"></i></span></div></div>')
            } else {
                g.parent().siblings(".answer-wrapper").append('<div class="container row-fluid answer-container" style=""><div class="row" style="width:100%;margin:0px 0px 0px 20px;"><div class="span8 col-md-8"><input class="answer-box" type="text" placeholder="Answer" style="width:100%;"></div><div class="span4 col-md-4"><button type="button" class="btn btn-default btn-approve correct-button multi" style="margin:0px 10px 3px 5px"><i class="p3icon-check"></i> Correct</button>&nbsp;<span class="delete-answer-button" style="cursor:pointer;"><i class="p3icon-delete"></i></span></div></div></div>')
            }
            this.saveQuestions(this.getQuestionOrder(-1, false), false)
        },
        deleteQuestion: function(j) {
            var k = this,
                h = $(j.currentTarget),
                g = h.closest(".question-region");
            if (g.data("album") > 0) {
                var i = new e.Ms.AlbumDelete({
                    Id: g.data("album"),
                    groupId: 0,
                    option: 1,
                    contextValue: k.assignment.get("AssignmentId"),
                    contentId: g.data("content"),
                    contextLabelId: 5
                });
                i.destroy({
                    error: function() {
                        p3.displayError("Error deleting Album")
                    }
                })
            }
            g.remove();
            this.saveQuestions(this.getQuestionOrder(-1, false), true);
            k.updateQuestionCount();
            if (!k.assignment.get("MaxScoreInd")) {
                $("#points-assigned").html(a.Us.getPointsAssigned(k.assessment.get("Questions")))
            }
        },
        addEmbed: function(i) {
            var l = this,
                g = $(i.currentTarget),
                k = g.data("sort"),
                h = (p3.Config.uiVersion === 1) ? '<h4 style="font-size: 14px;font-weight:bold;"><i class="p3icon-edit"></i> Edit Embed</h4>' : '<i class="fa fa-pencil"></i> Edit Embed';
            $(".question-media.open").removeClass("open");
            var j = new a.Vs.EmbedView({
                mode: "Add",
                embed: "",
                embedTitle: ""
            });
            p3.rV(j, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            j.on("embedSaved", function(o, m) {
                var n = l.assessment.get("Questions");
                n[k].Embed = m;
                n[k].EmbedTitle = o;
                l.saveQuestions(n, false);
                g.closest(".question-media").html('<button class="btn btn-default btn-sm edit-media edit-embed-link" data-sort="' + k + '">' + h + "</button>");
                p3.showModal(p3.Layout.Containers.Modal, "hide")
            });
            return false
        },
        editEmbed: function(i) {
            var m = this,
                g = $(i.currentTarget),
                l = g.data("sort"),
                h = g.prop("disabled");
            if (!h) {
                var k = m.assessment.get("Questions");
                var j = new a.Vs.EmbedView({
                    mode: "Edit",
                    embed: k[l].Embed,
                    embedTitle: k[l].EmbedTitle
                });
                p3.rV(j, p3.Layout.Containers.Modal, true);
                p3.showModal(p3.Layout.Containers.Modal);
                j.on("embedSaved", function(o, n) {
                    k[l].Embed = n;
                    k[l].EmbedTitle = o;
                    m.saveQuestions(k, false);
                    p3.showModal(p3.Layout.Containers.Modal, "hide")
                })
            }
            return false
        },
        addPhoto: function(i) {
            var m = this,
                g = $(i.currentTarget),
                l = g.data("sort");
            var k = m.assessment.get("Questions");
            var h = new Bbm({
                topicContentId: 0,
                shortDescription: "",
                longDescription: "",
                Url: "",
                FileName: ""
            });
            $(".question-media.open").removeClass("open");
            var j = e.Us.showAssessmentPhotoDialog(0, h, m.assignment.get("AssignmentId"));
            j.on("photoSaved", function() {
                p3.showModal(p3.Layout.Containers.Modal, "hide");
                var n = new a.Ms.AlbumGet({
                    assignmentId: m.assignment.get("AssignmentId"),
                    contentId: 31
                });
                n.fetch({
                    async: false,
                    success: function() {
                        k[l].AlbumId = n.get("album_id");
                        k[l].ContentId = 31;
                        m.saveQuestions(k, true)
                    },
                    error: function() {
                        p3.displayError("Error getting content index")
                    }
                })
            })
        },
        editPhoto: function(k) {
            var m = this,
                g = $(k.currentTarget),
                h = g.data("album"),
                j = g.prop("disabled");
            if (!j) {
                var i = new Bbm({
                    topicContentId: 0,
                    shortDescription: "",
                    longDescription: "",
                    Url: "",
                    FileName: ""
                });
                var l = e.Us.showAssessmentPhotoDialog(h, i, m.assignment.get("AssignmentId"));
                l.on("photoSaved", function() {
                    p3.showModal(p3.Layout.Containers.Modal, "hide")
                })
            }
        },
        addAudio: function(j) {
            var m = this,
                g = $(j.currentTarget),
                l = g.data("sort");
            var k = m.assessment.get("Questions");
            var i = new Bbm({
                topicContentId: 0,
                shortDescription: "",
                longDescription: "",
                Url: "",
                FileName: ""
            });
            $(".question-media.open").removeClass("open");
            var h = e.Us.showAssessmentAudioDialog(0, i, m.assignment.get("AssignmentId"));
            h.on("audioSaved", function() {
                p3.showModal(p3.Layout.Containers.Modal, "hide");
                var n = new a.Ms.AlbumGet({
                    assignmentId: m.assignment.get("AssignmentId"),
                    contentId: 165
                });
                n.fetch({
                    async: false,
                    success: function() {
                        k[l].AlbumId = n.get("album_id");
                        k[l].ContentId = 165;
                        m.saveQuestions(k, true)
                    },
                    error: function() {
                        p3.displayError("Error getting content index")
                    }
                })
            })
        },
        editAudio: function(l) {
            var m = this,
                g = $(l.currentTarget),
                h = g.data("album"),
                k = g.prop("disabled");
            if (!k) {
                var j = new Bbm({
                    topicContentId: 0,
                    shortDescription: "",
                    longDescription: "",
                    Url: "",
                    FileName: ""
                });
                var i = e.Us.showAssessmentAudioDialog(h, j, m.assignment.get("AssignmentId"));
                i.on("audioSaved", function() {
                    p3.showModal(p3.Layout.Containers.Modal, "hide")
                })
            }
        },
        updateQuestionCount: function() {
            $("#question-counter").html(this.assessment.get("Questions").length)
        }
    });
    a.Vs.QuestionView = Bb.View.extend({
        template: "assessment/assessment.question.template.html",
        events: {
            "click #intro-toggle": "toggleIntro",
            "click #intro-collapse": "toggleIntro",
            'click span[id*="question-text-"]': "showEditor"
        },
        render: function(g) {
            var h = this;
            $(g).html(h.el);
            h.renderTemplate()
        },
        renderTemplate: function() {
            var g = this;
            p3.fT(g.template, function(i) {
                var h = false;
                if (g.options.questions && g.options.questions.length) {
                    h = true
                }
                g.$el.html(i({
                    questions: g.options.questions,
                    MaxScoreInd: g.options.assignment.get("MaxScoreInd"),
                    haveQuestions: h
                }));
                if (g.options.locked) {
                    $("#question-container :input").attr("disabled", "disabled");
                    $(".delete-question-button").hide();
                    $(".delete-answer-button").hide();
                    $(".add-answer-button").hide();
                    $(".question-text-box").hide();
                    $(".question-text-locked").show()
                }
            })
        },
        toggleIntro: function(g) {
            $("#intro").collapse("toggle");
            return false
        },
        showEditor: function(g) {
            var k = this,
                i, j;
            if (g.currentTarget.id.indexOf("_parent") === -1) {
                for (i in tinyMCE.editors) {
                    if (tinyMCE.editors.hasOwnProperty(i)) {
                        j = tinyMCE.editors[i];
                        if (j.editorId.indexOf("question-text-") > -1) {
                            tinyMCE.editors[i].save();
                            tinyMCE.editors[i].remove();
                            k.options.parentView.saveQuestions(k.options.parentView.getQuestionOrder(-1, false), false)
                        }
                    }
                }
                tinyMCE.execCommand("mceAddControl", false, g.currentTarget.id);
                var h = tinyMCE.get(g.currentTarget.id);
                if (h !== undefined) {
                    h.focus();
                    h.onChange.add(function() {
                        k.options.parentView.saveQuestions(k.options.parentView.getQuestionOrder(-1, false), false)
                    });
                    h.onSetContent.add(function() {
                        k.options.parentView.saveQuestions(k.options.parentView.getQuestionOrder(-1, false), false)
                    })
                }
            }
        }
    });
    a.Vs.EmbedView = Bb.View.extend({
        template: "assessment/assessment.embed.template.html",
        events: {
            "click #btnSaveWidget": "doSave"
        },
        initialize: function(g) {
            this.mode = g.mode || "Add";
            this.embed = g.embed || "";
            this.embedTitle = g.embedTitle || ""
        },
        render: function(g) {
            $(g).append(this.el);
            this.renderTemplate()
        },
        renderTemplate: function() {
            var g = this;
            p3.fT(g.template, function(h) {
                g.$el.html(h({
                    Mode: g.mode,
                    Embed: g.embed,
                    EmbedTitle: g.embedTitle
                }));
                $("#embed-text").height(110)
            })
        },
        doSave: function(h) {
            var k = this;
            var i = k.$("#embed-title").val(),
                g = k.$("#embed-text").val(),
                j = true;
            $("#btnSaveWidget").button("loading");
            if (typeof i !== "string" || i === "") {
                k.$("#embed-title").closest(".control-group").addClass("error");
                j = false
            } else {
                k.$("#embed-title").closest(".control-group").removeClass("error")
            }
            if (typeof g !== "string" || g === "") {
                k.$("#embed-text").closest(".control-group").addClass("error");
                j = false
            } else {
                k.$("#embed-text").closest(".control-group").removeClass("error")
            }
            if (j) {
                k.trigger("embedSaved", i, g)
            } else {
                $("#btnSaveWidget").button("reset");
                $("#btnSaveAddWidget").button("reset")
            }
            return false
        }
    });
    a.Vs.Take = Bb.View.extend({
        template: "assessment/assessment.take.template.html",
        events: {
            "click #begin-button": "beginAssessment",
            "click #submit-all-button": "submitAllClick",
            "click #save-all-for-later-button": "saveForLaterClick"
        },
        initialize: function() {
            this.Containers = {};
            this.preview = this.options.preview || false;
            this.resume = this.options.resume || false;
            this.currentQuestion = 0
        },
        dispose: function() {
            var g = this;
            $("#site-main").addClass("container");
            $("body").removeClass("graniteCountertop");
            if (g.assessTimer) {
                window.clearInterval(g.assessTimer);
                g.assessTimer = null;
                if (!g.preview) {
                    g.saveResults(false)
                }
            }
        },
        render: function(h) {
            var i = this;
            $(h).html(i.el);
            var g = new a.Cs.Album();
            i.albums = g;
            g.fetch({
                async: false,
                data: {
                    assignmentId: i.options.assignmentId
                },
                success: function() {
                    var j = "/ftpimages/" + p3.Data.SchoolContext.get("SchoolInfo").SchoolId + "/";
                    g.each(function(k) {
                        switch (k.get("content_id")) {
                            case 165:
                                if (k.get("thumb_filename")) {
                                    k.set("filename", j + "audio/" + k.get("thumb_filename"))
                                } else {
                                    k.set("filename", "/ftpimages/999/podium/style1/icons/audioDefault.png")
                                }
                                break;
                            case 167:
                                k.set("filename", j + "video/" + k.get("thumb_filename"));
                                break;
                            case 31:
                                k.set("filename", j + "photo/" + k.get("filename"));
                                break
                        }
                    })
                },
                error: function() {
                    p3.displayError("Error loading assessment albums")
                }
            });
            i.assignment = new b.Ms.AssignmentGet();
            i.assignment.set("AssignmentId", i.options.assignmentId);
            i.assignment.fetch({
                error: function() {
                    p3.displayError("Error loading assignment")
                },
                success: function(l, m) {
                    i.assessmentId = i.assignment.get("AssessmentId");
                    var j;
                    if (i.preview) {
                        j = new a.Ms.Assessment({
                            AssessmentId: i.assessmentId,
                            AssignmentId: i.options.assignmentId
                        })
                    } else {
                        j = new a.Ms.AssessmentGet({
                            AssessmentId: i.assessmentId,
                            AssignmentId: i.options.assignmentId
                        })
                    }
                    i.assessment = j;
                    if (i.assessmentId > 0) {
                        var k = false;
                        if (!i.preview) {
                            var n = new a.Ms.AssessmentCanTake();
                            n.fetch({
                                async: false,
                                data: {
                                    assessmentId: i.assessmentId,
                                    assignmentIndexId: i.options.assignmentIndexId
                                },
                                success: function(o, p) {
                                    k = p
                                },
                                error: function() {
                                    p3.displayError("Error validating student for assessment")
                                }
                            })
                        } else {
                            k = true
                        }
                        if (k) {
                            if (i.resume) {
                                i.getExistingResults()
                            }
                            j.fetch({
                                data: {
                                    assessmentId: i.assessmentId,
                                    assignmentIndexId: i.options.assignmentIndexId
                                },
                                error: function() {
                                    p3.displayError("Error loading assessment")
                                },
                                success: function() {
                                    j.set("AssessmentDescription", j.get("AssessmentDescription").replace(/[\n\r]/g, "<br />"));
                                    var p = "";
                                    if (i.assignment.get("TimeToComplete") > 0) {
                                        var o = i.assignment.get("TimeToComplete") * 60000;
                                        if (i.resume) {
                                            i.existingMilliseconds = (i.result.get("SavedMilliseconds") || 0);
                                            o -= i.existingMilliseconds
                                        }
                                        p = a.Us.getTimeDisplayForMilliseconds(o)
                                    }
                                    p3.fT(i.template, function(q) {
                                        i.$el.html(q({
                                            assignment: i.assignment.toJSON(),
                                            assessment: j.toJSON(),
                                            canTake: true,
                                            timeRemaining: p,
                                            preview: i.preview
                                        }));
                                        i.Containers.Questions = $("#question-container");
                                        window.setTimeout(function() {
                                            $("#site-main").removeClass("container");
                                            $("body").addClass("graniteCountertop")
                                        }, 100)
                                    })
                                }
                            })
                        } else {
                            p3.fT(i.template, function(o) {
                                i.$el.html(o({
                                    canTake: false
                                }));
                                window.setTimeout(function() {
                                    $("#site-main").removeClass("container");
                                    $("body").addClass("graniteCountertop")
                                }, 100)
                            })
                        }
                    }
                }
            })
        },
        getAsessment: function() {
            var g = this;
            g.assessment.fetch({
                data: {
                    assessmentId: g.assessmentId,
                    assignmentIndexId: g.options.assignmentIndexId
                },
                error: function() {
                    p3.displayError("Error loading assessment")
                },
                async: false,
                success: function() {
                    if (!g.resume) {
                        g.getResults()
                    }
                }
            })
        },
        beginAssessment: function(j) {
            var p = this,
                o = [],
                k, n, h, l;
            p.startTime = new Date();
            if (!p.resume) {
                p.result = new a.Ms.AssessmentResult();
                p.result.set({
                    AssessmentId: p.assessmentId,
                    AssignmentId: p.options.assignmentId,
                    AssignmentIndexId: p.options.assignmentIndexId,
                    Responses: o
                });
                if (!p.preview) {
                    h = p.assessment.get("QuestionCount") || 1;
                    for (l = 0; l < h; l++) {
                        o.push({
                            SortOrder: l,
                            ResponseOrder: l,
                            Response: ""
                        })
                    }
                    p.saveResults(false);
                    if (p.assignment.get("SaveForLater")) {
                        p3.enterConfirmMode({
                            Message: "This assessment has not been submitted. If you wish to resume later press Cancel and then select 'Save For Later', otherwise you will not be able to resume later. Are you sure you wish to leave this page?"
                        })
                    } else {
                        p3.enterConfirmMode({
                            Message: "This assessment has not been submitted. You will not be able to resume it later. Are you sure you wish to leave this page?"
                        })
                    }
                }
            } else {
                if (!p.preview) {
                    p3.enterConfirmMode({
                        Message: "This assessment has not been submitted. If you wish to resume later press Cancel and then select 'Save For Later', otherwise you will not be able to resume later. Are you sure you wish to leave this page?"
                    })
                }
            }
            p.getAsessment();
            p.startTime = new Date();
            $("#intro-container").hide();
            $("#question-container").show();
            var m = p.result.get("Responses");
            if (p.assignment.get("QuestionsTogether")) {
                for (k = 0; k < m.length; k++) {
                    n = new a.Vs.TakeQuestion({
                        question: m[k],
                        showFooter: false,
                        showPrevious: false,
                        showNext: false,
                        number: k + 1,
                        preview: p.preview,
                        albums: p.albums
                    });
                    p3.rV(n, p.Containers.Questions, false);
                    p.handleResponse(n)
                }
                $("#submit-container").show()
            } else {
                this.currentQuestion = 0;
                n = new a.Vs.TakeQuestion({
                    question: m[0],
                    showFooter: true,
                    showPrevious: false,
                    showNext: m.length > 1,
                    number: 1,
                    preview: p.preview,
                    albums: p.albums,
                    showSaveForLater: p.assignment.get("SaveForLater")
                });
                p3.rV(n, p.Containers.Questions, true);
                n.on("moveNext", function() {
                    p.moveNext()
                });
                n.on("submitAssessment", function() {
                    p.submitAssessment()
                });
                n.on("responseRecorded", function(q, i) {
                    p.updateResponse(q, i);
                    if (!p.preview) {
                        p.saveResults(false)
                    }
                });
                n.on("saveForLater", function() {
                    p.saveAssessmentForLater()
                })
            }
            if (p.assignment.get("TimeToComplete") > 0) {
                p.textResized = false;
                if (p.assessTimer) {
                    window.clearInterval(p.assessTimer);
                    p.assessTimer = null
                }
                var g = p.assignment.get("TimeToComplete") * 60000;
                if (p.resume) {
                    p.existingMilliseconds = (p.result.get("SavedMilliseconds") || 0);
                    g -= p.existingMilliseconds
                }
                p.endTime = new Date(p.startTime.getTime() + g);
                p.assessTimer = window.setInterval(function() {
                    var r = new Date();
                    if (r >= p.endTime) {
                        window.clearInterval(p.assessTimer);
                        p.assessTimer = null;
                        p.result.set("SubmitResults", true);
                        p.saveResults(true)
                    } else {
                        var s = new Date(a.Us.getOffsetFromReferenceDate(p.endTime.getTime() - r.getTime())),
                            i = s.getHours(),
                            q = s.getMinutes(),
                            t = s.getSeconds(),
                            u = "";
                        if (i > 0) {
                            u = i + ":"
                        }
                        if (q > 0 || i > 0) {
                            if (q > 0) {
                                if (i > 0 && q < 10) {
                                    u += "0"
                                }
                                u += q
                            } else {
                                u += "00"
                            }
                        }
                        u += ":";
                        if (t < 10) {
                            u += "0"
                        }
                        u += t;
                        $("#timer-display").html(u);
                        if (i < 1 && q < 1 && !p.textResized) {
                            p.textResized = true;
                            $("#timer-display").animate({
                                fontSize: "24px"
                            }, 1000);
                            $("#timer-display").css("color", "#b94a48")
                        }
                    }
                }, 1000)
            }
        },
        handleResponse: function(g) {
            var h = this;
            g.on("responseRecorded", function(j, i) {
                h.updateResponse(j, i);
                if (!h.preview) {
                    h.saveResults(false)
                }
            })
        },
        moveNext: function() {
            var g = this;
            g.destroyJPlayers();
            if (g.currentQuestion + 1 < g.result.get("Responses").length) {
                g.currentQuestion += 1;
                g.outputCurrentQuestion();
                $(window).scrollTop(0)
            }
            if (!g.preview) {
                g.saveResults(false)
            }
        },
        movePrevious: function() {
            var g = this;
            g.destroyJPlayers();
            if (g.currentQuestion - 1 >= 0) {
                g.currentQuestion -= 1;
                g.outputCurrentQuestion();
                $(window).scrollTop(0)
            }
            if (!g.preview) {
                g.saveResults(false)
            }
        },
        destroyJPlayers: function() {
            if ($(".jp-jplayer").length > 0) {
                $(".jp-jplayer").each(function(g, h) {
                    $("#" + h.id).jPlayer("destroy")
                })
            }
        },
        outputCurrentQuestion: function() {
            var i = this;
            var g = i.result.get("Responses");
            var h = new a.Vs.TakeQuestion({
                question: g[i.currentQuestion],
                showFooter: true,
                showPrevious: i.currentQuestion > 0,
                showNext: i.currentQuestion < g.length - 1,
                number: i.currentQuestion + 1,
                preview: i.preview,
                albums: i.albums,
                showSaveForLater: i.assignment.get("SaveForLater")
            });
            p3.rV(h, i.Containers.Questions, true);
            h.on("moveNext", function() {
                i.moveNext()
            });
            h.on("movePrevious", function() {
                i.movePrevious()
            });
            h.on("submitAssessment", function() {
                i.submitAssessment()
            });
            h.on("responseRecorded", function(k, j) {
                i.updateResponse(k, j);
                if (!i.preview) {
                    i.saveResults(false)
                }
            });
            h.on("saveForLater", function() {
                i.saveAssessmentForLater()
            })
        },
        submitAssessment: function() {
            var g = this;
            p3.showConfirm("Submit Assessment", "Are you sure you want to submit this assessment?", null, function() {
                g.result.set("SubmitResults", true);
                p3.exitConfirmMode();
                g.saveResults(false)
            })
        },
        saveAssessmentForLater: function() {
            var g = this;
            p3.showConfirm("Save For Later", "Are you sure you want to save and exit this assessment? You will be able to resume later.", null, function() {
                g.result.set("SaveForLater", true);
                p3.exitConfirmMode();
                g.saveResults(false)
            })
        },
        submitAllClick: function(g) {
            var h = this;
            if ($(".box-validate").length == 0) {
                h.submitAssessment()
            }
        },
        saveForLaterClick: function(g) {
            var h = this;
            if ($(".box-validate").length == 0) {
                h.saveAssessmentForLater()
            }
        },
        getResults: function() {
            var m = this;
            var g;
            var k = m.assessment.get("Questions"),
                j = [];
            if (m.assignment.get("RandomizeQuestions")) {
                var l, h = k.length;
                for (g = 0; g < h; g++) {
                    l = Math.floor((Math.random() * (k.length - 1)));
                    k[l].ResponseOrder = g + 1;
                    j.push(k[l]);
                    k.splice(l, 1)
                }
            } else {
                for (g = 0; g < k.length; g++) {
                    k[g].ResponseOrder = g;
                    j.push(k[g])
                }
            }
            m.result.set("Responses", j)
        },
        getExistingResults: function() {
            var h = this;
            var g = new a.Ms.AssessmentResult();
            g.fetch({
                async: false,
                data: {
                    assessmentId: h.assessmentId,
                    assignmentIndexId: h.options.assignmentIndexId,
                    assessmentResultId: 0,
                    doSort: false,
                    userId: p3.Data.Context.get("UserInfo").UserId
                },
                success: function() {
                    g.set({
                        AssignmentId: h.options.assignmentId,
                        AssignmentIndexId: h.options.assignmentIndexId,
                        SaveForLater: false
                    })
                },
                error: function() {
                    p3.displayError("Error loading results")
                }
            });
            h.result = g
        },
        saveResults: function(m) {
            var n = this,
                k = 0,
                l = 0;
            var j = new Date(),
                g, h;
            if (m) {
                g = new Date(a.Us.getOffsetFromReferenceDate(n.assignment.get("TimeToComplete") * 60000))
            } else {
                g = new Date(a.Us.getOffsetFromReferenceDate(j.getTime() - n.startTime.getTime() + (n.existingMilliseconds || 0)))
            }
            if (n.preview) {
                n.result.urlRoot = "assessmentresult/preview"
            }
            if (n.assessment) {
                k = n.assessment.get("QuestionCount") || 0
            }
            if (n.result) {
                if (n.result.get("Responses")) {
                    l = n.result.get("Responses").length || 0
                }
            }
            if ((k > 0 || l > 0) && (k !== l)) {
                p3.displayError("Assessment error. The number of questions does not match the number of responses.")
            } else {
                n.result.save({
                    UserId: p3.Data.Context.get("UserInfo").UserId,
                    ResultTime: g.getHours() + ":" + g.getMinutes() + ":" + g.getSeconds() + "." + g.getMilliseconds(),
                    IsPreview: n.preview
                }, {
                    async: false,
                    success: function() {
                        if (n.result.get("SubmitResults")) {
                            if (n.assessTimer) {
                                window.clearInterval(n.assessTimer);
                                n.assessTimer = null
                            }
                            if (n.assessment.get("ShowOnComplete")) {
                                if (n.preview) {
                                    $("#submit-container").hide();
                                    $("#student-back-btn").show();
                                    if (n.assignment.get("MaxScoreInd") == 1) {
                                        var o = n.result.get("Responses");
                                        for (h = 0; h < o.length; h++) {
                                            o[h].Points = Math.round(o[h].Points * 100) / 100
                                        }
                                    }
                                    var p = new a.Vs.StudentResults({
                                        result: n.result,
                                        assessment: n.assessment,
                                        maxScore: n.assignment.get("MaxScore"),
                                        onComplete: true,
                                        assignment: n.assignment
                                    });
                                    p3.rV(p, n.Containers.Questions, true)
                                } else {
                                    if (n.assessment.get("RestrictResults")) {
                                        var i = new a.Ms.AssessmentReviewCheck();
                                        i.fetch({
                                            data: {
                                                assessmentId: n.assessment.get("AssessmentId"),
                                                assignmentIndexId: n.options.assignmentIndexId
                                            },
                                            error: function() {
                                                p3.displayError("Error checking assessment review status")
                                            },
                                            success: function() {
                                                if (i.get("assessment_locked")) {
                                                    window.history.go(-1)
                                                } else {
                                                    p3.router().navigate("#assessmentdetail/" + n.options.assignmentId + "/" + n.options.assignmentIndexId + "/0/" + p3.Data.Context.get("UserInfo").UserId + "/1", true)
                                                }
                                            }
                                        })
                                    } else {
                                        p3.router().navigate("#assessmentdetail/" + n.options.assignmentId + "/" + n.options.assignmentIndexId + "/0/" + p3.Data.Context.get("UserInfo").UserId + "/1", true)
                                    }
                                }
                            } else {
                                window.history.go(-1)
                            }
                            if (m) {
                                p3.displayError("Your time has expired.")
                            }
                        } else {
                            if (n.result.get("SaveForLater")) {
                                if (!n.Navigated) {
                                    n.Navigated = true;
                                    window.history.go(-1)
                                }
                            }
                        }
                    },
                    error: function() {
                        p3.displayError("Error saving results")
                    }
                })
            }
        },
        updateResponse: function(j, h) {
            var m = this;
            var k = m.result.get("Responses"),
                g;
            k[h].Response = j;
            switch (k[h].QuestionTypeId) {
                case 3:
                    var l = [];
                    if (j.toString().length > 0) {
                        l = j.toString().split(",")
                    }
                    for (g = 0; g < k[h].Answers.length; g++) {
                        if (l.indexOf(g.toString()) > -1) {
                            k[h].Answers[g].Selected = true
                        } else {
                            k[h].Answers[g].Selected = false
                        }
                    }
                    break;
                case 4:
                    if (j == 0) {
                        k[h].Answers[0].Selected = true
                    } else {
                        k[h].Answers[0].Selected = false
                    }
                    if (j == 1) {
                        k[h].Answers[1].Selected = true
                    } else {
                        k[h].Answers[1].Selected = false
                    }
                    break
            }
            m.result.set("Responses", k)
        }
    });
    a.Vs.TakeQuestion = Bb.View.extend({
        events: {
            "click #next-question-button": "moveNext",
            "click #previous-link": "movePrevious",
            "click #submit-button": "submitAssessment",
            "click .answer-button": "handleRadioClick",
            "keyup .essay-area": "updateCharacterCounter",
            "click .media-cover": "showMedia",
            "click .save-for-later-button": "saveForLater"
        },
        initialize: function() {
            this.question = this.options.question;
            this.showFooter = this.options.showFooter;
            this.showPrevious = this.options.showPrevious;
            this.showNext = this.options.showNext;
            this.number = this.options.number;
            this.preview = this.options.preview;
            this.albums = this.options.albums
        },
        dispose: function() {
            var g = tinyMCE.get("essay-answer-");
            if (g) {
                g.remove();
                g = null
            }
        },
        render: function(h) {
            var n = this,
                k = "",
                l = 0,
                j;
            $(h).append(n.el);
            switch (n.question.QuestionTypeId) {
                case 1:
                    n.template = "assessment/assessment.essay.template.html";
                    l = n.question.CharacterLimit;
                    break;
                case 2:
                    n.template = "assessment/assessment.fillin.template.html";
                    if (n.question.Description && n.question.Description.indexOf("_________") == -1) {
                        n.question.Description = n.question.Description.replace("_", "_________")
                    }
                    break;
                case 3:
                    n.template = "assessment/assessment.multi.template.html";
                    var m = [];
                    if (n.question.Response != null && n.question.Response.toString().length > 0) {
                        m = n.question.Response.toString().split(",")
                    }
                    for (j = 0; j < n.question.Answers.length; j++) {
                        n.question.Answers[j].Index = j;
                        if (m.indexOf(j.toString()) > -1) {
                            n.question.Answers[j].Selected = true
                        } else {
                            n.question.Answers[j].Selected = false
                        }
                    }
                    if (n.question.Checkboxes) {
                        k = "p3icon-check";
                        n.singleAnswer = false
                    } else {
                        k = "p3icon-radioOff";
                        n.singleAnswer = true
                    }
                    break;
                case 4:
                    n.template = "assessment/assessment.truefalse.template.html";
                    n.singleAnswer = true;
                    n.question.Answers[0].Index = 0;
                    if (n.question.Response != null && n.question.Response.toString().length > 0 && n.question.Response == 0) {
                        n.question.Answers[0].Selected = true
                    } else {
                        n.question.Answers[0].Selected = false
                    }
                    n.question.Answers[1].Index = 1;
                    if (n.question.Response != null && n.question.Response.toString().length > 0 && n.question.Response == 1) {
                        n.question.Answers[1].Selected = true
                    } else {
                        n.question.Answers[1].Selected = false
                    }
                    break
            }
            if (n.question.AlbumId > 0) {
                var g = n.albums.get(n.question.AlbumId);
                if (g) {
                    n.question.FileCount = g.get("num_files");
                    n.question.ProcessedCount = g.get("files_processed");
                    n.question.CoverFile = g.get("filename")
                }
            }
            p3.fT(n.template, function(i) {
                n.$el.html(i({
                    question: n.question,
                    showFooter: n.showFooter,
                    showPrevious: n.showPrevious,
                    showNext: n.showNext,
                    number: n.number,
                    icon: k,
                    maxChars: l,
                    showSaveForLater: n.options.showSaveForLater
                }));
                if (n.question.ContentId == 165) {
                    n.renderAudio(n.question.AlbumId)
                }
                if (n.question.UseEditor) {
                    p3.showHtmlEditor("essay-answer-" + n.number, p3.Us.Enum.HtmlEditorCategories.FULL, false, function() {
                        var o = tinyMCE.get("essay-answer-" + n.number);
                        if (o !== undefined) {
                            if (n.question.CharacterLimit) {
                                n.$(".characterCounter").html(o.save().length);
                                if (o.save().length > n.question.CharacterLimit) {
                                    n.$(".characterCounter").addClass("badge-important")
                                } else {
                                    n.$(".characterCounter").removeClass("badge-important")
                                }
                            }
                            o.onChange.add(function(r, q) {
                                var s = true;
                                if (n.question.CharacterLimit) {
                                    var p = r.getContent().length;
                                    n.$(".characterCounter").html(p);
                                    if (p > n.question.CharacterLimit) {
                                        n.$(".characterCounter").addClass("badge-important");
                                        n.$(".wContainer").addClass("box-validate");
                                        s = false
                                    } else {
                                        n.$(".characterCounter").removeClass("badge-important");
                                        n.$(".wContainer").removeClass("box-validate")
                                    }
                                }
                                if (s) {
                                    n.trigger("responseRecorded", r.getContent(), n.number - 1)
                                }
                            });
                            o.onKeyUp.add(function(r, q) {
                                if (n.question.CharacterLimit) {
                                    var p = r.getContent().length;
                                    n.$(".characterCounter").html(p);
                                    if (p > n.question.CharacterLimit) {
                                        n.$(".characterCounter").addClass("badge-important")
                                    } else {
                                        n.$(".characterCounter").removeClass("badge-important")
                                    }
                                }
                            });
                            o.onSetContent.add(function(r, q) {
                                var s = true;
                                if (n.question.CharacterLimit) {
                                    var p = r.getContent().length;
                                    n.$(".characterCounter").html(p);
                                    if (p > n.question.CharacterLimit) {
                                        n.$(".characterCounter").addClass("badge-important");
                                        n.$(".wContainer").addClass("box-validate");
                                        s = false
                                    } else {
                                        n.$(".characterCounter").removeClass("badge-important");
                                        n.$(".wContainer").removeClass("box-validate")
                                    }
                                }
                                if (s) {
                                    n.trigger("responseRecorded", r.getContent(), n.number - 1)
                                }
                            })
                        }
                    }, p3.Us.Enum.HtmlEditorEncoding.NUMERIC)
                }
                $("#answer-box-" + n.number).bind("change", function(o) {
                    n.trigger("responseRecorded", $("#answer-box-" + n.number).val(), n.number - 1)
                });
                $("#essay-answer-" + n.number).bind("change", function(o) {
                    n.trigger("responseRecorded", $("#essay-answer-" + n.number).val(), n.number - 1)
                });
                p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.MathJax, function() {
                    MathJax.Hub.Queue(["Typeset", MathJax.Hub])
                })
            })
        },
        moveNext: function(g) {
            if ($(".box-validate").length == 0) {
                this.trigger("moveNext")
            }
            return false
        },
        movePrevious: function(g) {
            if ($(".box-validate").length == 0) {
                this.trigger("movePrevious")
            }
            return false
        },
        submitAssessment: function(g) {
            var h = this;
            if ($(".box-validate").length == 0) {
                h.trigger("submitAssessment")
            }
        },
        saveForLater: function(g) {
            var h = this;
            if ($(".box-validate").length == 0) {
                h.trigger("saveForLater")
            }
        },
        handleRadioClick: function(i) {
            var k = this;
            var h = $(i.currentTarget),
                g;
            if (k.singleAnswer) {
                g = h.parentsUntil("#question-container");
                g.find(".answer-button.active").removeClass("active");
                k.trigger("responseRecorded", h.data("index"), k.number - 1)
            } else {
                var j = "";
                if (!h.hasClass("active")) {
                    j = h.data("index").toString()
                }
                g = h.parentsUntil("#question-container");
                g.find(".answer-button.active").each(function(l, m) {
                    if ($(m).data("index") != h.data("index")) {
                        if (j.length > 0) {
                            j += ","
                        }
                        j += $(m).data("index").toString()
                    }
                });
                k.trigger("responseRecorded", j, k.number - 1)
            }
        },
        updateCharacterCounter: function(g) {
            var h = this;
            if (h.question.CharacterLimit) {
                g.stopPropagation();
                g.preventDefault();
                $("#counter-" + h.number).html($(g.currentTarget).val().length);
                if ($(g.currentTarget).val().length > h.question.CharacterLimit) {
                    $("#counter-" + h.number).addClass("badge-important")
                } else {
                    $("#counter-" + h.number).removeClass("badge-important")
                }
            }
        },
        showMedia: function(j) {
            var g = $(j.target).attr("data-album"),
                i = $(j.target).attr("data-content"),
                h = "";
            switch (i) {
                case "31":
                    h = "photo";
                    break;
                case "165":
                    h = "audio";
                    break;
                case "167":
                    h = "video";
                    break;
                default:
                    break
            }
            f.Us.showModal(g, h);
            return false
        },
        renderAudio: function(g) {
            var i = this;
            var h = new f.Cs.Medias();
            h.fetch({
                data: {
                    albumId: g,
                    logView: 1
                },
                success: function() {
                    var k = 0;
                    h.each(function(l) {
                        l.set({
                            index: k,
                            number: k + 1
                        }, {
                            silent: true
                        });
                        if (!l.get("title")) {
                            l.set({
                                title: "Track " + (k + 1)
                            }, {
                                silent: true
                            })
                        }
                        l.set("number", i.number + "_" + l.get("number").toString());
                        i.allowDownload = l.get("allow_download");
                        k += 1
                    });
                    var j = new f.Vs.Audio({
                        collection: h,
                        itemIndex: 1,
                        isAssessment: true
                    });
                    p3.rV(j, "#audio-player-" + i.number, true);
                    window.setTimeout(function() {
                        $(".jp-title").css("color", "black");
                        $(".jp-pause").css("line-height", "24px !important")
                    }, 100)
                },
                error: function() {
                    p3.displayError("Error loading audio")
                }
            })
        }
    });
    a.Vs.StudentResults = Bb.View.extend({
        template: "assessment/assessment.student.results.template.html",
        events: {
            "click #retake-button": "startRetake",
            "click #BackButton": "goBack",
            "click .comment-link": "toggleComment"
        },
        initialize: function() {
            this.onComplete = this.options.onComplete
        },
        dispose: function() {
            if (!this.onComplete) {
                $("#site-main").addClass("container");
                $("body").removeClass("graniteCountertop")
            }
        },
        render: function(g) {
            var h = this;
            $(g).html(h.el);
            h.renderTemplate()
        },
        renderTemplate: function() {
            var g = this;
            p3.fT(g.template, function(t) {
                var k = 0,
                    m = 0,
                    p = 0,
                    o = 0,
                    q = g.options.result.get("Responses"),
                    l, n, h;
                if (q) {
                    for (l = 0; l < q.length; l++) {
                        switch (q[l].Correct) {
                            case 0:
                                m += 1;
                                break;
                            case 1:
                                k += 1;
                                break;
                            case 2:
                                p += 1;
                                break;
                            case 3:
                                o += 1;
                                break
                        }
                        q[l].DisplayOrder = l + 1;
                        if (q[l].QuestionTypeId == 3 || q[l].QuestionTypeId == 4) {
                            for (n = 0; n < q[l].Answers.length; n++) {
                                h = q[l].Answers[n];
                                if (h.IsCorrect && (h.Selected || g.options.assessment.get("ShowAnswers"))) {
                                    h.iconClass = "p3icon-ok"
                                } else {
                                    if (h.Selected) {
                                        h.iconClass = "p3icon-delete"
                                    } else {
                                        h.iconClass = "p3icon-radioOff"
                                    }
                                }
                            }
                        }
                        if (q[l].Comment) {
                            q[l].Comment = q[l].Comment.replace(/[\n\r]/g, "<br />")
                        }
                    }
                }
                var s = a.Us.getTimeDisplayForMilliseconds(g.options.result.get("SavedMilliseconds"));
                var r = "";
                if (g.options.assignment) {
                    r = g.options.assignment.get("ShortDescription")
                }
                g.$el.html(t({
                    result: g.options.result.toJSON(),
                    correct: k,
                    incorrect: m,
                    pending: p,
                    partial: o,
                    assessment: g.options.assessment.toJSON(),
                    maxScore: g.options.maxScore,
                    onComplete: g.onComplete,
                    timeTaken: s,
                    shortDescription: r,
                    publishGrade: g.options.assignment.get("PublishGrade") || !g.options.assignment.get("IncGradeBook")
                }));
                if (!g.onComplete) {
                    window.setTimeout(function() {
                        $("body").addClass("graniteCountertop")
                    }, 100)
                }
                p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.MathJax, function() {
                    MathJax.Hub.Queue(["Typeset", MathJax.Hub])
                })
            })
        },
        startRetake: function(g) {
            var h = this;
            p3.renderMainPage(new a.Vs.Take({
                assignmentId: h.options.result.get("AssignmentId"),
                assignmentIndexId: h.options.result.get("AssignmentIndexId"),
                preview: false,
                resume: false
            }))
        },
        goBack: function(h) {
            var g = -1;
            if (this.options.take) {
                g = -2
            }
            window.history.go(g)
        },
        toggleComment: function(h) {
            var g = $(h.currentTarget),
                i = g.data("order");
            $("#comment" + i).toggle();
            return false
        }
    });
    a.Vs.PrintResults = Bb.View.extend({
        template: "assessment/assessment.print.results.template.html",
        render: function(g) {
            var h = this;
            $(g).html(h.el);
            h.renderTemplate()
        },
        renderTemplate: function() {
            var l = this,
                h, k, g;
            p3.fT(l.template, function(w) {
                var i = 0,
                    m = 0,
                    p = 0,
                    o = 0,
                    q = l.options.result.get("Responses"),
                    j, u;
                for (h = 0; h < q.length; h++) {
                    switch (q[h].Correct) {
                        case 0:
                            m += 1;
                            break;
                        case 1:
                            i += 1;
                            break;
                        case 2:
                            p += 1;
                            break;
                        case 3:
                            o += 1;
                            break
                    }
                    q[h].DisplayOrder = h + 1;
                    if (q[h].QuestionTypeId == 3 || q[h].QuestionTypeId == 4) {
                        for (k = 0; k < q[h].Answers.length; k++) {
                            g = q[h].Answers[k];
                            if (g.IsCorrect) {
                                g.iconClass = "p3icon-ok"
                            } else {
                                if (g.Selected) {
                                    g.iconClass = "p3icon-delete"
                                } else {
                                    g.iconClass = "p3icon-radioOff"
                                }
                            }
                        }
                    }
                    if (q[h].Comment) {
                        q[h].Comment = q[h].Comment.replace(/[\n\r]/g, "<br />")
                    }
                }
                var v = a.Us.getTimeDisplayForMilliseconds(l.options.result.get("SavedMilliseconds"));
                var s = "";
                if (l.options.assignment) {
                    s = l.options.assignment.get("ShortDescription");
                    var r = l.options.assignment.get("SectionLinks"),
                        n = l.options.result.get("AssignmentIndexId");
                    for (h = 0; h < r.length; h++) {
                        if (r[h].AssignmentIndexId == n) {
                            j = r[h].Section.Name;
                            break
                        }
                    }
                }
                var t = new a.Cs.StudentInfo();
                t.fetch({
                    async: false,
                    data: {
                        userId: l.options.studentId
                    },
                    error: function() {
                        p3.displayError("Error loading user information")
                    },
                    success: function() {
                        u = t.models[0].get("fullname")
                    }
                });
                l.$el.html(w({
                    result: l.options.result.toJSON(),
                    correct: i,
                    incorrect: m,
                    pending: p,
                    partial: o,
                    assessment: l.options.assessment.toJSON(),
                    maxScore: l.options.maxScore,
                    onComplete: l.onComplete,
                    timeTaken: v,
                    shortDescription: s,
                    course: j,
                    studentName: u
                }));
                if (!l.onComplete) {
                    window.setTimeout(function() {
                        $("body").addClass("graniteCountertop")
                    }, 100)
                }
                p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.MathJax, function() {
                    MathJax.Hub.Queue(["Typeset", MathJax.Hub])
                })
            })
        }
    });
    a.Vs.SectionDetails = Bb.View.extend({
        template: "assessment/assessment.detail.template.html",
        events: {
            "click #BackButton": "goBack",
            "click .student-result-btn": "openStudentDialog",
            "click #bulk-commit-button": "bulkCommit",
            "click #breakdown-button": "openBreakdownDialog",
            "click .allow-continue-link": "continueClick",
            "click #bulk-continue-button": "bulkContinueClick"
        },
        render: function(g) {
            var h = this;
            $(g).html(h.el);
            h.renderTemplate()
        },
        renderTemplate: function() {
            var g = this;
            g.assignment = new b.Ms.Assignment();
            g.assignment.set("AssignmentId", g.options.assignmentId);
            g.assignment.fetch({
                error: function() {
                    p3.displayError("Error loading assignment")
                },
                success: function(h, i) {
                    g.assessmentId = g.assignment.get("AssessmentId");
                    g.assessment = new a.Ms.Assessment({
                        AssessmentId: g.assessmentId,
                        AssignmentId: g.options.assignmentId
                    });
                    g.assessment.fetch({
                        async: false,
                        data: {
                            assessmentId: g.assessmentId
                        }
                    });
                    g.renderRoster()
                }
            })
        },
        renderRoster: function() {
            var h = this;
            var g = new a.Cs.AssessmentRoster();
            h.roster = g;
            g.fetch({
                async: false,
                data: {
                    assignmentIndexId: h.options.assignmentIndexId
                },
                success: function(t, x) {
                    var z = _.find(h.assignment.get("SectionLinks"), function(i) {
                        return i.AssignmentIndexId == h.options.assignmentIndexId
                    });
                    var v = false,
                        u = new Date(),
                        G = new Date(u.getFullYear(), u.getMonth(), u.getDate()),
                        o = new Date(z.DueDate),
                        E = 0,
                        m = false,
                        H = 0,
                        I = 0,
                        J = 0,
                        F = [],
                        n = 0,
                        p = 0,
                        B = new a.Cs.AssessmentRoster(),
                        q, D, C, A = false,
                        s;
                    v = (o < G);
                    B.remove(B.at(0));
                    h.submissions = B;
                    g.each(function(i) {
                        q = "";
                        D = "";
                        C = "";
                        if (i.get("grad_year")) {
                            i.set("year", "'" + i.get("grad_year").substring(2))
                        } else {
                            i.set("year", "")
                        }
                        if (i.get("points_earned") != null) {
                            p += 1;
                            q = (Math.round(i.get("points_earned") * 100) / 100).toString()
                        } else {
                            if (i.get("letter_grade")) {
                                p += 1;
                                q = i.get("letter_grade")
                            } else {
                                if (i.get("graded_ind") === true) {
                                    p += 1;
                                    q = "*"
                                }
                            }
                        }
                        i.set("GBDisplay", q);
                        if (i.get("submitted_date_local")) {
                            E += 1;
                            D = c.getDateString(c.getDate(i.get("submitted_date_local"))) + " at " + c.getTimeString(c.getDate(i.get("submitted_date_local")));
                            B.add(i);
                            i.set("PointsDisplay", Math.round(i.get("results_total_points") * 100) / 100);
                            if (i.get("results_total_time")) {
                                F = i.get("results_total_time").split(":");
                                H += parseInt(F[0], 10);
                                I += parseInt(F[1], 10);
                                J += parseFloat(F[2])
                            }
                        } else {
                            if (i.get("assessment_results_id") > 0) {
                                if (!i.get("paused_ind")) {
                                    i.set("inprogress", true);
                                    A = true
                                }
                            } else {
                                if (v) {
                                    i.set("overdue", true)
                                }
                            }
                            D = "--"
                        }
                        if (i.get("exempt")) {
                            C = C + "exempt; "
                        }
                        if (i.get("incomplete")) {
                            C = C + "incomplete; "
                        }
                        if (i.get("missing")) {
                            C = C + "missing; "
                        }
                        if (i.get("num_days_late")) {
                            C = C + "extend " + i.get("num_days_late").toString() + " days; "
                        } else {
                            if (i.get("late")) {
                                C = C + "extend 0 days; "
                            }
                        }
                        if (C.length > 0) {
                            D = D + "  *(" + C.substring(0, C.length - 2) + ")"
                        }
                        i.set("submitted", D)
                    });
                    if (E > n) {
                        m = true;
                        var w = h.assessment.get("Questions");
                        for (s = 0; s < w.length; s++) {
                            if (w[s].QuestionTypeId == 1) {
                                m = false;
                                break
                            }
                        }
                    }
                    var l = "";
                    if (E > 0 && (J > 0 || I > 0 || H > 0)) {
                        I += (H * 60);
                        J += (I * 60);
                        var y = J / E;
                        var j = Math.floor(y / 3600),
                            r = false;
                        if (j > 0) {
                            r = true;
                            l += j + ":";
                            y = y - (j * 3600)
                        }
                        var k = Math.floor(y / 60);
                        if (k > 0) {
                            if (k < 10) {
                                l += "0"
                            }
                            l += k;
                            y = y - (k * 60)
                        } else {
                            if (r) {
                                l += "00"
                            }
                        }
                        l += ":";
                        y = Math.round(y);
                        if (y < 10) {
                            l += "0"
                        }
                        l += y
                    }
                    p3.fT(h.template, function(i) {
                        h.$el.html(i({
                            students: g.toJSON(),
                            total: g.length,
                            completed: p,
                            print: h.options.print == "1",
                            rootUrl: p3.Config.RootPath,
                            aid: h.options.assignmentId,
                            aiid: h.options.assignmentIndexId,
                            title: h.assignment.get("ShortDescription"),
                            adate: z.AssignmentDate,
                            ddate: z.DueDate,
                            sectionName: z.Section.Name,
                            submitted: E,
                            gradebook: h.assignment.get("IncGradeBook"),
                            bulkCommit: m,
                            maxScore: h.assignment.get("MaxScore"),
                            averageTime: l,
                            showBulkContinue: A
                        }))
                    })
                },
                error: function() {
                    p3.displayError("Error loading students")
                }
            })
        },
        goBack: function(g) {
            window.history.go(-1)
        },
        openStudentDialog: function(h) {
            var o = this;
            var g = $(h.currentTarget);
            var n = g.data("id"),
                k = g.data("result"),
                l = -1,
                j;
            for (j = 0; j < o.submissions.length; j++) {
                if (o.submissions.models[j].get("user_id") == n) {
                    l = j;
                    break
                }
            }
            var m = new a.Vs.TeacherReview({
                userId: n,
                resultId: k,
                resultIndex: l,
                submissions: o.submissions,
                assignment: o.assignment,
                assessmentId: o.assessmentId,
                assessment: o.assessment,
                assignmentIndexId: o.options.assignmentIndexId,
                roster: o.roster
            });
            p3.rV(m, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            m.on("resultSaved", function() {
                o.renderRoster()
            })
        },
        bulkCommit: function(g) {
            var h = this;
            p3.showConfirm("Bulk Commit", "Are you sure you want to commit all submitted assessments to the grade book?", null, function() {
                var i = new a.Ms.BulkCommit();
                i.save({
                    assignmentIndexId: h.options.assignmentIndexId
                }, {
                    success: function() {
                        h.renderRoster()
                    },
                    error: function() {
                        p3.displayError("Bulk Commit Error")
                    }
                })
            })
        },
        openBreakdownDialog: function(g) {
            var h = this;
            p3.rV(new a.Vs.DetailBreakdown({
                assignment: h.assignment,
                assessmentId: h.assessmentId,
                assessment: h.assessment,
                assignmentIndexId: h.options.assignmentIndexId
            }), p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            return false
        },
        continueClick: function(g) {
            var h = this;
            g.preventDefault();
            p3.showConfirm("Allow Continue", "Are you sure you want to allow this student to continue the assessment?", null, function() {
                h.pauseIncompleteAssessments($(g.currentTarget).data("id"))
            })
        },
        bulkContinueClick: function(g) {
            var i = this,
                h = "";
            p3.showConfirm("Allow Continue", "Are you sure you want to allow all incomplete assessments to be continued?", null, function() {
                i.roster.each(function(j) {
                    if (j.get("inprogress")) {
                        if (h.length > 0) {
                            h += ","
                        }
                        h += j.get("assessment_results_id")
                    }
                });
                i.pauseIncompleteAssessments(h)
            })
        },
        pauseIncompleteAssessments: function(g) {
            var i = this,
                h = new a.Ms.AssessmentPause({
                    resultIds: g,
                    assignmentIndexId: i.options.assignmentIndexId
                });
            h.save({}, {
                success: function() {
                    i.renderRoster()
                },
                error: function() {
                    p3.displayError("Error pausing assessments.")
                }
            })
        }
    });
    a.Vs.TeacherReview = Bb.View.extend({
        template: "assessment/assessment.teacher.review.template.html",
        events: {
            "click #btnSave": "saveClick",
            "click #btnCommit": "commitClick",
            "change .points-box": "updatePoints",
            "click .comment-link": "toggleComment",
            "click #retake-button": "setCommitStatus"
        },
        initialize: function() {
            var g = this;
            g.userId = g.options.userId;
            g.resultId = g.options.resultId;
            g.resultIndex = g.options.resultIndex;
            g.submissions = g.options.submissions;
            g.assignment = g.options.assignment;
            g.assessmentId = g.options.assessmentId;
            g.assessment = g.options.assessment;
            g.assignmentIndexId = g.options.assignmentIndexId;
            g.roster = g.options.roster
        },
        render: function(g) {
            var h = this;
            $(g).html(h.el);
            h.renderTemplate()
        },
        renderTemplate: function() {
            var k = this,
                g;
            k.showRetake = false;
            var h = new a.Ms.AssessmentFacultyResult();
            k.result = h;
            if (k.resultId > 0 && k.resultIndex >= 0) {
                h.fetch({
                    async: false,
                    data: {
                        assessmentId: k.assessmentId,
                        assignmentIndexId: k.assignmentIndexId,
                        assessmentResultId: k.resultId,
                        doSort: true,
                        userId: p3.Data.Context.get("UserInfo").UserId
                    },
                    success: function() {
                        h.set({
                            AssignmentId: k.options.assignmentId,
                            AssignmentIndexId: k.assignmentIndexId
                        });
                        var l = 0,
                            m = 0,
                            p = 0,
                            o = 0,
                            r = h.get("Responses");
                        var q = 0,
                            n, i;
                        if (k.assignment.get("MaxScoreInd") == 1) {
                            q = Math.round((k.assignment.get("MaxScore") / r.length) * 100) / 100
                        }
                        if (h.get("AttemptNumber") >= k.assignment.get("NumberOfAttempts") || h.get("PointsEarned") >= 0) {
                            k.showRetake = true
                        }
                        for (g = 0; g < r.length; g++) {
                            switch (r[g].Correct) {
                                case 0:
                                    m += 1;
                                    break;
                                case 1:
                                    l += 1;
                                    break;
                                case 2:
                                    p += 1;
                                    break;
                                case 3:
                                    o += 1;
                                    break
                            }
                            r[g].DisplayOrder = g + 1;
                            if (k.assignment.get("MaxScoreInd") == 1) {
                                r[g].Points = q
                            }
                            if (r[g].QuestionTypeId == 3 || r[g].QuestionTypeId == 4) {
                                for (n = 0; n < r[g].Answers.length; n++) {
                                    i = r[g].Answers[n];
                                    if (i.IsCorrect) {
                                        i.iconClass = "p3icon-ok"
                                    } else {
                                        if (i.Selected) {
                                            i.iconClass = "p3icon-delete"
                                        } else {
                                            i.iconClass = "p3icon-radioOff"
                                        }
                                    }
                                }
                            }
                        }
                        var s = k.submissions.models[k.resultIndex];
                        if (s.get("points_earned")) {
                            s.set("TotalDisplay", Math.round(s.get("points_earned") * 100) / 100);
                            s.set("IsCommitted", true)
                        } else {
                            if (s.get("letter_grade")) {
                                s.set("TotalDisplay", s.get("letter_grade"));
                                s.set("IsCommitted", true)
                            } else {
                                s.set("TotalDisplay", Math.round(s.get("results_total_points") * 100) / 100)
                            }
                        }
                        var t = a.Us.getTimeDisplayForMilliseconds(h.get("SavedMilliseconds"));
                        p3.fT(k.template, function(u) {
                            k.$el.html(u({
                                submission: s.toJSON(),
                                assignment: k.assignment.toJSON(),
                                schoolId: p3.Data.SchoolContext.get("SchoolInfo").SchoolId,
                                assessment: k.assessment,
                                correct: l,
                                incorrect: m,
                                pending: p,
                                result: h.toJSON(),
                                partial: o,
                                timeTaken: t,
                                showRetake: k.showRetake,
                                host: location.protocol + "//" + location.host + location.pathname,
                                studentId: k.options.userId
                            }));
                            p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.MathJax, function() {
                                MathJax.Hub.Queue(["Typeset", MathJax.Hub])
                            })
                        })
                    },
                    error: function() {
                        p3.displayError("Error loading results")
                    }
                })
            } else {
                var j;
                k.showRetake = k.resultId > 0;
                k.roster.each(function(i) {
                    if (i.get("user_id") == k.userId) {
                        j = i.toJSON()
                    }
                });
                if (k.resultId > 0) {
                    h.fetch({
                        async: false,
                        data: {
                            assessmentId: k.assessmentId,
                            assignmentIndexId: k.assignmentIndexId,
                            assessmentResultId: k.resultId,
                            doSort: false,
                            userId: p3.Data.Context.get("UserInfo").UserId
                        },
                        success: function() {
                            h.set("Responses", [])
                        },
                        error: function() {
                            p3.displayError("Error loading results")
                        }
                    })
                }
                h.set({
                    AssignmentId: k.options.assignmentId,
                    AssignmentIndexId: k.assignmentIndexId,
                    AssessmentId: k.assessmentId,
                    DaysLate: j.num_days_late,
                    Exempt: j.exempt,
                    Incomplete: j.incomplete,
                    Late: j.late,
                    Missing: j.missing,
                    AssessmentResultId: k.resultId
                });
                p3.fT(k.template, function(i) {
                    k.$el.html(i({
                        assignment: k.assignment.toJSON(),
                        schoolId: p3.Data.SchoolContext.get("SchoolInfo").SchoolId,
                        result: h.toJSON(),
                        assessment: k.assessment,
                        correct: 0,
                        incorrect: 0,
                        pending: 0,
                        partial: 0,
                        timeTaken: "--",
                        notSubmitted: true,
                        submission: j,
                        showRetake: k.showRetake
                    }));
                    p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.MathJax, function() {
                        MathJax.Hub.Queue(["Typeset", MathJax.Hub])
                    })
                })
            }
        },
        saveClick: function(g) {
            if (this.validateSave(false)) {
                this.saveResult(false)
            }
        },
        commitClick: function(g) {
            if (this.validateSave(true)) {
                this.saveResult(true)
            }
        },
        validateSave: function(g) {
            var h = true;
            if ($(".box-validate").length > 0) {
                h = false
            } else {
                if (g) {
                    if ($(".responseAwaiting").length > 0) {
                        h = false;
                        $(".responseAwaiting").find(".points-box").attr("data-original-title", "Points required.").tooltip({
                            placement: "right"
                        }).addClass("box-validate")
                    }
                }
            }
            return h
        },
        saveResult: function(g) {
            var n = this,
                k = [],
                l = new Date(),
                m = n.resultId > 0 && n.resultIndex >= 0,
                j, h;
            if (m) {
                l = n.result.get("SavedDateTime");
                j = n.result.get("Responses");
                for (h = 0; h < j.length; h++) {
                    k.push({
                        SortOrder: j[h].SortOrder,
                        ResponseOrder: j[h].ResponseOrder,
                        Response: j[h].Response.toString(),
                        Correct: j[h].Correct.toString(),
                        PointsEarned: j[h].PointsEarned,
                        Comment: $("#comment" + (h + 1)).find(".review-comment").val()
                    })
                }
            }
            n.result.urlRoot = "/api/assessmentresult/edit";
            n.result.save({
                SubmitResults: m,
                PostToGradebook: g,
                TeacherReview: true,
                Responses: k,
                Exempt: $("#exempt-button").hasClass("active"),
                Incomplete: $("#incomplete-button").hasClass("active"),
                Missing: $("#missing-button").hasClass("active"),
                Late: $("#late-button").hasClass("active"),
                DaysLate: $("#days-late-box").val(),
                UserId: n.userId,
                ResultTime: l,
                AllowRetake: n.showRetake && $("#retake-button").hasClass("active")
            }, {
                success: function() {
                    n.trigger("resultSaved");
                    p3.showModal(p3.Layout.Containers.Modal, "hide")
                },
                error: function() {
                    p3.displayError("Error saving results")
                }
            })
        },
        updatePoints: function(o) {
            var z = this;
            var h = $(o.currentTarget);
            var r = h.data("order") - 1;
            var w = z.result.get("Responses"),
                u = w[r],
                t = 0,
                q = 0,
                l = 0,
                j = 0,
                s = 0,
                y = 0,
                m = false,
                p;
            h.removeClass("box-validate");
            h.attr("data-original-title", "");
            if (/^\d*(\.\d{1,})?$/.test(h.val())) {
                if (h.val().length) {
                    t = parseFloat(h.val())
                }
                if (t > u.Points) {
                    h.attr("data-original-title", "Value is greater than the maximum points.");
                    h.tooltip({
                        placement: "right"
                    });
                    h.addClass("box-validate")
                } else {
                    u.PointsEarned = t;
                    var n = 0;
                    if (t > 0) {
                        if (t == u.Points) {
                            n = 1
                        } else {
                            n = 3
                        }
                    }
                    if (n != u.Correct) {
                        m = true;
                        u.Correct = n
                    }
                    for (p = 0; p < w.length; p++) {
                        switch (w[p].Correct) {
                            case 0:
                                q += 1;
                                break;
                            case 1:
                                l += 1;
                                break;
                            case 2:
                                j += 1;
                                break;
                            case 3:
                                s += 1;
                                break
                        }
                        y += w[p].PointsEarned
                    }
                    $("#points-earned").html(Math.round(y * 100) / 100);
                    if (m) {
                        var x, v, k;
                        switch (n) {
                            case 0:
                                x = "Incorrect";
                                k = "p3Red";
                                v = "responseIncorrect";
                                break;
                            case 1:
                                x = "Correct";
                                k = "p3Green";
                                v = "responseCorrect";
                                break;
                            case 3:
                                x = "Partial";
                                k = "p3Blue";
                                v = "responsePartial";
                                break
                        }
                        var g = h.parents(".point-container");
                        g.removeClass("responseIncorrect responseCorrect responseAwaiting responsePartial").addClass(v);
                        g.find(".point-type-box").removeClass("p3Gold p3Green p3Red p3Blue").addClass(k);
                        g.find(".point-type").html(x);
                        $("#correct-count").html(l);
                        $("#incorrect-count").html(q);
                        $("#awaiting-count").html(j);
                        $("#partial-count").html(s)
                    }
                    z.result.set("Responses", w)
                }
            } else {
                h.attr("data-original-title", d.P3.NotNumeric);
                h.tooltip({
                    placement: "right"
                });
                h.addClass("box-validate")
            }
        },
        toggleComment: function(h) {
            var g = $(h.currentTarget),
                i = g.data("order");
            $("#comment" + i).toggle();
            return false
        },
        setCommitStatus: function(g) {
            if ($("#btnCommit").length > 0 && $("#btnCommit").html() == "Commit to Grade Book") {
                if ($(g.currentTarget).hasClass("active")) {
                    $("#btnCommit").attr("disabled", false)
                } else {
                    $("#btnCommit").attr("disabled", true)
                }
            }
        }
    });
    a.Vs.DetailBreakdown = Bb.View.extend({
        template: "assessment/assessment.breakdown.template.html",
        events: {
            "click .answer-link": "toggleAnswers",
            "click #btn-expand-all": "toggleAllAnswers"
        },
        initialize: function() {
            var g = this;
            g.assignment = g.options.assignment;
            g.assessmentId = g.options.assessmentId;
            g.assessment = g.options.assessment;
            g.assignmentIndexId = g.options.assignmentIndexId
        },
        render: function(g) {
            var h = this;
            $(g).html(h.el);
            h.renderTemplate()
        },
        renderTemplate: function() {
            var h = this;
            var g = new a.Ms.AssessmentBreakdown();
            g.fetch({
                data: {
                    assessmentId: h.assessmentId,
                    assignmentIndexId: h.assignmentIndexId
                },
                success: function() {
                    var k = g.get("Responses"),
                        j;
                    for (j = 0; j < k.length; j++) {
                        k[j].Number = k[j].SortOrder + 1
                    }
                    p3.fT(h.template, function(i) {
                        h.$el.html(i({
                            questions: k
                        }));
                        p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.MathJax, function() {
                            MathJax.Hub.Queue(["Typeset", MathJax.Hub])
                        })
                    })
                },
                error: function() {
                    p3.displayError("Error loading breakdown")
                }
            })
        },
        toggleAnswers: function(h) {
            var g = $(h.currentTarget),
                i = g.data("num");
            $(".answer-detail[data-num='" + i + "']").toggle();
            p3.setModalHeight(p3.Layout.Containers.Modal);
            if ($(".answer-detail:hidden").length == 0) {
                $("#btn-expand-all").removeClass("expand");
                $("#btn-expand-all").html("Collapse All")
            } else {
                if ($(".answer-detail:hidden").length == $(".answer-detail").length) {
                    $("#btn-expand-all").addClass("expand");
                    $("#btn-expand-all").html("Expand All")
                }
            }
            return false
        },
        toggleAllAnswers: function(g) {
            if ($("#btn-expand-all").hasClass("expand")) {
                $("#btn-expand-all").removeClass("expand");
                $("#btn-expand-all").html("Collapse All");
                $(".answer-detail").show()
            } else {
                $("#btn-expand-all").addClass("expand");
                $("#btn-expand-all").html("Expand All");
                $(".answer-detail").hide()
            }
            p3.setModalHeight(p3.Layout.Containers.Modal);
            return false
        }
    });
    a.Us.getQuestionTypeName = function(g) {
        var h = "";
        switch (g) {
            case 1:
                h = "Essay";
                break;
            case 2:
                h = "Fill in the Blank";
                break;
            case 3:
                h = "Multi Choice";
                break;
            case 4:
                h = "True/False";
                break
        }
        return h
    };
    a.Us.showStudentReview = function(h, i, j, k) {
        var g = new b.Ms.AssignmentGet();
        g.set("AssignmentId", h);
        g.fetch({
            error: function() {
                p3.displayError("Error loading assignment")
            },
            success: function(m, n) {
                var l = new a.Ms.AssessmentStudentReview({
                    AssessmentId: g.get("AssessmentId"),
                    AssignmentId: h
                });
                l.fetch({
                    data: {
                        assessmentId: g.get("AssessmentId"),
                        assignmentIndexId: i
                    },
                    error: function() {
                        p3.displayError("Error loading assessment")
                    },
                    success: function() {
                        var o = new a.Ms.AssessmentResult();
                        o.fetch({
                            data: {
                                assessmentId: g.get("AssessmentId"),
                                assignmentIndexId: i,
                                assessmentResultId: 0,
                                doSort: false,
                                userId: j
                            },
                            success: function() {
                                o.set({
                                    AssignmentId: h,
                                    AssignmentIndexId: i
                                });
                                if (o.get("PointsEarned") < 0) {
                                    o.set("PointsEarned", 0)
                                }
                                var r = o.get("Responses"),
                                    q = 0,
                                    p;
                                if (r) {
                                    if (g.get("MaxScoreInd") == 1) {
                                        q = Math.round((g.get("MaxScore") / r.length) * 100) / 100
                                    }
                                    for (p = 0; p < r.length; p++) {
                                        if (g.get("MaxScoreInd") == 1) {
                                            r[p].Points = q;
                                            r[p].PointsEarned = Math.round(r[p].PointsEarned * 100) / 100
                                        }
                                    }
                                }
                                var s = new a.Vs.StudentResults({
                                    result: o,
                                    assessment: l,
                                    maxScore: g.get("MaxScore"),
                                    onComplete: false,
                                    assignment: g,
                                    take: k
                                });
                                p3.renderMainPage(s)
                            },
                            error: function() {
                                p3.displayError("Error loading results")
                            }
                        })
                    }
                })
            }
        })
    };
    a.Us.printResults = function(h, i, k, j) {
        var g = new b.Ms.AssignmentGet();
        g.set("AssignmentId", h);
        g.fetch({
            error: function() {
                p3.displayError("Error loading assignment")
            },
            success: function(m, n) {
                var l = new a.Ms.AssessmentStudentReview({
                    AssessmentId: g.get("AssessmentId"),
                    AssignmentId: h
                });
                l.fetch({
                    data: {
                        assessmentId: g.get("AssessmentId"),
                        assignmentIndexId: i
                    },
                    error: function() {
                        p3.displayError("Error loading assessment")
                    },
                    success: function() {
                        var o = new a.Ms.AssessmentFacultyResult();
                        o.fetch({
                            data: {
                                assessmentId: g.get("AssessmentId"),
                                assignmentIndexId: i,
                                assessmentResultId: j,
                                doSort: true,
                                userId: p3.Data.Context.get("UserInfo").UserId
                            },
                            success: function() {
                                o.set({
                                    AssignmentId: h,
                                    AssignmentIndexId: i
                                });
                                if (o.get("PointsEarned") < 0) {
                                    o.set("PointsEarned", 0)
                                }
                                var r = o.get("Responses"),
                                    q = 0,
                                    p;
                                if (g.get("MaxScoreInd") == 1) {
                                    q = Math.round((g.get("MaxScore") / r.length) * 100) / 100
                                }
                                for (p = 0; p < r.length; p++) {
                                    if (g.get("MaxScoreInd") == 1) {
                                        r[p].Points = q;
                                        r[p].PointsEarned = Math.round(r[p].PointsEarned * 100) / 100
                                    }
                                }
                                var s = new a.Vs.PrintResults({
                                    result: o,
                                    assessment: l,
                                    maxScore: g.get("MaxScore"),
                                    assignment: g,
                                    studentId: k
                                });
                                p3.rV(s, $("#app"), true)
                            },
                            error: function() {
                                p3.displayError("Error loading results")
                            }
                        })
                    }
                })
            }
        })
    };
    a.Us.getStartString = function(g, h) {
        var k = "",
            l = g.get("SectionLinks"),
            j;
        for (j = 0; j < l.length; j++) {
            if (l[j].AssignmentIndexId == h) {
                k = c.displayDate(l[j].AssignmentDate, "shortDate") + " at " + c.displayTime(l[j].AssignmentTime, true, "shortTime");
                break
            }
        }
        return k
    };
    a.Us.getOffsetFromReferenceDate = function(h) {
        var g = new Date(2012, 1, 1);
        return g.getTime() + (h || 0)
    };
    a.Us.getTimeDisplayForMilliseconds = function(g) {
        var i = new Date(a.Us.getOffsetFromReferenceDate(g)),
            h = "";
        if (i.getHours() > 0) {
            h += i.getHours() + ":";
            if (i.getMinutes() > 0 && i.getMinutes() < 10) {
                h += "0"
            } else {
                if (i.getMinutes() == 0) {
                    h += "00"
                }
            }
        }
        if (i.getMinutes() > 0) {
            h += i.getMinutes()
        }
        h += ":";
        if (i.getSeconds() < 10) {
            h += "0"
        }
        h += i.getSeconds();
        return h
    };
    a.Us.getPointsAssigned = function(j) {
        var h = 0,
            g;
        if (j) {
            for (g = 0; g < j.length; g++) {
                h += Number(j[g].Points)
            }
        }
        return h
    };
    p3.router().route("assessmentedit/:id/:index/:locked", "assessmentedit", function(g, h, i) {
        p3.renderMainPage(new a.Vs.EditDetail({
            assignmentId: g,
            editMode: "content",
            assignmentIndexId: h,
            locked: i == "1"
        }))
    });
    p3.router().route("assessment/:id/:index/:resume", "assessment", function(g, h, i) {
        p3.renderMainPage(new a.Vs.Take({
            assignmentId: g,
            assignmentIndexId: h,
            preview: false,
            resume: i == "true"
        }))
    });
    p3.router().route("assessmentpreview/:id/:index", "assessmentpreview", function(g, h) {
        p3.renderMainPage(new a.Vs.Take({
            assignmentId: g,
            assignmentIndexId: h,
            preview: true,
            resume: false
        }))
    });
    p3.router().route("assessmentdetail/:id/:index/:print/:studentid/:take", "assessmentdetail", function(g, h, i, j, k) {
        a.Us.showStudentReview(g, h, j, k == "1")
    });
    p3.router().route("assessmentsectiondetail/:id/:index/:print", "assessmentsectiondetail", function(g, h, i) {
        if (i == 1) {
            p3.rV(new a.Vs.SectionDetails({
                assignmentId: g,
                assignmentIndexId: h,
                print: i
            }), $("#app"), true)
        } else {
            p3.renderMainPage(new a.Vs.SectionDetails({
                assignmentId: g,
                assignmentIndexId: h,
                print: i
            }))
        }
    });
    p3.router().route("assessmentdetailprint/:assignmentid/:resultid/:index/:studentid", "assessmentdetailprint", function(g, i, h, j) {
        a.Us.printResults(g, h, j, i)
    })
}(p3.module("LMS/assessment")));
(function(b) {
    var g = p3.Us.Enum,
        l = p3.module("shared/task"),
        k = p3.module("report"),
        f = p3.module("shared/datepicker"),
        m = p3.module("shared/timepicker"),
        j = p3.module("shared/notification"),
        a = p3.module("LMS/academicclass"),
        h = p3.module("cms/shared/grouppublish"),
        i = p3.module("shared/ltitool"),
        e = p3.Us.Culture,
        c = p3.module("lms/assignmentoptions"),
        d = p3.module("LMS/Shared/AssignmentTools");
    b.Data = {};
    b.Ms.AssignmentType = Bbm.extend({
        idAttribute: "AssignmentTypeId",
        url: function() {
            return ""
        }
    });
    b.Ms.LtiInfo = Bbm.extend({
        initialize: function(n) {
            var p = this,
                o = new i.Cs.ltiProviderPicklist();
            p.currentProviderId = n.get("ProviderId") || 0;
            p.currentProviderListId = "none";
            p.currentProvider = new Bbm();
            if (p.currentProviderId) {
                p.currentPlacement = n;
                p.hasSavedPlacement = true
            } else {
                p.currentPlacement = new i.Ms.Tool({
                    ContextLabelId: 5,
                    ContextValue: 999,
                    Gradeable: true
                });
                p.hasSavedPlacement = false
            }
            p.provider1Count = 0;
            p.provider2Count = 0;
            p.providerList1 = new i.Cs.ltiProviderPicklist();
            p.providerList2 = new i.Cs.ltiProviderPicklist();
            if (i.Us.IsLtiInstalled()) {
                o.fetch({
                    async: false,
                    data: {
                        scope: g.LtiProviderScope.ASSIGNMENT
                    },
                    success: function() {
                        o.each(function(q) {
                            if (q.get("GalleryId") === 2) {
                                p.providerList2.push(q)
                            } else {
                                p.providerList1.push(q)
                            }
                        });
                        p.provider1Count = p.providerList1.ltiProvidersAvailableCount(p.currentProviderId);
                        p.provider2Count = p.providerList2.ltiProvidersAvailableCount(p.currentProviderId);
                        p.locateProvider(p.currentProviderId)
                    },
                    error: function() {
                        p3.displayError("Error loading the provider list")
                    }
                })
            }
        },
        locateProvider: function(p) {
            var o = this,
                n, q = false;
            if (p) {
                n = o.providerList1.locateProvider(p);
                if (n.get("ProviderId") === p) {
                    o.currentProvider = n;
                    o.currentProviderListId = "lti";
                    q = true
                } else {
                    n = o.providerList2.locateProvider(p);
                    if (n.get("ProviderId") === p) {
                        o.currentProvider = n;
                        o.currentProviderListId = "submission";
                        q = true
                    }
                }
            }
            return q
        },
        getLtiSaved: function() {
            var n = this;
            return (n.currentProviderListId === "lti" && n.hasSavedPlacement)
        },
        getLtiCount: function() {
            var n = this;
            return (n.currentProviderListId !== "submission" ? n.provider1Count : 0)
        },
        getLtiProvider: function() {
            var n = this,
                o = {};
            if (n.currentProviderListId === "lti") {
                if (n.hasSavedPlacement) {
                    o = n.currentPlacement.toJSON()
                } else {
                    if (n.currentProvider) {
                        o = n.currentProvider.toJSON()
                    }
                }
            }
            return o
        },
        getLtiProviderList: function() {
            var n = this;
            return (n.currentProviderListId !== "submission" ? ([{
                ProviderName: "-- Select a provider --",
                ProviderId: 0,
                ActiveInd: true
            }].concat(n.providerList1.toJSON())) : {})
        },
        getLtiSubmissionSaved: function() {
            var n = this;
            return (n.currentProviderListId === "submission" && n.hasSavedPlacement)
        },
        getLtiSubmissionCount: function() {
            var n = this;
            return (n.currentProviderListId !== "lti" ? n.provider2Count : 0)
        },
        getLtiSubmissionProvider: function() {
            var n = this,
                o = {};
            if (n.currentProviderListId === "submission") {
                if (n.hasSavedPlacement) {
                    o = n.currentPlacement.toJSON()
                } else {
                    if (n.currentProvider) {
                        o = n.currentProvider.toJSON()
                    }
                }
            }
            return o
        },
        getLtiSubmissionProviderList: function() {
            var n = this;
            return (n.currentProviderListId !== "lti" ? ([{
                ProviderName: "-- Select a provider --",
                ProviderId: 0,
                ActiveInd: true
            }].concat(n.providerList2.toJSON())) : {})
        }
    });
    b.Vs.Lti = Bb.View.extend({
        template: "classassignment/addnewassignment.lti.template.html",
        events: {
            "change #ProviderId": "toggleLtiProvider",
            "change #XmlValue": "doXmlEntered"
        },
        initialize: function() {
            this.parentView = this.options.parentView
        },
        render: function(n) {
            var o = this;
            $(n).append(o.el);
            o.renderTemplate()
        },
        renderTemplate: function() {
            var o = this,
                n;
            if (o.model.currentProviderListId === "submission") {
                o.$el.hide()
            }
            n = i.Us.PresentationTargetPickList(o.model.currentProvider.get("PresentationTargetOptions"));
            p3.fT(o.template, function(p) {
                o.$el.html(p({
                    placementSaved: o.model.getLtiSaved(),
                    provider: o.model.getLtiProvider(),
                    providerList: o.model.getLtiProviderList(),
                    targets: n.toJSON()
                }));
                p3.setModalHeight(p3.Layout.Containers.Modal);
                if (o.model.currentProvider.get("ParameterInd")) {
                    o.listView = new i.Vs.EditToolGeneralList({
                        model: o.model.currentPlacement
                    });
                    p3.rV(o.listView, o.$("#param-list-area"), true)
                }
            })
        },
        toggleLtiProvider: function(o) {
            var q = this,
                n = $(o.currentTarget),
                p;
            p = parseInt(n.val(), 10);
            if (p) {
                q.model.currentProviderId = p;
                q.model.currentProvider = q.model.providerList1.locateProvider(p);
                q.model.currentProviderListId = "lti";
                if (q.model.currentProvider.get("OutcomesInd")) {
                    q.parentView.forceIncludeInGradebook()
                }
                q.model.currentPlacement.changeProvider(q.model.currentProvider)
            } else {
                q.model.currentProviderId = 0;
                q.model.currentProvider = q.model.providerList1.locateProvider(p);
                q.model.currentProviderListId = "none"
            }
            q.renderTemplate();
            q.parentView.adjustLtiUI()
        },
        doXmlEntered: function(n) {
            var o = this,
                p = $(n.currentTarget).val();
            if (p.length > 0) {
                if (o.model.currentPlacement.processXml(p, o.model.providerList1) === true) {
                    o.renderTemplate()
                }
            }
        },
        doValidate: function(o) {
            var q = this,
                n, p;
            if (q.model.currentProviderId) {
                if (q.model.currentProvider.placementsHaveEditableLaunchUrl()) {
                    n = q.$("#LaunchUrl");
                    p = n.val();
                    if (p.trim().length === 0) {
                        n.closest(".control-group").addClass("error");
                        if (o.indexOf(p3.Us.InfoMessageLibrary.P3.RequiredInfoNotEntered) === -1) {
                            o.push(p3.Us.InfoMessageLibrary.P3.RequiredInfoNotEntered)
                        }
                    } else {
                        q.model.currentPlacement.set("LaunchUrl", p.trim());
                        n.closest(".control-group").removeClass("error")
                    }
                }
                if (q.model.currentProvider.placementsHaveEditableConsumerKey()) {
                    n = q.$("#ConsumerKey");
                    p = n.val();
                    if (p.trim().length === 0) {
                        n.closest(".control-group").addClass("error");
                        if (o.indexOf(p3.Us.InfoMessageLibrary.P3.RequiredInfoNotEntered) === -1) {
                            o.push(p3.Us.InfoMessageLibrary.P3.RequiredInfoNotEntered)
                        }
                    } else {
                        q.model.currentPlacement.set("ConsumerKey", p.trim());
                        n.closest(".control-group").removeClass("error")
                    }
                }
                if (q.model.currentProvider.placementsHaveEditableSharedSecret()) {
                    n = q.$("#SharedSecret");
                    p = n.val();
                    if (p.trim().length === 0) {
                        q.model.currentPlacement.set("SharedSecret", null)
                    } else {
                        q.model.currentPlacement.set("SharedSecret", p.trim())
                    }
                }
                if (q.model.currentProvider.placementsHaveEditableParameters()) {
                    if (!(i.Us.ValidateParameterList(q.listView, q.model.currentPlacement, "Parameters", true))) {
                        if (o.indexOf(p3.Us.InfoMessageLibrary.P3.RequiredInfoNotEntered) === -1) {
                            o.push(p3.Us.InfoMessageLibrary.P3.RequiredInfoNotEntered)
                        }
                    }
                }
            }
        },
        buildLtiPlacementJson: function() {
            var o = this,
                n = {};
            n.ProviderId = o.model.currentProvider.get("ProviderId") || 0;
            n.ToolId = o.model.currentPlacement.get("ToolId") || 0;
            if (n.ProviderId > 0) {
                if (o.model.currentProvider.placementsHaveEditableLaunchUrl()) {
                    n.LaunchUrl = o.model.currentPlacement.get("LaunchUrl")
                }
                if (o.model.currentProvider.placementsHaveEditableConsumerKey()) {
                    n.ConsumerKey = o.model.currentPlacement.get("ConsumerKey")
                }
                if (o.model.currentProvider.placementsHaveEditableSharedSecret()) {
                    n.SharedSecret = o.model.currentPlacement.get("SharedSecret")
                }
                if (o.model.currentProvider.placementsHaveEditableParameters()) {
                    n.Parameters = o.model.currentPlacement.get("Parameters")
                }
            }
            return n
        }
    });
    b.Ms.Assignment = Bbm.extend({
        idAttribute: "AssignmentId",
        url: function() {
            var n = this.get("AssignmentId");
            if (n === undefined || n === 0) {
                return aP + "assignment2/?format=json"
            }
            if (this.hasOwnProperty("useSecureGet") && this.useSecureGet) {
                return aP + "assignment2/SecureGet/" + this.get("AssignmentId") + "/?format=json"
            }
            return aP + "assignment2/" + this.get("AssignmentId") + "/?format=json"
        },
        currentPlacement: function() {
            var n, o;
            n = this.get("Lti");
            if (n && n.length > 0) {
                o = new i.Ms.Tool(n[0])
            } else {
                o = new i.Ms.Tool()
            }
            return o
        }
    });
    b.Ms.AssignmentGet = Bbm.extend({
        idAttribute: "AssignmentId",
        url: function() {
            return aP + "assignment2/getAssignment/" + this.get("AssignmentId") + "/?format=json"
        }
    });
    b.Ms.SectionForTeacher = Bbm.extend({
        idAttribute: "SectionId",
        url: function() {
            return ""
        }
    });
    b.Cs.SectionsForTeacher = Bbc.extend({
        model: b.Ms.SectionForTeacher,
        initialize: function(n, o) {
            o = o || {};
            this.sectionId = o.sectionId || 0;
            this.filterInd = o.filterInd || 0
        },
        url: function() {
            return aP + "datadirect/SectionsForTeacher/?format=json&associationId=1&sectionId=" + this.sectionId + "&filterInd=" + this.filterInd
        }
    });
    b.Ms.SectionForAssignment = Bbm.extend({
        idAttribute: "AssignmentIndexId",
        url: function() {
            return ""
        }
    });
    b.Cs.SectionForAssignments = Bbc.extend({
        model: b.Ms.SectionForAssignment,
        initialize: function(n, o) {
            this.assignmentId = o.assignmentId || 0
        },
        url: function() {
            return aP + "assignment/SectionLinksGet/?format=json&id=" + this.assignmentId
        }
    });
    b.Cs.AssignmentTypes = Bbc.extend({
        url: function() {
            return aP + "DataDirect/AssignmentTypeBySection/"
        }
    });
    b.Cs.AssignmentTypesAll = Bbc.extend({
        url: function() {
            return aP + "DataDirect/AssignmentTypes/"
        }
    });
    b.Cs.Assignments = Bbc.extend({
        model: b.Ms.Assignment,
        initialize: function(n, o) {
            this.dateSort = o.dateSort || null;
            this.assignTypes = o.assignTypes || null;
            this.startDate = o.startDate || null;
            this.endDate = o.endDate || null;
            this.searchTerm = o.searchTerm || null;
            this.sectionId = o.sectionId || 0;
            this.studentId = o.studentId || null;
            this.statuses = o.statuses || null
        },
        setSectionId: function(n) {
            this.sectionId = n
        },
        setDateSortFilter: function(n) {
            this.dateSort = n
        },
        setAssignTypeFilter: function(n) {
            this.assignTypes = n
        },
        setStatusFilter: function(n) {
            this.statuses = n
        },
        setStartDateFilter: function(n) {
            this.startDate = n
        },
        setEndDateFilter: function(n) {
            this.endDate = n
        },
        setSearchTerm: function(n) {
            this.searchTerm = n
        },
        url: function() {
            var o = p3.Data.Context.getSelectedPersona().Id,
                n = "?format=json",
                q = this.sectionId || 0,
                p;
            if (this.dateSort !== null) {
                n += "&dateSort=" + this.dateSort
            }
            if (this.assignTypes !== null) {
                n += "&assignmentTypes=" + this.assignTypes
            }
            if (this.statuses !== null) {
                n += "&statusFilters=" + this.statuses
            }
            if (this.startDate !== null) {
                n += "&startDate=" + this.startDate
            }
            if (this.endDate !== null) {
                n += "&endDate=" + this.endDate
            }
            if (this.searchTerm !== null) {
                n += "&searchTerm=" + this.searchTerm
            }
            if (o == 1) {
                if (this.studentId) {
                    n += "&studentId=" + this.studentId
                }
                p = aP + "assignment/forchildsection/" + q + "/" + n
            } else {
                n += "&personaId=" + o;
                p = aP + "assignment/forsection/" + q + "/" + n
            }
            return p
        },
        filters: undefined,
        comparator: function(n) {
            return n.get("short_description")
        },
        changeSort: function(n) {
            if (this.filters !== undefined) {
                this.comparator = this.filters[n]
            }
        }
    });
    b.Ms.Type = Bbm.extend({
        idAttribute: "Id",
        url: function() {
            return ""
        }
    });
    b.Ms.UserFolder = Bbm.extend({
        url: function() {
            return aP + "datadirect/GetUserFolder/?format=json"
        }
    });
    b.Cs.Types = Bbc.extend({
        model: b.Ms.Type,
        initialize: function(n, o) {
            this.sectionId = o.sectionId || 0
        },
        setSection: function(n) {
            this.sectionId = n
        },
        url: function() {
            var n = aP + "assignment/TypesForSection/?format=json";
            if (this.sectionId !== null) {
                n += "&sectionId=" + this.sectionId
            }
            return n
        }
    });
    b.Enum = {
        viewByFilters: {
            ASSIGNED: 0,
            DUE: 1,
            ACTIVE: 2
        }
    };
    b.Ms.AssignmentDelete = Bbm.extend({
        idAttribute: "Id",
        url: function() {
            if (this.get("sections") === null) {
                return aP + "assignment/delete/" + this.get("Id") + "/?format=json"
            }
            return aP + "assignment/delete/" + this.get("Id") + "/?format=json&sections=" + this.get("sections")
        }
    });
    b.Ms.Attachment = Bbm.extend({});
    b.Cs.Attachments = Bbc.extend({
        model: b.Ms.Attachment,
        url: function() {
            return aP + "datadirect/AssignmentAttachments/?format=json"
        }
    });
    b.Ms.DropBoxItem = Bbm.extend({});
    b.Ms.DropBoxEntry = Bbm.extend({});
    b.Cs.DropBoxEntries = Bbc.extend({
        model: b.Ms.DropBoxEntry,
        url: function() {
            return aP + "datadirect/managedropbox/?format=json"
        }
    });
    b.Ms.PublishAssignment = Bbm.extend({
        url: function() {
            return aP + "assignment2/publishstatus/?format=json"
        }
    });
    b.Ms.DownloadNameDuplicate = Bbm.extend({
        url: function() {
            return aP + "datadirect/validatefilename/?format=json&filename=" + this.get("filename")
        }
    });
    b.Ms.FileTypes = Bbm.extend({
        idAttribute: "Extension",
        url: function() {
            return ""
        }
    });
    b.Cs.FileTypes = Bbc.extend({
        model: b.Ms.FileTypes,
        url: function() {
            return aP + "datadirect/GetValidFileTypes/?format=json"
        },
        parse: function(n) {
            var o = [];
            _.each(n, function(p) {
                o.push({
                    Extension: p.Extension.toLowerCase(),
                    fileType: p.fileType,
                    fileTypeId: p.fileTypeId
                })
            });
            return o
        }
    });
    b.Ms.ExistingAssignment = Bbm.extend({
        url: "assignment2/AddExistingAssignment/"
    });
    b.Cs.MarkingPeriods = Bbc.extend({
        url: function() {
            return aP + "datadirect/AssignmentMarkingPeriods/?format=json"
        }
    });
    b.Cs.ExistingSchoolYears = Bbc.extend({
        url: "datadirect/SchoolYearsGet/"
    });
    b.Cs.ExistingTeachers = Bbc.extend({
        url: "datadirect/AssignmentTeachersGet/"
    });
    b.Cs.ExistingSections = Bbc.extend({
        url: "datadirect/AssignmentSectionsForTeacher/"
    });
    b.Cs.ExistingMarkingPeriods = Bbc.extend({
        url: "datadirect/MarkingPeriodsForSection/"
    });
    b.Cs.ExistingAssignments = Bbc.extend({
        url: "datadirect/ExistingAssignmentsGet/",
        filters: undefined,
        comparator: function(n) {
            return n.get("short_description")
        },
        changeSort: function(n) {
            if (this.filters !== undefined) {
                this.comparator = this.filters[n]
            }
        }
    });
    b.Ms.AssignmentStatusUpdate = Bbm.extend({
        url: function() {
            return aP + "assignment2/assignmentstatusupdate/?format=json&assignmentIndexId=" + this.get("assignmentIndexId") + "&assignmentStatus=" + this.get("assignmentStatus")
        }
    });
    b.Cs.ImportAssignments = Bbc.extend({
        url: "datadirect/ImportAssignmentsGet/",
        filters: undefined,
        comparator: function(n) {
            return n.get("short_description")
        },
        changeSort: function(n) {
            if (this.filters !== undefined) {
                this.comparator = this.filters[n]
            }
        }
    });
    b.Vs.AddAssignmentView = Bb.View.extend({
        template: "classassignment/addassignment.template.html",
        linkTemplate: "classassignment/assignmentLinkItem.template.html",
        downloadTemplate: "classassignment/assignmentDownloadItem.template.html",
        existingTemplate: "classassignment/addexistingassignment.template.html",
        ItemTemplate: "classassignment/addexistingtableitem.template.html",
        newTemplate: "classassignment/addnewassignment.template.html",
        initialize: function(n) {
            if (n !== undefined) {
                this.assignment = n.assignment || undefined;
                this.title = n.title || "Add Assignment";
                this.AddMode = n.AddMode !== undefined ? n.AddMode : true;
                this.AddExisting = n.AddExisting || false;
                this.defaultDate = n.defaultDate || e.localDateTime()
            } else {
                this.assignment = undefined;
                this.title = "Add Assignment";
                this.AddMode = true;
                this.AddExisting = false;
                this.defaultDate = e.localDateTime()
            }
            this.activeYear = "";
            this.activeTeacher = 0;
            this.activeSection = 0;
            this.activeOffering = 0;
            this.activeSections = [];
            this.CurrentSort = "short_description";
            this.ActiveAssignmentSections = b.Data.TeacherSections === undefined ? [] : b.Data.TeacherSections.toJSON();
            this.resetAssignmentFields(false);
            this.contentId = 58;
            b.Data.FileTypes = new b.Cs.FileTypes({}, {});
            b.Data.FileTypes.fetch();
            if (this.SectionsForTeacher === undefined) {
                this.SectionsForTeacher = new b.Cs.ExistingSections()
            }
            this.markingPeriods = new b.Cs.MarkingPeriods();
            p3.fT(this.linkTemplate, function(o) {
                return false
            });
            p3.fT(this.downloadTemplate, function(o) {
                return false
            });
            p3.Layout.Containers.Modal.on("postRender", this.initEditors);
            if (p3.Data.fileTypes === undefined) {
                p3.Data.fileTypes = new b.Cs.FileTypes({}, {});
                p3.Data.fileTypes.fetch({
                    error: function() {
                        p3.displayError("Error loading filetypes")
                    }
                })
            }
        },
        dispose: function() {
            p3.Layout.Containers.Modal.off("postRender");
            if (this.emptysections) {
                b.Data.TeacherSections = undefined
            }
            var n = tinyMCE.get("add-assignment-title-field");
            if (n) {
                n.remove();
                n = null
            }
            n = tinyMCE.get("add-assignment-description-field");
            if (n) {
                n.remove();
                n = null
            }
        },
        initEditors: function() {
            p3.showHtmlEditor("add-assignment-title-field", p3.Us.Enum.HtmlEditorCategories.FULL, false, function() {
                var n = tinyMCE.get("add-assignment-title-field");
                if (n !== undefined) {
                    n.onKeyUp.add(function(q, p) {
                        var o = q.getContent().length;
                        if (o > 255) {
                            $("#titleCountField").addClass("badge-error")
                        } else {
                            $("#titleCountField").removeClass("badge-error")
                        }
                        $("#titleCountField").html(o)
                    });
                    n.onSetContent.add(function(q, p) {
                        var o = q.getContent().length;
                        if (o > 255) {
                            $("#titleCountField").addClass("badge-error")
                        } else {
                            $("#titleCountField").removeClass("badge-error")
                        }
                        $("#titleCountField").html(o)
                    });
                    n.onChange.add(function(q, p) {
                        var o = q.getContent().length;
                        if (o > 255) {
                            $("#titleCountField").addClass("badge-error")
                        } else {
                            $("#titleCountField").removeClass("badge-error")
                        }
                        $("#titleCountField").html(o)
                    })
                } else {
                    p3.log("error TinyMCE not loaded yet.")
                }
            }, p3.Us.Enum.HtmlEditorEncoding.NUMERIC);
            p3.showHtmlEditor("add-assignment-description-field", p3.Us.Enum.HtmlEditorCategories.FULL, false, undefined, p3.Us.Enum.HtmlEditorEncoding.NUMERIC)
        },
        events: {
            "click #show-more-groups": "showGroupDialog",
            "click .add-assignment-save-option": "doAssignmentSave",
            "click .add-assignment-save-add-another": "doAssignmentSave",
            "click .add-assignment-delete-option": "doAssignmentDelete",
            "click a.toggle-content": "showToggleContent",
            "click #publish-options-apply-selected-button": "doApplyToSelected",
            "click .add-assignment-section-selector": "showMoreButtonVisability",
            "click .assignment-drop-box-enable": "doDropBoxActivate",
            "click .link-delete-button": "deleteLinkItem",
            "click .download-delete-button": "deleteDownloadItem",
            "click #add-existing-assignment-link": "switchAddMode",
            "click .existing-table-sort": "updateFilter",
            "click #add-existing-search-button": "doSearch",
            "click input[name=submit-options]:radio": "submitTypeChange",
            "click #add-assignment-gradebook-include": "toggleGradeBook",
            "click .select-all-check": "doSelectionToggle",
            "change .input-file": "handleDownloads",
            "change .assignment-download-file-field": "handleDownloads",
            "change #existing-school-year-dd": "doYearSelect",
            "change #existing-teacher-dd": "doTeacherSelect",
            "change #existing-section-dd": "doSectionSelect",
            "blur .assignment-link-field": "handleLinks",
            "blur .assignment-download-field": "handleDownloads",
            "keydown #add-assignment-gradebook-abbr": "doCharacterCountLimit",
            "keydown #existing-search-field": "doSearchEnter",
            "change #add-assignment-type-selector": "assignmentTypeDefaultMaxPoint",
            "change .default-value-change": "highlightApplyToSelected",
            "change #add-assignment-lti-selector": "toggleSubmissionLtiProvider",
            "blur .default-time-value-blur": "highlightApplyToSelected",
            'shown a[data-toggle="tab"]': "haltPropagation"
        },
        adjustLtiUI: function() {
            var p = this,
                n, o;
            if (!(p.Lti.hasSavedPlacement)) {
                n = p.$("#ProviderId");
                o = p.$("#add-assignment-lti-selector");
                if (p.Lti.currentProviderListId === "lti" && p.Lti.currentProvider.get("ProviderId") > 0) {
                    o.prop("selectedIndex", 0);
                    o.prop("disabled", true);
                    p.$(".assignment-sub-lti-area").hide()
                } else {
                    if (p.Lti.currentProviderListId === "submission") {
                        n.prop("selectedIndex", 0);
                        n.prop("disabled", true);
                        p.$(".assignment-lti-area").hide();
                        if (!(p.Lti.currentProviderList)) {
                            o.prop("disabled", false)
                        }
                    } else {
                        n.prop("selectedIndex", 0);
                        n.prop("disabled", false);
                        o.prop("selectedIndex", 0);
                        o.prop("disabled", true);
                        p.$(".assignment-sub-lti-area").show();
                        p.$(".assignment-lti-area").show()
                    }
                }
            }
        },
        toggleSubmissionLtiProvider: function(o) {
            var p = this,
                n = $(o.currentTarget);
            p.Lti.currentProviderId = parseInt(n.val(), 10);
            p.Lti.currentProvider = p.Lti.providerList2.locateProvider(p.Lti.currentProviderId);
            p.Lti.currentProviderListId = "submission";
            if (p.Lti.currentProvider.get("OutcomesInd")) {
                p.forceIncludeInGradebook()
            }
            p.Lti.currentPlacement.changeProvider(p.Lti.currentProvider)
        },
        forceIncludeInGradebook: function() {
            var n = this;
            if (!(n.$("#add-assignment-gradebook-include").is(":checked"))) {
                n.$("#add-assignment-gradebook-include").trigger("click")
            }
        },
        render: function(n) {
            var p = this,
                o;
            p.Lti = new b.Ms.LtiInfo((p.assignment ? p.assignment.currentPlacement() : new i.Ms.Tool()));
            if (p.Lti.provider1Count > 0) {
                p.ltiView = new b.Vs.Lti({
                    model: p.Lti,
                    parentView: p
                })
            }
            p3.fT(p.template, function(r) {
                if (b.Data.TeacherSections === undefined || b.Data.TeacherSections.length == 0) {
                    b.Data.TeacherSections = new b.Cs.SectionsForTeacher();
                    p.emptysections = true;
                    p.SectionsForTeacher.fetch({
                        async: false,
                        data: {
                            schoolYear: p3.Data.SchoolContext.get("CurrentSchoolYear").SchoolYearLabel,
                            facultyUserId: p3.Data.Context.get("UserInfo").UserId
                        },
                        success: function(s, t) {
                            var u = p.assignment !== undefined ? _.pluck(p.assignment.get("SectionLinks"), "SectionId") : [];
                            s.each(function(w) {
                                if (w.get("isCurrent") === 1) {
                                    var y = w.get("SectionId"),
                                        v = w.get("Name"),
                                        x = new Bbm();
                                    x.set({
                                        IsSelected: u.indexOf(y) === -1 ? false : true,
                                        IsCurrent: true,
                                        LeadSectionId: y,
                                        GroupName: v,
                                        SectionId: y
                                    });
                                    b.Data.TeacherSections.add(x, {
                                        silent: true
                                    })
                                }
                            });
                            p.ActiveAssignmentSections = b.Data.TeacherSections === undefined ? [] : b.Data.TeacherSections.toJSON()
                        }
                    })
                }
                var q = p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.ASSIGNMENTDROPBOX);
                p.$el.html(r({
                    AddMode: p.AddMode,
                    WindowTitle: p.title,
                    edit: p.options ? p.options.edit || false : false,
                    gradebookInd: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADEBOOK),
                    dropboxInd: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.ASSIGNMENTDROPBOX),
                    assignmentTypes: [{
                        Type: "-- Select An Assignment Type --",
                        AssignmentTypeId: 0
                    }].concat(b.Data.Types.toJSON()),
                    sections: b.Data.TeacherSections.toJSON()
                }));
                $(n).append(p.el);
                p3.fT(p.newTemplate, function(x) {
                    var w = p.getSectionListForAssignment(),
                        t = (p.assignment) ? p.assignment.get("AssignmentTypeId") : null,
                        u;
                    $("#site-modal .modal-body").html(x({
                        AddMode: p.AddMode,
                        WindowTitle: p.title,
                        edit: p.options ? p.options.edit || false : false,
                        gradebookInd: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADEBOOK),
                        dropboxInd: q,
                        assignmentTypes: [{
                            Type: "-- Select An Assignment Type --",
                            AssignmentTypeId: 0
                        }].concat(b.Data.Types.toJSON()),
                        sections: w.toJSON(),
                        notifEnabled: p.notifEnabled,
                        notifTooltip: p.notifTooltip,
                        gradebookDefault: p3.Data.Context.get("UserInfo").GradebookDefaultInd,
                        existingAssignmentTypeId: t,
                        subPlacementSaved: p.Lti.getLtiSubmissionSaved(),
                        subLtiCount: p.Lti.getLtiSubmissionCount(),
                        subLtiProvider: p.Lti.getLtiSubmissionProvider(),
                        subLtiProviderList: p.Lti.getLtiSubmissionProviderList(),
                        canSubmitInd: q
                    }));
                    if (p.ltiView) {
                        p3.rV(p.ltiView, p.$(".assignment-lti-area"), true)
                    }
                    $(".abbr-tooltip").tooltip({
                        title: "10 character maximum"
                    });
                    $("#dropbox-enabled-fields").hide();
                    if (p.assignment !== undefined && p.assignment != null && p.assignment.get("AssignmentId") > 0) {
                        p.loadAssignment(p.assignment.toJSON())
                    } else {
                        var y = p.defaultDate;
                        $("#assignment-default-assigned-date").val(e.getDateString(y));
                        w = $("#add-assignment-sections-listing tr");
                        for (u = 0; u < w.length; u++) {
                            $($(w[u]).children("td")[1]).children("input:first").val(e.getDateString(y))
                        }
                    }
                    b.Us.LoadDateTimePickers(p.ActiveAssignmentSections);
                    p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.jQueryUI, function() {
                        p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.FileUpload, p.initializeFileUpload)
                    });
                    $(".send-notif-label").tooltip();
                    if (p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADEBOOK)) {
                        var v = p.getSectionListForAssignment().pluck("LeadSectionId");
                        w = "";
                        for (u = 0; u < v.length; u++) {
                            if (w.length > 0) {
                                w += ","
                            }
                            w += v[u].toString()
                        }
                        c.Us.getAssignmentOptionDefaults();
                        if (p3.Data.LMS.DefaultTime) {
                            o = e.getTimeString(e.getDate(e.getDateString() + " " + p3.Data.LMS.DefaultTime))
                        } else {
                            o = e.buildTimeString(0, 0, 0)
                        }
                        $("#add-assignment-sections-listing").find(".time-picker-field").attr("placeholder", o);
                        $("#assignment-default-assigned-time").attr("placeholder", o);
                        p.markingPeriods.fetch({
                            data: {
                                sectionList: w
                            },
                            success: function(C, K) {
                                var L = $(".grade-book-tooltip-location"),
                                    H, M, I, J, D, z, E, A, B, F, G;
                                for (H = 0; H < L.length; H++) {
                                    M = $(L[H]).data("sectionId");
                                    if (M && M > 0) {
                                        I = b.Us.GetMarkingPeriods(C, M);
                                        if (I.length === 0) {
                                            $(L[H]).hide()
                                        } else {
                                            J = "<strong>Marking Periods:</strong><br>Due date must fall within a marking period for this assignment to be included in Grade Book.<br>";
                                            for (D = 0; D < I.length; D++) {
                                                z = I[D].get("begin_date");
                                                E = I[D].get("end_date");
                                                if (typeof z === "string" && typeof E === "string") {
                                                    A = e.getDateString(e.getDate(z));
                                                    B = e.getTimeString(e.getTime(z));
                                                    F = e.getDateString(e.getDate(E));
                                                    G = e.getTimeString(e.getTime(E));
                                                    J += I[D].get("marking_period_description") + "<br><div>Begin: " + A + " " + B + "<br>End: " + F + " " + G + "<br></div>"
                                                }
                                            }
                                            $(L[H]).show().tooltip({
                                                title: J
                                            })
                                        }
                                    }
                                }
                            },
                            error: function(z, A) {
                                p3.displayError("Failed to retreive the Marking Periods")
                            }
                        })
                    }
                    if (p.emptysections && p.AddMode) {
                        $(".add-assignment-section-selector").prop("checked", false)
                    }
                    if ($(".add-assignment-section-selector:checked").length === 0) {
                        $(".select-all-check").prop("checked", false)
                    }
                    var s = jQuery.Event("postRender");
                    window.setTimeout(function() {
                        if ($("#rdoOnCampusSubmit").is(":checked")) {
                            $("#add-assignment-dropbox-num-files").prop("disabled", false);
                            $("#add-assignment-dropbox-late-time").prop("disabled", false)
                        } else {
                            $("#add-assignment-dropbox-num-files").prop("disabled", true);
                            $("#add-assignment-dropbox-late-time").prop("disabled", true)
                        }
                        if ($("#add-assignment-gradebook-include").is(":checked")) {
                            $("#add-assignment-gradebook-include-cum-grade").prop("disabled", false);
                            $("#add-assignment-gradebook-extra-credit").prop("disabled", false);
                            $("#add-assignment-gradebook-include-cum-grade").prop("disabled", false);
                            $("#add-assignment-gradebook-publish").prop("disabled", false);
                            $("#add-assignment-gradebook-abbr").prop("disabled", false);
                            $("#add-assignment-gradebook-max-points").prop("disabled", false);
                            $("#add-assignment-gradebook-factor").prop("disabled", false)
                        } else {
                            $("#add-assignment-gradebook-include-cum-grade").prop("disabled", true);
                            $("#add-assignment-gradebook-extra-credit").prop("disabled", true);
                            $("#add-assignment-gradebook-include-cum-grade").prop("disabled", true);
                            $("#add-assignment-gradebook-publish").prop("disabled", true);
                            $("#add-assignment-gradebook-abbr").prop("disabled", true);
                            $("#add-assignment-gradebook-max-points").prop("disabled", true);
                            $("#add-assignment-gradebook-factor").prop("disabled", true)
                        }
                        p3.Layout.Containers.Modal.trigger(s)
                    }, 400)
                });
                $("#publish-options-warning-message").hide()
            })
        },
        getSectionListForAssignment: function() {
            var s = this,
                r = new b.Cs.SectionsForTeacher({}, {
                    sectionId: 0
                }),
                q, o, n, p;
            r.remove(r.at(0));
            b.Data.TeacherSections.each(function(t) {
                r.add(t.clone())
            });
            if (!s.AddMode) {
                n = r.pluck("SectionId");
                q = s.assignment.get("SectionLinks");
                for (o = 0; o < q.length; o++) {
                    if (n.indexOf(q[o].SectionId) == -1) {
                        p = new b.Ms.SectionForTeacher({
                            SectionId: q[o].SectionId,
                            GroupName: q[o].Section.Name,
                            IsSelected: 1,
                            LeadSectionId: q[o].SectionId
                        });
                        r.add(p)
                    }
                }
            }
            return r
        },
        haltPropagation: function(n) {
            n.stopPropagation()
        },
        resetAssignmentFields: function(v) {
            var r, w, x, s, n, p, o, q, u, t;
            if ($("#add-assignment-title-field").length) {
                r = tinyMCE.get("add-assignment-title-field");
                r.setContent("");
                r.save();
                r.focus()
            }
            if ($("#add-assignment-description-field").length) {
                r = tinyMCE.get("add-assignment-description-field");
                r.setContent("");
                $("#add-assignment-description-field").html("")
            }
            if ($("#add-assignment-type-selector").length) {
                $("#add-assignment-type-selector").val(0)
            }
            if ($("#add-assignment-gradebook-abbr").length) {
                $("#add-assignment-gradebook-abbr").val("")
            }
            if ($("#add-assignment-gradebook-max-points").length) {
                $("#add-assignment-gradebook-max-points").val("")
            }
            if ($("#add-assignment-gradebook-factor").length) {
                $("#add-assignment-gradebook-factor").val(1)
            }
            if ($("#add-assignment-gradebook-include").length) {
                $("#add-assignment-gradebook-include").prop("checked", p3.Data.Context.get("UserInfo").GradebookDefaultInd);
                this.toggleGradeBook()
            }
            if ($("#add-assignment-gradebook-include-cum-grade").length) {
                $("#add-assignment-gradebook-include-cum-grade").prop("checked", p3.Data.Context.get("UserInfo").GradebookDefaultInd)
            }
            if ($("#add-assignment-gradebook-extra-credit").length) {
                $("#add-assignment-gradebook-extra-credit").prop("checked", false)
            }
            if ($("#add-assignment-gradebook-publish").length) {
                $("#add-assignment-gradebook-publish").prop("checked", p3.Data.Context.get("UserInfo").GradebookDefaultInd)
            }
            $("#rdoNoSubmit").prop("checked", true);
            this.toggleDropBox(false);
            $("#add-assignment-lti-selector").val(0);
            if ($("#add-assignment-dropbox-num-files").length) {
                $("#add-assignment-dropbox-num-files").val(1)
            }
            if ($("#add-assignment-dropbox-late-time").length) {
                $("#add-assignment-dropbox-late-time").val("")
            }
            x = this.defaultDate;
            if ($("#assignment-default-assigned-date").length) {
                $("#assignment-default-assigned-date").val(e.getDateString(x))
            }
            if ($("#assignment-default-assigned-time").length) {
                $("#assignment-default-assigned-time").val("")
            }
            if ($("#assignment-default-due-date").length) {
                $("#assignment-default-due-date").val("")
            }
            if ($("#assignment-default-publish-option").length) {
                $("#assignment-default-publish-option").val(1)
            }
            if ($("#assignment-default-notification-send").length) {
                $("#assignment-default-notification-send").prop("checked", false)
            }
            w = $("#add-assignment-sections-listing tr");
            for (s = 0; s < w.length; s++) {
                n = $(w[s]);
                p = $(n.children("td")[0]).find(".add-assignment-section-selector");
                o = n.children("td")[1];
                q = n.children("td")[2];
                u = n.children("td")[3];
                t = $(n.children("td")[4]).find("input");
                if (p) {
                    if ($(p).data("defaultSection")) {
                        $(p).prop("checked", true)
                    } else {
                        $(p).prop("checked", false)
                    }
                }
                if (o) {
                    $(o).children("input:first").val(e.getDateString(x));
                    $(o).children("input:last").val("")
                }
                if (q) {
                    $(q).children("input:first").val("")
                }
                if (u) {
                    $(u).children("select").val(1)
                }
                if (t) {
                    $(t).prop("checked", false)
                }
            }
            $("input.add-assignment-section-selector:checked").closest("tr").show();
            $(".add-assignment-section-selector:input:checkbox[checked!='checked']").closest("tr").remove();
            $(".select-all-check").prop("checked", true);
            if (this.emptysections) {
                $("input.add-assignment-section-selector").prop("checked", false);
                $("input.select-all-check").prop("checked", false)
            }
            if (this.$("#add-assignment-links-tab").children().length > 0) {
                this.$("#add-assignment-links-tab").children().remove();
                this.addLinkControl()
            }
            if (this.$("#add-assignment-downloads-tab").children().length > 0) {
                this.$("#add-assignment-downloads-tab").children().remove();
                this.addDownloadControl()
            }
            if ($("#add-assignment-title-field").length) {
                tinyMCE.get("add-assignment-title-field").focus()
            }
            if (v) {
                this.resetLti()
            }
        },
        resetLti: function() {
            var o = this,
                n = new i.Cs.ltiProviderPicklist();
            o.Lti.currentProviderId = 0;
            o.Lti.currentProviderListId = "none";
            o.Lti.currentProvider = new Bbm();
            o.Lti.currentPlacement = new i.Ms.Tool({
                ContextLabelId: 5,
                ContextValue: 999,
                Gradeable: true
            });
            o.Lti.hasSavedPlacement = false;
            o.Lti.provider1Count = 0;
            o.Lti.provider2Count = 0;
            o.Lti.providerList1 = new i.Cs.ltiProviderPicklist();
            o.Lti.providerList2 = new i.Cs.ltiProviderPicklist();
            if (i.Us.IsLtiInstalled()) {
                n.fetch({
                    async: false,
                    data: {
                        scope: g.LtiProviderScope.ASSIGNMENT
                    },
                    success: function() {
                        n.each(function(p) {
                            if (p.get("GalleryId") === 2) {
                                o.Lti.providerList2.push(p)
                            } else {
                                o.Lti.providerList1.push(p)
                            }
                        });
                        o.Lti.provider1Count = o.Lti.providerList1.ltiProvidersAvailableCount(o.Lti.currentProviderId);
                        o.Lti.provider2Count = o.Lti.providerList2.ltiProvidersAvailableCount(o.Lti.currentProviderId);
                        o.Lti.locateProvider(o.Lti.currentProviderId);
                        o.adjustLtiUI();
                        if (o.ltiView) {
                            o.ltiView.renderTemplate()
                        }
                    },
                    error: function() {
                        p3.displayError("Error loading the provider list")
                    }
                })
            }
        },
        loadAssignment: function(p) {
            var C = this,
                B, w, A, q, z, o, s, y, r, x, n, t, v, u;
            $("#add-assignment-title-field").text(p.ShortDescription);
            $("#titleCountField").html(p.ShortDescription.length);
            $("#add-assignment-description-field").text(p.LongDescription);
            $("#add-assignment-type-selector").val(p.AssignmentTypeId);
            $("#add-assignment-gradebook-abbr").val(p.AbbrDescription);
            $("#add-assignment-gradebook-max-points").val(p.MaxPoints);
            $("#add-assignment-gradebook-factor").val(p.Factor);
            if (p.IncGradeBook) {
                $("#add-assignment-gradebook-include").prop("checked", true)
            } else {
                $("#add-assignment-gradebook-include").prop("checked", false)
            }
            if (p.IncCumGrade) {
                $("#add-assignment-gradebook-include-cum-grade").prop("checked", true)
            } else {
                $("#add-assignment-gradebook-include-cum-grade").prop("checked", false)
            }
            if (p.ExtraCredit) {
                $("#add-assignment-gradebook-extra-credit").prop("checked", true)
            } else {
                $("#add-assignment-gradebook-extra-credit").prop("checked", false)
            }
            if (p.PublishGrade) {
                $("#add-assignment-gradebook-publish").prop("checked", true)
            } else {
                $("#add-assignment-gradebook-publish").prop("checked", false)
            }
            if (p.DropboxInd) {
                $("#rdoOnCampusSubmit").prop("checked", true);
                $("#add-assignment-dropbox-num-files").val(p.DropboxNumFiles);
                $("#add-assignment-dropbox-late-time").val(p.DropboxTimeLate)
            }
            $(".add-assignment-section-selector").prop("checked", false);
            B = [];
            for (w = 0; w < p.SectionLinks.length; w++) {
                A = p.SectionLinks[w];
                q = $("#add-assignment-sections-listing tr td label input[value = " + A.SectionId + "]");
                z = q.parents("tr");
                if (q.length === 0) {
                    $("#add-assignment-sections-listing").append($("<tr>").html('<td><label class="checkbox"><input class="add-assignment-section-selector" type="checkbox" value="' + A.SectionId + '" data-default-section="true" checked="checked">' + A.Section.Name + '</label></td><td class="control-group"><input id="' + A.SectionId + '-assigned-date" type="text" class="input-mini date-picker-field dp-' + A.SectionId + '" placeholder="" value=""> <input id="' + A.SectionId + '-assigned-time" type="text" class="input-mini time-picker-field" value=""></td><td class="control-group"><input id="' + A.SectionId + '-due-date" type="text" class="input-mini date-picker-field dp-' + A.SectionId + '" placeholder="" value=""><i class="p3icon-gradebook grade-book-tooltip-location" data-section-id="' + A.SectionId + '" data-original-title=""></i></td><td><select id="' + A.SectionId + '-publish-option" class="input-small publish-options"><option value="1">Now</option><option value="2">Assigned Date</option><option value="0">No</option></select></td><td><label class="checkbox"><input type="checkbox" id="' + A.SectionId + '-notification-send" value="option1"><span class="send-notif-label" data-original-title="">Yes</span></label></td>'));
                    q = $("#add-assignment-sections-listing tr td label input[value = " + A.SectionId + "]");
                    z = q.parents("tr")
                }
                B.push({
                    LeadSectionId: A.SectionId
                });
                o = $(z).children("td")[1];
                s = $(z).children("td")[2];
                y = $(z).children("td")[3];
                $(z).show();
                $(q).prop("checked", true);
                $(o).children("input:first").val(e.displayDate(A.AssignmentDate, "shortDate"));
                $(o).children("input:last").val(e.displayTime(A.AssignmentTime, false, "shortTime"));
                $(s).children("input:first").val(e.displayDate(A.DueDate, "shortDate"));
                $(y).children("select").val(A.PublishOnAssignedInd ? 2 : A.PublishInd ? 1 : 0)
            }
            C.ActiveAssignmentSections = B || b.Data.TeacherSections.toJSON();
            $(".add-assignment-section-selector:input:checkbox[checked!='checked']").closest("tr").remove();
            if (p.LinkItems.length > 0) {
                for (w = 0; w < p.LinkItems.length; w++) {
                    x = p.LinkItems[w];
                    n = $("#add-assignment-links-tab").children(":last");
                    if ($(n).find("input:first").val() !== "" && $(n).find("input:last").val() !== "") {
                        $(n).find(".link-delete-button").show();
                        C.addLinkControl();
                        n = $("#add-assignment-links-tab").children(":last")
                    }
                    $(n).find("input:first").val(x.ShortDescription);
                    $(n).find("input:last").val(x.Url);
                    $(n).data("id", x.LinkID);
                    $(n).find(".link-delete-button").show();
                    C.addLinkControl()
                }
            }
            if (p.DownloadItems.length > 0) {
                for (w = 0; w < p.DownloadItems.length; w++) {
                    r = p.DownloadItems[w];
                    n = $("#add-assignment-downloads-tab").children(":last");
                    if ($(n).find("input:first").val() !== "" && $(n).find("a.assignment-download-file-field:last").val() !== "") {
                        $(n).find(".download-delete-button").show();
                        C.addDownloadControl();
                        n = $("#add-assignment-downloads-tab").children(":last")
                    }
                    t = r.FileName;
                    v = r.FriendlyFileName || r.FileName;
                    u = $(n).find("input:first").parent().next();
                    $(n).find("input:last").val(r.ShortDescription);
                    u.data("rawFile", t);
                    $(n).find("input.assignment-download-file-name").data("fileType", r.FileTypeID);
                    u.val(v.substring(0, v.lastIndexOf(".")));
                    u.next().html(t.substring(t.lastIndexOf(".")));
                    $(n).find("input:first").siblings("span:first").html("Change");
                    $(n).data("id", r.DownloadID);
                    $(n).data("originalFile", t);
                    $(n).data("fileTypeId", r.FileTypeID);
                    $(n).find(".download-delete-button").show();
                    C.addDownloadControl()
                }
            }
        },
        initializeFileUpload: function() {
            b.Us.initializeFileUpload(this)
        },
        handleLinks: function(n) {
            b.Us.handleLinks(n, this);
            return false
        },
        handleDownloads: function(n) {
            b.Us.handleDownloads(n, this);
            return false
        },
        submitTypeChange: function(o) {
            var s = this,
                p, r = $(o.currentTarget).val(),
                n = (r === "1"),
                q = (r === "2");
            this.toggleDropBox(n);
            if (q) {
                p = s.$("#rdoLtiSubmit").data("providerid");
                if (p) {
                    s.Lti.currentProviderId = p;
                    s.Lti.locateProvider(p);
                    if (s.Lti.currentProvider.get("OutcomesInd")) {
                        s.forceIncludeInGradebook()
                    }
                } else {
                    s.Lti.currentProviderListId = "submission"
                }
                s.adjustLtiUI()
            } else {
                if (s.Lti.currentProviderListId === "submission") {
                    s.Lti.currentProviderId = 0;
                    s.Lti.currentProviderListId = "none";
                    s.adjustLtiUI()
                }
            }
        },
        toggleDropBox: function(n) {
            if ($("#rdoOnCampusSubmit").length > 0) {
                if (n) {
                    $("#add-assignment-dropbox-num-files").prop("disabled", false);
                    $("#add-assignment-dropbox-late-time").prop("disabled", false)
                } else {
                    $("#add-assignment-dropbox-num-files").prop("disabled", true);
                    $("#add-assignment-dropbox-late-time").prop("disabled", true)
                }
            }
        },
        toggleGradeBook: function(n) {
            if ($("#add-assignment-gradebook-include").is(":checked")) {
                $("#add-assignment-gradebook-include-cum-grade").prop("disabled", false);
                $("#add-assignment-gradebook-extra-credit").prop("disabled", false);
                $("#add-assignment-gradebook-include-cum-grade").prop("disabled", false);
                $("#add-assignment-gradebook-publish").prop("disabled", false);
                $("#add-assignment-gradebook-abbr").prop("disabled", false);
                $("#add-assignment-gradebook-max-points").prop("disabled", false);
                $("#add-assignment-gradebook-factor").prop("disabled", false)
            } else {
                $("#add-assignment-gradebook-include-cum-grade").prop("disabled", true);
                $("#add-assignment-gradebook-extra-credit").prop("disabled", true);
                $("#add-assignment-gradebook-include-cum-grade").prop("disabled", true);
                $("#add-assignment-gradebook-publish").prop("disabled", true);
                $("#add-assignment-gradebook-abbr").prop("disabled", true);
                $("#add-assignment-gradebook-max-points").prop("disabled", true);
                $("#add-assignment-gradebook-factor").prop("disabled", true)
            }
        },
        addLinkControl: function() {
            b.Us.addLinkControl(this)
        },
        addDownloadControl: function() {
            b.Us.addDownloadControl(this)
        },
        deleteLinkItem: function(n) {
            b.Us.deleteLinkItem(n, this);
            return false
        },
        deleteDownloadItem: function(n) {
            b.Us.deleteDownloadItem(n, this);
            return false
        },
        switchAddMode: function(n) {
            var o = this;
            if (this.AddMode) {
                if (this.AddExisting) {
                    $(".assignment-add-header").html("Add New Assignment");
                    $("#add-existing-assignment-link").html("Add Existing");
                    p3.fT(o.newTemplate, function(u) {
                        var p;
                        $("#site-modal .modal-body").html(u({
                            AddMode: o.AddMode,
                            WindowTitle: o.title,
                            edit: o.options ? o.options.edit || false : false,
                            gradebookInd: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADEBOOK),
                            dropboxInd: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.ASSIGNMENTDROPBOX),
                            assignmentTypes: [{
                                Type: "-- Select An Assignment Type --",
                                AssignmentTypeId: 0
                            }].concat(b.Data.Types.toJSON()),
                            sections: b.Data.TeacherSections.toJSON(),
                            notifEnabled: o.notifEnabled,
                            notifTooltip: o.notifTooltip
                        }));
                        b.Us.LoadDateTimePickers(o.ActiveAssignmentSections);
                        var t = e.buildTimeString(0, 0, 0);
                        $(".input-mini.time-picker-field.hasTimePicker").attr("placeholder", t);
                        p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.jQueryUI, function() {
                            p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.FileUpload, o.initializeFileUpload)
                        });
                        o.resetPublisOptions();
                        if (b.Data.currentLeadSectionId === undefined) {
                            $(".select-all-check").prop("checked", false);
                            $(".add-assignment-section-selector").prop("checked", false)
                        }
                        if (p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADEBOOK)) {
                            var r = b.Data.TeacherSections.pluck("LeadSectionId");
                            var s = "";
                            for (p = 0; p < r.length; p++) {
                                if (s.length > 0) {
                                    s += ","
                                }
                                s += r[p].toString()
                            }
                            var q = new b.Cs.MarkingPeriods();
                            q.fetch({
                                data: {
                                    sectionList: s
                                },
                                success: function(y, F) {
                                    var G = $(".grade-book-tooltip-location"),
                                        z, H, D, E, v, A, w, x, B, C;
                                    for (p = 0; p < G.length; p++) {
                                        H = $(G[p]).data("sectionId");
                                        if (H && H > 0) {
                                            D = b.Us.GetMarkingPeriods(y, H);
                                            if (D.length === 0) {
                                                $(G[p]).hide()
                                            } else {
                                                E = "<strong>Marking Periods:</strong><br>Due date must fall within a marking period for this assignment to be included in Grade Book.<br>";
                                                for (z = 0; z < D.length; z++) {
                                                    v = D[z].get("begin_date");
                                                    A = D[z].get("end_date");
                                                    if (typeof v === "string" && typeof A === "string") {
                                                        w = e.getDateString(e.getDate(v));
                                                        x = e.getTimeString(e.getTime(v));
                                                        B = e.getDateString(e.getDate(A));
                                                        C = e.getTimeString(e.getTime(A));
                                                        E += D[z].get("marking_period_description") + "<br><div>Begin: " + w + " " + x + "<br>End: " + B + " " + C + "<br></div>"
                                                    }
                                                }
                                                $(G[p]).show().tooltip({
                                                    title: E
                                                })
                                            }
                                        }
                                    }
                                },
                                error: function(v, w) {
                                    p3.displayError("Failed to retreive the Marking Periods")
                                }
                            })
                        }
                    });
                    this.initEditors();
                    this.AddExisting = false
                } else {
                    $(".assignment-add-header").html("Add Existing Assignment");
                    $("#add-existing-assignment-link").html("Add New");
                    if (o.ExistingSchoolYears === undefined) {
                        o.ExistingSchoolYears = new b.Cs.ExistingSchoolYears({}, {})
                    }
                    if (o.TeachersForYear === undefined) {
                        o.TeachersForYear = new b.Cs.ExistingTeachers()
                    }
                    if (o.SectionsForTeacher === undefined) {
                        o.SectionsForTeacher = new b.Cs.ExistingSections()
                    }
                    o.ExistingSchoolYears.fetch({
                        success: function(p, q) {
                            o.activeTeacher = p3.Data.Context.get("UserInfo") ? p3.Data.Context.get("UserInfo").UserId : 0;
                            o.activeYear = p.find(function(r) {
                                return r.get("Current")
                            }).get("Label");
                            o.TeachersForYear.fetch({
                                data: {
                                    schoolYear: o.activeYear
                                },
                                success: function(r, s) {
                                    o.SectionsForTeacher.fetch({
                                        data: {
                                            facultyUserId: o.activeTeacher,
                                            schoolYear: o.activeYear
                                        },
                                        success: function(v, x) {
                                            var u = v.toJSON();
                                            u = _.uniq(u, true, function(y) {
                                                return y.SectionId
                                            });
                                            var w, t = false;
                                            if (b.Data.currentLeadSectionId === undefined) {
                                                w = v.at(0);
                                                t = true
                                            } else {
                                                w = v.find(function(y) {
                                                    return y.get("SectionId").toString() == b.Data.currentLeadSectionId
                                                })
                                            }
                                            if (w !== undefined) {
                                                o.activeSection = w.get("SectionId");
                                                o.activeOffering = w.get("OfferingId")
                                            } else {
                                                o.activeSection = 0;
                                                o.activeOffering = 0
                                            }
                                            p3.fT(o.existingTemplate, function(z) {
                                                $("#site-modal .modal-body").html(z({
                                                    SchoolYears: p.toJSON(),
                                                    Teachers: r.toJSON(),
                                                    SectionNames: u,
                                                    sections: b.Data.TeacherSections.toJSON(),
                                                    notifEnabled: o.notifEnabled,
                                                    notifTooltip: o.notifTooltip
                                                }));
                                                if (o.activeTeacher) {
                                                    $("#existing-teacher-dd").val(o.activeTeacher)
                                                }
                                                if (b.Data.currentLeadSectionId) {
                                                    $("#existing-section-dd").val(b.Data.currentLeadSectionId)
                                                }
                                                b.Us.LoadDateTimePickers(o.ActiveAssignmentSections);
                                                var y = e.buildTimeString(0, 0, 0);
                                                $(".input-mini.time-picker-field.hasTimePicker").attr("placeholder", y);
                                                p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.jQueryUI, function() {
                                                    p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.FileUpload, o.initializeFileUpload)
                                                });
                                                o.resetPublisOptions();
                                                o.getExistingAssignments();
                                                if (t) {
                                                    $(".select-all-check").prop("checked", false);
                                                    $(".add-assignment-section-selector").prop("checked", false)
                                                }
                                            })
                                        },
                                        error: function(t, u) {
                                            p3.displayError("Error retreiving sections.")
                                        }
                                    })
                                },
                                error: function(s, t) {
                                    p3.displayError("Error retreiving teachers.")
                                }
                            })
                        },
                        error: function(p, q) {
                            p3.displayError("Error retreiving school years.")
                        }
                    });
                    this.AddExisting = true
                }
            }
            return false
        },
        doYearSelect: function(n) {
            var o = this;
            o.activeYear = $(n.currentTarget).val();
            if (o.TeachersForYear === undefined) {
                o.TeachersForYear = new b.Cs.ExistingTeachers()
            }
            o.updateTeachers(true, o.activeTeacher)
        },
        doTeacherSelect: function(n) {
            var o = this;
            o.activeTeacher = $(n.currentTarget).val();
            if (o.activeYear <= 0) {
                o.activeYear = $("#existing-school-year-dd").val()
            }
            if (o.SectionsForTeacher === undefined) {
                o.SectionsForTeacher = new b.Cs.ExistingSections()
            }
            o.updateSections(true)
        },
        doSectionSelect: function(o) {
            var n = $("#existing-section-dd");
            this.activeSection = n.val();
            var p = 'option[value="' + this.activeSection + '"]';
            this.activeOffering = n.children(p).data("offering");
            this.getExistingAssignments()
        },
        getExistingAssignments: function(p, o, n) {
            var q = this;
            p = p || q.activeTeacher;
            o = o || q.activeSection;
            n = n || q.activeOffering;
            if (p <= 0 || o <= 0 || n <= 0) {
                q.renderItems([])
            }
            if (q.ExistingAssignments === undefined) {
                q.ExistingAssignments = new b.Cs.ExistingAssignments();
                q.ExistingAssignments.filters = {
                    short_description: function(t, u) {
                        var r = t.get("short_description") || "",
                            s = u.get("short_description") || "";
                        return r < s ? -1 : r > s ? 1 : 0
                    },
                    date1: function(r) {
                        return r.get("date1") ? e.getDate(r.get("date1")).getTime() : 0
                    },
                    date2: function(r) {
                        return r.get("date2") ? e.getDate(r.get("date2")).getTime() : 0
                    },
                    extra: function(t, u) {
                        var r = t.get("extra") || "",
                            s = u.get("extra") || "";
                        return r < s ? -1 : r > s ? 1 : 0
                    },
                    short_description_invert: function(t, u) {
                        var r = t.get("short_description") || "",
                            s = u.get("short_description") || "";
                        return r < s ? 1 : r > s ? -1 : 0
                    },
                    date1_invert: function(r) {
                        return r.get("date1") ? -e.getDate(r.get("date1")).getTime() : 0
                    },
                    date2_invert: function(r) {
                        return r.get("date2") ? -e.getDate(r.get("date2")).getTime() : 0
                    },
                    extra_invert: function(t, u) {
                        var r = t.get("extra") || "",
                            s = u.get("extra") || "";
                        return r < s ? 1 : r > s ? -1 : 0
                    }
                }
            }
            q.ExistingAssignments.fetch({
                data: {
                    facultyUserId: p,
                    offeringId: n,
                    sectionId: o
                },
                success: function(s, u) {
                    s.each(function(y) {
                        var r = y.get("date1"),
                            x = y.get("date2");
                        if (r !== undefined && typeof r.substring === "function" && r.indexOf(" ") > 0) {
                            y.set("date1", r.substring(0, r.indexOf(" ")))
                        }
                        if (x !== undefined && typeof x.substring === "function" && x.indexOf(" ") > 0) {
                            y.set("date2", x.substring(0, x.indexOf(" ")))
                        }
                    });
                    var t = s.toJSON();
                    if ($("#existing-search-field").val() !== "") {
                        t = [];
                        var v = $("#existing-search-field").val().toLowerCase();
                        var w = s.filter(function(r) {
                            return (r.get("short_description").toLowerCase().indexOf(v) > -1)
                        });
                        _.each(w, function(r) {
                            t.push(r.toJSON())
                        })
                    }
                    q.renderItems(t)
                },
                error: function(s, t) {
                    p3.displayError("Error retreiving Existing Assignments.")
                }
            })
        },
        updateTeachers: function(o, n) {
            var p = this;
            p.TeachersForYear.fetch({
                data: {
                    schoolYear: p.activeYear
                },
                success: function(s, t) {
                    var q = $("#existing-teacher-dd");
                    var u;
                    q.html("");
                    s.each(function(v) {
                        var r;
                        if (n && v.get("Id") === n) {
                            r = $("<option>", {
                                value: v.get("Id"),
                                selected: "selected"
                            }).html(v.get("Name"));
                            p.activeTeacher = v.get("Id")
                        } else {
                            if (!u) {
                                u = v.get("Id")
                            }
                            r = $("<option>", {
                                value: v.get("Id")
                            }).html(v.get("Name"))
                        }
                        q.append(r)
                    });
                    if (!n) {
                        p.activeTeacher = u;
                        p.keepOffering = false
                    } else {
                        p.keepOffering = true
                    }
                    if (s.length === 0) {
                        p.activeTeacher = 0
                    }
                    p.updateSections(o)
                },
                error: function(q, s) {
                    p3.displayError("Error retreiving teachers.")
                }
            })
        },
        updateSections: function(n) {
            var o = this;
            o.SectionsForTeacher.fetch({
                data: {
                    facultyUserId: o.activeTeacher,
                    schoolYear: o.activeYear
                },
                success: function(s, v) {
                    var p = $("#existing-section-dd");
                    var t = false,
                        u = o.keepOffering ? o.activeOffering : 0;
                    p.html("");
                    var q = [];
                    s.each(function(w) {
                        var r, x = w.get("SectionId");
                        if ($.inArray(x, q) === -1) {
                            r = $("<option>", {
                                value: w.get("SectionId"),
                                "data-offering": w.get("OfferingId")
                            }).html(w.get("Name"));
                            q.push(w.get("SectionId"));
                            p.append(r);
                            if (u && w.get("OfferingId") == u) {
                                o.activeOffering = w.get("OfferingId");
                                o.activeSection = w.get("SectionId");
                                u = 0;
                                t = true
                            } else {
                                if (!t) {
                                    o.activeOffering = w.get("OfferingId");
                                    o.activeSection = w.get("SectionId");
                                    t = true
                                }
                            }
                        }
                    });
                    if (s.length === 0) {
                        o.activeOffering = 0;
                        o.activeSection = 0
                    }
                    p.val(o.activeSection);
                    if (n) {
                        o.getExistingAssignments()
                    }
                },
                error: function(p, q) {
                    p3.displayError("Error retreiving sections.")
                }
            })
        },
        renderItems: function(n) {
            var o = this;
            p3.fT(o.ItemTemplate, function(p) {
                if (n !== undefined && n.length > 0) {
                    $("#existing-items-table").html(p({
                        assignments: n
                    }))
                } else {
                    $("#existing-items-table").html("<tr><td></td><td>There are no assignments to display.</td><td></td<td></td><td></td></tr>")
                }
            })
        },
        updateFilter: function(o) {
            var t = this;
            var n = $(o.currentTarget);
            var r = n.data("sort");
            $(".sort-icon").removeClass("p3icon-sortDown p3icon-sortUp p3icon-sortOff");
            $(".sort-icon").addClass("p3icon-sortOff");
            $(".existing-table-sort").removeClass("sort-active").addClass("muted");
            if (r !== undefined) {
                if (t.CurrentSort === r) {
                    r = r + "_invert";
                    n.removeClass("muted").addClass("sort-active");
                    n.children("i").removeClass("p3icon-sortOff").addClass("p3icon-sortUp")
                } else {
                    n.removeClass("muted").addClass("sort-active");
                    n.children("i").removeClass("p3icon-sortOff").addClass("p3icon-sortDown")
                }
                t.CurrentSort = r;
                t.ExistingAssignments.changeSort(r);
                t.ExistingAssignments.sort();
                var p = t.ExistingAssignments.toJSON();
                if ($("#existing-search-field").val() !== "") {
                    p = [];
                    var q = $("#existing-search-field").val().toLowerCase();
                    var s = t.ExistingAssignments.filter(function(u) {
                        return (u.get("short_description").toLowerCase().indexOf(q) > -1)
                    });
                    _.each(s, function(u) {
                        p.push(u.toJSON())
                    })
                }
                t.renderItems(p)
            }
        },
        doAssignmentDelete: function(n) {
            n.preventDefault();
            n.stopPropagation();
            var s = this;
            if (this.assignment !== undefined) {
                var r = '<div class="modal hide " tabindex="-1" id="confirm-modal"></div>';
                $(r).modal();
                var o = this.assignment.get("AssignmentId");
                var q = new b.Cs.SectionForAssignments({}, {
                    assignmentId: o
                });
                var p = new b.Vs.DeleteAssignmentModalView({
                    collection: q,
                    assignmentId: o,
                    container: $("#confirm-modal")
                }).on("assignmentDeleted", function() {
                    s.trigger("deleteAssignment");
                    p3.Layout.Containers.Modal.modal("hide")
                });
                p3.rV(p, $("#confirm-modal"), true);
                p3.showModal($("#confirm-modal"));
                p3.initModalHeightTimer($("#confirm-modal"));
                q.fetch({
                    error: function() {
                        p3.displayError("Error loading Sections associated with the assignment")
                    }
                })
            }
        },
        doSearchEnter: function(n) {
            if (n.keyCode === 13) {
                this.doSearch(n)
            }
        },
        doSearch: function(n) {
            var r = this;
            var p = $("#existing-search-field").val().toLowerCase();
            var q = r.ExistingAssignments.filter(function(s) {
                return (s.get("short_description").toLowerCase().indexOf(p) > -1)
            });
            var o = [];
            _.each(q, function(s) {
                o.push(s.toJSON())
            });
            r.renderItems(o);
            return false
        },
        resetExistingFields: function() {
            var n = this;
            n.$("input:radio[name=existing-assignmnet-options]:checked").prop("checked", false);
            n.resetPublisOptions()
        },
        resetPublisOptions: function() {
            var x = $("#add-assignment-sections-listing tr"),
                y = e.localDateTime(),
                z = this,
                u;
            var n = $("#assignment-default-assigned-date"),
                q = $("#assignment-default-assigned-time"),
                o = $("#assignment-default-due-date"),
                p, s, r, t, w, v;
            if (n && n.length > 0) {
                n.val(e.getDateString(y))
            }
            if (q && q.length > 0) {
                q.val("")
            }
            if (o && o.length > 0) {
                o.val("")
            }
            for (u = 0; u < x.length; u++) {
                p = $(x[u]);
                s = $(p.children("td")[0]).find(".add-assignment-section-selector");
                r = p.children("td")[1];
                t = p.children("td")[2];
                w = p.children("td")[3];
                v = $(p.children("td")[4]).find("input");
                if (s) {
                    if ($(s).data("defaultSection")) {
                        $(s).prop("checked", true)
                    } else {
                        $(s).prop("checked", false)
                    }
                }
                if (r) {
                    $(r).children("input:first").val(e.getDateString(y));
                    $(r).children("input:last").val("")
                }
                if (t) {
                    $(t).children("input:first").val("")
                }
                if (w) {
                    $(w).children("select").val(1)
                }
                if (v) {
                    $(v).prop("checked", false)
                }
            }
            if (!z.emptysections) {
                $("input.add-assignment-section-selector:checked").closest("tr").show();
                $(".add-assignment-section-selector:input:checkbox[checked!='checked']").closest("tr").remove()
            } else {
                $("input.add-assignment-section-selector").prop("checked", false);
                $("input.select-all-check").prop("checked", false)
            }
            $("#publish-options-apply-selected-button").removeClass("btn-primary");
            $("#publish-options-warning-message").hide("slow")
        },
        doCharacterCountLimit: function(n) {
            if ($(n.currentTarget).val().length >= 10) {
                if (n.keyCode != 8 && n.keyCode != 9 && n.keyCode != 13 && n.keyCode != 46 && (n.keyCode < 35 || n.keyCode > 40)) {
                    return false
                }
            }
        },
        doDropBoxActivate: function(n) {
            var o = $(n.target).data("assignmentId");
            p3.log("someday this button will activate the drop box for " + o);
            return false
        },
        doSelectionToggle: function(n) {
            b.Us.DoSelectionToggle(n)
        },
        showMoreButtonVisability: function() {
            var n = $("#add-assignment-sections-listing tr td label input:checked"),
                o = $("#add-assignment-sections-listing tr:visible");
            if (n.length >= o.length) {
                $(".select-all-check").prop("checked", true)
            } else {
                $(".select-all-check").prop("checked", false)
            }
        },
        highlightApplyToSelected: function(n) {
            $("#publish-options-apply-selected-button").addClass("btn-primary");
            $("#publish-options-warning-message").show("slow")
        },
        doApplyToSelected: function(n) {
            b.Us.DoApplyToSelected();
            return false
        },
        validated: function(E) {
            E = E || false;
            var G = this,
                A = [],
                B = $("#add-assignment-gradebook-include:checked").length == 1 ? true : false,
                r = $("#add-assignment-gradebook-include").closest(".control-group"),
                y = $("#add-assignment-type-selector"),
                n = $("#add-assignment-gradebook-abbr"),
                u = $("#add-assignment-gradebook-max-points"),
                q = $("#add-assignment-gradebook-factor"),
                x = $("#add-assignment-title-field"),
                p = $("#add-assignment-downloads-tab").children(".control-group"),
                t = $("#add-assignment-links-tab").children(".control-group"),
                v = $(".add-assignment-section-selector:checked"),
                o = $("#add-assignment-links-tab").closest(".control-group").children("label:first"),
                w = G.$("#add-assignment-lti-selector"),
                z = false;
            $("ul#add-assignment-attachment-tabs li").removeClass("error");
            $("#gradebook-include-label").removeClass("box-validate");
            if (!E) {
                if (x.val() === "") {
                    if (A.indexOf(p3.Us.InfoMessageLibrary.P3.RequiredInfoNotEntered) === -1) {
                        A.push(p3.Us.InfoMessageLibrary.P3.RequiredInfoNotEntered)
                    }
                    x.closest(".control-group").addClass("error")
                }
                if (x.val().length > 255) {
                    if (A.indexOf(p3.Us.InfoMessageLibrary.Assignment.TitleLengthError) === -1) {
                        A.push(p3.Us.InfoMessageLibrary.Assignment.TitleLengthError)
                    }
                    x.closest(".control-group").addClass("error")
                }
                if (x.val() !== "" && x.val().length <= 255) {
                    x.closest(".control-group").removeClass("error")
                }
                if (G.Lti.hasSavedPlacement && G.Lti.currentProviderListId === "submission") {
                    w.removeClass("box-validate")
                } else {
                    if (G.Lti.currentProviderListId === "submission") {
                        if (G.Lti.currentProviderId) {
                            w.removeClass("box-validate")
                        } else {
                            w.addClass("box-validate");
                            if (A.indexOf(p3.Us.InfoMessageLibrary.Assignment.LtiProviderRequired) === -1) {
                                A.push(p3.Us.InfoMessageLibrary.Assignment.LtiProviderRequired)
                            }
                        }
                    } else {
                        if (G.Lti.currentProviderListId === "lti") {
                            G.ltiView.doValidate(A)
                        }
                    }
                }
                if (t.length > 0) {
                    var F = /(((http[s]?):\/\/|mailto:)?\S+\.[a-zA-Z]{2,3}([\S\w\W]+|[\s+]))|(javascript:)\S+/i;
                    t.each(function(K) {
                        var I = $(this).find(".assignment-url-field"),
                            H = $(this).find(".assignment-conditional-required-field"),
                            J = false;
                        if (I.length === 0 && H.length === 0) {
                            return
                        }
                        if ((I.val() !== "" && H.val() === "") || (I.val() === "" && H.val() !== "")) {
                            if (A.indexOf(p3.Us.InfoMessageLibrary.P3.RequiredInfoNotEntered) === -1) {
                                A.push(p3.Us.InfoMessageLibrary.P3.RequiredInfoNotEntered)
                            }
                            $(this).addClass("error");
                            z = J = true
                        } else {
                            $(this).removeClass("error");
                            z = false
                        }
                        if (I.val() !== "" && !F.test(I.val())) {
                            if (A.indexOf(p3.Us.InfoMessageLibrary.P3.UrlError) === -1) {
                                A.push(p3.Us.InfoMessageLibrary.P3.UrlError)
                            }
                            $(this).addClass("error");
                            z = true
                        } else {
                            if (!J) {
                                $(this).removeClass("error");
                                z = false
                            }
                        }
                        if ($(this).hasClass("error")) {
                            $("ul#add-assignment-attachment-tabs li:first-child").addClass("error")
                        }
                    })
                }
                if (p.length > 0) {
                    var C = z;
                    p.each(function(L) {
                        var J = $(this).find(".assignment-download-file-name"),
                            I = J.siblings("span:last"),
                            H = $(this).find(".assignment-download-field"),
                            K = false;
                        if (J.length === 0 && I.length === 0 && H.length === 0) {
                            return
                        }
                        if ((J.val() !== "" && H.val() === "") || (J.val() === "" && H.val() !== "")) {
                            $(this).addClass("error");
                            z = K = true;
                            if (A.indexOf(p3.Us.InfoMessageLibrary.P3.RequiredInfoNotEntered) === -1) {
                                A.push(p3.Us.InfoMessageLibrary.P3.RequiredInfoNotEntered)
                            }
                        } else {
                            if (J.val() !== "" && !/^[^\\\/\:\*\?\"\\<\>\|\.\+]+(\.[^\\\/\:\*\?\"\\<\>\|\.\+]+)+$/.test(J.val() + I.html())) {
                                $(this).addClass("error");
                                z = K = true;
                                if (A.indexOf(p3.Us.InfoMessageLibrary.P3.FileNameInvalidChars) === -1) {
                                    A.push(p3.Us.InfoMessageLibrary.P3.FileNameInvalidChars)
                                }
                            } else {
                                if (J.val().length > 200) {
                                    $(this).addClass("error");
                                    z = K = true;
                                    if (A.indexOf(p3.Us.InfoMessageLibrary.P3.FileNameToLong) === -1) {
                                        A.push(p3.Us.InfoMessageLibrary.P3.FileNameToLong)
                                    }
                                } else {
                                    $(this).removeClass("error");
                                    if (!C) {
                                        z = false
                                    }
                                }
                            }
                        }
                        if (J.val() !== "" && H.val() !== "") {
                            if (p3.Data.fileTypes !== undefined) {
                                if (p3.Data.fileTypes.get(I.html().toLowerCase())) {
                                    if (!K) {
                                        I.removeClass("error");
                                        if (!C) {
                                            z = false
                                        }
                                    }
                                } else {
                                    I.addClass("error");
                                    z = K = true;
                                    if (A.indexOf(p3.Us.InfoMessageLibrary.Assignment.FileTypeUnsupported) === -1) {
                                        A.push(p3.Us.InfoMessageLibrary.Assignment.FileTypeUnsupported)
                                    }
                                }
                            }
                        }
                        if (I.data("Duplicate") === 1) {
                            $(this).addClass("error");
                            z = true;
                            if (A.indexOf(p3.Us.InfoMessageLibrary.P3.FileNameDuplicate) === -1) {
                                A.push(p3.Us.InfoMessageLibrary.P3.FileNameDuplicate)
                            }
                        } else {
                            if (!K) {
                                I.removeClass("error");
                                if (!C) {
                                    z = false
                                }
                            }
                        }
                        if ($(this).hasClass("error")) {
                            $("ul#add-assignment-attachment-tabs li:last-child").addClass("error")
                        }
                    })
                }
                if (z) {
                    o.addClass("error")
                } else {
                    o.removeClass("error")
                }
                r.removeClass("error");
                if (G.Lti.currentProviderListId === "lti" || G.Lti.currentProviderListId === "submission") {
                    if (G.Lti.currentProvider && (G.Lti.currentProvider.get("OutcomesInd") === true && !B)) {
                        r.addClass("error");
                        if (A.indexOf(p3.Us.InfoMessageLibrary.Assignment.GradedLTIRequiresGradebook) === -1) {
                            A.push(p3.Us.InfoMessageLibrary.Assignment.GradedLTIRequiresGradebook)
                        }
                    }
                }
                if (B) {
                    var s = n.closest(".controls").siblings("label:first"),
                        D = false;
                    if (G.markingPeriods.length <= 0) {
                        s.closest(".control-group").addClass("error");
                        if (A.indexOf(p3.Us.InfoMessageLibrary.Assignment.GradeBookSetupIsRequired) === -1) {
                            A.push(p3.Us.InfoMessageLibrary.Assignment.GradeBookSetupIsRequired)
                        }
                    } else {
                        s.closest(".control-group").removeClass("error")
                    }
                    if (y.val() === "0") {
                        y.closest(".control-group").addClass("error");
                        D = true;
                        if (A.indexOf(p3.Us.InfoMessageLibrary.Assignment.GradeBookRequiredFields) === -1) {
                            A.push(p3.Us.InfoMessageLibrary.Assignment.GradeBookRequiredFields)
                        }
                    } else {
                        y.closest(".control-group").removeClass("error")
                    }
                    if (n.val() === "") {
                        n.closest(".control-group").addClass("error");
                        D = false;
                        if (A.indexOf(p3.Us.InfoMessageLibrary.Assignment.GradeBookRequiredFields) === -1) {
                            A.push(p3.Us.InfoMessageLibrary.Assignment.GradeBookRequiredFields)
                        }
                    } else {
                        n.closest(".control-group").removeClass("error")
                    }
                    if (u.val() !== "" && /^\d*(\.\d{1,})?$/.test(u.val())) {
                        u.closest(".control-group").removeClass("error");
                        if (u.val().toString().length > 6) {
                            u.val(u.val().substring(0, 6))
                        }
                    } else {
                        u.closest(".control-group").addClass("error");
                        D = false;
                        if (A.indexOf(p3.Us.InfoMessageLibrary.Assignment.GradeBookRequiredFields) === -1) {
                            A.push(p3.Us.InfoMessageLibrary.Assignment.GradeBookRequiredFields)
                        }
                    }
                    if (q.val() !== "" && /^\d*(\.\d{1,})?$/.test(q.val()) && q.val() !== "0") {
                        q.closest(".control-group").removeClass("error");
                        if (q.val().toString().length > 6) {
                            q.val(q.val().substring(0, 6))
                        }
                    } else {
                        q.closest(".control-group").addClass("error");
                        D = false;
                        if (A.indexOf(p3.Us.InfoMessageLibrary.Assignment.GradeBookRequiredFields) === -1) {
                            A.push(p3.Us.InfoMessageLibrary.Assignment.GradeBookRequiredFields)
                        }
                    }
                    if (A.indexOf(p3.Us.InfoMessageLibrary.Assignment.GradeBookRequiredFields) !== -1) {
                        if (!D) {
                            s.addClass("error")
                        } else {
                            s.removeClass("error")
                        }
                    } else {
                        s.removeClass("error")
                    }
                }
            }
            if (v.length > 0) {
                v.each(function(R) {
                    var H = $(this).closest("td").siblings("td:first").children("input:first"),
                        M = e.getDate(H.val());
                    if (isNaN(M)) {
                        H.addClass("error");
                        if (A.indexOf(p3.Us.InfoMessageLibrary.P3.RequiredInfoNotEntered) === -1) {
                            A.push(p3.Us.InfoMessageLibrary.P3.RequiredInfoNotEntered)
                        }
                    } else {
                        H.removeClass("error")
                    }
                    if (p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADEBOOK) && G.markingPeriods.length > 0) {
                        var U = parseInt($(this).val(), 10),
                            S = false,
                            I = $("#" + U + "-due-date"),
                            O = I.val(),
                            N = e.getDate(O),
                            L, T = G.markingPeriods.filter(function(V) {
                                return V.get("section_id") === U
                            }),
                            J, P, K, Q;
                        if (isNaN(N)) {
                            N = M
                        }
                        for (L = 0; L < T.length; L++) {
                            J = T[L].get("begin_date");
                            P = T[L].get("end_date");
                            if (typeof J === "string" && typeof P === "string") {
                                K = e.getDate(J);
                                Q = e.getDate(P);
                                if (N <= Q && N >= K) {
                                    S = true
                                }
                            }
                        }
                        if (!S) {
                            I.closest(".control-group").addClass("error");
                            if (A.indexOf(p3.Us.InfoMessageLibrary.Assignment.DueDateMustBeInMarkingPeriod) === -1) {
                                A.push(p3.Us.InfoMessageLibrary.Assignment.DueDateMustBeInMarkingPeriod)
                            }
                        } else {
                            I.closest(".control-group").removeClass("error")
                        }
                    }
                })
            } else {
                if (A.indexOf(p3.Us.InfoMessageLibrary.Assignment.SectionRequired) === -1) {
                    A.push(p3.Us.InfoMessageLibrary.Assignment.SectionRequired)
                }
            }
            return A
        },
        doAssignmentSave: function(D) {
            var an = this,
                M = false,
                p = e.localDateTime(),
                ac, af, ag, C, Q, S, ad, o, A, Z;
            if (an.AddExisting) {
                ac = an.$("input:radio[name=existing-assignmnet-options]:checked");
                af = an.$(".add-assignment-section-selector:checked");
                ag = [];
                C = an.validated(true);
                if (C.length > 0) {
                    _.each(C, function(ao) {
                        p3.Us.InfoMessage.ErrorBox(ao, "#existing-assignments-container", false);
                        M = true
                    })
                }
                if (M) {
                    $("#site-modal .modal-body").scrollTop(1);
                    return false
                }
                for (Q = 0; Q < af.length; Q++) {
                    ad = $(af[Q]).closest("td").nextAll("td");
                    o = $(ad[0]).children("input");
                    A = $(ad[1]).children("input");
                    Z = $(ad[2]).children("select").val();
                    p = e.localDateTime();
                    if ($(o[0]).val() !== "") {
                        p = e.getDate($(o[0]).val())
                    }
                    if (e.getDate($(A[0]).val()).getTime() < p.getTime()) {
                        $(A[0]).closest(".control-group").addClass("error");
                        M = true
                    }
                    ag.push({
                        SectionId: $(af[Q]).val(),
                        AssignmentDate: $(o[0]).val() || e.getDateString(p),
                        AssignmentTime: b.Us.GetAssignmentTime($(o[1])),
                        DueDate: $(A[0]).val() || e.getDateString(p),
                        DueTime: e.buildTimeString(23, 59, 0),
                        PublishInd: Z == 1 ? true : false,
                        PublishOnAssignedInd: Z == 2 ? true : false
                    })
                }
                var ab = new b.Ms.ExistingAssignment({
                    AssignmentId: ac.val(),
                    SectionLinks: ag,
                    SendNotification: $("#send_notif_check").is(":checked")
                });
                ab.save({}, {
                    success: function(ao, ap) {
                        an.trigger("saveAssignment");
                        if ($(D.target).hasClass("add-assignment-save-add-another")) {
                            an.resetExistingFields();
                            $("#site-modal .modal-body").scrollTop(1)
                        } else {
                            $("#site-modal").modal("hide")
                        }
                    },
                    error: function(ao, ap) {
                        p3.displayError("Error creating assignment")
                    }
                })
            } else {
                $("#assignment-edit-form-container").children(".alert").remove();
                var B = tinyMCE.get("add-assignment-title-field");
                if (B !== undefined && typeof B.save === "function") {
                    B.save()
                }
                B = tinyMCE.get("add-assignment-description-field");
                if (B !== undefined && typeof B.save === "function") {
                    B.save()
                }
                C = an.validated();
                if (C.length > 0) {
                    _.each(C, function(ao) {
                        p3.Us.InfoMessage.ErrorBox(ao, "#assignment-edit-form-container", false);
                        M = true
                    })
                }
                if (M) {
                    $("#site-modal .modal-body").scrollTop(1);
                    return false
                }
                var ah = ($("#add-assignment-title-field").data("contents") !== undefined ? $("#add-assignment-title-field").data("contents") : $("#add-assignment-title-field").val()),
                    v = ($("#add-assignment-description-field").data("contents") !== undefined ? $("#add-assignment-description-field").data("contents") : $("#add-assignment-description-field").val()),
                    aj = $("#add-assignment-type-selector").val(),
                    n = $("#add-assignment-gradebook-abbr").val(),
                    W = $("#add-assignment-gradebook-max-points").val(),
                    G = $("#add-assignment-gradebook-factor").val(),
                    P = $("#add-assignment-gradebook-include:checked").length == 1 ? true : false,
                    O = $("#add-assignment-gradebook-include-cum-grade:checked").length == 1 ? true : false,
                    F = $("#add-assignment-gradebook-extra-credit:checked").length == 1 ? true : false,
                    aa = $("#add-assignment-gradebook-publish:checked").length == 1 ? true : false,
                    q = $("#rdoOnCampusSubmit:checked").length == 1 ? true : false,
                    s = $("#add-assignment-dropbox-num-files").val(),
                    r = e.buildTimeString(23, 59, 0),
                    T = $("#add-assignment-links-tab").children("div"),
                    y = $("#add-assignment-downloads-tab").children("div"),
                    V, ae;
                af = $(".add-assignment-section-selector:checked");
                if (q && $("#add-assignment-dropbox-late-time").length > 0 && $("#add-assignment-dropbox-late-time").val() !== "") {
                    r = $("#add-assignment-dropbox-late-time").getTime()
                }
                ag = [];
                var al = /((http[s]?):\/\/|mailto:)/i,
                    U = [],
                    z = [],
                    X = [],
                    u, Y, ak, K, x, w, t, H, L, ai, J, E, N, I, R, am;
                for (Q = 0; Q < af.length; Q++) {
                    ad = $(af[Q]).closest("td").nextAll("td");
                    o = $(ad[0]).children("input");
                    A = $(ad[1]).children("input");
                    Z = $(ad[2]).children("select").val();
                    ae = $(af[Q]).val();
                    p = e.localDateTime();
                    if ($(o[0]).val() !== "") {
                        p = e.getDate($(o[0]).val())
                    }
                    if (e.getDate($(A[0]).val()).getTime() < p.getTime()) {
                        $(A[0]).closest(".control-group").addClass("error");
                        M = true
                    }
                    if (this.assignment !== undefined) {
                        ag.push({
                            SectionId: ae,
                            AssignmentId: this.assignment.get("AssignmentId") || null,
                            AssignmentIndexId: this.assignment.get("AssignmentIndexId") || null,
                            AssignmentDate: $(o[0]).val() || e.getDateString(p),
                            AssignmentTime: b.Us.GetAssignmentTime($(o[1])),
                            DueDate: $(A[0]).val() || e.getDateString(p),
                            DueTime: r || e.buildTimeString(23, 59, 0),
                            Section: null,
                            PublishInd: Z == 1 ? true : false,
                            PublishOnAssignedInd: Z == 2 ? true : false
                        })
                    } else {
                        ag.push({
                            SectionId: ae,
                            AssignmentDate: $(o[0]).val() || e.getDateString(p),
                            AssignmentTime: b.Us.GetAssignmentTime($(o[1])),
                            DueDate: $(A[0]).val() || e.getDateString(p),
                            DueTime: r || e.buildTimeString(23, 59, 0),
                            Section: null,
                            PublishInd: Z == 1 ? true : false,
                            PublishOnAssignedInd: Z == 2 ? true : false
                        })
                    }
                    if (this.options.edit) {
                        if ($("#" + ae + "-notification-send").is(":checked")) {
                            X.push(ae)
                        }
                    }
                }
                if (this.assignment !== undefined && typeof this.assignment.get === "function") {
                    _.each(this.assignment.get("SectionLinks"), function(ao) {
                        if (ao.HasGrades && _.find(ag, function(ap) {
                                return ao.SectionId == ap.SectionId
                            }) === undefined) {
                            ag.push({
                                SectionId: ao.SectionId,
                                AssignmentDate: ao.AssignmentDate,
                                AssignmentTime: ao.AssignmentTime,
                                DueDate: ao.DueDate,
                                DueTime: ao.DueTime,
                                Section: null,
                                PublishInd: ao.PublishInd,
                                PublishOnAssignedInd: ao.PublishOnAssignedInd
                            })
                        }
                    })
                }
                if (M) {
                    $("#site-modal .modal-body").scrollTop(1);
                    return false
                }
                if (T.length > 0) {
                    for (Q = 0, S = T.length; Q < S; Q++) {
                        R = $(T[Q]).find("input:first").val();
                        am = $(T[Q]).find("input:last").val();
                        u = $(T[Q]).children("span").data("needsDelete");
                        if (u) {
                            N = $(T[Q]).children("span").data("id");
                            if (N && N > 0) {
                                U.push({
                                    LinkId: N,
                                    ContextValue: -1
                                })
                            }
                        } else {
                            if (R && am && R != "" && am != "") {
                                if (!al.test(am)) {
                                    am = "http://" + am
                                }
                                if (this.assignment === undefined) {
                                    U.push({
                                        Url: am,
                                        ShortDescription: R
                                    })
                                } else {
                                    U.push({
                                        LinkId: $(T[Q]).data("id"),
                                        Url: am,
                                        ShortDescription: R
                                    })
                                }
                            }
                        }
                    }
                }
                if (y.length > 0) {
                    for (Q = 0, S = y.length; Q < S; Q++) {
                        t = $(y[Q]).find("input:last").val();
                        H = $(y[Q]).find("input.assignment-download-file-name").data("rawFile");
                        L = $(y[Q]).find("input.assignment-download-file-name").val();
                        ai = $(y[Q]).find("input.assignment-download-file-name").data("attachedFileName");
                        J = $(y[Q]).find("input.assignment-download-file-name").data("fileType");
                        E = "";
                        u = $(y[Q]).children("span").data("needsDelete");
                        if (u) {
                            N = $(y[Q]).children("span").data("id");
                            I = $(y[Q]).children("span").data("filename");
                            if (N && N > 0) {
                                z.push({
                                    DownloadId: N,
                                    ContextValue: -1,
                                    FileName: I
                                })
                            }
                            break
                        }
                        if (ai !== undefined) {
                            E = ai.substring(ai.lastIndexOf("."))
                        } else {
                            E = $(y[Q]).find("input.assignment-download-file-name").next().html()
                        }
                        if (H === "" && t === "" && (ai === undefined || ai === "")) {
                            break
                        }
                        if (this.assignment === undefined) {
                            if (t && t != "" && ((H !== undefined && H != "") || (L !== undefined && L != "")) && ai !== undefined && ai != "" && E != "" && $(y[Q]).find("input.assignment-download-file-name").data("fileChanged") === true) {
                                z.push({
                                    FileName: H || L + E,
                                    FriendlyFileName: L + E,
                                    UploadedFile: ai,
                                    FileTypeID: J,
                                    DownloadID: 0,
                                    Description: t
                                })
                            }
                        } else {
                            Y = $(y[Q]).data("originalFile");
                            ak = ai;
                            K = J || $(y[Q]).data("fileTypeId");
                            x = $(y[Q]).data("id");
                            w = {};
                            if (Y && K && x) {
                                if (H && E != H.substring(H.lastIndexOf("."))) {
                                    H = H.substring(0, H.lastIndexOf(".")) + E
                                }
                                w.DownloadID = x || 0;
                                w.FileName = H || L + E;
                                w.FriendlyFileName = L + E || "";
                                w.FileTypeID = K || 0;
                                w.Description = t || "";
                                if (Y != H) {
                                    w.OriginalFile = Y
                                }
                                if (ak !== undefined && ak !== "") {
                                    w.UploadedFile = ak
                                }
                                z.push(w)
                            } else {
                                if (typeof K === "number" && K > 0 && t && t != "") {
                                    z.push({
                                        FileName: H || L + E,
                                        FriendlyFileName: L + E,
                                        UploadedFile: ai,
                                        FileTypeID: J,
                                        DownloadID: 0,
                                        Description: t
                                    })
                                }
                            }
                        }
                    }
                }
                if (this.assignment === undefined) {
                    this.assignment = new b.Ms.Assignment({
                        AssignmentTypeId: aj,
                        ShortDescription: ah,
                        LongDescription: v,
                        IncGradeBook: P,
                        AbbrDescription: n,
                        MaxPoints: W,
                        Factor: G,
                        ExtraCredit: F,
                        IncCumGrade: O,
                        PublishGrade: aa,
                        DropboxInd: q,
                        DropboxNumFiles: s,
                        DropboxTimeLate: r || e.buildTimeString(23, 59, 0),
                        SectionLinks: ag,
                        LinkItems: U,
                        DownloadItems: z,
                        SendNotification: $("#send_notif_check").is(":checked"),
                        Notifications: X,
                        HasGrades: (an.options.assignment == undefined) ? false : an.options.assignment.get("HasGrades")
                    })
                } else {
                    this.assignment.set({
                        AssignmentTypeId: aj,
                        ShortDescription: ah,
                        LongDescription: v,
                        IncGradeBook: P,
                        AbbrDescription: n,
                        MaxPoints: W,
                        Factor: G,
                        ExtraCredit: F,
                        IncCumGrade: O,
                        PublishGrade: aa,
                        DropboxInd: q,
                        DropboxNumFiles: s,
                        DropboxTimeLate: r || e.buildTimeString(23, 59, 0),
                        SectionLinks: ag,
                        LinkItems: U,
                        DownloadItems: z,
                        SendNotification: false,
                        Notifications: X,
                        HasGrades: (an.options.assignment == undefined) ? false : an.options.assignment.get("HasGrades")
                    })
                }
                V = an.assignment.get("Lti");
                if (V === undefined) {
                    V = []
                }
                if (an.Lti.currentProviderListId === "lti") {
                    if (V.length === 0) {
                        V.push(an.ltiView.buildLtiPlacementJson())
                    } else {
                        V[0] = an.ltiView.buildLtiPlacementJson()
                    }
                } else {
                    if (an.Lti.currentProviderListId === "submission") {
                        if (V.length === 0) {
                            V.push({
                                ProviderId: an.Lti.currentProviderId
                            })
                        } else {
                            V[0].ProviderId = an.Lti.currentProviderId
                        }
                    } else {
                        V = []
                    }
                }
                this.assignment.set("Lti", V);
                this.assignment.save({}, {
                    success: function(ao, ap) {
                        an.trigger("saveAssignment");
                        if ($(D.target).hasClass("add-assignment-save-add-another")) {
                            an.resetAssignmentFields(true);
                            $("#site-modal .modal-body").scrollTop(1)
                        } else {
                            $("#site-modal").modal("hide")
                        }
                    },
                    error: function(ao, ap) {
                        p3.displayError("Error creating assignment")
                    }
                })
            }
            return false
        },
        showGroupDialog: function(n) {
            var p = this;
            $("#show-more-groups").button("loading");
            var o = [];
            $(".add-assignment-section-selector").each(function(q) {
                o.push("null_" + $(this).val())
            });
            h.Us.showGroupPickerDialog(58, o, p);
            return false
        },
        addSelectedGroups: function(n) {
            var q = this,
                o;
            b.Us.addSelectedGroups(q, n);
            var p = "";
            $(".add-assignment-section-selector").each(function(r, s) {
                if (p.length > 0) {
                    p += ","
                }
                p += $(s).val()
            });
            for (o = 0; o < n.length; o++) {
                if (p.length > 0) {
                    p += ","
                }
                p += n[o].leadSectionId.toString()
            }
            q.markingPeriods.fetch({
                data: {
                    sectionList: p
                },
                success: function(w, D) {
                    var E = $(".grade-book-tooltip-location"),
                        x, F, t, y, u, v, z, A, B, C;
                    for (o = 0; o < E.length; o++) {
                        F = $(E[o]).data("sectionId");
                        if (F && F > 0) {
                            B = b.Us.GetMarkingPeriods(w, F);
                            if (B.length === 0) {
                                $(E[o]).hide()
                            } else {
                                C = "<strong>Marking Periods:</strong><br>Due date must fall within a marking period for this assignment to be included in Grade Book.<br>";
                                for (x = 0; x < B.length; x++) {
                                    t = B[x].get("begin_date");
                                    y = B[x].get("end_date");
                                    if (typeof t === "string" && typeof y === "string") {
                                        u = e.getDateString(e.getDate(t));
                                        v = e.getTimeString(e.getTime(t));
                                        z = e.getDateString(e.getDate(y));
                                        A = e.getTimeString(e.getTime(y));
                                        C += B[x].get("marking_period_description") + "<br><div>Begin: " + u + " " + v + "<br>End: " + z + " " + A + "<br></div>"
                                    }
                                }
                                $(E[o]).show().tooltip({
                                    title: C
                                })
                            }
                        }
                    }
                },
                error: function(s, t) {
                    p3.displayError("Failed to retreive the Marking Periods")
                }
            })
        },
        showToggleContent: function(n) {
            $(n.target).parent().siblings(".content").slideToggle();
            return false
        },
        assignmentTypeDefaultMaxPoint: function(o) {
            var n = _.first(b.Data.Types.where({
                AssignmentTypeId: parseInt($(o.target).val(), 10)
            }));
            if (n && this.$el.find("#add-assignment-gradebook-max-points").val() === "") {
                this.$el.find("#add-assignment-gradebook-max-points").val(n.get("DefaultMaxPoints"))
            }
        }
    });
    b.Vs.ClassAssignmentView = Bb.View.extend({
        template: "classassignment/classassignment.template.html",
        assignmentlistview: undefined,
        events: {
            "click .addAssignmentButton": "assignmentAddWindow",
            "click #assignmentSearchButton": "doAssignmentSearch",
            "blur #assignmentSearchBox": "doSearchFix",
            "keypress #assignmentSearchBox": "doAssignmentSearchEnter",
            "click .addAssessmentButton": "addAssessment",
            "click .addDiscussionButton": "addDiscussion",
            "click .ltiConfigButton": "showLtiConfigList"
        },
        initialize: function() {
            this.Containers = {};
            this.sectionId = this.options.sectionId || 0;
            b.Data.currentLeadSectionId = this.leadSectionId = this.options.leadSectionId || 0;
            this.assginments = null;
            p3.Layout.Containers.Modal.on("shown", b.Us.showHtmlEditor);
            this.userHasFullAccess = this.options.userHasFullAccess || false;
            this.isOwner = this.options.isOwner || false;
            this.isManager = this.options.isManager || false;
            this.content = this.options.content;
            this.canEdit = false;
            this.isEditor = false;
            if (this.userHasFullAccess) {
                this.canEdit = true
            } else {
                var n = this.content.get(58);
                if (n && n.get("EditorAccess")) {
                    this.canEdit = true;
                    this.isEditor = true
                }
            }
            if (this.canEdit) {
                b.Us.FetchTeacherSections(this.leadSectionId, this.isOwner, this.isManager, this.isEditor)
            }
        },
        dispose: function() {
            p3.Layout.Containers.Modal.off("shown", b.Us.showHtmlEditor);
            if (b.Data.currentLeadSectionId) {
                b.Data.currentLeadSectionId = undefined
            }
            if (b.Data.TeacherSections) {
                b.Data.TeacherSections = undefined
            }
            var n = tinyMCE.get("myeditor");
            if (n) {
                n.remove();
                n = null
            }
        },
        render: function(o) {
            var p = this,
                n = function() {
                    p.rVs(o)
                };
            k.loadReportList2(n, n)
        },
        rVs: function(n) {
            var q = this,
                p, o, r;
            p = new k.Cs.ReportList();
            p.remove(p.at(0));
            if (q.canEdit && k.hasAccessToReportId(324, true)) {
                r = l.Us.getUrlById(1691, "__pd=gm_fv&pk=324&ext=vw&o_pk=" + q.sectionId);
                o = new k.Ms.ReportList({
                    ReportName: "Roster Assignments Due - By Section",
                    Link: r
                });
                p.add(o)
            }
            if (q.canEdit && k.hasAccessToReportId(82, true)) {
                r = l.Us.getUrlById(1691, "__pd=gm_fv&pk=82&ext=vw&o_pk=" + q.sectionId);
                o = new k.Ms.ReportList({
                    ReportName: "Roster Major Assignments - By Section",
                    Link: r
                });
                p.add(o)
            }
            if (q.canEdit && k.hasAccessToReportId(444, true)) {
                r = l.Us.getUrlById(1691, "__pd=gm_fv&pk=444&ext=vw&sid=" + q.leadSectionId);
                o = new k.Ms.ReportList({
                    ReportName: "Submitted Assignments - By Student",
                    Link: r
                });
                p.add(o)
            }
            if (q.canEdit && k.hasAccessToReportId(412, true)) {
                r = l.Us.getUrlById(1691, "__pd=gm_fv&pk=412&ext=vw&sid=" + q.leadSectionId + "&vid=" + p3.Data.Context.get("UserInfo").UserId);
                o = new k.Ms.ReportList({
                    ReportName: "View Schedule",
                    Link: r
                });
                p.add(o)
            }
            q.reports = p;
            p3.fT(q.template, function(s) {
                q.$el.html(s({
                    leadSectionId: q.leadSectionId,
                    schoolId: p3.Config.SchoolId
                }));
                $(n).html(q.el);
                q.Containers.LeftColumn = $("#2col-wideleft");
                q.Containers.RightColumn = $("#2col-slimright");
                q.renderContent()
            })
        },
        renderContent: function() {
            b.Data.assignments = new b.Cs.Assignments({}, {
                dateSort: 1,
                assignTypes: null,
                startDate: null,
                endDate: null,
                sectionId: this.leadSectionId,
                studentId: b.Data.studentId
            });
            b.Data.assignments.filters = {
                AssignmentDescription: function(p, q) {
                    var n = p.get("AssignmentDescription") || "",
                        o = q.get("AssignmentDescription") || "";
                    return n < o ? -1 : n > o ? 1 : 0
                },
                AssignmentDescription_invert: function(p, q) {
                    var n = p.get("AssignmentDescription") || "",
                        o = q.get("AssignmentDescription") || "";
                    return n < o ? 1 : n > o ? -1 : 0
                },
                AssignmentType: function(p, q) {
                    var n = p.get("AssignmentType") || "",
                        o = q.get("AssignmentType") || "";
                    return n < o ? -1 : n > o ? 1 : 0
                },
                AssignmentType_invert: function(p, q) {
                    var n = p.get("AssignmentType") || "",
                        o = q.get("AssignmentType") || "";
                    return n < o ? 1 : n > o ? -1 : 0
                },
                DateAssigned: function(n) {
                    return n.get("DateAssigned") ? e.getDate(n.get("DateAssigned")).getTime() : 0
                },
                DateAssigned_invert: function(n) {
                    return n.get("DateAssigned") ? -e.getDate(n.get("DateAssigned")).getTime() : 0
                },
                DateDue: function(n) {
                    return n.get("DateDue") ? e.getDate(n.get("DateDue")).getTime() : 0
                },
                DateDue_invert: function(n) {
                    return n.get("DateDue") ? -e.getDate(n.get("DateDue")).getTime() : 0
                },
                Publish: function(n) {
                    var o;
                    if (n.get("PublishOnAssignedInd")) {
                        o = 1
                    } else {
                        if (n.get("PublishInd")) {
                            o = 3
                        } else {
                            o = 2
                        }
                    }
                    return o
                },
                Publish_invert: function(n) {
                    var o;
                    if (n.get("PublishOnAssignedInd")) {
                        o = 3
                    } else {
                        if (n.get("PublishInd")) {
                            o = 1
                        } else {
                            o = 2
                        }
                    }
                    return o
                },
                GradedCount: function(t, u) {
                    var r = t.get("GradedCount"),
                        n = t.get("NumEnrolled"),
                        s = u.get("GradedCount"),
                        o = u.get("NumEnrolled"),
                        p = r === n,
                        q = s === o;
                    if (t.get("GradeBookInd") === false && u.get("GradeBookInd") === false) {
                        return 0
                    }
                    if (t.get("GradeBookInd") === false && u.get("GradeBookInd") === true) {
                        return -1
                    }
                    if (t.get("GradeBookInd") === true && u.get("GradeBookInd") === false) {
                        return 1
                    }
                    if (r === 0 && s === 0) {
                        return n < o ? -1 : n > o ? 1 : 0
                    }
                    if (!p && !q) {
                        if (r === s) {
                            return n < o ? -1 : n > o ? 1 : 0
                        }
                        return r < s ? -1 : r > s ? 1 : 0
                    }
                    if (p && !q) {
                        return 1
                    }
                    if (q && !p) {
                        return -1
                    }
                    if (p && q) {
                        return n < o ? -1 : n > o ? 1 : 0
                    }
                    return 0
                },
                GradedCount_invert: function(n, o) {
                    return -this.filters.GradedCount(n, o)
                }
            };
            this.assignmentlistview = new b.Vs.ListToggleView({
                leadSectionId: this.leadSectionId,
                sectionId: this.sectionId,
                canEdit: this.canEdit
            });
            p3.rV(this.assignmentlistview, this.Containers.LeftColumn, false);
            b.Data.types = new b.Cs.Types({}, {
                sectionId: this.leadSectionId
            });
            p3.rV(new b.Vs.AssignmentFilterView({
                collection: b.Data.types,
                sectionId: this.sectionId,
                leadSectionId: this.leadSectionId,
                assignments: b.Data.assignments,
                reports: this.reports,
                canEdit: this.canEdit,
                isOwner: this.isOwner
            }), this.Containers.RightColumn, false);
            b.Data.types.fetch({
                error: function() {
                    p3.displayError("Error loading assignment types")
                }
            })
        },
        assignmentAddWindow: function() {
            b.Us.AddAssignmentView().on("saveAssignment", function() {
                setTimeout(function() {
                    b.Us.updateAssignments(true)
                }, 500)
            });
            return false
        },
        showLtiConfigList: function(n) {
            d.Us.showLtiConfigList(0, n)
        },
        doSearchFix: function(n) {
            if ($("#assignmentSearchBox").val() === "") {
                b.Data.assignments.setSearchTerm("");
                if (p3.Data.LMS !== undefined && p3.Data.LMS.AssignmentFilters !== undefined) {
                    p3.Data.LMS.AssignmentFilters.SearchTerm = ""
                }
            }
        },
        doAssignmentSearch: function(n) {
            var o = $("#assignmentSearchBox").val();
            if (o !== undefined && o !== null) {
                b.Data.assignments.setSearchTerm(o);
                b.Us.updateAssignments();
                if (p3.Data.LMS !== undefined && p3.Data.LMS.AssignmentFilters !== undefined) {
                    p3.Data.LMS.AssignmentFilters.SearchTerm = o
                }
            }
            return false
        },
        doAssignmentSearchEnter: function(n) {
            if (n.keyCode === 13) {
                this.doAssignmentSearch(n);
                return false
            }
        },
        addAssessment: function(n) {
            var o = this;
            b.Us.AddAssessmentView().on("saveAssessment", function(q, r) {
                var p = new b.Ms.Assignment();
                p.set("AssignmentId", q);
                p.fetch({
                    error: function() {
                        p3.displayError("Error loading assignment")
                    },
                    success: function(u, v) {
                        var w = p.get("SectionLinks"),
                            s = 0,
                            t;
                        for (t = 0; t < w.length; t++) {
                            if (w[t].SectionId == o.sectionId) {
                                s = w[t].AssignmentIndexId;
                                break
                            }
                        }
                        p3.router().navigate("#assessmentedit/" + q + "/" + s + "/0", true)
                    }
                })
            });
            return false
        },
        addDiscussion: function(o) {
            var p = this,
                n = b.Us.AddDiscussionView();
            n.on("saveDiscussion", function(q, r) {
                b.Us.updateAssignments()
            });
            n.on("saveAddDiscussion", function(q, r) {
                b.Us.updateAssignments();
                p.addDiscussion()
            });
            return false
        }
    });
    b.Vs.ClassAssignmentStudentView = Bb.View.extend({
        template: "classassignment/classassignment.template.student.html",
        assignmentlistview: undefined,
        events: {
            "click #assignmentSearchButton": "doAssignmentSearch",
            "blur #assignmentSearchBox": "doSearchFix",
            "keypress #assignmentSearchBox": "doAssignmentSearchEnter",
            "click a.assignment-status-link": "doStatusChange"
        },
        initialize: function() {
            this.Containers = {};
            this.sectionId = this.options.sectionId || 0;
            b.Data.currentLeadSectionId = this.leadSectionId = this.options.leadSectionId || 0;
            b.Data.studentId = this.options.studentId;
            this.assginments = null;
            p3.Layout.Containers.Modal.on("shown", b.Us.showHtmlEditor)
        },
        dispose: function() {
            p3.Layout.Containers.Modal.off("shown", b.Us.showHtmlEditor);
            var n = tinyMCE.get("myeditor");
            if (n) {
                n.remove();
                n = null
            }
        },
        render: function(n) {
            var o = this;
            p3.fT(o.template, function(p) {
                o.$el.html(p({
                    leadSectionId: o.leadSectionId
                }));
                $(n).html(o.el);
                o.Containers.LeftColumn = $("#2col-wideleft");
                o.Containers.RightColumn = $("#2col-slimright");
                o.renderContent()
            })
        },
        renderContent: function() {
            b.Data.assignments = new b.Cs.Assignments({}, {
                dateSort: 1,
                assignTypes: null,
                startDate: null,
                endDate: null,
                sectionId: this.leadSectionId,
                studentId: b.Data.studentId
            });
            b.Data.assignments.filters = {
                _statusPrepHelper: function(n, o) {
                    var t = {
                            red: 0,
                            blue: 1,
                            orange: 2,
                            green: 3
                        },
                        u = n.get("AssignmentStatus"),
                        v = o.get("AssignmentStatus"),
                        p = "",
                        q = "",
                        r = -1,
                        s = -1;
                    switch (u) {
                        case -1:
                            if (n.get("AssessmentInd")) {
                                p = "Take";
                                r = t.blue
                            } else {
                                p = n.get("DropBoxInd") ? "Submit" : "To Do";
                                r = t.blue
                            }
                            break;
                        case 0:
                            p = "In&nbsp;Progress";
                            r = t.orange;
                            break;
                        case 1:
                            p = n.get("HasGrade") ? "Graded" : "Completed";
                            r = t.green;
                            break;
                        case 2:
                            p = "Overdue";
                            r = t.red;
                            break;
                        case 3:
                            p = "Retake";
                            r = t.blue;
                            break;
                        case 4:
                            p = "Graded";
                            r = t.green;
                            break
                    }
                    switch (v) {
                        case -1:
                            if (o.get("AssessmentInd")) {
                                q = "Take";
                                s = t.blue
                            } else {
                                q = o.get("DropBoxInd") ? "Submit" : "To Do";
                                s = t.blue
                            }
                            break;
                        case 0:
                            q = "In&nbsp;Progress";
                            s = t.orange;
                            break;
                        case 1:
                            q = o.get("HasGrade") ? "Graded" : "Completed";
                            s = t.green;
                            break;
                        case 2:
                            q = "Overdue";
                            s = t.red;
                            break;
                        case 3:
                            q = "Retake";
                            s = t.blue;
                            break;
                        case 4:
                            q = "Graded";
                            s = t.green;
                            break
                    }
                    return {
                        n1: p,
                        n2: q,
                        p1: r,
                        p2: s
                    }
                },
                AssignmentDescription: function(p, q) {
                    var n = p.get("AssignmentDescription") || "",
                        o = q.get("AssignmentDescription") || "";
                    return n < o ? -1 : n > o ? 1 : 0
                },
                AssignmentDescription_invert: function(p, q) {
                    var n = p.get("AssignmentDescription") || "",
                        o = q.get("AssignmentDescription") || "";
                    return n < o ? 1 : n > o ? -1 : 0
                },
                AssignmentType: function(p, q) {
                    var n = p.get("AssignmentType") || "",
                        o = q.get("AssignmentType") || "";
                    return n < o ? -1 : n > o ? 1 : 0
                },
                AssignmentType_invert: function(p, q) {
                    var n = p.get("AssignmentType") || "",
                        o = q.get("AssignmentType") || "";
                    return n < o ? 1 : n > o ? -1 : 0
                },
                DateAssigned: function(n) {
                    return n.get("DateAssigned") ? e.getDate(n.get("DateAssigned")).getTime() : 0
                },
                DateAssigned_invert: function(n) {
                    return n.get("DateAssigned") ? -e.getDate(n.get("DateAssigned")).getTime() : 0
                },
                DateDue: function(n) {
                    return n.get("DateDue") ? e.getDate(n.get("DateDue")).getTime() : 0
                },
                DateDue_invert: function(n) {
                    return n.get("DateDue") ? -e.getDate(n.get("DateDue")).getTime() : 0
                },
                AssignmentStatus: function(o, p) {
                    var n = (this.filters !== undefined) ? this.filters : this,
                        q = n._statusPrepHelper(o, p),
                        r;
                    if (q.p1 === q.p2) {
                        r = q.n1 < q.n2 ? -1 : q.n1 > q.n2 ? 1 : 0
                    } else {
                        r = q.p1 < q.p2 ? -1 : q.p1 > q.p2 ? 1 : 0
                    }
                    return r
                },
                AssignmentStatus_invert: function(n, o) {
                    return -this.filters.AssignmentStatus(n, o)
                }
            };
            this.assignmentlistview = new b.Vs.ListToggleView({
                leadSectionId: this.leadSectionId,
                sectionId: this.sectionId,
                canEdit: this.canEdit
            });
            p3.rV(this.assignmentlistview, this.Containers.LeftColumn, false);
            b.Data.assignments.fetch({
                error: function(n, o) {
                    p3.displayError("Error loading assignments")
                }
            });
            b.Data.types = new b.Cs.Types({}, {
                sectionId: this.leadSectionId
            });
            p3.rV(new b.Vs.AssignmentFilterStudentView({
                collection: b.Data.types,
                sectionId: this.sectionId,
                leadSectionId: this.leadSectionId,
                assignments: b.Data.assignments
            }), this.Containers.RightColumn, false);
            b.Data.types.fetch({
                error: function() {
                    p3.displayError("Error loading assignment types")
                }
            })
        },
        doSearchFix: function(n) {
            if ($("#assignmentSearchBox").val() === "") {
                b.Data.assignments.setSearchTerm("")
            }
        },
        doAssignmentSearch: function(n) {
            var o = $("#assignmentSearchBox").val();
            if (o != undefined && o != null) {
                b.Data.assignments.setSearchTerm(o);
                b.Us.updateAssignments()
            }
            return false
        },
        doAssignmentSearchEnter: function(n) {
            if (n.keyCode == 13) {
                this.doAssignmentSearch(n);
                n.stopPropagation()
            }
        },
        doStatusChange: function(q) {
            $(".btn-group.open").removeClass("open");
            var o = $(q.currentTarget),
                n = o.closest(".btn-group"),
                r = o.data("status"),
                s = n.data("status"),
                p, t;
            if (r != s) {
                p = n.data("indexid");
                t = new b.Ms.AssignmentStatusUpdate({
                    assignmentIndexId: p,
                    assignmentStatus: r
                });
                t.save({}, {
                    success: function() {
                        var u = "",
                            v;
                        switch (r) {
                            case -1:
                                if ($(q.currentTarget).text() == "Overdue") {
                                    u = "btn-danger"
                                }
                                break;
                            case 0:
                                u = "btn-warning";
                                break;
                            case 1:
                                u = "btn-success";
                                break
                        }
                        n.find(".assignment-status-button").removeClass("btn-warning").removeClass("btn-danger").removeClass("btn-success").addClass(u).html('<span class="caret"></span>&nbsp;' + $(q.currentTarget).text());
                        $(q.currentTarget).closest(".btn-group").data("status", r);
                        v = b.Data.assignments.find(function(w) {
                            return w.get("AssignmentIndexId") === p
                        });
                        if (v !== undefined) {
                            v.set("AssignmentStatus", r)
                        }
                    },
                    error: function() {
                        p3.displayError("Error updating assignment status")
                    }
                })
            }
            return false
        }
    });
    b.Vs.Attachments = Bb.View.extend({
        template: "ParentChild/assignment.attachments.template.html",
        className: "attachments",
        initialize: function() {
            this.collection.bind("reset change", this.renderTemplate, this);
            Hb.registerHelper("htmlTextDisplay", function(n) {
                if (n) {
                    return new Hb.SafeString(n)
                }
                return ""
            })
        },
        render: function(n) {
            $(n).append(this.el)
        },
        renderTemplate: function(n) {
            var o = this;
            p3.fT(o.template, function(q) {
                var p = _.groupBy(n.toJSON(), function(r) {
                    return r.type
                });
                _.each(p.Download, function(r) {
                    r.attachment = p3.Config.FtpImagePath + "download/" + r.attachment
                });
                o.$el.html(q({
                    attachmentsSorted: p
                }));
                o.$el.parent().slideToggle()
            })
        }
    });
    b.Vs.ListToggleView = Bb.View.extend({
        template: "classassignment/listtypetoggleview.template.html",
        events: {
            "click #list-type-toggle": "toggleList"
        },
        initialize: function() {
            if (p3.Data.LMS === undefined) {
                p3.Data.LMS = {}
            }
            this.activeView = p3.Data.LMS.listViewType || "byType";
            this.leadSectionId = this.options.leadSectionId;
            this.sectionId = this.options.sectionId;
            this.canEdit = this.options.canEdit
        },
        render: function(n) {
            $(n).append(this.el);
            this.renderTemplate()
        },
        renderTemplate: function() {
            var o = this,
                n = p3.Data.Context.getSelectedPersona().Id;
            p3.fT(o.template, function(p) {
                o.$el.html(p({}));
                o.$listContainer = $("#list-container");
                if (o.activeView === "byType") {
                    if (n === 3 || n === 5) {
                        p3.rV(new b.Vs.AssignmentListView({
                            collection: b.Data.assignments,
                            leadSectionId: o.leadSectionId,
                            sectionId: o.sectionId,
                            canEdit: o.canEdit
                        }), o.$listContainer, true)
                    } else {
                        p3.rV(new b.Vs.AssignmentListStudentView({
                            collection: b.Data.assignments,
                            leadSectionId: o.leadSectionId,
                            sectionId: o.sectionId
                        }), o.$listContainer, true)
                    }
                } else {
                    p3.rV(new b.Vs.SortedListView({
                        collection: b.Data.assignments,
                        leadSectionId: o.leadSectionId,
                        sectionId: o.sectionId,
                        canEdit: o.canEdit
                    }), o.$listContainer, true);
                    $("#list-type-toggle button").removeClass("active");
                    $($("#list-type-toggle button")[1]).addClass("active")
                }
            })
        },
        toggleList: function(p) {
            var r = this,
                o = $(p.target),
                n = $("#list-type-toggle button"),
                s = o.data("toggle"),
                q = p3.Data.Context.getSelectedPersona().Id;
            if (o[0].tagName.toLowerCase() === "button") {
                if (s != this.activeView) {
                    n.removeClass("active");
                    o.addClass("active");
                    if (s === "byType") {
                        if (q === 3 || q === 5) {
                            p3.rV(new b.Vs.AssignmentListView({
                                collection: b.Data.assignments,
                                leadSectionId: r.leadSectionId,
                                sectionId: r.sectionId,
                                canEdit: r.canEdit
                            }), r.$listContainer, true)
                        } else {
                            p3.rV(new b.Vs.AssignmentListStudentView({
                                collection: b.Data.assignments,
                                leadSectionId: r.leadSectionId,
                                sectionId: r.sectionId
                            }), r.$listContainer, true)
                        }
                        b.Data.assignments.trigger("reset")
                    } else {
                        p3.rV(new b.Vs.SortedListView({
                            collection: b.Data.assignments,
                            leadSectionId: this.leadSectionId,
                            sectionId: this.sectionId,
                            canEdit: this.canEdit
                        }), this.$listContainer, true);
                        if (b._renderListTimer) {
                            window.clearInterval(b._renderListTimer);
                            b._renderListTimer = undefined
                        }
                        b._renderListTimer = window.setInterval(function() {
                            if ($("#sorted-assignment-items").length > 0) {
                                b.Data.assignments.trigger("reset");
                                window.clearInterval(b._renderListTimer);
                                b._renderListTimer = undefined
                            }
                        }, 100)
                    }
                    p3.Data.LMS.listViewType = s;
                    this.activeView = s
                }
            }
            p.stopPropagation()
        }
    });
    b.Vs.SortedListView = Bb.View.extend({
        template: "classassignment/sortedlistview.template.html",
        events: {
            "click .assignment-table-sort": "updateFilter",
            "click .assignment-list-edit-button": "doAssignmentEdit",
            "click .assignment-list-delete-button": "doAssignmentDelete",
            "change .assignment-list-publish-selector": "doAssignmentPublish",
            "click .assignment-list-copy-button": "doAssignmentCopy"
        },
        initialize: function() {
            if (p3.Data.LMS === undefined) {
                p3.Data.LMS = {}
            }
            this.sortDir = -1;
            this.sortField = "";
            if (p3.Data.LMS.sortViewField !== undefined) {
                if (p3.Data.LMS.sortViewField.indexOf("_") > 0) {
                    this.sortDir = 1;
                    this.sortField = p3.Data.LMS.sortViewField.substring(0, p3.Data.LMS.sortViewField.indexOf("_"))
                }
            } else {
                this.sortField = "DateDue"
            }
            this.collection.comparator = this.collection.filters[p3.Data.LMS.sortViewField || "DateDue"];
            this.collection.sort();
            this.collection.on("reset", this.renderItems, this);
            this.collection.on("sort", this.renderItems, this)
        },
        dispose: function() {
            this.collection.off("reset", this.renderItems);
            this.collection.off("sort", this.renderItems)
        },
        render: function(n) {
            $(n).append(this.el);
            this.renderTemplate()
        },
        renderTemplate: function() {
            var p = this,
                o = p3.Data.Context.getSelectedPersona().Id,
                n = [];
            switch (o) {
                case 1:
                    n.push({
                        title: "Title",
                        field: "AssignmentDescription"
                    });
                    n.push({
                        title: "Type",
                        field: "AssignmentType",
                        classes: "assignment-list-item-type"
                    });
                    n.push({
                        title: "Assigned",
                        field: "DateAssigned",
                        classes: "assignment-list-item-dates"
                    });
                    n.push({
                        title: "Due",
                        field: "DateDue",
                        classes: "assignment-list-item-dates"
                    });
                    n.push({
                        title: "",
                        field: "",
                        classes: ""
                    });
                    break;
                case 2:
                    n.push({
                        title: "Title",
                        field: "AssignmentDescription"
                    });
                    n.push({
                        title: "Type",
                        field: "AssignmentType",
                        classes: "assignment-list-item-type"
                    });
                    n.push({
                        title: "Assigned",
                        field: "DateAssigned",
                        classes: "assignment-list-item-dates"
                    });
                    n.push({
                        title: "Due",
                        field: "DateDue",
                        classes: "assignment-list-item-dates"
                    });
                    n.push({
                        title: "Status",
                        field: "AssignmentStatus",
                        classes: ""
                    });
                    break;
                case 3:
                case 5:
                    n.push({
                        title: "Title",
                        field: "AssignmentDescription"
                    });
                    n.push({
                        title: "Type",
                        field: "AssignmentType",
                        classes: "assignment-list-item-type"
                    });
                    n.push({
                        title: "Assigned",
                        field: "DateAssigned",
                        classes: "assignment-list-item-dates"
                    });
                    n.push({
                        title: "Due",
                        field: "DateDue",
                        classes: "assignment-list-item-dates"
                    });
                    n.push({
                        title: "Publish",
                        field: "Publish",
                        classes: "assignment-list-item-publish"
                    });
                    if (p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADEBOOK)) {
                        n.push({
                            title: "Graded",
                            field: "GradedCount",
                            classes: "assignment-list-item-graded"
                        })
                    }
                    n.push({
                        title: "",
                        field: "",
                        classes: "assignment-list-item-controls"
                    });
                    break;
                default:
                    break
            }
            p3.fT(p.template, function(q) {
                p.$el.html(q({
                    columns: n
                }));
                $('a[data-sort="' + p.sortField + '"]').removeClass("muted").addClass("sort-active");
                $('a[data-sort="' + p.sortField + '"] i').removeClass("p3icon-sortOff").addClass(p.sortDir > 0 ? "p3icon-sortUp" : "p3icon-sortDown")
            })
        },
        renderItems: function() {
            var o = this,
                n = $("#sorted-assignment-items");
            n.html("");
            this.collection.each(function(p) {
                var s = {},
                    r = p3.Data.Context.getSelectedPersona().Id;
                if (p.get("GradedCount") === 0) {
                    s.btnStyle = "important"
                } else {
                    if (p.get("GradedCount") < p.get("NumEnrolled")) {
                        s.btnStyle = "warning"
                    } else {
                        s.btnStyle = "success"
                    }
                }
                if ((p.get("AssignmentLongDescription") !== undefined && p.get("AssignmentLongDescription") !== null && p.get("AssignmentLongDescription").length > 0) || p.get("HasLinks") || p.get("") || p.get("DropBoxInd") || (p.get("GradeBookInd") && (r == 3 || r == 5)) || (p.get("GradeBookInd") && p.get("PublishGrade") && r < 3)) {
                    s.showDetail = true
                }
                if (o.options.studentId) {
                    s.studentId = o.options.studentId
                }
                var q = new b.Vs.SortedItemView({
                    model: p,
                    options: s,
                    canEdit: o.options.canEdit
                });
                p3.rV(q, n, false)
            })
        },
        doAssignmentEdit: function(p) {
            var q = $(p.currentTarget).data("assignmentId"),
                r = ($(p.currentTarget).data("assessment") == 1),
                s = ($(p.currentTarget).data("discussion") == 1),
                t = this;
            if (r) {
                p3.router().navigate("#assessmentedit/" + q + "/" + $(p.currentTarget).data("index") + "/" + $(p.currentTarget).data("locked"), true)
            } else {
                if (s) {
                    var n = new b.Ms.Assignment();
                    n.set("AssignmentId", q);
                    n.fetch({
                        async: false,
                        error: function() {
                            p3.displayError("Error loading assignment")
                        },
                        success: function(v, w) {
                            var u = b.Us.AddDiscussionView(n, 0);
                            u.on("saveDiscussion", function() {
                                setTimeout(function() {
                                    t.collection.fetch()
                                }, 500)
                            })
                        }
                    })
                } else {
                    var o = b.Us.EditAssignmentView(q);
                    if (o !== undefined && o !== null) {
                        o.on("saveAssignment", function() {
                            setTimeout(function() {
                                t.collection.fetch()
                            }, 500)
                        }).on("deleteAssignment", function() {
                            setTimeout(function() {
                                t.collection.fetch()
                            }, 500)
                        })
                    }
                }
            }
            return false
        },
        doAssignmentCopy: function(p) {
            var n = $(p.currentTarget).data("assignmentId"),
                q = this;
            var o = b.Us.AddAssessmentView(undefined, n);
            if (o !== undefined) {
                o.on("saveAssessment", function(r, s) {
                    setTimeout(function() {
                        q.collection.fetch()
                    }, 500)
                });
                o.on("saveEditAssessment", function(s, t) {
                    var r = new b.Ms.Assignment();
                    r.set("AssignmentId", s);
                    r.fetch({
                        error: function() {
                            p3.displayError("Error loading assignment")
                        },
                        success: function(u, v) {
                            p3.router().navigate("#assessmentedit/" + s + "/" + r.get("SectionLinks")[0].AssignmentIndexId + "/0", true)
                        }
                    })
                })
            }
            return false
        },
        doAssignmentDelete: function(o) {
            var p = $(o.currentTarget).data("assignmentId"),
                q = ($(o.currentTarget).data("assessment") == 1),
                s = this;
            var r = new b.Cs.SectionForAssignments({}, {
                assignmentId: p
            });
            var n = new b.Vs.DeleteAssignmentModalView({
                collection: r,
                assignmentId: p,
                isAssessment: q
            });
            p3.rV(n, p3.Layout.Containers.Modal, true);
            n.on("assignmentDeleted", function() {
                s.collection.fetch()
            });
            p3.showModal(p3.Layout.Containers.Modal);
            r.fetch({
                error: function() {
                    p3.displayError("Error loading Sections associated with the assignment")
                }
            });
            return false
        },
        doAssignmentPublish: function(q) {
            var s = this,
                n = $(q.target).data("assignmentId"),
                o = $(q.target).data("aiid"),
                r = $(q.target).val();
            var p = new b.Ms.Assignment();
            p.set("AssignmentId", n);
            p.fetch({
                error: function() {
                    p3.displayError("Error loading assignment")
                },
                success: function(u, w) {
                    var x = u.get("SectionLinks");
                    if (x.length > 1) {
                        var t = new b.Vs.PublishChangeConfirmation({
                            Sections: x,
                            PublishOpt: r,
                            LeadSectionId: s.options.leadSectionId,
                            SectionId: s.options.sectionId,
                            target: $(q.target)
                        });
                        p3.rV(t, p3.Layout.Containers.Modal, true);
                        p3.showModal(p3.Layout.Containers.Modal);
                        $(p3.Layout.Containers.Modal).on("hide", t.resetDefault)
                    } else {
                        var v = new b.Ms.PublishAssignment();
                        v.fetch({
                            data: {
                                assignmentIndexId: o,
                                publishInd: r
                            },
                            success: function() {
                                s.collection.fetch()
                            },
                            error: function() {
                                s.collection.fetch()
                            }
                        })
                    }
                }
            })
        },
        updateFilter: function(o) {
            var q = this;
            var n = $(o.currentTarget);
            var p = n.data("sort");
            $(".sort-icon").removeClass("p3icon-sortDown p3icon-sortUp p3icon-sortOff").addClass("p3icon-sortOff");
            $(".assignment-table-sort").removeClass("sort-active").addClass("muted");
            if (p !== undefined) {
                if (q.CurrentSort === p) {
                    p = p + "_invert";
                    n.removeClass("muted").addClass("sort-active");
                    n.children("i").removeClass("p3icon-sortOff").addClass("p3icon-sortUp")
                } else {
                    n.removeClass("muted").addClass("sort-active");
                    n.children("i").removeClass("p3icon-sortOff").addClass("p3icon-sortDown")
                }
                q.CurrentSort = p;
                b.Data.assignments.changeSort(p);
                b.Data.assignments.sort();
                if (p3.Data.LMS === undefined) {
                    p3.Data.LMS = {}
                }
                p3.Data.LMS.sortViewField = p
            }
            return false
        }
    });
    b.Vs.SortedItemView = Bb.View.extend({
        template: "classassignment/sorteditemview.template.html",
        studentTemplate: "classassignment/sortedstudentitemview.template.html",
        tagName: "tr",
        events: {},
        initialize: function(n) {
            this.model = n.model;
            this.viewOptions = n.options || {}
        },
        render: function(n) {
            var r = this,
                o = p3.Data.LMS !== undefined && p3.Data.LMS.AssignmentFilters !== undefined && p3.Data.LMS.AssignmentFilters.onlyDropbox !== undefined && p3.Data.LMS.AssignmentFilters.onlyDropbox === true,
                q = p3.Data.Context.getSelectedPersona().Id;
            $(n).append(r.el);
            if (r.model !== undefined && (!o || (o && r.model.get("DropBoxInd") === true))) {
                var p = "";
                if (r.model.get("AssessmentInd")) {
                    if (r.model.get("AssessmentId") > 0 && (q == 3 || q == 5)) {
                        p += '<a href="#assessmentsectiondetail/' + r.model.get("AssignmentId") + "/" + r.model.get("AssignmentIndexId") + '/0">' + r.model.get("AssignmentDescription") + "</a>"
                    } else {
                        p += '<p class="assignment-list-text">' + r.model.get("AssignmentDescription") + "</p>"
                    }
                } else {
                    if (r.model.get("DiscussionInd")) {
                        if (q == 3 || q == 5) {
                            p += '<a href="#discussionsectiondetail/' + r.model.get("AssignmentId") + "/" + r.model.get("AssignmentIndexId") + '/0">' + r.model.get("AssignmentDescription") + "</a>"
                        } else {
                            if (q == 2) {
                                p += '<a href="#discussiondetail/' + r.model.get("AssignmentId") + "/" + r.model.get("AssignmentIndexId") + '">' + r.model.get("AssignmentDescription") + "</a>"
                            }
                        }
                    } else {
                        if (r.model.get("AssignmentLongDescription").length > 0 || r.model.get("HasLinks") || r.model.get("HasDownloads") || (r.model.get("LtiInd") && (q == 2 || q == 3)) || r.model.get("DropBoxInd") || (r.model.get("GradeBookInd") && (q == 3 || q == 5))) {
                            if (q == 1) {
                                p += '<a href="' + d.Us.BuildAssignmentDetailLink(r.model.get("AssignmentId"), r.model.get("AssignmentIndexId"), a.Data.studentId, 0) + '">'
                            } else {
                                p += '<a href="' + d.Us.BuildAssignmentDetailLink(r.model.get("AssignmentId"), r.model.get("AssignmentIndexId"), null, 0) + '">'
                            }
                            p += r.model.get("AssignmentDescription") + "</a>"
                        } else {
                            p += '<p class="assignment-list-text">' + r.model.get("AssignmentDescription") + "</p>"
                        }
                    }
                }
                r.model.set("linkItem", p)
            }
            p3.fT((q === 3 || q === 5) ? r.template : r.studentTemplate, function(s) {
                r.$el.append(s({
                    model: r.model.toJSON(),
                    options: r.viewOptions,
                    hasGradebook: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADEBOOK),
                    canEdit: r.options.canEdit
                }))
            })
        }
    });
    b.Vs.AssignmentListView = Bb.View.extend({
        template: "classassignment/assignmentlistview.template.html",
        itemTemplate: "classassignment/assignmentlistview.item.template.html",
        className: "ch",
        sortType: "assignmentType",
        events: {
            "click .slide": "slideContent",
            "click .assignment-list-edit-button": "doAssignmentEdit",
            "click .assignment-list-delete-button": "doAssignmentDelete",
            "click a.toggle-detail": "showDetail",
            "click .assignment-table-button": "doShowMoreAssignments",
            "change .assignment-list-publish-selector": "doAssignmentPublish",
            "focus .assignment-list-publish-selector": "doAssignmnetPublishFocus",
            "updateAssignments #assignmentview": "updateAssignments",
            "click .assignment-list-copy-button": "doAssignmentCopy"
        },
        renderTemplate: function() {
            var n = this;
            p3.fT(n.template, function(A) {
                var C = [],
                    r = p3.Data.LMS !== undefined && p3.Data.LMS.AssignmentFilters !== undefined && p3.Data.LMS.AssignmentFilters.onlyDropbox !== undefined && p3.Data.LMS.AssignmentFilters.onlyDropbox === true,
                    y = p3.Data.Context.getSelectedPersona().Id,
                    s, v, p;
                if (n.sortType) {
                    switch (n.sortType) {
                        case "assignmentType":
                            var q = n.collection.pluck("AssignmentType"),
                                B = _.uniq(q),
                                t, w, o, z, u, x;
                            if (q[0] !== undefined && B.length) {
                                for (s = 0, w = B.length; s < w; s++) {
                                    o = b.Us.GetAssignmentsByType(n.collection, B[s]);
                                    z = [];
                                    for (t = 0; t < o.length; t++) {
                                        u = o[t];
                                        if ((u !== undefined) && (!r || (r && u.get("DropBoxInd") === true))) {
                                            x = "";
                                            if (u.get("AssessmentInd")) {
                                                if (u.get("AssessmentId") > 0 && (y == 3 || y == 5)) {
                                                    x += '<a href="#assessmentsectiondetail/' + u.get("AssignmentId") + "/" + u.get("AssignmentIndexId") + '/0">' + u.get("AssignmentDescription") + "</a>"
                                                } else {
                                                    x += '<p class="assignment-list-text">' + u.get("AssignmentDescription") + "</p>"
                                                }
                                            } else {
                                                if (u.get("DiscussionInd")) {
                                                    if (y == 3 || y == 5) {
                                                        x += '<a href="#discussionsectiondetail/' + u.get("AssignmentId") + "/" + u.get("AssignmentIndexId") + '/0">' + u.get("AssignmentDescription") + "</a>"
                                                    } else {
                                                        x += '<p class="assignment-list-text">' + u.get("AssignmentDescription") + "</p>"
                                                    }
                                                } else {
                                                    if (u.get("AssignmentLongDescription").length > 0 || u.get("HasLinks") || u.get("HasDownloads") || u.get("DropBoxInd") || (u.get("LtiInd") && (y == 2 || y == 3)) || (u.get("GradeBookInd") && (y == 3 || y == 5))) {
                                                        if (y == 1) {
                                                            x += '<a href="' + d.Us.BuildAssignmentDetailLink(u.get("AssignmentId"), u.get("AssignmentIndexId"), a.Data.studentId, 0) + '">'
                                                        } else {
                                                            x += '<a href="' + d.Us.BuildAssignmentDetailLink(u.get("AssignmentId"), u.get("AssignmentIndexId"), null, 0) + '">'
                                                        }
                                                        x += u.get("AssignmentDescription") + "</a>"
                                                    } else {
                                                        x += '<p class="assignment-list-text">' + u.get("AssignmentDescription") + "</p>"
                                                    }
                                                }
                                            }
                                            u.set("linkItem", x);
                                            z.push(u.toJSON())
                                        }
                                    }
                                    if (z.length > 0) {
                                        C.push({
                                            heading: B[s],
                                            id: (z.length > 0 ? z[0].AssignmentTypeId : -1),
                                            major: false,
                                            assignments: z
                                        })
                                    }
                                }
                            }
                            break;
                        default:
                            break
                    }
                } else {
                    C = n.collection.toJSON()
                }
                if (C.length === 0) {
                    if ($("#assignmentSearchBox").val() !== "") {
                        n.$el.html("<h5>Your search did not return any results.</h5>")
                    } else {
                        if (b.Data.assignments.dateSort == null && (b.Data.assignments.startDate == null || b.Data.assignments.endDate == null)) {
                            n.$el.html("<h5>Enter date range to view assignments.</h5>")
                        } else {
                            n.$el.html("<h5>There are no assignments to display.</h5>")
                        }
                    }
                } else {
                    for (s = 0; s < C.length; s++) {
                        p = C[s];
                        for (v = 0; v < p.assignments.length; v++) {
                            if (p.assignments[v].GradedCount === 0) {
                                p.assignments[v].btnStyle = "important"
                            } else {
                                if (p.assignments[v].GradedCount < p.assignments[v].NumEnrolled) {
                                    p.assignments[v].btnStyle = "warning"
                                } else {
                                    p.assignments[v].btnStyle = "success"
                                }
                            }
                        }
                    }
                    n.$el.html(A({
                        leadSectionId: n.options.leadSectionId,
                        sortedItems: C,
                        hasGradebook: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADEBOOK),
                        canEdit: n.options.canEdit
                    }));
                    n.renderItems(C)
                }
            })
        },
        renderItems: function(n) {
            if (n === undefined || n.length < 0) {
                return
            }
            var o = this;
            _.each(n, function(t) {
                var u = t.id + "-list-table",
                    r = (t.id !== "" ? (t.id + "-more-button") : "no-more-button"),
                    q = $("#" + u).children("tbody"),
                    p = $("#" + r),
                    s = 1;
                _.each(t.assignments, function(v) {
                    p3.fT(o.itemTemplate, function(w) {
                        q.append(w({
                            assignment: v,
                            hasGradebook: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADEBOOK),
                            canEdit: o.options.canEdit,
                            userId: p3.Data.Context.get("UserInfo").UserId,
                            facultyInd: (p3.Data.Context.getSelectedPersona().Id === g.AppPersona.FACULTY.Value)
                        }));
                        if (s > 10) {
                            q.children("tr:last").hide()
                        }
                        s++
                    })
                });
                if (t.assignments.length > 10) {
                    p.show()
                }
            })
        },
        renderSearch: function(n) {
            var o = this;
            p3.fT(o.template, function(p) {
                o.$el.html(p({
                    leadSectionId: o.options.leadSectionId,
                    assignmentTypes: n,
                    hasGradebook: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADEBOOK),
                    canEdit: o.options.canEdit
                }))
            })
        },
        initialize: function() {
            this.collection.comparator = undefined;
            this.collection.on("reset", this.renderTemplate, this);
            p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.jQueryUI, function() {
                p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.FileUpload, function() {
                    return false
                })
            })
        },
        dispose: function() {
            this.collection.off("reset", this.renderTemplate)
        },
        render: function(n) {
            b.Us.registerHelpers();
            $(n).append(this.el)
        },
        slideContent: function(n) {
            var o = $(n.target);
            p3.slideContent(o)
        },
        showButtons: function(o) {
            var n = $(o.currentTarget).find("a.btn"),
                p, q;
            for (p = 0, q = n.length; p < q; p++) {
                $(n[p]).show()
            }
        },
        hideButtons: function(o) {
            var n = $(o.currentTarget).find("a.btn"),
                p, q;
            for (p = 0, q = n.length; p < q; p++) {
                $(n[p]).hide()
            }
        },
        doAssignmentEdit: function(p) {
            var q = $(p.currentTarget).data("assignmentId"),
                r = ($(p.currentTarget).data("assessment") == 1),
                s = ($(p.currentTarget).data("discussion") == 1);
            if (r) {
                p3.router().navigate("#assessmentedit/" + q + "/" + $(p.currentTarget).data("indexId") + "/" + $(p.currentTarget).data("locked"), true)
            } else {
                if (s) {
                    var n = new b.Ms.Assignment();
                    n.set("AssignmentId", q);
                    n.fetch({
                        async: false,
                        error: function() {
                            p3.displayError("Error loading assignment")
                        },
                        success: function(u, v) {
                            var t = b.Us.AddDiscussionView(n, 0);
                            t.on("saveDiscussion", function() {
                                setTimeout(function() {
                                    b.Us.updateAssignments()
                                }, 500)
                            })
                        }
                    })
                } else {
                    var o = b.Us.EditAssignmentView(q);
                    if (o !== undefined) {
                        o.on("saveAssignment", function() {
                            setTimeout(function() {
                                b.Us.updateAssignments()
                            }, 500)
                        }).on("deleteAssignment", function() {
                            setTimeout(function() {
                                b.Us.updateAssignments()
                            }, 500)
                        })
                    }
                }
            }
            return false
        },
        doAssignmentCopy: function(p) {
            var n = $(p.currentTarget).data("assignmentId"),
                o = b.Us.AddAssessmentView(undefined, n);
            if (o !== undefined) {
                o.on("saveAssessment", function(q, r) {
                    setTimeout(function() {
                        b.Us.updateAssignments()
                    }, 500)
                });
                o.on("saveEditAssessment", function(r, s) {
                    var q = new b.Ms.Assignment();
                    q.set("AssignmentId", r);
                    q.fetch({
                        error: function() {
                            p3.displayError("Error loading assignment")
                        },
                        success: function(t, u) {
                            p3.router().navigate("#assessmentedit/" + r + "/" + q.get("SectionLinks")[0].AssignmentIndexId + "/0", true)
                        }
                    })
                })
            }
            return false
        },
        doAssignmentDelete: function(n) {
            var o = $(n.currentTarget).data("assignmentId"),
                p = ($(n.currentTarget).data("assessment") == 1);
            var q = new b.Cs.SectionForAssignments({}, {
                assignmentId: o
            });
            var r = new b.Vs.DeleteAssignmentModalView({
                collection: q,
                assignmentId: o,
                isAssessment: p
            }).on("assignmentDeleted", function() {
                b.Us.updateAssignments()
            });
            p3.rV(r, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            q.fetch({
                error: function() {
                    p3.displayError("Error loading Sections associated with the assignment")
                }
            });
            return false
        },
        showDetail: function(o) {
            if ($(o.target).closest("td").has(".attachments").length) {
                $(o.target).closest("td").find(".detail").slideToggle()
            } else {
                var p = $(o.target).data("assignmentId");
                if (p === undefined) {
                    p = $(o.target).closest("a").data("assignmentId")
                }
                var n = new b.Cs.Attachments();
                p3.rV(new b.Vs.Attachments({
                    collection: n
                }), $(o.target).parents("td").find(".detail"), false);
                n.fetch({
                    data: {
                        assignmentId: p
                    },
                    error: function() {
                        p3.displayError("Error loading attachments")
                    }
                })
            }
            return false
        },
        doAssignmnetPublishFocus: function(n) {
            $(n.target).data("lastValue", $(n.target).val())
        },
        doAssignmentPublish: function(q) {
            var s = this,
                n = $(q.target).data("assignmentId"),
                o = $(q.target).data("aiid"),
                r = $(q.target).val();
            var p = new b.Ms.Assignment();
            p.set("AssignmentId", n);
            p.fetch({
                error: function() {
                    p3.displayError("Error loading assignment")
                },
                success: function(u, w) {
                    var x = u.get("SectionLinks");
                    if (x.length > 1) {
                        var t = new b.Vs.PublishChangeConfirmation({
                            Sections: x,
                            PublishOpt: r,
                            LeadSectionId: s.options.leadSectionId,
                            SectionId: s.options.sectionId,
                            target: $(q.target)
                        });
                        p3.rV(t, p3.Layout.Containers.Modal, true);
                        p3.showModal(p3.Layout.Containers.Modal);
                        $(p3.Layout.Containers.Modal).on("hide", t.resetDefault)
                    } else {
                        var v = new b.Ms.PublishAssignment();
                        v.fetch({
                            data: {
                                assignmentIndexId: o,
                                publishInd: r
                            },
                            success: function(y, z) {
                                s.collection.fetch()
                            }
                        })
                    }
                }
            })
        },
        doShowMoreAssignments: function(o) {
            o.preventDefault();
            var n = $(o.currentTarget),
                s = $(n.prev("table")[0]),
                p = s.children("tbody").children("tr:hidden"),
                q, r;
            if (p.length < 11) {
                n.hide()
            }
            for (q = 0, r = p.length; q < r && q < 10; q++) {
                $(p[q]).show()
            }
            return false
        },
        updateAssignments: function() {
            b.Us.updateAssignments(true)
        }
    });
    b.Vs.AssignmentListStudentView = Bb.View.extend({
        template: "classassignment/assignmentlistview.template.student.html",
        className: "ch",
        sortType: "assignmentType",
        events: {
            "click .slide": "slideContent",
            "click .assignment-list-edit-button": "doAssignmentEdit",
            "click .assignment-list-delete-button": "doAssignmentDelete",
            "click a.toggle-detail": "showDetail",
            "change .assignment-list-publish-selector": "doAssignmentPublish",
            "focus .assignment-list-publish-selector": "doAssignmnetPublishFocus",
            "click .assignment-table-button": "doShowMoreAssignments",
            "click a.assignment-status-link": "doStatusChange"
        },
        renderTemplate: function() {
            var n = this;
            p3.fT(n.template, function(u) {
                var w = [];
                if (n.sortType) {
                    switch (n.sortType) {
                        case "assignmentType":
                            var p = n.collection.pluck("AssignmentType"),
                                v = _.uniq(p),
                                q, s, o, r, t;
                            if (p[0] !== undefined && v.length) {
                                for (q = 0, s = v.length; q < s; q++) {
                                    o = b.Us.GetAssignmentsByType(n.collection, v[q]);
                                    t = [];
                                    for (r = 0; r < o.length; r++) {
                                        if (o[r] !== undefined) {
                                            t.push(o[r].toJSON())
                                        }
                                    }
                                    w.push({
                                        heading: v[q],
                                        major: false,
                                        assignments: t
                                    })
                                }
                            }
                            break;
                        default:
                            break
                    }
                } else {
                    w = n.collection.toJSON()
                }
                if (w.length === 0) {
                    if ($("#assignmentSearchBox").val() !== "") {
                        n.$el.html("<h5>Your search did not return any results.</h5>")
                    } else {
                        if (b.Data.assignments.dateSort == null && (b.Data.assignments.startDate == null || b.Data.assignments.endDate == null)) {
                            n.$el.html("<h5>Enter date range to view assignments.</h5>")
                        } else {
                            n.$el.html("<h5>There are no assignments to display.</h5>")
                        }
                    }
                } else {
                    n.$el.html(u({
                        leadSectionId: n.options.leadSectionId,
                        sortedItems: w,
                        hasDropbox: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.ASSIGNMENTDROPBOX),
                        showStatus: p3.Data.Context.getSelectedPersona().Id === 2
                    }))
                }
            })
        },
        renderSearch: function(n) {
            var o = this;
            p3.fT(o.template, function(p) {
                o.$el.html(p({
                    leadSectionId: o.options.leadSectionId,
                    assignmentTypes: n,
                    hasDropbox: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.ASSIGNMENTDROPBOX),
                    showStatus: p3.Data.Context.getSelectedPersona().Id === 2
                }))
            })
        },
        initialize: function() {
            this.collection.bind("reset change", this.renderTemplate, this);
            p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.jQueryUI, function() {
                p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.FileUpload, function() {
                    return false
                })
            })
        },
        render: function(n) {
            b.Us.registerHelpers();
            $(n).append(this.el);
            b.Us.updateAssignments()
        },
        slideContent: function(n) {
            var o = $(n.target);
            p3.slideContent(o)
        },
        showButtons: function(o) {
            var n = $(o.currentTarget).find("a.btn"),
                p, q;
            for (p = 0, q = n.length; p < q; p++) {
                $(n[p]).show()
            }
        },
        hideButtons: function(o) {
            var n = $(o.currentTarget).find("a.btn"),
                p, q;
            for (p = 0, q = n.length; p < q; p++) {
                $(n[p]).hide()
            }
        },
        doAssignmentEdit: function(n) {
            var o = $(n.currentTarget).data("assignmentId");
            b.Us.EditAssignmentView(o, {
                event: "saveAssignment",
                execute: function() {
                    setTimeout(function() {
                        b.Us.updateAssignments()
                    }, 500)
                }
            });
            return false
        },
        doAssignmentDelete: function(n) {
            var o = $(n.currentTarget).data("assignmentId"),
                p = new b.Cs.SectionForAssignments({}, {
                    assignmentId: o
                }),
                q = new b.Vs.DeleteAssignmentModalView({
                    collection: p,
                    assignmentId: o
                }).on("assignmentDeleted", function() {
                    b.Us.updateAssignments()
                });
            p3.rV(q, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            p.fetch({
                error: function() {
                    p3.displayError("Error loading Sections associated with the assignment")
                }
            });
            return false
        },
        showDetail: function(o) {
            if ($(o.target).closest("td").has(".attachments").length) {
                $(o.target).closest("td").find(".detail").slideToggle()
            } else {
                var p = $(o.target).data("assignmentId");
                if (p === undefined) {
                    p = $(o.target).closest("a").data("assignmentId")
                }
                var n = new b.Cs.Attachments();
                p3.rV(new b.Vs.Attachments({
                    collection: n
                }), $(o.target).parents("td").find(".detail"), false);
                n.fetch({
                    data: {
                        assignmentId: p
                    },
                    error: function() {
                        p3.displayError("Error loading attachments")
                    }
                })
            }
            return false
        },
        doAssignmnetPublishFocus: function(n) {
            $(n.target).data("lastValue", $(n.target).val())
        },
        doAssignmentPublish: function(q) {
            var s = this,
                n = $(q.target).data("assignmentId"),
                o = $(q.target).data("aiid"),
                r = $(q.target).val();
            var p = new b.Ms.Assignment();
            p.set("AssignmentId", n);
            p.fetch({
                error: function() {
                    p3.displayError("Error loading assignment")
                },
                success: function(u, w) {
                    var x = u.get("SectionLinks");
                    if (x.length > 1) {
                        var t = new b.Vs.PublishChangeConfirmation({
                            Sections: x,
                            PublishOpt: r,
                            LeadSectionId: s.options.leadSectionId,
                            SectionId: s.options.sectionId,
                            target: $(q.target)
                        });
                        p3.rV(t, p3.Layout.Containers.Modal, true);
                        p3.showModal(p3.Layout.Containers.Modal);
                        $(p3.Layout.Containers.Modal).on("hide", t.resetDefault)
                    } else {
                        var v = new b.Ms.PublishAssignment();
                        v.fetch({
                            data: {
                                assignmentIndexId: o,
                                publishInd: r
                            }
                        })
                    }
                }
            })
        },
        doStatusChange: function(q) {
            $(".btn-group.open").removeClass("open");
            var o = $(q.currentTarget),
                n = o.closest(".btn-group"),
                r = o.data("status"),
                s = n.data("status");
            if (s == 2 && r == -1) {
                s = -1
            }
            if (r != s) {
                var p = n.data("indexid");
                var t = new b.Ms.AssignmentStatusUpdate({
                    assignmentIndexId: p,
                    assignmentStatus: r
                });
                t.save({}, {
                    success: function(u, w) {
                        var v = "";
                        switch (r) {
                            case -1:
                                if ($(q.currentTarget).text() == "Overdue") {
                                    v = "btn-danger"
                                }
                                break;
                            case 0:
                                v = "btn-warning";
                                break;
                            case 1:
                                v = "btn-success";
                                break
                        }
                        n.find(".assignment-status-button").removeClass("btn-warning").removeClass("btn-danger").removeClass("btn-success").addClass(v).html('<span class="caret"></span>&nbsp;' + $(q.currentTarget).text());
                        $(q.currentTarget).closest(".btn-group").data("status", r)
                    },
                    error: function(u, v) {
                        p3.displayError("Error updating assignment status")
                    }
                })
            }
            return false
        },
        doShowMoreAssignments: function(o) {
            o.preventDefault();
            var n = $(o.currentTarget),
                s = $(n.prev("table")[0]),
                p = s.children("tbody").children("tr:hidden"),
                q, r;
            if (p.length < 11) {
                n.hide()
            }
            for (q = 0, r = p.length; q < r && q < 10; q++) {
                $(p[q]).show()
            }
            return false
        }
    });
    b.Vs.AssignmentFilterView = Bb.View.extend({
        template: "classassignment/assignmentfilter.template.html",
        className: "ch",
        filterRange: {
            previous: false,
            active: true,
            future: false,
            daterange: false
        },
        events: {
            "click .assignmentTypeFilter": "setAssignmentTypes",
            "click .assignmentTimeFilter": "setFilterRange",
            "change #assignmentFilterStartDatePicker": "setDateRange",
            "change #assignmentFilterEndDatePicker": "setDateRange",
            "click #assignment-reports-list-toggle": "toggleReports",
            "click #import-button": "openImportDialog"
        },
        initialize: function(o) {
            this.collection.bind("reset", this.renderTemplate, this);
            this.showDateRanges(false);
            b.Us.FetchAssignmentTypes(o.sectionId);
            if (p3.Data.LMS === undefined) {
                p3.Data.LMS = {}
            }
            if (p3.Data.LMS.AssignmentFilters === undefined) {
                p3.Data.LMS.AssignmentFilters = {
                    Range: {
                        previous: false,
                        active: true,
                        future: false,
                        daterange: false,
                        startDate: e.localDateTime().toDateString(),
                        endDate: null
                    },
                    Types: "",
                    Statuses: "",
                    SearchTerm: ""
                };
                this.filterRange.previous = false;
                this.filterRange.active = true;
                this.filterRange.future = false;
                this.filterRange.daterange = false
            } else {
                this.filterRange.previous = p3.Data.LMS.AssignmentFilters.Range.previous;
                this.filterRange.active = p3.Data.LMS.AssignmentFilters.Range.active;
                this.filterRange.future = p3.Data.LMS.AssignmentFilters.Range.future;
                this.filterRange.daterange = p3.Data.LMS.AssignmentFilters.Range.daterange;
                if (p3.Data.LMS.AssignmentFilters.Types.length > 0) {
                    this.options.assignments.setAssignTypeFilter(p3.Data.LMS.AssignmentFilters.Types)
                }
                if (p3.Data.LMS.AssignmentFilters.Statuses.length > 0) {
                    this.options.assignments.setAssignTypeFilter(p3.Data.LMS.AssignmentFilters.Statuses)
                }
                var n = 1;
                if (p3.Data.LMS.AssignmentFilters.Range.daterange) {
                    n = null
                } else {
                    if (p3.Data.LMS.AssignmentFilters.Range.previous) {
                        n = 0
                    } else {
                        if (p3.Data.LMS.AssignmentFilters.Range.future) {
                            n = 2
                        }
                    }
                }
                this.options.assignments.setDateSortFilter(n)
            }
            this.schoolYears = new b.Cs.ExistingSchoolYears();
            this.schoolYears.fetch({
                error: function(p, q) {
                    p3.displayError("Error retreiving school years.")
                }
            })
        },
        renderTemplate: function() {
            var n = this;
            d.Us.refreshLtiConfigSummary(0);
            p3.fT(n.template, function(o) {
                n.$el.html(o({
                    assignmentTypes: n.collection.toJSON(),
                    previous: n.filterRange.previous,
                    active: n.filterRange.active,
                    future: n.filterRange.future,
                    daterange: n.filterRange.daterange,
                    reports: n.options.reports.toJSON(),
                    leadSectionId: n.options.leadSectionId,
                    canEdit: n.options.canEdit,
                    owner: n.options.isOwner,
                    showAssess: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.ASSESSMENTS),
                    showDiscuss: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADEDDISCUSSION),
                    lti: d.Data.LtiConfigSummary.toJSON()
                }));
                f.Us.initialize("#assignmentFilterStartDatePicker", {
                    changeMonth: true,
                    changeYear: true
                });
                f.Us.initialize("#assignmentFilterEndDatePicker", {
                    changeMonth: true,
                    changeYear: true
                });
                n.displayExistingFilters();
                n.showDateRanges(n.filterRange.daterange)
            })
        },
        render: function(n) {
            var o = this;
            $(n).append(o.el)
        },
        setAssignmentTypes: function(s) {
            s.preventDefault();
            var q = $(s.currentTarget),
                n = q.find("i"),
                p = q.closest("ul"),
                o = q.closest("ul").find("li"),
                v = q.data("typeId"),
                r = false;
            if (v === -1) {
                var t = p.find("i");
                if (t.length > 0) {
                    _.each(t, function(w) {
                        $(w).removeClass("p3icon-ok").addClass("p3icon-check");
                        $(w).closest("div").removeClass("active-filter").addClass("inactive-filter")
                    });
                    n.removeClass("p3icon-check").addClass("p3icon-ok");
                    n.closest("div").removeClass("inactive-filter").addClass("active-filter")
                }
                r = true
            } else {
                p.find("i:first").removeClass("p3icon-ok").addClass("p3icon-check");
                p.find("i:first").closest("div").removeClass("active-filter").addClass("inactive-filter");
                if (n.hasClass("p3icon-ok")) {
                    n.removeClass("p3icon-ok").addClass("p3icon-check");
                    n.closest("div").removeClass("active-filter").addClass("inactive-filter")
                } else {
                    n.removeClass("p3icon-check").addClass("p3icon-ok");
                    n.closest("div").removeClass("inactive-filter").addClass("active-filter")
                }
                if (p.find("i.p3icon-ok").length === 0) {
                    p.find("i:first").removeClass("p3icon-check").addClass("p3icon-ok");
                    p.find("i:first").closest("div").removeClass("inactive-filter").addClass("active-filter");
                    r = true
                }
            }
            if (this.options.assignments) {
                p3.Data.LMS.AssignmentFilters.Types = "";
                if (!r) {
                    var u = o.find(".p3icon-ok");
                    _.each(u, function(w) {
                        if (p3.Data.LMS.AssignmentFilters.Types.length > 0) {
                            p3.Data.LMS.AssignmentFilters.Types += ","
                        }
                        p3.Data.LMS.AssignmentFilters.Types += $(w).closest("a").data("typeId")
                    })
                }
            }
            this.options.assignments.setAssignTypeFilter(p3.Data.LMS.AssignmentFilters.Types);
            b.Us.updateAssignments()
        },
        displayExistingFilters: function() {
            var q = this,
                o;
            if (p3.Data.LMS === undefined || p3.Data.LMS.AssignmentFilters === undefined) {
                return
            }
            if (p3.Data.LMS.AssignmentFilters.Types.length > 0) {
                var p = p3.Data.LMS.AssignmentFilters.Types.split(","),
                    n = $(".assignmentTypeFilter");
                n.each(function() {
                    var r = $(this).data("typeId");
                    if (p.indexOf(r.toString()) > -1) {
                        $(this).find("i").removeClass("p3icon-check").addClass("p3icon-ok");
                        $(this).find("div").removeClass("inactive-filter").addClass("active-filter")
                    } else {
                        $(this).find("i").removeClass("p3icon-ok").addClass("p3icon-check");
                        $(this).find("div").removeClass("active-filter").addClass("inactive-filter")
                    }
                })
            }
            _.each($(".assignmentTimeFilter"), function(s) {
                var r = $(s).data("typeId");
                if (q.filterRange.previous && r === 0) {
                    $(s).find("i").removeClass("p3icon-radioOff").addClass("p3icon-radioOn");
                    $(s).find("div").removeClass("inactive-filter").addClass("active-filter")
                } else {
                    if (q.filterRange.active && r === 1) {
                        $(s).find("i").removeClass("p3icon-radioOff").addClass("p3icon-radioOn");
                        $(s).find("div").removeClass("inactive-filter").addClass("active-filter")
                    } else {
                        if (q.filterRange.future && r === 2) {
                            $(s).find("i").removeClass("p3icon-radioOff").addClass("p3icon-radioOn");
                            $(s).find("div").removeClass("inactive-filter").addClass("active-filter")
                        } else {
                            if (q.filterRange.daterange && r === 3) {
                                $(s).find("i").removeClass("p3icon-radioOff").addClass("p3icon-radioOn");
                                $(s).find("div").removeClass("inactive-filter").addClass("active-filter")
                            } else {
                                $(s).find("i").removeClass("p3icon-radioOn").addClass("p3icon-radioOff");
                                $(s).find("div").removeClass("active-filter").addClass("inactive-filter")
                            }
                        }
                    }
                }
            });
            if (p3.Data.LMS.AssignmentFilters.Range.daterange) {
                o = e.getDateString(p3.Data.LMS.AssignmentFilters.Range.startDate).ApiFormat();
                $("#assignmentFilterStartDatePicker").val(o);
                this.options.assignments.setStartDateFilter(o);
                o = e.getDateString(p3.Data.LMS.AssignmentFilters.Range.endDate).ApiFormat();
                $("#assignmentFilterEndDatePicker").val(o);
                this.options.assignments.setEndDateFilter(o)
            }
            if (p3.Data.LMS.AssignmentFilters.SearchTerm.length > 0) {
                $("#assignmentSearchBox").val(p3.Data.LMS.AssignmentFilters.SearchTerm);
                $("#assignmentSearchButton").trigger($.Event("click"))
            } else {
                b.Us.updateAssignments()
            }
        },
        setFilterRange: function(q) {
            q.preventDefault();
            var p = $(q.currentTarget),
                n = p.find("i"),
                o = p.closest("ul"),
                r = o.find("i"),
                s = p.data("typeId");
            if (r.length > 0) {
                _.each(r, function(t) {
                    $(t).removeClass("p3icon-radioOn").addClass("p3icon-radioOff");
                    $(t).closest("div").removeClass("active-filter").addClass("inactive-filter")
                });
                n.removeClass("p3icon-radioOff").addClass("p3icon-radioOn");
                n.closest("div").removeClass("inactive-filter").addClass("active-filter")
            }
            p3.Data.LMS.AssignmentFilters.Range.previous = this.filterRange.previous = false;
            p3.Data.LMS.AssignmentFilters.Range.active = this.filterRange.active = false;
            p3.Data.LMS.AssignmentFilters.Range.future = this.filterRange.future = false;
            p3.Data.LMS.AssignmentFilters.Range.daterange = this.filterRange.daterange = false;
            if (this.options.assignments) {
                if (s == 3) {
                    this.options.assignments.setDateSortFilter(null);
                    p3.Data.LMS.AssignmentFilters.Range.daterange = this.filterRange.daterange = true;
                    this.showDateRanges(true)
                } else {
                    this.options.assignments.setDateSortFilter(s);
                    switch (s) {
                        case 0:
                            p3.Data.LMS.AssignmentFilters.Range.previous = this.filterRange.previous = true;
                            break;
                        case 1:
                            p3.Data.LMS.AssignmentFilters.Range.active = this.filterRange.active = true;
                            break;
                        case 2:
                            p3.Data.LMS.AssignmentFilters.Range.future = this.filterRange.future = true;
                            break
                    }
                    this.showDateRanges(false)
                }
            }
            b.Us.updateAssignments()
        },
        setDateRange: function() {
            var p = $("#assignmentFilterStartDatePicker");
            var n = $("#assignmentFilterEndDatePicker");
            var q = p.attr("value") || $(p).datepicker("getDate");
            var o = n.attr("value") || $(n).datepicker("getDate");
            p3.Data.LMS.AssignmentFilters.Range.startDate = q;
            p3.Data.LMS.AssignmentFilters.Range.endDate = o;
            if (q !== null && o !== null && !$(p).hasClass("invalid") && !$(n).hasClass("invalid")) {
                this.options.assignments.setStartDateFilter(e.getDateString(q).ApiFormat());
                this.options.assignments.setEndDateFilter(e.getDateString(o).ApiFormat());
                b.Us.updateAssignments()
            }
        },
        showDateRanges: function(n) {
            if (n == false) {
                $("#assignmentFilterStartDatePicker").attr("disabled", "disabled");
                $("#assignmentFilterEndDatePicker").attr("disabled", "disabled");
                $("#assignmentFilterStartDatePicker").siblings("label").removeClass("active-filter").addClass("inactive-filter");
                $("#assignmentFilterEndDatePicker").siblings("label").removeClass("active-filter").addClass("inactive-filter")
            } else {
                $("#assignmentFilterStartDatePicker").removeAttr("disabled");
                $("#assignmentFilterEndDatePicker").removeAttr("disabled");
                $("#assignmentFilterStartDatePicker").siblings("label").removeClass("inactive-filter").addClass("active-filter");
                $("#assignmentFilterEndDatePicker").siblings("label").removeClass("inactive-filter").addClass("active-filter")
            }
        },
        toggleReports: function(n) {
            n.preventDefault();
            $("#reports-collapse").collapse("toggle")
        },
        openImportDialog: function() {
            var o = this;
            var n = new b.Vs.ImportAssignments({
                schoolYears: o.schoolYears,
                currentSections: b.Data.TeacherSections,
                leadSectionId: o.options.leadSectionId
            });
            n.on("save", function() {
                b.Us.updateAssignments()
            });
            p3.rV(n, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal)
        },
        toggleDropBoxOnly: function(o) {
            var n = $(o.currentTarget);
            if (n.data("toggleOn") === true) {
                p3.Data.LMS.AssignmentFilters.onlyDropbox = true
            } else {
                p3.Data.LMS.AssignmentFilters.onlyDropbox = undefined
            }
        }
    });
    b.Vs.AssignmentFilterStudentView = Bb.View.extend({
        template: "classassignment/assignmentfilter.template.student.html",
        className: "ch",
        filterRange: {
            previous: false,
            active: true,
            future: false,
            daterange: false
        },
        events: {
            "click .assignment-type-filter": "setAssignmentTypes",
            "click .status-type-filter": "setStatusFilter",
            "click .assignment-time-filter": "setFilterRange",
            "change #assignmentFilterStartDatePicker": "setDateRange",
            "change #assignmentFilterEndDatePicker": "setDateRange",
            "click #assignment-reports-list-toggle": "toggleReports"
        },
        initialize: function(n) {
            this.collection.bind("reset change", this.renderTemplate, this);
            this.showDateRanges(false);
            b.Us.FetchAssignmentTypes(n.sectionId);
            this.filterRange.previous = false;
            this.filterRange.active = true;
            this.filterRange.future = false;
            this.filterRange.daterange = false
        },
        renderTemplate: function() {
            var q = this;
            var p = false;
            var s = "";
            var o = false;
            var r = "";
            var n = false;
            p3.fT(q.template, function(w) {
                var u = p3.Data.Context.findByTaskRef("AssignmentCalendar:Run:0");
                q.$el.html(w({
                    assignmentTypes: q.collection.toJSON(),
                    previous: q.filterRange.previous,
                    active: q.filterRange.active,
                    future: q.filterRange.future,
                    daterange: q.filterRange.daterange,
                    leadSectionId: q.options.sectionId,
                    hasGrade: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADEBOOK) || p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADING),
                    hasaccess: u,
                    hasAccessToReport: o,
                    viewReportLink: s,
                    hasAccessTo2ndReport: n,
                    view2ndReportLink: r,
                    showreportsbutton: p,
                    showStatusFilter: p3.Data.Context.getSelectedPersona().Id === 2,
                    assessments: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.ASSESSMENTS)
                }));
                var v = $(".assignment-type-filter:first").closest("ul").find("i"),
                    t = $(".assignment-type-filter:first").find("i");
                if (v.length > 0) {
                    _.each(v, function(x) {
                        $(x).removeClass("p3icon-ok").addClass("p3icon-check");
                        $(x).closest("div").removeClass("active-filter").addClass("inactive-filter")
                    });
                    t.removeClass("p3icon-check").addClass("p3icon-ok");
                    t.closest("div").removeClass("inactive-filter").addClass("active-filter")
                }
                q.showDateRanges(q.filterRange.daterange);
                f.Us.initialize("#assignmentFilterStartDatePicker", {
                    changeMonth: true,
                    changeYear: true
                });
                f.Us.initialize("#assignmentFilterEndDatePicker", {
                    changeMonth: true,
                    changeYear: true
                })
            })
        },
        render: function(n) {
            var o = this;
            $(n).append(o.el)
        },
        setAssignmentTypes: function(s) {
            s.preventDefault();
            var q = $(s.currentTarget),
                n = q.find("i"),
                p = q.closest("ul"),
                o = q.closest("ul").find("li"),
                w = q.data("typeId"),
                r = false;
            if (w === -1) {
                var t = p.find("i");
                if (t.length > 0) {
                    _.each(t, function(x) {
                        $(x).removeClass("p3icon-ok").addClass("p3icon-check");
                        $(x).closest("div").removeClass("active-filter").addClass("inactive-filter")
                    });
                    n.removeClass("p3icon-check").addClass("p3icon-ok");
                    n.closest("div").removeClass("inactive-filter").addClass("active-filter")
                }
                r = true
            } else {
                p.find("i:first").removeClass("p3icon-ok").addClass("p3icon-check");
                p.find("i:first").closest("div").removeClass("active-filter").addClass("inactive-filter");
                if (n.hasClass("p3icon-ok")) {
                    n.removeClass("p3icon-ok").addClass("p3icon-check");
                    n.closest("div").removeClass("active-filter").addClass("inactive-filter")
                } else {
                    n.removeClass("p3icon-check").addClass("p3icon-ok");
                    n.closest("div").removeClass("inactive-filter").addClass("active-filter")
                }
                if (p.find("i.p3icon-ok").length === 0) {
                    p.find("i:first").removeClass("p3icon-check").addClass("p3icon-ok");
                    p.find("i:first").closest("div").removeClass("inactive-filter").addClass("active-filter");
                    r = true
                }
            }
            var u = "";
            if (this.options.assignments) {
                if (!r) {
                    var v = o.find(".p3icon-ok");
                    _.each(v, function(x) {
                        if (u.length > 0) {
                            u += ","
                        }
                        u += $(x).closest("a").data("typeId")
                    })
                }
            }
            this.options.assignments.setAssignTypeFilter(u);
            b.Us.updateAssignments()
        },
        setStatusFilter: function(s) {
            s.preventDefault();
            var q = $(s.currentTarget),
                n = q.find("i"),
                p = q.closest("ul"),
                o = q.closest("ul").find("li"),
                w = q.data("statusId"),
                u = "",
                r = false;
            if (w === -2) {
                var t = p.find("i");
                if (t.length > 0) {
                    _.each(t, function(x) {
                        $(x).removeClass("p3icon-ok").addClass("p3icon-check");
                        $(x).closest("div").removeClass("active-filter").addClass("inactive-filter")
                    });
                    n.removeClass("p3icon-check").addClass("p3icon-ok");
                    n.closest("div").removeClass("inactive-filter").addClass("active-filter")
                }
                r = true
            } else {
                p.find("i:first").removeClass("p3icon-ok").addClass("p3icon-check");
                p.find("i:first").closest("div").removeClass("active-filter").addClass("inactive-filter");
                if (n.hasClass("p3icon-ok")) {
                    n.removeClass("p3icon-ok").addClass("p3icon-check");
                    n.closest("div").removeClass("active-filter").addClass("inactive-filter")
                } else {
                    n.removeClass("p3icon-check").addClass("p3icon-ok");
                    n.closest("div").removeClass("inactive-filter").addClass("active-filter")
                }
                if (p.find("i.p3icon-ok").length === 0) {
                    p.find("i:first").removeClass("p3icon-check").addClass("p3icon-ok");
                    p.find("i:first").closest("div").removeClass("inactive-filter").addClass("active-filter");
                    r = true
                }
            }
            if (this.options.assignments) {
                if (!r) {
                    var v = o.find(".p3icon-ok");
                    _.each(v, function(x) {
                        if (u.length > 0) {
                            u += ","
                        }
                        u += $(x).closest("a").data("statusId")
                    })
                }
            }
            this.options.assignments.setStatusFilter(u);
            b.Us.updateAssignments()
        },
        setFilterRange: function(q) {
            q.preventDefault();
            var p = $(q.currentTarget),
                n = p.find("i"),
                o = p.closest("ul"),
                r = o.find("i"),
                s = p.data("typeId");
            if (r.length > 0) {
                _.each(r, function(t) {
                    $(t).removeClass("p3icon-radioOn").addClass("p3icon-radioOff");
                    $(t).closest("div").removeClass("active-filter").addClass("inactive-filter")
                });
                n.removeClass("p3icon-radioOff").addClass("p3icon-radioOn");
                n.closest("div").removeClass("inactive-filter").addClass("active-filter")
            }
            this.filterRange.previous = false;
            this.filterRange.active = false;
            this.filterRange.future = false;
            this.filterRange.daterange = false;
            if (this.options.assignments) {
                if (s == 3) {
                    this.options.assignments.setDateSortFilter(null);
                    this.filterRange.daterange = true;
                    this.showDateRanges(true)
                } else {
                    this.options.assignments.setDateSortFilter(s);
                    switch (s) {
                        case 0:
                            this.filterRange.previous = true;
                            break;
                        case 1:
                            this.filterRange.active = true;
                            break;
                        case 2:
                            this.filterRange.future = true;
                            break
                    }
                    this.showDateRanges(false)
                }
            }
            b.Us.updateAssignments()
        },
        setDateRange: function() {
            var p = $("#assignmentFilterStartDatePicker");
            var n = $("#assignmentFilterEndDatePicker");
            var q = p.attr("value") || $(p).datepicker("getDate");
            var o = n.attr("value") || $(n).datepicker("getDate");
            if (q !== null && o !== null && !$(p).hasClass("invalid") && !$(n).hasClass("invalid")) {
                this.options.assignments.setStartDateFilter(e.getDateString(q).ApiFormat());
                this.options.assignments.setEndDateFilter(e.getDateString(o).ApiFormat());
                b.Us.updateAssignments()
            }
        },
        showDateRanges: function(n) {
            if (n == false) {
                $("#assignmentFilterStartDatePicker").attr("disabled", "disabled");
                $("#assignmentFilterEndDatePicker").attr("disabled", "disabled");
                $("#assignmentFilterStartDatePicker").siblings("label").removeClass("active-filter").addClass("inactive-filter");
                $("#assignmentFilterEndDatePicker").siblings("label").removeClass("active-filter").addClass("inactive-filter")
            } else {
                $("#assignmentFilterStartDatePicker").removeAttr("disabled");
                $("#assignmentFilterEndDatePicker").removeAttr("disabled");
                $("#assignmentFilterStartDatePicker").siblings("label").removeClass("inactive-filter").addClass("active-filter");
                $("#assignmentFilterEndDatePicker").siblings("label").removeClass("inactive-filter").addClass("active-filter")
            }
        },
        toggleReports: function(n) {
            n.preventDefault();
            $("#reports-collapse").collapse("toggle")
        }
    });
    b.Vs.PublishChangeConfirmation = Bb.View.extend({
        template: "classassignment/AssignmentPublishChange.template.html",
        update: false,
        events: {
            "click #btnConfirm": "doPublishChange"
        },
        initialize: function(n) {
            b.Data.ConfirmBox = this
        },
        render: function(n) {
            $(n).append(this.el);
            this.renderTemplate()
        },
        renderTemplate: function() {
            var n = this;
            p3.fT(n.template, function(p) {
                var o = [];
                _.each(n.options.Sections, function(q) {
                    o.push({
                        aiid: q.AssignmentIndexId,
                        name: q.Section.Name
                    })
                });
                n.$el.html(p({
                    Sections: o,
                    showRadios: o.length > 1 ? true : false
                }))
            })
        },
        resetDefault: function() {
            if (!b.Data.ConfirmBox.update) {
                var n = $(b.Data.ConfirmBox.options.target).data("lastValue");
                if (n !== undefined) {
                    $(b.Data.ConfirmBox.options.target).val(n)
                }
            }
            b.Data.ConfirmBox = undefined;
            $(p3.Layout.Containers.Modal).off("hide", this.resetDefault)
        },
        doPublishChange: function(q) {
            var v = this,
                t = $("#rdo_remove").filter(":checked"),
                p = $("#rdo_delete").filter(":checked"),
                r = $("#showRadios").length > 0 ? true : false,
                u = $("table#sectionsToChange"),
                s, n;
            this.update = true;
            if (r && v.options.PublishOpt) {
                if (t.length) {
                    s = new b.Ms.PublishAssignment();
                    n = $(v.options.target).data("aiid");
                    if (n && v.options.PublishOpt !== undefined) {
                        s.fetch({
                            data: {
                                assignmentIndexId: n,
                                publishInd: v.options.PublishOpt
                            },
                            success: function(w, x) {
                                $("#site-modal").modal("hide");
                                b.Data.assignments.fetch()
                            },
                            error: function(w, x) {
                                p3.displayError("Failed to save changes to the server")
                            }
                        })
                    }
                } else {
                    if (p.length) {
                        var o = "";
                        s = new b.Ms.PublishAssignment();
                        _.each($(u).children("tbody").children("tr"), function(w) {
                            if (o.length > 0) {
                                o += ","
                            }
                            o += $(w).data("aiid")
                        });
                        if (o && v.options.PublishOpt !== undefined) {
                            s.fetch({
                                data: {
                                    assignmentIndexId: o,
                                    publishInd: v.options.PublishOpt
                                },
                                success: function(w, x) {
                                    $("#site-modal").modal("hide");
                                    b.Data.assignments.fetch()
                                },
                                error: function(w, x) {
                                    p3.displayError("Failed to save changes to the server")
                                }
                            })
                        }
                    }
                }
            }
        },
        showToggleContent: function(n) {
            $(n.target).parent().siblings(".content").slideToggle();
            return false
        },
        assignmentTypeDefaultMaxPoint: function(o) {
            var n = _.first(b.Data.Types.where({
                AssignmentTypeId: parseInt($(o.target).val(), 10)
            }));
            if (n) {
                this.$el.find("#add-assignment-gradebook-max-points").val(n.get("DefaultMaxPoints"))
            }
        }
    });
    b.Vs.DeleteAssignmentModalView = Bb.View.extend({
        template: "classassignment/assignmentdeletemodal.template.html",
        events: {
            "click #assignment-delete-cancel-button": "doCancel",
            "click #assignment-delete-confirm-button": "doAssignmentDelete"
        },
        renderTemplate: function() {
            var p = this,
                o = p.collection.toJSON(),
                n = true;
            p3.fT(p.template, function(w) {
                var r = p.collection.filter(function(z) {
                        return z.get("HasGrades") === true
                    }),
                    s = p.collection.filter(function(z) {
                        return z.get("HasGradeDetails") === true
                    }),
                    t = p.collection.filter(function(z) {
                        return z.get("HasGradeValues") === true
                    }),
                    x = p.collection.filter(function(z) {
                        return z.get("DropBoxSubmitted") === true
                    }),
                    v = p.collection.filter(function(z) {
                        return z.get("HasAssessmentResults") === true
                    }),
                    u = p.isAssessment ? "Assessment" : "Assignment",
                    y = p.isAssessment ? "assessment" : "assignment",
                    q = "<p>To delete this " + y + ' leave "Remove" checked for all class sections listed and click "Confirm."</p><p>To only remove this ' + y + ' from specific class sections, uncheck "Remove" in list below for the sections that should keep this ' + y + ' and click "Confirm."</p>';
                if (p.isAssessment) {
                    if (t.length > 0) {
                        o = [];
                        n = false;
                        p.collection.each(function(z) {
                            if (z.get("HasGradeValues")) {
                                o.push(z.toJSON())
                            }
                        })
                    }
                    p.$el.html(w({
                        Sections: o,
                        AllowDelete: n,
                        header: u
                    }));
                    if (t.length > 0) {
                        p3.Us.InfoMessage.ErrorBox("<p>Whoops! We can't let you delete this " + y + "! Grades have been recorded for the following course sections. You must open the Grade Book and delete those grades before we'll let you delete this assessment forever.</p>", "#delete-confirm-modal-errors", false)
                    } else {
                        if (v.length > 0) {
                            p3.Us.InfoMessage.ErrorBox("<p>Yikes! There are student submissions associated with this " + y + ". Are you sure you want to delete it and lose those answers forever? Once you hit confirm there is no undo button. </p>" + q, "#delete-confirm-modal-errors", false)
                        } else {
                            if (s.length > 0) {
                                p3.Us.InfoMessage.ErrorBox("<p>Yikes! We are seeing some grade details on this " + y + ". Are you really sure you want to delete it and lose those details forever? You can review the details in the Grade Book.</p>" + q, "#delete-confirm-modal-errors", false)
                            } else {
                                p3.Us.InfoMessage.ErrorBox("<p>Wait a minute! Are you sure you want to delete this " + y + " forever? Once you hit confirm there is no undo button.</p>" + q, "#delete-confirm-modal-errors", false)
                            }
                        }
                    }
                } else {
                    if (r.length > 0) {
                        o = [];
                        n = false;
                        p.collection.each(function(z) {
                            if (z.get("HasGrades")) {
                                o.push(z.toJSON())
                            }
                        })
                    } else {
                        if (v.length > 0) {
                            o = [];
                            n = false;
                            p.collection.each(function(z) {
                                if (z.get("HasAssessmentResults")) {
                                    o.push(z.toJSON())
                                }
                            })
                        }
                    }
                    p.$el.html(w({
                        Sections: o,
                        AllowDelete: n,
                        header: u
                    }));
                    if (r.length > 0) {
                        p3.Us.InfoMessage.ErrorBox("<p>Whoops! We can't let you delete this " + y + "! Grades have been recorded for the following course sections.</p>", "#delete-confirm-modal-errors", false)
                    } else {
                        if (v.length > 0) {
                            p3.Us.InfoMessage.ErrorBox("<p>Whoops! We can't let you delete this " + y + "! Results have been recorded for the following course sections.</p>", "#delete-confirm-modal-errors", false)
                        } else {
                            if (x.length > 0) {
                                p3.Us.InfoMessage.ErrorBox(p3.Us.InfoMessageLibrary.Assignment.AssignmentDeleteAssociatedSubmissions, "#delete-confirm-modal-errors", false)
                            } else {
                                p3.Us.InfoMessage.ErrorBox("<p>Wait a minute! Are you sure you want to delete this " + y + " forever? Once you hit confirm there is no undo button.</p>" + q, "#delete-confirm-modal-errors", false)
                            }
                        }
                    }
                }
            })
        },
        initialize: function() {
            this.collection.bind("reset change", this.renderTemplate, this);
            this.assignmentId = this.options.assignmentId || 0;
            this.isAssessment = this.options.isAssessment || false;
            this.container = this.options.container || p3.Layout.Containers.Modal
        },
        render: function(n) {
            $(n).append(this.el)
        },
        doAssignmentDelete: function() {
            var s = this,
                o;
            if (this.assignmentId > 0) {
                var p = "",
                    r = false,
                    q = $("#assignment-sections-to-delete-list tr");
                for (o = 0; o < q.length; o++) {
                    if ($($(q[o]).children("td:last").children()).is(":checked")) {
                        p += $($(q[o]).children("td:last").children()).val() + ","
                    } else {
                        r = true
                    }
                }
                if (p && p.length > 0) {
                    p = p.substr(0, p.length - 1)
                }
                var n = new b.Ms.AssignmentDelete({
                    Id: this.assignmentId,
                    sections: r ? p : null
                });
                n.destroy({
                    error: function() {
                        s.container.modal("hide")
                    },
                    success: function() {
                        s.trigger("assignmentDeleted");
                        s.container.modal("hide")
                    }
                })
            }
            return false
        },
        doCancel: function() {
            this.$el.parent().modal("hide");
            return false
        }
    });
    b.Vs.ImportAssignments = Bb.View.extend({
        template: "classassignment/import.asignment.template.html",
        events: {
            "change #school-year-dd": "yearChanged",
            "change #teacher-dd": "teacherChanged",
            "change #section-dd": "sectionChanged",
            "change #marking-dd": "markingPeriodChanged",
            "click #btnApply": "saveAssignments"
        },
        initialize: function() {
            var n = this;
            n.leadSectionId = n.options.leadSectionId;
            p3.Layout.Containers.Modal.on("shown", function() {
                window.setTimeout(function() {
                    p3.setModalHeight(p3.Layout.Containers.Modal)
                }, 300)
            });
            n.options.schoolYears.each(function(o) {
                if (o.get("Current")) {
                    n.activeYear = o.get("Label")
                }
            });
            n.Containers = {};
            n.activeTeacher = p3.Data.Context.get("UserInfo").UserId
        },
        render: function(n) {
            var s = this,
                q = 0,
                p = "";
            if (p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADEBOOK)) {
                var o = new b.Cs.MarkingPeriods();
                o.fetch({
                    async: false,
                    data: {
                        sectionList: s.leadSectionId
                    },
                    success: function(t, u) {
                        p = "<strong>Marking Periods:</strong><div style='margin-top:5px;'>";
                        o.each(function(z) {
                            var v = z.get("begin_date"),
                                x = z.get("end_date");
                            if (typeof v === "string" && typeof x === "string") {
                                var w = v.substring(0, v.indexOf(" ")),
                                    y = x.substring(0, x.indexOf(" "));
                                p += z.get("marking_period_description") + ": " + w + " - " + y + "<br />"
                            }
                        });
                        p += "</div>"
                    },
                    error: function(t, u) {
                        p3.displayError("Failed to retreive the Marking Periods")
                    }
                })
            }
            var r = new b.Cs.ExistingTeachers();
            r.fetch({
                data: {
                    schoolYear: s.activeYear
                },
                success: function(t, w, v) {
                    var x = new b.Cs.ExistingSections(),
                        u;
                    x.fetch({
                        data: {
                            facultyUserId: s.activeTeacher,
                            schoolYear: s.activeYear
                        },
                        success: function(z, B) {
                            var y = z.toJSON();
                            y = _.uniq(y, true, function(C) {
                                return C.SectionId
                            });
                            if (y.length > 0) {
                                for (u = 0; u < y.length; u++) {
                                    if (y[u].SectionId == s.leadSectionId) {
                                        y.splice(u, 1);
                                        break
                                    }
                                }
                                if (y.length > 0) {
                                    q = y[0].SectionId
                                }
                            }
                            var A = new b.Cs.ExistingMarkingPeriods();
                            A.fetch({
                                data: {
                                    sectionId: q
                                },
                                success: function(C, E, D) {
                                    p3.fT(s.template, function(G) {
                                        s.$el.html(G({
                                            schoolYears: s.options.schoolYears.toJSON(),
                                            teachers: t.toJSON(),
                                            sections: y,
                                            currentSections: s.options.currentSections.toJSON(),
                                            markingPeriods: [{
                                                Name: "-- All --",
                                                mpId: -1
                                            }].concat(A.toJSON()),
                                            mpMessage: p
                                        }));
                                        $(n).html(s.el);
                                        $("#teacher-dd").val(s.activeTeacher);
                                        s.Containers.Assignments = $("#import-content-container");
                                        var F = new b.Cs.ImportAssignments();
                                        if (q > 0) {
                                            F.fetch({
                                                data: {
                                                    sectionId: q
                                                },
                                                success: function() {
                                                    s.renderAssignments(F)
                                                },
                                                error: function() {
                                                    p3.displayError("Error retreiving existing assignments.")
                                                }
                                            })
                                        } else {
                                            s.renderAssignments(F)
                                        }
                                    })
                                }
                            })
                        }
                    })
                },
                error: function(t, u) {
                    p3.displayError("Error retreiving sections.")
                }
            })
        },
        renderAssignments: function(n) {
            var p = this;
            var o = new b.Vs.ImportAssignmentList({
                assignments: n
            });
            p.listView = o;
            p3.rV(o, p.Containers.Assignments, true);
            p3.initModalHeightTimer(p.Containers.Assignments)
        },
        yearChanged: function(n) {
            var p = this;
            p.activeYear = $("#school-year-dd").val();
            $("#teacher-dd").empty();
            var o = new b.Cs.ExistingTeachers();
            o.fetch({
                data: {
                    schoolYear: p.activeYear
                },
                success: function(q, u, t) {
                    if (q.length > 0) {
                        var s = false;
                        q.each(function(r) {
                            var v = r.get("Id") === p.activeTeacher;
                            $("<option />", {
                                text: r.get("Name"),
                                val: r.get("Id"),
                                selected: v
                            }).appendTo("#teacher-dd");
                            if (v) {
                                s = true
                            }
                        });
                        if (!s) {
                            $("#teacher-dd").val(p3.Data.Context.get("UserInfo").UserId);
                            if ($("#teacher-dd").val() !== p3.Data.Context.get("UserInfo").UserId) {
                                $("#teacher-dd > option:first").attr("selected", true)
                            }
                        }
                    } else {
                        $("#section-dd").empty()
                    }
                    $("#teacher-dd").trigger($.Event("change"))
                }
            })
        },
        teacherChanged: function(o) {
            var s = this,
                q = 0,
                n = $(o.currentTarget),
                p;
            s.activeTeacher = parseInt(n.val(), 10) || s.activeTeacher || 0;
            $("#section-dd").empty();
            var r = new b.Cs.ExistingSections();
            r.fetch({
                data: {
                    facultyUserId: s.activeTeacher,
                    schoolYear: s.activeYear
                },
                success: function(u, v) {
                    var t = u.toJSON();
                    t = _.uniq(t, true, function(w) {
                        return w.SectionId
                    });
                    if (t.length > 0) {
                        for (p = 0; p < t.length; p++) {
                            if (t[p].SectionId != s.leadSectionId) {
                                if (q == 0) {
                                    q = t[p].SectionId
                                }
                                $("<option />", {
                                    val: t[p].SectionId,
                                    text: t[p].Name
                                }).appendTo("#section-dd")
                            }
                        }
                    }
                    s.updateAssignments(q);
                    $("#section-dd").trigger($.Event("change"))
                },
                error: function(t, u) {
                    p3.displayError("Error retreiving sections.")
                }
            })
        },
        sectionChanged: function(n) {
            var r = this,
                q = $("#section-dd").val(),
                o = 0,
                p = new b.Cs.ExistingMarkingPeriods();
            $("#marking-dd").empty();
            p.fetch({
                data: {
                    sectionId: q
                },
                success: function(t, w, v) {
                    var s = t.toJSON(),
                        u;
                    s = [{
                        Name: "-- All --",
                        mpId: -1
                    }].concat(_.uniq(s, true, function(x) {
                        return x.mpId
                    }));
                    if (s.length > 0) {
                        for (u = 0; u < s.length; u++) {
                            if (o === 0) {
                                o = s[u].mpId
                            }
                            $("<option />", {
                                val: s[u].mpId,
                                text: s[u].Name
                            }).appendTo("#marking-dd")
                        }
                    }
                    r.updateAssignments(q, o === -1 ? undefined : o)
                }
            })
        },
        markingPeriodChanged: function(n) {
            var o = this;
            o.updateAssignments($("#section-dd").val(), $("#marking-dd").val())
        },
        updateAssignments: function(p, o) {
            var q = this,
                n = new b.Cs.ImportAssignments();
            if (p > 0) {
                n.fetch({
                    async: false,
                    data: {
                        sectionId: p,
                        markingPeriodId: (o !== undefined && o > 0 ? o : undefined)
                    },
                    success: function() {
                        q.listView.assignments = n;
                        q.listView.renderTemplate()
                    },
                    error: function() {
                        p3.displayError("Error retreiving existing assignments.")
                    }
                })
            } else {
                n.remove(n.at(0));
                q.listView.assignments = n;
                q.listView.renderTemplate()
            }
        },
        saveAssignments: function(p) {
            var x = this;
            var w = true;
            var u = true;
            var v = true;
            var t = [];
            var o = [],
                q, n;
            $("div.alert-error").remove();
            if ($(".btn-select-item.active").length == 0) {
                w = false;
                u = false
            }
            if ($(".section-checkbox:checked").length == 0) {
                w = false;
                v = false
            } else {
                $(".section-checkbox:checked").each(function() {
                    t.push($(this).val())
                })
            }
            if (!w) {
                var r = "Please select ";
                if (!u && !v) {
                    r += "at least one assignment and a section to add it to."
                } else {
                    if (!u) {
                        r += "at least one assignment."
                    } else {
                        r += "at least one section to add assignments to."
                    }
                }
                p3.Us.InfoMessage.ErrorBox(r, "#import-content-container", false);
                $("#site-modal .modal-body").scrollTop(1)
            } else {
                $(".btn-select-item.active").each(function() {
                    for (q = 0; q < t.length; q++) {
                        n = $(this).data("item");
                        if ($("#pub-date-" + n).val().length > 0) {
                            o.push({
                                AssignmentId: n,
                                SectionId: t[q],
                                AssignmentDate: $("#pub-date-" + n).val(),
                                AssignmentTime: e.displayTime(e.buildTimeString(0, 0, 0), true, "timeSpan"),
                                DueDate: $("#exp-date-" + n).val() || $("#pub-date-" + n).val(),
                                DueTime: e.buildTimeString(23, 59, 0),
                                PublishInd: true,
                                PublishOnAssignedInd: false
                            })
                        } else {
                            w = false
                        }
                    }
                });
                if (w) {
                    var s = new b.Ms.ExistingAssignment({
                        AssignmentId: 0,
                        SectionLinks: o,
                        SendNotification: false
                    });
                    s.save({}, {
                        error: function() {
                            p3.showModal(p3.Layout.Containers.Modal, "hide");
                            p3.displayError("Error importing assignments")
                        },
                        success: function() {
                            x.trigger("save");
                            p3.showModal(p3.Layout.Containers.Modal, "hide")
                        }
                    })
                } else {
                    p3.Us.InfoMessage.ErrorBox("An assigned date is required for each assignment being imported.", "#import-content-container", false);
                    $("#site-modal .modal-body").scrollTop(1)
                }
            }
        }
    });
    b.Vs.ImportAssignmentList = Bb.View.extend({
        template: "classassignment/import.assignment.list.template.html",
        itemTemplate: "classassignment/import.assignment.list.item.template.html",
        events: {
            "click .type-toggle": "toggleType",
            "click .select-all-type": "selectAllType",
            "click .btn-select-item": "selectItem",
            "click th.header-sort-item": "updateFilter",
            'blur [id*="exp-date-"]': "triggerCacheUpdate",
            'blur [id*="pub-date-"]': "triggerCacheUpdate"
        },
        renderTemplate: function() {
            var o = this;
            var n = [];
            p3.fT(o.template, function(p) {
                o.$el.html(p({
                    assignType: n,
                    haveData: o.assignments.length > 0
                }));
                window.setTimeout(function() {
                    if (o.CurrentSort === undefined) {
                        o.CurrentSort = "title_no_html_invert"
                    }
                    var q = o.CurrentSort.indexOf("_invert"),
                        r = o.CurrentSort;
                    if (q > -1) {
                        r = o.CurrentSort.substring(0, q)
                    }
                    $("th.header-sort-item[data-sort=" + r + "]").trigger($.Event("click"))
                }, 500)
            })
        },
        renderItems: function() {
            var o = this,
                n = $("#import-assignment-list-table-body");
            n.html("");
            o.assignments.each(function(p) {
                p3.fT(o.itemTemplate, function(q) {
                    n.append(q({
                        assignment: p.toJSON()
                    }))
                })
            });
            $("#import-assignment-list-table-body button").removeClass("active");
            _.each(o.selectedAssignments, function(p) {
                if (p.sel) {
                    $("#import-assignment-list-table-body button[data-item=" + p.id + "]").addClass("active")
                } else {
                    $("#import-assignment-list-table-body button[data-item=" + p.id + "]").removeClass("active")
                }
                $("#exp-date-" + p.id).val(p.dd);
                $("#pub-date-" + p.id).val(p.da)
            });
            p3.initModalHeightTimer(p3.Layout.Containers.Modal);
            window.setTimeout(function() {
                f.Us.initialize(".date-input", {
                    changeMonth: true,
                    changeYear: true
                })
            }, 400)
        },
        initialize: function() {
            var n = this;
            n.assignments = n.options.assignments;
            n.assignments.changeSort("title_no_html");
            n.selectedAssignments = []
        },
        render: function(n) {
            this.renderTemplate();
            $(n).append(this.el)
        },
        toggleType: function(o) {
            var n = $(o.currentTarget);
            var p = n.data("type");
            if ($("#type" + p).is(":visible")) {
                $("#type" + p).hide(200);
                n.find(".p3icon-downArrow").removeClass("p3icon-downArrow").addClass("p3icon-sideArrow")
            } else {
                $("#type" + p).show(200);
                n.find(".p3icon-sideArrow").removeClass("p3icon-sideArrow").addClass("p3icon-downArrow")
            }
        },
        selectAllType: function(p) {
            var r = this,
                o = $(p.currentTarget),
                q = o.data("type"),
                n = $(".btn-select-item[data-type='" + q + "']");
            if (o.hasClass("active")) {
                n.removeClass("active");
                n.each(function(s, t) {
                    r.cacheManageEdit($(t).data("item"), false)
                })
            } else {
                n.addClass("active");
                n.each(function(s, t) {
                    r.cacheManageEdit($(t).data("item"), true)
                });
                if (!$("#type" + q).is(":visible")) {
                    $("#type" + q).show(200);
                    $(".type-toggle[data-type='" + q + "']").find(".p3icon-sideArrow").removeClass("p3icon-sideArrow").addClass("p3icon-downArrow")
                }
            }
        },
        selectItem: function(o) {
            var n = $(o.currentTarget),
                q = n.data("type"),
                p = n.data("item"),
                r = this;
            if (n.hasClass("active")) {
                $(".select-all-type[data-type='" + q + "']").removeClass("active");
                r.cacheManageEdit(p, false)
            } else {
                if ($(".btn-select-item.active[data-type='" + q + "']").length + 1 == $(".btn-select-item[data-type='" + q + "']").length) {
                    $(".select-all-type[data-type='" + q + "']").addClass("active")
                }
                r.cacheManageEdit(p, true)
            }
        },
        cacheManageEdit: function(q, r) {
            var t = $("button[data-item=" + q + "]").hasClass("active"),
                p = $("#exp-date-" + q).val(),
                n = $("#pub-date-" + q).val(),
                s = this.selectedAssignments,
                o = _.find(s, function(u) {
                    return u.id === q
                });
            if (r !== undefined) {
                t = r
            }
            if (p === "" && n === "" && t === false) {
                this.cacheRemoveEdit(q)
            }
            if (o === undefined || o === null) {
                s.push({
                    id: q,
                    sel: t,
                    dd: p,
                    da: n
                })
            } else {
                o.sel = t;
                o.dd = p;
                o.da = n
            }
        },
        cacheRemoveEdit: function(o) {
            var p = this.selectedAssignments,
                n = _.find(p, function(q) {
                    return q.id === o
                });
            if (n !== undefined) {
                p.splice(p.indexOf(n), 1)
            }
        },
        updateFilter: function(o) {
            var q = this;
            var n = (o.currentTarget !== undefined && o.currentTarget !== null) ? $(o.currentTarget) : undefined;
            var p = (n !== undefined && n !== null) ? n.data("sort") : undefined;
            if (q.assignments.filters === undefined) {
                q.assignments.filters = {
                    title_no_html: function(t, u) {
                        var r = t.get("title_no_html") || "",
                            s = u.get("title_no_html") || "";
                        return r < s ? -1 : r > s ? 1 : 0
                    },
                    assignment_type: function(t, u) {
                        var r = t.get("assignment_type") || "",
                            s = u.get("assignment_type") || "";
                        return r < s ? -1 : r > s ? 1 : 0
                    },
                    date_assigned: function(r) {
                        return r.get("date_assigned") ? e.getDate(r.get("date_assigned")).getTime() : 0
                    },
                    date_due: function(r) {
                        return r.get("date_due") ? e.getDate(r.get("date_due")).getTime() : 0
                    },
                    title_no_html_invert: function(t, u) {
                        var r = t.get("title_no_html") || "",
                            s = u.get("title_no_html") || "";
                        return r < s ? 1 : r > s ? -1 : 0
                    },
                    assignment_type_invert: function(t, u) {
                        var r = t.get("assignment_type") || "",
                            s = u.get("assignment_type") || "";
                        return r < s ? 1 : r > s ? -1 : 0
                    },
                    date_assigned_invert: function(r) {
                        return r.get("date_assigned") ? -e.getDate(r.get("date_assigned")).getTime() : 0
                    },
                    date_due_invert: function(r) {
                        return r.get("date_due") ? -e.getDate(r.get("date_due")).getTime() : 0
                    }
                }
            }
            $(".sort-icon").removeClass("p3icon-sortDown p3icon-sortUp p3icon-sortOff");
            $(".sort-icon").addClass("p3icon-sortOff");
            $(".existing-table-sort").removeClass("sort-active").addClass("muted");
            if (p !== undefined) {
                if (q.CurrentSort === p) {
                    p = p + "_invert";
                    n.removeClass("muted").addClass("sort-active");
                    n.children("i").removeClass("p3icon-sortOff").addClass("p3icon-sortUp")
                } else {
                    n.removeClass("muted").addClass("sort-active");
                    n.children("i").removeClass("p3icon-sortOff").addClass("p3icon-sortDown")
                }
                q.CurrentSort = p;
                q.assignments.changeSort(p);
                q.assignments.sort();
                q.renderItems()
            }
        },
        triggerCacheUpdate: function(n) {
            var o = $(n.currentTarget).closest("tr").find("button").data("item");
            if (o !== undefined && o > 0) {
                this.cacheManageEdit(o)
            }
        }
    });
    b.Vs.AssessmentEditView = Bb.View.extend({
        template: "ClassAssignment/Assessment.edit.template.html",
        events: {
            "click #btnSave": "saveAssessment",
            "click #btnSaveEdit": "saveAssessment",
            "click #show-more-groups": "showGroupDialog",
            "change #assignment-type-drop": "assignmentTypeDefaultMaxPoint",
            "click #publish-options-apply-selected-button": "doApplyToSelected",
            "click .select-all-check": "doSelectionToggle",
            "change #max-point-box": "pointsChange",
            "change #max-score-box": "scoreChange",
            "click #gradebook-check": "toggleGradeBook",
            "change .default-value-change": "highlightApplyToSelected",
            "blur .default-time-value-blur": "highlightApplyToSelected"
        },
        initialize: function() {
            this.contentId = 58;
            this.markingPeriods = new b.Cs.MarkingPeriods()
        },
        dispose: function() {
            var n = tinyMCE.get("description-box");
            if (n) {
                n.remove()
            }
            if (this.emptysections) {
                b.Data.TeacherSections = undefined
            }
        },
        render: function(n) {
            var o = this;
            $(n).html(o.el);
            o.renderTemplate()
        },
        renderTemplate: function() {
            var n = this;
            b.Us.RenderEditModal(n, "name-box")
        },
        validated: function() {
            var A = this;
            var w = tinyMCE.get("name-box");
            w.save();
            var x = [],
                y = $("#gradebook-check:checked").length == 1 ? true : false,
                v = $("#assignment-type-drop"),
                n = $("#abbrev-box"),
                q = $("#max-point-box"),
                o = $("#factor-box"),
                u = $("#name-box"),
                s = $(".add-assignment-section-selector:checked"),
                t = $("#time-box"),
                r = $("#max-score-box");
            if (u.val() === "") {
                if (x.indexOf(p3.Us.InfoMessageLibrary.P3.RequiredInfoNotEntered) === -1) {
                    x.push(p3.Us.InfoMessageLibrary.P3.RequiredInfoNotEntered)
                }
                u.closest(".control-group").addClass("error")
            } else {
                u.closest(".control-group").removeClass("error")
            }
            if (y) {
                var p = n.closest(".controls").siblings("label:first"),
                    z = false;
                if (v.val() === "0") {
                    v.closest(".control-group").addClass("error");
                    z = true;
                    if (x.indexOf(p3.Us.InfoMessageLibrary.Assignment.GradeBookRequiredFields) === -1) {
                        x.push(p3.Us.InfoMessageLibrary.Assignment.GradeBookRequiredFields)
                    }
                } else {
                    v.closest(".control-group").removeClass("error")
                }
                if (n.val() === "") {
                    n.closest(".control-group").addClass("error");
                    z = false;
                    if (x.indexOf(p3.Us.InfoMessageLibrary.Assignment.GradeBookRequiredFields) === -1) {
                        x.push(p3.Us.InfoMessageLibrary.Assignment.GradeBookRequiredFields)
                    }
                } else {
                    n.closest(".control-group").removeClass("error")
                }
                if (q.val() !== "" && /^\d*(\.\d{1,})?$/.test(q.val())) {
                    q.closest(".control-group").removeClass("error");
                    if (q.val().toString().length > 6) {
                        q.val(q.val().substring(0, 6))
                    }
                } else {
                    q.closest(".control-group").addClass("error");
                    z = false;
                    if (x.indexOf(p3.Us.InfoMessageLibrary.Assignment.GradeBookRequiredFields) === -1) {
                        x.push(p3.Us.InfoMessageLibrary.Assignment.GradeBookRequiredFields)
                    }
                }
                if (o.val() !== "" && /^\d*(\.\d{1,})?$/.test(o.val()) && o.val() !== "0") {
                    o.closest(".control-group").removeClass("error");
                    if (o.val().toString().length > 6) {
                        o.val(o.val().substring(0, 6))
                    }
                } else {
                    o.closest(".control-group").addClass("error");
                    z = false;
                    if (x.indexOf(p3.Us.InfoMessageLibrary.Assignment.GradeBookRequiredFields) === -1) {
                        x.push(p3.Us.InfoMessageLibrary.Assignment.GradeBookRequiredFields)
                    }
                }
                if (x.indexOf(p3.Us.InfoMessageLibrary.Assignment.GradeBookRequiredFields) !== -1) {
                    if (!z) {
                        p.addClass("error")
                    } else {
                        p.removeClass("error")
                    }
                } else {
                    p.removeClass("error")
                }
            }
            if (r.val() !== "" && /^\d*(\.\d{1,})?$/.test(r.val()) && r.val() !== "0") {
                r.closest(".control-group").removeClass("error")
            } else {
                r.closest(".control-group").addClass("error");
                if (x.indexOf(p3.Us.InfoMessageLibrary.P3.RequiredInfoNotEntered) === -1) {
                    x.push(p3.Us.InfoMessageLibrary.P3.RequiredInfoNotEntered)
                }
            }
            if ((/^\d*(\.\d{1,})?$/.test(t.val()) && t.val() !== "0") || t.val() == "") {
                t.closest(".control-group").removeClass("error")
            } else {
                t.closest(".control-group").addClass("error");
                if (x.indexOf("Invalid value, must be numeric and greater than zero.") === -1) {
                    x.push("Invalid value, must be numeric and greater than zero.")
                }
            }
            if (s.length > 0) {
                s.each(function(L) {
                    var B = $(this).closest("td").siblings("td:first").children("input:first"),
                        G = e.getDate(B.val());
                    if (isNaN(G)) {
                        B.closest(".control-group").addClass("error");
                        if (x.indexOf(p3.Us.InfoMessageLibrary.P3.RequiredInfoNotEntered) === -1) {
                            x.push(p3.Us.InfoMessageLibrary.P3.RequiredInfoNotEntered)
                        }
                    } else {
                        B.closest(".control-group").removeClass("error")
                    }
                    if (p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADEBOOK) && A.markingPeriods.length > 0) {
                        var O = parseInt($(this).val(), 10),
                            M = false,
                            C = $("#" + O + "-due-date"),
                            I = C.val(),
                            H = e.getDate(I),
                            N = A.markingPeriods.filter(function(P) {
                                return P.get("section_id") === O
                            }),
                            F, D, K, E, J;
                        if (isNaN(H)) {
                            H = G
                        }
                        for (F = 0; F < N.length; F++) {
                            D = N[F].get("begin_date");
                            K = N[F].get("end_date");
                            if (typeof D === "string" && typeof K === "string") {
                                E = e.getDate(D);
                                J = e.getDate(K);
                                if (H <= J && H >= E) {
                                    M = true
                                }
                            }
                        }
                        if (!M) {
                            C.closest(".control-group").addClass("error");
                            if (x.indexOf(p3.Us.InfoMessageLibrary.Assignment.DueDateMustBeInMarkingPeriod) === -1) {
                                x.push(p3.Us.InfoMessageLibrary.Assignment.DueDateMustBeInMarkingPeriod)
                            }
                        } else {
                            C.closest(".control-group").removeClass("error")
                        }
                    }
                })
            } else {
                if (x.indexOf(p3.Us.InfoMessageLibrary.Assignment.SectionRequired) === -1) {
                    x.push(p3.Us.InfoMessageLibrary.Assignment.SectionRequired)
                }
            }
            return x
        },
        highlightApplyToSelected: function(n) {
            $("#publish-options-apply-selected-button").addClass("btn-primary");
            $("#publish-options-warning-message").show("slow")
        },
        saveAssessment: function(s) {
            var Q = this,
                v = false;
            $(".modal-body").children(".alert").remove();
            var r = Q.validated();
            if (r.length > 0) {
                _.each(r, function(R) {
                    p3.Us.InfoMessage.ErrorBox(R, ".modal-body", false);
                    v = true
                })
            }
            if (v) {
                $("#site-modal .modal-body").scrollTop(1);
                return false
            }
            var N = $("#name-box").val(),
                P = $("#assignment-type-drop").val(),
                n = $("#abbrev-box").val(),
                z = $("#max-point-box").val(),
                u = $("#factor-box").val(),
                x = $("#gradebook-check:checked").length == 1 ? true : false,
                w = $("#cumulative-check:checked").length == 1 ? true : false,
                t = $("#extra-credit-check:checked").length == 1 ? true : false,
                F = $("#publish-grade-check:checked").length == 1 ? true : false,
                K = $(".add-assignment-section-selector:checked"),
                A = $("#max-score-box").val(),
                B = $("#score_type_dropdown").val(),
                D = $("#attempts-box").val(),
                M = $("#time-box").val(),
                G = $("#random-radio").hasClass("active"),
                O = $("#together-button").hasClass("active"),
                H = $("#allow-save-radio").hasClass("active"),
                y, C = [];
            var L = [];
            var I = $(K[y]).closest("td").nextAll("td"),
                o, q, E, J, p;
            for (y = 0; y < K.length; y++) {
                I = $(K[y]).closest("td").nextAll("td");
                o = $(I[0]).children("input");
                q = $(I[1]).children("input");
                E = $(I[2]).children("select").val();
                J = $(K[y]).val();
                p = e.localDateTime();
                if ($(o[0]).val() !== "") {
                    p = e.getDate($(o[0]).val())
                }
                if (e.getDate($(q[0]).val()).getTime() < p.getTime()) {
                    $(q[0]).closest(".control-group").addClass("error");
                    v = true
                }
                if (this.assignment !== undefined) {
                    L.push({
                        SectionId: J,
                        AssignmentId: this.assignment.get("AssignmentId") || null,
                        AssignmentIndexId: this.assignment.get("AssignmentIndexId") || null,
                        AssignmentDate: $(o[0]).val() || e.getDateString(p),
                        AssignmentTime: b.Us.GetAssignmentTime($(o[1])),
                        DueDate: $(q[0]).val() || e.getDateString(p),
                        DueTime: e.buildTimeString(23, 59, 0),
                        Section: null,
                        PublishInd: E == 1 ? true : false,
                        PublishOnAssignedInd: E == 2 ? true : false
                    })
                } else {
                    L.push({
                        SectionId: J,
                        AssignmentDate: $(o[0]).val() || e.getDateString(p),
                        AssignmentTime: b.Us.GetAssignmentTime($(o[1])),
                        DueDate: $(q[0]).val() || e.getDateString(p),
                        DueTime: e.buildTimeString(23, 59, 0),
                        Section: null,
                        PublishInd: E == 1 ? true : false,
                        PublishOnAssignedInd: E == 2 ? true : false
                    })
                }
                if (this.options.edit) {
                    if ($("#" + J + "-notification-send").is(":checked")) {
                        C.push(J)
                    }
                }
            }
            if (v) {
                $("#site-modal .modal-body").scrollTop(1);
                return false
            }
            if (this.assignment === undefined || this.copyId > 0) {
                this.assignment = new b.Ms.Assignment({
                    AssignmentTypeId: P,
                    ShortDescription: N,
                    LongDescription: "",
                    IncGradeBook: x,
                    AbbrDescription: n,
                    MaxPoints: z,
                    Factor: u,
                    ExtraCredit: t,
                    IncCumGrade: w,
                    PublishGrade: F,
                    DropboxInd: false,
                    DropboxNumFiles: 0,
                    DropboxTimeLate: e.buildTimeString(23, 59, 0),
                    SectionLinks: L,
                    LinkItems: [],
                    DownloadItems: [],
                    SendNotification: false,
                    Notifications: [],
                    HasGrades: (Q.options.assignment == undefined) ? false : Q.options.assignment.get("HasGrades"),
                    AssessmentInd: true,
                    MaxScore: A,
                    MaxScoreInd: B,
                    TimeToComplete: M,
                    NumberOfAttempts: D,
                    RandomizeQuestions: G,
                    QuestionsTogether: O,
                    SaveForLater: H
                });
                if (this.copyId > 0) {
                    this.assignment.set("AssessmentCopyId", this.copyAssessmentId)
                }
            } else {
                this.assignment.set({
                    AssignmentTypeId: P,
                    ShortDescription: N,
                    LongDescription: "",
                    IncGradeBook: x,
                    AbbrDescription: n,
                    MaxPoints: z,
                    Factor: u,
                    ExtraCredit: t,
                    IncCumGrade: w,
                    PublishGrade: F,
                    DropboxInd: false,
                    DropboxNumFiles: 0,
                    DropboxTimeLate: e.buildTimeString(23, 59, 0),
                    SectionLinks: L,
                    LinkItems: [],
                    DownloadItems: [],
                    SendNotification: false,
                    Notifications: [],
                    HasGrades: (Q.options.assignment == undefined) ? false : Q.options.assignment.get("HasGrades"),
                    AssessmentInd: true,
                    MaxScore: A,
                    MaxScoreInd: B,
                    TimeToComplete: M,
                    NumberOfAttempts: D,
                    RandomizeQuestions: G,
                    QuestionsTogether: O,
                    SaveForLater: H
                })
            }
            this.assignment.save({}, {
                success: function(R, S) {
                    if (s.currentTarget.id == "btnSaveEdit") {
                        Q.trigger("saveEditAssessment", S, R)
                    } else {
                        Q.trigger("saveAssessment", S, R)
                    }
                    $("#site-modal").modal("hide")
                },
                error: function(R, S) {
                    p3.displayError("Error creating assignment")
                }
            })
        },
        getSectionListForAssignment: function() {
            var s = this;
            var r = new b.Cs.SectionsForTeacher({}, {
                sectionId: 0
            });
            r.remove(r.at(0));
            b.Data.TeacherSections.each(function(t) {
                r.add(t.clone())
            });
            if (!s.AddMode) {
                var n = r.pluck("SectionId");
                var q = s.assignment.get("SectionLinks"),
                    o, p;
                for (o = 0; o < q.length; o++) {
                    if (n.indexOf(q[o].SectionId) == -1) {
                        p = new b.Ms.SectionForTeacher({
                            SectionId: q[o].SectionId,
                            GroupName: q[o].Section.Name,
                            IsSelected: 1,
                            LeadSectionId: q[o].SectionId,
                            HasGrades: q[o].HasGrades,
                            HasAssessmentResults: q[o].HasAssessmentResults
                        });
                        r.add(p)
                    } else {
                        if (q[o].HasGrades || q[o].HasAssessmentResults) {
                            b.Us.SyncSections(r, q, o)
                        }
                    }
                }
            }
            return r
        },
        showGroupDialog: function(n) {
            var p = this;
            $("#show-more-groups").button("loading");
            var o = [];
            $(".add-assignment-section-selector").each(function(q) {
                o.push("null_" + $(this).val())
            });
            h.Us.showGroupPickerDialog(58, o, p);
            return false
        },
        addSelectedGroups: function(n) {
            var r = this;
            b.Us.addSelectedGroups(r, n);
            var p = r.getSectionListForAssignment().pluck("LeadSectionId");
            var q = "",
                o;
            for (o = 0; o < p.length; o++) {
                if (q.length > 0) {
                    q += ","
                }
                q += p[o].toString()
            }
            for (o = 0; o < n.length; o++) {
                if (q.length > 0) {
                    q += ","
                }
                q += n[o].leadSectionId.toString()
            }
            r.markingPeriods.fetch({
                data: {
                    sectionList: q
                },
                success: function(w, D) {
                    var E = $(".grade-book-tooltip-location"),
                        F, B, C, x, t, y, u, v, z, A;
                    for (o = 0; o < E.length; o++) {
                        F = $(E[o]).data("sectionId");
                        if (F && F > 0) {
                            B = b.Us.GetMarkingPeriods(w, F);
                            if (B.length === 0) {
                                $(E[o]).hide()
                            } else {
                                C = "<strong>Marking Periods:</strong><br>Due date must fall within a marking period for this assignment to be included in Grade Book.<br>";
                                for (x = 0; x < B.length; x++) {
                                    t = B[x].get("begin_date");
                                    y = B[x].get("end_date");
                                    if (typeof t === "string" && typeof y === "string") {
                                        u = e.getDateString(e.getDate(t));
                                        v = e.getTimeString(e.getTime(t));
                                        z = e.getDateString(e.getDate(y));
                                        A = e.getTimeString(e.getTime(y));
                                        C += B[x].get("marking_period_description") + "<br><div>Begin: " + u + " " + v + "<br>End: " + z + " " + A + "<br></div>"
                                    }
                                }
                                $(E[o]).show().tooltip({
                                    title: C
                                })
                            }
                        }
                    }
                },
                error: function(s, t) {
                    p3.displayError("Failed to retreive the Marking Periods")
                }
            })
        },
        loadAssignment: function(o) {
            var r, u, p, t, n, q, s;
            $("#name-box").val(o.ShortDescription);
            $("#assignment-type-drop").val(o.AssignmentTypeId);
            $("#max-score-box").val(o.MaxScore);
            $("#score_type_dropdown").val(o.MaxScoreInd);
            if (o.TimeToComplete > 0) {
                $("#time-box").val(o.TimeToComplete)
            } else {
                $("#time-box").val("")
            }
            $("#attempts-box").val(o.NumberOfAttempts);
            if (o.QuestionsTogether) {
                $("#together-button").addClass("active");
                $("#per-page-button").removeClass("active")
            } else {
                $("#per-page-button").addClass("active");
                $("#together-button").removeClass("active")
            }
            if (o.RandomizeQuestions) {
                $("#random-radio").addClass("active");
                $("#order-radio").removeClass("active")
            } else {
                $("#random-radio").removeClass("active");
                $("#order-radio").addClass("active")
            }
            if (o.SaveForLater) {
                $("#allow-save-radio").addClass("active");
                $("#no-save-radio").removeClass("active")
            } else {
                $("#allow-save-radio").removeClass("active");
                $("#no-save-radio").addClass("active")
            }
            $("#abbrev-box").val(o.AbbrDescription);
            $("#max-point-box").val(o.MaxPoints);
            $("#factor-box").val(o.Factor);
            if (o.IncGradeBook) {
                $("#gradebook-check").prop("checked", true)
            } else {
                $("#gradebook-check").prop("checked", false)
            }
            if (o.IncCumGrade) {
                $("#cumulative-check").prop("checked", true)
            } else {
                $("#cumulative-check").prop("checked", false)
            }
            if (o.ExtraCredit) {
                $("#extra-credit-check").prop("checked", true)
            } else {
                $("#extra-credit-check").prop("checked", false)
            }
            if (o.PublishGrade) {
                $("#publish-grade-check").prop("checked", true)
            } else {
                $("#publish-grade-check").prop("checked", false)
            }
            $(".add-assignment-section-selector").prop("checked", false);
            for (r = 0; r < o.SectionLinks.length; r++) {
                u = o.SectionLinks[r];
                p = $("#add-assignment-sections-listing tr td label input[value = " + u.SectionId + "]");
                t = p.parents("tr");
                n = $(t).children("td")[1];
                q = $(t).children("td")[2];
                s = $(t).children("td")[3];
                $(t).show();
                $(p).prop("checked", true);
                $(n).children("input:first").val(e.displayDate(u.AssignmentDate, "shortDate"));
                $(n).children("input:last").val(e.displayTime(u.AssignmentTime, false, "shortTime"));
                $(q).children("input:first").val(e.displayDate(u.DueDate, "shortDate"));
                $(s).children("select").val(u.PublishOnAssignedInd ? 2 : u.PublishInd ? 1 : 0)
            }
            $(".add-assignment-section-selector:input:checkbox[checked!='checked']").closest("tr").remove()
        },
        assignmentTypeDefaultMaxPoint: function(o) {
            var n = _.first(b.Data.Types.where({
                AssignmentTypeId: parseInt($(o.target).val(), 10)
            }));
            if (n && this.$el.find("#max-point-box").val() === "") {
                this.$el.find("#max-point-box").val(n.get("DefaultMaxPoints"));
                $("#max-score-box").val(n.get("DefaultMaxPoints"))
            }
        },
        doApplyToSelected: function(n) {
            b.Us.DoApplyToSelected();
            return false
        },
        doSelectionToggle: function(n) {
            b.Us.DoSelectionToggle(n)
        },
        pointsChange: function(n) {
            $("#max-score-box").val($("#max-point-box").val())
        },
        scoreChange: function(n) {
            $("#max-point-box").val($("#max-score-box").val())
        },
        toggleGradeBook: function(n) {
            b.Us.ToggleGradeBook()
        }
    });
    b.Vs.DiscussionEditView = Bb.View.extend({
        template: "ClassAssignment/discussion.edit.template.html",
        linkTemplate: "classassignment/assignmentLinkItem.template.html",
        downloadTemplate: "classassignment/assignmentDownloadItem.template.html",
        events: {
            "click #btnSave": "saveDiscussion",
            "click #btnSaveEdit": "saveDiscussion",
            "click #btnSaveAdd": "saveDiscussion",
            "click #show-more-groups": "showGroupDialog",
            "change #assignment-type-drop": "assignmentTypeDefaultMaxPoint",
            "click #publish-options-apply-selected-button": "doApplyToSelected",
            "click .select-all-check": "doSelectionToggle",
            "click #gradebook-check": "toggleGradeBook",
            "change .default-value-change": "highlightApplyToSelected",
            "blur .default-time-value-blur": "highlightApplyToSelected",
            "click .link-delete-button": "deleteLinkItem",
            "click .download-delete-button": "deleteDownloadItem",
            "change .input-file": "handleDownloads",
            "change .assignment-download-file-field": "handleDownloads",
            "blur .assignment-link-field": "handleLinks",
            "blur .assignment-download-field": "handleDownloads"
        },
        initialize: function() {
            this.contentId = 58;
            this.markingPeriods = new b.Cs.MarkingPeriods();
            p3.fT(this.linkTemplate, function(n) {
                return false
            });
            p3.fT(this.downloadTemplate, function(n) {
                return false
            });
            b.Data.FileTypes = new b.Cs.FileTypes({}, {});
            b.Data.FileTypes.fetch();
            if (p3.Data.fileTypes === undefined) {
                p3.Data.fileTypes = new b.Cs.FileTypes({}, {});
                p3.Data.fileTypes.fetch({
                    error: function() {
                        p3.displayError("Error loading filetypes")
                    }
                })
            }
            p3.Layout.Containers.Modal.on("postRender", this.initializeFileUpload)
        },
        dispose: function() {
            var n = tinyMCE.get("description-box");
            if (n) {
                n.remove()
            }
            if (this.emptysections) {
                b.Data.TeacherSections = undefined
            }
            p3.Layout.Containers.Modal.off("postRender")
        },
        render: function(n) {
            var o = this;
            $(n).html(o.el);
            p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.jQueryUI, function() {
                p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.FileUpload, function() {
                    o.renderTemplate()
                })
            })
        },
        renderTemplate: function() {
            var n = this;
            b.Us.RenderEditModal(n, "description-box")
        },
        validated: function() {
            var F = this;
            var z = tinyMCE.get("description-box");
            z.save();
            var A = [],
                B = $("#gradebook-check:checked").length == 1 ? true : false,
                x = $("#assignment-type-drop"),
                n = $("#abbrev-box"),
                u = $("#max-point-box"),
                r = $("#factor-box"),
                w = $("#name-box"),
                v = $(".add-assignment-section-selector:checked"),
                p = $("#description-box"),
                q = $("#add-assignment-downloads-tab").children(".control-group"),
                t = $("#add-assignment-links-tab").children(".control-group"),
                o = $("#add-assignment-links-tab").closest(".control-group").children("label:first"),
                y = false;
            if (w.val() === "") {
                if (A.indexOf(p3.Us.InfoMessageLibrary.P3.RequiredInfoNotEntered) === -1) {
                    A.push(p3.Us.InfoMessageLibrary.P3.RequiredInfoNotEntered)
                }
                w.closest(".control-group").addClass("error")
            } else {
                w.closest(".control-group").removeClass("error")
            }
            if (p.val() === "") {
                if (A.indexOf(p3.Us.InfoMessageLibrary.P3.RequiredInfoNotEntered) === -1) {
                    A.push(p3.Us.InfoMessageLibrary.P3.RequiredInfoNotEntered)
                }
                p.closest(".control-group").addClass("error")
            } else {
                p.closest(".control-group").removeClass("error")
            }
            if (t.length > 0) {
                var E = /(((http[s]?):\/\/|mailto:)?\S+\.[a-zA-Z]{2,3}([\S\w\W]+|[\s+]))|(javascript:)\S+/i;
                t.each(function(J) {
                    var H = $(this).find(".assignment-url-field"),
                        G = $(this).find(".assignment-conditional-required-field"),
                        I = false;
                    if (H.length === 0 && G.length === 0) {
                        return
                    }
                    if ((H.val() !== "" && G.val() === "") || (H.val() === "" && G.val() !== "")) {
                        if (A.indexOf(p3.Us.InfoMessageLibrary.P3.RequiredInfoNotEntered) === -1) {
                            A.push(p3.Us.InfoMessageLibrary.P3.RequiredInfoNotEntered)
                        }
                        $(this).addClass("error");
                        y = I = true
                    } else {
                        $(this).removeClass("error");
                        y = false
                    }
                    if (H.val() !== "" && !E.test(H.val())) {
                        if (A.indexOf(p3.Us.InfoMessageLibrary.P3.UrlError) === -1) {
                            A.push(p3.Us.InfoMessageLibrary.P3.UrlError)
                        }
                        $(this).addClass("error");
                        y = true
                    } else {
                        if (!I) {
                            $(this).removeClass("error");
                            y = false
                        }
                    }
                    if ($(this).hasClass("error")) {
                        $("ul#add-assignment-attachment-tabs li:first-child").addClass("error")
                    }
                })
            }
            if (q.length > 0) {
                var C = y;
                q.each(function(K) {
                    var I = $(this).find(".assignment-download-file-name"),
                        H = I.siblings("span:last"),
                        G = $(this).find(".assignment-download-field"),
                        J = false;
                    if (I.length === 0 && H.length === 0 && G.length === 0) {
                        return
                    }
                    if ((I.val() !== "" && G.val() === "") || (I.val() === "" && G.val() !== "")) {
                        $(this).addClass("error");
                        y = J = true;
                        if (A.indexOf(p3.Us.InfoMessageLibrary.P3.RequiredInfoNotEntered) === -1) {
                            A.push(p3.Us.InfoMessageLibrary.P3.RequiredInfoNotEntered)
                        }
                    } else {
                        if (I.val() !== "" && !/^[^\\\/\:\*\?\"\\<\>\|\.\+]+(\.[^\\\/\:\*\?\"\\<\>\|\.\+]+)+$/.test(I.val() + H.html())) {
                            $(this).addClass("error");
                            y = J = true;
                            if (A.indexOf(p3.Us.InfoMessageLibrary.P3.FileNameInvalidChars) === -1) {
                                A.push(p3.Us.InfoMessageLibrary.P3.FileNameInvalidChars)
                            }
                        } else {
                            if (I.val().length > 200) {
                                $(this).addClass("error");
                                y = J = true;
                                if (A.indexOf(p3.Us.InfoMessageLibrary.P3.FileNameToLong) === -1) {
                                    A.push(p3.Us.InfoMessageLibrary.P3.FileNameToLong)
                                }
                            } else {
                                $(this).removeClass("error");
                                if (!C) {
                                    y = false
                                }
                            }
                        }
                    }
                    if (I.val() !== "" && G.val() !== "") {
                        if (p3.Data.fileTypes !== undefined) {
                            if (p3.Data.fileTypes.get(H.html().toLowerCase())) {
                                if (!J) {
                                    H.removeClass("error");
                                    if (!C) {
                                        y = false
                                    }
                                }
                            } else {
                                H.addClass("error");
                                y = J = true;
                                if (A.indexOf(p3.Us.InfoMessageLibrary.Assignment.FileTypeUnsupported) === -1) {
                                    A.push(p3.Us.InfoMessageLibrary.Assignment.FileTypeUnsupported)
                                }
                            }
                        }
                    }
                    if (H.data("Duplicate") === 1) {
                        $(this).addClass("error");
                        y = true;
                        if (A.indexOf(p3.Us.InfoMessageLibrary.P3.FileNameDuplicate) === -1) {
                            A.push(p3.Us.InfoMessageLibrary.P3.FileNameDuplicate)
                        }
                    } else {
                        if (!J) {
                            H.removeClass("error");
                            if (!C) {
                                y = false
                            }
                        }
                    }
                    if ($(this).hasClass("error")) {
                        $("#download-tab").addClass("error")
                    }
                })
            }
            if (y) {
                o.addClass("error")
            } else {
                o.removeClass("error")
            }
            if (B) {
                var s = n.closest(".controls").siblings("label:first"),
                    D = false;
                if (x.val() === "0") {
                    x.closest(".control-group").addClass("error");
                    D = true;
                    if (A.indexOf(p3.Us.InfoMessageLibrary.Assignment.GradeBookRequiredFields) === -1) {
                        A.push(p3.Us.InfoMessageLibrary.Assignment.GradeBookRequiredFields)
                    }
                } else {
                    x.closest(".control-group").removeClass("error")
                }
                if (n.val() === "") {
                    n.closest(".control-group").addClass("error");
                    D = false;
                    if (A.indexOf(p3.Us.InfoMessageLibrary.Assignment.GradeBookRequiredFields) === -1) {
                        A.push(p3.Us.InfoMessageLibrary.Assignment.GradeBookRequiredFields)
                    }
                } else {
                    n.closest(".control-group").removeClass("error")
                }
                if (u.val() !== "" && /^\d*(\.\d{1,})?$/.test(u.val())) {
                    u.closest(".control-group").removeClass("error");
                    if (u.val().toString().length > 6) {
                        u.val(u.val().substring(0, 6))
                    }
                } else {
                    u.closest(".control-group").addClass("error");
                    D = false;
                    if (A.indexOf(p3.Us.InfoMessageLibrary.Assignment.GradeBookRequiredFields) === -1) {
                        A.push(p3.Us.InfoMessageLibrary.Assignment.GradeBookRequiredFields)
                    }
                }
                if (r.val() !== "" && /^\d*(\.\d{1,})?$/.test(r.val()) && r.val() !== "0") {
                    r.closest(".control-group").removeClass("error");
                    if (r.val().toString().length > 6) {
                        r.val(r.val().substring(0, 6))
                    }
                } else {
                    r.closest(".control-group").addClass("error");
                    D = false;
                    if (A.indexOf(p3.Us.InfoMessageLibrary.Assignment.GradeBookRequiredFields) === -1) {
                        A.push(p3.Us.InfoMessageLibrary.Assignment.GradeBookRequiredFields)
                    }
                }
                if (A.indexOf(p3.Us.InfoMessageLibrary.Assignment.GradeBookRequiredFields) !== -1) {
                    if (!D) {
                        s.addClass("error")
                    } else {
                        s.removeClass("error")
                    }
                } else {
                    s.removeClass("error")
                }
            }
            if (v.length > 0) {
                v.each(function(Q) {
                    var G = $(this).closest("td").siblings("td:first").children("input:first"),
                        L = e.getDate(G.val());
                    if (isNaN(L)) {
                        G.closest(".control-group").addClass("error");
                        if (A.indexOf(p3.Us.InfoMessageLibrary.P3.RequiredInfoNotEntered) === -1) {
                            A.push(p3.Us.InfoMessageLibrary.P3.RequiredInfoNotEntered)
                        }
                    } else {
                        G.closest(".control-group").removeClass("error")
                    }
                    if (p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADEBOOK) && F.markingPeriods.length > 0) {
                        var T = parseInt($(this).val(), 10),
                            R = false,
                            H = $("#" + T + "-due-date"),
                            N = H.val(),
                            M = e.getDate(N),
                            S = F.markingPeriods.filter(function(U) {
                                return U.get("section_id") === T
                            }),
                            I, P, K, J, O;
                        if (isNaN(M)) {
                            M = L
                        }
                        for (K = 0; K < S.length; K++) {
                            I = S[K].get("begin_date");
                            P = S[K].get("end_date");
                            if (typeof I === "string" && typeof P === "string") {
                                J = e.getDate(I);
                                O = e.getDate(P);
                                if (M <= O && M >= J) {
                                    R = true
                                }
                            }
                        }
                        if (!R) {
                            H.closest(".control-group").addClass("error");
                            if (A.indexOf(p3.Us.InfoMessageLibrary.Assignment.DueDateMustBeInMarkingPeriod) === -1) {
                                A.push(p3.Us.InfoMessageLibrary.Assignment.DueDateMustBeInMarkingPeriod)
                            }
                        } else {
                            H.closest(".control-group").removeClass("error")
                        }
                    }
                })
            } else {
                if (A.indexOf(p3.Us.InfoMessageLibrary.Assignment.SectionRequired) === -1) {
                    A.push(p3.Us.InfoMessageLibrary.Assignment.SectionRequired)
                }
            }
            return A
        },
        highlightApplyToSelected: function(n) {
            $("#publish-options-apply-selected-button").addClass("btn-primary");
            $("#publish-options-warning-message").show("slow")
        },
        saveDiscussion: function(z) {
            var aj = this,
                I = false;
            $(".modal-body").children(".alert").remove();
            var y = aj.validated();
            if (y.length > 0) {
                _.each(y, function(ak) {
                    p3.Us.InfoMessage.ErrorBox(ak, ".modal-body", false);
                    I = true
                })
            }
            if (I) {
                $("#site-modal .modal-body").scrollTop(1);
                return false
            }
            var ad = $("#name-box").val(),
                af = $("#assignment-type-drop").val(),
                n = $("#abbrev-box").val(),
                S = $("#max-point-box").val(),
                C = $("#factor-box").val(),
                L = $("#gradebook-check:checked").length == 1 ? true : false,
                K = $("#cumulative-check:checked").length == 1 ? true : false,
                B = $("#extra-credit-check:checked").length == 1 ? true : false,
                W = $("#publish-grade-check:checked").length == 1 ? true : false,
                Z = $(".add-assignment-section-selector:checked"),
                aa = $("#btn-share-yes").hasClass("active"),
                ab = $("#btn-anytime").hasClass("active"),
                o = $("#btn-attach-yes").hasClass("active"),
                R = $("#description-box").val(),
                P = $("#add-assignment-links-tab").children("div"),
                v = $("#add-assignment-downloads-tab").children("div");
            var ac = [],
                Q = [],
                w = [],
                ah = /((http[s]?):\/\/|mailto:)/i,
                M, X, p, x, V, Y, q, T = [],
                N, ai, s, r, D, H, ae, F, A, J, E, O, U, ag, G, u, t;
            for (M = 0; M < Z.length; M++) {
                X = $(Z[M]).closest("td").nextAll("td");
                p = $(X[0]).children("input");
                x = $(X[1]).children("input");
                V = $(X[2]).children("select").val();
                Y = $(Z[M]).val();
                q = e.localDateTime();
                if ($(p[0]).val() !== "") {
                    q = e.getDate($(p[0]).val())
                }
                if (e.getDate($(x[0]).val()).getTime() < q.getTime()) {
                    $(x[0]).closest(".control-group").addClass("error");
                    I = true
                }
                if (this.assignment !== undefined) {
                    ac.push({
                        SectionId: Y,
                        AssignmentId: this.assignment.get("AssignmentId") || null,
                        AssignmentIndexId: this.assignment.get("AssignmentIndexId") || null,
                        AssignmentDate: $(p[0]).val() || e.getDateString(q),
                        AssignmentTime: b.Us.GetAssignmentTime($(p[1])),
                        DueDate: $(x[0]).val() || e.getDateString(q),
                        DueTime: e.buildTimeString(23, 59, 0),
                        Section: null,
                        PublishInd: V == 1 ? true : false,
                        PublishOnAssignedInd: V == 2 ? true : false
                    })
                } else {
                    ac.push({
                        SectionId: Y,
                        AssignmentDate: $(p[0]).val() || e.getDateString(q),
                        AssignmentTime: b.Us.GetAssignmentTime($(p[1])),
                        DueDate: $(x[0]).val() || e.getDateString(q),
                        DueTime: e.buildTimeString(23, 59, 0),
                        Section: null,
                        PublishInd: V == 1 ? true : false,
                        PublishOnAssignedInd: V == 2 ? true : false
                    })
                }
                if (this.options.edit) {
                    if ($("#" + Y + "-notification-send").is(":checked")) {
                        T.push(Y)
                    }
                }
            }
            if (P.length > 0) {
                for (M = 0, O = P.length; M < O; M++) {
                    N = $(P[M]).find("input:first").val();
                    ai = $(P[M]).find("input:last").val();
                    s = $(P[M]).children("span").data("needsDelete");
                    if (s) {
                        J = $(P[M]).children("span").data("id");
                        if (J && J > 0) {
                            Q.push({
                                LinkId: J,
                                ContextValue: -1
                            })
                        }
                    } else {
                        if (N && ai && N != "" && ai != "") {
                            if (!ah.test(ai)) {
                                ai = "http://" + ai
                            }
                            if (this.assignment === undefined) {
                                Q.push({
                                    Url: ai,
                                    ShortDescription: N
                                })
                            } else {
                                Q.push({
                                    LinkId: $(P[M]).data("id"),
                                    Url: ai,
                                    ShortDescription: N
                                })
                            }
                        }
                    }
                }
            }
            if (v.length > 0) {
                for (M = 0, O = v.length; M < O; M++) {
                    r = $(v[M]).find("input:last").val();
                    D = $(v[M]).find("input.assignment-download-file-name").data("rawFile");
                    H = $(v[M]).find("input.assignment-download-file-name").val();
                    ae = $(v[M]).find("input.assignment-download-file-name").data("attachedFileName");
                    F = $(v[M]).find("input.assignment-download-file-name").data("fileType");
                    s = $(v[M]).children("span").data("needsDelete");
                    A = "";
                    if (s) {
                        J = $(v[M]).children("span").data("id");
                        E = $(v[M]).children("span").data("filename");
                        if (J && J > 0) {
                            w.push({
                                DownloadId: J,
                                ContextValue: -1,
                                FileName: E
                            })
                        }
                        break
                    }
                    if (ae !== undefined) {
                        A = ae.substring(ae.lastIndexOf("."))
                    } else {
                        A = $(v[M]).find("input.assignment-download-file-name").next().html()
                    }
                    if (D === "" && r === "" && (ae === undefined || ae === "")) {
                        break
                    }
                    if (this.assignment === undefined) {
                        if (r && r != "" && ((D !== undefined && D != "") || (H !== undefined && H != "")) && ae !== undefined && ae != "" && A != "" && $(v[M]).find("input.assignment-download-file-name").data("fileChanged") === true) {
                            w.push({
                                FileName: D || H + A,
                                FriendlyFileName: H + A,
                                UploadedFile: ae,
                                FileTypeID: F,
                                DownloadID: 0,
                                Description: r
                            })
                        }
                    } else {
                        U = $(v[M]).data("originalFile");
                        ag = ae;
                        G = F || $(v[M]).data("fileTypeId");
                        u = $(v[M]).data("id");
                        t = {};
                        if (U && G && u) {
                            t.DownloadID = u || 0;
                            t.FileName = D || H + A;
                            t.FriendlyFileName = H + A || "";
                            t.FileTypeID = G || 0;
                            t.Description = r || "";
                            if (U != D) {
                                t.OriginalFile = U
                            }
                            if (ag !== undefined && ag !== "") {
                                t.UploadedFile = ag
                            }
                            w.push(t)
                        } else {
                            if (typeof G === "number" && G > 0 && r && r != "") {
                                w.push({
                                    FileName: D || H + A,
                                    FriendlyFileName: H + A,
                                    UploadedFile: ae,
                                    FileTypeID: F,
                                    DownloadID: 0,
                                    Description: r
                                })
                            }
                        }
                    }
                }
            }
            if (I) {
                $("#site-modal .modal-body").scrollTop(1);
                return false
            }
            if (this.assignment === undefined || this.copyId > 0) {
                this.assignment = new b.Ms.Assignment({
                    AssignmentTypeId: af,
                    ShortDescription: ad,
                    LongDescription: R,
                    IncGradeBook: L,
                    AbbrDescription: n,
                    MaxPoints: S,
                    Factor: C,
                    ExtraCredit: B,
                    IncCumGrade: K,
                    PublishGrade: W,
                    DropboxInd: false,
                    DropboxNumFiles: 0,
                    DropboxTimeLate: e.buildTimeString(23, 59, 0),
                    SectionLinks: ac,
                    LinkItems: Q,
                    DownloadItems: w,
                    SendNotification: false,
                    Notifications: [],
                    HasGrades: (aj.options.assignment == undefined) ? false : aj.options.assignment.get("HasGrades"),
                    DiscussionInd: true,
                    ShareDiscussion: aa,
                    AlwaysShowDiscussion: ab,
                    AllowDiscussionAttach: o,
                    Embed: $("#discussion-embed-box").val()
                });
                if (this.copyId > 0) {
                    this.assignment.set("AssessmentCopyId", this.copyAssessmentId)
                }
            } else {
                this.assignment.set({
                    AssignmentTypeId: af,
                    ShortDescription: ad,
                    LongDescription: R,
                    IncGradeBook: L,
                    AbbrDescription: n,
                    MaxPoints: S,
                    Factor: C,
                    ExtraCredit: B,
                    IncCumGrade: K,
                    PublishGrade: W,
                    DropboxInd: false,
                    DropboxNumFiles: 0,
                    DropboxTimeLate: e.buildTimeString(23, 59, 0),
                    SectionLinks: ac,
                    LinkItems: Q,
                    DownloadItems: w,
                    SendNotification: false,
                    Notifications: [],
                    HasGrades: (aj.options.assignment == undefined) ? false : aj.options.assignment.get("HasGrades"),
                    DiscussionInd: true,
                    ShareDiscussion: aa,
                    AlwaysShowDiscussion: ab,
                    AllowDiscussionAttach: o,
                    Embed: $("#discussion-embed-box").val()
                })
            }
            this.assignment.save({}, {
                success: function(ak, al) {
                    if (z.currentTarget.id == "btnSaveEdit") {
                        aj.trigger("saveEditDiscussion", al, ak);
                        $("#site-modal").modal("hide")
                    } else {
                        if (z.currentTarget.id == "btnSaveAdd") {
                            aj.trigger("saveAddDiscussion", al, ak)
                        } else {
                            aj.trigger("saveDiscussion", al, ak);
                            $("#site-modal").modal("hide")
                        }
                    }
                },
                error: function(ak, al) {
                    p3.displayError("Error creating assignment")
                }
            })
        },
        getSectionListForAssignment: function() {
            var s = this;
            var r = new b.Cs.SectionsForTeacher({}, {
                    sectionId: 0
                }),
                o, p;
            r.remove(r.at(0));
            b.Data.TeacherSections.each(function(t) {
                r.add(t.clone())
            });
            if (!s.AddMode) {
                var n = r.pluck("SectionId");
                var q = s.assignment.get("SectionLinks");
                for (o = 0; o < q.length; o++) {
                    if (n.indexOf(q[o].SectionId) == -1) {
                        p = new b.Ms.SectionForTeacher({
                            SectionId: q[o].SectionId,
                            GroupName: q[o].Section.Name,
                            IsSelected: 1,
                            LeadSectionId: q[o].SectionId,
                            HasGrades: q[o].HasGrades,
                            HasAssessmentResults: q[o].HasAssessmentResults
                        });
                        r.add(p)
                    } else {
                        if (q[o].HasGrades || q[o].HasAssessmentResults) {
                            b.Us.SyncSections(r, q, o)
                        }
                    }
                }
            }
            return r
        },
        showGroupDialog: function(n) {
            var p = this;
            $("#show-more-groups").button("loading");
            var o = [];
            $(".add-assignment-section-selector").each(function(q) {
                o.push("null_" + $(this).val())
            });
            h.Us.showGroupPickerDialog(58, o, p);
            return false
        },
        addSelectedGroups: function(n) {
            var r = this,
                o;
            b.Us.addSelectedGroups(r, n);
            var p = r.getSectionListForAssignment().pluck("LeadSectionId");
            var q = "";
            for (o = 0; o < p.length; o++) {
                if (q.length > 0) {
                    q += ","
                }
                q += p[o].toString()
            }
            for (o = 0; o < n.length; o++) {
                if (q.length > 0) {
                    q += ","
                }
                q += n[o].leadSectionId.toString()
            }
            r.markingPeriods.fetch({
                data: {
                    sectionList: q
                },
                success: function(w, D) {
                    var E = $(".grade-book-tooltip-location"),
                        B, F, t, y, u, v, z, A, C, x;
                    for (o = 0; o < E.length; o++) {
                        F = $(E[o]).data("sectionId");
                        if (F && F > 0) {
                            B = b.Us.GetMarkingPeriods(w, F);
                            if (B.length === 0) {
                                $(E[o]).hide()
                            } else {
                                C = "<strong>Marking Periods:</strong><br>Due date must fall within a marking period for this assignment to be included in Grade Book.<br>";
                                for (x = 0; x < B.length; x++) {
                                    t = B[x].get("begin_date");
                                    y = B[x].get("end_date");
                                    if (typeof t === "string" && typeof y === "string") {
                                        u = e.getDateString(e.getDate(t));
                                        v = e.getTimeString(e.getTime(t));
                                        z = e.getDateString(e.getDate(y));
                                        A = e.getTimeString(e.getTime(y));
                                        C += B[x].get("marking_period_description") + "<br><div>Begin: " + u + " " + v + "<br>End: " + z + " " + A + "<br></div>"
                                    }
                                }
                                $(E[o]).show().tooltip({
                                    title: C
                                })
                            }
                        }
                    }
                },
                error: function(s, t) {
                    p3.displayError("Failed to retreive the Marking Periods")
                }
            })
        },
        loadAssignment: function(p) {
            var B = this,
                w, A = p.SectionLinks[w],
                q, z, o, s, y, x, r, n, t, v, u;
            $("#name-box").val(p.ShortDescription);
            $("#description-box").val(p.LongDescription);
            $("#assignment-type-drop").val(p.AssignmentTypeId);
            if (p.ShareDiscussion) {
                $("#btn-share-yes").addClass("active");
                $("#btn-share-no").removeClass("active")
            } else {
                $("#btn-share-no").addClass("active");
                $("#btn-share-yes").removeClass("active")
            }
            if (p.AlwaysShowDiscussion) {
                $("#btn-anytime").addClass("active");
                $("#btn-after-post").removeClass("active")
            } else {
                $("#btn-after-post").addClass("active");
                $("#btn-anytime").removeClass("active")
            }
            if (p.AllowDiscussionAttach) {
                $("#btn-attach-yes").addClass("active");
                $("#btn-attach-no").removeClass("active")
            } else {
                $("#btn-attach-no").addClass("active");
                $("#btn-attach-yes").removeClass("active")
            }
            $("#abbrev-box").val(p.AbbrDescription);
            $("#max-point-box").val(p.MaxPoints);
            $("#factor-box").val(p.Factor);
            if (p.IncGradeBook) {
                $("#gradebook-check").prop("checked", true)
            } else {
                $("#gradebook-check").prop("checked", false)
            }
            if (p.IncCumGrade) {
                $("#cumulative-check").prop("checked", true)
            } else {
                $("#cumulative-check").prop("checked", false)
            }
            if (p.ExtraCredit) {
                $("#extra-credit-check").prop("checked", true)
            } else {
                $("#extra-credit-check").prop("checked", false)
            }
            if (p.PublishGrade) {
                $("#publish-grade-check").prop("checked", true)
            } else {
                $("#publish-grade-check").prop("checked", false)
            }
            $(".add-assignment-section-selector").prop("checked", false);
            for (w = 0; w < p.SectionLinks.length; w++) {
                A = p.SectionLinks[w];
                q = $("#add-assignment-sections-listing tr td label input[value = " + A.SectionId + "]");
                z = q.parents("tr");
                o = $(z).children("td")[1];
                s = $(z).children("td")[2];
                y = $(z).children("td")[3];
                $(z).show();
                $(q).prop("checked", true);
                $(o).children("input:first").val(e.displayDate(A.AssignmentDate, "shortDate"));
                $(o).children("input:last").val(e.displayTime(A.AssignmentTime, false, "shortTime"));
                $(s).children("input:first").val(e.displayDate(A.DueDate, "shortDate"));
                $(y).children("select").val(A.PublishOnAssignedInd ? 2 : A.PublishInd ? 1 : 0)
            }
            $(".add-assignment-section-selector:input:checkbox[checked!='checked']").closest("tr").remove();
            if (p.LinkItems.length > 0) {
                for (w = 0; w < p.LinkItems.length; w++) {
                    x = p.LinkItems[w];
                    n = $("#add-assignment-links-tab").children(":last");
                    if ($(n).find("input:first").val() !== "" && $(n).find("input:last").val() !== "") {
                        $(n).find(".link-delete-button").show();
                        B.addLinkControl();
                        n = $("#add-assignment-links-tab").children(":last")
                    }
                    $(n).find("input:first").val(x.ShortDescription);
                    $(n).find("input:last").val(x.Url);
                    $(n).data("id", x.LinkID);
                    $(n).find(".link-delete-button").show();
                    B.addLinkControl()
                }
            }
            if (p.DownloadItems.length > 0) {
                for (w = 0; w < p.DownloadItems.length; w++) {
                    r = p.DownloadItems[w];
                    n = $("#add-assignment-downloads-tab").children(":last");
                    if ($(n).find("input:first").val() !== "" && $(n).find("a.assignment-download-file-field:last").val() !== "") {
                        $(n).find(".download-delete-button").show();
                        B.addDownloadControl();
                        n = $("#add-assignment-downloads-tab").children(":last")
                    }
                    t = r.FileName;
                    v = r.FriendlyFileName || r.FileName;
                    u = $(n).find("input:first").parent().next();
                    $(n).find("input:last").val(r.ShortDescription);
                    u.data("rawFile", t);
                    $(n).find("input.assignment-download-file-name").data("fileType", r.FileTypeID);
                    u.val(v.substring(0, v.lastIndexOf(".")));
                    u.next().html(t.substring(t.lastIndexOf(".")));
                    $(n).find("input:first").siblings("span:first").html("Change");
                    $(n).data("id", r.DownloadID);
                    $(n).data("originalFile", t);
                    $(n).data("fileTypeId", r.FileTypeID);
                    $(n).find(".download-delete-button").show();
                    B.addDownloadControl()
                }
            }
            $("#discussion-embed-box").val(p.Embed)
        },
        assignmentTypeDefaultMaxPoint: function(o) {
            var n = _.first(b.Data.Types.where({
                AssignmentTypeId: parseInt($(o.target).val(), 10)
            }));
            if (n && this.$el.find("#max-point-box").val() === "") {
                this.$el.find("#max-point-box").val(n.get("DefaultMaxPoints"))
            }
        },
        doApplyToSelected: function(n) {
            b.Us.DoApplyToSelected();
            return false
        },
        doSelectionToggle: function(n) {
            b.Us.DoSelectionToggle(n)
        },
        toggleGradeBook: function(n) {
            b.Us.ToggleGradeBook()
        },
        addLinkControl: function() {
            b.Us.addLinkControl(this)
        },
        addDownloadControl: function() {
            b.Us.addDownloadControl(this)
        },
        deleteLinkItem: function(n) {
            b.Us.deleteLinkItem(n, this);
            return false
        },
        deleteDownloadItem: function(n) {
            b.Us.deleteDownloadItem(n, this);
            return false
        },
        handleLinks: function(n) {
            b.Us.handleLinks(n, this);
            return false
        },
        handleDownloads: function(n) {
            b.Us.handleDownloads(n, this);
            return false
        },
        initializeFileUpload: function() {
            b.Us.initializeFileUpload(this)
        }
    });
    b.Us.DoApplyToSelected = function() {
        var n = $("#assignment-default-assigned-date").val(),
            o = $("#assignment-default-assigned-time").val(),
            p = $("#assignment-default-due-date").val(),
            q = $("#assignment-default-publish-option").val(),
            r = $("#assignment-default-notification-send").attr("checked"),
            u = $("#add-assignment-sections-listing").children("tr"),
            v = $($(u).children("td")).children("label").children("input:checked.add-assignment-section-selector"),
            t, s;
        for (t = 0; t < v.length; t++) {
            s = $(v[t]).val();
            $("#" + s + "-assigned-date").val(n);
            $("#" + s + "-assigned-time").val(o);
            $("#" + s + "-assigned-time").setTime(o);
            $("#" + s + "-due-date").val(p);
            $("#" + s + "-publish-option").val(q);
            if (r === "checked") {
                $("#" + s + "-notification-send").prop("checked", true)
            } else {
                $("#" + s + "-notification-send").prop("checked", false)
            }
        }
        $("#publish-options-apply-selected-button").removeClass("btn-primary");
        $("#publish-options-warning-message").hide("slow")
    };
    b.Us.DoSelectionToggle = function(n) {
        var o = $(n.target).filter(":checked");
        if (o.length > 0) {
            $(".add-assignment-section-selector:visible").prop("checked", true)
        } else {
            $(".add-assignment-section-selector:visible").prop("checked", false);
            $(".add-assignment-section-selector:disabled").prop("checked", true)
        }
    };
    b.Us.ToggleGradeBook = function() {
        if ($("#gradebook-check").is(":checked")) {
            $("#cumulative-check").prop("disabled", false);
            $("#extra-credit-check").prop("disabled", false);
            $("#publish-grade-check").prop("disabled", false);
            $("#abbrev-box").prop("disabled", false);
            $("#max-point-box").prop("disabled", false);
            $("#factor-box").prop("disabled", false)
        } else {
            $("#cumulative-check").prop("disabled", true);
            $("#extra-credit-check").prop("disabled", true);
            $("#publish-grade-check").prop("disabled", true);
            $("#abbrev-box").prop("disabled", true);
            $("#max-point-box").prop("disabled", true);
            $("#factor-box").prop("disabled", true)
        }
    };
    b.Us.FetchAssignmentTypes = function(n) {
        if (n === undefined) {
            b.Data.Types = new b.Cs.AssignmentTypesAll();
            b.Data.Types.fetch({
                async: false
            })
        } else {
            b.Data.Types = new b.Cs.AssignmentTypes();
            b.Data.Types.fetch({
                data: {
                    sectionId: n
                },
                async: false
            })
        }
    };
    b.Us.FetchTeacherSections = function(r, q, p, o) {
        var n;
        if (q) {
            n = 0
        } else {
            if (p) {
                n = 1
            } else {
                n = 2
            }
        }
        b.Data.TeacherSections = new b.Cs.SectionsForTeacher({}, {
            sectionId: r,
            filterInd: n
        });
        b.Data.TeacherSections.fetch({
            async: false,
            error: function() {
                p3.displayError("Error loading sections list.")
            }
        })
    };
    b.Us.AddAssignmentView = function(p) {
        b.Us.registerHelpers();
        b.Us.FetchAssignmentTypes(b.Data.currentLeadSectionId);
        var q = new b.Vs.AddAssignmentView(p);
        var n;
        if (p && p.edit) {
            n = 55
        } else {
            n = 54
        }
        var o = new j.Cs.NotificationActive({}, {
            actionId: n
        });
        o.fetch({
            success: function() {
                o.setNotificationProperties();
                q.notifEnabled = o.enabled;
                q.notifTooltip = o.tooltip;
                p3.rV(q, p3.Layout.Containers.Modal, true);
                p3.showModal(p3.Layout.Containers.Modal);
                p3.Layout.Containers.Modal.on("hide.assignmentEdit", function() {
                    if (tinyMCE !== undefined) {
                        tinyMCE.execCommand("mceRemoveControl", false, "add-assignment-title-field");
                        tinyMCE.execCommand("mceRemoveControl", false, "add-assignment-description-field")
                    }
                    p3.Layout.Containers.Modal.off("hide.assignmentEdit");
                    p3.Layout.Containers.Modal.off("postRender")
                })
            },
            error: function() {
                p3.displayError("Error loading notification settings")
            }
        });
        return q
    };
    b.Us.AddAssessmentView = function(n, p) {
        b.Us.registerHelpers();
        if (b.Data.currentLeadSectionId === undefined) {
            b.Data.Types = new b.Cs.AssignmentTypesAll();
            b.Data.Types.fetch({
                async: false
            })
        } else {
            b.Data.Types = new b.Cs.AssignmentTypes();
            b.Data.Types.fetch({
                data: {
                    sectionId: b.Data.currentLeadSectionId
                },
                async: false
            })
        }
        var q = new b.Vs.AssessmentEditView();
        if (n) {
            q.AddMode = false;
            q.assignment = n;
            p3.rV(q, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal)
        } else {
            if (p > 0) {
                q.copyId = p;
                q.AddMode = false;
                var o = new b.Ms.Assignment();
                o.set("AssignmentId", p);
                o.fetch({
                    error: function() {
                        p3.displayError("Error loading assignment")
                    },
                    success: function(r, s) {
                        o.set("ShortDescription", "Copy of " + o.get("ShortDescription"));
                        q.assignment = o;
                        q.copyAssessmentId = o.get("AssessmentId");
                        p3.rV(q, p3.Layout.Containers.Modal, true);
                        p3.showModal(p3.Layout.Containers.Modal)
                    }
                })
            } else {
                q.AddMode = true;
                p3.rV(q, p3.Layout.Containers.Modal, true);
                p3.showModal(p3.Layout.Containers.Modal)
            }
        }
        return q
    };
    b.Us.AddDiscussionView = function(n, p) {
        b.Us.registerHelpers();
        if (b.Data.currentLeadSectionId === undefined) {
            b.Data.Types = new b.Cs.AssignmentTypesAll();
            b.Data.Types.fetch({
                async: false
            })
        } else {
            b.Data.Types = new b.Cs.AssignmentTypes();
            b.Data.Types.fetch({
                data: {
                    sectionId: b.Data.currentLeadSectionId
                },
                async: false
            })
        }
        var q = new b.Vs.DiscussionEditView();
        if (n) {
            q.AddMode = false;
            q.assignment = n;
            p3.rV(q, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal)
        } else {
            if (p > 0) {
                q.copyId = p;
                q.AddMode = false;
                var o = new b.Ms.Assignment();
                o.set("AssignmentId", p);
                o.fetch({
                    error: function() {
                        p3.displayError("Error loading assignment")
                    },
                    success: function(r, s) {
                        o.set("ShortDescription", "Copy of " + o.get("ShortDescription"));
                        q.assignment = o;
                        q.copyAssessmentId = o.get("AssessmentId");
                        p3.rV(q, p3.Layout.Containers.Modal, true);
                        p3.showModal(p3.Layout.Containers.Modal)
                    }
                })
            } else {
                q.AddMode = true;
                p3.rV(q, p3.Layout.Containers.Modal, true);
                p3.showModal(p3.Layout.Containers.Modal)
            }
        }
        return q
    };
    b.Us.EditAssignmentView = function(o, p) {
        b.Us.FetchAssignmentTypes();
        b.Us.registerHelpers();
        var n = new b.Ms.Assignment();
        var q;
        n.set("AssignmentId", o);
        n.useSecureGet = true;
        n.fetch({
            async: false,
            error: function() {
                n.useSecureGet = false;
                p3.displayError("Error loading assignment")
            },
            success: function(r, s) {
                n.useSecureGet = false;
                q = b.Us.AddAssignmentView({
                    assignment: r,
                    title: "Edit Assignment",
                    edit: true,
                    AddMode: false
                });
                if (p) {
                    q.on(p.event, p.execute)
                }
            }
        });
        return q
    };
    b.Us.updateAssignments = function(n) {
        if (b.Data.assignments) {
            b.Data.assignments.reset({}, {
                silent: true
            });
            if (b.Data.assignments.dateSort != null || (b.Data.assignments.startDate != null && b.Data.assignments.endDate != null)) {
                b.Data.assignments.fetch({
                    error: function(o, p) {
                        p3.displayError("Error loading assignments")
                    }
                })
            }
            if (n && b.Data.assignments.sectionId) {
                b.Us.RefreshSectionAssignmentTypes(b.Data.assignments.sectionId)
            }
        }
    };
    b.Us.RefreshSectionAssignmentTypes = function(n) {
        if (b.Data.types !== undefined) {
            b.Data.types.fetch({
                data: {
                    sectionId: n
                },
                error: function() {
                    p3.displayError("Error loading assignment types")
                }
            })
        }
    };
    b.Us.LoadDateTimePickers = function(n) {
        f.Us.initialize(".dp-non-pre-pop");
        m.Us.initialize(".time-picker-field");
        f.Us.LoadPreSelDatePickers(n)
    };
    b.Us.showHtmlEditor = function() {
        p3.showHtmlEditor("myeditor", p3.Us.Enum.HtmlEditorCategories.FULL, false, undefined, p3.Us.Enum.HtmlEditorEncoding.NUMERIC)
    };
    b.Us.registerHelpers = function() {
        if (!Hb.helpers.DropBoxFileNumberSelector) {
            Hb.registerHelper("DropBoxFileNumberSelector", function(o, q) {
                var r = "",
                    n = "",
                    p;
                for (p = 0; p < 11; p++) {
                    n = (p == o) ? ' selected="selected"' : "";
                    r += q.fn({
                        index: p,
                        selectMe: n
                    })
                }
                return r
            })
        }
        if (!Hb.helpers.AssignmentListing) {
            Hb.registerHelper("AssignmentListing", function(n, r) {
                var s = "",
                    o, q, p;
                if (n && n.length > 0) {
                    s = '<tbody><tr style="display: none;"><td></td></tr>';
                    for (o = 0, q = n.length; o < q; o++) {
                        p = n[o];
                        p.hide = (o > 9) ? "none" : "";
                        s += r.fn(p)
                    }
                    s += "</tbody>"
                }
                s += "</table>";
                if (n && n.length > 10) {
                    s += '<a href class="btn btn-default assignment-table-button">Show More</a><br/><br/>'
                }
                return s
            })
        }
        if (!Hb.helpers.AssignmentDetailLink) {
            Hb.registerHelper("AssignmentDetailLink", function(n, p) {
                var r = "",
                    q = p3.Data.Context.getSelectedPersona().Id,
                    o = d.Us.isStudentDetailLinkAvailable(n, q);
                if (o) {
                    if (n.AssessmentInd) {
                        var s;
                        if (q == 1) {
                            s = a.Data.studentId
                        } else {
                            s = p3.Data.Context.get("UserInfo").UserId
                        }
                        r += '<a href="#assessmentdetail/' + n.AssignmentId + "/" + n.AssignmentIndexId + "/0/" + s + '/0">'
                    } else {
                        if (q == 1) {
                            r += '<a href="' + d.Us.BuildAssignmentDetailLink(n.AssignmentId, n.AssignmentIndexId, a.Data.studentId, 0) + '">'
                        } else {
                            if (n.DiscussionInd) {
                                if (q == 2) {
                                    r += '<a href="#discussiondetail/' + n.AssignmentId + "/" + n.AssignmentIndexId + '">'
                                } else {
                                    r += '<a href="#discussionsectiondetail/' + n.AssignmentId + "/" + n.AssignmentIndexId + '/0">'
                                }
                            } else {
                                r += '<a href="' + d.Us.BuildAssignmentDetailLink(n.AssignmentId, n.AssignmentIndexId, null, 0) + '">'
                            }
                        }
                    }
                } else {
                    r += '<p class="assignment-list-text">'
                }
                r += p.fn(n);
                if (o) {
                    r += "</a>"
                } else {
                    r += "</p>"
                }
                return r
            })
        }
        if (!Hb.helpers.AssignmentListStatus) {
            Hb.registerHelper("AssignmentListStatus", function(u, v) {
                var y = "",
                    p = true,
                    o = "",
                    A = "",
                    w = false,
                    r = true,
                    B = e.getDate(u.LocalNow),
                    s = e.getDate(u.DueDate),
                    x = p3.Data.Context.getSelectedPersona().Id,
                    n = e.getDate(u.DateAssigned),
                    q = true,
                    z = (p3.Config.uiVersion === 3) ? "" : ' style="width:85px;"';
                if (B > s) {
                    w = true
                }
                if (u.DropBoxInd || u.DiscussionInd) {
                    p = false
                } else {
                    if (u.AssignmentStatus == 1) {
                        if (w) {
                            p = false
                        }
                    }
                }
                if (x === 2) {
                    switch (u.AssignmentStatus) {
                        case -1:
                            if (u.AssessmentInd) {
                                if (B < n) {
                                    q = false
                                } else {
                                    A = "Take";
                                    o = " btn-info"
                                }
                            } else {
                                A = u.DropBoxInd ? "Submit" : "To Do";
                                o = " btn-info"
                            }
                            break;
                        case 0:
                            A = "In&nbsp;Progress";
                            o = " btn-warning";
                            break;
                        case 1:
                            A = u.HasGrade ? "Graded" : "Completed";
                            o = " btn-success";
                            r = u.dropboxInd ? false : true;
                            break;
                        case 2:
                            A = "Overdue";
                            o = " btn-danger";
                            break;
                        case 3:
                            A = "Retake";
                            o = " btn-info";
                            break;
                        case 4:
                            A = "Graded";
                            o = " btn-success";
                            r = false;
                            break;
                        case 5:
                            A = "Upcoming";
                            break
                    }
                    if (u.AssessmentInd) {
                        switch (u.AssignmentStatus) {
                            case -1:
                            case 3:
                            case 1:
                            case 4:
                                if (q) {
                                    var t = "p3icon-notification";
                                    if (u.AssignmentStatus == 1) {
                                        t = "p3icon-check"
                                    } else {
                                        if (u.AssignmentStatus == 4) {
                                            t = "p3icon-ok"
                                        }
                                    }
                                    y = '<a class="btn btn-default ' + o + '"' + z + ' href="#assessment/' + u.AssignmentId + "/" + u.AssignmentIndexId + '/false"><i class="' + t + ' iconColor"></i> ' + A + "</a>"
                                } else {
                                    y = '<button style="margin-top:0px;width:107px;" class="btn btn-default">Upcoming</button>'
                                }
                                break;
                            case 0:
                                y = '<button style="margin-top:0px;" class="btn btn-default assignment-status-button btn-warning"><h5><i class="p3icon-notification iconColor"></i>&nbsp;Incomplete</h5></button>';
                                break;
                            case 2:
                                y = '<button style="margin-top:0px;" class="btn btn-default assignment-status-button btn-danger"><h5><i class="p3icon-notification iconColor"></i> Overdue</h5></button>';
                                break;
                            case 6:
                                y = '<a class="btn btn-default btn-warning"' + z + ' href="#assessment/' + u.AssignmentId + "/" + u.AssignmentIndexId + '/true"><i class="p3icon-notification iconColor"></i> Resume</a>';
                                break
                        }
                    } else {
                        if (p && r) {
                            y = '<div class="btn-group assignment-status-container" data-status="' + u.AssignmentStatus + '" data-indexId="' + u.AssignmentIndexId + '">';
                            y += '<button class="btn btn-default assignment-status-button dropdown-toggle' + o + '" data-toggle="dropdown">';
                            y += ' <span class="caret"></span> ' + A + "</button>";
                            y += '<ul class="dropdown-menu assignment-status-button">';
                            if (!w) {
                                y += '<li><a href class="assignment-status-link" data-status="-1">To Do</a></li>'
                            }
                            y += '<li><a href class="assignment-status-link" data-status="0">In Progress</a></li>';
                            y += '<li><a href class="assignment-status-link" data-status="1">Completed</a></li>';
                            y += "</ul></div>"
                        } else {
                            switch (u.AssignmentStatus) {
                                case 1:
                                    y = '<button class="btn btn-default assignment-status-button' + o + '"> <i class="p3icon-check iconColor"></i>&nbsp;' + A + "</button>";
                                    break;
                                case 2:
                                    y = '<button style="margin-top:0px;" class="btn btn-default assignment-status-button btn-danger"><h5><i class="p3icon-notification iconColor"></i> Overdue</h5></button>';
                                    break;
                                case 4:
                                    y = '<button class="btn btn-default assignment-status-button' + o + '"> <i class="p3icon-ok iconColor"></i>&nbsp;' + A + "</button>";
                                    break;
                                case 5:
                                    y = '<button style="margin-top:0px;width:107px;" class="btn btn-default">Upcoming</button>';
                                    break;
                                default:
                                    y = '<button class="btn btn-default assignment-status-button' + o + '"> <i class="p3icon-assignmentUpload iconColor"></i>&nbsp;' + A + "</button>";
                                    break
                            }
                        }
                    }
                }
                return '<td data-heading="Status">' + y + "</td>"
            })
        }
        if (!Hb.helpers.fileSizeDisplay) {
            Hb.registerHelper("fileSizeDisplay", function(o) {
                if (o === undefined || o === null) {
                    return ""
                }
                var p = o,
                    n = 0,
                    q = "",
                    r = ["B", "KB", "MB", "GB", "TB", "PB"];
                while (p > 1024) {
                    p = (p / 1024);
                    n++
                }
                q = r[n];
                return Math.round(p * 100) / 100 + " " + q
            });
            Hb.registerPartial("dropBoxFileDetail", '<div class="well"><dl class="dl-horizontal"><dt class="muted">Download(s)</dt><dd>{{#each files}}<a target="_blank" href="{{fileUrl}}">{{fileName}}</a>{{/each}}<button class="btn" data-url="{{fileUrl}}"><i class="icon-trash"></i></button></dd></dl><button class="btn" data-url="{{filePath}}">Allow Resubmission</button>')
        }
        if (!Hb.helpers.sectionIsShownInPublishOptions) {
            Hb.registerHelper("sectionIsShownInPublishOptions", function(n, o) {
                if (n.IsSelected || n.IsCurrent) {
                    return o.fn(n)
                }
                return ""
            })
        }
    };
    b.Us.addSelectedGroups = function(I, n) {
        if (n.length > 0) {
            var E = "";
            var o = [];
            var H = e.localDateTime();
            var t = e.getDateString(H);
            var G = e.buildTimeString(0, 0, 0);
            var x = p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADEBOOK);
            var C = "";
            var z = 0,
                y, F, A, p, u, q, r, v, w, D, s;
            for (y = 0; y < n.length; y++) {
                z = n[y].leadSectionId;
                if (y > 0) {
                    E += ","
                }
                E += z;
                o.push({
                    LeadSectionId: z
                });
                C = '<tr><td><label class="checkbox"><input class="add-assignment-section-selector" type="checkbox" value="' + z + '" checked="checked">' + n[y].courseTitle + "</td></label>";
                C += '<td class="control-group"><input id="' + z + '-assigned-date" type="text" class="input-mini date-picker-field dp-' + z + '" value="' + t + '"> <input id="' + z + '-assigned-time" type="text" class="input-mini time-picker-field" placeholder="' + G + '"></td>';
                C += '<td class="control-group"><input id="' + z + '-due-date" type="text" class="input-mini date-picker-field dp-' + z + '" >';
                if (x && !this.AddExisting) {
                    C += '<i class="p3icon-gradebook grade-book-tooltip-location" data-section-id="' + z + '"></i>'
                }
                C += "</td>";
                C += '<td><select id="' + z + '-publish-option" class="input-small publish-options"><option value="1">Now</option><option value="2">Assigned Date</option><option value="0">No</option></select></td>';
                if (!I.AddMode) {
                    C += '<td><label class="checkbox"><input';
                    if (!I.notifEnabled) {
                        C += ' disabled="disabled"'
                    }
                    C += ' type="checkbox" id="' + z + '-notification-send" value="option1"><span class="send-notif-label"';
                    if (!I.notifEnabled) {
                        C += ' rel="tooltip" data-original-title="' + I.notifTooltip + '"'
                    }
                    C += ">Yes</span></label></td>"
                }
                C += "</tr>";
                if ($("#add-assignment-sections-listing tr:last").length > 0) {
                    $("#add-assignment-sections-listing tr:last").after(C)
                } else {
                    $("#add-assignment-sections-listing").html(C)
                }
            }
            f.Us.LoadPreSelDatePickers(o);
            $(".time-picker-field").timepicker({
                render24Hour: e.is24HourFormat()
            });
            $(".send-notif-label").tooltip();
            if (x && !this.AddExisting) {
                var B = new b.Cs.MarkingPeriods();
                B.fetch({
                    data: {
                        sectionList: E
                    },
                    success: function(J, K) {
                        for (y = 0; y < n.length; y++) {
                            F = n[y].leadSectionId;
                            A = b.Us.GetMarkingPeriods(J, F);
                            if (A.length === 0) {
                                $('.grade-book-tooltip-location[data-section-id="' + F + '"]').hide()
                            } else {
                                D = "<strong>Marking Periods:</strong><br>Due date must fall within a marking period for this assignment to be included in Grade Book.<br>";
                                for (s = 0; s < A.length; s++) {
                                    p = A[s].get("begin_date");
                                    u = A[s].get("end_date");
                                    if (typeof p === "string" && typeof u === "string") {
                                        q = e.getDateString(e.getDate(p));
                                        r = e.getTimeString(e.getTime(p));
                                        v = e.getDateString(e.getDate(u));
                                        w = e.getTimeString(e.getTime(u));
                                        D += A[s].get("marking_period_description") + "<br><div>Begin: " + q + " " + r + "<br>End: " + v + " " + w + "<br></div>"
                                    }
                                }
                                $('.grade-book-tooltip-location[data-section-id="' + F + '"]').show().tooltip({
                                    title: D
                                })
                            }
                        }
                    },
                    error: function(J, K) {
                        p3.displayError("Failed to retreive the Marking Periods")
                    }
                })
            }
        }
    };
    b.Us.RenderEditModal = function(o, n) {
        if (b.Data.TeacherSections === undefined) {
            b.Data.TeacherSections = new b.Cs.SectionsForTeacher();
            o.emptysections = true;
            o.SectionsForTeacher = new b.Cs.ExistingSections();
            o.SectionsForTeacher.fetch({
                async: false,
                data: {
                    schoolYear: p3.Data.SchoolContext.get("CurrentSchoolYear").SchoolYearLabel,
                    facultyUserId: p3.Data.Context.get("UserInfo").UserId
                },
                success: function(p, q) {
                    p.each(function(s) {
                        if (s.get("isCurrent") === 1) {
                            var u = s.get("SectionId"),
                                r = s.get("Name"),
                                t = new Bbm();
                            t.set({
                                IsSelected: false,
                                IsCurrent: true,
                                LeadSectionId: u,
                                GroupName: r,
                                SectionId: u
                            });
                            b.Data.TeacherSections.add(t, {
                                silent: true
                            })
                        }
                    })
                }
            })
        }
        p3.fT(o.template, function(v) {
            var t = o.getSectionListForAssignment(),
                q, u, r;
            q = (o.assignment) ? o.assignment.get("AssignmentTypeId") : null;
            o.$el.html(v({
                AddMode: o.AddMode,
                assignmentTypes: [{
                    Type: "-- Select An Assignment Type --",
                    AssignmentTypeId: 0
                }].concat(b.Data.Types.toJSON()),
                edit: o.options ? o.options.edit || false : false,
                gradebookInd: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADEBOOK),
                sections: t.toJSON(),
                gradebookDefault: p3.Data.Context.get("UserInfo").GradebookDefaultInd,
                copyId: o.copyId,
                existingAssignmentTypeId: q
            }));
            $(".section-label").tooltip();
            if (o.assignment !== undefined && o.assignment != null && o.assignment.get("AssignmentId") > 0) {
                o.loadAssignment(o.assignment.toJSON())
            } else {
                var w = e.localDateTime();
                $("#assignment-default-assigned-date").val(e.getDateString(w));
                t = $("#add-assignment-sections-listing tr");
                for (r = 0; r < t.length; r++) {
                    $($(t[r]).children("td")[1]).children("input:first").val(e.getDateString(w))
                }
            }
            b.Us.LoadDateTimePickers(b.Data.TeacherSections.toJSON());
            if (p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADEBOOK)) {
                var s = o.getSectionListForAssignment().pluck("LeadSectionId");
                t = "";
                for (r = 0; r < s.length; r++) {
                    if (t.length > 0) {
                        t += ","
                    }
                    t += s[r].toString()
                }
                c.Us.getAssignmentOptionDefaults();
                if (p3.Data.LMS.DefaultTime) {
                    u = e.getTimeString(e.getDate(e.getDateString() + " " + p3.Data.LMS.DefaultTime))
                } else {
                    u = e.buildTimeString(0, 0, 0)
                }
                $("#add-assignment-sections-listing").find(".time-picker-field").attr("placeholder", u);
                $("#assignment-default-assigned-time").attr("placeholder", u);
                o.markingPeriods.fetch({
                    data: {
                        sectionList: t
                    },
                    success: function(A, H) {
                        var I = $(".grade-book-tooltip-location"),
                            J, F, G, B, x, C, y, z, D, E;
                        for (r = 0; r < I.length; r++) {
                            J = $(I[r]).data("sectionId");
                            if (J && J > 0) {
                                F = b.Us.GetMarkingPeriods(A, J);
                                if (F.length === 0) {
                                    $(I[r]).hide()
                                } else {
                                    G = "<strong>Marking Periods:</strong><br>Due date must fall within a marking period for this assignment to be included in Grade Book.<br>";
                                    for (B = 0; B < F.length; B++) {
                                        x = F[B].get("begin_date");
                                        C = F[B].get("end_date");
                                        if (typeof x === "string" && typeof C === "string") {
                                            y = e.getDateString(e.getDate(x));
                                            z = e.getTimeString(e.getTime(x));
                                            D = e.getDateString(e.getDate(C));
                                            E = e.getTimeString(e.getTime(C));
                                            G += F[B].get("marking_period_description") + "<br><div>Begin: " + y + " " + z + "<br>End: " + D + " " + E + "<br></div>"
                                        }
                                    }
                                    $(I[r]).show().tooltip({
                                        title: G
                                    })
                                }
                            }
                        }
                    },
                    error: function(x, y) {
                        p3.displayError("Failed to retreive the Marking Periods")
                    }
                })
            }
            if (o.emptysections && o.AddMode) {
                $(".add-assignment-section-selector").prop("checked", false)
            }
            if ($(".add-assignment-section-selector:checked").length === 0) {
                $(".select-all-check").prop("checked", false)
            }
            var p = jQuery.Event("postRender");
            window.setTimeout(function() {
                p3.Layout.Containers.Modal.trigger(p);
                p3.showHtmlEditor(n, p3.Us.Enum.HtmlEditorCategories.FULL, false, undefined, p3.Us.Enum.HtmlEditorEncoding.NUMERIC);
                o.toggleGradeBook()
            }, 400)
        })
    };
    b.Us.addLinkControl = function(o) {
        var n = o.$("#add-assignment-links-tab");
        p3.fT(o.linkTemplate, function(p) {
            var q = p({});
            $(n).append(q);
            $(".assignment-link-field.assignment-conditional-required-field:last").focus()
        })
    };
    b.Us.addDownloadControl = function(p) {
        var n = p.$("#add-assignment-downloads-tab"),
            o = $(n).children(":last");
        if (o.find("input.assignment-download-file-name").val() !== "" && o.find("input:last").val() !== "") {
            p3.fT(p.downloadTemplate, function(q) {
                $(n).append(q({}));
                p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.jQueryUI, function() {
                    p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.FileUpload, function() {
                        $(".assignment-download-file-field").off("fileuploaddone fileuploadadd fileuploadprogress").fileupload({
                            url: p3.Config.RootPath + "utilities/FileTransferHandler.ashx",
                            autoUpload: true
                        }).on("fileuploaddone", function(s, r) {
                            $(s.target).parent().attr("data-active", false);
                            if (r.result[0] !== undefined) {
                                if (r.files[0].isValidUpload) {
                                    var u = $(s.target).parent().siblings("input.assignment-download-file-name"),
                                        t = r.files[0].name;
                                    $(u).data("attachedFileName", r.result[0].name);
                                    $(u).data("fileChanged", true);
                                    $(u).val(t.substring(0, t.lastIndexOf(".")));
                                    $(u).siblings("span:last").html(t.substring(t.lastIndexOf(".")));
                                    $(u).siblings("span:first").children("span").html("Change");
                                    $(s.target).parent().find("input:last").focus();
                                    $(u).trigger("change");
                                    $(".progress-container").hide();
                                    return false
                                }
                                if (!r.files[0].isValidUpload) {
                                    if ($("#assignment-editor-file-error-msg").length === 0) {
                                        $("#add-assignment-downloads-tab").find(".progress-container:first").after($("<div>").addClass("alert alert-error margin-file-error").attr("id", "assignment-editor-file-error-msg").html("The file " + r.files[0].name + " is not a supported type and was not uploaded."))
                                    } else {
                                        $("#assignment-editor-file-error-msg").html("The file " + r.files[0].name + " is not a supported type and was not uploaded.")
                                    }
                                }
                            }
                        }).on("fileuploadadd", function(s, r) {
                            $(s.target).parent().attr("data-active", true);
                            r.files[0].isValidUpload = p3.Us.FileTools.isValidFile(p3.Us.Enum.UploadType.All, r.files[0].name);
                            if ($("#assignment-editor-file-error-msg").length > 0) {
                                $("#assignment-editor-file-error-msg").remove()
                            }
                            if (r.files[0].isValidUpload) {
                                $(".bar").attr("style", "width: 0%");
                                $(".progress-text").html("Uploading... " + r.files[0].name);
                                $(".progress-container").show();
                                r.submit()
                            }
                        }).on("fileuploadprogress", function(s, r) {
                            var t = parseInt(r.loaded / r.total * 100, 10);
                            $(".bar").attr("style", "width: " + t + "%")
                        })
                    })
                });
                $("assignment-download-file-name:last").focus()
            })
        }
    };
    b.Us.deleteLinkItem = function(p, r) {
        var n = $(p.currentTarget);
        var q = n.parent("div").data("id");
        q = typeof q === "number" ? q : 0;
        if (q > 0) {
            var o = n.siblings(":first").val();
            n.siblings().replaceWith($("<span>", {
                "class": "alert alert-error",
                "data-id": q.toString(),
                "data-needs-delete": "true"
            }).html('The link "' + o + '" will be deleted upon clicking Save.'))
        } else {
            n.closest(".control-group").remove()
        }
    };
    b.Us.deleteDownloadItem = function(p, u) {
        var n = $(p.currentTarget);
        var t = n.parent("div").data("id");
        var r = n.parent("div").find("input.assignment-download-file-name").data("rawFile"),
            s = n.parent("div").find("input.assignment-download-file-name").val(),
            q = n.parent("div").find("input.assignment-download-file-name").next().html();
        t = typeof t === "number" ? t : 0;
        if (t > 0) {
            var o = n.siblings(":last").val();
            n.siblings().replaceWith($("<span>", {
                "class": "alert alert-error",
                "data-id": t.toString(),
                "data-needs-delete": "true",
                "data-filename": r + q
            }).html('The download "' + s + "." + q + '" (' + o + ") will be deleted once you click the Save button."))
        } else {
            n.closest(".control-group").remove()
        }
    };
    b.Us.handleLinks = function(q, v) {
        var o = v.$("#add-assignment-links-tab");
        var n = $(o).children(":last");
        var p = $(n).find("input:first"),
            u = $(n).find("input:last");
        if (p.val() !== "" && u.val() !== "") {
            $(n).find(".link-delete-button").show();
            b.Us.addLinkControl(v)
        } else {
            if (p.val() === "" && u.val() === "") {
                var s = $(n).prev();
                var r = $(s).find("input:first"),
                    t = $(s).find("input:last");
                if (r.val() === "" && t.val() === "") {
                    n.remove()
                }
            }
        }
    };
    b.Us.handleDownloads = function(q, x) {
        var o = x.$("#add-assignment-downloads-tab");
        var n = $(o).find('span.fileinput-button[data-active="true"]').parent();
        if (n.length === 0) {
            n = $(o).children(":last")
        }
        var p = $(n).find("input:last"),
            s = $(n).find("input.assignment-download-file-name");
        var r = $(s).data("attachedFileName");
        if (r === undefined && q.srcElement !== undefined && q.srcElement.files !== undefined && q.srcElement.files !== null && q.srcElement.files.length > 0) {
            r = q.srcElement.files[0].name;
            if (s.val() === "") {
                if (r && typeof r.substring === "function" && typeof r.lastIndexOf === "function") {
                    s.val(r.substring(0, r.lastIndexOf(".")))
                }
            }
        }
        if (r && typeof r.substring === "function" && typeof r.lastIndexOf === "function") {
            r = r.substring(r.lastIndexOf("."))
        }
        var t = b.Data.FileTypes.filter(function(y) {
            if (r === undefined) {
                return false
            }
            return y.get("Extension") == r.toLowerCase()
        });
        if (p.val() !== "" && s.val() !== "" && t.length > 0) {
            s.data("fileType", t[0].get("fileTypeId"));
            $(n).find(".download-delete-button").show();
            b.Us.addDownloadControl(x)
        } else {
            if (p.val() === "" && s.val() === "") {
                var w = $(n).prev();
                var u = $(w).find("input:first"),
                    v = $(w).find("a.assignment-download-file-field:last");
                if (u.val() === "" && $(v).data("attachedFileName") === "") {
                    n.remove()
                }
            }
        }
    };
    b.Us.initializeFileUpload = function(n) {
        $(".assignment-download-file-field").off("fileuploaddone fileuploadadd fileuploadprogress").fileupload({
            url: p3.Config.RootPath + "utilities/FileTransferHandler.ashx",
            autoUpload: true
        }).on("fileuploaddone", function(p, o) {
            $(p.target).parent().attr("data-active", false);
            if (o.result[0] !== undefined) {
                if (o.files[0].isValidUpload) {
                    var r = $(p.target).parent().siblings("input.assignment-download-file-name"),
                        q = o.files[0].name;
                    $(r).data("attachedFileName", o.result[0].name);
                    $(r).data("fileChanged", true);
                    $(r).val(q.substring(0, q.lastIndexOf(".")));
                    $(r).siblings("span:last").html(q.substring(q.lastIndexOf(".")));
                    $(r).siblings("span:first").children("span").html("Change");
                    $(p.target).parent().find("input:last").focus();
                    $(r).trigger("change");
                    $(".progress-container").hide();
                    return false
                }
                if (!o.files[0].isValidUpload) {
                    if ($("#assignment-editor-file-error-msg").length === 0) {
                        $("#add-assignment-downloads-tab").find(".progress-container:first").after($("<div>").addClass("alert alert-error margin-file-error").attr("id", "assignment-editor-file-error-msg").html("The file " + o.files[0].name + " is not a supported type and was not uploaded."))
                    } else {
                        $("#assignment-editor-file-error-msg").html("The file " + o.files[0].name + " is not a supported type and was not uploaded.")
                    }
                }
            }
        }).on("fileuploadadd", function(p, o) {
            o.files[0].isValidUpload = p3.Us.FileTools.isValidFile(p3.Us.Enum.UploadType.All, o.files[0].name);
            $(p.target).parent().attr("data-active", true);
            if ($("#assignment-editor-file-error-msg").length > 0) {
                $("#assignment-editor-file-error-msg").remove()
            }
            if (o.files[0].isValidUpload) {
                $(".bar").attr("style", "width: 0%");
                $(".progress-text").html("Uploading... " + o.files[0].name);
                $(".progress-container").show();
                o.submit()
            }
        }).on("fileuploadprogress", function(p, o) {
            var q = parseInt(o.loaded / o.total * 100, 10);
            $(".bar").attr("style", "width: " + q + "%")
        })
    };
    b.Us.GetAssignmentTime = function(n) {
        var o = n.getTime();
        if (o === "undefined:undefined" || o === false) {
            o = "0:00"
        }
        if (o === "0:00" && n.attr("placeholder").length > 0) {
            o = n.attr("placeholder")
        }
        return e.displayTime(o, true, "timeSpan")
    };
    b.Us.GetMarkingPeriods = function(n, o) {
        return n.filter(function(p) {
            return p.get("section_id") === o
        })
    };
    b.Us.SyncSections = function(p, o, n) {
        p.each(function(q) {
            if (q.get("SectionId") == o[n].SectionId) {
                q.set("HasGrades", o[n].HasGrades);
                q.set("HasAssessmentResults", o[n].HasAssessmentResults)
            }
        })
    };
    b.Us.GetAssignmentsByType = function(n, o) {
        return n.filter(function(p) {
            return p.get("AssignmentType") === o
        })
    };
    p3.router().route("classassignment", "Assignment", function(n) {
        p3.renderMainPage(new b.Vs.ClassAssignmentView())
    })
}(p3.module("LMS/assignment")));
(function(a) {
    a.Cs.PersonaAccess = Bbc.extend({
        url: "DataDirect/AssignmentCenterPersonaOptionsGet"
    });
    a.Ms.PersonaAccessSet = Bbm.extend({
        idAttribute: "pliId",
        url: function() {
            return aP + "DataDirect/AssignmentCenterPersonaOptionsSave"
        }
    });
    a.Vs.LayoutView = Bb.View.extend({
        template: "page/page.1col.wide.template.html",
        initialize: function() {
            if (p3.Config.uiVersion === 3) {
                this.template = "assignmentcenter/assignmentcenter.options.layout.template.html"
            }
        },
        render: function(b) {
            var c = this;
            $(b).html(this.el);
            p3.fT(c.template, function(e) {
                c.$el.html(e());
                var d = c.$el.find("#col-main");
                p3.rV(new a.Vs.PersonaOptions(), d, false)
            })
        }
    });
    a.Vs.PersonaOptions = Bb.View.extend({
        template: "assignmentcenter/assignmentcenter.options.persona.template.html",
        events: {
            "click button": "doToggle"
        },
        initialize: function(b) {
            new a.Cs.PersonaAccess().on("reset", this.renderTemplate, this).fetch()
        },
        render: function(b) {
            var c = this;
            $(b).append(c.el)
        },
        renderTemplate: function(b, i, g) {
            var k = this,
                c, f, e, h = _.uniq(b.pluck("persona_desc")),
                d = [],
                j;
            for (c = 0; c < h.length; c++) {
                f = b.where({
                    persona_desc: h[c]
                });
                j = [];
                for (e = 0; e < f.length; e++) {
                    j.push({
                        id: f[e].get("pli_id"),
                        name: f[e].get("persona_level_desc"),
                        enabled: f[e].get("enabled_ind")
                    })
                }
                d.push({
                    title: h[c],
                    levels: j
                })
            }
            p3.fT(k.template, function(l) {
                k.$el.html(l({
                    persona: d
                }))
            })
        },
        doToggle: function(d) {
            var c = $(d.currentTarget),
                b = c.parent(),
                f = b.data("id"),
                g = {
                    pliId: f,
                    enabled: c.data("enabled")
                };
            new a.Ms.PersonaAccessSet(g).save()
        }
    });
    p3.router().route("Assignmentcenterdisplay", "Assignmentcenterdisplay", function(b) {
        p3.renderMainPage(new a.Vs.LayoutView())
    })
}(p3.module("assignmentcenteroptions")));
(function(a) {
    var c = p3.module("shared/timepicker"),
        b = p3.Us.Culture;
    a.Ms.AssignmentOptions = Bbm.extend({
        urlRoot: "Assignment/AssignmentOptions/"
    });
    a.Ms.AssignmentOptionsEndUser = Bbm.extend({
        urlRoot: "Assignment/ViewAssignmentOptions/"
    });
    a.AssignmentViews = {
        LIST: {
            Name: "List",
            Value: 0
        },
        GRID: {
            Name: "Grid",
            Value: 1
        }
    };
    a.AssignmentCenterRanges = {
        MONTH: {
            Name: "Month",
            Value: 2
        },
        WEEK: {
            Name: "Week",
            Value: 1
        },
        DAY: {
            Name: "Day",
            Value: 0
        }
    };
    a.AssignmentCenterDisplays = {
        DUE: {
            Name: "Due",
            Value: 1
        },
        ACTIVE: {
            Name: "Active",
            Value: 0
        },
        ASSIGNED: {
            Name: "Assigned",
            Value: 2
        }
    };
    a.Vs.LayoutView = Bb.View.extend({
        template: "assignmentoptions/layout.template.html",
        events: {
            "blur #default-time-box": "timeChange",
            "click .ac-default-view": "acViewClick",
            "click .ac-default-range": "acRangeClick",
            "change #ac-display-dropdown": "acDisplayChange"
        },
        renderTemplate: function() {
            var d = this;
            p3.fT(d.template, function(e) {
                d.$el.html(e({
                    options: d.model.toJSON()
                }));
                c.Us.initialize("#default-time-box")
            })
        },
        render: function(d) {
            var e = this;
            $(d).append(e.el);
            e.model = new a.Ms.AssignmentOptions();
            e.getOptions()
        },
        getOptions: function() {
            var d = this;
            d.model.fetch({
                success: function() {
                    d.renderTemplate()
                },
                error: function(e, f) {
                    p3.displayError("Error getting assignment options")
                }
            })
        },
        saveOptions: function() {
            var d = this;
            d.model.save({}, {
                error: function() {
                    p3.displayError("Error saving assignment options.")
                }
            })
        },
        timeChange: function(d) {
            var h = $("#default-time-box").val(),
                f = [],
                g = "0:00:00";
            if (h.length > 0) {
                f = b.getTime(h, true);
                g = f[0] + ":" + f[1] + ":" + f[2]
            }
            this.model.set("DefaultTime", g);
            this.saveOptions()
        },
        acViewClick: function(d) {
            this.model.set("AssignmentCenterView", $(d.currentTarget).data("val"));
            this.saveOptions()
        },
        acRangeClick: function(d) {
            this.model.set("AssignmentCenterRange", $(d.currentTarget).data("val"));
            this.saveOptions()
        },
        acDisplayChange: function(d) {
            this.model.set("AssignmentCenterDisplay", $("#ac-display-dropdown").val());
            this.saveOptions()
        }
    });
    a.Us.getAssignmentOptionDefaults = function() {
        var d;
        if (_.isUndefined(p3.Data.LMS)) {
            p3.Data.LMS = {}
        }
        if (!p3.Data.LMS.OptionsDefaulted) {
            d = new a.Ms.AssignmentOptionsEndUser();
            d.fetch({
                async: false,
                success: function() {
                    p3.Data.LMS.OptionsDefaulted = true;
                    p3.Data.LMS.DisplayCalendar = (d.get("AssignmentCenterView") === a.AssignmentViews.GRID.Value);
                    switch (d.get("AssignmentCenterRange")) {
                        case a.AssignmentCenterRanges.DAY.Value:
                            p3.Data.LMS.calendarView = "basicDay";
                            break;
                        case a.AssignmentCenterRanges.MONTH.Value:
                            p3.Data.LMS.calendarView = "month";
                            break;
                        case a.AssignmentCenterRanges.WEEK.Value:
                            p3.Data.LMS.calendarView = "basicWeek";
                            break
                    }
                    switch (d.get("AssignmentCenterDisplay")) {
                        case a.AssignmentCenterDisplays.ACTIVE.Value:
                            p3.Data.LMS.AssignmentCenterfilter = 2;
                            break;
                        case a.AssignmentCenterDisplays.ASSIGNED.Value:
                            p3.Data.LMS.AssignmentCenterfilter = 0;
                            break;
                        case a.AssignmentCenterDisplays.DUE.Value:
                            p3.Data.LMS.AssignmentCenterfilter = 1;
                            break
                    }
                    p3.Data.LMS.DefaultTime = d.get("DefaultTime")
                },
                error: function(e, f) {
                    p3.displayError("Error getting default assignment options")
                }
            })
        }
    };
    a.Us.verifyAssignmentCenterFilter = function(e, d) {
        if ((e !== undefined && e !== null) && (e === 0 || e === 1 || e === 2 || e === "0" || e === "1" || e === "2")) {
            return e
        }
        if ((d !== undefined && d !== null) && (d === 0 || d === 1 || d === 2 || d === "0" || d === "1" || d === "2")) {
            return d
        }
        return 2
    }
}(p3.module("lms/assignmentoptions")));
(function(a) {
    a.Cs.PersonaAccess = Bbc.extend({
        url: "DataDirect/AssignmentCenterPersonaOptionsGet"
    });
    a.Ms.PersonaAccessSet = Bbm.extend({
        idAttribute: "pliId",
        url: function() {
            return aP + "DataDirect/AssignmentCenterPersonaOptionsSave"
        }
    });
    a.Vs.LayoutView = Bb.View.extend({
        template: "page/page.1col.wide.template.html",
        initialize: function() {
            if (p3.Config.uiVersion === 3) {
                this.template = "assignmentcenter/assignmentcenter.options.layout.template.html"
            }
        },
        render: function(b) {
            var c = this;
            $(b).html(this.el);
            p3.fT(c.template, function(e) {
                c.$el.html(e());
                var d = c.$el.find("#col-main");
                p3.rV(new a.Vs.PersonaOptions(), d, false)
            })
        }
    });
    a.Vs.PersonaOptions = Bb.View.extend({
        template: "assignmentcenter/assignmentcenter.options.persona.template.html",
        events: {
            "click .option-toggle": "doToggle"
        },
        initialize: function(b) {
            new a.Cs.PersonaAccess().on("reset", this.renderTemplate, this).fetch()
        },
        render: function(b) {
            var c = this;
            $(b).append(c.el)
        },
        renderTemplate: function(b, i, g) {
            var k = this,
                h = _.uniq(b.pluck("persona_desc")),
                d = [],
                c, f, j, e;
            for (c = 0; c < h.length; c++) {
                f = b.where({
                    persona_desc: h[c]
                });
                j = [];
                for (e = 0; e < f.length; e++) {
                    j.push({
                        id: f[e].get("pli_id"),
                        name: f[e].get("persona_level_desc"),
                        enabled: f[e].get("enabled_ind")
                    })
                }
                d.push({
                    title: h[c],
                    levels: j
                })
            }
            p3.fT(k.template, function(l) {
                k.$el.html(l({
                    persona: d
                }))
            })
        },
        doToggle: function(d) {
            var c = $(d.currentTarget),
                b = c.parent(),
                f = b.data("id"),
                g = {
                    pliId: f,
                    enabled: c.data("enabled")
                };
            new a.Ms.PersonaAccessSet(g).save()
        }
    });
    p3.router().route("assignmentsettings", "assignmentsettings", function(b) {
        p3.renderMainPage(new a.Vs.LayoutView())
    })
}(p3.module("LMS/AssignmentSettings")));
(function(b) {
    var a = p3.module("lms/assignmentoptions");
    b.Ms.AssignmentType = Bbm.extend({
        idAttribute: "AssignmentTypeId",
        url: function() {
            return aP + "assignmenttype/get/?format=json"
        }
    });
    b.Cs.AssignmentType = Bbc.extend({
        model: b.Ms.AssignmentType,
        url: function() {
            return aP + "assignmenttype/getall/?format=json"
        }
    });
    b.Ms.AssignmentTypeSave = Bbm.extend({
        idAttribute: "AssignmentTypeId",
        url: function() {
            var c;
            if (this.get("AssignmentTypeId") === 0) {
                c = aP + "assignmenttype/create/?format=json"
            } else {
                c = aP + "assignmenttype/update/?format=json"
            }
            return c
        }
    });
    b.Ms.AssignmentTypeDelete = Bbm.extend({
        idAttribute: "AssignmentTypeId",
        url: function() {
            return aP + "assignmenttype/delete/?format=json&assignmentTypeId=" + this.get("AssignmentTypeId")
        }
    });
    b.Vs.LayoutView = Bb.View.extend({
        template: "assignmenttype/layout.template.html",
        events: {
            "click #add-type-button": "addType",
            "click .edit-type-button": "editType",
            "click .delete-type-button": "deleteType"
        },
        renderTemplate: function() {
            var c = this;
            p3.fT(c.template, function(d) {
                c.$el.html(d({
                    types: c.collection.toJSON()
                }));
                c.renderOptions();
                c.$(".btn-mini.disabled").tooltip()
            })
        },
        render: function(c) {
            var d = this;
            $(c).append(d.el);
            d.collection = new b.Cs.AssignmentType();
            d.getTypes();
            d.Containers = {}
        },
        getTypes: function() {
            var c = this;
            c.collection.fetch({
                success: function() {
                    c.renderTemplate()
                },
                error: function(d, e) {
                    p3.displayError("Error getting assignment types")
                }
            })
        },
        addType: function(d) {
            var f = this,
                c = new b.Vs.editView({
                    assignmentTypeId: 0
                });
            p3.rV(c, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            c.on("typeSaved", function() {
                f.getTypes()
            })
        },
        editType: function(c) {
            var f = this,
                d = new b.Vs.editView({
                    assignmentTypeId: $(c.currentTarget).data("id")
                });
            p3.rV(d, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            d.on("typeSaved", function() {
                f.getTypes()
            })
        },
        deleteType: function(f) {
            var g = this,
                c = $(f.currentTarget).data("id"),
                d;
            p3.showConfirm(null, "Are you sure you want to delete this assignment type?", null, function() {
                d = new b.Ms.AssignmentTypeDelete({
                    AssignmentTypeId: c
                });
                d.destroy({
                    error: function() {
                        p3.displayError("Error deleting assignment type")
                    },
                    success: function() {
                        g.getTypes()
                    }
                })
            })
        },
        renderOptions: function() {
            var d = this,
                c = new a.Vs.LayoutView();
            d.Containers.Options = d.$("#assignment-options-container");
            p3.rV(c, d.Containers.Options, true)
        }
    });
    b.Vs.editView = Bb.View.extend({
        template: "assignmenttype/edit.template.html",
        events: {
            "click #btnSave": "saveType",
            "click #btnSaveAdd": "saveType"
        },
        renderTemplate: function() {
            var c = this;
            p3.fT(c.template, function(d) {
                c.$el.html(d({
                    type: c.model.toJSON(),
                    assignmentTypeId: c.options.assignmentTypeId
                }))
            })
        },
        render: function(c) {
            var d = this;
            $(c).append(this.el);
            d.model = new b.Ms.AssignmentType({
                Inactive: false
            });
            if (d.options.assignmentTypeId === 0) {
                d.renderTemplate()
            } else {
                d.model.fetch({
                    data: {
                        assignmentTypeId: d.options.assignmentTypeId
                    },
                    success: function() {
                        d.renderTemplate()
                    },
                    error: function(e, f) {
                        p3.displayError("Error getting assignment type")
                    }
                })
            }
        },
        saveType: function(l) {
            var n = this,
                k = (l.target.id === "btnSaveAdd"),
                m, i = $("#type-box"),
                j = $("#type-group"),
                d = $("#btnSave"),
                f = $("#btnSaveAdd"),
                g = $("#code-box"),
                h = $("#major-yes-button"),
                c = $("#active-no-button");
            if (i.val().length === 0) {
                j.addClass("error").addClass("has-error")
            } else {
                j.removeClass("error").removeClass("has-error");
                d.button("loading");
                f.button("loading");
                m = new b.Ms.AssignmentTypeSave({
                    AssignmentTypeId: n.options.assignmentTypeId,
                    ShortDescription: i.val(),
                    Code: g.val(),
                    Major: h.hasClass("active"),
                    Inactive: c.hasClass("active")
                });
                m.save({}, {
                    error: function() {
                        p3.showModal(p3.Layout.Containers.Modal, "hide");
                        p3.displayError("Error saving assignment type.")
                    },
                    success: function() {
                        n.trigger("typeSaved");
                        if (k) {
                            i.val("");
                            g.val("");
                            h.removeClass("active");
                            $("#major-no-button").addClass("active");
                            c.removeClass("active");
                            $("#active-yes-button").addClass("active");
                            d.button("reset");
                            f.button("reset")
                        } else {
                            p3.showModal(p3.Layout.Containers.Modal, "hide")
                        }
                    }
                })
            }
        }
    });
    p3.router().route("assignmenttypes", "assignmenttypes", function() {
        p3.renderMainPage(new b.Vs.LayoutView({}))
    })
}(p3.module("lms/assignmenttype")));
(function(a) {
    var l = p3.module("shared/task"),
        d = p3.module("shared/datepicker"),
        c = p3.Us.Culture,
        i = p3.module("report"),
        g = p3.module("shared/message"),
        h = p3.module("shared/profile"),
        f = p3.module("LMS/groupPageEdit"),
        j = p3.module("LMS/roster");
    a.Data = {};
    a.Cs.Members = Bbc.extend({
        initialize: function(n, o) {
            this.sectionId = o.sectionId || 0
        },
        url: function() {
            return aP + "datadirect/athleticrosterget/?format=json&teamId=" + this.sectionId
        },
        filters: undefined,
        comparator: function(n) {
            return n.get("jersey_num")
        },
        changeSort: function(n) {
            if (!_.isUndefined(this.filters)) {
                this.comparator = this.filters[n]
            }
        }
    });
    a.Ms.Member = Bbm.extend({
        idAttribute: "memberId",
        url: function() {
            return aP + "datadirect/AthleticRosterItemGet?format=json&teamId=" + this.get("sectionId") + "&memberId=" + this.get("memberId")
        }
    });
    a.Ms.MemberUpdate = Bbm.extend({
        url: function() {
            return aP + "athletics/rosterupdate"
        }
    });
    a.Ms.MemberDelete = Bbm.extend({
        idAttribute: "memberId",
        url: function() {
            return aP + "athletics/rosterdelete?format=json&teamId=" + this.get("teamId") + "&memberId=" + this.get("memberId") + "&scheduleError=" + this.get("scheduleError") + "&changeSections=" + this.get("changeSections") + "&dropDate=" + this.get("dropDate")
        }
    });
    a.Cs.MedicalMedicationList = Bbc.extend({
        url: "Medical/MedicalMedicationList/"
    });

    function m(n, o) {
        var p = n.split(",").map(function(q) {
            return parseInt(q, 10)
        });
        return $.grep(o, function(q) {
            return p.indexOf(q.Id) > -1
        }).map(function(q) {
            return q.Description
        }).join(", ")
    }

    function b(t, r) {
        var n = t.get("allergies"),
            p = t.get("conditions"),
            q = "",
            s = t.get("medications"),
            o = t.get("clearances");
        if (n) {
            q = "Allergic to: " + n
        }
        if (p) {
            if (q) {
                q += "<br />"
            }
            q += "Condition(s): " + p
        }
        if (s) {
            if (q) {
                q += "<br />"
            }
            q += "Medication(s): " + m(s, r)
        }
        if (o) {
            if (q) {
                q += "<br />"
            }
            q += "Missing: " + o
        }
        t.set("medicalSummary", q);
        return s
    }

    function e(q, r) {
        var u = q.split(",").map(function(w) {
                return parseInt(w, 10)
            }),
            v = {},
            n, o = u.length,
            t, p, s;
        for (n = 0; n < o; n++) {
            t = u[n];
            v[t] = (v[t] || 0) + 1
        }
        o = r.length;
        for (n = 0; n < o; n++) {
            p = r[n];
            if (v[p.Id]) {
                if (s) {
                    s += ", "
                } else {
                    s = ""
                }
                s += v[p.Id] + " " + p.Description
            }
        }
        return s
    }

    function k(n) {
        return [n.lastname, n.firstname]
    }
    a.Vs.RosterView = Bb.View.extend({
        template: "athleticroster/athleticsroster.roster.template.html",
        events: {
            "click .send-message": "sendMessage",
            "click .edit-roster": "editRoster",
            "click .delete-roster": "showDeleteDialog",
            "click .sort-icon": "sortChange",
            "click #rosterSearchButton": "outputTemplate",
            "keydown #rosterSearchField": "doSearchEnter",
            "click #athleticRosterManageButton": "onManageButton",
            "change #roster-term-picker": "changeTermPicker"
        },
        renderTemplate: function() {
            var p = this,
                o = p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.MEDICAL) && !p3.Data.Context.get("IsImpersonating");

            function n() {
                p.collection.fetch({
                    success: function(q, F) {
                        var J = new i.Cs.ReportList(),
                            I, L, t = [],
                            D, y = false,
                            w = false,
                            z = false,
                            v = false,
                            x = false,
                            s = 0,
                            K = false,
                            u = false,
                            E, A, B, C = [],
                            H = [],
                            G = [];
                        J.remove(J.at(0));
                        if (i.hasAccessToReportId(373)) {
                            L = l.Us.getUrlById(1691, "__pd=gm_fv&pk=373&ext=vw&o_pk=" + p.options.sectionId);
                            I = new i.Ms.ReportList({
                                ReportName: "Emergency Contacts",
                                Link: L
                            });
                            J.add(I)
                        }
                        if (i.hasAccessToReportId(401)) {
                            L = l.Us.getUrlById(1691, "__pd=gm_fv&pk=401&ext=pdf&sid=" + p.options.sectionId);
                            I = new i.Ms.ReportList({
                                ReportName: "Learning Profile - By Section",
                                Link: L
                            });
                            J.add(I)
                        }
                        if ((i.hasAccessToReportId(500)) && (!p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.CONNECTEE))) {
                            L = l.Us.getUrlById(1691, "__pd=gm_fv&pk=500&ext=vw&o_pk=" + p.options.sectionId);
                            I = new i.Ms.ReportList({
                                ReportName: "Attendance History - By Section",
                                Link: L
                            });
                            J.add(I)
                        }
                        if ((i.hasAccessToReportId(121)) && (!p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.CONNECTEE))) {
                            L = l.Us.getUrlById(1691, "__pd=gm_fv&pk=121&ext=vw&o_pk=" + p.options.sectionId);
                            I = new i.Ms.ReportList({
                                ReportName: "Attendance History - By Section",
                                Link: L
                            });
                            J.add(I)
                        }
                        if (i.hasAccessToReportId(508)) {
                            L = l.Us.getUrlById(1691, "__pd=gm_fv&pk=508&sectionId=" + p.options.sectionId);
                            I = new i.Ms.ReportList({
                                ReportName: "School Forms",
                                Link: L
                            });
                            J.add(I)
                        }
                        if (p3.Data.Context.findByTaskId(53477) && !p3.Data.Context.get("IsImpersonating")) {
                            L = "/app" + l.Us.getUrlById(53477, p.options.sectionId);
                            I = new i.Ms.ReportList({
                                ReportName: "Medical Contact Cards",
                                Link: L
                            });
                            J.add(I)
                        }
                        D = new a.Cs.Members(null, {
                            sectionId: p.options.sectionId
                        });
                        p.players = D;
                        p.defineFilters();
                        p.collection.each(function(r) {
                            if (r.get("teacher_type") && r.get("teacher_type").length > 0) {
                                s += 1;
                                if (s == 1 || (s - 1) % 3 == 0) {
                                    K = true
                                } else {
                                    K = false
                                }
                                if (s > 1 && s % 3 == 0) {
                                    u = true
                                } else {
                                    u = false
                                }
                                t.push({
                                    coachType: r.get("teacher_type"),
                                    name: r.get("name"),
                                    id: r.get("id"),
                                    photo: r.get("user_thumb"),
                                    startRow: K,
                                    endRow: u
                                })
                            } else {
                                if (r.get("jersey_num")) {
                                    x = true
                                }
                                if (r.get("position")) {
                                    y = true
                                }
                                if (r.get("height") && r.get("publish_height")) {
                                    w = true
                                }
                                if (r.get("weight") && r.get("publish_weight")) {
                                    z = true
                                }
                                r.set("grad_year", r.get("grad_year").substring(2));
                                if (r.get("form_instance_id")) {
                                    r.set("lpLink", "pk=393&__pd=gm_fv&ext=pdf&sid=" + r.get("id") + "&fiid=" + r.get("form_instance_id"))
                                }
                                if (r.get("user_thumb") && r.get("user_thumb").indexOf("thumb_photo") !== -1) {
                                    r.set("ath_photo", true)
                                }
                                B = b(r, p.medicationList);
                                if (B) {
                                    if (A) {
                                        A += ","
                                    } else {
                                        A = ""
                                    }
                                    A += B
                                }
                                if (!r.get("cleared")) {
                                    C.push({
                                        name: r.get("name"),
                                        lastname: r.get("lastname"),
                                        firstname: r.get("firstname")
                                    })
                                }
                                if (r.get("clearance_date")) {
                                    H.push({
                                        name: r.get("name"),
                                        lastname: r.get("lastname"),
                                        firstname: r.get("firstname"),
                                        clearanceDate: r.get("clearance_date")
                                    })
                                }
                                if (r.get("allergy_date")) {
                                    G.push({
                                        name: r.get("name"),
                                        lastname: r.get("lastname"),
                                        firstname: r.get("firstname"),
                                        changedDate: r.get("allergy_date"),
                                        type: "allergy"
                                    })
                                }
                                if (r.get("condition_date")) {
                                    G.push({
                                        name: r.get("name"),
                                        lastname: r.get("lastname"),
                                        firstname: r.get("firstname"),
                                        changedDate: r.get("condition_date"),
                                        type: "condition"
                                    })
                                }
                                if (r.get("medication_date")) {
                                    G.push({
                                        name: r.get("name"),
                                        lastname: r.get("lastname"),
                                        firstname: r.get("firstname"),
                                        changedDate: r.get("medication_date"),
                                        type: "medication"
                                    })
                                }
                                D.add(r)
                            }
                        });
                        if (A) {
                            p.medicationsNeeded = e(A, p.medicationList)
                        }
                        p.nonClearedStudents = _.sortBy(C, k);
                        p.recentlyClearedStudents = _.sortBy(H, k);
                        p.recentlyChangedStudents = _.sortBy(G, k);
                        if (s > 0) {
                            t[s - 1].endRow = true
                        }
                        p.reports = J;
                        p.coaches = t;
                        p.players = D;
                        p.havePosition = y;
                        p.haveHeight = w;
                        p.haveWeight = z;
                        p.haveEquipment = v;
                        p.haveNumbers = x;
                        p.SortAsc = true;
                        if (x) {
                            p.SortType = a.Us.SortType.Number;
                            D.changeSort("jersey_num")
                        } else {
                            p.SortType = a.Us.SortType.Name;
                            D.changeSort("lastname")
                        }
                        D.sort();
                        if (D.length == 0) {
                            p.outputTemplate()
                        } else {
                            E = new h.Ms.ProfileTabs();
                            E.fetch({
                                data: {
                                    showuserid: D.models[0].get("id")
                                },
                                success: function(M) {
                                    var r = _.chain(M.toJSON()).filter(function(T) {
                                            return T.Value == true
                                        }).pluck("Key").value(),
                                        Q = false,
                                        S = false,
                                        N = false,
                                        P = false,
                                        R = false,
                                        O = false;
                                    if (_.contains(r, "Progress")) {
                                        Q = true
                                    }
                                    if (_.contains(r, "Schedule")) {
                                        S = true
                                    }
                                    if (_.contains(r, "Assignments")) {
                                        N = true
                                    }
                                    if (_.contains(r, "Official Notes")) {
                                        P = true
                                    }
                                    if (_.contains(r, "Course Requests")) {
                                        R = true
                                    }
                                    if (_.contains(r, "Contact Card")) {
                                        O = true
                                    }
                                    p.showProgress = Q;
                                    p.showSchedule = S;
                                    p.showAssign = N;
                                    p.showNotes = P;
                                    p.showRequests = R;
                                    p.showContact = O;
                                    p.showMedical = o && p3.Data.Context.findByTaskId(53394);
                                    p.outputTemplate()
                                }
                            })
                        }
                    },
                    error: function() {
                        p3.displayError("Error loading roster")
                    }
                })
            }
            if (o) {
                new a.Cs.MedicalMedicationList().fetch({
                    success: function(q) {
                        p.medicationList = q ? q.toJSON() : [];
                        n()
                    }
                })
            } else {
                p.medicationList = [];
                n()
            }
        },
        initialize: function() {
            var p = this,
                o, n;
            p.canEdit = p.options.userHasFullAccess;
            if (!p.canEdit) {
                o = p.options.content.get(49);
                if (o && o.get("EditorAccess")) {
                    p.canEdit = true
                }
            }
            n = new a.Cs.Members({}, {
                sectionId: p.options.sectionId
            });
            p.collection = n
        },
        dispose: function() {
            $(".tooltip").remove()
        },
        render: function(n) {
            $(n).append(this.el);
            i.loadReportList();
            var o = this;
            o.renderTemplate()
        },
        defineFilters: function() {
            var n = this;
            n.players.filters = {
                lastname: function(q, r) {
                    var o = q.get("lastname") || "",
                        p = r.get("lastname") || "",
                        s;
                    if (o < p) {
                        s = -1
                    } else {
                        if (o > p) {
                            s = 1
                        } else {
                            s = n.players.filters.firstname(q, r)
                        }
                    }
                    return s
                },
                lastname_invert: function(q, r) {
                    var o = q.get("lastname") || "",
                        p = r.get("lastname") || "",
                        s;
                    if (o < p) {
                        s = 1
                    } else {
                        if (o > p) {
                            s = -1
                        } else {
                            s = n.players.filters.firstname_invert(q, r)
                        }
                    }
                    return s
                },
                firstname: function(q, r) {
                    var o = q.get("firstname") || "",
                        p = r.get("firstname") || "";
                    return o < p ? -1 : o > p ? 1 : 0
                },
                firstname_invert: function(q, r) {
                    var o = q.get("firstname") || "",
                        p = r.get("firstname") || "";
                    return o < p ? 1 : o > p ? -1 : 0
                },
                jersey_num: function(q, r) {
                    var o = -1,
                        p = -1;
                    if (q.get("jersey_num") != null) {
                        o = q.get("jersey_num")
                    }
                    if (r.get("jersey_num") != null) {
                        p = r.get("jersey_num")
                    }
                    return n.doCompare(o, p, q, r)
                },
                jersey_num_invert: function(q, r) {
                    var o = -1,
                        p = -1;
                    if (q.get("jersey_num") != null) {
                        o = q.get("jersey_num")
                    }
                    if (r.get("jersey_num") != null) {
                        p = r.get("jersey_num")
                    }
                    return n.doCompareInvert(o, p, q, r)
                },
                position: function(q, r) {
                    var o = q.get("position") || "",
                        p = r.get("position") || "";
                    return n.doCompare(o, p, q, r)
                },
                position_invert: function(q, r) {
                    var o = q.get("position") || "",
                        p = r.get("position") || "";
                    return n.doCompareInvert(o, p, q, r)
                },
                height: function(q, r) {
                    var o = q.get("height") || "",
                        p = r.get("height") || "";
                    return n.doCompare(o, p, q, r)
                },
                height_invert: function(q, r) {
                    var o = q.get("height") || "",
                        p = r.get("height") || "";
                    return n.doCompareInvert(o, p, q, r)
                },
                weight: function(q, r) {
                    var o = q.get("weight") || "",
                        p = r.get("weight") || "";
                    return n.doCompare(o, p, q, r)
                },
                weight_invert: function(q, r) {
                    var o = q.get("weight") || "",
                        p = r.get("weight") || "";
                    return n.doCompareInvert(o, p, q, r)
                },
                grade_number: function(q, r) {
                    var o = -1,
                        p = -1;
                    if (q.get("grade_number") != null) {
                        o = q.get("grade_number")
                    }
                    if (r.get("grade_number") != null) {
                        p = r.get("grade_number")
                    }
                    return n.doCompare(o, p, q, r)
                },
                grade_number_invert: function(q, r) {
                    var o = -1,
                        p = -1;
                    if (q.get("grade_number") != null) {
                        o = q.get("grade_number")
                    }
                    if (r.get("grade_number") != null) {
                        p = r.get("grade_number")
                    }
                    return n.doCompareInvert(o, p, q, r)
                }
            }
        },
        doCompare: function(q, r, n, o) {
            var s = this,
                p;
            if (q < r) {
                p = -1
            } else {
                if (q > r) {
                    p = 1
                } else {
                    p = s.players.filters.lastname(n, o)
                }
            }
            return p
        },
        doCompareInvert: function(q, r, n, o) {
            var s = this,
                p;
            if (q < r) {
                p = 1
            } else {
                if (q > r) {
                    p = -1
                } else {
                    p = s.players.filters.lastname(n, o)
                }
            }
            return p
        },
        sortChange: function(o) {
            var r = this,
                n = $(o.currentTarget),
                q = n.data("sorttype"),
                p = "";
            switch (q) {
                case a.Us.SortType.Number:
                    p = "jersey_num";
                    break;
                case a.Us.SortType.Name:
                    p = "lastname";
                    break;
                case a.Us.SortType.Year:
                    p = "grade_number";
                    break;
                case a.Us.SortType.Position:
                    p = "position";
                    break;
                case a.Us.SortType.Height:
                    p = "height";
                    break;
                case a.Us.SortType.Weight:
                    p = "weight";
                    break
            }
            if (q == r.SortType) {
                r.SortAsc = !r.SortAsc
            } else {
                r.SortAsc = true
            }
            if (!r.SortAsc) {
                p += "_invert"
            }
            r.SortType = q;
            r.players.changeSort(p);
            r.players.sort();
            r.outputTemplate()
        },
        doSearchEnter: function(n) {
            if (n.keyCode === 13) {
                this.outputTemplate()
            }
        },
        outputTemplate: function() {
            var s = this,
                q = $("#rosterSearchField").val(),
                n = [],
                p, o = p3.Data.Context.getSelectedPersona().Id == 3 || p3.Data.Context.getSelectedPersona().Id == 5,
                r = [];
            h.Data.ShowBackButton = true;
            s.$el.html("");
            if (q !== undefined && q !== null && q.length > 0) {
                n = _.filter(s.coaches, function(t) {
                    return !_.isUndefined(t.name) ? t.name.toLowerCase().indexOf(q.toLowerCase()) >= 0 : false
                });
                p = s.players.filter(function(w) {
                    var v = (w.get("nickname") !== null) ? w.get("nickname").toLowerCase().indexOf(q.toLowerCase()) >= 0 : false,
                        t = (w.get("firstname") !== null) ? w.get("firstname").toLowerCase().indexOf(q.toLowerCase()) >= 0 : false,
                        u = (w.get("lastname") !== null) ? w.get("lastname").toLowerCase().indexOf(q.toLowerCase()) >= 0 : false;
                    return v || t || u
                });
                _.each(p, function(t) {
                    r.push(t.toJSON())
                });
                p = r
            } else {
                n = n.concat(s.coaches);
                p = s.players.toJSON()
            }
            _.each(n, function(t, u) {
                t.endRow = (u + 1) % 3 === 0;
                if (u === n.length) {
                    t.endRow = true
                }
            });
            if (n.length > 0) {
                n[n.length - 1].endRow = true
            }
            if (s.options.enableSearch) {
                this.content = new f.Cs.Content({}, {
                    sectionId: s.options.sectionId,
                    leadSectionId: s.options.leadSectionId
                });
                this.content.fetch({
                    success: function(t) {
                        var w = t.find(function(x) {
                                return x.get("ContentId") == 434
                            }),
                            v = s.coaches.length + s.players.length,
                            u = w.get("EditorAccess") && (p3.Data.Context.findByTaskId(j.Us.GroupTypes.Athletics.memberEdit) || p3.Data.Context.findByTaskId(j.Us.GroupTypes.Athletics.ownerEdit));
                        p3.fT(s.template, function(x) {
                            s.$el.append(x({
                                report: s.reports.toJSON(),
                                haveReports: s.reports.length > 0,
                                coaches: n,
                                players: p || s.players.toJSON(),
                                sectionId: s.options.sectionId,
                                hasComposeAccess: (g.Us.hasComposeAccess() && (p3.Data.SchoolContext.get("SchoolInfo").BulkMessageEnabled || p3.Data.SchoolContext.get("SchoolInfo").BulkEmailEnabled)),
                                canMsgUser: (g.Us.hasComposeAccess() && p3.Data.SchoolContext.get("SchoolInfo").IndividualMessageEnabled),
                                havePosition: s.havePosition,
                                haveHeight: s.haveHeight,
                                haveWeight: s.haveWeight,
                                haveEquipment: s.haveEquipment,
                                haveNumbers: s.haveNumbers,
                                schoolId: p3.Data.SchoolContext.get("SchoolInfo").SchoolId,
                                canEdit: s.canEdit,
                                isParent: p3.Data.Context.getSelectedPersona().Id === 1,
                                sortType: s.SortType,
                                sortAsc: s.SortAsc,
                                isTeacher: o,
                                showProgress: s.showProgress,
                                showSchedule: s.showSchedule,
                                showAssign: s.showAssign,
                                showNotes: s.showNotes,
                                showRequests: s.showRequests,
                                showContact: s.showContact,
                                enableSearch: s.options.enableSearch,
                                memberCount: v,
                                searchTerm: q,
                                managementLink: typeof u === "object" ? u.TaskId : undefined,
                                showCoaches: n.length > 0,
                                showPlayers: p.length > 0,
                                editTask: (l.Us.getUrlByTaskRef("ContentItem:Edit:49", "") != "#"),
                                deleteTask: (l.Us.getUrlByTaskRef("EnrollmentAddDrop:Delete:9", "") != "#"),
                                isCoach: p3.Data.Context.getSelectedPersona().Id == 3 || p3.Data.Context.getSelectedPersona().Id == 5,
                                medicationsNeeded: s.medicationsNeeded,
                                nonClearedStudents: s.nonClearedStudents,
                                recentlyClearedStudents: s.recentlyClearedStudents,
                                recentlyChangedStudents: s.recentlyChangedStudents,
                                showMedical: s.showMedical,
                                hasConduct: (p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.CONDUCT)) ? true : false
                            }));
                            s.$el.find(".btn").tooltip();
                            s.$el.find(".teamCaptain").tooltip();
                            s.Containers = {
                                termPicker: s.$("#term-picker")
                            };
                            p3.rV(new j.Vs.TermPicker({
                                leadSectionId: s.options.leadSectionId,
                                sectionId: s.options.sectionId
                            }), s.Containers.termPicker, true)
                        })
                    }
                })
            } else {
                p3.fT(s.template, function(t) {
                    s.$el.append(t({
                        report: s.reports.toJSON(),
                        haveReports: s.reports.length > 0,
                        coaches: n,
                        players: p || s.players.toJSON(),
                        sectionId: s.options.sectionId,
                        hasComposeAccess: (g.Us.hasComposeAccess() && (p3.Data.SchoolContext.get("SchoolInfo").BulkMessageEnabled || p3.Data.SchoolContext.get("SchoolInfo").BulkEmailEnabled)),
                        canMsgUser: (g.Us.hasComposeAccess() && p3.Data.SchoolContext.get("SchoolInfo").IndividualMessageEnabled),
                        havePosition: s.havePosition,
                        haveHeight: s.haveHeight,
                        haveWeight: s.haveWeight,
                        haveEquipment: s.haveEquipment,
                        haveNumbers: s.haveNumbers,
                        schoolId: p3.Data.SchoolContext.get("SchoolInfo").SchoolId,
                        canEdit: s.canEdit,
                        isParent: p3.Data.Context.getSelectedPersona().Id === 1,
                        sortType: s.SortType,
                        sortAsc: s.SortAsc,
                        isTeacher: o,
                        showProgress: s.showProgress,
                        showSchedule: s.showSchedule,
                        showAssign: s.showAssign,
                        showNotes: s.showNotes,
                        showRequests: s.showRequests,
                        showContact: s.showContact,
                        enableSearch: s.options.enableSearch,
                        memberCount: 0,
                        searchTerm: q,
                        managementLink: undefined,
                        showCoaches: n.length > 0,
                        showPlayers: p.length > 0,
                        editTask: (l.Us.getUrlByTaskRef("ContentItem:Edit:49", "") != "#"),
                        deleteTask: (l.Us.getUrlByTaskRef("EnrollmentAddDrop:Delete:9", "") != "#"),
                        isCoach: p3.Data.Context.getSelectedPersona().Id == 3 || p3.Data.Context.getSelectedPersona().Id == 5,
                        medicationsNeeded: s.medicationsNeeded,
                        nonClearedStudents: s.nonClearedStudents,
                        recentlyClearedStudents: s.recentlyClearedStudents,
                        recentlyChangedStudents: s.recentlyChangedStudents,
                        showMedical: s.showMedical
                    }));
                    s.$el.find(".btn").tooltip();
                    s.$el.find(".teamCaptain").tooltip();
                    s.Containers = {
                        termPicker: s.$("#term-picker")
                    };
                    p3.rV(new j.Vs.TermPicker({
                        leadSectionId: s.options.leadSectionId,
                        sectionId: s.options.sectionId
                    }), s.Containers.termPicker, true)
                })
            }
        },
        sendMessage: function(n) {
            var u = $(n.currentTarget),
                w = this,
                r = p3.Data.SchoolContext.get("SchoolInfo"),
                q = (r.BulkEmailEnabled && r.BulkMessageEnabled) ? 2 : ((r.BulkEmailEnabled && !r.BulkMessageEnabled) ? 1 : 0),
                v, o, p, s;
            if (u.length > 0) {
                v = $(u).data("messageType");
                o = $(u).data("userId");
                if (!v && typeof o === "number") {
                    a.Us.ComposeUserMessage(o)
                } else {
                    if (!v && typeof o === "string") {
                        p = o.split(",");
                        if (p.length > 0) {
                            a.Us.ComposeUserMessage(p, false, {})
                        }
                    } else {
                        if (typeof v === "number") {
                            s = parseInt(w.options.sectionId, 10);
                            if (typeof s === "number") {
                                switch (v) {
                                    case 0:
                                        a.Us.ComposeUserMessage(["2_" + s + "_1", "2_" + s + "_2", "2_" + s + "_4"], true, {
                                            mode: q,
                                            type: g.Enum.bulkType.all,
                                            sectionId: s
                                        });
                                        break;
                                    case 1:
                                        a.Us.ComposeUserMessage(["2_" + s + "_2"], true, {
                                            mode: q,
                                            type: g.Enum.bulkType.parent,
                                            sectionId: s
                                        });
                                        break;
                                    case 2:
                                        a.Us.ComposeUserMessage(["2_" + s + "_1"], true, {
                                            mode: q,
                                            type: g.Enum.bulkType.student,
                                            sectionId: s
                                        });
                                        break;
                                    default:
                                        break
                                }
                            }
                        }
                    }
                }
            }
            return false
        },
        editRoster: function(o) {
            var r = this,
                n = $(o.currentTarget),
                q = n.data("id"),
                p = new a.Ms.Member({
                    memberId: q,
                    sectionId: r.options.sectionId
                });
            p.fetch({
                async: false,
                error: function() {
                    p3.displayError("Error loading roster member")
                },
                success: function(s, t) {
                    p3.rV(new a.Vs.EditRosterView({
                        userId: q,
                        sectionId: r.options.sectionId,
                        rosterItem: t[0],
                        schoolId: p3.Data.SchoolContext.attributes.SchoolInfo.SchoolId,
                        parentView: r
                    }), p3.Layout.Containers.Modal, true);
                    p3.showModal(p3.Layout.Containers.Modal)
                }
            });
            return false
        },
        showDeleteDialog: function(o) {
            var q = this,
                n = $(o.currentTarget),
                p = n.data("id");
            p3.rV(new a.Vs.DeleteRosterView({
                userId: p,
                teamId: q.options.sectionId,
                startDate: q.options.startDate,
                endDate: q.options.endDate,
                parentView: q,
                duration: q.options.duration
            }), p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            return false
        },
        refreshPlayers: function() {
            var n = this;
            n.collection.fetch({
                success: function() {
                    var r = false,
                        p = false,
                        s = false,
                        o = false,
                        q = false,
                        u = new a.Cs.Members({}, {
                            sectionId: n.options.sectionId
                        }),
                        t, v;
                    u.remove(u.at(0));
                    n.collection.each(function(w) {
                        if (!w.get("teacher_type") || w.get("teacher_type").length == 0) {
                            if (w.get("jersey_num")) {
                                q = true
                            }
                            if (w.get("position")) {
                                r = true
                            }
                            if (w.get("height") && w.get("publish_height")) {
                                p = true
                            }
                            if (w.get("weight") && w.get("publish_weight")) {
                                s = true
                            }
                            w.set("grad_year", w.get("grad_year").substring(2));
                            if (w.get("form_instance_id")) {
                                w.set("lpLink", "pk=393&__pd=gm_fv&ext=pdf&sid=" + w.get("id") + "&fiid=" + w.get("form_instance_id"))
                            }
                            if (w.get("user_thumb") && w.get("user_thumb").indexOf("thumb_photo") !== -1) {
                                w.set("ath_photo", true)
                            }
                            b(w, n.medicationList);
                            u.add(w)
                        }
                    });
                    n.players = u;
                    n.defineFilters();
                    n.havePosition = r;
                    n.haveHeight = p;
                    n.haveWeight = s;
                    n.haveEquipment = o;
                    n.haveNumbers = q;
                    v = false;
                    if (n.SortType == a.Us.SortType.Number && !q) {
                        v = true
                    }
                    if (n.SortType == a.Us.SortType.Position && !r) {
                        v = true
                    }
                    if (n.SortType == a.Us.SortType.Height && !p) {
                        v = true
                    }
                    if (n.SortType == a.Us.SortType.Weight && !s) {
                        v = true
                    }
                    if (v) {
                        n.SortAsc = true;
                        n.SortType = a.Us.SortType.Name
                    }
                    switch (n.SortType) {
                        case a.Us.SortType.Number:
                            t = "jersey_num";
                            break;
                        case a.Us.SortType.Name:
                            t = "lastname";
                            break;
                        case a.Us.SortType.Year:
                            t = "grade_number";
                            break;
                        case a.Us.SortType.Position:
                            t = "position";
                            break;
                        case a.Us.SortType.Height:
                            t = "height";
                            break;
                        case a.Us.SortType.Weight:
                            t = "weight";
                            break
                    }
                    if (!n.SortAsc) {
                        t += "_invert"
                    }
                    n.players.changeSort(t);
                    n.players.sort();
                    n.outputTemplate()
                },
                error: function() {
                    p3.displayError("Error refreshing roster")
                }
            })
        },
        onManageButton: function(n) {
            var p = this,
                o;
            j.Data.AssociationId = 2;
            o = new j.Vs.ManageRosterView({
                sectionId: this.options.sectionId,
                roster: undefined,
                onSave: function() {
                    p.renderTemplate()
                }
            });
            n.stopPropagation();
            n.preventDefault();
            p3.rV(o, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal)
        },
        changeTermPicker: function(n) {
            this.options.sectionId = $(n.currentTarget).val();
            this.collection.sectionId = this.options.sectionId;
            this.outputTemplate()
        }
    });
    a.Vs.DeleteRosterView = Bb.View.extend({
        template: "athleticroster/athleticsroster.delete.template.html",
        events: {
            "click #btnSave": "deleteRoster",
            "click .remove-filter": "removeTypeChange"
        },
        initialize: function() {
            this.teamId = this.options.teamId || 0;
            this.userId = this.options.userId || 0;
            this.startDate = this.options.startDate;
            this.endDate = this.options.endDate;
            this.parentView = this.options.parentView;
            this.duration = this.options.duration || ""
        },
        render: function(n) {
            var o = this;
            p3.fT(o.template, function(s) {
                var q = false,
                    p = c.localDateTime(),
                    r = new Date(o.startDate);
                if (p.getTime() >= r.getTime()) {
                    q = true
                }
                o.seasonStarted = q;
                o.$el.html(s({
                    seasonStarted: q,
                    duration: o.duration,
                    today: c.getDateString(p),
                    startDate: c.getDateString(r),
                    endDate: c.getDateString(new Date(o.endDate))
                }));
                $(n).html(o.el);
                d.Us.initialize("#dropDate")
            })
        },
        deleteRoster: function() {
            var u = this,
                t = true,
                p = "",
                r = false,
                n = false,
                q = "",
                s, o;
            $("div.alert-error").remove();
            $("#btnSave").button("loading");
            if (u.seasonStarted) {
                if ($(".active-filter").length == 0) {
                    t = false;
                    p = "Please select a removal option."
                } else {
                    if ($(".active-filter").data("type-id") == 0) {
                        r = true
                    } else {
                        n = ($(".active-filter").data("type-id") == 1);
                        q = $("#dropDate").val();
                        if (q.length == 0) {
                            t = false;
                            p = "Please select a Drop/Change Date."
                        } else {
                            s = new Date(q).getTime();
                            if (s < new Date(u.startDate).getTime() || s > new Date(u.endDate).getTime()) {
                                t = false;
                                p = "Please select a Drop/Change Date within the season start and end dates."
                            }
                        }
                    }
                }
            } else {
                n = true
            }
            if (t) {
                o = new a.Ms.MemberDelete({
                    memberId: u.userId,
                    teamId: u.teamId,
                    scheduleError: r,
                    changeSections: n,
                    dropDate: q
                });
                o.destroy({
                    error: function() {
                        p3.showModal(p3.Layout.Containers.Modal, "hide");
                        p3.displayError("Error deleting roster member")
                    },
                    success: function() {
                        u.parentView.refreshPlayers();
                        p3.showModal(p3.Layout.Containers.Modal, "hide")
                    }
                })
            } else {
                p3.Us.InfoMessage.ErrorBox(p, ".modal-body", false)
            }
            $("#btnSave").button("reset");
            return false
        },
        removeTypeChange: function(o) {
            var n = $(o.currentTarget);
            $(".active-filter").removeClass("active-filter").addClass("inactive-filter");
            $(".p3icon-radioOn").removeClass("p3icon-radioOn").addClass("p3icon-radioOff");
            n.find(".inactive-filter").removeClass("inactive-filter").addClass("active-filter");
            n.find(".p3icon-radioOff").removeClass("p3icon-radioOff").addClass("p3icon-radioOn");
            return false
        }
    });
    a.Vs.EditRosterView = Bb.View.extend({
        template: "athleticroster/athleticsroster.edit.template.html",
        events: {
            "click #btnSave": "saveRoster"
        },
        initialize: function() {
            this.sectionId = this.options.sectionId || 0;
            _.bindAll(this, "initializeFileUpload")
        },
        render: function(n) {
            var o = this;
            p3.fT(o.template, function(p) {
                o.options.rosterItem.grad_year = o.options.rosterItem.grad_year.substring(2);
                o.$el.html(p({
                    rosterItem: o.options.rosterItem,
                    canDrag: !window.head.browser.ie
                }));
                $(n).html(o.el)
            });
            p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.jQueryUI, function() {
                p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.FileUpload, o.initializeFileUpload)
            })
        },
        initializeFileUpload: function() {
            var n = p3.Us.Enum.UploadType.IMAGE;
            window.setTimeout(function() {
                $("#fileupload").fileupload({
                    url: p3.Config.RootPath + "utilities/FileTransferHandler.ashx",
                    acceptFileTypes: n.ValidExtensions,
                    autoUpload: true
                }).bind("fileuploaddone", function(p, o) {
                    if (o.files[0].isValidUpload) {
                        $("#user-image").attr("src", "/ftpimages/pdTemp/" + o.result[0].name)
                    } else {
                        $("#fileupload").find("p:first").addClass("alert alert-error").removeClass("muted").html("The file " + o.files[0].name + " is not a supported type and was not uploaded.")
                    }
                }).on("fileuploadadd", function(p, o) {
                    o.files[0].isValidUpload = p3.Us.FileTools.isValidFile(n, o.files[0].name);
                    $("#fileupload").find("p:first").removeClass("alert alert-error").addClass("muted").html("Select a photo to represent you. If nothing is uploaded the current placeholder photo will be dislpayed.");
                    if (o.files[0].isValidUpload) {
                        o.submit()
                    } else {
                        $("#fileupload").find("p:first").addClass("alert alert-error").removeClass("muted").html("The file " + o.files[0].name + " is not a supported type and was not uploaded.")
                    }
                })
            }, 100)
        },
        saveRoster: function() {
            var s = this,
                r = true,
                o = "",
                q, n, p;
            $("div.alert-error").remove();
            $("#btnSave").button("loading");
            if (r) {
                q = new a.Ms.MemberUpdate({
                    TeamId: s.options.sectionId,
                    Id: s.options.userId,
                    PublishName: true
                });
                q.set("Position", $("#position-box").val());
                n = -1;
                if ($("#jersey-box").val().length > 0) {
                    n = $("#jersey-box").val()
                }
                q.set("JerseyNumber", n);
                q.set("LockerNumber", $("#locker-box").val());
                q.set("LockerCombination", $("#locker-combo").val());
                q.set("Height", $("#height-box").val());
                q.set("PublishHeight", $("#chkPublishHeight").is(":checked"));
                q.set("Weight", $("#weight-box").val());
                q.set("PublishWeight", $("#chkPublishWeight").is(":checked"));
                q.set("ReturningLetterInd", $("#chkLetter").is(":checked"));
                q.set("TeamCaptainInd", $("#chkCaptain").is(":checked"));
                q.set("Accolades", $("#accolade-box").val());
                p = [];
                if ($("#user-image").attr("src").indexOf("user.png") == -1) {
                    if ($("#user-image").attr("src").indexOf("/pdTemp/") > -1) {
                        p.push({
                            photo_id: 0,
                            original_filename: $("#user-image").attr("src")
                        });
                        if (s.options.rosterItem.photo_id > 0) {
                            p.push({
                                photo_id: s.options.rosterItem.photo_id,
                                DeleteInd: true,
                                large_filename: s.options.rosterItem.large,
                                thumb_filename: s.options.rosterItem.thumb_filename
                            })
                        }
                    }
                }
                q.set("Photos", p);
                q.save({}, {
                    error: function() {
                        p3.showModal(p3.Layout.Containers.Modal, "hide");
                        p3.displayError("Error saving roster member")
                    },
                    success: function() {
                        s.options.parentView.refreshPlayers();
                        p3.showModal(p3.Layout.Containers.Modal, "hide")
                    }
                })
            } else {
                p3.Us.InfoMessage.ErrorBox(o, ".modal-body", false)
            }
            $("#btnSave").button("reset");
            return false
        }
    });
    a.Us.ComposeUserMessage = function(o, n, q) {
        var r = [],
            p;
        if (n) {
            if (o.length > 0) {
                g.Us.composeMessageOrEmail(o, undefined, q)
            }
        } else {
            if (o && o instanceof Array) {
                for (p = 0; p < o.length; p++) {
                    r.push("12_" + o[p] + "_0")
                }
            } else {
                if (typeof o === "number") {
                    r.push("12_" + o + "_0")
                } else {
                    return
                }
            }
            if (r.length > 0) {
                g.Us.composeMessageOrEmail(r, undefined, q)
            }
        }
    };
    a.Us.SortType = {
        Number: 0,
        Name: 1,
        Year: 2,
        Position: 3,
        Height: 4,
        Weight: 5
    };
    Hb.registerHelper("sortIcon", function(q, n, p) {
        var o = "p3icon-sortOff";
        if (q == n) {
            if (p) {
                o = "p3icon-sortUp"
            } else {
                o = "p3icon-sortDown"
            }
        }
        return o
    })
}(p3.module("LMS/athleticroster")));
var MQMap;

function geocodeResponse(d) {
    if (d.results.length > 0) {
        if (d.results[0].locations.length > 0) {
            var b = d.results[0].locations[0],
                c = new MQA.Poi(b.latLng),
                a = new MQA.Icon("/podium/images/mapMarker.png", 32, 32);
            c.setIcon(a);
            MQMap.addShape(c);
            MQMap.setCenter(b.latLng)
        }
    }
}(function(b) {
    var d = p3.module("shared/datepicker"),
        h = p3.module("shared/timepicker"),
        f = p3.module("shared/notification"),
        a = p3.module("app"),
        g = p3.module("shared/task"),
        c = p3.Us.Culture,
        e = p3.module("shared/feeds");
    b.Data = {};
    b.Ms.ScheduleItem = Bbm.extend({
        idAttribute: "ScheduleId",
        url: function() {
            var i;
            if (this.get("ScheduleId") > 0) {
                i = aP + "athleticschedule/GameUpdate"
            } else {
                i = aP + "athleticschedule/GameCreate"
            }
            return i
        }
    });
    b.Cs.ScheduleItem = Bbc.extend({
        model: b.Ms.ScheduleItem,
        initialize: function(i, j) {
            this.dateSort = j.dateSort || 0;
            this.scheduleType = j.scheduleType || 0;
            this.startDate = j.startDate || null;
            this.endDate = j.endDate || null;
            this.searchTerm = j.searchTerm || null;
            this.sectionId = j.sectionId || 0;
            this.lite = j.lite || null
        },
        setSectionId: function(i) {
            this.sectionId = i
        },
        setDateSortFilter: function(i) {
            this.dateSort = i
        },
        setScheduleTypeFilter: function(i) {
            this.scheduleType = i
        },
        setStartDateFilter: function(i) {
            this.startDate = i
        },
        setEndDateFilter: function(i) {
            this.endDate = i
        },
        setSearchTerm: function(i) {
            this.searchTerm = i
        },
        setLiteMode: function(i) {
            this.lite = i
        },
        url: function() {
            var i = "?format=json&teamId=" + this.sectionId;
            if (this.dateSort !== null) {
                i += "&dateSort=" + this.dateSort
            }
            if (this.scheduleType !== null) {
                i += "&scheduleType=" + this.scheduleType
            }
            if (this.startDate !== null) {
                i += "&startDate=" + this.startDate
            }
            if (this.endDate !== null) {
                i += "&endDate=" + this.endDate
            }
            if (this.searchTerm !== null) {
                i += "&searchTerm=" + this.searchTerm
            }
            if (this.lite !== null) {
                i += "&isLite=" + this.lite
            }
            return aP + "athletics/teamscheduleget/" + i
        }
    });
    b.Cs.CalendarItem = Bbc.extend({
        model: b.Ms.ScheduleItem,
        initialize: function(i, j) {
            this.startDate = j.startDate || null;
            this.scheduleDuration = j.scheduleDuration || 0;
            this.scheduleType = j.scheduleType || 0
        },
        url: function() {
            var i = "";
            if (b.Data.SelectedSportLevels.length > 0) {
                i = b.Data.SelectedSportLevels.join()
            }
            return aP + "athletics/athleticcalendarget/?format=json&startDate=" + this.startDate + "&scheduleDuration=" + this.scheduleDuration + "&selectedSportLevels=" + i
        },
        setScheduleTypeFilter: function(i) {
            this.scheduleType = i
        }
    });
    b.Ms.Venue = Bbm.extend({
        idAttribute: "id"
    });
    b.Cs.Venue = Bbc.extend({
        model: b.Ms.Venue,
        url: function() {
            return aP + "datadirect/athleticvenuesget/"
        }
    });
    b.Ms.Location = Bbm.extend({
        idAttribute: "id"
    });
    b.Cs.Location = Bbc.extend({
        model: b.Ms.Location,
        url: function() {
            return aP + "datadirect/athleticlocationsget/"
        }
    });
    b.Ms.Opponent = Bbm.extend({
        idAttribute: "id"
    });
    b.Cs.Opponent = Bbc.extend({
        model: b.Ms.Opponent,
        url: function() {
            return aP + "datadirect/athleticopponentsget/"
        }
    });
    b.Ms.Transportation = Bbm.extend({
        idAttribute: "id"
    });
    b.Cs.Transportation = Bbc.extend({
        model: b.Ms.Transportation,
        url: function() {
            return aP + "datadirect/athletictransportationget/"
        }
    });
    b.Ms.GameGet = Bbm.extend({
        idAttribute: "ScheduleId",
        url: function() {
            return aP + "athleticschedule/gameedit?format=json&scheduleId=" + this.get("ScheduleId")
        }
    });
    b.Ms.GameDelete = Bbm.extend({
        idAttribute: "ScheduleId",
        url: function() {
            return aP + "athleticschedule/gamedelete?format=json&scheduleId=" + this.get("ScheduleId")
        }
    });
    b.Ms.DateUpdate = Bbm.extend({
        idAttribute: "ScheduleId",
        url: function() {
            return aP + "athleticschedule/scheduledatechange?format=json&scheduleId=" + this.get("ScheduleId") + "&newDate=" + this.get("newDate") + "&sendNotification=" + this.get("sendNotification") + "&reschedule=" + this.get("reschedule") + "&endDate=" + this.get("endDate") + "&isGame=" + this.get("isGame")
        }
    });
    b.Ms.PracticeItem = Bbm.extend({
        idAttribute: "PracticeId",
        url: function() {
            var i;
            if (this.get("PracticeId") > 0) {
                i = aP + "athleticschedule/PracticeUpdate"
            } else {
                i = aP + "athleticschedule/PracticeCreate"
            }
            return i
        }
    });
    b.Ms.PublishOptionsSave = Bbm.extend({
        url: "AthleticSchedule/AthleticSchedulePublishSave"
    });
    b.Ms.PublishOptionsGet = Bbm.extend({
        idAttribute: "teamId",
        url: function() {
            return aP + "DataDirect/AthleticSchedulePublishGet?format=json&teamId=" + this.get("teamId")
        }
    });
    b.Cs.PracticeDates = Bbc.extend({
        initialize: function(i, j) {
            this.teamId = j.teamId || 0;
            this.dateStart = j.dateStart || null;
            this.dateEnd = j.dateEnd || null;
            this.excludeGames = j.excludeGames || false;
            this.weekdays = j.weekdays || null;
            this.roomId = j.roomId || 0;
            this.locationId = j.locationId || 0;
            this.transportationId = j.transportationId || 0
        },
        url: function() {
            return aP + "athleticschedule/PracticeDatesGenerate/?format=json&teamId=" + this.teamId + "&dateStart=" + this.dateStart + "&dateEnd=" + this.dateEnd + "&excludeGames=" + this.excludeGames + "&weekdays=" + this.weekdays + "&roomId=" + this.roomId + "&locationId=" + this.locationId + "&transportationId=" + this.transportationId
        }
    });
    b.Ms.PracticeDelete = Bbm.extend({
        idAttribute: "PracticeId",
        url: function() {
            return aP + "athleticschedule/practicedelete?format=json&practiceId=" + this.get("PracticeId") + "&teamId=" + this.get("TeamId")
        }
    });
    b.Ms.PracticeGet = Bbm.extend({
        idAttribute: "PracticeId",
        url: function() {
            return aP + "athleticschedule/practiceedit?format=json&practiceId=" + this.get("PracticeId") + "&teamId=" + this.get("TeamId")
        }
    });
    b.Ms.PracticeDetailsGet = Bbm.extend({
        idAttribute: "ScheduleId",
        url: function() {
            return aP + "datadirect/practicedetailsget?format=json&scheduleId=" + this.get("ScheduleId")
        }
    });
    b.Cs.GameConflicts = Bbc.extend({
        initialize: function(i, j) {
            this.teamId = j.teamId || 0;
            this.gameDate = j.gameDate || null;
            this.scheduleId = j.scheduleId || 0
        },
        url: function() {
            return aP + "athleticschedule/GameUpdateValidate/?format=json&teamId=" + this.teamId + "&gameDate=" + this.gameDate + "&scheduleId=" + this.scheduleId
        }
    });
    b.Cs.PracticeConflicts = Bbc.extend({
        initialize: function(i, j) {
            this.teamId = j.teamId || 0;
            this.dateStart = j.dateStart || null;
            this.dateEnd = j.dateEnd || null;
            this.practiceId = j.practiceId || 0
        },
        url: function() {
            return aP + "athleticschedule/PracticeUpdateValidate/?format=json&teamId=" + this.teamId + "&dateStart=" + this.dateStart + "&dateEnd=" + this.dateEnd + "&practiceId=" + this.practiceId
        }
    });
    b.Cs.SportLevels = Bbc.extend({
        url: function() {
            return aP + "datadirect/sportlevelsget/"
        }
    });
    b.Cs.EditableTeams = Bbc.extend({
        initialize: function(i, j) {
            this.lookupDate = j.lookupDate
        },
        url: function() {
            var i;
            i = aP + "datadirect/EditableTeamsByDate/?format=json&lookupDate=" + c.getDateString(this.lookupDate).ApiFormat();
            return i
        }
    });
    b.Vs.TeamScheduleView = Bb.View.extend({
        template: "athleticschedule/athleticschedule.template.html",
        schedulelistview: undefined,
        events: {
            "click .addGameButton": "gameAddWindow",
            "click .addPracticeButton": "practiceAddWindow",
            "click .scheduleSettingsButton": "publishSettingsWindow",
            "click #scheduleSearchButton": "doScheduleSearch",
            "blur #scheduleSearchBox": "doSearchFix",
            "keypress #scheduleSearchBox": "doScheduleSearchEnter"
        },
        initialize: function() {
            this.Containers = {};
            this.sectionId = this.options.sectionId || 0;
            b.Data.currentLeadSectionId = this.leadSectionId = this.options.leadSectionId || 0;
            this.scheduleItems = null;
            this.userHasFullAccess = this.options.userHasFullAccess || false;
            this.isOwner = this.options.isOwner || false;
            this.isManager = this.options.isManager || false;
            this.content = this.options.content || undefined;
            this.canEdit = false;
            this.isEditor = false;
            if (this.userHasFullAccess) {
                this.canEdit = true
            } else {
                var i = !_.isUndefined(this.content) ? this.content.get(45) : null;
                if (i && i.get("EditorAccess")) {
                    this.canEdit = true;
                    this.isEditor = true
                }
            }
            this.durationId = this.options.durationId || 0;
            this.hideCalendar = this.options.hideCalendar || false;
            this.hideBulkPractices = this.options.hideBulkPractices || false;
            this.isLite = (this.hideCalendar && this.hideBulkPractices);
            this.athleticPrivileges = b.Us.getAthleticPrivileges(this.canEdit, this.isLite, this.hideBulkPractices);
            b.Us.initializeData(this.canEdit);
            b.Us.initializeNotifications(this.sectionId)
        },
        render: function(i) {
            var j = this;
            p3.fT(j.template, function(k) {
                j.$el.html(k({
                    leadSectionId: j.leadSectionId
                }));
                $(i).html(j.el);
                j.Containers.LeftColumn = $("#2col-wideleft");
                j.Containers.RightColumn = $("#2col-slimright");
                j.renderContent()
            })
        },
        renderContent: function() {
            var i = this;
            b.Data.scheduleItems = new b.Cs.ScheduleItem({}, {
                dateSort: 2,
                scheduleType: 0,
                startDate: null,
                endDate: null,
                sectionId: i.leadSectionId,
                lite: i.isLite
            });
            i.schedulelistview = new b.Vs.ScheduleListView({
                collection: b.Data.scheduleItems,
                leadSectionId: i.leadSectionId,
                sectionId: i.sectionId,
                canEdit: i.canEdit,
                isLite: i.isLite
            });
            p3.rV(i.schedulelistview, i.Containers.LeftColumn, false);
            b.Data.scheduleItems.fetch({
                error: function(j, k) {
                    p3.displayError("Error loading schedule")
                }
            });
            p3.rV(new b.Vs.ScheduleFilterView({
                sectionId: i.sectionId,
                leadSectionId: i.leadSectionId,
                scheduleItems: b.Data.scheduleItems,
                canEdit: i.canEdit,
                durationId: i.durationId,
                hideCalendar: i.hideCalendar,
                hideBulkPractices: i.hideBulkPractices
            }), i.Containers.RightColumn, false)
        },
        gameAddWindow: function() {
            var j = this,
                i;
            if (j.athleticPrivileges.canAddGameAndPractice || j.athleticPrivileges.canAddGame) {
                i = new b.Ms.ScheduleItem({
                    ScheduleType: 0,
                    HomeAwayType: 0,
                    LocationId: -1,
                    LeagueInd: 1
                });
                b.Us.openGameScheduleDialog(0, i, j.options.leadSectionId, false, null, false, j.isLite, j.athleticPrivileges)
            } else {
                if (j.athleticPrivileges.canAddPractice) {
                    i = new b.Ms.ScheduleItem({
                        PracticeDate: null
                    });
                    b.Us.openEditPracticeDialog(0, i, j.options.leadSectionId, false, null, false, j.athleticPrivileges)
                }
            }
            return false
        },
        practiceAddWindow: function() {
            var i = this;
            p3.rV(new b.Vs.BulkAddPracticeView({
                sectionId: i.leadSectionId
            }), p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            return false
        },
        publishSettingsWindow: function(i) {
            i.preventDefault();
            var j = this;
            p3.rV(new b.Vs.PublishSettings({
                sectionId: j.leadSectionId,
                isLite: j.isLite
            }), p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal)
        },
        doSearchFix: function(i) {
            if ($("#scheduleSearchBox").val() === "") {
                b.Data.scheduleItems.setSearchTerm("")
            }
        },
        doScheduleSearch: function(i) {
            var j = $("#scheduleSearchBox").val();
            if (j && j !== null) {
                b.Data.scheduleItems.setSearchTerm(j);
                b.Us.updateSchedule()
            }
            return false
        },
        doScheduleSearchEnter: function(i) {
            if (i.keyCode == 13) {
                this.doScheduleSearch(i);
                return false
            }
        }
    });
    b.Vs.ScheduleFilterView = Bb.View.extend({
        template: "athleticschedule/athleticschedulefilter.template.html",
        className: "ch",
        filterRange: {
            allDates: true,
            past: true,
            upcoming: false,
            daterange: false
        },
        events: {
            "click .athletic-event-type-filter": "setScheduleType",
            "click .athletic-schedule-time-filter": "setFilterRange",
            "change #scheduleFilterStartDatePicker": "setDateRange",
            "change #scheduleFilterEndDatePicker": "setDateRange"
        },
        initialize: function(i) {
            this.showDateRanges(false);
            this.filterRange.allDates = false;
            this.filterRange.past = false;
            this.filterRange.upcoming = true;
            this.filterRange.daterange = false;
            this.canEdit = (this.options.canEdit || false);
            this.hideCalendar = (this.options.hideCalendar || false);
            this.hideBulkPractices = (this.options.hideBulkPractices || false);
            this.isLite = (this.hideCalendar && this.hideBulkPractices);
            this.athleticPrivileges = b.Us.getAthleticPrivileges(this.canEdit, this.isLite, this.hideBulkPractices)
        },
        renderTemplate: function() {
            var i = this;
            p3.fT(i.template, function(j) {
                i.$el.html(j({
                    allDates: i.filterRange.allDates,
                    past: i.filterRange.past,
                    upcoming: i.filterRange.upcoming,
                    daterange: i.filterRange.daterange,
                    leadSectionId: i.options.leadSectionId,
                    canEdit: i.canEdit,
                    hideCalendar: i.hideCalendar,
                    hideBulkPractices: i.hideBulkPractices,
                    isLite: i.isLite,
                    athleticPrivileges: i.athleticPrivileges
                }));
                d.Us.initialize("#scheduleFilterStartDatePicker", {
                    changeMonth: true,
                    changeYear: true
                });
                d.Us.initialize("#scheduleFilterEndDatePicker", {
                    changeMonth: true,
                    changeYear: true
                })
            })
        },
        render: function(i) {
            var j = this;
            p3.fT(j.template, function(k) {
                j.$el.html(k({
                    allDates: j.filterRange.allDates,
                    past: j.filterRange.past,
                    upcoming: j.filterRange.upcoming,
                    daterange: j.filterRange.daterange,
                    leadSectionId: j.options.leadSectionId,
                    canEdit: j.canEdit,
                    durationId: j.options.durationId,
                    hideCalendar: j.hideCalendar,
                    hideBulkPractices: j.hideBulkPractices,
                    isLite: j.isLite,
                    athleticPrivileges: j.athleticPrivileges
                }));
                $(i).append(j.el);
                d.Us.initialize("#scheduleFilterStartDatePicker", {
                    changeMonth: true,
                    changeYear: true
                });
                d.Us.initialize("#scheduleFilterEndDatePicker", {
                    changeMonth: true,
                    changeYear: true
                });
                j.showDateRanges(j.filterRange.daterange)
            })
        },
        setScheduleType: function(n) {
            n.preventDefault();
            var l = $(n.currentTarget),
                i = l.find("i"),
                k = l.closest("ul"),
                j = l.closest("ul").find("li"),
                r = l.data("typeId"),
                m = false,
                o, p, q;
            if (r === -1) {
                o = k.find("i");
                if (o.length > 0) {
                    _.each(o, function(s) {
                        $(s).removeClass("p3icon-ok").addClass("p3icon-check");
                        $(s).closest("div").removeClass("active-filter").addClass("inactive-filter")
                    });
                    i.removeClass("p3icon-check").addClass("p3icon-ok");
                    i.closest("div").removeClass("inactive-filter").addClass("active-filter")
                }
                m = true
            } else {
                k.find("i:first").removeClass("p3icon-ok").addClass("p3icon-check");
                k.find("i:first").closest("div").removeClass("active-filter").addClass("inactive-filter");
                if (i.hasClass("p3icon-ok")) {
                    i.removeClass("p3icon-ok").addClass("p3icon-check");
                    i.closest("div").removeClass("active-filter").addClass("inactive-filter")
                } else {
                    i.removeClass("p3icon-check").addClass("p3icon-ok");
                    i.closest("div").removeClass("inactive-filter").addClass("active-filter")
                }
                if (k.find("i.p3icon-ok").length === 0) {
                    k.find("i:first").removeClass("p3icon-check").addClass("p3icon-ok");
                    k.find("i:first").closest("div").removeClass("inactive-filter").addClass("active-filter");
                    m = true
                }
            }
            p = 0;
            if (this.options.scheduleItems) {
                if (!m) {
                    q = j.find(".p3icon-ok");
                    _.each(q, function(s) {
                        p += $(s).closest("a").data("typeId")
                    })
                }
            }
            this.options.scheduleItems.setScheduleTypeFilter(p);
            b.Us.updateSchedule()
        },
        setFilterRange: function(l) {
            l.preventDefault();
            var k = $(l.currentTarget),
                i = k.find("i"),
                j = k.closest("ul"),
                m = j.find("i"),
                n = k.data("typeId");
            if (m.length > 0) {
                _.each(m, function(o) {
                    $(o).removeClass("p3icon-radioOn").addClass("p3icon-radioOff");
                    $(o).closest("div").removeClass("active-filter").addClass("inactive-filter")
                });
                i.removeClass("p3icon-radioOff").addClass("p3icon-radioOn");
                i.closest("div").removeClass("inactive-filter").addClass("active-filter")
            }
            this.filterRange.allDates = false;
            this.filterRange.past = false;
            this.filterRange.upcoming = false;
            this.filterRange.daterange = false;
            if (this.options.scheduleItems) {
                if (n == 3) {
                    this.options.scheduleItems.setDateSortFilter(null);
                    this.filterRange.daterange = true;
                    this.showDateRanges(true)
                } else {
                    this.options.scheduleItems.setDateSortFilter(n);
                    switch (n) {
                        case 0:
                            this.filterRange.allDates = true;
                            break;
                        case 1:
                            this.filterRange.past = true;
                            break;
                        case 2:
                            this.filterRange.upcoming = true;
                            break
                    }
                    this.showDateRanges(false)
                }
            }
            b.Us.updateSchedule()
        },
        setDateRange: function() {
            var k = $("#scheduleFilterStartDatePicker"),
                i = $("#scheduleFilterEndDatePicker"),
                l = k.attr("value") || $(k).datepicker("getDate"),
                j = i.attr("value") || $(i).datepicker("getDate");
            if (l !== null && j !== null && !$(k).hasClass("invalid") && !$(i).hasClass("invalid")) {
                this.options.scheduleItems.setStartDateFilter(c.getDateString(l));
                this.options.scheduleItems.setEndDateFilter(c.getDateString(j));
                b.Us.updateSchedule()
            }
        },
        showDateRanges: function(i) {
            if (i == false) {
                $("#scheduleFilterStartDatePicker").attr("disabled", "disabled");
                $("#scheduleFilterEndDatePicker").attr("disabled", "disabled");
                $("#scheduleFilterStartDatePicker").siblings("label").removeClass("active-filter").addClass("inactive-filter");
                $("#scheduleFilterEndDatePicker").siblings("label").removeClass("active-filter").addClass("inactive-filter")
            } else {
                $("#scheduleFilterStartDatePicker").removeAttr("disabled");
                $("#scheduleFilterEndDatePicker").removeAttr("disabled");
                $("#scheduleFilterStartDatePicker").siblings("label").removeClass("inactive-filter").addClass("active-filter");
                $("#scheduleFilterEndDatePicker").siblings("label").removeClass("inactive-filter").addClass("active-filter")
            }
        }
    });
    b.Vs.ScheduleListView = Bb.View.extend({
        template: "athleticschedule/athleticschedulelistview.template.html",
        className: "ch",
        events: {
            "click a.schedule-list-delete-button": "showDeleteDialog",
            "click a.schedule-list-edit-button": "showEditDialog",
            "click a.athletic-detail-link": "showDetails"
        },
        initialize: function() {
            this.canEdit = this.options.canEdit || false;
            this.isLite = this.options.isLite || false;
            b.Us.initializeData(this.canEdit);
            b.Us.initializeNotifications(this.sectionId);
            this.athleticPrivileges = b.Us.getAthleticPrivileges(this.canEdit, this.isLite, true);
            this.collection.bind("reset change", this.renderTemplate, this)
        },
        renderTemplate: function() {
            var i = this;
            p3.fT(i.template, function(o) {
                var m = "",
                    p = [],
                    k, j, n, l;
                i.collection.each(function(q) {
                    if (q.get("Gamedate")) {
                        j = c.getDate(q.get("Gamedate"));
                        n = c.displayDate(j, "monthYear");
                        if (n !== m) {
                            m = n;
                            k = [];
                            p.push({
                                heading: n,
                                scheduleItems: k
                            })
                        }
                        q.set("Location", q.get("location"));
                        l = q.get("ScheduleTypeText");
                        if (l === "Game") {
                            q.set("UserCanEdit", i.athleticPrivileges.canEditGame)
                        } else {
                            if (l === "Practice") {
                                q.set("UserCanEdit", i.athleticPrivileges.canEditPractice)
                            }
                        }
                        k.push(q.toJSON())
                    }
                });
                if (p.length === 0 && $("#scheduleSearchBox").length > 0) {
                    if ($("#scheduleSearchBox").val() !== "") {
                        i.$el.html("<h5>Your search did not return any results.</h5>")
                    } else {
                        if (b.Data.scheduleItems.dateSort == null && (b.Data.scheduleItems.startDate == null || b.Data.scheduleItems.endDate == null)) {
                            i.$el.html("<h5>Enter date range to view schedule.</h5>")
                        } else {
                            i.$el.html("<h5>There are no schedule items to display.</h5>")
                        }
                    }
                } else {
                    if ($("#scheduleSearchBox").length === 0) {
                        i.$el.html("")
                    } else {
                        i.$el.html(o({
                            leadSectionId: i.options.leadSectionId,
                            sortedItems: p
                        }))
                    }
                }
            })
        },
        renderSearch: function(i) {
            var j = this;
            p3.fT(j.template, function(k) {
                j.$el.html(k({
                    leadSectionId: j.options.leadSectionId,
                    sortedItems: i,
                    athleticPrivileges: j.athleticPrivileges
                }))
            })
        },
        render: function(i) {
            Hb.registerHelper("ScheduleDetailLink", function(k, j) {
                var l = "";
                if (k.ShowDetails) {
                    l += '<a href class="athletic-detail-link" data-schedule-id="' + k.ScheduleId + '" data-type="' + k.ScheduleTypeText + '">Directions & Details</a>'
                }
                return l
            });
            Hb.registerHelper("FormatDate", function(j) {
                var k = c.getDate(j),
                    l;
                l = "<h6>" + c.displayDate(k, "abbrDay") + "</h6>";
                l += "<h1>" + k.getDate() + "</h1>";
                return l
            });
            $(i).append(this.el);
            b.Us.updateSchedule()
        },
        showButtons: function(j) {
            var i = $(j.currentTarget).find("a.btn"),
                k, l;
            for (k = 0, l = i.length; k < l; k++) {
                $(i[k]).show()
            }
        },
        hideButtons: function(j) {
            var i = $(j.currentTarget).find("a.btn"),
                k, l;
            for (k = 0, l = i.length; k < l; k++) {
                $(i[k]).hide()
            }
        },
        showDeleteDialog: function(j) {
            var l = this,
                i = $(j.currentTarget),
                k = i.data("schedule-id");
            if (i.data("type") == "Game") {
                p3.showConfirm(null, "Warning: Once you hit confirm there is no undo button. Are you really sure you want to delete this forever?", null, function() {
                    var m = new b.Ms.GameDelete({
                        ScheduleId: k
                    });
                    m.destroy({
                        error: function() {
                            p3.displayError("Error deleting game")
                        },
                        success: function() {
                            b.Us.updateSchedule()
                        }
                    })
                })
            } else {
                p3.showConfirm(null, "Warning: Once you hit confirm there is no undo button. Are you really sure you want to delete this forever?", null, function() {
                    var m = new b.Ms.PracticeDelete({
                        PracticeId: k,
                        TeamId: l.options.sectionId
                    });
                    m.destroy({
                        error: function() {
                            p3.displayError("Error deleting practice")
                        },
                        success: function() {
                            b.Us.updateSchedule()
                        }
                    })
                })
            }
            return false
        },
        showEditDialog: function(j) {
            var n = this,
                i = $(j.currentTarget),
                m = i.data("schedule-id"),
                k, l;
            if (i.data("type") == "Game") {
                k = b.Us.getGameDetails(m);
                b.Us.openGameScheduleDialog(m, k, n.options.leadSectionId, false, null, false, n.isLite, n.athleticPrivileges)
            } else {
                l = b.Us.getPracticeItem(m, n.options.leadSectionId);
                b.Us.openEditPracticeDialog(m, l, n.options.leadSectionId, false, null, false, n.athleticPrivileges)
            }
            return false
        },
        showDetails: function(j) {
            var i = $(j.currentTarget),
                k = i.data("schedule-id"),
                l;
            if (i.data("type") == "Game") {
                l = b.Us.getGameDetails(k);
                p3.rV(new b.Vs.GameScheduleDetailsView({
                    scheduleItem: l.toJSON()
                }), p3.Layout.Containers.Modal, true)
            } else {
                l = b.Us.getPracticeDetails(k);
                p3.rV(new b.Vs.PracticeDetailsView({
                    scheduleItem: l.toJSON()
                }), p3.Layout.Containers.Modal, true)
            }
            p3.showModal(p3.Layout.Containers.Modal);
            return false
        }
    });
    b.Vs.EditGameScheduleView = Bb.View.extend({
        template: "athleticschedule/gameschedule.edit.template.html",
        events: {
            "click #btnSaveGame": "saveGame",
            "click #btnSaveAddGame": "saveGame",
            "click .opponent-link": "addOpponent",
            "click .transportation-link": "addTransportation",
            "click .opponent-delete-button": "deleteOpponent",
            "click .transport-delete-button": "deleteTransportation",
            "change #rescheduleDropdown": "scheduleChange",
            "click #btnDeleteGame": "deleteGame",
            "click #switch-add-schedule-link": "switchAddMode",
            "change #teamDropdown": "teamChanged"
        },
        initialize: function() {
            this.sectionId = this.options.sectionId || 0;
            this.athleticPrivileges = this.options.athleticPrivileges || {};
            p3.Layout.Containers.Modal.on("shown", function() {
                window.setTimeout(function() {
                    d.Us.initialize(".date-input");
                    h.Us.initialize(".time-picker-field", {
                        placeholder: "TBA",
                        midnight: "TBA"
                    });
                    h.Us.initialize(".time-picker-field-no-tba", {
                        placeholder: "TBA",
                        midnight: "TBA"
                    });
                    window.setTimeout(function() {
                        $(".time-picker-field-no-tba").each(function() {
                            if ($(this).val() == "TBA") {
                                $(this).val("12:00 AM")
                            }
                        })
                    }, 400);
                    $("#send_notif_label").tooltip();
                    p3.setModalHeight(p3.Layout.Containers.Modal)
                }, 400)
            })
        },
        render: function(i) {
            var j = this;
            p3.fT(j.template, function(o) {
                var l = false,
                    m = "",
                    k, n;
                if (j.options.scheduleId > 0) {
                    if (b.Data.editGameNotif && b.Data.editGameNotif.pk == j.options.sectionId) {
                        l = b.Data.editGameNotif.enabled;
                        m = b.Data.editGameNotif.tooltip
                    } else {
                        k = new f.Cs.NotificationActive({}, {
                            actionId: 43,
                            pk: j.options.sectionId
                        });
                        b.Data.editGameNotif = k;
                        k.fetch({
                            async: false,
                            success: function() {
                                k.setNotificationProperties();
                                l = b.Data.editGameNotif.enabled;
                                m = b.Data.editGameNotif.tooltip
                            },
                            error: function() {
                                p3.displayError("Error loading notification settings")
                            }
                        })
                    }
                } else {
                    if (b.Data.addGameNotif && b.Data.addGameNotif.pk == j.options.sectionId) {
                        l = b.Data.addGameNotif.enabled;
                        m = b.Data.addGameNotif.tooltip
                    }
                }
                n = [];
                if (j.options.showTeamPicker) {
                    n = b.Data.EditableTeams.toJSON()
                }
                _.each(j.options.scheduleItem.get("Vehicles"), function(p) {
                    if (p.BeginDate === p.EndDate && p.BeginTime === "00:00:00" && p.EndTime === "23:59:00") {
                        p.AllDaySelected = true
                    }
                });
                j.$el.html(o({
                    scheduleId: j.options.scheduleId,
                    notifEnabled: l,
                    notifTooltip: m,
                    scheduleItem: j.options.scheduleItem.toJSON(),
                    venues: b.Data.venues.toJSON(),
                    locations: b.Data.locations.toJSON(),
                    opponents: b.Data.opponents.toJSON(),
                    transportation: b.Data.transportation.toJSON(),
                    showTeamPicker: j.options.showTeamPicker,
                    teams: n,
                    cancelled: (j.options.scheduleItem.get("CancelType") == 1),
                    athleticPrivileges: j.athleticPrivileges
                }));
                $(i).html(j.el)
            })
        },
        teamChanged: function() {
            $("#teamGroup").removeClass("error");
            var l = $("#teamDropdown").val(),
                j = false,
                k = "",
                i;
            if (l > 0) {
                if (b.Data.addGameNotif && b.Data.addGameNotif.pk == l) {
                    j = b.Data.addGameNotif.enabled;
                    k = b.Data.addGameNotif.tooltip
                } else {
                    i = new f.Cs.NotificationActive({}, {
                        actionId: 42,
                        pk: l
                    });
                    b.Data.addGameNotif = i;
                    i.fetch({
                        async: false,
                        success: function() {
                            i.setNotificationProperties();
                            j = b.Data.addGameNotif.enabled;
                            k = b.Data.addGameNotif.tooltip
                        },
                        error: function() {
                            p3.displayError("Error loading notification settings")
                        }
                    })
                }
            }
            $("#send_notif_label").attr("data-original-title", k);
            if (!j) {
                $("#send_notif_check").addClass("disabled");
                $("#send_notif_check").removeClass("btn-approve")
            } else {
                $("#send_notif_check").removeClass("disabled");
                $("#send_notif_check").addClass("btn-approve")
            }
            if (j) {
                $("#send_notif_check").addClass("active")
            } else {
                $("#send_notif_check").removeClass("active")
            }
        },
        saveGame: function(j) {
            var s = true,
                u = this,
                m = [],
                t = [],
                l = [],
                o = u.options.sectionId,
                n, k, i, p, r, q;
            $("#btnSaveGame").button("loading");
            $("#btnSaveAddGame").button("loading");
            $(".error-message-container").html("");
            i = (j.target.id == "btnSaveAddGame");
            if ($("#gameDate").val().length == 0) {
                s = false;
                $(".game-date-time").addClass("error")
            }
            if (u.options.showTeamPicker) {
                if ($("#teamDropdown").val() == 0) {
                    s = false;
                    $("#teamGroup").addClass("error")
                } else {
                    o = $("#teamDropdown").val()
                }
            }
            if (s) {
                n = new b.Ms.ScheduleItem({
                    ScheduleId: u.options.scheduleId,
                    Opponents: m,
                    Vehicles: t,
                    SectionId: o,
                    DragAndDrop: false
                });
                k = $("#gameDate").val();
                if ($("#gameTime").val()) {
                    k += " " + $("#gameTime").getTime()
                }
                n.set("Gamedate", k);
                if (u.options.scheduleId == 0) {
                    n.set("CancelType", 0)
                } else {
                    if ($("#rescheduleDropdown").val() == 3) {
                        n.set("CancelType", 0);
                        n.set("ClearReschedule", true)
                    } else {
                        n.set("CancelType", $("#rescheduleDropdown").val());
                        if ($("#rescheduleDropdown").val() == "1") {
                            n.set("SkipValidation", true)
                        }
                    }
                }
                n.set("ScheduleType", 0);
                n.set("HomeAwayType", $("#homeAwayDropdown").val());
                if ($("#locationDropdown").val() != "0") {
                    n.set("LocationId", $("#locationDropdown").val());
                    if ($("#locationDropdown :selected").parent().attr("label") == "Venues") {
                        n.set("LocationInd", 0)
                    } else {
                        n.set("LocationInd", 1)
                    }
                }
                $("tr.opponent-row").each(function() {
                    if (!$(this).hasClass("delete-pending")) {
                        m.push({
                            Id: $(this).data("oppid")
                        })
                    }
                });
                $("tr.transport-row").each(function() {
                    if (!$(this).hasClass("delete-pending")) {
                        var z = "",
                            B = "",
                            C = false,
                            E = $(this).data("transid") || 0,
                            x, y, v, w, D, A;
                        if ($("input:radio[name=rdo" + E + "]:checked").val() == 0) {
                            C = true
                        } else {
                            x = $(this).find(".trans-start-date");
                            y = $(this).find(".trans-start-time");
                            v = $(this).find(".trans-end-date");
                            w = $(this).find(".trans-end-time");
                            if (x.val().length == 0 || y.getTime().length == 0 || v.val().length == 0 || w.getTime().length == 0) {
                                s = false;
                                x.addClass("error");
                                y.addClass("error");
                                v.addClass("error");
                                w.addClass("error");
                                if ($.inArray("Whoops! To reserve a vehicle you'll need to enter start and end dates and times.", l) === -1) {
                                    l.push("Whoops! To reserve a vehicle you'll need to enter start and end dates and times.")
                                }
                            }
                            z = x.val() + " " + y.getTime();
                            B = v.val() + " " + w.getTime();
                            D = Date.parse(z);
                            A = Date.parse(B);
                            if (D >= A) {
                                x.addClass("error");
                                y.addClass("error");
                                v.addClass("error");
                                w.addClass("error");
                                s = false;
                                if ($.inArray("Whoops! To reserve a vehicle the start date and time must come before the end date and time.", l) === -1) {
                                    l.push("Whoops! To reserve a vehicle the start date and time must come before the end date and time.")
                                }
                            }
                        }
                        $(this).find("div").removeClass("box-validate");
                        $(this).attr("data-original-title", "");
                        t.push({
                            TransportationId: E,
                            EntireDate: C,
                            BeginDate: z,
                            EndDate: B
                        })
                    }
                });
                p = c.getDateString(c.localDateTime());
                if ($("#dismissalTime").length > 0) {
                    r = $("#dismissalTime").val().trim()
                }
                q = r ? c.isMidnight(r) : false;
                if (r && !q) {
                    r = c.displayTime(c.getTimeString(c.getDate((p + " " + r))), true, "timeSpan");
                    n.set("DismissalTime", r)
                }
                if ($("#departureTime").length > 0) {
                    r = $("#departureTime").val().trim()
                }
                q = r ? c.isMidnight(r) : false;
                if (r && !q) {
                    r = c.displayTime(c.getTimeString(c.getDate((p + " " + r))), true, "timeSpan");
                    n.set("DepartureTime", r)
                }
                if ($("#pickupTime").length > 0) {
                    r = $("#pickupTime").val().trim()
                }
                q = r ? c.isMidnight(r) : false;
                if (r && !q) {
                    r = c.displayTime(c.getTimeString(c.getDate((p + " " + r))), true, "timeSpan");
                    n.set("PickupTime", r)
                }
                n.set("DepartureNote", $("#departureTextbox").val());
                n.set("PickupNote", $("#pickupTextbox").val());
                n.set("Title", $("#titleTextbox").val());
                if ($("#rdoLeague").hasClass("active")) {
                    n.set("LeagueInd", 1)
                } else {
                    n.set("LeagueInd", 0)
                }
                n.set("ScrimmageInd", $("#chkScrimmage").hasClass("active"));
                n.set("TournamentInd", $("#chkTournament").hasClass("active"));
                n.set("InvitationalInd", $("#chkInvitational").hasClass("active"));
                n.set("PlayoffInd", $("#chkPlayoff").hasClass("active"));
                n.set("AdditionalNotes", $("#txtNotes").val());
                n.set("SendNotification", $("#send_notif_check").hasClass("active"))
            }
            if (s) {
                n.save({}, {
                    error: function() {
                        p3.showModal(p3.Layout.Containers.Modal, "hide");
                        p3.displayError("Error saving Game")
                    },
                    success: function(w, x) {
                        var v = w.get("Conflicts"),
                            y = (!v || v.length == 0),
                            z;
                        if (!y) {
                            b.Us.openScheduleConfirmDialog(n, true, u.options.scheduleId > 0, b.Us.getConflictText(v), u.options.calendarView, false, i, null, u.sectionId, u.options.dashboardView, u.options.showTeamPicker, u);
                            $("#btnSaveGame").button("reset");
                            $("#btnSaveAddGame").button("reset")
                        }
                        if (y) {
                            if (i) {
                                z = new b.Ms.ScheduleItem({
                                    GameType: 0,
                                    HomeAway: 0,
                                    LocationId: -1,
                                    LeagueInd: 1
                                });
                                p3.rV(new b.Vs.EditGameScheduleView({
                                    scheduleId: 0,
                                    scheduleItem: z,
                                    sectionId: u.sectionId,
                                    calendarView: u.options.calendarView,
                                    showTeamPicker: u.options.showTeamPicker,
                                    isLite: u.options.isLite
                                }), p3.Layout.Containers.Modal, true);
                                d.Us.initialize(".date-input");
                                p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.TimePicker, function() {
                                    $(".time-picker-field").timepicker({
                                        placeholder: "TBA",
                                        midnight: "TBA",
                                        render24Hour: c.is24HourFormat()
                                    })
                                });
                                $("#send_notif_label").tooltip();
                                p3.setModalHeight(p3.Layout.Containers.Modal)
                            } else {
                                u.trigger("dataModified");
                                p3.showModal(p3.Layout.Containers.Modal, "hide")
                            }
                            if (u.options.dashboardView) {
                                u.options.dashboardView.refreshDashboard()
                            } else {
                                if (u.options.calendarView) {
                                    b.Us.updateCalendar(u.sectionId)
                                } else {
                                    b.Us.updateSchedule()
                                }
                            }
                        }
                    }
                })
            } else {
                $("#btnSaveGame").button("reset");
                $("#btnSaveAddGame").button("reset");
                _.each(l, function(v) {
                    p3.Us.InfoMessage.ErrorBox(v, ".error-message-container", false)
                })
            }
            return false
        },
        scheduleChange: function(i) {
            if ($("#rescheduleDropdown").val() == 2) {
                $("#original_date").show();
                $("#gameDate").val("");
                $("#gameTime").val("")
            } else {
                $("#original_date").hide()
            }
        },
        addOpponent: function(j) {
            var l = $(j.currentTarget).data("id"),
                i = true,
                k;
            $("tr.opponent-row").each(function(m) {
                if ($(this).data("oppid") == l) {
                    i = false
                }
            });
            if (i) {
                k = '<tr class="opponent-row" data-oppid="' + l + '"><td width="95%">' + $(j.currentTarget).text() + "</td>";
                k += '<td><button data-oppid="' + l + '" data-add="1" class="btn opponent-delete-button"><i class="p3icon-delete"></i></button></td></tr>';
                $("#opponentTable tbody:last").append(k);
                p3.setModalHeight(p3.Layout.Containers.Modal)
            }
            $(".btn-group.open").removeClass("open");
            return false
        },
        deleteOpponent: function(k) {
            var i = $(k.currentTarget),
                j;
            if (i.data("add") == "1") {
                i.closest("tr").remove()
            } else {
                i.closest("tr").addClass("delete-pending");
                j = i.closest("tr").find("td");
                j[0].innerHTML = '<div class="alert alert-error">This opponent will be deleted on save.</div>';
                j[1].innerHTML = "&nbsp;"
            }
        },
        addTransportation: function(j) {
            var m = $(j.currentTarget).data("id"),
                i = true,
                l, k;
            $("tr.transport-row").each(function(n) {
                if ($(this).data("transid") == m) {
                    i = false
                }
            });
            if (i) {
                l = $("#gameDate").val();
                k = '<tr class="transport-row" data-transid="' + m + '" ><td width="95%"><div>' + $(j.currentTarget).text() + "<br />";
                k += '<label class="radio"><input type="radio" name="rdo' + m + '" value="0" checked="">Entire Day</label>';
                k += '<label class="radio"><input type="radio" name="rdo' + m + '" value="1">Specific Time Period</label>';
                k += '&nbsp;&nbsp;&nbsp;&nbsp;Start:&nbsp;<input type="text" class="input-small trans-start-date date-input" style="margin-bottom:4px;" value="' + l + '"/>&nbsp;<input type="text" class="input-mini trans-start-time time-picker-field" style="margin-bottom:4px;"/><br />';
                k += '&nbsp;&nbsp;&nbsp;&nbsp;End:&nbsp;&nbsp;<input type="text" class="input-small trans-end-date date-input" value="' + l + '"/>&nbsp;<input type="text" class="input-mini trans-end-time time-picker-field"/>';
                k += "</div></td>";
                k += '<td><button data-transid="' + m + '" data-add="1" class="btn btn-default transport-delete-button"><i class="p3icon-delete"></i></button></td></tr>';
                $("#transportTable tbody:last").append(k);
                d.Us.initialize(".date-input");
                $(".time-picker-field").timepicker({
                    render24Hour: c.is24HourFormat()
                });
                p3.setModalHeight(p3.Layout.Containers.Modal)
            }
            $(".btn-group.open").removeClass("open");
            return false
        },
        deleteTransportation: function(k) {
            var i = $(k.currentTarget),
                j;
            if (i.data("add") == "1") {
                i.closest("tr").remove()
            } else {
                i.closest("tr").addClass("delete-pending");
                j = i.closest("tr").find("td");
                j[0].innerHTML = '<div class="alert alert-error">This vehicle will be deleted on save.</div>';
                j[1].innerHTML = "&nbsp;"
            }
            $(".tooltip").remove()
        },
        deleteGame: function(j) {
            var k = this,
                i = new b.Ms.GameDelete({
                    ScheduleId: k.options.scheduleId
                });
            b.Us.showDeleteConfirm(i, k.sectionId, k.options.calendarView, k)
        },
        switchAddMode: function(i) {
            var l = this,
                j, k;
            p3.showModal(p3.Layout.Containers.Modal, "hide");
            if (l.options.calendarView || l.options.dashboardView) {
                j = l.options.scheduleItem.get("Gamedate")
            }
            k = new b.Ms.ScheduleItem({
                PracticeDate: j
            });
            b.Us.openEditPracticeDialog(0, k, l.sectionId, l.options.calendarView, l.options.dashboardView, l.options.showTeamPicker, l.athleticPrivileges, l.options.dataModifiedCallback);
            return false
        }
    });
    b.Vs.GameScheduleDetailsView = Bb.View.extend({
        template: "athleticschedule/athleticschedule.details.template.html",
        events: {},
        initialize: function() {
            this.scheduleItem = this.options.scheduleItem;
            p3.Layout.Containers.Modal.on("shown", function() {
                window.setTimeout(function() {
                    p3.setModalHeight(p3.Layout.Containers.Modal)
                }, 400)
            })
        },
        render: function(i) {
            var n = this,
                l = false,
                m = false,
                k = n.scheduleItem,
                j;
            if (k.DismissalTime || k.Vehicles.length > 0 || k.DepartureNote || k.DepartureTime || k.PickupNote || k.PickupTime || k.AdditionalNotes) {
                l = true
            }
            j = k.LocationDetail;
            if (j.Directions || j.MapUrl || j.AddressLine1 || k.RoomDirections) {
                m = true;
                if (j.Directions) {
                    j.Directions = j.Directions.replace(/\r/g, "<br />")
                }
                if (k.RoomDirections) {
                    k.RoomDirections = k.RoomDirections.replace(/\r/g, "<br />")
                }
            }
            p3.fT(n.template, function(r) {
                var o = "",
                    q = "",
                    p = "";
                if (j.AddressLine1) {
                    o = encodeURIComponent(j.AddressLine1);
                    q = j.AddressLine1;
                    p = j.AddressLine1;
                    if (j.AddressLine2) {
                        o += "," + encodeURIComponent(j.AddressLine2);
                        q += j.AddressLine2;
                        p += "<br />" + j.AddressLine2
                    }
                    if (j.AddressLine3) {
                        o += "," + encodeURIComponent(j.AddressLine3);
                        q += " " + j.AddressLine3;
                        p += "<br />" + j.AddressLine3
                    }
                    if (j.City) {
                        o += "," + encodeURIComponent(j.City);
                        q += " " + j.City;
                        p += "<br />" + j.City
                    }
                    if (j.StateShort) {
                        o += "," + encodeURIComponent(j.StateShort);
                        q += " " + j.StateShort;
                        if (j.City) {
                            p += ", " + j.StateShort
                        } else {
                            p += "<br />" + j.StateShort
                        }
                    }
                    if (j.Zip) {
                        o += "," + encodeURIComponent(j.Zip);
                        q += " " + j.Zip;
                        if (j.City || j.State) {
                            p += " " + j.Zip
                        } else {
                            p += "<br />" + j.Zip
                        }
                    }
                }
                n.$el.html(r({
                    scheduleItem: k,
                    showDetail: l,
                    showDirections: m,
                    address: p
                }));
                $(i).html(n.el);
                if (j.AddressLine1) {
                    b.Us.addMapScript(q, o)
                }
            })
        }
    });
    b.Vs.PracticeDetailsView = Bb.View.extend({
        template: "athleticschedule/practice.details.template.html",
        events: {},
        initialize: function() {
            this.scheduleItem = this.options.scheduleItem;
            p3.Layout.Containers.Modal.on("shown", function() {
                window.setTimeout(function() {
                    p3.setModalHeight(p3.Layout.Containers.Modal)
                }, 400)
            })
        },
        render: function(i) {
            var m = this,
                k = false,
                l = false,
                j = m.scheduleItem;
            if (j.DismissalTime || j.transportation_name || j.DepartureTime || j.PickupTime || j.practice_note) {
                k = true
            }
            if (j.directions || j.map_url || j.line_one) {
                l = true;
                if (j.directions) {
                    j.directions = j.directions.replace(/\r/g, "<br />")
                }
            }
            p3.fT(m.template, function(q) {
                var n = "",
                    p = "",
                    o = "";
                if (j.line_one) {
                    n = encodeURIComponent(j.line_one);
                    p = j.line_one;
                    o = j.line_one;
                    if (j.line_two) {
                        n += "," + encodeURIComponent(j.line_two);
                        p += j.line_two;
                        o += "<br />" + j.line_two
                    }
                    if (j.line_three) {
                        n += "," + encodeURIComponent(j.line_three);
                        p += " " + j.line_three;
                        o += "<br />" + j.line_three
                    }
                    if (j.city) {
                        n += "," + encodeURIComponent(j.city);
                        p += " " + j.city;
                        o += "<br />" + j.city
                    }
                    if (j.state_short) {
                        n += "," + encodeURIComponent(j.state_short);
                        p += " " + j.state_short;
                        if (j.city) {
                            o += ", " + j.state_short
                        } else {
                            o += "<br />" + j.state_short
                        }
                    }
                    if (j.zip) {
                        n += "," + encodeURIComponent(j.zip);
                        p += " " + j.zip;
                        if (j.city || j.state_short) {
                            o += " " + j.zip
                        } else {
                            o += "<br />" + j.zip
                        }
                    }
                }
                m.$el.html(q({
                    scheduleItem: j,
                    showDetail: k,
                    showDirections: l,
                    address: o
                }));
                $(i).html(m.el);
                if (j.line_one) {
                    b.Us.addMapScript(p, n)
                }
            })
        }
    });
    b.Vs.CalendarView = Bb.View.extend({
        template: "page/page.1col.wide.template.html",
        events: {
            "click .scheduleTypeFilter": "setScheduleType",
            "click #week-view": "weekView",
            "click #month-view": "monthView",
            "click #button-today": "gotoToday",
            "click #button-previous": "movePrevious",
            "click #button-next": "moveNext"
        },
        initialize: function() {
            this.userHasFullAccess = this.options.userHasFullAccess || false;
            this.isOwner = this.options.isOwner || false;
            this.isManager = this.options.isManager || false;
            this.content = this.options.content;
            this.canEdit = false;
            this.isEditor = false;
            if (this.userHasFullAccess) {
                this.options.canEdit = true
            } else {
                var i = this.content.get(45);
                if (i && i.get("EditorAccess")) {
                    this.options.canEdit = true;
                    this.isEditor = true
                }
            }
            b.Us.initializeData(this.options.canEdit);
            b.Us.initializeNotifications(this.options.sectionId);
            b.Data.fullView = false
        },
        render: function(i) {
            p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.jQueryUI, function() {
                return true
            });
            var j = this;
            $(i).html(this.el);
            p3.fT(j.template, function(k) {
                j.$el.html(k());
                b.Data.leadSectionId = j.options.leadSectionId;
                b.Data.scheduleItems = new b.Cs.ScheduleItem({}, {
                    dateSort: 0,
                    scheduleType: 0,
                    startDate: null,
                    endDate: null,
                    sectionId: j.options.leadSectionId
                });
                b.Data.scheduleItems.fetch({
                    error: function(l, m) {
                        p3.displayError("Error loading schedule")
                    },
                    success: function(l, m) {
                        b.Us.BuildCalendarEventArray(j.options.leadSectionId, j.options.canEdit);
                        p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.AthleticCalendar, j.initializeCalendar, j.options)
                    }
                })
            })
        },
        initializeCalendar: function(i) {
            b.Us.initializeCalendar(i)
        },
        setScheduleType: function(i) {
            b.Us.setScheduleType(i);
            b.Us.updateCalendar(b.Data.leadSectionId)
        },
        weekView: function(i) {
            $("#col-main").fullCalendar("changeView", "basicWeek")
        },
        monthView: function(i) {
            $("#col-main").fullCalendar("changeView", "month")
        },
        gotoToday: function(i) {
            $("#col-main").fullCalendar("today")
        },
        movePrevious: function(i) {
            $("#col-main").fullCalendar("prev")
        },
        moveNext: function(i) {
            $("#col-main").fullCalendar("next")
        }
    });
    b.Vs.FullCalendarView = Bb.View.extend({
        template: "page/page.1col.wide.template.html",
        events: {
            "click .scheduleTypeFilter": "setScheduleType",
            "click #week-view": "weekView",
            "click #month-view": "monthView",
            "click #button-today": "gotoToday",
            "click #button-previous": "movePrevious",
            "click #button-next": "moveNext",
            "click #sport-picker-button": "openSportPicker"
        },
        initialize: function() {
            var l = this,
                j = p3.Data.Context.getSelectedPersona().Id,
                k, i;
            if (j === 3 || j === 5) {
                l.options.canEdit = true
            } else {
                l.options.canEdit = false
            }
            l.options.fullCalendar = true;
            b.Us.initializeData(l.options.canEdit);
            b.Data.SelectedSportLevels = [];
            b.Data.SportLevels = new b.Cs.SportLevels();
            b.Data.SportLevels.fetch({
                error: function() {
                    p3.displayError("Error loading sport levels")
                }
            });
            b.Data.SelectedSports = new b.Cs.SportLevels();
            b.Data.SelectedSports.remove(b.Data.SelectedSports.at(0));
            l.todayDate = c.localDateTime();
            k = new Date(this.todayDate);
            k.setMonth(k.getMonth() - 3);
            i = new Date(this.todayDate);
            i.setMonth(i.getMonth() + 3);
            b.Data.startDate = k;
            b.Data.endDate = i;
            b.Data.fullView = true;
            l.options.athleticPrivileges = b.Us.getAthleticPrivileges(l.options.canEdit, false, true)
        },
        render: function(i) {
            p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.jQueryUI, function() {
                return true
            });
            var j = this;
            $(i).html(this.el);
            p3.fT(j.template, function(l) {
                j.$el.html(l());
                var k = '<div id="loading" class="alert alert-info" style="position: absolute; left: 47%; top: 38%; padding:6px; border:solid 1px #ff000;text-align: center;z-index: 1000; "><span id="load-icon"></span></div>';
                $("#col-main").prepend(k);
                p3.loadingIcon("#load-icon");
                b.Data.scheduleItems = new b.Cs.CalendarItem({}, {
                    startDate: c.getDateString(j.todayDate).ApiFormat(),
                    scheduleDuration: 0
                });
                b.Data.scheduleItems.fetch({
                    error: function(m, n) {
                        p3.displayError("Error loading schedule")
                    },
                    success: function(m, n) {
                        b.Us.BuildCalendarEventArray(0, j.options.canEdit);
                        p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.AthleticCalendar, j.initializeCalendar, j.options);
                        $("#loading").remove()
                    }
                })
            })
        },
        initializeCalendar: function(i) {
            b.Us.initializeCalendar(i)
        },
        setScheduleType: function(i) {
            b.Us.setScheduleType(i);
            $("#col-main").fullCalendar("removeEvents");
            b.Us.BuildCalendarEventArray(0, true);
            $("#col-main").fullCalendar("addEventSource", b.Data.CalendarEvents)
        },
        weekView: function(i) {
            var j = this;
            $("#col-main").fullCalendar("changeView", "basicWeek");
            j.ensureData()
        },
        monthView: function(i) {
            var j = this;
            $("#col-main").fullCalendar("changeView", "month");
            j.ensureData()
        },
        gotoToday: function(j) {
            var m = this,
                l = c.localDateTime(),
                n = l.getFullYear(),
                k = l.getMonth(),
                i = l.getDate();
            if (l) {
                $("#col-main").fullCalendar("gotoDate", n, k, i);
                m.ensureData()
            }
        },
        movePrevious: function(i) {
            var j = this;
            $("#col-main").fullCalendar("prev");
            j.ensureData()
        },
        moveNext: function(i) {
            var j = this;
            $("#col-main").fullCalendar("next");
            j.ensureData()
        },
        ensureData: function() {
            var m = this,
                k = 0,
                l, j = $("#col-main").fullCalendar("getView"),
                i;
            if (j.visStart < b.Data.startDate) {
                k = -3;
                l = b.Data.startDate
            } else {
                if (j.visEnd > b.Data.endDate) {
                    k = 3;
                    l = b.Data.endDate
                }
            }
            if (k != 0) {
                i = new b.Cs.CalendarItem({}, {
                    startDate: c.getDateString(l).ApiFormat(),
                    scheduleDuration: k
                });
                i.fetch({
                    error: function(n, o) {
                        p3.displayError("Error loading additional events")
                    },
                    success: function(n, o) {
                        i.each(function(p) {
                            if (k == 3) {
                                b.Data.scheduleItems.push(p)
                            } else {
                                b.Data.scheduleItems.unshift(p)
                            }
                        });
                        if (k == 3) {
                            b.Data.endDate.setMonth(b.Data.endDate.getMonth() + 3)
                        } else {
                            b.Data.startDate.setMonth(b.Data.startDate.getMonth() - 3)
                        }
                        $("#col-main").fullCalendar("removeEvents");
                        b.Us.BuildCalendarEventArray(0, m.options.canEdit);
                        $("#col-main").fullCalendar("addEventSource", b.Data.CalendarEvents)
                    }
                })
            }
        },
        openSportPicker: function() {
            p3.rV(new b.Vs.TeamPicker({}), p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal)
        }
    });
    b.Vs.BulkAddPracticeView = Bb.View.extend({
        template: "athleticschedule/bulkpractice.template.html",
        events: {
            "click #btnSave": "savePractices",
            "click #btnApply": "applyPracticeOptions",
            "change #teamDropdown": "teamChanged"
        },
        initialize: function() {
            this.sectionId = this.options.sectionId || 0;
            p3.Layout.Containers.Modal.on("shown", function() {
                window.setTimeout(function() {
                    d.Us.initialize(".date-input");
                    p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.TimePicker, function() {
                        $(".time-picker-field").timepicker({
                            render24Hour: c.is24HourFormat()
                        })
                    });
                    $("#send_notif_label").tooltip();
                    p3.setModalHeight(p3.Layout.Containers.Modal)
                }, 400)
            })
        },
        render: function(i) {
            var k = this,
                j = [];
            if (k.options.showTeamPicker) {
                j = b.Data.EditableTeams.toJSON()
            }
            p3.fT(k.template, function(l) {
                k.$el.html(l({
                    venues: b.Data.venues.toJSON(),
                    locations: b.Data.locations.toJSON(),
                    transportation: b.Data.transportation.toJSON(),
                    showTeamPicker: k.options.showTeamPicker,
                    teams: j
                }));
                $(i).html(k.el)
            })
        },
        dayDifference: function(m, k) {
            var i = 1000 * 60 * 60 * 24,
                n = m.getTime(),
                l = k.getTime(),
                j = Math.abs(l - n);
            return Math.round(j / i)
        },
        teamChanged: function(i) {
            $("#practiceTable tbody").children().remove();
            if ($("#teamDropdown").val() != 0) {
                $("#teamDropdown").removeClass("box-validate")
            }
        },
        applyPracticeOptions: function(n) {
            var z = true,
                B = this,
                r = "",
                m = [],
                u, o, p, A, v, t, l, j, x, w, s, k, q, y;
            $("#practiceTable tbody").children().remove();
            $("#btnApply").button("loading");
            $(".modal-body").find("div.alert:first").remove();
            if ($("#startDate").val().length == 0) {
                z = false;
                $("#startDate").addClass("error");
                r = "Please enter a start date."
            } else {
                u = c.getDate($("#startDate").val());
                if ($("#endDate").val().length > 0) {
                    o = c.getDate($("#endDate").val())
                } else {
                    o = u
                }
                if ($(".day-button.active").length > 0) {
                    A = false;
                    v = c.getDate($("#startDate").val());
                    $(".day-button.active").each(function() {
                        m.push($(this).data("day"))
                    });
                    for (p = 0; p <= B.dayDifference(u, o); p++) {
                        if (m.indexOf(v.getDay()) > -1) {
                            A = true;
                            break
                        }
                        v.setDate(v.getDate() + 1)
                    }
                    if (!A) {
                        r = "No practices would be created for the date range and days of the week selected.";
                        z = false
                    }
                } else {
                    z = false;
                    r = "Please select a day of the week."
                }
            }
            t = B.options.sectionId;
            if (B.options.showTeamPicker) {
                if ($("#teamDropdown").val() == 0) {
                    z = false;
                    $("#teamDropdown").addClass("box-validate")
                } else {
                    t = $("#teamDropdown").val()
                }
            }
            if (z) {
                l = $("#startDate").val();
                l = l.ApiFormat();
                if ($("#endDate").val().length > 0) {
                    j = $("#endDate").val();
                    j = j.ApiFormat()
                } else {
                    j = l
                }
                x = $("#startTime").getTime();
                if (x) {
                    x = x.ApiFormat();
                    l += " " + x
                }
                w = $("#endTime").getTime();
                if (w) {
                    w = w.ApiFormat();
                    j += " " + w
                } else {
                    if ($("#startTime").getTime()) {
                        j += " " + x
                    }
                }
                s = 0;
                q = 0;
                y = 0;
                if ($("#locationDropdown").val() != "0") {
                    if ($("#locationDropdown :selected").parent().attr("label") == "Venues") {
                        s = $("#locationDropdown").val()
                    } else {
                        q = $("#locationDropdown").val()
                    }
                }
                if ($("#transportationDropdown").val() != "0") {
                    y = $("#transportationDropdown").val()
                }
                k = new b.Cs.PracticeDates({}, {
                    teamId: t,
                    dateStart: l,
                    dateEnd: j,
                    excludeGames: ($("#chkExcludeGame").is(":checked")),
                    weekdays: m,
                    roomId: s,
                    locationId: q,
                    transportationId: y
                });
                k.fetch({
                    error: function(i, C) {
                        p3.displayError("Error validating dates.")
                    },
                    success: function(i, C) {
                        $("#practiceContainer").show();
                        $("#btnSave").attr("disabled", false);
                        B.outputPotentialPractices(k.toJSON())
                    }
                })
            } else {
                if (r.length > 0) {
                    p3.Us.InfoMessage.ErrorBox(r, ".modal-body", false)
                }
                $("#btnSave").attr("disabled", true)
            }
            $("#btnApply").button("reset");
            return false
        },
        outputPotentialPractices: function(p) {
            var A = this,
                r, v, q, t = '<select class="location-dropdown span2 form-control"><option value="0">-- Select A Location --</option>',
                y = '<select class="transportation-dropdown span2 form-control"><option value="0">-- Select Vehicle --</option>',
                u, n, z, o, x, w, s, m = function(i) {
                    u += '<option value="' + i.get("id") + '"';
                    if (i.get("id") == p[r].RoomId && p[r].LocationInd == 0) {
                        u += " selected"
                    }
                    u += ">" + i.get("name") + "</option>"
                },
                k = function(i) {
                    u += '<option value="' + i.get("id") + '"';
                    if (i.get("id") == p[r].LocationId && p[r].LocationInd == 1) {
                        u += " selected"
                    }
                    u += ">" + i.get("name") + "</option>"
                },
                l = function(i) {
                    u += '<option value="' + i.get("id") + '"';
                    if (i.get("id") == p[r].TransportationId) {
                        u += " selected"
                    }
                    u += ">" + i.get("name") + "</option>"
                };
            A.tempDates = p;
            if (p.length == 0) {
                $("#practiceTable tbody:last").append('<tr><td colspan="5">No available dates.</td></tr>');
                $("#btnSave").attr("disabled", true)
            }
            u = "";
            for (r = 0; r < p.length; r++) {
                v = c.getDate(p[r].StartDate);
                q = c.getDate(p[r].EndDate);
                u = "<tr><td>" + c.displayDate(v, "shortDayDate") + "</td>";
                u += "<td>" + c.getTimeString(v) + " - " + c.getTimeString(q) + "</td>";
                u += "<td>" + t;
                if (b.Data.venues.length > 0) {
                    u += '<optgroup label="Venues">';
                    b.Data.venues.each(m);
                    u += "</optgroup>"
                }
                if (b.Data.locations.length > 0) {
                    u += '<optgroup label="Locations">';
                    b.Data.locations.each(k);
                    u += "</optgroup>"
                }
                u += "</select><td>" + y;
                if (b.Data.transportation.length > 0) {
                    b.Data.transportation.each(l)
                }
                u += "</select></td>";
                u += "<td>";
                z = "";
                n = p[r].Conflicts;
                if (n && n.length > 0) {
                    z = "<h4>Potential Conflicts</h4>";
                    o = -1;
                    for (s = 0; s < n.length; s++) {
                        x = c.getTimeString(c.getDate(c.getDateString(c.localDateTime()) + " " + n[s].ConflictTime));
                        w = c.isMidnight(x);
                        switch (n[s].ConflictType) {
                            case 0:
                                if (n[s].ConflictType != o) {
                                    z += "<h5>Game:</h5>"
                                }
                                z += "Start Time: " + x + "<br />";
                                break;
                            case 1:
                                if (n[s].ConflictType != o) {
                                    z += "<h5>Practice:</h5>"
                                }
                                z += "Start Time: " + x + "<br />";
                                break;
                            case 2:
                                if (n[s].ConflictType != o) {
                                    z += "<h5>Location:</h5>"
                                }
                                z += n[s].ConflictDescription + " by " + n[s].ConflictTeam + " at " + x + "<br />";
                                break;
                            case 3:
                                if (n[s].ConflictType != o) {
                                    z += "<h5>Vehicle:</h5>"
                                }
                                z += n[s].ConflictDescription + " by " + n[s].ConflictTeam;
                                if (w) {
                                    z += " all day<br />"
                                } else {
                                    z += " at ";
                                    z += x + "<br />"
                                }
                                break
                        }
                        o = n[s].ConflictType
                    }
                }
                if (z.length > 0) {
                    u += '<i class="p3icon-warning" rel="tooltip" data-original-title="' + z + '" ></i>'
                }
                u += "</td></tr>";
                $("#practiceTable tbody:last").append(u)
            }
            $(".p3icon-warning").tooltip();
            p3.setModalHeight(p3.Layout.Containers.Modal)
        },
        savePractices: function(i) {
            var r = this,
                q = true,
                m = r.options.sectionId,
                k, j, l, n, p, o;
            if ($("#practiceTable tbody").children().length > 0) {
                if (r.options.showTeamPicker) {
                    if ($("#teamDropdown").val() == 0) {
                        q = false;
                        $("#teamDropdown").addClass("box-validate")
                    } else {
                        m = $("#teamDropdown").val()
                    }
                }
                if (q) {
                    k = [];
                    $("#practiceTable tbody").children().each(function(s) {
                        j = 0;
                        if ($(this).find(".location-dropdown").val() != "0") {
                            if ($(this).find(".location-dropdown :selected").parent().attr("label") == "Locations") {
                                j = 1
                            }
                        }
                        k.push({
                            StartDate: r.tempDates[s].StartDate,
                            EndDate: r.tempDates[s].EndDate,
                            TransportationId: $(this).find(".transportation-dropdown").val(),
                            LocationId: $(this).find(".location-dropdown").val(),
                            LocationInd: j
                        })
                    });
                    l = new b.Ms.PracticeItem({
                        PracticeId: 0,
                        TeamId: m,
                        SkipValidation: false,
                        PracticeList: k,
                        BulkAdd: true
                    });
                    n = c.getDateString(c.localDateTime());
                    p = $("#dismissalTime").val().trim();
                    o = p ? c.isMidnight(p) : false;
                    if (p && !o) {
                        p = c.displayTime(c.getTimeString(c.getDate((n + " " + p))), true, "timeSpan");
                        l.set("DismissalTime", p)
                    }
                    p = $("#departureTime").val().trim();
                    o = p ? c.isMidnight(p) : false;
                    if (p && !o) {
                        p = c.displayTime(c.getTimeString(c.getDate((n + " " + p))), true, "timeSpan");
                        l.set("DepartureTime", p)
                    }
                    p = $("#pickupTime").val().trim();
                    o = p ? c.isMidnight(p) : false;
                    if (p && !o) {
                        p = c.displayTime(c.getTimeString(c.getDate((n + " " + p))), true, "timeSpan");
                        l.set("PickupTime", p)
                    }
                    l.save({}, {
                        error: function() {
                            p3.showModal(p3.Layout.Containers.Modal, "hide");
                            p3.displayError("Error saving Practices")
                        },
                        success: function(v, x) {
                            var u = v.get("Conflicts"),
                                w = v.get("PracticeList"),
                                y = true,
                                z, t, s;
                            if (u && u.length > 0) {
                                y = false;
                                $("#practiceTable tbody").children().remove();
                                r.outputPotentialPractices(w);
                                z = '<div class="modal hide " tabindex="-1" id="validate-modal"></div>';
                                $(z).modal();
                                t = function() {
                                    $("#validate-modal").modal("hide");
                                    $("#validate-modal").remove();
                                    l.set("SkipValidation", true);
                                    l.save({}, {
                                        error: function() {
                                            p3.showModal(p3.Layout.Containers.Modal, "hide");
                                            p3.displayError("Error saving Practices")
                                        },
                                        success: function(A, B) {
                                            p3.showModal(p3.Layout.Containers.Modal, "hide");
                                            if (r.options.dashboardView) {
                                                r.options.dashboardView.refreshDashboard()
                                            } else {
                                                if (r.options.calendarView) {
                                                    b.Us.updateCalendar(r.sectionId)
                                                } else {
                                                    b.Us.updateSchedule()
                                                }
                                            }
                                        }
                                    })
                                };
                                s = function() {
                                    $("#validate-modal").modal("hide");
                                    $("#validate-modal").remove()
                                };
                                p3.rV(new a.Vs.Confirm({
                                    ConfirmationTitle: "Practice Conflicts",
                                    ConfirmationText: 'There are potential conflicts with the practice dates you are saving. Press "Confirm" to continue saving or "Cancel" to edit before saving.',
                                    ConfirmCallback: t,
                                    CancelCallback: s,
                                    KeepOpen: true
                                }), "#validate-modal", true)
                            }
                            if (y) {
                                p3.showModal(p3.Layout.Containers.Modal, "hide");
                                if (r.options.dashboardView) {
                                    r.options.dashboardView.refreshDashboard()
                                } else {
                                    if (r.options.calendarView) {
                                        b.Us.updateCalendar(r.sectionId)
                                    } else {
                                        b.Us.updateSchedule()
                                    }
                                }
                            }
                        }
                    })
                }
            } else {
                p3.Us.InfoMessage.ErrorBox("There are no practices to add.", ".modal-body", false)
            }
            return false
        }
    });
    b.Vs.EditPracticeView = Bb.View.extend({
        template: "athleticschedule/practice.edit.template.html",
        events: {
            "click #btnSave": "savePractice",
            "change #practiceDate": "removeDateValidation",
            "change #startTime": "removeTimeValidation",
            "change #endTime": "removeTimeValidation",
            "click #btnDeletePractice": "deletePractice",
            "click #switch-add-schedule-link": "switchAddMode",
            "change #teamDropdown": "teamChanged"
        },
        initialize: function() {
            this.sectionId = this.options.sectionId || 0;
            this.athleticPrivileges = this.options.athleticPrivileges || {};
            p3.Layout.Containers.Modal.on("shown", function() {
                window.setTimeout(function() {
                    d.Us.initialize(".date-input");
                    p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.TimePicker, function() {
                        $(".time-picker-field").timepicker()
                    });
                    $("#send_notif_label").tooltip();
                    p3.setModalHeight(p3.Layout.Containers.Modal)
                }, 400)
            })
        },
        render: function(i) {
            var j = this;
            p3.fT(j.template, function(p) {
                var n = j.options.practiceItem,
                    l, m, k, o;
                if (j.options.practiceId > 0) {
                    if (b.Data.editPracticeNotif && b.Data.editPracticeNotif.pk == j.options.sectionId) {
                        l = b.Data.editPracticeNotif.enabled;
                        m = b.Data.editPracticeNotif.tooltip
                    } else {
                        k = new f.Cs.NotificationActive({}, {
                            actionId: 48,
                            pk: j.options.sectionId
                        });
                        b.Data.editPracticeNotif = k;
                        k.fetch({
                            async: false,
                            success: function() {
                                k.setNotificationProperties();
                                l = b.Data.editPracticeNotif.enabled;
                                m = b.Data.editPracticeNotif.tooltip
                            },
                            error: function() {
                                p3.displayError("Error loading notification settings")
                            }
                        })
                    }
                } else {
                    if (b.Data.addPracticeNotif && b.Data.addPracticeNotif.pk == j.options.sectionId) {
                        l = b.Data.addPracticeNotif.enabled;
                        m = b.Data.addPracticeNotif.tooltip
                    }
                }
                o = [];
                if (j.options.showTeamPicker) {
                    o = b.Data.EditableTeams.toJSON()
                }
                j.$el.html(p({
                    venues: b.Data.venues.toJSON(),
                    locations: b.Data.locations.toJSON(),
                    transportation: b.Data.transportation.toJSON(),
                    practice: n.toJSON(),
                    notifEnabled: l,
                    notifTooltip: m,
                    practiceId: j.options.practiceId,
                    showTeamPicker: j.options.showTeamPicker,
                    teams: o,
                    athleticPrivileges: j.athleticPrivileges
                }));
                $(i).html(j.el)
            })
        },
        teamChanged: function() {
            $("#teamGroup").removeClass("error");
            var l = $("#teamDropdown").val(),
                j = false,
                k = "",
                i;
            if (l > 0) {
                if (b.Data.addPracticeNotif && b.Data.addPracticeNotif.pk == l) {
                    j = b.Data.addPracticeNotif.enabled;
                    k = b.Data.addPracticeNotif.tooltip
                } else {
                    i = new f.Cs.NotificationActive({}, {
                        actionId: 47,
                        pk: l
                    });
                    b.Data.addPracticeNotif = i;
                    i.fetch({
                        async: false,
                        success: function() {
                            i.setNotificationProperties();
                            j = b.Data.addPracticeNotif.enabled;
                            k = b.Data.addPracticeNotif.tooltip
                        },
                        error: function() {
                            p3.displayError("Error loading notification settings")
                        }
                    })
                }
            }
            $("#send_notif_label").attr("data-original-title", k);
            if (!j) {
                $("#send_notif_check").addClass("disabled");
                $("#send_notif_check").removeClass("btn-approve")
            } else {
                $("#send_notif_check").removeClass("disabled");
                $("#send_notif_check").addClass("btn-approve")
            }
            if (j) {
                $("#send_notif_check").addClass("active")
            } else {
                $("#send_notif_check").removeClass("active")
            }
        },
        removeDateValidation: function(i) {
            $("#practiceDateGroup").removeClass("error")
        },
        removeTimeValidation: function(i) {
            $("#timeGroup").removeClass("error")
        },
        savePractice: function(i) {
            var s = this,
                r = true,
                m = s.options.sectionId,
                k, j, n, l, o, q, p;
            $("#btnSave").button("loading");
            if ($("#practiceDate").val().length == 0) {
                r = false;
                $("#practiceDateGroup").addClass("error")
            }
            if (!$("#startTime").getTime() || $("#startTime").getTime().length == 0 || !$("#endTime").getTime() || $("#endTime").getTime().length == 0) {
                r = false;
                $("#timeGroup").addClass("error")
            }
            if (s.options.showTeamPicker) {
                if ($("#teamDropdown").val() == 0) {
                    r = false;
                    $("#teamGroup").addClass("error")
                } else {
                    m = $("#teamDropdown").val()
                }
            }
            if (r) {
                k = [];
                j = 0;
                if ($("#locationDropdown").val() != "0") {
                    if ($("#locationDropdown :selected").parent().attr("label") == "Locations") {
                        j = 1
                    }
                }
                k.push({
                    StartDate: $("#practiceDate").val() + " " + $("#startTime").getTime(),
                    EndDate: $("#practiceDate").val() + " " + $("#endTime").getTime(),
                    TransportationId: $("#transportDropdown").val(),
                    LocationId: $("#locationDropdown").val(),
                    LocationInd: j,
                    CancelledInd: $("#chkCancel").is(":checked"),
                    RowNumber: 0,
                    PracticeNote: $("#txtNotes").val()
                });
                n = $("#send_notif_check").hasClass("active");
                l = new b.Ms.PracticeItem({
                    PracticeId: s.options.practiceId,
                    TeamId: m,
                    SkipValidation: $("#chkCancel").is(":checked"),
                    PracticeList: k,
                    SendNotification: n
                });
                o = c.getDateString(c.localDateTime());
                q = $("#dismissalTime").val().trim();
                p = q ? c.isMidnight(q) : false;
                if (q && !p) {
                    q = c.displayTime(c.getTimeString(c.getDate((o + " " + q))), true, "timeSpan");
                    l.set("DismissalTime", q)
                }
                q = $("#departureTime").val().trim();
                p = q ? c.isMidnight(q) : false;
                if (q && !p) {
                    q = c.displayTime(c.getTimeString(c.getDate((o + " " + q))), true, "timeSpan");
                    l.set("DepartureTime", q)
                }
                q = $("#pickupTime").val().trim();
                p = q ? c.isMidnight(q) : false;
                if (q && !p) {
                    q = c.displayTime(c.getTimeString(c.getDate((o + " " + q))), true, "timeSpan");
                    l.set("PickupTime", q)
                }
                l.save({}, {
                    error: function() {
                        p3.showModal(p3.Layout.Containers.Modal, "hide");
                        p3.displayError("Error saving Practice")
                    },
                    success: function(u, v) {
                        var t = u.get("Conflicts"),
                            w = (!t || t.length == 0);
                        if (!w) {
                            b.Us.openScheduleConfirmDialog(l, false, s.options.practiceId > 0, b.Us.getConflictText(t), s.options.calendarView, false, false, null, s.options.sectionId, s.options.dashboardView, false, s);
                            $("#btnSave").button("reset")
                        }
                        if (w) {
                            s.trigger("dataModified");
                            p3.showModal(p3.Layout.Containers.Modal, "hide");
                            if (s.options.dashboardView) {
                                s.options.dashboardView.refreshDashboard()
                            } else {
                                if (s.options.calendarView) {
                                    b.Us.updateCalendar(s.sectionId)
                                } else {
                                    b.Us.updateSchedule()
                                }
                            }
                        }
                    }
                })
            }
            $("#btnSave").button("reset");
            return false
        },
        deletePractice: function(j) {
            var k = this,
                i = new b.Ms.PracticeDelete({
                    PracticeId: k.options.practiceId,
                    TeamId: k.sectionId
                });
            b.Us.showDeleteConfirm(i, k.sectionId, k.options.calendarView, k)
        },
        switchAddMode: function(i) {
            var k = this,
                j;
            p3.showModal(p3.Layout.Containers.Modal, "hide");
            j = new b.Ms.ScheduleItem({
                ScheduleType: 0,
                HomeAwayType: 0,
                LocationId: -1,
                LeagueInd: 1
            });
            if (k.options.calendarView) {
                j.set("Gamedate", k.options.practiceItem.get("Gamedate"))
            }
            b.Us.openGameScheduleDialog(0, j, k.sectionId, k.options.calendarView, null, k.options.showTeamPicker, false, k.athleticPrivileges);
            return false
        }
    });
    b.Vs.ConfirmView = Bb.View.extend({
        template: "athleticschedule/athleticschedule.confirm.template.html",
        events: {
            "click #btnSave": "saveSchedule"
        },
        initialize: function() {
            var i = this;
            i.saveModel = i.options.saveModel;
            i.isGame = i.options.isGame || false;
            i.isEdit = i.options.isEdit || false;
            i.isDragAndDrop = i.options.isDragAndDrop || false;
            i.potentialConflicts = i.options.potentialConflicts;
            i.calendarView = i.options.calendarView || false;
            i.modalView = i.options.modalView;
            i.addAnother = i.options.addAnother || false;
            i.revertFunc = i.options.revertFunc;
            i.sectionId = i.options.sectionId || 0;
            i.showTeamPicker = i.options.showTeamPicker;
            i.showNotification = false;
            if (i.isDragAndDrop) {
                if (i.isGame) {
                    i.showNotification = b.Data.editGameNotif.enabled;
                    i.notifEnabled = b.Data.editGameNotif.enabled;
                    i.notifTooltip = b.Data.editGameNotif.tooltip
                } else {
                    i.showNotification = b.Data.editPracticeNotif.enabled;
                    i.notifEnabled = b.Data.editPracticeNotif.enabled;
                    i.notifTooltip = b.Data.editPracticeNotif.tooltip
                }
            }
            $("#validate-modal").on("shown", function() {
                window.setTimeout(function() {
                    $("#send_notif_label").tooltip();
                    p3.setModalHeight("#validate-modal")
                }, 400)
            });
            $("#validate-modal").on("hide", function() {
                if (i.isDragAndDrop && i.revertFunc) {
                    i.revertFunc()
                }
            })
        },
        render: function(i) {
            var j = this;
            p3.fT(j.template, function(k) {
                j.$el.html(k({
                    potentialConflicts: j.potentialConflicts,
                    showNotification: j.showNotification,
                    showReschedule: j.isGame && j.isDragAndDrop,
                    notifEnabled: j.notifEnabled,
                    notifTooltip: j.notifTooltip
                }));
                $(i).html(j.el)
            })
        },
        saveSchedule: function(i) {
            var l = this,
                k = false,
                j = false;
            $("#btnSave").button("loading");
            l.saveModel.set("SkipValidation", true);
            if (l.isDragAndDrop) {
                if (l.showNotification && $("#send_notif_check").hasClass("active")) {
                    k = true
                }
                if (l.isGame && $("#send_reminder").is(":checked")) {
                    j = true
                }
                l.saveModel.set("sendNotification", k);
                l.saveModel.set("reschedule", j)
            }
            l.saveModel.save({}, {
                error: function() {
                    $("#validate-modal").modal("hide");
                    $("#validate-modal").remove();
                    p3.showModal(p3.Layout.Containers.Modal, "hide");
                    if (l.isGame) {
                        p3.displayError("Error saving Game")
                    } else {
                        p3.displayError("Error saving Practice")
                    }
                },
                success: function(m, n) {
                    l.revertFunc = null;
                    $("#validate-modal").modal("hide");
                    $("#validate-modal").remove();
                    if (!l.isDragAndDrop) {
                        if (l.modalView) {
                            l.modalView.trigger("dataModified")
                        }
                        p3.showModal(p3.Layout.Containers.Modal, "hide")
                    }
                    if (l.options.dashboardView) {
                        l.options.dashboardView.refreshDashboard()
                    } else {
                        if (l.options.calendarView) {
                            b.Us.updateCalendar(l.sectionId)
                        } else {
                            b.Us.updateSchedule()
                        }
                    }
                    if (l.addAnother) {
                        var o = new b.Ms.ScheduleItem({
                            GameType: 0,
                            HomeAway: 0,
                            LocationId: -1,
                            LeagueInd: 1
                        });
                        p3.rV(new b.Vs.EditGameScheduleView({
                            scheduleId: 0,
                            scheduleItem: o,
                            sectionId: l.saveModel.get("SectionId"),
                            calendarView: l.calendarView,
                            showTeamPicker: l.showTeamPicker
                        }), p3.Layout.Containers.Modal, true);
                        p3.showModal(p3.Layout.Containers.Modal)
                    }
                }
            })
        }
    });
    b.Vs.PublishSettings = Bb.View.extend({
        template: "athleticschedule/publish.settings.template.html",
        events: {
            "click .practice-setting-button": "practiceSettingToggle",
            "click .game-setting-button": "gameSettingToggle",
            "click #save-settings-button": "doSave"
        },
        initialize: function(i) {
            var j = this;
            j.sectionId = i.sectionId || 0;
            j.settings = new b.Ms.PublishOptionsGet({
                teamId: j.sectionId
            });
            j.settings.fetch({
                async: false,
                success: function(k, l) {
                    if (k.get("publish_schedule") === true) {
                        j.setGamePublish = true
                    }
                    if (k.get("publish_practice_schedule") === true) {
                        j.setPracticePublish = true
                    }
                }
            })
        },
        render: function(i) {
            var j = this;
            p3.fT(j.template, function(k) {
                j.$el.html(k({
                    gamePublish: j.setGamePublish,
                    practicePublish: j.setPracticePublish,
                    isLite: j.options.isLite || false
                }));
                $(i).html(j.el)
            })
        },
        doSave: function(j) {
            j.preventDefault();
            var p = this,
                l = false,
                k = false,
                n = false,
                m = false,
                i = $("#settings-error-message-container"),
                o;
            if (i.html() !== "") {
                i.html("");
                i.removeClass("alert alert-error")
            }
            if ($("#gamesPublishSchedule").find(".active").hasClass("btn-approve")) {
                l = true
            }
            if ($("#gamesSendNotification").find(".active").hasClass("btn-approve")) {
                k = true
            }
            if ($("#practicesPublishSchedule").find(".active").hasClass("btn-approve")) {
                n = true
            }
            if ($("#practicesSendNotification").find(".active").hasClass("btn-approve")) {
                m = true
            }
            o = new b.Ms.PublishOptionsSave({
                teamId: p.sectionId,
                publishGameSchedule: l,
                sendGameNotif: k,
                publishPracticeSchedule: n,
                sendPracticeNotif: m
            });
            o.save({}, {
                success: function() {
                    $(p3.Layout.Containers.Modal).modal("hide")
                },
                error: function() {
                    i.addClass("alert alert-error");
                    i.html("<strong>Error:</strong> Settings were unable to be saved please try again.")
                }
            })
        },
        gameSettingToggle: function(l) {
            var k = $(l.currentTarget).parent(),
                m = k.data("type"),
                i, j;
            $(l.currentTarget).removeClass("active");
            if (m === 0) {
                i = $(l.currentTarget);
                j = $("#gamesSendNotification").find(".active");
                if (i.hasClass("btn-denied")) {
                    _.each(j.parent().children(), function(n) {
                        $(n).attr("disabled", true)
                    })
                } else {
                    _.each(j.parent().children(), function(n) {
                        $(n).removeAttr("disabled")
                    })
                }
            } else {
                i = $("#gamesPublishSchedule").find(".active");
                j = $(l.currentTarget)
            }
            if (i.hasClass("btn-approve") && j.hasClass("btn-approve")) {
                $("#gameMessages").addClass("alert alert-info").html('<p>Upon saving, all users that have subscribed to receive the "Game Schedule Published" Notification will receive an e-mail and/or text alert.</p><p>This is a one time alert, and users will not receive any further notice if you choose to unpublish this schedule in the future.</p>')
            } else {
                if (i.hasClass("btn-denied") && j.hasClass("btn-approve")) {
                    $("#gameMessages").addClass("alert alert-info").html('<p>This schedule was previously published and "Game Schedule Published" Notifications were sent out to subscribed users.</p><p>This was a one time alert, and users will not receive any further notice if you choose to unpublish this schedule</p>');
                    if (j.hasClass("active")) {
                        j.removeClass("active").parent().find(".btn-denied").addClass("active")
                    } else {
                        l.preventDefault()
                    }
                } else {
                    $("#gameMessages").removeClass("alert alert-info").html("")
                }
            }
        },
        practiceSettingToggle: function(l) {
            var k = $(l.currentTarget).parent(),
                m = k.data("type"),
                i, j;
            if (m === 0) {
                i = $(l.currentTarget);
                j = $("#practicesSendNotification").find(".active")
            } else {
                i = $("#practicesPublishSchedule").find(".active");
                j = $(l.currentTarget)
            }
            if (i.hasClass("btn-approve") && j.hasClass("btn-approve")) {
                $("#practiceMessages").addClass("alert alert-info").html('<p>Upon saving, all users that have subscribed to receive the "Practice Schedule Published" Notification will receive an e-mail and/or text alert.</p><p>This is a one time alert, and users will not receive any further notice if you choose to unpublish this schedule in the future.</p>')
            } else {
                if (i.hasClass("btn-denied") && j.hasClass("btn-approve")) {
                    $("#practiceMessages").addClass("alert alert-info").html('<p>This schedule was previously published and "Practice Schedule Published" Notifications were sent out to subscribed users.</p><p>This was a one time alert, and users will not receive any further notice if you choose to unpublish this schedule</p>')
                } else {
                    $("#practiceMessages").removeClass("alert alert-info").html("")
                }
            }
        }
    });
    b.Vs.TeamPicker = Bb.View.extend({
        template: "athleticschedule/team.picker.template.html",
        events: {
            "click #btnApply": "applyTeams",
            "click .season-toggle": "toggleSeason",
            "click .sport-toggle": "toggleSport",
            "click .select-all-season": "selectAllSeason",
            "click .select-all-sport": "selectAllSport",
            "click .btn-select-team": "selectTeam"
        },
        initialize: function() {
            p3.Layout.Containers.Modal.on("shown", function() {
                window.setTimeout(function() {
                    p3.setModalHeight(p3.Layout.Containers.Modal)
                }, 300)
            })
        },
        render: function(i) {
            var j = this;
            p3.fT(j.template, function(r) {
                var o = [],
                    p = [],
                    q = [],
                    m = "",
                    n = "",
                    k, l;
                b.Data.SportLevels.each(function(s) {
                    if (s.get("season_id") != m) {
                        m = s.get("season_id");
                        p = [];
                        o.push({
                            seasonId: m,
                            season: s.get("season"),
                            sports: p,
                            selectAll: true
                        });
                        n = s.get("department_id");
                        q = [];
                        p.push({
                            sportId: n,
                            sport: s.get("department"),
                            seasonId: m,
                            teams: q,
                            isExpanded: false,
                            selectAll: true
                        })
                    } else {
                        if (s.get("department_id") != n) {
                            n = s.get("department_id");
                            q = [];
                            p.push({
                                sportId: n,
                                sport: s.get("department"),
                                seasonId: m,
                                teams: q,
                                selectAll: true
                            })
                        }
                    }
                    if (b.Data.SelectedSportLevels.indexOf(s.get("offering_id")) > -1) {
                        s.set("isSelected", true);
                        p[p.length - 1].isExpanded = true
                    } else {
                        s.set("isSelected", false);
                        p[p.length - 1].selectAll = false;
                        o[o.length - 1].selectAll = false
                    }
                    q.push(s.toJSON())
                });
                for (k = 0; k < o.length; k++) {
                    for (l = 0; l < o[k].sports.length; l++) {
                        o[k].sports[l].teamCount = o[k].sports[l].teams.length
                    }
                }
                j.$el.html(r({
                    seasons: o
                }));
                $(i).html(j.el)
            })
        },
        toggleSeason: function(j) {
            var i = $(j.currentTarget),
                k = i.data("season");
            if ($("#season" + k).is(":visible")) {
                $("#season" + k).hide(200)
            } else {
                $("#season" + k).show(200)
            }
        },
        toggleSport: function(j) {
            var i = $(j.currentTarget),
                k = i.data("sport");
            if ($("#sport" + k).is(":visible")) {
                $("#sport" + k).hide(200);
                i.find(".swaparrow").removeClass("arrow-s").addClass("arrow-e")
            } else {
                $("#sport" + k).show(200);
                i.find(".swaparrow").removeClass("arrow-e").addClass("arrow-s")
            }
        },
        selectAllSeason: function(j) {
            var i = $(j.currentTarget),
                k = i.data("season");
            if (i.hasClass("active")) {
                $(".btn-select-team[data-season='" + k + "']").removeClass("active");
                $(".select-all-sport[data-season='" + k + "']").removeClass("active")
            } else {
                $(".btn-select-team[data-season='" + k + "']").addClass("active");
                $(".select-all-sport[data-season='" + k + "']").addClass("active");
                if (!$("#season" + k).is(":visible")) {
                    $("#season" + k).show(200)
                }
                $(".sport-body[data-season='" + k + "']:hidden").show(200);
                $(".sport-toggle[data-season='" + k + "']").find(".arrow-e").removeClass("arrow-e").addClass("arrow-s")
            }
        },
        selectAllSport: function(k) {
            var i = $(k.currentTarget),
                l = i.data("season"),
                m = i.data("sport"),
                j;
            if (i.hasClass("active")) {
                i.removeClass("active");
                $(".btn-select-team[data-season='" + l + "'][data-sport='" + m + "']").removeClass("active")
            } else {
                i.addClass("active");
                $(".btn-select-team[data-season='" + l + "'][data-sport='" + m + "']").addClass("active");
                $("#sport" + l + "_" + m).show(200);
                $(".sport-toggle[data-sport='" + l + "_" + m + "']").find(".arrow-e").removeClass("arrow-e").addClass("arrow-s")
            }
            j = ($(".btn-select-team.active[data-season='" + l + "']").length == $(".btn-select-team[data-season='" + l + "']").length);
            if (j) {
                $(".select-all-season[data-season='" + l + "']").addClass("active")
            } else {
                $(".select-all-season[data-season='" + l + "']").removeClass("active")
            }
        },
        selectTeam: function(j) {
            var i = $(j.currentTarget),
                k = i.data("season"),
                l = i.data("sport");
            if (i.hasClass("active")) {
                $(".select-all-sport[data-season='" + k + "'][data-sport='" + l + "']").removeClass("active");
                $(".select-all-season[data-season='" + k + "']").removeClass("active")
            } else {
                if ($(".btn-select-team.active[data-season='" + k + "'][data-sport='" + l + "']").length + 1 == $(".btn-select-team[data-season='" + k + "'][data-sport='" + l + "']").length) {
                    $(".select-all-sport[data-season='" + k + "'][data-sport='" + l + "']").addClass("active")
                }
                if ($(".btn-select-team.active[data-season='" + k + "']").length + 1 == $(".btn-select-team[data-season='" + k + "']").length) {
                    $(".select-all-season[data-season='" + k + "']").addClass("active")
                }
            }
        },
        applyTeams: function(j) {
            var l = [],
                i, m, k;
            $(".btn-select-team.active").each(function() {
                l.push($(this).data("team"))
            });
            b.Data.SelectedSportLevels = l;
            i = $("#col-main").fullCalendar("getView");
            b.Data.scheduleItems.scheduleDuration = 0;
            b.Data.scheduleItems.startDate = c.getDateString(i.visEnd);
            m = new Date(i.visEnd);
            m.setMonth(m.getMonth() - 3);
            k = new Date(i.visEnd);
            k.setMonth(k.getMonth() + 3);
            b.Data.startDate = m;
            b.Data.endDate = k;
            b.Data.scheduleItems.reset({});
            b.Data.scheduleItems.fetch({
                error: function(n, o) {
                    p3.displayError("Error loading schedule")
                },
                success: function() {
                    $("#col-main").fullCalendar("removeEvents");
                    b.Us.BuildCalendarEventArray(0, true);
                    $("#col-main").fullCalendar("addEventSource", b.Data.CalendarEvents)
                }
            });
            p3.showModal(p3.Layout.Containers.Modal, "hide")
        }
    });
    b.Us.BuildCalendarEventArray = function(s, C) {
        var o = [],
            A = "",
            j = "",
            z = "",
            n = "",
            i = false,
            m = false,
            r = false,
            l = false,
            k, u = false,
            t = false,
            v = false,
            B = b.Data.scheduleItems.scheduleType,
            x, y, w, p, q;
        u = (B == 0) || (B == 1) || (B == 3) || (B == 5);
        t = (B == 0) || (B == 2) || (B == 3) || (B == 6);
        v = (B == 0) || (B == 4) || (B == 5) || (B == 6);
        p = b.Us.hasEditGameTask();
        q = b.Us.hasEditPracticeTask();
        b.Data.scheduleItems.each(function(D) {
            if (D.get("ScheduleTypeText") == "Game") {
                r = true
            } else {
                r = false
            }
            if (s > 0 || B == 0 || (u && r && D.get("HomeAway") == "Home") || (t && r && D.get("HomeAway") == "Away") || (v && !r)) {
                A = "<span style='font-size:12px;'>";
                k = "<br/><span style='color:#595858;'>";
                n = "";
                x = c.getDateString(c.getDate(D.get("Gamedate")));
                y = c.getTimeString(c.getDate(x + " " + D.get("StartTime")));
                w = c.getTimeString(c.getDate(x + " " + D.get("EndTimeSpan")));
                z = c.getDate(x + " " + y);
                if (!c.isMidnight(w)) {
                    n = c.getDate(x + " " + w)
                }
                if (c.isMidnight(y)) {
                    i = true
                } else {
                    i = false
                }
                if (b.Data.fullView) {
                    A += D.get("TeamName") + "<br />";
                    m = D.get("CanEdit")
                } else {
                    m = C
                }
                if (r) {
                    m = m && p
                } else {
                    m = m && q
                }
                if (D.get("CancelledInd") || D.get("RescheduledInd")) {
                    l = false
                } else {
                    l = m
                }
                if (D.get("CancelledInd")) {
                    A += '<span style="color:#e31d1d"><b>Canceled</b></span>';
                    if (r) {
                        if (D.get("OpponentNames")) {
                            k += "<b>VS</b> " + D.get("OpponentNames")
                        } else {
                            k += "Game"
                        }
                        j = "#F3F3F3"
                    } else {
                        k += "Practice";
                        j = "#d6d6d6"
                    }
                } else {
                    if (D.get("RescheduledInd")) {
                        m = false;
                        A += '<span style="color:#e31d1d"><b>Rescheduled</b></span>';
                        if (D.get("OpponentNames")) {
                            k += " <b>VS</b> " + D.get("OpponentNames")
                        }
                        if (D.get("RescheduledDate")) {
                            k += '<br><i style="font-size:11px">Resched Date: ' + c.displayDate(D.get("RescheduledDate"), "shortDayMonthDate") + "</i>"
                        }
                        j = "#F3F3F3"
                    } else {
                        if (D.get("Title")) {
                            A += D.get("Title") + "<br />"
                        }
                        if (D.get("InvitationalInd")) {
                            A += "Invitational<br />"
                        }
                        if (r && !D.get("LeagueInd")) {
                            A += "Non-League Game<br />"
                        }
                        if (D.get("PlayoffInd")) {
                            A += "Playoff Game<br />"
                        }
                        if (D.get("ScrimmageInd")) {
                            A += "Scrimmage<br />"
                        }
                        if (D.get("TournamentInd")) {
                            A += "Tournament<br />"
                        }
                        if (r) {
                            A += D.get("HomeAway");
                            j = "#F3F3F3"
                        } else {
                            A += "Practice";
                            j = "#d6d6d6"
                        }
                        A += "</span>";
                        if (D.get("BuildingName")) {
                            k += "Location: " + D.get("BuildingName") + " " + D.get("RoomName") + "<br />"
                        }
                        if (D.get("location")) {
                            k += "Location: " + D.get("location") + "<br />"
                        }
                        if (D.get("OpponentNames")) {
                            k += "<b>VS</b> " + D.get("OpponentNames") + "<br />"
                        }
                        if (D.get("RescheduledDate")) {
                            k += '<i style="font-size:11px">Resched from ' + c.displayDate(D.get("RescheduledDate"), "shortDayMonthDate") + "</i><br />"
                        }
                        if (D.get("ShowDetails")) {
                            k += '<a data-id="2" class="viewdetail" href>Directions & Details</a>'
                        }
                    }
                }
                k += "</span>";
                o.push({
                    title: A + k,
                    start: z,
                    end: n,
                    backgroundColor: j,
                    borderColor: "#c6c4c4",
                    allDay: i,
                    canEdit: m,
                    id: D.get("ScheduleId"),
                    isGame: r,
                    sectionId: s || D.get("SectionId"),
                    canDrag: l
                })
            }
        });
        b.Data.CalendarEvents = o
    };
    b.Us.getGameDetails = function(j) {
        var i = new b.Ms.GameGet({
            ScheduleId: j
        });
        i.fetch({
            async: false,
            error: function(k, l) {
                p3.displayError("Error loading game")
            },
            success: function() {
                var l = c.getDate(i.get("Gamedate")),
                    k = c.getDateString(l),
                    p = c.getTimeString(l),
                    m, n, o, q;
                if (c.isMidnight(p)) {
                    p = "TBA"
                }
                i.set("StartTime", p);
                i.set("StartDisplay", p);
                i.set("Gamedate", k);
                i.set("OpponentId", 0);
                if (i.get("ScheduleType") == 0 && i.get("Opponents").length == 1) {
                    i.set("OpponentId", i.get("Opponents")[0].Id)
                }
                if (i.get("Vehicles").length > 0) {
                    q = i.get("Vehicles");
                    for (m = 0; m < q.length; m++) {
                        n = c.getDate(q[m].BeginDate);
                        o = c.getDate(q[m].EndDate);
                        q[m].BeginTime = c.getTimeString(n);
                        q[m].BeginDate = c.getDateString(n);
                        q[m].EndTime = c.getTimeString(o);
                        q[m].EndDate = c.getDateString(o)
                    }
                }
                if (c.isMidnight(i.get("DismissalTime"))) {
                    i.set("DismissalTime", "")
                } else {
                    i.set("DismissalTime", c.getTimeString(c.getDate(k + " " + i.get("DismissalTime"))))
                }
                if (c.isMidnight(i.get("DepartureTime"))) {
                    i.set("DepartureTime", "")
                } else {
                    i.set("DepartureTime", c.getTimeString(c.getDate(k + " " + i.get("DepartureTime"))))
                }
                if (c.isMidnight(i.get("PickupTime"))) {
                    i.set("PickupTime", "")
                } else {
                    i.set("PickupTime", c.getTimeString(c.getDate(k + " " + i.get("PickupTime"))))
                }
            }
        });
        return i
    };
    b.Us.getPracticeItem = function(j, k) {
        var i = new b.Ms.PracticeGet({
            PracticeId: j,
            TeamId: k
        });
        i.fetch({
            async: false,
            error: function(l, m) {
                p3.displayError("Error loading practice")
            },
            success: function() {
                var q = c.getDate(i.get("StartDate")),
                    l = c.getDateString(q),
                    r = c.getTimeString(q),
                    o, n, m, p;
                i.set("StartTime", r);
                i.set("PracticeDate", l);
                if (i.get("EndDate")) {
                    o = c.getDate(i.get("EndDate"));
                    i.set("EndTime", c.getTimeString(o))
                }
                if (i.get("DismissalTime")) {
                    n = c.getDate(i.get("DismissalTime"));
                    i.set("DismissalTime", c.getTimeString(n))
                }
                if (i.get("DepartureTime")) {
                    m = c.getDate(i.get("DepartureTime"));
                    i.set("DepartureTime", c.getTimeString(m))
                }
                if (i.get("PickupTime")) {
                    p = c.getDate(i.get("PickupTime"));
                    i.set("PickupTime", c.getTimeString(p))
                }
            }
        });
        return i
    };
    b.Us.getPracticeDetails = function(j) {
        var i = new b.Ms.PracticeDetailsGet({
            ScheduleId: j
        });
        i.fetch({
            async: false,
            error: function(k, l) {
                p3.displayError("Error loading practice")
            },
            success: function() {
                var k = c.getDateString(c.localDateTime()),
                    l;
                i.set("PracticeDate", c.getDateString(c.getDate(i.get("event_date_start"))));
                l = c.getDate(k + " " + i.get("start_time"));
                i.set("StartTime", c.getTimeString(l));
                l = c.getDate(k + " " + i.get("end_time"));
                i.set("EndTime", c.getTimeString(l));
                if (i.get("student_dismissal_time")) {
                    l = c.getDate(i.get("student_dismissal_time"));
                    i.set("DismissalTime", c.getTimeString(l))
                }
                if (i.get("departure_time")) {
                    l = c.getDate(i.get("departure_time"));
                    i.set("DepartureTime", c.getTimeString(l))
                }
                if (i.get("pickuptime")) {
                    l = c.getDate(i.get("pickuptime"));
                    i.set("PickupTime", c.getTimeString(l))
                }
            }
        });
        return i
    };
    b.Us.updateSchedule = function() {
        if (b.Data.scheduleItems) {
            b.Data.scheduleItems.reset({});
            if (b.Data.scheduleItems.dateSort != null || (b.Data.scheduleItems != null && b.Data.scheduleItems.endDate != null)) {
                b.Data.scheduleItems.fetch({
                    error: function(i, j) {
                        p3.displayError("Error loading schedule")
                    },
                    success: function() {
                        $(".schedule-table-button").click(function() {
                            var m = $($(this).prev("table")[0]),
                                j = m.children("tbody").children("tr:hidden"),
                                k, l;
                            if (j.length < 11) {
                                $(this).hide()
                            }
                            for (k = 0, l = j.length; k < l && k < 10; k++) {
                                $(j[k]).show()
                            }
                            return false
                        })
                    }
                })
            }
        }
    };
    b.Us.updateCalendar = function(l) {
        if (b.Data.scheduleItems) {
            var j = $("#col-main").fullCalendar("getView"),
                m = new Date(j.visStart),
                k = new Date(j.visStart),
                i = new Date(m);
            m.setMonth(i.getMonth() - 3);
            k.setMonth(i.getMonth() + 3);
            b.Data.startDate = m;
            b.Data.endDate = k;
            b.Data.scheduleItems.startDate = c.getDateString(i).ApiFormat();
            b.Data.scheduleItems.reset({});
            b.Data.scheduleItems.fetch({
                error: function(n, o) {
                    p3.displayError("Error loading schedule")
                },
                success: function(n, o) {
                    var p = 0;
                    if (!b.Data.fullView) {
                        p = l
                    }
                    $("#col-main").fullCalendar("removeEvents");
                    b.Us.BuildCalendarEventArray(p, true);
                    $("#col-main").fullCalendar("addEventSource", b.Data.CalendarEvents)
                }
            })
        }
    };
    b.Us.openGameScheduleDialog = function(o, p, q, j, k, r, m, i, l) {
        m = m || false;
        var n = new b.Vs.EditGameScheduleView({
            scheduleId: o,
            scheduleItem: p,
            sectionId: q,
            calendarView: j,
            dashboardView: k,
            showTeamPicker: r,
            isLite: m,
            dataModifiedCallback: l,
            athleticPrivileges: i
        });
        if (l) {
            n.on("dataModified", function() {
                l()
            })
        }
        p3.rV(n, p3.Layout.Containers.Modal, true);
        p3.showModal(p3.Layout.Containers.Modal)
    };
    b.Us.openEditPracticeDialog = function(n, o, p, j, k, q, i, l) {
        var m = new b.Vs.EditPracticeView({
            practiceId: n,
            practiceItem: o,
            sectionId: p,
            calendarView: j,
            dashboardView: k,
            showTeamPicker: q,
            dataModifiedCallback: l,
            athleticPrivileges: i
        });
        if (l) {
            m.on("dataModified", function() {
                l()
            })
        }
        p3.rV(m, p3.Layout.Containers.Modal, true);
        p3.showModal(p3.Layout.Containers.Modal)
    };
    b.Us.openScheduleConfirmDialog = function(r, n, m, p, j, l, i, q, s, k, t, o) {
        var u = '<div class="modal hide " tabindex="-1" id="validate-modal"></div>';
        $(u).modal();
        p3.rV(new b.Vs.ConfirmView({
            saveModel: r,
            isGame: n,
            isEdit: m,
            potentialConflicts: p,
            calendarView: j,
            modalView: o,
            isDragAndDrop: l,
            addAnother: i,
            revertFunc: q,
            sectionId: s,
            dashboardView: k,
            showTeamPicker: t
        }), "#validate-modal", true);
        p3.setModalHeight($("#validate-modal"))
    };
    b.Us.getConflictText = function(j) {
        var l = '<table style="margin-top:10px;" class="table table-striped"><tr><th>Type</th><th>Details</th></tr>',
            k, n, m;
        for (k = 0; k < j.length; k++) {
            n = c.getTimeString(c.getDate(c.getDateString(c.localDateTime()) + " " + j[k].ConflictTime));
            m = c.isMidnight(n);
            l += "<tr><td>";
            switch (j[k].ConflictType) {
                case 0:
                    l += "Game</td><td>Start Time: ";
                    l += n;
                    break;
                case 1:
                    l += "Practice</td><td>Start Time: ";
                    l += n;
                    break;
                case 2:
                    l += "Location</td><td>";
                    l += j[k].ConflictDescription;
                    l += " in use by ";
                    l += j[k].ConflictTeam;
                    l += " at ";
                    l += n;
                    break;
                case 3:
                    l += "Vehicle</td><td>";
                    l += j[k].ConflictDescription;
                    l += " in use by ";
                    l += j[k].ConflictTeam;
                    if (m) {
                        l += " all day"
                    } else {
                        l += " at ";
                        l += n
                    }
                    break
            }
            l += "</td></tr>"
        }
        l += "</table>";
        return l
    };
    b.Us.showDeleteConfirm = function(l, n, i, m) {
        var o = '<div class="modal hide " tabindex="-1" id="confirm-modal"></div>',
            k, j;
        $(o).modal();
        k = function() {
            $("#confirm-modal").modal("hide");
            $("#confirm-modal").remove();
            l.destroy({
                error: function() {
                    p3.showModal(p3.Layout.Containers.Modal, "hide");
                    p3.displayError("Error deleting schedule item")
                },
                success: function() {
                    if (m) {
                        m.trigger("dataModified")
                    }
                    p3.showModal(p3.Layout.Containers.Modal, "hide");
                    if (i) {
                        b.Us.updateCalendar(n)
                    } else {
                        b.Us.updateSchedule()
                    }
                }
            })
        };
        j = function() {
            $("#confirm-modal").modal("hide");
            $("#confirm-modal").remove()
        };
        p3.rV(new a.Vs.Confirm({
            ConfirmationTitle: "Confirm",
            ConfirmationText: "Warning: Once you hit confirm there is no undo button. Are you really sure you want to delete this forever?",
            ConfirmCallback: k,
            CancelCallback: j,
            KeepOpen: true
        }), "#confirm-modal", true)
    };
    b.Us.addMapScript = function(j, i) {
        var k;
        if (window.location.protocol == "https:") {
            k = "https://www.mapquestapi.com/sdk/js/v7.0.s/mqa.toolkit.js?key=Gmjtd%7Cluu22g0rn9%2Crx%3Do5-lz251"
        } else {
            k = "http://mapquestapi.com/sdk/js/v7.0.s/mqa.toolkit.js?key=Gmjtd%7Cluu22g0rn9%2Crx%3Do5-lz251"
        }
        head.js(k, function() {
            MQMap = new MQA.TileMap({
                elt: document.getElementById("map-container"),
                zoom: 12,
                latLng: {
                    lat: 0,
                    lng: 0
                },
                mtype: "map"
            });
            MQA.withModule("zoomcontrol3", function() {
                MQMap.addControl(new MQA.LargeZoomControl3(), new MQA.MapCornerPlacement(MQA.MapCorner.TOP_LEFT))
            });
            MQA.withModule("viewcontrol3", function() {
                MQMap.addControl(new MQA.ViewControl3(), new MQA.MapCornerPlacement(MQA.MapCorner.TOP_RIGHT))
            });
            $("#map-container").show();
            $("#map-link").show();
            $("#map-link").attr("href", "http://mapq.st/directions?daddr=" + j);
            var l = document.createElement("script");
            l.type = "text/javascript";
            l.src = document.location.protocol + "//www.mapquestapi.com/geocoding/v1/address?key=Gmjtd%7Cluu22g0rn9%2Crx%3Do5-lz251&callback=geocodeResponse&location=" + i;
            document.body.appendChild(l)
        })
    };
    b.Us.initializeNotifications = function(o, n) {
        var k = true,
            i, l, m, j;
        if (n) {
            k = false
        }
        i = new f.Cs.NotificationActive({}, {
            actionId: 42,
            pk: o
        });
        b.Data.addGameNotif = i;
        l = new f.Cs.NotificationActive({}, {
            actionId: 43,
            pk: o
        });
        b.Data.editGameNotif = l;
        m = new f.Cs.NotificationActive({}, {
            actionId: 48,
            pk: o
        });
        b.Data.editPracticeNotif = m;
        j = new f.Cs.NotificationActive({}, {
            actionId: 47,
            pk: o
        });
        b.Data.addPracticeNotif = j;
        i.fetch({
            async: k,
            success: function() {
                i.setNotificationProperties()
            },
            error: function() {
                p3.displayError("Error loading notification settings")
            }
        });
        l.fetch({
            async: k,
            success: function() {
                l.setNotificationProperties()
            },
            error: function() {
                p3.displayError("Error loading notification settings")
            }
        });
        m.fetch({
            async: k,
            success: function() {
                m.setNotificationProperties()
            },
            error: function() {
                p3.displayError("Error loading notification settings")
            }
        });
        j.fetch({
            async: k,
            success: function() {
                j.setNotificationProperties()
            },
            error: function() {
                p3.displayError("Error loading notification settings")
            }
        })
    };
    b.Us.initializeData = function(i) {
        var m = new b.Cs.Venue(),
            j, k, l;
        b.Data.venues = m;
        if (i) {
            m.fetch({
                async: false,
                error: function() {
                    p3.displayError("Error loading athletic venues")
                }
            })
        }
        j = new b.Cs.Location();
        b.Data.locations = j;
        if (i) {
            j.fetch({
                async: false,
                error: function() {
                    p3.displayError("Error loading athletic locations")
                }
            })
        }
        k = new b.Cs.Opponent();
        b.Data.opponents = k;
        if (i) {
            k.fetch({
                async: false,
                error: function() {
                    p3.displayError("Error loading athletic opponents")
                }
            })
        }
        l = new b.Cs.Transportation();
        b.Data.transportation = l;
        if (i) {
            l.fetch({
                async: false,
                error: function() {
                    p3.displayError("Error loading athletic transportation")
                }
            })
        }
    };
    b.Us.setScheduleType = function(j) {
        var i = $(j.currentTarget),
            k = 0;
        if (j.currentTarget.id != "scheduleFilterAll") {
            if (i.hasClass("active")) {
                i.removeClass("active cal-filter-on").addClass("cal-filter-off");
                i.find("i").removeClass("p3icon-ok").addClass("p3icon-check")
            } else {
                i.addClass("active cal-filter-on").removeClass("cal-filter-off");
                i.find("i").removeClass("p3icon-check").addClass("p3icon-ok")
            }
            $(".scheduleTypeFilter").each(function() {
                if ($(this).hasClass("active")) {
                    k += parseInt($(this).data("val"), 10)
                }
            });
            if (k == 7) {
                k = 0
            }
        }
        if (k == 0) {
            $(".scheduleTypeFilter").removeClass("active cal-filter-on").addClass("cal-filter-off");
            $("i.p3icon-ok").removeClass("p3icon-ok").addClass("p3icon-check");
            $("#scheduleFilterAll").addClass("active cal-filter-on").removeClass("cal-filter-off");
            $("#scheduleFilterAll").find("i").removeClass("p3icon-check").addClass("p3icon-ok")
        } else {
            $("#scheduleFilterAll").removeClass("active cal-filter-on").addClass("cal-filter-off");
            $("#scheduleFilterAll").find("i").removeClass("p3icon-ok").addClass("p3icon-check")
        }
        b.Data.scheduleItems.setScheduleTypeFilter(k)
    };
    b.Us.initializeCalendar = function(i) {
        var j;
        b.Data.Culture = p3.Data.SchoolContext.attributes.Culture;
        j = b.Data.Culture.App.ShortMonthDayYearPattern.split("Y").join("y").split("D").join("d");
        if (j.indexOf("d") < j.indexOf("M")) {
            j = j.split(" yyyy").join(" [yyyy]").split(" MMM").join(" [MMM]") + "{ '-' " + j + "}"
        } else {
            j = j.split(" yyyy").join(" [yyyy]") + "{ '-' " + j.split(" MMM").join(" [MMM]") + "}"
        }
        $("#col-main").fullCalendar({
            editable: i.canEdit,
            disableResizing: true,
            header: {
                left: "",
                center: "title",
                right: ""
            },
            defaultView: "month",
            year: c.localDateTime().getFullYear(),
            month: c.localDateTime().getMonth(),
            firstDay: b.Data.Culture.App.firstDay,
            timeFormat: b.Data.Culture.App.ShortTimePattern.replace(" A", "t"),
            columnFormat: {
                week: b.Data.Culture.App.ShortDayDatePattern.split("D").join("d")
            },
            titleFormat: {
                month: b.Data.Culture.App.YearMonthPattern.replace(",", "").split("Y").join("y"),
                week: j,
                day: b.Data.Culture.App.ShortMonthDayYearPattern
            },
            events: b.Data.CalendarEvents,
            eventRender: function(l, k) {
                k.find(".fc-event-title").html('<span style="font-size: 12px; font-weight: bold;">' + k.find(".fc-event-time").text() + "&nbsp;</span>" + k.find(".fc-event-title").text())
            },
            dayClick: function(m, k, o, r) {
                var l, q, p = b.Data.fullView,
                    n;
                if (r.calendar.options.editable) {
                    l = b.Us.getAthleticPrivileges(true, false, true);
                    if (l.canAddGame || l.canAddPractice) {
                        q = new b.Cs.EditableTeams({}, {
                            lookupDate: m
                        });
                        if (p) {
                            b.Data.EditableTeams = q;
                            q.fetch({
                                async: false,
                                error: function() {
                                    p3.displayError("Error loading sport levels")
                                }
                            })
                        }
                        if (!p || q.length > 0) {
                            if (l.canAddGame) {
                                n = new b.Ms.ScheduleItem({
                                    ScheduleType: 0,
                                    HomeAwayType: 0,
                                    LocationId: -1,
                                    LeagueInd: 1,
                                    Gamedate: c.getDateString(m)
                                });
                                b.Us.openGameScheduleDialog(0, n, b.Data.leadSectionId, true, null, p, false, l)
                            } else {
                                n = new b.Ms.ScheduleItem({
                                    PracticeDate: c.getDateString(m)
                                });
                                b.Us.openEditPracticeDialog(0, n, b.Data.leadSectionId, true, null, p, l)
                            }
                        }
                    }
                }
            },
            eventClick: function(l, m, p) {
                var o, n, k;
                k = b.Us.getAthleticPrivileges(true, false, true);
                if (m.target.className == "viewdetail") {
                    if (l.isGame) {
                        o = b.Us.getGameDetails(l.id);
                        p3.rV(new b.Vs.GameScheduleDetailsView({
                            scheduleItem: o.toJSON()
                        }), p3.Layout.Containers.Modal, true)
                    } else {
                        o = b.Us.getPracticeDetails(l.id);
                        p3.rV(new b.Vs.PracticeDetailsView({
                            scheduleItem: o.toJSON()
                        }), p3.Layout.Containers.Modal, true)
                    }
                    p3.showModal(p3.Layout.Containers.Modal)
                } else {
                    if (l.canEdit) {
                        if (l.isGame && k.canEditGame) {
                            o = b.Us.getGameDetails(l.id);
                            b.Us.openGameScheduleDialog(l.id, o, l.sectionId, true, null, false, false, k)
                        } else {
                            if (k.canEditPractice) {
                                n = b.Us.getPracticeItem(l.id, l.sectionId);
                                b.Us.openEditPracticeDialog(l.id, n, l.sectionId, true, null, false, k)
                            }
                        }
                    }
                }
                return false
            },
            eventDragStart: function(k, l, m, n) {
                if (!k.canDrag) {
                    l.preventDefault()
                }
            },
            eventDrop: function(p, m, r, k, v, q, w, y) {
                var t, s, x, u = "",
                    l, n, o;
                t = c.getDateString(p.start) + " " + c.getTimeString(p.start);
                if (p.isGame) {
                    l = new b.Cs.GameConflicts({}, {
                        teamId: p.sectionId,
                        gameDate: t.ApiFormat(),
                        scheduleId: p.id
                    });
                    x = new b.Ms.DateUpdate({
                        ScheduleId: p.id,
                        newDate: t,
                        endDate: t,
                        isGame: true
                    })
                } else {
                    s = c.getDateString(p.end) + " " + c.getTimeString(p.end);
                    l = new b.Cs.PracticeConflicts({}, {
                        teamId: p.sectionId,
                        dateStart: t.ApiFormat(),
                        practiceId: p.id,
                        dateEnd: s.ApiFormat()
                    });
                    x = new b.Ms.DateUpdate({
                        ScheduleId: p.id,
                        newDate: t,
                        endDate: s,
                        isGame: false,
                        reschedule: false
                    })
                }
                l.fetch({
                    async: false,
                    error: function(z, A) {
                        p3.displayError("Error validating schedule date.")
                    },
                    success: function(z, A) {
                        if (z && z.length > 0) {
                            u = b.Us.getConflictText(z.toJSON())
                        }
                    }
                });
                if (b.Data.fullView) {
                    if (p.isGame) {
                        if (!b.Data.editGameNotif || b.Data.editGameNotif.pk != p.sectionId) {
                            n = new f.Cs.NotificationActive({}, {
                                actionId: 43,
                                pk: p.sectionId
                            });
                            b.Data.editGameNotif = n;
                            n.fetch({
                                async: false,
                                success: function() {
                                    n.setNotificationProperties()
                                },
                                error: function() {
                                    p3.displayError("Error loading notification settings")
                                }
                            })
                        }
                    } else {
                        if (!b.Data.editPracticeNotif || b.Data.editPracticeNotif.pk != p.sectionId) {
                            o = new f.Cs.NotificationActive({}, {
                                actionId: 48,
                                pk: p.sectionId
                            });
                            b.Data.editPracticeNotif = o;
                            o.fetch({
                                async: false,
                                success: function() {
                                    o.setNotificationProperties()
                                },
                                error: function() {
                                    p3.displayError("Error loading notification settings")
                                }
                            })
                        }
                    }
                }
                if (p.isGame || (u.length > 0 || b.Data.editPracticeNotif.enabled)) {
                    b.Us.openScheduleConfirmDialog(x, p.isGame, true, u, true, true, false, v, p.sectionId, null, false, null)
                } else {
                    x.set("sendNotification", false);
                    x.save({}, {
                        error: function() {
                            p3.displayError("Error saving Practice")
                        }
                    })
                }
            },
            loading: function(k) {
                var l = '<div id="loading" class="alert alert-info" style="position: absolute; left: 47%; top: 38%; padding:6px; border:solid 1px #ff000;text-align: center;z-index: 1000; "><span id="load-icon"></span>Loading ...</div>';
                if (k) {
                    $("#col-main").prepend(l);
                    p3.loadingIcon("#load-icon")
                } else {
                    $("#loading").remove()
                }
            },
            viewDisplay: function(p) {
                var o = b.Data.scheduleItems.scheduleType,
                    m = 0,
                    l, k, n;
                l = '<div class="btn-group"><button class="btn btn-default btn-large btn-inverse" id="button-previous">&lt;</button><button class="btn btn-default btn-large btn-inverse" id="button-next">&gt;</button>';
                l += '<button class="btn btn-default btn-large btn-inverse" style="margin-left:10px;" id="button-today">Today</button>';
                l += '<button class="btn btn-default btn-large btn-inverse" style="margin-left:10px;" id="week-view">Week</button><button class="btn btn-default btn-large btn-inverse" id="month-view">Month</button></div>';
                $(".fc-header-left").html(l);
                if (!b.Data.fullView) {
                    m = b.Data.leadSectionId
                }
                p3.rV(new e.Vs.iCalTeamSchedule({
                    sectionId: m
                }), $(".fc-header-right"), true);
                window.setTimeout(function() {
                    if (!b.Data.fullView) {
                        var q = '<div class="pull-right" style="margin-top:8px;"><a class="btn btn-default btn-large btn-inverse" style="display:inline;" href="#athleticteam/' + b.Data.leadSectionId + '/schedule" >List View</a>&nbsp;&nbsp;</div>';
                        $(".fc-header-right").append(q)
                    }
                    $(".dropdown-toggle").addClass("btn-large").addClass("btn-inverse").css("display", "inline");
                    $(".dropdown").addClass("pull-right");
                    $(".p3icon-rssGreen").addClass("p3icon-rss").removeClass("p3icon-rssGreen")
                }, 300);
                $("tr.filter-row").remove();
                k = '<tr class="filter-row"><td colspan="3" style="padding-top:0px;padding-bottom:0px;"><div class="grayContainer">';
                k += '<div class="btn-toolbar" style="margin-top:10px; margin-bottom:8px"><table width="100%"><tr><td width="20%" style="padding-top:0px;padding-bottom:0px;margin-left:15px;"><div class="pull-left" style="padding-left:15px;"><a class="btn btn-default btn-large" href="javascript:history.go(-1)"><h4>&lt; Back</h4></a></div></td><td style="padding-top:0px;padding-bottom:0px;" align="center" width="60%">';
                k += '<div class="btn-group">';
                if (o == 0) {
                    k += '<button id="scheduleFilterAll" data-val="0" class="btn btn-default btn-large active scheduleTypeFilter cal-filter-on"><i class="p3icon-ok"></i> All</button>'
                } else {
                    k += '<button id="scheduleFilterAll" data-val="0" class="btn btn-default btn-large scheduleTypeFilter cal-filter-off"><i class="p3icon-check"></i> All</button>'
                }
                if (o == 1 || o == 3 || o == 5) {
                    k += '<button id="scheduleFilterHome" data-val="1" class="btn btn-default btn-large active scheduleTypeFilter cal-filter-on"><i class="p3icon-ok"></i> Home</button>'
                } else {
                    k += '<button id="scheduleFilterHome" data-val="1" class="btn btn-default btn-large scheduleTypeFilter cal-filter-off"><i class="p3icon-check"></i> Home</button>'
                }
                if (o == 2 || o == 3 || o == 6) {
                    k += '<button id="scheduleFilterAway" data-val="2" class="btn btn-default btn-large active scheduleTypeFilter cal-filter-on"><i class="p3icon-ok"></i> Away</button>'
                } else {
                    k += '<button id="scheduleFilterAway" data-val="2" class="btn btn-default btn-large scheduleTypeFilter cal-filter-off"><i class="p3icon-check"></i> Away</button>'
                }
                if (o == 4 || o == 5 || o == 6) {
                    k += '<button id="scheduleFilterPractice" data-val="4" class="btn btn-default btn-large active scheduleTypeFilter cal-filter-on"><i class="p3icon-ok"></i> Practice</button>'
                } else {
                    k += '<button id="scheduleFilterPractice" data-val="4" class="btn btn-default btn-large scheduleTypeFilter cal-filter-off"><i class="p3icon-check"></i> Practice</button>'
                }
                k += "</div></td>";
                k += '<td width="20%" style="padding-top:0px;padding-bottom:0px;"><div class="pull-right" style="padding-right:15px;">';
                if (b.Data.SportLevels && b.Data.SportLevels.length > 0) {
                    k += '<button id="sport-picker-button" class="btn btn-default btn-large"><h4><i class="p3icon-teams"></i> Select Teams</h4></button>'
                }
                k += "</div></td>";
                k += "</div></div></td></tr>";
                $(".fc-header tbody:last").append(k);
                $(".fc-widget-header").addClass("cal-column-header");
                $(".fc-header-title").html("<h1>" + p.title + "</h1>");
                $(".btn-inverse").removeClass("active");
                switch (p.name) {
                    case "basicWeek":
                        $("#week-view").addClass("active");
                        break;
                    case "month":
                        $("#month-view").addClass("active");
                        break
                }
                n = c.localDateTime().getTime();
                if (n >= p.visStart.getTime() && n <= p.visEnd.getTime()) {
                    $("#button-today").addClass("active")
                }
            }
        })
    };
    b.Us.hasAddGameTask = function() {
        return ((g.Us.getLinkById(1145).length) ? true : false)
    };
    b.Us.hasEditGameTask = function() {
        return ((g.Us.getLinkById(1146).length) ? true : false)
    };
    b.Us.hasAddPracticeTask = function() {
        return ((g.Us.getLinkById(4528).length) ? true : false)
    };
    b.Us.hasEditPracticeTask = function() {
        return ((g.Us.getLinkById(4529).length) ? true : false)
    };
    b.Us.getAthleticPrivileges = function(p, r, q) {
        var o = (r || false),
            k = (p || false),
            n = (q || false),
            i = o || (k && b.Us.hasAddGameTask()),
            l = o || (k && b.Us.hasEditGameTask()),
            j = (!o) && k && b.Us.hasAddPracticeTask(),
            m = (!o) && k && b.Us.hasEditPracticeTask();
        return {
            canAddGame: i,
            canAddPractice: j,
            canAddGameAndPractice: (i && j),
            canEditGame: l,
            canEditPractice: m,
            canEditGameAndPractice: (l && m),
            canAddBulkPractices: (j && (!n)),
            isLite: o
        }
    };
    Hb.registerHelper("FormatTime", function(i, l) {
        var k = "",
            j;
        if (c.isMidnight(l) || !l) {
            k = "TBA"
        } else {
            j = c.getDateString(c.getDate(i));
            j = c.getDate(j + " " + l);
            k = c.getTimeString(j)
        }
        return k
    });
    p3.router().route("athleticcalendar/:id", "athleticcalendar", function(i) {
        p3.renderMainPage(new b.Vs.FullCalendarView({
            sectionId: i
        }))
    })
}(p3.module("LMS/athleticschedule")));
(function(b) {
    var a = p3.module("LMS/athleticschedule"),
        d = p3.module("LMS/athleticroster"),
        c = p3.module("LMS/groupPageEdit");
    b.Pages = [{
        Id: 1,
        ContentId: 433,
        Label: "Team Page",
        RoutePage: "teampage",
        IconClass: "p3icon-page",
        HTMLID: "team-page-btn",
        Display: function(e) {
            var f = new c.Vs.LayoutView({
                sectionId: b.Data.sectionId,
                leadSectionId: b.Data.leadSectionId,
                content: b.Data.contentTypes,
                userHasFullAccess: b.Data.userHasFullAccess,
                isOwner: b.Data.IsOwner,
                isManager: b.Data.isManager,
                associationId: 2,
                contextLabelId: 3,
                preview: false,
                layoutId: b.Data.layoutId,
                pendingInd: false
            });
            p3.rV(f, e, true)
        },
        Active: true
    }, {
        Id: 2,
        ContentId: 268,
        Label: "Schedule",
        RoutePage: "schedule",
        IconClass: "p3icon-schedule",
        HTMLID: "schedule-btn",
        Display: function(e) {
            p3.rV(new a.Vs.TeamScheduleView({
                sectionId: b.Data.sectionId,
                leadSectionId: b.Data.leadSectionId,
                durationId: b.Data.durationId,
                content: b.Data.contentTypes,
                userHasFullAccess: b.Data.userHasFullAccess,
                isOwner: b.Data.IsOwner,
                isManager: b.Data.isManager
            }), e, true)
        },
        Active: false
    }, {
        Id: 3,
        ContentId: 434,
        Label: "Roster",
        RoutePage: "roster",
        IconClass: "p3icon-roster",
        HTMLID: "roster-btn",
        Display: function(e) {
            p3.rV(new d.Vs.RosterView({
                sectionId: b.Data.sectionId,
                leadSectionId: b.Data.leadSectionId,
                content: b.Data.contentTypes,
                coachId: b.Data.coachId,
                userHasFullAccess: b.Data.userHasFullAccess,
                isOwner: b.Data.IsOwner,
                isManager: b.Data.isManager,
                startDate: b.Data.StartDate,
                endDate: b.Data.EndDate,
                duration: b.Data.duration,
                enableSearch: true
            }), e, true)
        },
        Active: false
    }, {
        Id: 4,
        ContentId: 45,
        Label: "Calendar",
        RoutePage: "calendar",
        Hidden: true,
        Display: function(e) {
            p3.rV(new a.Vs.CalendarView({
                sectionId: b.Data.sectionId,
                leadSectionId: b.Data.leadSectionId,
                durationId: b.Data.durationId,
                content: b.Data.contentTypes,
                userHasFullAccess: b.Data.userHasFullAccess,
                isOwner: b.Data.IsOwner,
                isManager: b.Data.isManager
            }), e, true)
        },
        Active: false
    }];
    b.Ms.Section = Bbm.extend({
        url: function() {
            return ""
        }
    });
    b.Cs.Section = Bbc.extend({
        model: b.Ms.Section,
        initialize: function(e, f) {
            this.sectionId = f.sectionId || 0
        },
        url: function() {
            return aP + "datadirect/SectionInfoView/?format=json&sectionId=" + this.sectionId + "&associationId=2"
        }
    });
    b.Ms.Content = Bbm.extend({
        idAttribute: "ContentId",
        url: function() {
            return ""
        }
    });
    b.Cs.Content = Bbc.extend({
        model: b.Ms.Content,
        initialize: function(e, f) {
            this.sectionId = f.sectionId || 0;
            this.leadSectionId = f.leadSectionId || 0
        },
        url: function() {
            return aP + "datadirect/GroupPossibleContentGet/?format=json&leadSectionId=" + this.sectionId
        }
    });
    b.Data = {};
    b.Data.sectionId = 0;
    b.Data.leadSectionId = 0;
    b.Data.contentTypes = null;
    b.Data.MainViewRendered = false;
    b.Data.RenderedSectionId = 0;
    b.Data.coachId = 0;
    b.Data.durationId = 0;
    b.Data.StartDate = null;
    b.Data.EndDate = null;
    b.Data.duration = "";
    b.Vs.MainTeamView = Bb.View.extend({
        template: "athleticteam/athleticteammainview.template.html",
        initialize: function(e) {
            this.Containers = {};
            if (e) {
                b.Data.sectionId = b.Data.RenderedSectionId = this.SectionId = e.SectionId
            } else {
                b.Data.sectionId = b.Data.RenderedSectionId = this.SectionId = 0
            }
            b.Data.MainViewRendered = true
        },
        dispose: function() {
            b.Data.MainViewRendered = false
        },
        render: function(e) {
            var f = this;
            p3.fT(f.template, function(h) {
                f.$el.html(h({}));
                $(e).html(f.el);
                f.Containers.Navigation = $("#athleticteamnavmenu");
                f.Containers.MainContent = $("#athleticteammaincontainer");
                var g = new b.Cs.Section({}, {
                    sectionId: f.SectionId
                });
                p3.rV(new b.Vs.NavigationView({
                    ParentView: f,
                    collection: g
                }), f.Containers.Navigation, false);
                g.fetch({
                    error: function() {
                        p3.displayError("Error loading section information")
                    }
                })
            })
        }
    });
    b.Vs.NavigationView = Bb.View.extend({
        template: "athleticteam/athleticteamnavigationmenu.template.html",
        initialize: function(e) {
            this.collection.bind("reset change", this.renderTemplate, this);
            this.Containers = {};
            if (e) {
                this.ParentView = e.ParentView
            }
            this.enableScrollNav()
        },
        dispose: function() {
            this.disableScrollNav()
        },
        renderTemplate: function() {
            var v = this,
                e, l, f, s, h, n, p, j, m, t, k, i, o, r, u, q, g;
            v.collection.each(function(w) {
                if (w.get("Id") == b.Data.sectionId) {
                    e = w.get("Teacher");
                    l = w.get("GroupName");
                    s = w.get("SchoolYear");
                    h = w.get("Description");
                    n = w.get("IsOwner");
                    m = w.get("IsManager");
                    f = w.get("TeacherId");
                    p = w.get("LeadSectionId");
                    j = w.get("DurationId");
                    t = w.get("StartDate");
                    k = w.get("EndDate");
                    i = w.get("Duration");
                    o = w.get("LayoutId")
                }
            });
            b.Data.IsOwner = n;
            b.Data.isManager = m;
            b.Data.coachId = f;
            b.Data.leadSectionId = p;
            b.Data.durationId = j;
            b.Data.StartDate = t;
            b.Data.EndDate = k;
            b.Data.duration = i;
            r = p3.Data.Context.getSelectedPersona().Id;
            b.Data.userHasFullAccess = (r == 3 && b.Data.IsOwner) || b.Data.isManager;
            b.Data.layoutId = o;
            u = false;
            if (e !== "" || h || s) {
                u = true
            }
            g = new b.Cs.Content({}, {
                sectionId: b.Data.sectionId
            });
            q = [];
            g.fetch({
                error: function() {
                    p3.displayError("Error loading available content")
                },
                success: function() {
                    var y, x, w;
                    b.Data.contentTypes = g;
                    g.each(function(A) {
                        var z = A.get("ContentId"),
                            C = _.find(b.Pages, function(D) {
                                return D.ContentId === z
                            }),
                            B = A.get("ShowContentType");
                        if (C && B && !C.Hidden) {
                            q.push({
                                sort: C.Id,
                                title: C.Label,
                                iconClass: C.IconClass,
                                status: C.Active ? "active" : "inactive",
                                link: "athleticteam/" + b.Data.sectionId + "/" + C.RoutePage,
                                pId: C.Id,
                                HTMLID: C.HTMLID
                            });
                            C.Enabled = true
                        } else {
                            if (C) {
                                C.Enabled = false
                            }
                        }
                    });
                    y = _.find(b.Pages, function(z) {
                        return z.ContentId === 268
                    });
                    if (y && y.Enabled) {
                        x = _.find(b.Pages, function(z) {
                            return z.ContentId === 45
                        });
                        if (x) {
                            x.Enabled = true
                        }
                    }
                    q = _.sortBy(q, "sort");
                    p3.fT(v.template, function(z) {
                        v.$el.html(z({
                            Info: u,
                            Coach: e,
                            GroupName: l,
                            SchoolYear: s,
                            Description: h,
                            navigationItems: q
                        }))
                    });
                    w = _.find(b.Pages, function(z) {
                        return z.Active
                    });
                    if (w && w.Enabled) {
                        w.Display($("#athleticteammaincontainer"))
                    }
                }
            });
            return this
        },
        events: {
            "click #section-description-toggle": "toggleDescription",
            "click [data-pid]": "switchTab"
        },
        render: function(e) {
            $(e).append(this.el);
            return this
        },
        toggleDescription: function(f) {
            var e = $("#section-description-content");
            if (e) {
                if (e.filter(":visible").length) {
                    e.hide(400)
                } else {
                    e.show(400)
                }
            }
            return false
        },
        switchTab: function(e) {
            if ($(e.currentTarget).attr("data-pid") === "4") {
                _.find(b.Pages, function(f) {
                    return f.Id === 4
                }).Display();
                return false
            }
        },
        enableScrollNav: function(g) {
            var f = $(document),
                e = $(".subnavbar"),
                j = e.length && e.offset().top - 120,
                i = false,
                h = false;

            function k() {
                if (e.length === 0) {
                    e = $(".subnavbar");
                    j = e.length && e.offset().top - 120
                }
                var l = f.scrollTop();
                i = e.hasClass("subnavbar-fixed");
                if (h) {
                    h = false
                } else {
                    if (l >= j && !i) {
                        e.addClass("subnavbar-fixed");
                        h = true
                    } else {
                        if (l <= j && i) {
                            e.removeClass("subnavbar-fixed")
                        }
                    }
                }
            }
            f.on("scroll", k)
        },
        disableScrollNav: function(f) {
            var e = $(document);
            e.off("scroll")
        }
    });
    b.Us.LoadPage = function(e, g) {
        p3.loadingIcon("#athleticteammaincontainer");
        var f;
        _.each(b.Pages, function(h) {
            if (h.RoutePage.toLowerCase() === g.toLowerCase()) {
                h.Active = true
            } else {
                h.Active = false
            }
            if (h.Active) {
                f = h
            }
        });
        if (!b.Data.MainViewRendered || b.Data.RenderedSectionId != e) {
            p3.renderMainPage(new b.Vs.MainTeamView({
                SectionId: e
            }))
        } else {
            if (f && f.Enabled) {
                f.Display($("#athleticteammaincontainer"));
                b.Us.SwitchTabs(f)
            }
        }
    };
    b.Us.SwitchTabs = function(f) {
        var e = (p3.Config.uiVersion === 1) ? $(".nav-pills").children() : $(".nav-tabs").children();
        $.each(e, function() {
            var g = $(this);
            if (g.data("pid") === f.Id || (f.Id === 4 && g.data("pid") === 2)) {
                g.removeClass("inactive");
                g.addClass("active")
            } else {
                if (g.hasClass("active")) {
                    g.removeClass("active");
                    g.addClass("inactive")
                }
            }
        })
    };
    p3.router().route("athleticteam/:id", "athleticteam", function(e) {
        if (e.indexOf("&pk=") > -1) {
            e = e.substring(4)
        }
        b.Us.LoadPage(e, "teampage")
    });
    p3.router().route("athleticteam/:id/:page", "athleticteam", b.Us.LoadPage)
}(p3.module("LMS/athleticteam")));
(function(a) {
    var b = p3.module("LMS/groupPageEdit");
    a.Ms.Sections = Bbm.extend({
        idAttribute: "SectionId",
        url: function() {
            return ""
        }
    });
    a.Cs.Sections = Bbc.extend({
        model: a.Ms.Sections,
        initialize: function(c, d) {
            this.sectionId = d.sectionId || 0
        },
        url: function() {
            return aP + "datadirect/SectionsForTeacher/?format=json"
        }
    });
    p3.router().route("academicclassedit/:sectionId/:leadSectionId", "academicclassedit", function(d, c) {
        p3.setTitle("Edit Bulletinboard");
        b.Us.loadPageEditor(c, d, 1, 2)
    })
}(p3.module("LMS/classpage")));
(function(a) {
    var b = p3.module("LMS/groupPageEdit");
    p3.router().route("communitypageedit/:sectionId/:leadSectionId", "communitypageedit", function(d, c) {
        p3.setTitle("Edit Bulletinboard");
        b.Us.loadPageEditor(c, d, 3, 12)
    })
}(p3.module("LMS/communitybulletinboard")));
(function(a) {
    var d = p3.module("shared/task"),
        e = p3.module("LMS/topic"),
        c = p3.module("LMS/roster"),
        b = p3.module("LMS/groupPageEdit");
    a.Data = {};
    a.Pages = [{
        Id: 1,
        ContentId: 433,
        Label: "Bulletin Board",
        RoutePage: "bulletinboard",
        IconClass: "p3icon-page",
        HTMLID: "bulletin-board-btn",
        LinkId: "bulletin-board-link",
        Display: function(f) {
            var g;
            g = new b.Vs.LayoutView({
                sectionId: a.Data.sectionId,
                leadSectionId: a.Data.leadSectionId,
                content: a.Data.contentTypes,
                userHasFullAccess: a.Data.userHasFullAccess,
                isOwner: a.Data.IsOwner,
                isManager: a.Data.isManager,
                associationId: 3,
                contextLabelId: 12,
                preview: false,
                layoutId: a.Data.layoutId,
                pendingInd: false
            });
            p3.rV(g, f, true)
        },
        Active: true
    }, {
        Id: 2,
        ContentId: 386,
        Label: "Topics",
        RoutePage: "topics",
        IconClass: "p3icon-topics",
        HTMLID: "topics-btn",
        LinkId: "topics-link",
        Display: function(f) {
            p3.rV(new e.Vs.TopicManageView({
                sectionId: a.Data.sectionId,
                leadSectionId: a.Data.leadSectionId,
                active: true,
                future: false,
                expired: false,
                userHasFullAccess: a.Data.userHasFullAccess,
                isOwner: a.Data.IsOwner,
                isManager: a.Data.isManager,
                content: a.Data.contentTypes,
                levelNum: a.Data.levelNum || -1,
                durationId: a.Data.durationId,
                schoolYearLabel: a.Data.schoolYear,
                contextLabelId: 12
            }), f, true)
        },
        Active: false
    }, {
        Id: 3,
        ContentId: 434,
        Label: "Roster",
        RoutePage: "roster",
        IconClass: "p3icon-roster",
        HTMLID: "roster-btn",
        LinkId: "roster-link",
        Display: function(f) {
            p3.rV(new c.Vs.RosterView({
                sectionId: a.Data.sectionId,
                leadSectionId: a.Data.leadSectionId,
                durationId: a.Data.durationId,
                associationId: 3,
                isOwner: a.Data.IsOwner,
                enableSearch: true,
                disableLearningProfiles: true
            }), f, true)
        },
        Active: false
    }];
    a.Ms.Section = Bbm.extend({
        url: function() {
            return ""
        }
    });
    a.Cs.Section = Bbc.extend({
        model: a.Ms.Section,
        initialize: function(f, g) {
            this.sectionId = g.sectionId || 0
        },
        url: function() {
            return aP + "datadirect/SectionInfoView/?format=json&sectionId=" + this.sectionId + "&associationId=3"
        }
    });
    a.Ms.Content = Bbm.extend({
        idAttribute: "ContentId",
        url: function() {
            return ""
        }
    });
    a.Cs.Content = Bbc.extend({
        model: a.Ms.Content,
        initialize: function(f, g) {
            this.sectionId = g.sectionId || 0;
            this.leadSectionId = g.leadSectionId || 0
        },
        url: function() {
            return aP + "datadirect/GroupPossibleContentGet/?format=json&leadSectionId=" + this.leadSectionId
        }
    });
    a.Data = {};
    a.Data.leadSectionId = 0;
    a.Data.durationId = 0;
    a.Data.sectionId = 0;
    a.Data.contentTypes = null;
    a.Data.MainViewRendered = false;
    a.Data.RenderedSectionId = 0;
    a.Data.schoolYear = "";
    a.Vs.MainGroupView = Bb.View.extend({
        template: "communitygroup/communitygroupmainview.template.html",
        initialize: function(f) {
            this.Containers = {};
            if (f) {
                a.Data.sectionId = a.Data.RenderedSectionId = this.SectionId = f.SectionId
            } else {
                a.Data.sectionId = a.Data.RenderedSectionId = this.SectionId = 0
            }
            a.Data.MainViewRendered = true
        },
        dispose: function() {
            a.Data.MainViewRendered = false
        },
        render: function(f) {
            var g = this;
            p3.fT(g.template, function(i) {
                g.$el.html(i({}));
                $(f).html(g.el);
                g.Containers.Navigation = $("#communitypagenavmenu");
                g.Containers.MainContent = $("#communitypagecontainer");
                var h = new a.Cs.Section({}, {
                    sectionId: g.SectionId
                });
                p3.rV(new a.Vs.NavigationView({
                    ParentView: g,
                    collection: h
                }), g.Containers.Navigation, false);
                h.fetch({
                    error: function() {
                        p3.displayError("Error loading section information")
                    }
                })
            })
        }
    });
    a.Vs.NavigationView = Bb.View.extend({
        template: "communitygroup/communitygroupnavigationmenu.template.html",
        initialize: function(f) {
            this.collection.bind("reset change", this.renderTemplate, this);
            this.Containers = {};
            if (f) {
                this.ParentView = f.ParentView
            }
            this.enableScrollNav()
        },
        dispose: function() {
            this.disableScrollNav()
        },
        renderTemplate: function() {
            var u = this,
                k, t, i, q, r, p, o, j, l, m, n, h, g = false,
                f, s = [];
            u.collection.each(function(v) {
                if (v.get("Id") === parseInt(a.Data.sectionId, 10)) {
                    k = v.get("GroupName");
                    if (v.get("Identifier")) {
                        k += " " + v.get("Identifier")
                    }
                    i = v.get("Duration");
                    j = v.get("DurationId");
                    h = v.get("Description");
                    q = v.get("Level");
                    r = v.get("LevelNum");
                    t = v.get("SchoolYear");
                    if (v.get("Length")) {
                        if (v.get("Length") === 1) {
                            p = "1 Term"
                        } else {
                            p = v.get("Length") + " Terms"
                        }
                    }
                    o = v.get("LeadSectionId");
                    m = v.get("IsOwner");
                    l = v.get("IsManager");
                    n = v.get("LayoutId")
                }
            });
            a.Data.IsOwner = m;
            a.Data.leadSectionId = o;
            a.Data.durationId = j;
            a.Data.levelNum = r;
            a.Data.schoolYear = t;
            a.Data.isManager = l;
            a.Data.userHasFullAccess = a.Data.IsOwner || a.Data.isManager;
            a.Data.layoutId = n;
            if (i || j || h || q || p) {
                g = true
            }
            f = new a.Cs.Content({}, {
                sectionId: a.Data.sectionId,
                leadSectionId: a.Data.leadSectionId
            });
            f.fetch({
                error: function() {
                    p3.displayError("Error loading available content")
                },
                success: function() {
                    a.Data.contentTypes = f;
                    f.each(function(x) {
                        var w = x.get("ContentId"),
                            y = true,
                            A, z = _.find(a.Pages, function(B) {
                                return B.ContentId === w
                            });
                        y = x.get("ShowContentType");
                        if (y & w === 386) {
                            y = a.Data.userHasFullAccess || x.get("EditorAccess");
                            if (!y) {
                                A = new e.Cs.Topic({}, {
                                    sectionId: 0,
                                    leadSectionId: a.Data.leadSectionId,
                                    active: true,
                                    future: false,
                                    expired: false
                                });
                                A.fetch({
                                    async: false,
                                    success: function() {
                                        if (A.length > 0) {
                                            y = true
                                        }
                                    },
                                    error: function() {
                                        p3.displayError("Error loading topics")
                                    }
                                })
                            }
                        }
                        if (z && y) {
                            s.push({
                                sort: z.Id,
                                title: z.Label,
                                iconClass: z.IconClass,
                                status: z.Active ? "active" : "inactive",
                                link: d.Us.getUrlById(247, a.Data.sectionId + "/" + z.RoutePage),
                                pId: z.Id,
                                HTMLID: z.HTMLID,
                                LinkId: z.LinkId
                            });
                            z.Enabled = true
                        } else {
                            if (z) {
                                z.Enabled = false
                            }
                        }
                    });
                    s = _.sortBy(s, "sort");
                    p3.fT(u.template, function(w) {
                        u.$el.html(w({
                            Info: g,
                            GroupName: k,
                            Duration: i,
                            Level: q,
                            Length: p,
                            Description: h,
                            navigationItems: s
                        }))
                    });
                    var v = _.find(a.Pages, function(w) {
                        return w.Active
                    });
                    if (v && v.Enabled) {
                        v.Display($("#communitypagecontainer"))
                    }
                }
            });
            return this
        },
        events: {
            "click #section-description-toggle": "toggleDescription",
            "click [data-pid]": "switchTab"
        },
        render: function(f) {
            $(f).append(this.el);
            return this
        },
        toggleDescription: function(g) {
            var f = $("#section-description-content");
            if (f && f.filter(":visible").length) {
                f.hide(400)
            } else {
                f.show(400)
            }
            return false
        },
        switchTab: function(f) {
            if ($(f.currentTarget).attr("data-pid") === "4") {
                _.find(a.Pages, function(g) {
                    return g.Id === 4
                }).Display();
                return false
            }
        },
        enableScrollNav: function(h) {
            var g = $(document),
                f = $(".subnavbar"),
                i = f.length && f.offset().top - 101;

            function j() {
                if (f.length === 0) {
                    f = $(".subnavbar");
                    i = f.length && f.offset().top - 101
                }
                var l = g.scrollTop(),
                    k = f.hasClass("subnavbar-fixed");
                if (l >= i && !k) {
                    f.addClass("subnavbar-fixed")
                } else {
                    if (l <= i && k) {
                        f.removeClass("subnavbar-fixed")
                    }
                }
            }
            g.on("scroll", j)
        },
        disableScrollNav: function(g) {
            var f = $(document);
            f.off("scroll")
        }
    });
    a.Us.LoadPage = function(f, h) {
        p3.loadingIcon("#communitypagecontainer");
        var g;
        _.each(a.Pages, function(i) {
            if (i.RoutePage.toLowerCase() === h.toLowerCase()) {
                i.Active = true;
                g = i
            } else {
                i.Active = false
            }
        });
        if (!a.Data.MainViewRendered || a.Data.RenderedSectionId !== f) {
            p3.renderMainPage(new a.Vs.MainGroupView({
                SectionId: f
            }))
        } else {
            if (g && g.Enabled) {
                g.Display($("#communitypagecontainer"));
                a.Us.SwitchTabs(g)
            }
        }
    };
    a.Us.SwitchTabs = function(g) {
        var f = (p3.Config.uiVersion === 1) ? $(".nav-pills").children() : $(".nav-tabs").children();
        $.each(f, function() {
            var h = $(this);
            if (h.data("pid") === g.Id || (g.Id === 8 && h.data("pid") === 3)) {
                h.removeClass("inactive");
                h.addClass("active")
            } else {
                if (h.hasClass("active")) {
                    h.removeClass("active");
                    h.addClass("inactive")
                }
            }
        })
    };
    p3.router().route("communitypage/:id", "communitypage", function(f) {
        if (f.indexOf("&pk=") > -1) {
            f = f.substring(4)
        }
        a.Us.LoadPage(f, p3.Data.Context.get("UserInfo").UserId, "bulletinboard")
    });
    p3.router().route("communitypage/:id/:page", "communitypage", function(f, g) {
        a.Us.LoadPage(f, g)
    })
}(p3.module("LMS/communitygroup")));
(function(b) {
    var d = p3.module("pager"),
        c = p3.Us.Culture,
        a = p3.module("app");
    b.Data = {};
    b.Ms.SchoolInfoGet = Bbm.extend({
        url: function() {
            return aP + "integration/schoolinfoget/?format=json"
        }
    });
    b.Cs.VendorRoles = Bbc.extend({
        url: "integration/vendorrolesget/?format=json"
    });
    b.Ms.SettingsSave = Bbm.extend({
        url: function() {
            return aP + "eeconnect/InitialSettingsSave/?format=json"
        }
    });
    b.Ms.GetAccessToken = Bbm.extend({
        url: function() {
            return aP + "eeconnect/GetAccessToken/?format=json"
        }
    });
    b.Ms.EETypes = Bbm.extend({
        url: function() {
            return aP + "eeconnect/EETypesGet/?format=json"
        }
    });
    b.Ms.EEAttendanceTypes = Bbm.extend({
        url: function() {
            return aP + "eeconnect/EEAttendanceTypesGet/?format=json"
        }
    });
    b.Ms.EEMarkingColumns = Bbm.extend({
        url: function() {
            return aP + "eeconnect/EEMarkingColumnsGet/?format=json"
        }
    });
    b.Cs.Settings = Bbc.extend({
        url: "eeconnect/settingsget/?format=json"
    });
    b.Ms.WHType = Bbm.extend({
        idAttribute: "dd_id"
    });
    b.Cs.PhoneTypes = Bbc.extend({
        model: b.Ms.WHType,
        url: "datadirect/PhoneTypesGet/?format=json"
    });
    b.Cs.AddressTypes = Bbc.extend({
        model: b.Ms.WHType,
        url: "datadirect/AddressTypesGet/?format=json"
    });
    b.Cs.GradeLevels = Bbc.extend({
        model: b.Ms.WHType,
        url: "datadirect/GradeLevelsGet/?format=json"
    });
    b.Cs.AttendanceTypes = Bbc.extend({
        url: "eeconnect/AttendanceTypesGet/?format=json"
    });
    b.Cs.EEWHUnmatched = Bbc.extend({
        url: "datadirect/EEWHUnmatchedGet/?format=json"
    });
    b.Cs.EEUnmatched = Bbc.extend({
        url: "datadirect/EEUnmatchedGet/?format=json"
    });
    b.Cs.EEMatched = Bbc.extend({
        url: "datadirect/EEMatchedGet/?format=json"
    });
    b.Ms.EEMatchingStatistics = Bbm.extend({
        url: "datadirect/EEMatchingStatisticsGet/?format=json"
    });
    b.Cs.EEWHUser = Bbc.extend({
        url: "datadirect/EEWHUserGet/?format=json"
    });
    b.Ms.RelationshipType = Bbm.extend({
        idAttribute: "RelationshipId"
    });
    b.Cs.RelationshipType = Bbc.extend({
        model: b.Ms.RelationshipType,
        url: "eeconnect/RelationshipTypesGet/?format=json"
    });
    b.Ms.EEUser = Bbm.extend({
        url: function() {
            return aP + "eeconnect/EEUserGet/?format=json"
        }
    });
    b.Ms.UnlinkUser = Bbm.extend({
        url: function() {
            return aP + "eeconnect/UnlinkUser/?format=json"
        }
    });
    b.Ms.LinkUsers = Bbm.extend({
        url: function() {
            return aP + "eeconnect/LinkUsers/?format=json"
        }
    });
    b.Ms.CreateUsers = Bbm.extend({
        url: function() {
            return aP + "eeconnect/CreateUsers/?format=json"
        }
    });
    b.Cs.PossibleMatches = Bbc.extend({
        url: "datadirect/EEPossibleMatchGet/?format=json"
    });
    b.Ms.EETerms = Bbm.extend({
        url: function() {
            return aP + "eeconnect/EETermsGet/?format=json"
        }
    });
    b.Ms.WHTerm = Bbm.extend({
        idAttribute: "duration_id"
    });
    b.Cs.WHTerms = Bbc.extend({
        model: b.Ms.WHTerm,
        url: "datadirect/DurationPlusLevelGet/?format=json"
    });
    b.Cs.SchoolLevels = Bbc.extend({
        url: function() {
            return aP + "datadirect/SchoolLevelGet/1"
        }
    });
    b.Ms.WHMarkingPeriod = Bbm.extend({
        idAttribute: "marking_period_id"
    });
    b.Cs.WHMarkingPeriods = Bbc.extend({
        model: b.Ms.WHMarkingPeriod,
        url: "datadirect/MarkingPeriodsGet/?format=json"
    });
    b.Cs.EECourseLog = Bbc.extend({
        url: "datadirect/EECourseLogGet/?format=json"
    });
    b.Cs.EEAttendanceLog = Bbc.extend({
        url: "datadirect/EEAttendanceLogGet/?format=json"
    });
    b.Cs.EEGradeLog = Bbc.extend({
        url: "datadirect/EEGradeLogGet/?format=json"
    });
    b.Cs.SyncErrorList = Bbc.extend({
        url: "datadirect/EESyncErrorsGet/?format=json"
    });
    b.Cs.SectionGradeLog = Bbc.extend({
        url: "datadirect/EESectionGradeLogGet/?format=json"
    });
    b.Cs.EEUserLog = Bbc.extend({
        url: "datadirect/EEUserLogGet/?format=json"
    });
    b.Ms.LinkMismatchUser = Bbm.extend({
        url: function() {
            return aP + "eeconnect/LinkMismatchUser/?format=json"
        }
    });
    b.Ms.CreateMismatchUser = Bbm.extend({
        url: function() {
            return aP + "eeconnect/CreateMismatchUser/?format=json"
        }
    });
    b.Ms.RemoveRepositoryLink = Bbm.extend({
        url: function() {
            return aP + "eeconnect/RemoveRepositoryLink/?format=json"
        }
    });
    b.Vs.SettingsMain = Bb.View.extend({
        template: "connectee/layout.template.html",
        events: {
            "click #setup-button": "openInitSettings",
            "click #edit-settings-button": "openSettings",
            "click #unmatched-ee-button": "showUnmatchedEEUsers",
            "click #unmatched-onsuite-button": "showUnmatchedOnSuiteUsers",
            "click #matched-button": "showMatchedUsers",
            "click #course-summary-link": "showCourseSummary",
            "click #attendance-summary-link": "showAttendanceSummary",
            "click #grade-summary-link": "showGradeSummary",
            "click #auth-settings-button": "openInitSettings",
            "click #user-log-link": "showUserLog"
        },
        renderTemplate: function() {
            var e = this;
            p3.fT(e.template, function(f) {
                e.$el.html(f({
                    congrats: e.showCongrats,
                    enabled: e.enabled,
                    stats: e.stats.toJSON(),
                    haveToken: b.Data.AuthToken && b.Data.AuthToken.length > 0
                }))
            });
            e.showCongrats = false;
            e.Containers.UserList = "#user-list-container"
        },
        initialize: function() {
            this.showCongrats = false;
            this.Containers = {}
        },
        render: function(e) {
            var g = this,
                f;
            $(e).append(this.el);
            f = new b.Ms.SchoolInfoGet();
            f.fetch({
                data: {
                    vendorId: 95,
                    integrationTypeId: 5
                },
                success: function() {
                    g.enabled = f.get("enabled_ind");
                    if (!g.enabled) {
                        g.checkForSettings()
                    }
                    if (g.enabled && !b.Data.AuthToken) {
                        b.Us.GetAccessToken()
                    }
                    g.stats = new b.Ms.EEMatchingStatistics();
                    g.stats.fetch({
                        success: function(h, i) {
                            g.renderTemplate()
                        },
                        error: function(h, i) {
                            p3.displayError("Error loading matching statistics")
                        }
                    })
                },
                error: function(h, i) {
                    p3.displayError("Error getting Connect EE School Info")
                }
            })
        },
        openInitSettings: function(f) {
            var i = this,
                g, h = new b.Cs.Settings();
            h.fetch({
                success: function() {
                    g = new b.Vs.InitialSettings({
                        settings: h.models[0],
                        firstSetup: f.currentTarget.id === "setup-button"
                    });
                    p3.rV(g, p3.Layout.Containers.Modal, true);
                    p3.showModal(p3.Layout.Containers.Modal);
                    g.on("settingsInitialized", function(j, e) {
                        i.settingsInitialized(j, e)
                    })
                },
                error: function(e, j) {
                    p3.displayError("Error getting Connect EE parameters")
                }
            })
        },
        settingsInitialized: function(f, e) {
            var h = this,
                g;
            h.enabled = true;
            h.renderTemplate();
            p3.Layout.Containers.Modal.modal("hide");
            if (e) {
                g = new b.Vs.Settings({
                    settings: f,
                    initialSetup: true
                });
                p3.rV(g, p3.Layout.Containers.Modal, true);
                p3.showModal(p3.Layout.Containers.Modal);
                g.on("settingsSaved", function(i) {
                    h.settingsSaved(i, true)
                })
            } else {
                h.openSettings()
            }
        },
        openSettings: function(f) {
            var h = this,
                g = new b.Cs.Settings();
            g.fetch({
                success: function() {
                    var e = new b.Vs.Settings({
                        settings: g.models[0],
                        initialSetup: false
                    });
                    p3.rV(e, p3.Layout.Containers.Modal, true);
                    p3.showModal(p3.Layout.Containers.Modal);
                    e.on("settingsSaved", function(i) {
                        h.settingsSaved(i, false)
                    })
                },
                error: function(e, i) {
                    p3.displayError("Error getting Connect EE parameters")
                }
            })
        },
        settingsSaved: function(f, e) {
            var g = this;
            g.enabled = true;
            g.showCongrats = e;
            g.renderTemplate();
            p3.Layout.Containers.Modal.modal("hide")
        },
        showUnmatchedEEUsers: function(f) {
            this.showUserList("Unmatched Records in Education Edge", 0)
        },
        showUnmatchedOnSuiteUsers: function(f) {
            this.showUserList("Unmatched Records in Core", 1)
        },
        showMatchedUsers: function(f) {
            this.showUserList("Matched Records", 2)
        },
        showUserList: function(e, f) {
            var h = this,
                g;
            g = new b.Vs.UserList({
                label: e,
                type: f
            });
            p3.rV(g, h.Containers.UserList, true);
            g.on("countChange", function() {
                h.updateCounts()
            })
        },
        updateCounts: function() {
            var e = this;
            e.stats.fetch({
                success: function(f, g) {
                    $("#unmatched-ee-label").html(e.stats.get("vendor_unmatched"));
                    $("#unmatched-onsuite-label").html(e.stats.get("wh_unmatched"));
                    $("#matched-count").html(e.stats.get("matched_count"))
                },
                error: function(f, g) {
                    p3.displayError("Error loading matching statistics")
                }
            })
        },
        checkForSettings: function() {
            var f = this,
                e = new b.Cs.Settings();
            e.fetch({
                async: false,
                success: function() {
                    if (e.models[0].get("ApiUrl") && e.models[0].get("ApiUrl").length > 0) {
                        f.enabled = true
                    }
                },
                error: function(g, h) {
                    p3.displayError("Error getting Connect EE parameters")
                }
            })
        },
        showCourseSummary: function(g) {
            var h = this,
                f;
            f = new b.Vs.CourseList();
            p3.rV(f, h.Containers.UserList, true);
            g.preventDefault()
        },
        showAttendanceSummary: function(f) {
            var h = this,
                g;
            g = new b.Vs.LogList({
                grades: false
            });
            p3.rV(g, h.Containers.UserList, true);
            f.preventDefault()
        },
        showGradeSummary: function(f) {
            var h = this,
                g;
            g = new b.Vs.LogList({
                grades: true
            });
            p3.rV(g, h.Containers.UserList, true);
            f.preventDefault()
        },
        showUserLog: function(f) {
            var h = this,
                g;
            g = new b.Vs.LogList({
                grades: false,
                users: true
            });
            p3.rV(g, h.Containers.UserList, true);
            f.preventDefault()
        }
    });
    b.Vs.UserList = Bb.View.extend({
        template: "connectee/user-list.template.html",
        events: {
            "keyup #search-box": "checkTextKey",
            "click #search-button": "searchClick",
            "click .select-link-button": "setBulkCreateStatus",
            "click #select-all-link-button": "selectAllLink",
            "click .link-unmatched-link": "linkUnmatched",
            "click #bulk-create-button": "bulkCreateNew",
            "click .review-matched-link": "reviewMatch"
        },
        renderTemplate: function() {
            var f = this,
                e;
            if (f.Collection.length === 1) {
                e = "1 Result"
            } else {
                e = f.Collection.length + " Results"
            }
            p3.fT(f.template, function(g) {
                f.$el.html(g({
                    label: f.options.label,
                    users: f.getCurrentUsers(),
                    searchText: f.searchText,
                    countLabel: e,
                    listType: f.options.type
                }))
            });
            if (f.Collection.length > 20) {
                window.setTimeout(function() {
                    var h = new d.Cs.Pager(),
                        g;
                    h.getPages(f.Collection.length, f.currentPage, 20);
                    g = new d.Vs.PagerView({
                        collection: h,
                        prefix: "user",
                        itemCount: f.Collection.length,
                        currentPage: f.currentPage,
                        pageSize: 20,
                        scrollTop: true,
                        clickCallback: "pagerClick",
                        parentView: f
                    });
                    p3.rV(g, $("#user-pager"), true);
                    g.on("pagerClick", f.pageChanged)
                }, 100)
            }
        },
        pageChanged: function(e) {
            var f = this.options.parentView;
            if (e !== f.currentPage) {
                f.currentPage = e;
                f.renderTemplate()
            }
        },
        initialize: function() {
            this.Containers = {};
            this.searchText = "";
            this.instantiateCollection();
            this.currentPage = 1
        },
        render: function(e) {
            var f = this;
            $(e).append(this.el);
            f.getList("")
        },
        getList: function(e) {
            var f = this;
            f.searchText = e;
            f.Collection.fetch({
                data: {
                    searchText: e
                },
                success: function() {
                    f.renderTemplate()
                },
                error: function(g, h) {
                    p3.displayError("Error getting Connect EE user list")
                }
            })
        },
        getCurrentUsers: function() {
            var i = this,
                h = i.Collection.toJSON(),
                g = 0,
                e, f;
            if (h.length > 20) {
                if (i.currentPage > 1) {
                    g = (i.currentPage - 1) * 20
                }
                e = g + 20;
                f = h.slice(g, e)
            } else {
                f = h
            }
            return f
        },
        instantiateCollection: function() {
            var e = this;
            switch (e.options.type) {
                case 0:
                    e.Collection = new b.Cs.EEUnmatched();
                    break;
                case 1:
                    e.Collection = new b.Cs.EEWHUnmatched();
                    break;
                case 2:
                    e.Collection = new b.Cs.EEMatched();
                    break
            }
        },
        searchClick: function() {
            var e = this;
            e.getList($("#search-box").val().trim())
        },
        checkTextKey: function(e) {
            if (e.keyCode === 13) {
                this.getList($("#search-box").val().trim())
            }
        },
        setBulkCreateStatus: function(h) {
            var f = $(h.currentTarget),
                g = $(".select-link-button.active").length;
            if (f.hasClass("active")) {
                g -= 1
            } else {
                g += 1
            }
            if (g === 0) {
                $("#bulk-create-button").attr("disabled", "disabled")
            } else {
                $("#bulk-create-button").removeAttr("disabled")
            }
        },
        selectAllLink: function(f) {
            $(".select-link-button").addClass("active");
            $("#bulk-create-button").removeAttr("disabled")
        },
        linkUnmatched: function(g) {
            var i = this,
                f = $(g.currentTarget),
                h = new b.Vs.linkUsers({
                    eeId: f.data("extid"),
                    objectId: f.data("objectid")
                });
            p3.rV(h, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            h.on("userLinked", function() {
                i.getList();
                i.trigger("countChange")
            });
            h.on("userCreated", function() {
                i.getList();
                i.trigger("countChange")
            });
            g.preventDefault()
        },
        bulkCreateNew: function(g) {
            var j = this,
                i = [],
                h, f = $(".select-link-button.active");
            if (f.length > 0) {
                f.each(function(e, k) {
                    i.push($(k).data("objectid"))
                });
                h = new b.Ms.CreateUsers({
                    CreateUserList: i
                });
                h.save({}, {
                    success: function(e, k) {
                        j.getList();
                        j.trigger("countChange")
                    },
                    error: function(e, k) {
                        p3.displayError("Error creating users.")
                    }
                })
            }
        },
        reviewMatch: function(g) {
            var i = this,
                f = $(g.currentTarget),
                h = new b.Vs.ReviewMatch({
                    userId: f.data("id"),
                    eeId: f.data("extid"),
                    repoId: f.data("repoid")
                });
            p3.rV(h, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            h.on("userUnlinked", function() {
                i.getList();
                i.trigger("countChange")
            });
            g.preventDefault()
        }
    });
    b.Vs.SyncErrorsModal = Bb.View.extend({
        template: "connectee/syncerror.list.template.html",
        events: {
            "click .error-review-btn": "reviewError",
            "click .error-remove-btn": "removeLink"
        },
        render: function(e) {
            this.renderTemplate();
            $(e).append(this.el)
        },
        renderTemplate: function() {
            var g = this,
                e, f = g.options.typeId || 0;
            e = new b.Cs.SyncErrorList();
            e.fetch({
                data: {
                    logId: g.options.logId,
                    logTypeId: f
                },
                success: function() {
                    e.each(function(i) {
                        var h = i.get("action");
                        switch (h) {
                            case "External Repository ID's Don't Match":
                                i.set("reviewable", true);
                                break;
                            case "Section Repository Orphan - Section is linked in onCampus but is not being sent from EE":
                                i.set("canRemove", true);
                                i.set("objectId", 1);
                                break;
                            case "Course Repository Orphan - Course is linked in onCampus but is not being sent from EE":
                                i.set("canRemove", true);
                                i.set("objectId", 2);
                                break;
                            case "Department Repository Orphan - Department is linked in onCampus but is not being sent from EE":
                                i.set("canRemove", true);
                                i.set("objectId", 3);
                                break
                        }
                    });
                    p3.fT(g.template, function(h) {
                        g.$el.html(h({
                            type: g.options.type,
                            logId: g.options.logId,
                            date: g.options.date,
                            time: g.options.time,
                            SyncErrors: e.toJSON()
                        }))
                    })
                },
                error: function(h, i) {
                    p3.displayError("Error getting Connect EE SyncError list")
                }
            })
        },
        reviewError: function(h) {
            var f = $(h.currentTarget),
                j = f.data("id"),
                i = f.data("eeid"),
                k, l = '<div class="modal hide " tabindex="-1" id="error-review-modal"></div>',
                g;
            $(l).modal();
            g = $("#error-review-modal");
            k = new b.Vs.UserErrorReview({
                id: j,
                eeid: i,
                $btn: f
            });
            p3.rV(k, g, true);
            p3.setModalHeight(g)
        },
        removeLink: function(j) {
            var f = $(j.currentTarget),
                k = f.data("id"),
                l = f.data("objectid"),
                m = (l === 3 ? "department" : (l === 2 ? "course" : "section")),
                n = '<div class="modal hide " tabindex="-1" id="error-remove-modal"></div>',
                g, i, h, o;
            $(n).modal();
            g = $("#error-remove-modal");
            i = function() {
                g.modal("hide");
                g.remove();
                o = new b.Ms.RemoveRepositoryLink({
                    internalId: k,
                    objectId: l
                });
                o.save({}, {
                    success: function(e, p) {
                        f.parents("tr").remove()
                    },
                    error: function(e, p) {
                        p3.displayError("Error removing " + m + " link.")
                    }
                })
            };
            h = function() {
                g.modal("hide");
                g.remove()
            };
            p3.rV(new a.Vs.Confirm({
                ConfirmationTitle: "Confirm",
                ConfirmationText: "Are you sure you wish to remove the link to this " + m + "?",
                ConfirmCallback: i,
                CancelCallback: h,
                KeepOpen: true
            }), g, true)
        }
    });
    b.Vs.UserErrorReview = Bb.View.extend({
        template: "connectee/link.usererror.template.html",
        events: {
            "click .match-selector": "showPotentialMatch",
            "click #link-account-button": "linkClick",
            "click #create-new-link": "createNewClick",
            "click #link-confirm-button": "linkRecords",
            "click #create-confirm-button": "createRecord"
        },
        renderTemplate: function() {
            var p = this,
                g, h, l, m, n, e, q, o = p.WHUser.toJSON(),
                f;
            p3.fT(p.template, function(i) {
                p.$el.html(i({}))
            });
            p.Containers.whUsers = "#wh-user-container";
            p.Containers.eeUsers = "#ee-user-container";
            g = new b.Ms.EEUser();
            g.fetch({
                data: {
                    eeId: p.options.eeid,
                    accessToken: b.Data.AuthToken
                },
                success: function(r, s) {
                    var t = JSON.parse(s.ResponseString),
                        i, u = [],
                        k, j;
                    k = s.Mappings;
                    if (t.people && t.people.length > 0) {
                        i = t.people[0].bio;
                        e = t.people[0].contact_info;
                        if (e) {
                            for (h = 0; h < e.length; h++) {
                                q = "";
                                for (l = 0; l < k.length; l++) {
                                    if (k[l].EEFieldId === e[h].type_id) {
                                        j = k[l];
                                        break
                                    }
                                }
                                if (j) {
                                    switch (j.WHFieldId) {
                                        case -1:
                                            q = p.WHUser.models[0].get("email");
                                            break;
                                        case -2:
                                            q = p.WHUser.models[0].get("cc_email");
                                            break;
                                        default:
                                            for (m = 0; m < o.length; m++) {
                                                if (o[m].phone_type_id === j.WHFieldId) {
                                                    q = o[m].phone_number;
                                                    break
                                                }
                                            }
                                            break
                                    }
                                    u.push({
                                        EEDescription: j.EEDescription,
                                        WHDescription: j.WHDescription,
                                        EEValue: e[h].value,
                                        WHValue: q
                                    })
                                }
                            }
                        }
                    }
                    switch (i.record_type) {
                        case 1:
                            n = "Parent";
                            break;
                        case 6:
                        case 2:
                            n = "Student";
                            break;
                        case 8:
                            n = "Faculty";
                            break
                    }
                    u.push({
                        EEDescription: "Role",
                        WHDescription: "Role",
                        EEValue: n,
                        WHValue: p.WHUser.models[0].get("roles")
                    });
                    if (i.deceased || p.WHUser.models[0].get("deceased")) {
                        if (i.deceased) {
                            f = "Yes"
                        }
                        if (p.WHUser.models[0].get("deceased")) {
                            q = "Yes"
                        } else {
                            q = "No"
                        }
                        u.push({
                            EEDescription: "Deceased",
                            EEValue: f,
                            WHDescription: "Deceased",
                            WHValue: q
                        })
                    }
                    p.renderWHUser(u);
                    p.renderEEUser(i, u)
                },
                error: function(i, j) {
                    p3.displayError("Error loading EE User.")
                }
            })
        },
        initialize: function() {
            this.Containers = {}
        },
        render: function(e) {
            var f = this;
            $(e).append(this.el);
            f.WHUser = new b.Cs.EEWHUser();
            f.WHUser.fetch({
                data: {
                    userId: f.options.id
                },
                success: function() {
                    f.renderTemplate()
                },
                error: function(g, h) {
                    p3.displayError("Error loading WH User.")
                }
            })
        },
        renderEEUser: function(e, i) {
            var j = this,
                g, h, f;
            if (e.birth_date === "0001-01-01T00:00:00") {
                e.birth_date = ""
            } else {
                g = e.birth_date.split("T");
                h = g[0].split("-");
                e.birth_date = c.buildDateString(h[0], h[1] - 1, h[2])
            }
            f = new b.Vs.EEUserDetail({
                eeUser: e,
                eeId: j.options.eeId,
                userContacts: i
            });
            p3.rV(f, j.Containers.eeUsers, true)
        },
        renderWHUser: function(f) {
            var g = this,
                e = g.WHUser.models[0],
                h;
            if (e.get("birth_date")) {
                e.set("birth_date", c.getDateString(c.getDate(e.get("birth_date"))))
            }
            h = new b.Vs.WHUserDetail({
                whUser: e,
                userContacts: f
            });
            p3.rV(h, g.Containers.whUsers, true)
        },
        linkClick: function(f) {
            $("#link-confirm").show();
            $("#link-confirm-button").show();
            $("#link-account-button").hide();
            $("#or-header").hide();
            $("#create-new-link").hide();
            p3.setModalHeight("#error-review-modal")
        },
        createNewClick: function(f) {
            $("#create-confirm").show();
            $("#create-confirm-button").show();
            $("#link-account-button").hide();
            $("#or-header").hide();
            $("#create-new-link").hide();
            $("#wh-user-container").hide();
            p3.setModalHeight("#error-review-modal")
        },
        linkRecords: function(g) {
            var i = this,
                h, f = $("#error-review-modal");
            h = new b.Ms.LinkMismatchUser({
                eeId: i.options.eeid,
                userId: i.options.id
            });
            h.save({}, {
                success: function(e, j) {
                    f.modal("hide");
                    f.remove();
                    i.options.$btn.parent().html("<h5>Linked ID updated</h5>")
                },
                error: function(e, j) {
                    p3.displayError("Error linking user.")
                }
            })
        },
        createRecord: function(g) {
            var i = this,
                h, f = $("#error-review-modal");
            h = new b.Ms.CreateMismatchUser({
                eeId: i.options.eeid
            });
            h.save({}, {
                success: function(e, j) {
                    f.modal("hide");
                    f.remove();
                    i.options.$btn.parent().html("<h5>New user queued</h5>")
                },
                error: function(e, j) {
                    p3.displayError("Error creating user.")
                }
            })
        }
    });
    b.Vs.GradeLogModal = Bb.View.extend({
        template: "connectee/grade.log.template.html",
        render: function(e) {
            this.renderTemplate();
            $(e).append(this.el)
        },
        renderTemplate: function() {
            var f = this,
                e;
            e = new b.Cs.SectionGradeLog();
            e.fetch({
                data: {
                    logId: f.options.logId
                },
                success: function() {
                    p3.fT(f.template, function(j) {
                        var g = "",
                            h = [],
                            i = [];
                        e.each(function(k) {
                            if (g !== k.get("section_name")) {
                                g = k.get("section_name");
                                i = [];
                                h.push({
                                    section: k.get("section_name") + " - " + k.get("marking_period_description"),
                                    students: i
                                })
                            }
                            i.push(k.toJSON())
                        });
                        f.$el.html(j({
                            grades: h
                        }))
                    })
                },
                error: function(g, h) {
                    p3.displayError("Error getting grade log")
                }
            })
        }
    });
    b.Vs.CourseList = Bb.View.extend({
        template: "connectee/course-list.template.html",
        events: {
            "click .SyncErrorLink": "showSyncErrorList"
        },
        renderTemplate: function(e) {
            var f = this;
            p3.fT(f.template, function(g) {
                f.$el.html(g({
                    counts: e
                }))
            })
        },
        render: function(e) {
            var f = this;
            $(e).append(this.el);
            f.getList()
        },
        showSyncErrorList: function(g) {
            var l = this,
                i, h, k, f = $(g.currentTarget),
                j;
            g.preventDefault();
            k = f.attr("data-type");
            h = f.attr("data-logid");
            i = f.attr("data-rowid");
            j = new b.Vs.SyncErrorsModal({
                type: k,
                logId: h,
                date: l.counts[i].Date,
                time: l.counts[i].Time
            });
            p3.showModal(p3.Layout.Containers.Modal, {
                backOnHide: false
            });
            p3.rV(j, p3.Layout.Containers.Modal, true)
        },
        getList: function() {
            var j = this,
                f, h, e = 0,
                g = -1,
                i = 600000000;
            j.counts = [];
            f = new b.Cs.EECourseLog();
            f.fetch({
                success: function() {
                    f.each(function(k) {
                        if (e === 0 || e - k.get("log_dateTicks") > i) {
                            g += 1;
                            h = c.getDate(k.get("log_date"));
                            j.counts.push({
                                Date: c.getDateString(h),
                                Time: c.getTimeString(h),
                                Departments: 0,
                                Courses: 0,
                                Sections: 0,
                                Rosters: 0,
                                DepartmentsLogId: 0,
                                CoursesLogId: 0,
                                SectionsLogId: 0,
                                RostersLogId: 0,
                                RowIndex: g
                            });
                            e = k.get("log_dateTicks")
                        }
                        switch (k.get("log_type")) {
                            case 2:
                                j.counts[g].Courses = k.get("row_count");
                                j.counts[g].CoursesLogId = k.get("connect_ee_log_id");
                                break;
                            case 3:
                                j.counts[g].Sections = k.get("row_count");
                                j.counts[g].SectionsLogId = k.get("connect_ee_log_id");
                                break;
                            case 4:
                                j.counts[g].Departments = k.get("row_count");
                                j.counts[g].DepartmentsLogId = k.get("connect_ee_log_id");
                                break;
                            case 5:
                                j.counts[g].Rosters = k.get("row_count");
                                j.counts[g].RostersLogId = k.get("connect_ee_log_id");
                                break
                        }
                    });
                    j.renderTemplate(j.counts)
                },
                error: function(k, l) {
                    p3.displayError("Error getting Connect EE academic log")
                }
            })
        }
    });
    b.Vs.LogList = Bb.View.extend({
        template: "connectee/log-list.template.html",
        events: {
            "click .grade-error-link": "showGradeErrorLog",
            "click .grade-log-link": "showGradeLog",
            "click .SyncErrorLink": "showErrorLog"
        },
        renderTemplate: function(e) {
            var f = this;
            p3.fT(f.template, function(g) {
                f.$el.html(g({
                    logs: e.toJSON(),
                    grades: f.options.grades
                }))
            })
        },
        render: function(e) {
            var f = this;
            $(e).append(this.el);
            if (f.options.users) {
                f.template = "connectee/user-log-template.html"
            }
            f.getList()
        },
        getList: function() {
            var g = this,
                e, f;
            if (g.options.grades) {
                e = new b.Cs.EEGradeLog()
            } else {
                if (g.options.users) {
                    e = new b.Cs.EEUserLog()
                } else {
                    e = new b.Cs.EEAttendanceLog()
                }
            }
            e.fetch({
                success: function() {
                    e.each(function(h) {
                        f = c.getDate(h.get("log_date"));
                        h.set("Date", c.getDateString(f));
                        h.set("Time", c.getTimeString(f))
                    });
                    g.counts = e.toJSON();
                    g.renderTemplate(e)
                },
                error: function(h, i) {
                    p3.displayError("Error getting Connect EE log")
                }
            })
        },
        showGradeErrorLog: function(g) {
            var h, f = $(g.currentTarget),
                i;
            g.preventDefault();
            h = f.data("id");
            i = new b.Vs.SyncErrorsModal({
                type: "Grade",
                logId: h,
                typeId: 7
            });
            p3.showModal(p3.Layout.Containers.Modal, {
                backOnHide: false
            });
            p3.rV(i, p3.Layout.Containers.Modal, true)
        },
        showGradeLog: function(g) {
            var h, f = $(g.currentTarget),
                i;
            g.preventDefault();
            h = f.data("id");
            i = new b.Vs.GradeLogModal({
                logId: h
            });
            p3.showModal(p3.Layout.Containers.Modal, {
                backOnHide: false
            });
            p3.rV(i, p3.Layout.Containers.Modal, true)
        },
        showErrorLog: function(g) {
            var m = this,
                i, h, l, k, f = $(g.currentTarget),
                j;
            g.preventDefault();
            l = parseInt(f.attr("data-type"), 10);
            h = f.attr("data-logid");
            i = f.attr("data-rowid");
            switch (l) {
                case 1:
                    k = "Users";
                    break;
                case 8:
                    k = "Addresses";
                    break;
                case 9:
                    k = "Contacts";
                    break;
                case 10:
                    k = "Relationships";
                    break
            }
            j = new b.Vs.SyncErrorsModal({
                type: k,
                typeId: l,
                logId: h,
                date: m.counts[i].Date,
                time: m.counts[i].Time
            });
            p3.showModal(p3.Layout.Containers.Modal, {
                backOnHide: false
            });
            p3.rV(j, p3.Layout.Containers.Modal, true)
        }
    });
    b.Vs.InitialSettings = Bb.View.extend({
        template: "connectee/initial.setup.template.html",
        events: {
            "click #btnSave": "saveSettings",
            "click .btn-role": "removeRoleValidation",
            "change .input-medium": "removeTextValidation"
        },
        renderTemplate: function() {
            var e = this;
            p3.fT(e.template, function(f) {
                e.$el.html(f({
                    roles: e.Roles.toJSON(),
                    settings: e.options.settings.toJSON()
                }))
            })
        },
        render: function(e) {
            var f = this;
            $(e).append(this.el);
            f.Roles = new b.Cs.VendorRoles();
            f.Roles.fetch({
                data: {
                    vendorId: 95,
                    integrationTypeId: 5
                },
                success: function() {
                    f.renderTemplate()
                },
                error: function(g, h) {
                    p3.displayError("Error loading Vendor Roles.")
                }
            })
        },
        saveSettings: function(j) {
            var o = this,
                n = true,
                k = [],
                m, l, f = $("#btnSave"),
                g = $("#database-key-box"),
                h = $("#database-number-box"),
                i = $("#url-box");
            $(".control-group.error").removeClass("error");
            f.attr("disabled", "disabled");
            $(".alert-error").remove();
            if (i.val().length === 0) {
                $("#url-group").addClass("error");
                n = false
            }
            if (g.val().length === 0) {
                $("#database-key-group").addClass("error");
                n = false
            }
            if (h.val().length === 0) {
                $("#database-number-group").addClass("error");
                n = false
            }
            if ($(".btn-role.active").length === 0) {
                $("#roles-group").addClass("error");
                n = false
            }
            if (n) {
                $(".btn-role").each(function(p, q) {
                    var e = $(q);
                    k.push({
                        role_id: e.data("id"),
                        enabled_ind: e.hasClass("active")
                    })
                });
                m = new b.Ms.GetAccessToken({
                    VendorId: 95,
                    IntegrationType: 5,
                    Roles: k,
                    ApiUrl: i.val(),
                    DatabaseId: h.val(),
                    DatabaseKey: g.val(),
                    ApiVendorId: o.options.settings.get("ApiVendorId"),
                    ApiVendorKey: o.options.settings.get("ApiVendorKey")
                });
                m.save({}, {
                    success: function(e, p) {
                        var q = JSON.parse(p.ResponseString);
                        if (q && q.token && q.token.length > 0) {
                            b.Data.AuthToken = q.token;
                            l = new b.Ms.SettingsSave({
                                VendorId: 95,
                                IntegrationType: 5,
                                Roles: k,
                                ApiUrl: i.val(),
                                DatabaseId: h.val(),
                                DatabaseKey: g.val()
                            });
                            l.save({}, {
                                success: function(r, s) {
                                    r.set("ApiVendorId", o.options.settings.get("ApiVendorId"));
                                    r.set("ApiVendorKey", o.options.settings.get("ApiVendorKey"));
                                    o.trigger("settingsInitialized", r, o.options.firstSetup)
                                },
                                error: function(r, s) {
                                    f.removeAttr("disabled");
                                    p3.displayError("Error saving settings.")
                                }
                            })
                        } else {
                            p3.Us.InfoMessage.ErrorBox("Authorization failed please check that the parameters are correct.", ".modal-body", false);
                            p3.setModalHeight(p3.Layout.Containers.Modal);
                            f.removeAttr("disabled")
                        }
                    },
                    error: function(e, p) {
                        p3.Us.InfoMessage.ErrorBox("Authorization failed please check that the parameters are correct.", ".modal-body", false);
                        p3.setModalHeight(p3.Layout.Containers.Modal);
                        f.removeAttr("disabled")
                    }
                })
            } else {
                f.removeAttr("disabled")
            }
        },
        removeRoleValidation: function(f) {
            $("#roles-group").removeClass("error")
        },
        removeTextValidation: function(f) {
            $(f.currentTarget).parent().removeClass("error")
        }
    });
    b.Vs.Settings = Bb.View.extend({
        template: "connectee/setup.template.html",
        events: {
            "click #btnSave": "saveClick",
            "click .btn-role": "removeRoleValidation",
            "change .input-medium": "removeTextValidation",
            "click #authorize-link": "activateAuthorize",
            "click #user-link": "activateUser",
            "click #course-link": "activateCourses",
            "click #attendance-link": "activateAttendance",
            "click #grading-link": "activateGrading",
            "click .add-address-type": "addAddressDropdown",
            "click .delete-address-type": "deleteAddressDropdown",
            "click .add-phone-type": "addPhoneDropdown",
            "click .delete-phone-type": "deletePhoneDropdown",
            "click .add-email-type": "addEmailDropdown",
            "click .delete-email-type": "deleteEmailDropdown",
            "click .add-grade-type": "addGradeDropdown",
            "click .delete-grade-type": "deleteGradeDropdown",
            "click .add-level": "addLevelDropdown",
            "click .delete-level": "deleteLevelDropdown",
            "click .add-term": "addTermDropdown",
            "click .delete-term": "deleteTermDropdown",
            "click #default-user-button": "defaultUserClick",
            "click #user-type-button": "userTypeClick",
            "change #user-type-dropdown": "userTypeChange",
            "click .btn-select-year": "academicYearChange",
            "click .add-relationship-type": "addRelationshipDropdown",
            "click .delete-relationship-type": "deleteRelationshipDropdown"
        },
        initialize: function() {
            this.userMappings = [];
            this.userMappings.push({
                id: 0,
                mappings: []
            });
            this.userMappings.push({
                id: 1,
                mappings: []
            });
            this.userMappings.push({
                id: 2,
                mappings: []
            });
            this.byUser = false;
            this.userType = 0
        },
        renderTemplate: function() {
            var s = this,
                q = s.options.settings.get("Mappings"),
                r, l = 0,
                h = 0,
                m, g = s.AttendanceTypes.toJSON(),
                p = s.Levels.toJSON(),
                n, o, f = [],
                e = [];
            if (q && q.length > 0) {
                for (m = 0; m < q.length; m++) {
                    switch (q[m].MappingTypeId) {
                        case 1:
                            if (q[m].UserTypeId === 0) {
                                r = s.AddressTypes.get(q[m].WHFieldId);
                                if (r.get("EEId") > 0) {
                                    r.get("AdditionalIds").push({
                                        EEId: q[m].EEFieldId
                                    })
                                } else {
                                    r.set("EEId", q[m].EEFieldId);
                                    r.set("AdditionalIds", [])
                                }
                            } else {
                                s.setUserMappingValue(q[m].UserTypeId, q[m]);
                                s.byUser = true
                            }
                            break;
                        case 2:
                            if (q[m].UserTypeId === 0) {
                                switch (q[m].WHFieldId) {
                                    case -1:
                                        if (l > 0) {
                                            f.push({
                                                EEId: q[m].EEFieldId
                                            })
                                        } else {
                                            l = q[m].EEFieldId
                                        }
                                        break;
                                    case -2:
                                        if (h > 0) {
                                            e.push({
                                                EEId: q[m].EEFieldId
                                            })
                                        } else {
                                            h = q[m].EEFieldId
                                        }
                                        break;
                                    default:
                                        r = s.PhoneTypes.get(q[m].WHFieldId);
                                        if (r.get("EEId") > 0) {
                                            r.get("AdditionalIds").push({
                                                EEId: q[m].EEFieldId
                                            })
                                        } else {
                                            r.set("EEId", q[m].EEFieldId);
                                            r.set("AdditionalIds", [])
                                        }
                                        break
                                }
                            } else {
                                s.setUserMappingValue(q[m].UserTypeId, q[m]);
                                s.byUser = true
                            }
                            break;
                        case 3:
                            if (q[m].UserTypeId === 0) {
                                r = s.GradeLevels.get(q[m].WHFieldId);
                                if (r.get("EEId") > 0) {
                                    r.get("AdditionalIds").push({
                                        EEId: q[m].EEFieldId
                                    })
                                } else {
                                    r.set("EEId", q[m].EEFieldId);
                                    r.set("AdditionalIds", [])
                                }
                            } else {
                                s.setUserMappingValue(q[m].UserTypeId, q[m]);
                                s.byUser = true
                            }
                            break;
                        case 4:
                            r = s.Terms.get(q[m].WHFieldId);
                            if (r) {
                                if (r.get("EEId") > 0) {
                                    r.get("AdditionalIds").push({
                                        EEId: q[m].EEFieldId
                                    })
                                } else {
                                    r.set("EEId", q[m].EEFieldId);
                                    r.set("AdditionalIds", [])
                                }
                            }
                            break;
                        case 5:
                            for (n = 0; n < g.length; n++) {
                                for (o = 0; o < g[n].ExcuseList.length; o++) {
                                    if (g[n].ExcuseList[o].ExcuseTypeId === q[m].WHFieldId) {
                                        g[n].ExcuseList[o].EEId = q[m].EEFieldId;
                                        break
                                    }
                                }
                            }
                            break;
                        case 6:
                            for (n = 0; n < p.length; n++) {
                                if (p[n].LevelNum === q[m].WHFieldId) {
                                    if (p[n].EEId && p[n].EEId > 0) {
                                        p[n].AdditionalIds.push({
                                            EEId: q[m].EEFieldId
                                        })
                                    } else {
                                        p[n].EEId = q[m].EEFieldId;
                                        p[n].AdditionalIds = []
                                    }
                                    break
                                }
                            }
                            break;
                        case 7:
                            r = s.MarkingPeriods.get(q[m].WHFieldId);
                            if (r) {
                                r.set("EEId", q[m].EEFieldId);
                                r.set("EEDescription", q[m].EEDescription)
                            }
                            break;
                        case 8:
                            r = s.getRelationshipType(q[m].WHFieldId);
                            if (r) {
                                if (r[0].EEId && r[0].EEId > 0) {
                                    r[0].AdditionalIds.push({
                                        EEId: q[m].EEFieldId
                                    })
                                } else {
                                    r[0].EEId = q[m].EEFieldId;
                                    r[0].AdditionalIds = []
                                }
                            }
                            break
                    }
                }
            }
            p3.fT(s.template, function(i) {
                s.$el.html(i({
                    roles: s.Roles.toJSON(),
                    settings: s.options.settings.toJSON(),
                    initial: s.options.initialSetup,
                    EEPhoneTypes: b.Data.EEPhoneTypes,
                    EEAddressTypes: b.Data.EEAddressTypes,
                    EEGradeLevels: b.Data.EEGradeLevels,
                    AddressTypes: s.AddressTypes.toJSON(),
                    PhoneTypes: s.PhoneTypes.toJSON(),
                    GradeLevels: s.GradeLevels.toJSON(),
                    emailId: l,
                    ccEmailId: h,
                    Terms: s.Terms.toJSON(),
                    EETerms: b.Data.EETerms,
                    AttendanceTypes: g,
                    EEAttendanceTypes: b.Data.EEAttendanceTypes,
                    showAttendance: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.ATTENDANCELITE),
                    EELevels: b.Data.EELevels,
                    Levels: p,
                    MarkingPeriods: s.MarkingPeriods.toJSON(),
                    EEMarkingColumns: b.Data.EEMarkingColumns,
                    additionalEmail: f,
                    additionalCC: e,
                    byUser: s.byUser,
                    EEYears: b.Data.EEYears,
                    Relationships: s.RelationshipTypes,
                    EERelationships: b.Data.EERelationships
                }))
            })
        },
        render: function(e) {
            var r = this,
                g, f, p, h, l, m, q = r.options.settings.get("AcademicYears"),
                s = false,
                n = [],
                o;
            $(e).append(this.el);
            if (!b.Data.EEPhoneTypes) {
                g = new b.Ms.EETypes();
                g.fetch({
                    async: false,
                    data: {
                        typeId: 8,
                        accessToken: b.Data.AuthToken
                    },
                    success: function(i, j) {
                        var k = JSON.parse(j.ResponseString);
                        b.Data.EEPhoneTypes = k.table_entries
                    },
                    error: function(i, j) {
                        p3.displayError("Error loading EE Phone Types.")
                    }
                })
            }
            if (!b.Data.EEAddressTypes) {
                g = new b.Ms.EETypes();
                g.fetch({
                    async: false,
                    data: {
                        typeId: 86,
                        accessToken: b.Data.AuthToken
                    },
                    success: function(i, j) {
                        var k = JSON.parse(j.ResponseString);
                        b.Data.EEAddressTypes = k.table_entries
                    },
                    error: function(i, j) {
                        p3.displayError("Error loading EE Address Types.")
                    }
                })
            }
            if (!b.Data.EEGradeLevels) {
                g = new b.Ms.EETypes();
                g.fetch({
                    async: false,
                    data: {
                        typeId: 74,
                        accessToken: b.Data.AuthToken
                    },
                    success: function(i, j) {
                        var k = JSON.parse(j.ResponseString);
                        b.Data.EEGradeLevels = k.table_entries
                    },
                    error: function(i, j) {
                        p3.displayError("Error loading EE Grade Levels.")
                    }
                })
            }
            if (!b.Data.EETerms) {
                f = new b.Ms.EETerms();
                p = p3.Data.SchoolContext.get("CurrentSchoolYear").SchoolYearLabel;
                f.fetch({
                    async: false,
                    data: {
                        schoolYear: p,
                        accessToken: b.Data.AuthToken
                    },
                    success: function(i, j) {
                        var k = JSON.parse(j.ResponseString);
                        b.Data.EETerms = [];
                        b.Data.EELevels = [];
                        b.Data.EESessions = [];
                        b.Data.EEYears = [];
                        b.Data.YearJSON = k;
                        for (h = 0; h < k.academic_years.length; h++) {
                            if (n.indexOf(k.academic_years[h].school_id) === -1) {
                                b.Data.EELevels.push({
                                    eeSchoolId: k.academic_years[h].school_id,
                                    name: k.academic_years[h].school_name
                                });
                                n.push(k.academic_years[h].school_id)
                            }
                            s = q.indexOf(k.academic_years[h].ea7_academic_year_id) > -1;
                            b.Data.EEYears.push({
                                eeAcademicYearId: k.academic_years[h].ea7_academic_year_id,
                                eeAcademicYear: k.academic_years[h].description + " - " + k.academic_years[h].school_name,
                                Selected: s
                            });
                            if (s && k.academic_years[h].sessions) {
                                for (l = 0; l < k.academic_years[h].sessions.length; l++) {
                                    b.Data.EESessions.push({
                                        eeSessionId: k.academic_years[h].sessions[l].ea7_session_id,
                                        name: k.academic_years[h].school_name + " - " + k.academic_years[h].sessions[l].name
                                    });
                                    for (m = 0; m < k.academic_years[h].sessions[l].terms.length; m++) {
                                        b.Data.EETerms.push({
                                            eeTermId: k.academic_years[h].sessions[l].terms[m].ea7_term_id,
                                            name: k.academic_years[h].school_name + " - " + k.academic_years[h].sessions[l].name + " - " + k.academic_years[h].sessions[l].terms[m].name
                                        })
                                    }
                                }
                            }
                        }
                    },
                    error: function(i, j) {
                        p3.displayError("Error loading EE Terms.")
                    }
                })
            }
            if (!b.Data.EEAttendanceTypes) {
                g = new b.Ms.EEAttendanceTypes();
                g.fetch({
                    async: false,
                    data: {
                        accessToken: b.Data.AuthToken
                    },
                    success: function(i, j) {
                        var k = JSON.parse(j.ResponseString);
                        b.Data.EEAttendanceTypes = k.attendance_codes
                    },
                    error: function(i, j) {
                        p3.displayError("Error loading EE Attendance Types.")
                    }
                })
            }
            if (!b.Data.EERelationships) {
                g = new b.Ms.EETypes();
                g.fetch({
                    async: false,
                    data: {
                        typeId: 87,
                        accessToken: b.Data.AuthToken
                    },
                    success: function(i, j) {
                        var k = JSON.parse(j.ResponseString);
                        b.Data.EERelationships = k.table_entries
                    },
                    error: function(i, j) {
                        p3.displayError("Error loading EE Relationship Types.")
                    }
                })
            }
            if (!b.Data.EEMarkingColumns) {
                b.Data.EEMarkingColumns = [];
                for (h = 0; h < b.Data.EESessions.length; h++) {
                    r.getMarkingColumns(b.Data.EESessions[h].eeSessionId, b.Data.EESessions[h].name)
                }
            }
            r.PhoneTypes = new b.Cs.PhoneTypes();
            r.PhoneTypes.fetch({
                async: false,
                error: function(i, j) {
                    p3.displayError("Error loading Phone Types.")
                }
            });
            r.AddressTypes = new b.Cs.AddressTypes();
            r.AddressTypes.fetch({
                async: false,
                error: function(i, j) {
                    p3.displayError("Error loading Address Types.")
                }
            });
            o = new b.Cs.RelationshipType();
            o.fetch({
                async: false,
                success: function() {
                    r.RelationshipTypes = [];
                    _.each(o.toJSON(), function(i) {
                        if (i.RelationshipTypeId === 1) {
                            r.RelationshipTypes.push(i)
                        }
                    })
                },
                error: function(i, j) {
                    p3.displayError("Error loading Relationship Types.")
                }
            });
            r.GradeLevels = new b.Cs.GradeLevels();
            r.GradeLevels.fetch({
                async: false,
                error: function(i, j) {
                    p3.displayError("Error loading Grade Levels.")
                }
            });
            r.Terms = new b.Cs.WHTerms();
            r.Terms.fetch({
                data: {
                    schoolYear: p3.Data.SchoolContext.get("CurrentSchoolYear").SchoolYearLabel
                },
                error: function(i, j) {
                    p3.displayError("Error loading Terms.")
                }
            });
            r.AttendanceTypes = new b.Cs.AttendanceTypes();
            r.AttendanceTypes.fetch({
                async: false,
                error: function(i, j) {
                    p3.displayError("Error loading Attendance Types.")
                }
            });
            r.Levels = new b.Cs.SchoolLevels();
            r.Levels.fetch({
                async: false,
                error: function(i, j) {
                    p3.displayError("Error loading School Levels.")
                }
            });
            r.MarkingPeriods = new b.Cs.WHMarkingPeriods();
            r.MarkingPeriods.fetch({
                async: false,
                error: function(i, j) {
                    p3.displayError("Error loading Marking Periods.")
                }
            });
            r.Roles = new b.Cs.VendorRoles();
            r.Roles.fetch({
                data: {
                    vendorId: 95,
                    integrationTypeId: 5
                },
                success: function() {
                    r.renderTemplate()
                },
                error: function(i, j) {
                    p3.displayError("Error loading Vendor Roles.")
                }
            })
        },
        getMarkingColumns: function(h, j) {
            var e = new b.Ms.EEMarkingColumns(),
                g, f, k = this;
            e.fetch({
                async: false,
                data: {
                    sessionId: h,
                    accessToken: b.Data.AuthToken
                },
                success: function(i, l) {
                    var m = JSON.parse(l.ResponseString);
                    for (g = 0; g < m.marking_columns.length; g++) {
                        f = k.locateMarkingColumn(m.marking_columns[g].marking_column_table_entry_id);
                        if (!f) {
                            b.Data.EEMarkingColumns.push(m.marking_columns[g])
                        }
                    }
                },
                error: function(i, l) {
                    p3.displayError("Error loading EE Marking Columns.")
                }
            })
        },
        locateMarkingColumn: function(f) {
            var e;
            e = _.find(b.Data.EEMarkingColumns, function(g) {
                return g.marking_column_table_entry_id === f
            });
            return e
        },
        validate: function(f) {
            var g = true;
            $(".control-group.error").removeClass("error");
            $("#btnSave").attr("disabled", "disabled");
            $(".alert-error").remove();
            if ($("#url-box").val().length === 0) {
                $("#url-group").addClass("error");
                g = false
            }
            if ($("#database-key-box").val().length === 0) {
                $("#database-key-group").addClass("error");
                g = false
            }
            if ($("#database-number-box").val().length === 0) {
                $("#database-number-group").addClass("error");
                g = false
            }
            if ($(".btn-role.active").length === 0) {
                $("#roles-group").addClass("error");
                g = false
            }
            return g
        },
        authSettingsChanged: function() {
            var f = this,
                e = f.options.settings.toJSON();
            if (e.ApiUrl !== $("#url-box").val()) {
                return true
            }
            if (e.DataBaseId !== parseInt($("#database-number-box").val(), 10)) {
                return true
            }
            if (e.DatabaseKey !== $("#database-key-box").val()) {
                return true
            }
            return false
        },
        saveSettings: function() {
            var j = this,
                h = [],
                f = [],
                i, e = [],
                g = [];
            if (j.yearChange) {
                j.checkYears()
            }
            $(".btn-role").each(function(l, m) {
                var k = $(m);
                h.push({
                    role_id: k.data("id"),
                    enabled_ind: k.hasClass("active")
                })
            });
            j.collectUserMappings();
            if (j.byUser) {
                g = _.pluck(j.getSelectedRelationships(), "eeId");
                _.each(j.userMappings, function(k) {
                    if (k.id > 0 && (k.id === 1 || k.id === 2 || g.indexOf(k.id.toString()) > -1)) {
                        if (f.length > 0) {
                            f = f.concat(k.mappings)
                        } else {
                            f = k.mappings
                        }
                    }
                })
            } else {
                f = j.userMappings[0].mappings
            }
            $(".term-dd").each(function(l, m) {
                var k = $(m);
                if (k.val() > 0) {
                    f.push({
                        MappingTypeId: 4,
                        WHFieldId: k.data("id"),
                        EEFieldId: k.val(),
                        EEDescription: k.find("option:selected").text(),
                        WHDescription: k.parents("td").siblings().html()
                    })
                }
            });
            $(".attendance-dd").each(function(l, m) {
                var k = $(m);
                if (k.val() > 0) {
                    f.push({
                        MappingTypeId: 5,
                        WHFieldId: k.data("id"),
                        EEFieldId: k.val(),
                        EEDescription: k.find("option:selected").text(),
                        WHDescription: k.parent().siblings().html()
                    })
                }
            });
            $(".level-dd").each(function(l, m) {
                var k = $(m);
                if (k.val() > 0) {
                    f.push({
                        MappingTypeId: 6,
                        WHFieldId: k.data("id"),
                        EEFieldId: k.val(),
                        EEDescription: k.find("option:selected").text(),
                        WHDescription: k.parents("td").siblings().html()
                    })
                }
            });
            $(".marking-period-dd").each(function(l, m) {
                var k = $(m);
                if (k.val() > 0) {
                    f.push({
                        MappingTypeId: 7,
                        WHFieldId: k.data("id"),
                        EEFieldId: k.val(),
                        EEDescription: k.find("option:selected").text(),
                        WHDescription: k.parent().siblings().html()
                    })
                }
            });
            $(".btn-select-year.active").each(function(k, l) {
                e.push($(l).data("year"))
            });
            $(".relationship-type-dd").each(function(l, m) {
                var k = $(m);
                if (k.val() > 0) {
                    f.push({
                        MappingTypeId: 8,
                        WHFieldId: k.data("id"),
                        EEFieldId: k.val(),
                        EEDescription: k.find("option:selected").text(),
                        WHDescription: k.parents("td").siblings().html()
                    })
                }
            });
            i = new b.Ms.SettingsSave({
                VendorId: 95,
                IntegrationType: 5,
                Roles: h,
                ApiUrl: $("#url-box").val(),
                DatabaseId: $("#database-number-box").val(),
                DatabaseKey: $("#database-key-box").val(),
                SyncUsers: $("#user-sync-active").hasClass("active"),
                UserSyncInd: $("#user-manual-button").hasClass("active"),
                Mappings: f,
                SyncCourses: $("#course-sync-active").hasClass("active"),
                SyncAttendance: $("#attendance-sync-active").hasClass("active"),
                SyncGrading: $("#grading-sync-active").hasClass("active"),
                ForceRefresh: $("#force-refresh-button").hasClass("active"),
                AcademicYears: e,
                UpdateDepartments: $("#dept-update-active").hasClass("active"),
                UpdateCourses: $("#course-update-active").hasClass("active"),
                UseOCAttendace: $("#onCampus-active").hasClass("active"),
                UpdateUserName: $("#username-active").hasClass("active"),
                UpdateHostId: $("#hostid-active").hasClass("active")
            });
            i.save({}, {
                success: function(k, l) {
                    j.trigger("settingsSaved", k)
                },
                error: function(k, l) {
                    $("#btnSave").removeAttr("disabled");
                    p3.displayError("Error saving settings.")
                }
            })
        },
        saveClick: function(g) {
            var j = this,
                i = j.validate(),
                h, f = $("#btnSave");
            if (i) {
                if (j.authSettingsChanged()) {
                    h = new b.Ms.GetAccessToken({
                        VendorId: 95,
                        IntegrationType: 5,
                        ApiUrl: $("#url-box").val(),
                        DatabaseId: $("#database-number-box").val(),
                        DatabaseKey: $("#database-key-box").val(),
                        ApiVendorId: j.options.settings.get("ApiVendorId"),
                        ApiVendorKey: j.options.settings.get("ApiVendorKey")
                    });
                    h.save({}, {
                        success: function(e, k) {
                            var l = JSON.parse(k.ResponseString);
                            if (l && l.token && l.token.length > 0) {
                                b.Data.AuthToken = l.token;
                                j.saveSettings()
                            } else {
                                p3.Us.InfoMessage.ErrorBox("Authorization failed please check that the parameters are correct.", ".modal-body", false);
                                p3.setModalHeight(p3.Layout.Containers.Modal);
                                f.removeAttr("disabled")
                            }
                        },
                        error: function(e, k) {
                            p3.Us.InfoMessage.ErrorBox("Authorization failed please check that the parameters are correct.", ".modal-body", false);
                            p3.setModalHeight(p3.Layout.Containers.Modal);
                            f.removeAttr("disabled")
                        }
                    })
                } else {
                    j.saveSettings()
                }
            } else {
                f.removeAttr("disabled")
            }
        },
        removeRoleValidation: function(f) {
            $("#roles-group").removeClass("error")
        },
        removeTextValidation: function(f) {
            $(f.currentTarget).parent().removeClass("error")
        },
        activateAuthorize: function(f) {
            this.checkYears();
            this.activateTab(f, "#authorize-tab")
        },
        activateUser: function(f) {
            this.checkYears();
            this.syncUserTypes();
            this.activateTab(f, "#user-tab")
        },
        activateCourses: function(f) {
            this.checkYears();
            this.activateTab(f, "#course-tab")
        },
        activateAttendance: function(f) {
            this.checkYears();
            this.activateTab(f, "#attendance-tab")
        },
        activateGrading: function(f) {
            this.checkYears();
            this.activateTab(f, "#grading-tab")
        },
        activateTab: function(g, h) {
            var f = $(g.currentTarget);
            $(".nav-tabs li").removeClass("active");
            $(".nav-tabs li a").addClass("nav-tab-text");
            f.parent().addClass("active");
            f.removeClass("nav-tab-text");
            $(".tab-pane").removeClass("active");
            $(h).addClass("active");
            p3.setModalHeight(p3.Layout.Containers.Modal);
            g.preventDefault()
        },
        addAddressDropdown: function(h, g, o) {
            var j, l, f, n = p3.Config.uiVersion === 3,
                k = n ? "fa fa-trash" : "p3icon-delete",
                m = n ? "width:200px;display:inline;" : "";
            if (h === null) {
                f = $(g)
            } else {
                f = $(h.currentTarget)
            }
            l = '<div class="additional-address-type"><select class="address-type-dd input-medium form-control" data-id="' + f.data("id") + '" style="margin-top:2px;margin-right:3px;' + m + '">';
            l += '<option value="0">-- Please Select --</option>';
            for (j = 0; j < b.Data.EEAddressTypes.length; j++) {
                l += '<option value="' + b.Data.EEAddressTypes[j].id + '"';
                if (o && o === b.Data.EEAddressTypes[j].id) {
                    l += ' selected="selected"'
                }
                l += ">" + b.Data.EEAddressTypes[j].name + "</option>"
            }
            l += '</select><div class="btn btn-default btn-mini delete-address-type btn-link" data-toggle="button" style="margin-left:5px;"><i class="' + k + '" style="margin-left:2px;margin-right:1px;"></i></div></div>';
            f.parent().append(l)
        },
        deleteAddressDropdown: function(f) {
            $(f.currentTarget).parents(".additional-address-type").remove()
        },
        addPhoneDropdown: function(j, h, p) {
            var k, m, f, o = p3.Config.uiVersion === 3,
                l = o ? "fa fa-trash" : "p3icon-delete",
                n = o ? "width:200px;display:inline;" : "",
                g = o ? "btn-link" : "btn-mini";
            if (j === null) {
                f = $(h)
            } else {
                f = $(j.currentTarget)
            }
            m = '<div class="additional-phone-type"><select class="phone-type-dd input-medium form-control" data-id="' + f.data("id") + '" style="margin-top:2px;margin-right:3px;' + n + '">';
            m += '<option value="0">-- Please Select --</option>';
            for (k = 0; k < b.Data.EEPhoneTypes.length; k++) {
                m += '<option value="' + b.Data.EEPhoneTypes[k].id + '"';
                if (p && p === b.Data.EEPhoneTypes[k].id) {
                    m += ' selected="selected"'
                }
                m += ">" + b.Data.EEPhoneTypes[k].name + "</option>"
            }
            m += '</select><div class="btn btn-default ' + g + ' delete-phone-type" data-toggle="button" style="margin-left:5px;"><i class="' + l + '" style="margin-left:2px;margin-right:1px;"></i></div></div>';
            f.parent().append(m)
        },
        deletePhoneDropdown: function(f) {
            $(f.currentTarget).parents(".additional-phone-type").remove()
        },
        addEmailDropdown: function(j, h, p) {
            var k, m, f, o = p3.Config.uiVersion === 3,
                l = o ? "fa fa-trash" : "p3icon-delete",
                n = o ? "width:200px;display:inline;" : "",
                g = o ? "btn-link" : "btn-mini";
            if (j === null) {
                f = $(h)
            } else {
                f = $(j.currentTarget)
            }
            m = '<div class="additional-email-type"><select class="email-type-dd input-medium form-control" data-id="' + f.data("id") + '" style="margin-top:2px;margin-right:3px;' + n + '">';
            m += '<option value="0">-- Please Select --</option>';
            for (k = 0; k < b.Data.EEPhoneTypes.length; k++) {
                m += '<option value="' + b.Data.EEPhoneTypes[k].id + '"';
                if (p && p === b.Data.EEPhoneTypes[k].id) {
                    m += ' selected="selected"'
                }
                m += ">" + b.Data.EEPhoneTypes[k].name + "</option>"
            }
            m += '</select><div class="btn btn-default btn-default ' + g + ' delete-email-type" data-toggle="button" style="margin-left:5px;"><i class="' + l + '" style="margin-left:2px;margin-right:1px;"></i></div></div>';
            f.parent().append(m)
        },
        deleteEmailDropdown: function(f) {
            $(f.currentTarget).parents(".additional-email-type").remove()
        },
        addGradeDropdown: function(j, h, p) {
            var k, m, f, o = p3.Config.uiVersion === 3,
                l = o ? "fa fa-trash" : "p3icon-delete",
                n = o ? "width:200px;display:inline;" : "",
                g = o ? "btn-link" : "btn-mini";
            if (j === null) {
                f = $(h)
            } else {
                f = $(j.currentTarget)
            }
            m = '<div class="additional-grade-type"><select class="grade-level-dd input-medium form-control" data-id="' + f.data("id") + '" style="margin-top:2px;margin-right:3px;' + n + '">';
            m += '<option value="0">-- Please Select --</option>';
            for (k = 0; k < b.Data.EEGradeLevels.length; k++) {
                m += '<option value="' + b.Data.EEGradeLevels[k].id + '"';
                if (p && p === b.Data.EEGradeLevels[k].id) {
                    m += ' selected="selected"'
                }
                m += ">" + b.Data.EEGradeLevels[k].name + "</option>"
            }
            m += '</select><div class="btn btn-default ' + g + ' delete-grade-type" data-toggle="button" style="margin-left:5px;"><i class="' + l + '" style="margin-left:2px;margin-right:1px;"></i></div></div>';
            f.parent().append(m)
        },
        deleteGradeDropdown: function(f) {
            $(f.currentTarget).parents(".additional-grade-type").remove()
        },
        addLevelDropdown: function(h) {
            var j, l, f = $(h.currentTarget),
                n = p3.Config.uiVersion === 3,
                k = n ? "fa fa-trash" : "p3icon-delete",
                m = n ? "width:200px;display:inline;" : "",
                g = n ? "btn-link" : "btn-mini";
            l = '<div class="additional-level"><select class="level-dd input-medium form-control" data-id="' + f.data("id") + '" style="margin-top:2px;margin-right:3px;' + m + '">';
            l += '<option value="0">-- Please Select --</option>';
            for (j = 0; j < b.Data.EELevels.length; j++) {
                l += '<option value="' + b.Data.EELevels[j].eeSchoolId + '">' + b.Data.EELevels[j].name + "</option>"
            }
            l += '</select><div class="btn btn-default ' + g + ' delete-level" data-toggle="button" style="margin-left:5px;"><i class="' + k + '" style="margin-left:2px;margin-right:1px;"></i></div></div>';
            f.parent().append(l)
        },
        deleteLevelDropdown: function(f) {
            $(f.currentTarget).parents(".additional-level").remove()
        },
        addTermDropdown: function(h) {
            var j, l, f = $(h.currentTarget),
                n = p3.Config.uiVersion === 3,
                k = n ? "fa fa-trash" : "p3icon-delete",
                m = n ? "width:200px;display:inline;" : "",
                g = n ? "btn-link" : "btn-mini";
            l = '<div class="additional-term"><select class="term-dd input-medium form-control" data-id="' + f.data("id") + '" style="margin-top:2px;margin-right:3px;' + m + '">';
            l += '<option value="0">-- Please Select --</option>';
            for (j = 0; j < b.Data.EETerms.length; j++) {
                l += '<option value="' + b.Data.EETerms[j].eeTermId + '">' + b.Data.EETerms[j].name + "</option>"
            }
            l += '</select><div class="btn btn-default ' + g + ' delete-term" data-toggle="button" style="margin-left:5px;"><i class="' + k + '" style="margin-left:2px;margin-right:1px;"></i></div></div>';
            f.parent().append(l)
        },
        deleteTermDropdown: function(f) {
            $(f.currentTarget).parents(".additional-term").remove()
        },
        addRelationshipDropdown: function(j, h, p) {
            var k, m, f, o = p3.Config.uiVersion === 3,
                l = o ? "fa fa-trash" : "p3icon-delete",
                n = o ? "width:200px;display:inline;" : "",
                g = o ? "btn-link" : "btn-mini";
            if (j === null) {
                f = $(h)
            } else {
                f = $(j.currentTarget)
            }
            m = '<div class="additional-relationship-type"><select class="relationship-type-dd input-medium form-control" data-id="' + f.data("id") + '" style="margin-top:2px;margin-right:3px;' + n + '">';
            m += '<option value="0">-- Please Select --</option>';
            for (k = 0; k < b.Data.EERelationships.length; k++) {
                m += '<option value="' + b.Data.EERelationships[k].id + '"';
                if (p && p === b.Data.EERelationships[k].id) {
                    m += ' selected="selected"'
                }
                m += ">" + b.Data.EERelationships[k].name + "</option>"
            }
            m += '</select><div class="btn ' + g + ' delete-relationship-type" data-toggle="button" style="margin-left:5px;"><i class="' + l + '" style="margin-left:2px;margin-right:1px;"></i></div></div>';
            f.parent().append(m)
        },
        deleteRelationshipDropdown: function(f) {
            $(f.currentTarget).parents(".additional-relationship-type").remove()
        },
        defaultUserClick: function(f) {
            if (!$(f.currentTarget).hasClass("active")) {
                this.collectUserMappings();
                this.byUser = false;
                this.userType = 0;
                this.displayUserMappings();
                $("#user-type-region").hide();
                $("#user-options").show();
                $("#gradelevel").show()
            }
        },
        userTypeClick: function(f) {
            if (!$(f.currentTarget).hasClass("active")) {
                this.collectUserMappings();
                this.byUser = true;
                this.userType = 0;
                $("#user-type-region").show();
                $("#user-options").hide();
                this.syncUserTypes()
            }
        },
        userTypeChange: function(i) {
            var f = $("#gradelevel"),
                g = $("#user-options"),
                h = $("#user-type-dropdown");
            this.collectUserMappings();
            this.userType = parseInt(h.val(), 10);
            switch (h.val()) {
                case "0":
                    $("#user-options").hide();
                    break;
                case "2":
                    this.displayUserMappings();
                    g.show();
                    f.show();
                    break;
                default:
                    this.displayUserMappings();
                    g.show();
                    f.hide();
                    break
            }
        },
        collectUserMappings: function() {
            var h = [],
                i = 0,
                f = 0,
                j = this,
                e, g;
            if (!j.byUser || j.userType > 0) {
                $(".address-type-dd").each(function(l, m) {
                    var k = $(m);
                    if (k.val() > 0) {
                        e = k.data("id");
                        if (e === f) {
                            i += 1
                        } else {
                            i = 0;
                            f = e
                        }
                        h.push({
                            MappingTypeId: 1,
                            WHFieldId: e,
                            EEFieldId: parseInt(k.val(), 10),
                            EEDescription: k.find("option:selected").text(),
                            WHDescription: k.parents("td").siblings().html(),
                            SortOrder: i,
                            UserTypeId: j.userType
                        })
                    }
                });
                i = 0;
                f = 0;
                $(".phone-type-dd").each(function(l, m) {
                    var k = $(m);
                    if (k.val() > 0) {
                        e = k.data("id");
                        if (e === f) {
                            i += 1
                        } else {
                            i = 0;
                            f = e
                        }
                        h.push({
                            MappingTypeId: 2,
                            WHFieldId: e,
                            EEFieldId: parseInt(k.val(), 10),
                            EEDescription: k.find("option:selected").text(),
                            WHDescription: k.parents("td").siblings().html(),
                            SortOrder: i,
                            UserTypeId: j.userType
                        })
                    }
                });
                i = 0;
                f = 0;
                $(".email-type-dd").each(function(l, m) {
                    var k = $(m);
                    if (k.val() > 0) {
                        e = k.data("id");
                        if (e === f) {
                            i += 1
                        } else {
                            i = 0;
                            f = e
                        }
                        h.push({
                            MappingTypeId: 2,
                            WHFieldId: e,
                            EEFieldId: parseInt(k.val(), 10),
                            EEDescription: k.find("option:selected").text(),
                            WHDescription: k.parents("td").siblings().html(),
                            SortOrder: i,
                            UserTypeId: j.userType
                        })
                    }
                });
                if (!this.byUser || this.userType === 2) {
                    i = 0;
                    f = 0;
                    $(".grade-level-dd").each(function(l, m) {
                        var k = $(m);
                        if (k.val() > 0) {
                            e = k.data("id");
                            if (e === f) {
                                i += 1
                            } else {
                                i = 0;
                                f = e
                            }
                            h.push({
                                MappingTypeId: 3,
                                WHFieldId: e,
                                EEFieldId: parseInt(k.val(), 10),
                                EEDescription: k.find("option:selected").text(),
                                WHDescription: k.parents("td").siblings().html(),
                                SortOrder: i,
                                UserTypeId: j.userType
                            })
                        }
                    })
                }
                g = _.filter(j.userMappings, function(k) {
                    return k.id === j.userType
                });
                if (g.length === 0) {
                    j.userMappings.push({
                        id: j.userType,
                        mappings: h
                    })
                } else {
                    g[0].mappings = h
                }
            }
        },
        displayUserMappings: function() {
            var k = this,
                h = _.filter(k.userMappings, function(i) {
                    return i.id === k.userType
                }),
                j = h[0].mappings,
                e, g = 0,
                f = 0;
            $(".additional-address-type").remove();
            $(".address-type-dd").val(0);
            $(".additional-phone-type").remove();
            $(".phone-type-dd").val(0);
            $(".additional-email-type").remove();
            $(".email-type-dd").val(0);
            $(".additional-grade-type").remove();
            $(".grade-level-dd").val(0);
            for (e = 0; e < j.length; e++) {
                switch (j[e].MappingTypeId) {
                    case 1:
                        if (f !== j[e].WHFieldId || g !== j[e].MappingTypeId) {
                            $(".address-type-dd[data-id='" + j[e].WHFieldId + "']").val(j[e].EEFieldId)
                        } else {
                            k.addAddressDropdown(null, $(".address-type-dd[data-id='" + j[e].WHFieldId + "']")[0], j[e].EEFieldId)
                        }
                        break;
                    case 2:
                        if (j[e].WHFieldId > 0) {
                            if (f !== j[e].WHFieldId || g !== j[e].MappingTypeId) {
                                $(".phone-type-dd[data-id='" + j[e].WHFieldId + "']").val(j[e].EEFieldId)
                            } else {
                                k.addPhoneDropdown(null, $(".phone-type-dd[data-id='" + j[e].WHFieldId + "']")[0], j[e].EEFieldId)
                            }
                        } else {
                            if (f !== j[e].WHFieldId || g !== j[e].MappingTypeId) {
                                $(".email-type-dd[data-id='" + j[e].WHFieldId + "']").val(j[e].EEFieldId)
                            } else {
                                k.addEmailDropdown(null, $(".email-type-dd[data-id='" + j[e].WHFieldId + "']")[0], j[e].EEFieldId)
                            }
                        }
                        break;
                    case 3:
                        if (f !== j[e].WHFieldId || g !== j[e].MappingTypeId) {
                            $(".grade-level-dd[data-id='" + j[e].WHFieldId + "']").val(j[e].EEFieldId)
                        } else {
                            k.addGradeDropdown(null, $(".grade-level-dd[data-id='" + j[e].WHFieldId + "']")[0], j[e].EEFieldId)
                        }
                        break
                }
                f = j[e].WHFieldId;
                g = j[e].MappingTypeId
            }
        },
        academicYearChange: function(f) {
            this.yearChange = true
        },
        checkYears: function(l) {
            var p = [],
                h, m, n, o, f = $(".marking-period-dd"),
                g = $(".term-dd");
            if (this.yearChange) {
                $(".btn-select-year.active").each(function(e, i) {
                    p.push($(i).data("year"))
                });
                for (m = 0; m < b.Data.EEYears.length; m++) {
                    if (p.indexOf(b.Data.EEYears[m].eeAcademicYearId) > -1) {
                        b.Data.EEYears[m].Selected = true
                    } else {
                        b.Data.EEYears[m].Selected = false
                    }
                }
                this.options.settings.set("AcademicYears", p);
                $(".additional-term").remove();
                g.empty();
                g.append($("<option>", {
                    value: "0",
                    text: "-- Please Select --"
                }, "<option/>"));
                f.empty();
                f.append($("<option>", {
                    value: "0",
                    text: "-- Please Select --"
                }, "<option/>"));
                b.Data.EESessions = [];
                b.Data.EETerms = [];
                b.Data.EEMarkingColumns = [];
                if (p.length > 0) {
                    h = b.Data.YearJSON.academic_years;
                    for (m = 0; m < h.length; m++) {
                        if (p.indexOf(h[m].ea7_academic_year_id) > -1 && h[m].sessions) {
                            for (n = 0; n < h[m].sessions.length; n++) {
                                b.Data.EESessions.push({
                                    eeSessionId: h[m].sessions[n].ea7_session_id,
                                    name: h[m].school_name + " - " + h[m].sessions[n].name
                                });
                                for (o = 0; o < h[m].sessions[n].terms.length; o++) {
                                    b.Data.EETerms.push({
                                        eeTermId: h[m].sessions[n].terms[o].ea7_term_id,
                                        name: h[m].school_name + " - " + h[m].sessions[n].name + " - " + h[m].sessions[n].terms[o].name
                                    });
                                    g.append($("<option>", {
                                        value: h[m].sessions[n].terms[o].ea7_term_id,
                                        text: h[m].school_name + " - " + h[m].sessions[n].name + " - " + h[m].sessions[n].terms[o].name
                                    }, "<option/>"))
                                }
                            }
                        }
                    }
                    for (m = 0; m < b.Data.EESessions.length; m++) {
                        this.getMarkingColumns(b.Data.EESessions[m].eeSessionId, b.Data.EESessions[m].name)
                    }
                    if (b.Data.EEMarkingColumns.length > 0) {
                        for (m = 0; m < b.Data.EEMarkingColumns.length; m++) {
                            f.append($("<option>", {
                                value: b.Data.EEMarkingColumns[m].marking_column_table_entry_id,
                                text: b.Data.EEMarkingColumns[m].description
                            }, "<option/>"))
                        }
                    }
                }
                this.yearChange = false
            }
        },
        syncUserTypes: function() {
            var i = this,
                h = [],
                g, f, e = $("#user-type-dropdown");
            if (i.byUser) {
                h = i.getSelectedRelationships();
                e.empty();
                e.append($("<option>", {
                    value: "0",
                    text: "-- Select A User Type --"
                }, "<option/>"));
                e.append($("<option>", {
                    value: "2",
                    text: "For Students"
                }, "<option/>"));
                e.append($("<option>", {
                    value: "1",
                    text: "For Faculty"
                }, "<option/>"));
                _.each(h, function(j) {
                    f = parseInt(j.eeId, 10);
                    e.append($("<option>", {
                        value: f,
                        text: "For " + j.name
                    }, "<option/>"));
                    g = _.filter(i.userMappings, function(k) {
                        return k.id === f
                    });
                    if (g.length === 0) {
                        i.userMappings.push({
                            id: f,
                            mappings: []
                        })
                    }
                });
                e.val(i.userType);
                if (parseInt(e.val(), 10) !== i.userType) {
                    i.userType = 0
                }
            }
        },
        getSelectedRelationships: function() {
            var e = [];
            $(".relationship-type-dd").each(function(g, h) {
                var f = $(h);
                if (f.val() > 0) {
                    e.push({
                        eeId: f.val(),
                        name: f.find("option:selected").text()
                    })
                }
            });
            return e
        },
        setUserMappingValue: function(h, e) {
            var i = this,
                f = _.filter(i.userMappings, function(j) {
                    return j.id === h
                }),
                g = [];
            if (f.length > 0) {
                f[0].mappings.push(e)
            } else {
                g.push(e);
                i.userMappings.push({
                    id: h,
                    mappings: g
                })
            }
        },
        getRelationshipType: function(e) {
            var f = this;
            return _.filter(f.RelationshipTypes, function(g) {
                return e === g.RelationshipId
            })
        }
    });
    b.Vs.ReviewMatch = Bb.View.extend({
        template: "connectee/review.template.html",
        events: {
            "click #unlink-button": "unlinkClick",
            "click #unlink-confirm-button": "confirmClick"
        },
        renderTemplate: function() {
            var o = this,
                l, e, f, g, n = o.WHUser.toJSON(),
                h, m;
            if (o.WHUser.length > 0) {
                l = o.WHUser.models[0].get("linked_date")
            }
            p3.fT(o.template, function(i) {
                o.$el.html(i({
                    linkDate: l,
                    repoId: o.options.repoId
                }))
            });
            o.Containers.whUsers = "#wh-user-container";
            o.Containers.eeUsers = "#ee-user-container";
            e = new b.Ms.EEUser();
            e.fetch({
                data: {
                    eeId: o.options.eeId,
                    accessToken: b.Data.AuthToken
                },
                success: function(r, s) {
                    var t = JSON.parse(s.ResponseString),
                        k, q = s.Mappings,
                        u = [],
                        i, p, v, j = "No";
                    if (t.people && t.people.length > 0) {
                        k = t.people[0].bio;
                        i = t.people[0].contact_info;
                        if (i) {
                            for (f = 0; f < i.length; f++) {
                                v = "";
                                for (g = 0; g < q.length; g++) {
                                    if (q[g].EEFieldId === i[f].type_id) {
                                        p = q[g];
                                        break
                                    }
                                }
                                if (p) {
                                    switch (p.WHFieldId) {
                                        case -1:
                                            v = o.WHUser.models[0].get("email");
                                            break;
                                        case -2:
                                            v = o.WHUser.models[0].get("cc_email");
                                            break;
                                        default:
                                            for (h = 0; h < n.length; h++) {
                                                if (n[h].phone_type_id === p.WHFieldId) {
                                                    v = n[h].phone_number;
                                                    break
                                                }
                                            }
                                            break
                                    }
                                    if (p.UserTypeId === 0 || v === i[f].value) {
                                        u.push({
                                            EEDescription: p.EEDescription,
                                            WHDescription: p.WHDescription,
                                            EEValue: i[f].value,
                                            WHValue: v
                                        })
                                    }
                                }
                            }
                        }
                    }
                    switch (k.record_type) {
                        case 1:
                            m = "Parent";
                            break;
                        case 6:
                        case 2:
                            m = "Student";
                            break;
                        case 8:
                            m = "Faculty";
                            break
                    }
                    u.push({
                        EEDescription: "Role",
                        WHDescription: "Role",
                        EEValue: m,
                        WHValue: o.WHUser.models[0].get("roles")
                    });
                    if (k.deceased || o.WHUser.models[0].get("deceased")) {
                        if (k.deceased) {
                            j = "Yes"
                        }
                        if (o.WHUser.models[0].get("deceased")) {
                            v = "Yes"
                        } else {
                            v = "No"
                        }
                        u.push({
                            EEDescription: "Deceased",
                            EEValue: j,
                            WHDescription: "Deceased",
                            WHValue: v
                        })
                    }
                    o.renderWHUser(u);
                    o.renderEEUser(k, u)
                },
                error: function(i, j) {
                    p3.displayError("Error loading EE User.")
                }
            })
        },
        initialize: function() {
            this.Containers = {}
        },
        render: function(e) {
            var f = this;
            $(e).append(this.el);
            f.WHUser = new b.Cs.EEWHUser();
            f.WHUser.fetch({
                data: {
                    userId: f.options.userId
                },
                success: function() {
                    f.renderTemplate()
                },
                error: function(g, h) {
                    p3.displayError("Error loading WH User.")
                }
            })
        },
        renderEEUser: function(e, i) {
            var j = this,
                g, h, f;
            if (!e.birth_date || e.birth_date === "0001-01-01T00:00:00") {
                e.birth_date = ""
            } else {
                g = e.birth_date.split("T");
                h = g[0].split("-");
                e.birth_date = c.buildDateString(h[0], h[1] - 1, h[2])
            }
            f = new b.Vs.EEUserDetail({
                eeUser: e,
                eeId: j.options.eeId,
                userContacts: i
            });
            p3.rV(f, j.Containers.eeUsers, true)
        },
        renderWHUser: function(e) {
            var f = this,
                g;
            if (f.WHUser.models[0].get("birth_date")) {
                f.WHUser.models[0].set("birth_date", c.getDateString(c.getDate(f.WHUser.models[0].get("birth_date"))))
            }
            g = new b.Vs.WHUserDetail({
                whUser: f.WHUser.models[0],
                userContacts: e
            });
            p3.rV(g, f.Containers.whUsers, true)
        },
        unlinkClick: function(f) {
            $("#unlink-button").hide();
            $("#unlink-confirm").show();
            $("#unlink-confirm-button").show();
            p3.setModalHeight(p3.Layout.Containers.Modal)
        },
        confirmClick: function(f) {
            var h = this,
                g;
            g = new b.Ms.UnlinkUser({
                repositoryId: h.options.repoId
            });
            g.save({}, {
                success: function(e, i) {
                    h.trigger("userUnlinked", e);
                    p3.Layout.Containers.Modal.modal("hide")
                },
                error: function(e, i) {
                    p3.displayError("Error unlinking user.")
                }
            })
        }
    });
    b.Vs.linkUsers = Bb.View.extend({
        template: "connectee/link.user.template.html",
        events: {
            "click .match-selector": "showPotentialMatch",
            "click #link-account-button": "linkClick",
            "click #create-new-link": "createNewClick",
            "click #link-confirm-button": "linkRecords",
            "click #create-confirm-button": "createRecord"
        },
        renderTemplate: function() {
            var k = this,
                e, f, g, h;
            p3.fT(k.template, function(i) {
                k.$el.html(i({
                    matchCount: k.dropdownList.length,
                    matches: k.dropdownList
                }))
            });
            k.Containers.whUsers = "#wh-user-container";
            k.Containers.eeUsers = "#ee-user-container";
            e = new b.Ms.EEUser();
            e.fetch({
                data: {
                    eeId: k.options.eeId,
                    accessToken: b.Data.AuthToken
                },
                success: function(j, l) {
                    var m = JSON.parse(l.ResponseString),
                        i, n = [];
                    k.mappings = l.Mappings;
                    if (m.people && m.people.length > 0) {
                        i = m.people[0].bio;
                        k.contactInfo = m.people[0].contact_info;
                        if (k.contactInfo) {
                            for (f = 0; f < k.contactInfo.length; f++) {
                                for (g = 0; g < k.mappings.length; g++) {
                                    if (k.mappings[g].EEFieldId === k.contactInfo[f].type_id) {
                                        n.push({
                                            EEDescription: k.mappings[g].EEDescription,
                                            EEValue: k.contactInfo[f].value
                                        });
                                        break
                                    }
                                }
                            }
                        }
                    }
                    switch (i.record_type) {
                        case 1:
                            h = "Parent";
                            break;
                        case 6:
                            h = "Student";
                            break;
                        case 8:
                            h = "Faculty";
                            break
                    }
                    n.push({
                        EEDescription: "Role",
                        EEValue: h
                    });
                    k.renderEEUser(i, n)
                },
                error: function(i, j) {
                    p3.displayError("Error loading EE User.")
                }
            })
        },
        initialize: function() {
            this.Containers = {}
        },
        render: function(e) {
            var f = this;
            $(e).append(this.el);
            f.Matches = new b.Cs.PossibleMatches();
            f.Matches.fetch({
                data: {
                    objectDataId: f.options.objectId
                },
                success: function() {
                    f.dropdownList = [];
                    var h = 0,
                        g;
                    f.Matches.each(function(i) {
                        if (i.get("user_id") !== h) {
                            h = i.get("user_id");
                            g = "";
                            if (i.get("prefix") && i.get("prefix").length > 0) {
                                g = i.get("prefix") + " "
                            }
                            g += i.get("firstname");
                            if (i.get("middlename") && i.get("middlename").length > 0) {
                                g += " " + i.get("middlename")
                            }
                            g += " " + i.get("lastname");
                            if (i.get("suffix") && i.get("suffix").length > 0) {
                                g += " " + i.get("suffix")
                            }
                            f.dropdownList.push({
                                id: h,
                                name: g,
                                last: i.get("lastname")
                            })
                        }
                    });
                    f.renderTemplate()
                },
                error: function(g, h) {
                    p3.displayError("Error loading possible matches.")
                }
            })
        },
        renderEEUser: function(e, i) {
            var j = this,
                g, h, f;
            if (e.birth_date === "0001-01-01T00:00:00") {
                e.birth_date = ""
            } else {
                g = e.birth_date.split("T");
                h = g[0].split("-");
                e.birth_date = c.buildDateString(h[0], h[1] - 1, h[2])
            }
            f = new b.Vs.EEUserDetail({
                eeUser: e,
                eeId: j.options.eeId,
                userContacts: i
            });
            p3.rV(f, j.Containers.eeUsers, true)
        },
        renderWHUser: function() {
            var o = this,
                m, n = [],
                h, p, e, f, q, l = o.Matches.toJSON(),
                g;
            o.Matches.each(function(i) {
                if (!m && i.get("user_id") === o.selectedUser) {
                    m = i
                }
            });
            if (o.contactInfo) {
                for (e = 0; e < o.contactInfo.length; e++) {
                    p = "";
                    for (f = 0; f < o.mappings.length; f++) {
                        if (o.mappings[f].EEFieldId === o.contactInfo[e].type_id) {
                            h = o.mappings[f];
                            break
                        }
                    }
                    if (h) {
                        switch (h.WHFieldId) {
                            case -1:
                                p = m.get("email");
                                break;
                            case -2:
                                p = m.get("cc_email");
                                break;
                            default:
                                for (g = 0; g < l.length; g++) {
                                    if (l[g].user_id === o.selectedUser && l[g].phone_type_id === h.WHFieldId) {
                                        p = l[g].phone_number;
                                        break
                                    }
                                }
                                break
                        }
                        n.push({
                            EEDescription: h.EEDescription,
                            WHDescription: h.WHDescription,
                            EEValue: o.contactInfo[e].value,
                            WHValue: p
                        })
                    }
                }
            }
            if (m.get("roles") && m.get("roles").length > 0) {
                n.push({
                    WHDescription: "Role",
                    WHValue: m.get("roles")
                })
            } else {
                n.push({
                    WHDescription: "Role",
                    WHValue: ""
                })
            }
            if (m.get("birth_date")) {
                m.set("birth_date", c.getDateString(c.getDate(m.get("birth_date"))))
            }
            q = new b.Vs.WHUserDetail({
                whUser: m,
                userContacts: n,
                noHeader: true
            });
            p3.rV(q, o.Containers.whUsers, true)
        },
        showPotentialMatch: function(g) {
            var h = this,
                f = $(g.currentTarget);
            $("#selected-user-name").replaceWith('<h2 style="line-height:26px;text-align:left;" id="selected-user-name">' + f.html() + "</h3>");
            $("#match-count").hide();
            $("#or-header").addClass("pull-left").css("text-align", "left").css("margin", "5px 10px 0px 10px").show();
            $("#create-new-link").css("margin", "5px 0px 0px 0px").css("width", "").removeClass("btn-large").show();
            $("#create-new-label").replaceWith($('<h5><i class="p3icon-addNew"></i> Create A New User Record</h5>'));
            $("#link-account-button").show();
            $("#link-confirm").hide();
            $("#link-confirm-button").hide();
            h.selectedUser = f.data("id");
            h.renderWHUser();
            p3.setModalHeight(p3.Layout.Containers.Modal);
            g.preventDefault()
        },
        linkClick: function(f) {
            $("#link-confirm").show();
            $("#link-confirm-button").show();
            $("#link-account-button").hide();
            $("#or-header").hide();
            $("#create-new-link").hide();
            p3.setModalHeight(p3.Layout.Containers.Modal)
        },
        createNewClick: function(f) {
            $("#create-confirm").show();
            $("#create-confirm-button").show();
            $("#link-account-button").hide();
            $("#or-header").hide();
            $("#create-new-link").hide();
            $("#wh-user-container").hide();
            $("#match-group").hide();
            $("#match-count").hide();
            p3.setModalHeight(p3.Layout.Containers.Modal)
        },
        linkRecords: function(f) {
            var h = this,
                g;
            g = new b.Ms.LinkUsers({
                eeId: h.options.eeId,
                userId: h.selectedUser
            });
            g.save({}, {
                success: function(e, i) {
                    h.trigger("userLinked", e);
                    p3.Layout.Containers.Modal.modal("hide")
                },
                error: function(e, i) {
                    p3.displayError("Error linking user.")
                }
            })
        },
        createRecord: function(f) {
            var i = this,
                h = [],
                g;
            h.push(i.options.objectId);
            g = new b.Ms.CreateUsers({
                CreateUserList: h
            });
            g.save({}, {
                success: function(e, j) {
                    i.trigger("userCreated", e);
                    p3.Layout.Containers.Modal.modal("hide")
                },
                error: function(e, j) {
                    p3.displayError("Error creating user.")
                }
            })
        }
    });
    b.Vs.EEUserDetail = Bb.View.extend({
        template: "connectee/ee.user.detail.template.html",
        renderTemplate: function() {
            var e = this;
            p3.fT(e.template, function(f) {
                e.$el.html(f({
                    eeUser: e.options.eeUser,
                    eeId: e.options.eeId,
                    userContacts: e.options.userContacts
                }))
            });
            window.setTimeout(function() {
                p3.setModalHeight(p3.Layout.Containers.Modal)
            }, 100)
        },
        render: function(e) {
            var f = this;
            $(e).append(this.el);
            f.renderTemplate()
        }
    });
    b.Vs.WHUserDetail = Bb.View.extend({
        template: "connectee/wh.user.detail.template.html",
        renderTemplate: function() {
            var e = this;
            p3.fT(e.template, function(f) {
                e.$el.html(f({
                    whUser: e.options.whUser.toJSON(),
                    schoolId: p3.Data.SchoolContext.get("SchoolInfo").SchoolId,
                    userContacts: e.options.userContacts,
                    noHeader: e.options.noHeader
                }))
            })
        },
        render: function(e) {
            var f = this;
            $(e).append(this.el);
            f.renderTemplate()
        }
    });
    b.Us.GetAccessToken = function() {
        var e = new b.Ms.GetAccessToken();
        e.save({}, {
            success: function(f, g) {
                var h = JSON.parse(g.ResponseString);
                if (h && h.token && h.token.length > 0) {
                    b.Data.AuthToken = h.token;
                    $("#edit-settings-button").show()
                } else {
                    p3.displayError("Error getting Connect EE Authorization Token");
                    $("#auth-settings-button").show()
                }
            },
            error: function(f, g) {
                p3.displayError("Error getting Connect EE Authorization Token");
                $("#auth-settings-button").show()
            }
        })
    };
    p3.router().route("ConnectEESettings", "ConnectEESettings", function() {
        p3.setTitle("Connect Education Edge Settings");
        p3.renderMainPage(new b.Vs.SettingsMain())
    })
}(p3.module("LMS/connectee")));
(function(d) {
    var f = p3.module("lists"),
        b = p3.Us.Culture,
        e = p3.module("shared/datepicker"),
        c = p3.module("shared/dashboard"),
        h = p3.module("LMS/teampage"),
        a = p3.module("LMS/athleticschedule"),
        g = p3.module("lms/scoreboard");
    d.Ms.AssignmentChart = Bbm.extend({
        url: function() {
            return ""
        }
    });
    d.Cs.AssignmentChart = Bbc.extend({
        model: d.Ms.AssignmentChart,
        initialize: function(i, j) {
            this.groupBy = j.groupBy || 0;
            this.numberOfItems = j.numberOfItems || 8
        },
        url: function() {
            return aP + "datadirect/assignmentchartget/?format=json&groupBy=" + this.groupBy + "&numberOfItems=" + this.numberOfItems
        }
    });
    d.Ms.DashboardCounts = Bbm.extend({
        url: function() {
            return aP + "datadirect/DashboardCountsGet/?format=json&lookupDate=" + this.get("lookupDate").ApiFormat()
        }
    });
    d.Ms.AthleticsDashboardCounts = Bbm.extend({
        url: function() {
            return aP + "datadirect/DashboardAthCountsGet/?format=json&lookupDate=" + this.get("lookupDate").ApiFormat()
        }
    });
    d.Cs.AthleticsByDay = Bbc.extend({
        initialize: function(i, j) {
            this.lookupDate = j.lookupDate
        },
        url: function() {
            return aP + "datadirect/DashboardAthEventsGet/?format=json&lookupDate=" + this.lookupDate.ApiFormat()
        }
    });
    d.Cs.AthleticScoreboard = Bbc.extend({
        initialize: function(i, j) {
            this.lookupDate = j.lookupDate
        },
        url: function() {
            return aP + "datadirect/DashboardScoreboardGet/?format=json&lookupDate=" + this.lookupDate.ApiFormat()
        }
    });
    d.Cs.AthleticScorelist = Bbc.extend({
        initialize: function(i, j) {
            this.lookupDate = j.lookupDate
        },
        url: function() {
            return aP + "datadirect/DashboardScoreboardGet/?format=json&lookupDate=" + this.lookupDate.ApiFormat()
        },
        parse: function(j) {
            var i = [];
            _.each(j, function(k) {
                var l, m = _.find(i, function(n) {
                    return n.ath_schedule_id === k.ath_schedule_id
                });
                if (m === undefined) {
                    m = k;
                    i.push(m);
                    m.display_date = k.schedule_date;
                    if (k.news_id || k.result || k.score) {
                        m.edit = true
                    }
                }
                l = m.opponents;
                if (l === undefined || l === null) {
                    l = [];
                    m.opponents = l
                }
                l.push({
                    name: k.name,
                    result: k.result,
                    score: k.score,
                    score_vs: k.score_vs
                })
            });
            return i
        },
        comparator: "course_title"
    });
    d.Cs.AthleticLocationByDay = Bbc.extend({
        initialize: function(i, j) {
            this.lookupDate = j.lookupDate
        },
        url: function() {
            return aP + "datadirect/DashboardLocationGet/?format=json&lookupDate=" + this.lookupDate.ApiFormat()
        }
    });
    d.Cs.AthleticTransByDay = Bbc.extend({
        initialize: function(i, j) {
            this.lookupDate = j.lookupDate
        },
        url: function() {
            return aP + "datadirect/DashboardTransportationGet/?format=json&lookupDate=" + this.lookupDate.ApiFormat()
        }
    });
    d.Vs.LayoutView = Bb.View.extend({
        template: "dashboard/dashboard.oncampus.layout.template.html",
        initialize: function() {
            f.loadLists()
        },
        dispose: function() {
            $("BODY").removeClass("background-gray-texture")
        },
        render: function(l) {
            var m = this,
                i, j, k;
            $("BODY").addClass("background-gray-texture");
            p3.setTitle("Dashboard");
            p3.fT(m.template, function(o) {
                m.$el.html(o());
                i = m.$el.find("#page-2col-wideleft");
                j = m.$el.find("#page-2col-slimright");
                k = new d.Cs.AssignmentChart({}, {});
                k.fetch({
                    success: function() {
                        if (p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.COURSEMANAGEMENT)) {
                            p3.rV(new d.Vs.AssignmentChart({
                                collection: k
                            }), i, false)
                        } else {
                            i.html("&nbsp;")
                        }
                    },
                    error: function() {
                        p3.displayError("Error assignment chart data")
                    }
                });
                p3.rV(new c.Vs.FeatureSet({
                    persona: 5
                }), j, false);
                if (p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.ATHLETICGROUPS)) {
                    var n = new d.Vs.DashboardCounts();
                    p3.rV(n, p3.Layout.Containers.MainPage, false)
                }
            });
            $(l).html(this.el)
        }
    });
    d.Vs.DashboardCounts = Bb.View.extend({
        template: "dashboard/dashboard.oncampus.count.template.html",
        className: "wContainer noshadow",
        attributes: {
            style: "margin-top:-32px; margin-bottom:25px; padding:0px;"
        },
        initialize: function() {
            var j = this,
                i = new d.Ms.DashboardCounts({
                    lookupDate: b.getDateString(b.localDateTime())
                });
            j.countModel = i
        },
        render: function(i) {
            i.before(this.el);
            this.renderTemplate()
        },
        renderTemplate: function() {
            var k = this,
                j, i;
            k.countModel.fetch({
                success: function() {
                    j = false;
                    i = p3.Data.Context.findByTaskId(53100);
                    if (i) {
                        j = true
                    }
                    p3.fT(k.template, function(l) {
                        k.$el.html(l({
                            counts: k.countModel.attributes[0],
                            showAthletics: j
                        }))
                    })
                },
                error: function() {
                    p3.displayError("Error loading dashboard counts")
                }
            })
        }
    });
    d.Vs.AssignmentChart = Bb.View.extend({
        template: "shared/shared.chart.template.html",
        events: {},
        initialize: function(i) {
            var j = this;
            i.chart = function(k) {
                j.options.collection.fetch({
                    data: {
                        numberOfItems: 6
                    },
                    success: function(l) {
                        d3.select("#chart-container svg").datum(j.newChartData(l)).transition().duration(500).call(k)
                    }
                })
            }
        },
        render: function(i) {
            var j = this;
            j.$el.appendTo(i);
            p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.Chart, function() {
                nv.addGraph(function() {
                    var k = nv.models.multiBarChart().x(function(l, m) {
                        return l.label
                    }).y(function(l) {
                        return l.value
                    }).showControls(true);
                    k.xAxis.tickFormat(function(l) {
                        return l
                    });
                    k.yAxis.tickFormat(function(l) {
                        return l
                    });
                    j.options.chart(k);
                    return k
                });
                j.renderTemplate()
            })
        },
        renderTemplate: function() {
            var i = this;
            p3.fT(i.template, function(j) {
                i.$el.html(j({
                    title: "Assignment Activity",
                    height: 400
                }))
            })
        },
        newChartData: function(j) {
            var m = this,
                i, l, k;
            m.newChartData = [];
            m.newTicks = [];
            i = _.groupBy(j.models, function(n) {
                return n.get("DataLabel1")
            });
            l = _.groupBy(j.models, function(n) {
                return n.get("DataLabel2")
            });
            _.each(i, function(n) {
                k = [];
                _.each(n, function(p, o) {
                    k.push({
                        label: p.get("AxisLabel"),
                        value: p.get("DataValue1")
                    })
                });
                m.newChartData.push({
                    key: n[0].get("DataLabel1"),
                    values: k
                })
            });
            _.each(l, function(n) {
                k = [];
                _.each(n, function(p, o) {
                    k.push({
                        label: p.get("AxisLabel"),
                        value: p.get("DataValue2")
                    })
                });
                m.newChartData.push({
                    key: n[0].get("DataLabel2"),
                    values: k
                })
            });
            return m.newChartData
        }
    });
    d.Vs.AthleticDashboardCounts = Bb.View.extend({
        template: "dashboard/dashboard.athletics.tiles.template.html",
        events: {
            "click .aem-action-btn": "buttonClicked"
        },
        renderTemplate: function() {
            var i = this;
            i.countModel.fetch({
                success: function() {
                    var j = i.options.currentDate,
                        l = j.getMonth() + 1,
                        k = l + "-" + j.getDate() + "-" + j.getFullYear(),
                        m = i.options.parentView.listType;
                    p3.fT(i.template, function(n) {
                        i.$el.html(n({
                            counts: i.countModel.attributes[0],
                            currentDate: k,
                            event: m == 0,
                            location: m == 1,
                            trans: m == 2,
                            scoreboard: m == 3,
                            scorelist: m == 4
                        }))
                    });
                    i.delegateEvents()
                },
                error: function() {
                    p3.displayError("Error loading dashboard counts")
                }
            })
        },
        initialize: function() {
            var j = this,
                i = new d.Ms.AthleticsDashboardCounts({
                    lookupDate: b.getDateString(j.options.currentDate)
                });
            j.countModel = i
        },
        render: function(i) {
            $(i).append(this.el);
            this.renderTemplate()
        },
        changeListType: function(j) {
            var k = this,
                i = $(j.currentTarget);
            k.options.parentView.listType = i.data("type");
            k.options.parentView.refreshList();
            $(".btn-gray").removeClass("active");
            i.addClass("active")
        },
        buttonClicked: function(i) {
            var j = $(i.currentTarget).data("link");
            if (j && j.indexOf("#") === 0) {
                p3.router().navigate(j, true)
            }
            i.stopPropagation()
        }
    });
    d.Vs.AthleticsDashboardView = Bb.View.extend({
        template: "dashboard/dashboard.athletics.template.html",
        events: {},
        initialize: function() {
            var i = this;
            i.currentDate = i.options.currentDate;
            i.listType = i.options.listType;
            i.athleticPrivileges = a.Us.getAthleticPrivileges(true, false, false)
        },
        render: function(i) {
            p3.setTitle("Dashboard");
            var j = this;
            p3.fT(j.template, function(o) {
                j.$el.html(o({
                    displayDate: b.getDateString(j.currentDate),
                    athleticPrivileges: j.athleticPrivileges
                }));
                var k = j.$el.find("#athletic-tiles"),
                    l = j.$el.find("#list-container"),
                    m, n;
                switch (j.listType) {
                    case d.Us.DashboardType.Event:
                        m = new d.Vs.AthleticList({
                            parentView: j,
                            currentDate: j.currentDate
                        });
                        p3.rV(m, l, true);
                        break;
                    case d.Us.DashboardType.Scoreboard:
                        m = new d.Vs.Scoreboard({
                            parentView: j,
                            currentDate: j.currentDate
                        });
                        p3.rV(m, l, true);
                        break;
                    case d.Us.DashboardType.Location:
                        m = new d.Vs.AthleticLocation({
                            parentView: j,
                            currentDate: j.currentDate
                        });
                        p3.rV(m, l, true);
                        break;
                    case d.Us.DashboardType.Transportation:
                        m = new d.Vs.AthleticTransportation({
                            parentView: j,
                            currentDate: j.currentDate
                        });
                        p3.rV(m, l, true);
                        break;
                    case d.Us.DashboardType.Scorelist:
                        m = new d.Vs.ScoreList({
                            parentView: j,
                            currentDate: j.currentDate
                        });
                        p3.rV(m, l, true);
                        break
                }
                n = new d.Vs.AthleticDashboardCounts({
                    parentView: j,
                    currentDate: j.currentDate
                });
                p3.rV(n, k, true);
                window.setTimeout(function() {
                    $("#site-main").removeClass("container");
                    $("body").addClass("containerBack");
                    e.Us.initialize("#datedropdown", {
                        showOn: "button",
                        buttonText: 'Date Picker <i class="p3icon-downArrow"></i>',
                        onClose: function(p) {
                            j.switchDate(p)
                        },
                        beforeShow: function() {
                            setTimeout(function() {
                                $(".ui-datepicker").css("z-index", 2)
                            }, 0)
                        }
                    });
                    window.setTimeout(function() {
                        $(".ui-datepicker-trigger").addClass("btn btn-default pull-right").css("color", "#9f9f9f")
                    }, 200);
                    $("#add-game-button").bind("click", function(p) {
                        j.showAddGameDialog(p)
                    });
                    $("#bulk-practice-button").bind("click", function(p) {
                        j.showBulkPracticeDialog(p)
                    })
                }, 100)
            });
            $(i).html(this.el)
        },
        showBulkPracticeDialog: function() {
            var i = this;
            a.Data.EditableTeams = new a.Cs.EditableTeams({}, {
                lookupDate: i.options.currentDate
            });
            a.Data.EditableTeams.fetch({
                async: false,
                error: function() {
                    p3.displayError("Error loading teams")
                }
            });
            p3.rV(new a.Vs.BulkAddPracticeView({
                sectionId: 0,
                showTeamPicker: true,
                dashboardView: i
            }), p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            return false
        },
        showAddGameDialog: function() {
            var j = this,
                i;
            a.Data.EditableTeams = new a.Cs.EditableTeams({}, {
                lookupDate: j.options.currentDate
            });
            a.Data.EditableTeams.fetch({
                async: false,
                error: function() {
                    p3.displayError("Error loading teams")
                }
            });
            if (j.athleticPrivileges.canAddGame) {
                i = new a.Ms.ScheduleItem({
                    ScheduleType: 0,
                    HomeAwayType: 0,
                    LocationId: -1,
                    LeagueInd: 1,
                    Gamedate: b.getDateString(j.options.currentDate)
                });
                a.Us.openGameScheduleDialog(0, i, 0, false, j, true, j.athleticPrivileges.isLite, j.athleticPrivileges)
            } else {
                i = new a.Ms.ScheduleItem({
                    PracticeDate: b.getDateString(j.options.currentDate)
                });
                a.Us.openEditPracticeDialog(0, i, 0, false, j, true, j.athleticPrivileges)
            }
        },
        dispose: function() {
            $("#site-main").addClass("container");
            $("body").removeClass("containerBack")
        },
        switchDate: function(k) {
            var m = this,
                l, i, j;
            if (k.length && b.getDateString(b.getDate(k)) != b.getDateString(m.currentDate)) {
                l = "";
                switch (m.listType) {
                    case d.Us.DashboardType.Event:
                        l = "Events/";
                        break;
                    case d.Us.DashboardType.Location:
                        l = "Locations/";
                        break;
                    case d.Us.DashboardType.Transportation:
                        l = "Transportation/";
                        break;
                    case d.Us.DashboardType.Scoreboard:
                        l = "Scoreboard/";
                        break;
                    case d.Us.DashboardType.Scorelist:
                        l = "Scorelist/";
                        break
                }
                i = b.getDate(k);
                j = i.getMonth() + 1;
                p3.router().navigate("#AthleticsDashboard/" + l + j + "-" + i.getDate() + "-" + i.getFullYear(), true)
            }
        },
        refreshDashboard: function() {
            var j = this,
                i;
            j.refreshList();
            i = new d.Vs.AthleticDashboardCounts({
                parentView: j,
                currentDate: j.currentDate
            });
            p3.rV(i, "#athletic-tiles", true)
        },
        refreshList: function() {
            var j = this,
                i;
            switch (j.listType) {
                case d.Us.DashboardType.Event:
                    i = new d.Vs.AthleticList({
                        parentView: j,
                        currentDate: j.currentDate
                    });
                    p3.rV(i, "#list-container", true);
                    break;
                case d.Us.DashboardType.Scoreboard:
                    i = new d.Vs.Scoreboard({
                        parentView: j,
                        currentDate: j.currentDate
                    });
                    p3.rV(i, "#list-container", true);
                    break;
                case d.Us.DashboardType.Location:
                    i = new d.Vs.AthleticLocation({
                        parentView: j,
                        currentDate: j.currentDate
                    });
                    p3.rV(i, "#list-container", true);
                    break;
                case d.Us.DashboardType.Transportation:
                    i = new d.Vs.AthleticTransportation({
                        parentView: j,
                        currentDate: j.currentDate
                    });
                    p3.rV(i, "#list-container", true);
                    break;
                case d.Us.DashboardType.Scorelist:
                    i = new d.Vs.ScoreList({
                        parentView: j,
                        currentDate: j.currentDate
                    });
                    p3.rV(i, "#list-container", true);
                    break
            }
        }
    });
    d.Vs.AthleticList = Bb.View.extend({
        template: "dashboard/dashboard.athletics.list.template.html",
        events: {},
        initialize: function() {
            var i = this;
            i.parentView = i.options.parentView;
            i.collection = new d.Cs.AthleticsByDay({}, {
                lookupDate: b.getDateString(i.options.currentDate)
            });
            a.Us.initializeData(true);
            i.athleticPrivileges = a.Us.getAthleticPrivileges(true, false, false)
        },
        render: function(i) {
            $(i).append(this.el);
            this.renderTemplate()
        },
        renderTemplate: function() {
            var i = this;
            i.collection.fetch({
                success: function() {
                    var j = -1,
                        k = "",
                        l = "";
                    i.collection.each(function(n) {
                        j += 1;
                        n.set("index", j);
                        if (n.get("StartTime") != k) {
                            k = n.get("StartTime");
                            n.set("newTime", true)
                        }
                        var m = b.getTimeString(b.getDate(b.getDateString(b.localDateTime()) + " " + n.get("StartTime")));
                        n.set("StartTime", (b.isMidnight(m) ? "TBA" : m));
                        l = n.get("Opponents");
                        if (l != null) {
                            switch (n.get("HomeAway")) {
                                case "Home":
                                    n.set("opponentDisplay", "<strong>vs</strong> " + l);
                                    break;
                                case "Away":
                                    n.set("opponentDisplay", "<strong>@</strong> " + l);
                                    break
                            }
                        }
                    });
                    p3.fT(i.template, function(m) {
                        i.$el.html(m({
                            events: i.collection.toJSON()
                        }));
                        $("button.btn.delete").bind("click", function(n) {
                            i.showDeleteDialog(n)
                        });
                        $("button.btn.edit").bind("click", function(n) {
                            i.showEditDialog(n)
                        });
                        $(".detail-link").bind("click", function(n) {
                            i.showDetails(n)
                        })
                    })
                },
                error: function() {
                    p3.displayError("Error loading dashboard counts")
                }
            })
        },
        showDeleteDialog: function(j) {
            var m = this,
                i = $(j.currentTarget),
                k = i.data("id"),
                l = i.data("team-id");
            if (i.data("type") == 0) {
                p3.showConfirm(null, "Warning: Once you hit confirm there is no undo button. Are you really sure you want to delete this forever?", null, function() {
                    var n = new a.Ms.GameDelete({
                        ScheduleId: k
                    });
                    n.destroy({
                        error: function() {
                            p3.displayError("Error deleting game")
                        },
                        success: function() {
                            m.parentView.refreshDashboard()
                        }
                    })
                })
            } else {
                p3.showConfirm(null, "Warning: Once you hit confirm there is no undo button. Are you really sure you want to delete this forever?", null, function() {
                    var n = new a.Ms.PracticeDelete({
                        PracticeId: k,
                        TeamId: l
                    });
                    n.destroy({
                        error: function() {
                            p3.displayError("Error deleting practice")
                        },
                        success: function() {
                            m.parentView.refreshDashboard()
                        }
                    })
                })
            }
            return false
        },
        showEditDialog: function(j) {
            var n = this,
                i = $(j.currentTarget),
                l = i.data("id"),
                m = i.data("team-id"),
                k;
            a.Us.initializeNotifications(m, true);
            if (i.data("type") == 0) {
                k = a.Us.getGameDetails(l);
                a.Us.openGameScheduleDialog(l, k, m, false, n.parentView, false, n.athleticPrivileges.isLite, n.athleticPrivileges)
            } else {
                k = a.Us.getPracticeItem(l, m);
                a.Us.openEditPracticeDialog(l, k, m, false, n.parentView, false, n.athleticPrivileges)
            }
            return false
        },
        showDetails: function(j) {
            var i = $(j.currentTarget);
            d.Us.showDetails(i.data("id"), i.data("type"));
            j.preventDefault()
        }
    });
    d.Vs.Scoreboard = Bb.View.extend({
        template: "dashboard/dashboard.athletics.scoreboard.template.html",
        events: {},
        renderTemplate: function() {
            var j = this,
                i = new g.Ms.Settings();
            j.defaultLogo = "";
            i.fetch({
                async: false,
                error: function() {
                    p3.displayError("Error getting settings");
                    j.renderTemplate2()
                },
                success: function() {
                    if (i.get("LogoId") > 0) {
                        j.defaultLogo = i.get("Filename")
                    }
                    j.renderTemplate2()
                }
            })
        },
        renderTemplate2: function() {
            var i = this;
            i.collection.fetch({
                success: function() {
                    var j = 0,
                        k;
                    i.collection.each(function(m, l) {
                        m.set("startIndex", l);
                        if (m.get("ath_schedule_id") != j) {
                            j = m.get("ath_schedule_id");
                            k = [];
                            m.set("opponents", k);
                            m.set("haveOpponent", (m.get("sort_order") != null))
                        } else {
                            m.set("hide", true)
                        }
                        k.push({
                            name: m.get("name"),
                            result: m.get("result"),
                            score: m.get("score"),
                            score_vs: m.get("score_vs")
                        });
                        var n = b.getDateString(b.getDate(m.get("schedule_date")));
                        m.set("display_date", b.displayDate(n, "longDate"));
                        if (m.get("news_id") || m.get("result") || m.get("score")) {
                            m.set("edit", true)
                        }
                    });
                    p3.fT(i.template, function(l) {
                        i.$el.html(l({
                            events: i.collection.toJSON(),
                            schoolId: p3.Data.SchoolContext.get("SchoolInfo").SchoolId,
                            schoolName: p3.Data.SchoolContext.get("SchoolInfo").SchoolName,
                            DefaultLogo: i.defaultLogo
                        }));
                        $(".btn-add").bind("click", function(m) {
                            i.showAddDialog(m)
                        });
                        $(".btn-edit").bind("click", function(m) {
                            i.showEditDialog(m)
                        })
                    });
                    p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.Isotope, function() {
                        window.setTimeout(function() {
                            $(".scoreboard-container").isotope({
                                itemSelector: ".score-container"
                            })
                        }, 200)
                    })
                },
                error: function() {
                    p3.displayError("Error loading dashboard counts")
                }
            })
        },
        initialize: function() {
            var i = this;
            i.parentView = i.options.parentView;
            i.collection = new d.Cs.AthleticScoreboard({}, {
                lookupDate: b.getDateString(i.options.currentDate)
            });
            a.Us.initializeData(true)
        },
        render: function(i) {
            $(i).append(this.el);
            this.renderTemplate()
        },
        showAddDialog: function(i) {
            var j = this;
            j.showResultDialog(false, i);
            return false
        },
        showEditDialog: function(i) {
            var j = this;
            j.showResultDialog(true, i);
            return false
        },
        showResultDialog: function(j, k) {
            var m = this,
                i = $(k.currentTarget),
                l = i.data("sectionid");
            m.options.sections = new h.Cs.Sections({}, {
                sectionId: l
            });
            m.options.sections.models[0].set({
                GroupName: i.data("team"),
                IsSelected: 1,
                SectionId: l,
                LeadSectionId: l,
                ContextLabelId: 3,
                AssociationId: 2,
                Association: "Athletics",
                Primary: true
            });
            p3.rV(new h.Vs.EditResultsView({
                gameId: i.data("id"),
                existingData: j,
                parentView: m,
                newsId: i.data("newsid"),
                siteInd: i.data("siteind")
            }), p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal)
        }
    });
    d.Vs.ScoreList = Bb.View.extend({
        template: "dashboard/dashboard.athletics.scorelist.template.html",
        events: {
            "click .btn-add": "showAddDialog",
            "click .btn-edit": "showEditDialog"
        },
        initialize: function() {
            var i = this;
            i.parentView = i.options.parentView;
            i.collection = new d.Cs.AthleticScorelist({}, {
                lookupDate: b.getDateString(i.options.currentDate)
            });
            a.Us.initializeData(true);
            i.collection.on("reset", i.renderItems, i)
        },
        dispose: function() {
            var i = this;
            i.collection.off("reset", i.renderItems)
        },
        render: function(i) {
            var j = this;
            $(i).append(this.el);
            p3.fT(j.template, function(k) {
                j.$el.html(k({
                    schoolId: p3.Data.SchoolContext.get("SchoolInfo").SchoolId,
                    schoolName: p3.Data.SchoolContext.get("SchoolInfo").SchoolName
                }));
                j.collection.fetch()
            })
        },
        renderTemplate: function() {
            this.collection.fetch()
        },
        renderItems: function() {
            var i = this;
            $("#dashboard-athletic-scorelist").html("");
            i.collection.each(function(j) {
                if (!j.get("hide")) {
                    p3.rV(new d.Vs.ScoreListItem({
                        model: j
                    }), "#dashboard-athletic-scorelist", false)
                }
            })
        },
        showAddDialog: function(i) {
            var j = this;
            j.showResultDialog(false, i);
            return false
        },
        showEditDialog: function(i) {
            var j = this;
            j.showResultDialog(true, i);
            return false
        },
        showResultDialog: function(j, k) {
            var m = this,
                i = $(k.currentTarget),
                l = i.data("sectionid") || i.data("teamId");
            m.options.sections = new h.Cs.Sections({}, {
                sectionId: l
            });
            m.options.sections.models[0].set({
                GroupName: i.data("team"),
                IsSelected: 1,
                SectionId: l,
                LeadSectionId: l,
                ContextLabelId: 3,
                AssociationId: 2,
                Association: "Athletics",
                Primary: true
            });
            p3.rV(new h.Vs.EditResultsView({
                gameId: i.data("id"),
                existingData: j,
                parentView: m,
                newsId: i.data("newsid"),
                siteInd: i.data("siteind")
            }), p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal)
        }
    });
    d.Vs.ScoreListItem = Bb.View.extend({
        template: "dashboard/dashboard.athletics.scorelist.item.template.html",
        events: {},
        tagName: "tr",
        render: function(i) {
            var j = this;
            $(i).append(this.el);
            p3.fT(j.template, function(k) {
                j.$el.html(k({
                    item: j.model.toJSON(),
                    schoolName: p3.Data.SchoolContext.get("SchoolInfo").SchoolName,
                    canEdit: true
                }))
            })
        }
    });
    d.Vs.AthleticLocation = Bb.View.extend({
        template: "dashboard/dashboard.athletics.location.template.html",
        events: {},
        renderTemplate: function() {
            var i = this;
            i.collection.fetch({
                success: function() {
                    var j = -1,
                        k = "",
                        l = -1,
                        m = "";
                    i.collection.each(function(o) {
                        j += 1;
                        o.set("index", j);
                        if (o.get("Location") != k) {
                            k = o.get("Location");
                            o.set("newLocation", true)
                        }
                        if (o.get("LocationInd") != l) {
                            l = o.get("LocationInd");
                            if (l == 0) {
                                o.set("newLocType", "Home Venues")
                            } else {
                                o.set("newLocType", "Away Venues")
                            }
                        }
                        o.set("Location", o.get("Location"));
                        m = o.get("Opponents");
                        if (m != null) {
                            switch (o.get("HomeAway")) {
                                case "Home":
                                    o.set("opponentDisplay", "<strong>vs</strong> " + m);
                                    break;
                                case "Away":
                                    o.set("opponentDisplay", "<strong>@</strong> " + m);
                                    break
                            }
                        }
                        var n = b.getTimeString(b.getDate(b.getDateString(b.localDateTime()) + " " + o.get("StartTime")));
                        o.set("eventTime", (b.isMidnight(n) ? "TBA" : n))
                    });
                    p3.fT(i.template, function(n) {
                        i.$el.html(n({
                            events: i.collection.toJSON()
                        }));
                        $("button.btn.delete").bind("click", function(o) {
                            i.showDeleteDialog(o)
                        });
                        $("button.btn.edit").bind("click", function(o) {
                            i.showEditDialog(o)
                        });
                        $(".detail-link").bind("click", function(o) {
                            i.showDetails(o)
                        })
                    })
                },
                error: function() {
                    p3.displayError("Error loading dashboard counts")
                }
            })
        },
        initialize: function() {
            var i = this;
            i.parentView = i.options.parentView;
            i.collection = new d.Cs.AthleticLocationByDay({}, {
                lookupDate: b.getDateString(i.options.currentDate)
            });
            a.Us.initializeData(true);
            i.athleticPrivileges = a.Us.getAthleticPrivileges(true, false, false)
        },
        render: function(i) {
            $(i).append(this.el);
            this.renderTemplate()
        },
        showDeleteDialog: function(j) {
            var m = this,
                i = $(j.currentTarget),
                k = i.data("id"),
                l = i.data("team-id");
            if (i.data("type") == 0) {
                p3.showConfirm(null, "Warning: Once you hit confirm there is no undo button. Are you really sure you want to delete this forever?", null, function() {
                    var n = new a.Ms.GameDelete({
                        ScheduleId: k
                    });
                    n.destroy({
                        error: function() {
                            p3.displayError("Error deleting game")
                        },
                        success: function() {
                            m.parentView.refreshDashboard()
                        }
                    })
                })
            } else {
                p3.showConfirm(null, "Warning: Once you hit confirm there is no undo button. Are you really sure you want to delete this forever?", null, function() {
                    var n = new a.Ms.PracticeDelete({
                        PracticeId: k,
                        TeamId: l
                    });
                    n.destroy({
                        error: function() {
                            p3.displayError("Error deleting practice")
                        },
                        success: function() {
                            m.parentView.refreshDashboard()
                        }
                    })
                })
            }
            return false
        },
        showEditDialog: function(j) {
            var o = this,
                i = $(j.currentTarget),
                m = i.data("id"),
                n = i.data("team-id"),
                k, l;
            a.Us.initializeNotifications(n, true);
            if (i.data("type") == 0) {
                k = a.Us.getGameDetails(m);
                a.Us.openGameScheduleDialog(m, k, n, false, o.parentView, false, o.athleticPrivileges.isLite, o.athleticPrivileges)
            } else {
                l = a.Us.getPracticeItem(m, n);
                a.Us.openEditPracticeDialog(m, l, n, false, o.parentView, false, o.athleticPrivileges)
            }
            return false
        },
        showDetails: function(j) {
            var i = $(j.currentTarget);
            d.Us.showDetails(i.data("id"), i.data("type"));
            j.preventDefault()
        }
    });
    d.Vs.AthleticTransportation = Bb.View.extend({
        template: "dashboard/dashboard.athletics.trans.template.html",
        events: {},
        renderTemplate: function() {
            var i = this;
            i.collection.fetch({
                success: function() {
                    var l = -1,
                        m = "",
                        n = "",
                        o, j, k;
                    i.collection.each(function(p) {
                        l += 1;
                        p.set("index", l);
                        if (p.get("Transportation") != m) {
                            m = p.get("Transportation");
                            p.set("newTrans", true)
                        }
                        p.set("Transportation", p.get("Transportation"));
                        n = p.get("Opponents");
                        if (n != null) {
                            switch (p.get("HomeAway")) {
                                case "Home":
                                    p.set("opponentDisplay", "<strong>vs</strong> " + n);
                                    break;
                                case "Away":
                                    p.set("opponentDisplay", "<strong>@</strong> " + n);
                                    break
                            }
                        }
                        k = b.getTimeString(b.getDate(b.getDateString(b.localDateTime()) + " " + p.get("EventStartTime")));
                        p.set("eventTime", (b.isMidnight(k) ? "TBA" : k));
                        if (!p.get("AllDayInd")) {
                            o = b.getTimeString(b.getDate(b.getDateString(b.localDateTime()) + " " + p.get("StartTime")));
                            j = b.getTimeString(b.getDate(b.getDateString(b.localDateTime()) + " " + p.get("EndTime")));
                            p.set("reservedTime", o + " - " + j)
                        }
                    });
                    p3.fT(i.template, function(p) {
                        i.$el.html(p({
                            events: i.collection.toJSON()
                        }));
                        $("button.btn.delete").bind("click", function(q) {
                            i.showDeleteDialog(q)
                        });
                        $("button.btn.edit").bind("click", function(q) {
                            i.showEditDialog(q)
                        });
                        $(".detail-link").bind("click", function(q) {
                            i.showDetails(q)
                        })
                    })
                },
                error: function() {
                    p3.displayError("Error loading dashboard counts")
                }
            })
        },
        initialize: function() {
            var i = this;
            i.parentView = i.options.parentView;
            i.collection = new d.Cs.AthleticTransByDay({}, {
                lookupDate: b.getDateString(i.options.currentDate)
            });
            a.Us.initializeData(true);
            i.athleticPrivileges = a.Us.getAthleticPrivileges(true, false, false)
        },
        render: function(i) {
            $(i).append(this.el);
            this.renderTemplate()
        },
        showDeleteDialog: function(k) {
            var n = this,
                i = $(k.currentTarget),
                l = i.data("id"),
                m = i.data("team-id"),
                j;
            if (i.data("type") == 0) {
                p3.showConfirm(null, "Warning: Once you hit confirm there is no undo button. Are you really sure you want to delete this forever?", null, function() {
                    j = new a.Ms.GameDelete({
                        ScheduleId: l
                    });
                    j.destroy({
                        error: function() {
                            p3.displayError("Error deleting game")
                        },
                        success: function() {
                            n.parentView.refreshDashboard()
                        }
                    })
                })
            } else {
                p3.showConfirm(null, "Warning: Once you hit confirm there is no undo button. Are you really sure you want to delete this forever?", null, function() {
                    j = new a.Ms.PracticeDelete({
                        PracticeId: l,
                        TeamId: m
                    });
                    j.destroy({
                        error: function() {
                            p3.displayError("Error deleting practice")
                        },
                        success: function() {
                            n.parentView.refreshDashboard()
                        }
                    })
                })
            }
            return false
        },
        showEditDialog: function(j) {
            var o = this,
                i = $(j.currentTarget),
                m = i.data("id"),
                n = i.data("team-id"),
                k, l;
            a.Us.initializeNotifications(n, true);
            if (i.data("type") == 0) {
                k = a.Us.getGameDetails(m);
                a.Us.openGameScheduleDialog(m, k, n, false, o.parentView, false, o.athleticPrivileges.isLite, o.athleticPrivileges)
            } else {
                l = a.Us.getPracticeItem(m, n);
                a.Us.openEditPracticeDialog(m, l, n, false, o.parentView, false, o.athleticPrivileges)
            }
            return false
        },
        showDetails: function(j) {
            var i = $(j.currentTarget);
            d.Us.showDetails(i.data("id"), i.data("type"));
            j.preventDefault()
        }
    });
    d.Us.DashboardType = {
        Event: 0,
        Location: 1,
        Transportation: 2,
        Scoreboard: 3,
        Scorelist: 4
    };
    d.Us.showDetails = function(i, k) {
        var j;
        if (k == 0) {
            j = a.Us.getGameDetails(i);
            p3.rV(new a.Vs.GameScheduleDetailsView({
                scheduleItem: j.toJSON()
            }), p3.Layout.Containers.Modal, true)
        } else {
            j = a.Us.getPracticeDetails(i);
            p3.rV(new a.Vs.PracticeDetailsView({
                scheduleItem: j.toJSON()
            }), p3.Layout.Containers.Modal, true)
        }
        p3.showModal(p3.Layout.Containers.Modal)
    };
    p3.router().route("dashboard/onCampus", "dashboard", function() {
        p3.renderMainPage(new d.Vs.LayoutView(), true)
    });
    p3.router().route("AthleticsDashboard/:page/:date", "AthleticsDashboard", function(l, j) {
        var k, i, m;
        switch (l) {
            case "Events":
                k = d.Us.DashboardType.Event;
                break;
            case "Locations":
                k = d.Us.DashboardType.Location;
                break;
            case "Transportation":
                k = d.Us.DashboardType.Transportation;
                break;
            case "Scoreboard":
                k = d.Us.DashboardType.Scoreboard;
                break;
            case "Scorelist":
                k = d.Us.DashboardType.Scorelist;
                break
        }
        if (j == "today") {
            i = b.localDateTime()
        } else {
            m = j.split("-");
            i = new Date(m[2], m[0] - 1, m[1])
        }
        p3.renderMainPage(new d.Vs.AthleticsDashboardView({
            currentDate: i,
            listType: k || d.Us.DashboardType.Event
        }), true)
    })
}(p3.module("dashboardoncourse")));
(function(e) {
    var c = p3.module("shared/base"),
        a = p3.module("LMS/assignment"),
        d = p3.Us.Culture,
        b = p3.module("LMS/Shared/assignmentdetail"),
        g = p3.module("shared/fileselection"),
        f = p3.module("cms/shared/download"),
        h = p3.module("gradebook");
    e.Ms.DiscussionStatus = Bbm.extend({
        url: function() {
            return aP + "DataDirect/DiscussionStatusGet/?format=json&assignmentIndexId=" + this.get("assignmentIndexId")
        }
    });
    e.Ms.DiscussionItem = Bbm.extend({
        idAttribute: "MessageId",
        url: function() {
            return aP
        }
    });
    e.Cs.DiscussionItem = Bbc.extend({
        model: e.Ms.DiscussionItem,
        initialize: function(i, j) {
            this.contentIndexId = j.contentIndexId || 0;
            this.lastDate = j.lastDate || "";
            this.contentId = j.contentId || 58;
            this.sectionView = j.sectionView || false;
            this.studentId = j.studentId || 0;
            this.assignment = j.assignment
        },
        url: function() {
            return aP + "discussionitem/discussionitemsget/?format=json&contentIndexId=" + this.contentIndexId + "&viewDate=" + this.lastDate + "&contentId=" + this.contentId + "&userId=" + this.studentId + "&sectionView=" + this.sectionView
        }
    });
    e.Cs.DiscussionItemRefresh = c.Cs.Stream.extend({
        model: e.Ms.DiscussionItem,
        initialize: function(i, j) {
            this.contentIndexId = j.contentIndexId || 0;
            this.lastDate = j.lastDate || "";
            this.contentId = j.contentId || 0;
            this.sectionView = j.sectionView || false;
            this.studentId = j.studentId || 0;
            this.count = 0
        },
        add: function(r, s) {
            var m = [],
                k, o, l, p, q, n, u, t;
            if (r.length) {
                l = 0;
                p = _.max(r, function(i) {
                    return i.ModifiedDateTicks
                });
                if (p && p.ModifiedDateTicks) {
                    this.lastDate = p.ModifiedDateTicks
                }
                t = function(i, j) {
                    if (j.options.parentMessageId == q.MessageId) {
                        j.options.item = new e.Ms.DiscussionItem(q);
                        j.renderTemplate();
                        if (j.childMessages && j.childMessages.length > 0) {
                            for (k = 0; k < j.childMessages.length; k++) {
                                n = new e.Vs.DiscussionItem({
                                    assignment: j.options.assignment,
                                    staus: j.options.status,
                                    item: j.childMessages[k],
                                    isChild: true,
                                    parentMessageId: q.MessageId,
                                    assignmentIndexId: j.options.assignmentIndexId
                                });
                                p3.rV(n, "#child-messages-" + q.MessageId, false)
                            }
                        }
                    } else {
                        if (j.childMessages && j.childMessages.length > 0) {
                            for (o = 0; o < j.childMessages.length; o++) {
                                if (j.childMessages[o].get("MessageId") == q.MessageId) {
                                    u = new e.Ms.DiscussionItem(q);
                                    j.childMessages[o] = u;
                                    $("#child-messages-" + j.options.parentMessageId).data("views")[o].options.item = u;
                                    $("#child-messages-" + j.options.parentMessageId).data("views")[o].renderTemplate();
                                    break
                                }
                            }
                        }
                    }
                };
                for (k = 0; k < r.length; k++) {
                    q = r[k];
                    switch (q.AuditAction) {
                        case "D":
                            $('.message-display[data-id="' + q.MessageId + '"]').remove();
                            break;
                        case "I":
                            if (_.isUndefined(this.get(q.MessageId))) {
                                l += 1;
                                m.push(q)
                            }
                            break;
                        case "U":
                            $.each($("#message-region").data("views"), t);
                            break;
                        default:
                            break
                    }
                }
                this.count = this.count + l;
                if (l > 0) {
                    $("#messageLoadButton").html("(  <strong>" + this.count + "</strong> ) Load New Content");
                    $("#messageLoadRegion").show()
                }
            }
            return Bbc.prototype.add.call(this, m, s)
        },
        url: function() {
            return aP + "discussionitem/discussionitemsrefresh/?format=json&contentIndexId=" + this.contentIndexId + "&viewDate=" + this.lastDate + "&contentId=" + this.contentId + "&userId=" + this.studentId + "&sectionView=" + this.sectionView
        }
    });
    e.Ms.DiscussionItemCreate = Bbm.extend({
        idAttribute: "MessageId",
        url: function() {
            return aP + "discussionitem/create/?format=json"
        }
    });
    e.Ms.DiscussionItemUpdate = Bbm.extend({
        idAttribute: "MessageId",
        url: function() {
            return aP + "discussionitem/update/?format=json"
        }
    });
    e.Ms.DiscussionItemDelete = Bbm.extend({
        idAttribute: "Id",
        url: function() {
            return aP + "discussionitem/delete/" + this.get("Id") + "/?format=json&contextLabelId=5&contextValue=" + this.get("contextValue")
        }
    });
    e.Data = {};
    e.Vs.StudentDiscussion = Bb.View.extend({
        template: "discussion/discussion.student.detail.template.html",
        initialize: function(i) {
            this.Containers = {}
        },
        events: {
            "click #BackButton": "moveBack"
        },
        render: function(i) {
            var j = this;
            $(i).html(j.el);
            j.renderTemplate()
        },
        renderTemplate: function() {
            var s = this,
                l, k = "",
                o, p, q, i, j = "",
                t, r, m = _.find(s.options.assignment.get("SectionLinks"), function(u) {
                    return u.AssignmentIndexId == s.options.assignmentIndexId
                }),
                n = new e.Ms.DiscussionStatus({
                    assignmentIndexId: s.options.assignmentIndexId
                });
            n.fetch({
                error: function() {
                    p3.displayError("Error loading discussion status")
                },
                success: function(u, v) {
                    switch (v[0].discussion_status) {
                        case -1:
                            l = "#d3f1fb";
                            i = e.Us.getDayDifference(d.localDateTime(), d.getDate(m.DueDate));
                            switch (i) {
                                case 0:
                                    k = "Due Today";
                                    break;
                                case 1:
                                    k = "Due in 1 Day";
                                    break;
                                default:
                                    k = "Due in " + i + " Days";
                                    break
                            }
                            o = "#2d9bbb";
                            p = "p3icon-socialMedia";
                            q = "To Do";
                            t = "60px";
                            break;
                        case 1:
                            l = "#dbf3db";
                            r = d.getDate(v[0].first_post);
                            k = "submitted on " + e.Us.formatDateTime(r);
                            o = "#50a94f";
                            p = "p3icon-check";
                            q = "Completed";
                            t = "85px";
                            break;
                        case 2:
                            l = "#eed3d7";
                            i = e.Us.getDayDifference(d.localDateTime(), d.getDate(m.DueDate));
                            switch (i) {
                                case 0:
                                    k = "Due Today";
                                    break;
                                case 1:
                                    k = "Due 1 Day Ago";
                                    break;
                                default:
                                    k = "Due " + i + " Days Ago";
                                    break
                            }
                            o = "#b94a48";
                            p = "p3icon-warning";
                            q = "Overdue";
                            t = "85px";
                            break;
                        case 4:
                            l = "#dbf3db";
                            o = "#50a94f";
                            p = "p3icon-ok";
                            if (v[0].letter) {
                                j = v[0].letter
                            } else {
                                if (v[0].pointsEarned) {
                                    j = v[0].pointsEarned + " of " + s.options.assignment.get("MaxPoints")
                                }
                            }
                            q = "Graded: " + j;
                            t = "140px";
                            break;
                        case 5:
                            l = "#e9e9e9";
                            i = e.Us.getDayDifference(d.localDateTime(), d.getDate(m.DueDate));
                            switch (i) {
                                case 0:
                                    k = "Available Today";
                                    break;
                                case 1:
                                    k = "Available Tomorrow";
                                    break;
                                default:
                                    k = "Available in " + i + " Days";
                                    break
                            }
                            o = "#e1e1e1";
                            p = "p3icon-socialMedia";
                            q = "Upcoming";
                            t = "85px";
                            break
                    }
                    p3.fT(s.template, function(w) {
                        s.$el.html(w({
                            assignment: s.options.assignment.toJSON(),
                            adate: m.AssignmentDate,
                            ddate: m.DueDate,
                            sectionName: m.Section.Name,
                            regionBackcolor: l,
                            message: k,
                            statusBackcolor: o,
                            statusIcon: p,
                            statusText: q,
                            width: t
                        }));
                        s.Containers.DiscussionDetails = $("#discussion-details-container");
                        s.renderDetail(v[0])
                    })
                }
            })
        },
        moveBack: function(i) {
            window.history.go(-1)
        },
        renderDetail: function(j) {
            var i = new e.Vs.DiscussionDetail({
                assignment: this.options.assignment,
                status: j,
                assignmentIndexId: this.options.assignmentIndexId,
                sectionDetail: false,
                studentId: 0
            });
            p3.rV(i, this.Containers.DiscussionDetails, true)
        }
    });
    e.Vs.DiscussionDetail = Bb.View.extend({
        template: "discussion/discussion.detail.template.html",
        initialize: function(l) {
            this.Containers = {};
            var j = this.options.assignment.get("DownloadItems"),
                k;
            for (k = 0; k < j.length; k++) {
                j[k].isImage = e.Us.isImage(j[k].FileName)
            }
        },
        dispose: function() {
            $(window).unbind("scroll");
            this.stopStream()
        },
        events: {
            "click #original-response-button": "showResponseRegion",
            "click #messageLoadButton": "displayInsertedMessages"
        },
        render: function(i) {
            var j = this;
            $(i).html(j.el);
            j.renderTemplate()
        },
        renderTemplate: function() {
            var m = this,
                i, j = "",
                l, k;
            if (m.options.sectionDetail) {
                i = true
            } else {
                i = m.options.status.discussion_status != 5
            }
            p3.fT(m.template, function(n) {
                m.$el.html(n({
                    assignment: m.options.assignment.toJSON(),
                    status: m.options.status,
                    schoolId: p3.Data.SchoolContext.attributes.SchoolInfo.SchoolId,
                    canPost: i,
                    studentId: m.options.studentId
                }));
                m.Containers.ResponseRegion = $("#original-response-region");
                m.Containers.MessagesRegion = $("#message-region");
                if (m.options.sectionDetail || m.options.assignment.get("AlwaysShowDiscussion") || m.options.status.message_count > 0) {
                    m.renderMessages();
                    m.messagesRendered = true
                } else {
                    $("#message-region").html('<h5 class="noShow" style="text-align:center; margin:15px 20px 0px 10px; font-weight:400">You will not be able to view or respond to other classmates responses until you have added a response of your own.</h5>');
                    m.messagesRendered = false
                }
            });
            if (m.options.studentId <= 0) {
                l = new Date();
                if (p3.Data.SchoolContext.attributes.SchoolInfo.HoursFromCentral != 0) {
                    l = new Date(l.setHours(l.getHours() + p3.Data.SchoolContext.attributes.SchoolInfo.HoursFromCentral))
                }
                k = l.getTime() - (l.getTimezoneOffset() * 60000);
                j = (k * 10000) + 6.21355968e+17;
                m.refreshCollection = new e.Cs.DiscussionItemRefresh({}, {
                    contentIndexId: m.options.assignmentIndexId,
                    contentId: 58,
                    sectionView: m.options.sectionDetail,
                    studentId: m.options.studentId,
                    lastDate: j,
                    assignment: m.options.assignment
                });
                e.Data.refreshCollection = m.refreshCollection;
                m.startStream()
            }
        },
        showResponseRegion: function(i) {
            var k = this,
                j = new e.Vs.DiscussionPost({
                    assignment: k.options.assignment,
                    staus: k.options.status,
                    messageId: 0,
                    parentId: 0,
                    assignmentIndexId: k.options.assignmentIndexId
                });
            p3.rV(j, k.Containers.ResponseRegion, true);
            j.on("messageCreated", function(m) {
                if ($("#post-count").length > 0) {
                    m.set("OwnerPost", true)
                }
                $("#original-response-region").html('<div style="margin: 10px 10px 5px 90px; cursor: pointer;color: #0088cc;" id="original-response-button"><h3><i class="p3icon-comment iconSmall p3Blue"></i> &nbsp; add new response</h3></div>');
                if (k.messagesRendered) {
                    var l = new e.Vs.DiscussionItem({
                        assignment: k.options.assignment,
                        staus: k.options.status,
                        item: m,
                        isChild: false,
                        parentMessageId: 0,
                        prepend: true,
                        assignmentIndexId: k.options.assignmentIndexId
                    });
                    p3.rV(l, k.Containers.MessagesRegion, false)
                } else {
                    $(k.Containers.MessagesRegion).html("");
                    k.messagesRendered = true;
                    k.renderMessages()
                }
                if (k.options.sectionDetail) {
                    e.Us.showPostTotal()
                }
            })
        },
        renderMessages: function() {
            var m = this,
                k = 0,
                i = false,
                l, j = new e.Cs.DiscussionItem({}, {
                    contentIndexId: m.options.assignmentIndexId,
                    contentId: 58,
                    sectionView: m.options.sectionDetail,
                    studentId: m.options.studentId
                });
            j.fetch({
                success: function() {
                    if (j.length == 0 && m.options.studentId > 0) {
                        $(m.Containers.MessagesRegion).html('<div align="center" style="padding:10px"><i class="p3icon-trash"></i><h3>This student has not submitted a response.</h3></div>')
                    } else {
                        j.each(function(n) {
                            if (n.get("ChildRank") == 0) {
                                i = false;
                                k = n.get("MessageId")
                            } else {
                                i = true
                            }
                            var o = new e.Vs.DiscussionItem({
                                assignment: m.options.assignment,
                                staus: m.options.status,
                                item: n,
                                isChild: i,
                                parentMessageId: k,
                                assignmentIndexId: m.options.assignmentIndexId
                            });
                            if (i) {
                                l.childMessages.push(n);
                                o.parentView = l;
                                window.setTimeout(function(p) {
                                    p3.rV(o, p, false);
                                    if (m.options.sectionDetail) {
                                        e.Us.showPostTotal()
                                    }
                                }, 100, "#child-messages-" + k)
                            } else {
                                p3.rV(o, $(m.Containers.MessagesRegion), false);
                                l = o;
                                l.childMessages = []
                            }
                        })
                    }
                    if (m.options.sectionDetail) {
                        e.Us.showPostTotal()
                    }
                },
                error: function() {
                    p3.displayError("Error loading discussion thread")
                }
            })
        },
        stopStream: function() {
            var i = this;
            if (i.refreshCollection) {
                i.refreshCollection.unstream()
            }
        },
        startStream: function() {
            var i = this;
            i.refreshCollection.stream({
                interval: 60000,
                add: true
            })
        },
        displayInsertedMessages: function() {
            var o = this,
                j, l, m, k, n;
            $("#messageLoadRegion").hide();
            $(".added-note").removeClass("added-note");
            o.refreshCollection.count = 0;
            e.Us.showPostTotal();
            n = function(i, p) {
                if (p.options.parentMessageId == m) {
                    p.childMessages.push(l)
                }
            };
            for (j = 0; j < o.refreshCollection.models.length; j++) {
                l = o.refreshCollection.models[j];
                $('.message-display[data-id="' + l.get("MessageId") + '"]').remove();
                m = l.get("ParentMessageId");
                k = new e.Vs.DiscussionItem({
                    assignment: o.options.assignment,
                    staus: o.options.status,
                    item: l,
                    isChild: m > 0,
                    parentMessageId: m,
                    assignmentIndexId: o.options.assignmentIndexId,
                    inserted: true,
                    prepend: m == 0
                });
                if (m > 0) {
                    p3.rV(k, "#child-messages-" + m, false);
                    $.each($("#message-region").data("views"), n)
                } else {
                    p3.rV(k, $(o.Containers.MessagesRegion), false)
                }
            }
            o.refreshCollection.remove(o.refreshCollection.models);
            if (o.options.sectionDetail) {
                e.Data.roster.fetch({
                    data: {
                        aiid: o.options.assignmentIndexId,
                        viewerId: p3.Data.Context.get("UserInfo").UserId
                    },
                    error: function(i, p) {
                        p3.displayError("Error loading Roster.")
                    }
                })
            }
            return false
        }
    });
    e.Vs.DiscussionItem = Bb.View.extend({
        template: "discussion/discussion.item.template.html",
        initialize: function(i) {
            this.Containers = {}
        },
        events: {
            "click .add-child-response-btn": "showResponseRegion",
            "click .message-edit-btn": "editMessage",
            "click .message-delete-btn": "deleteMessage",
            "click .message-hide-btn": "hideMessage",
            "click .message-show-btn": "showMessage"
        },
        render: function(i) {
            var j = this;
            if (j.options.prepend) {
                $(i).prepend(j.el)
            } else {
                $(i).append(j.el)
            }
            j.renderTemplate()
        },
        renderTemplate: function() {
            var q = this,
                o, n = true,
                l = false,
                k = false,
                m = false,
                p = p3.Data.Context.getSelectedPersona().Id,
                j;
            if (p3.Data.Context.get("UserInfo").UserId == q.options.item.get("UserId")) {
                l = true;
                k = p == 3
            } else {
                if (p == 3) {
                    m = true;
                    k = true
                }
            }
            j = q.options.item.get("Attachments");
            if (j && j.length > 0) {
                for (o = 0; o < j.length; o++) {
                    j[o].isImage = e.Us.isImage(j[o].AttachmentFilename)
                }
            }
            p3.fT(q.template, function(i) {
                q.$el.html(i({
                    message: q.options.item.toJSON(),
                    schoolId: p3.Data.SchoolContext.attributes.SchoolInfo.SchoolId,
                    canPost: n,
                    isChild: q.options.isChild,
                    canEdit: l,
                    canDelete: k,
                    canHide: m,
                    parentId: q.options.parentMessageId,
                    inserted: q.options.inserted
                }));
                q.Containers.ResponseRegion = q.$(".response-region")
            })
        },
        showResponseRegion: function(i) {
            var l = this,
                j = $(i.currentTarget).data("id"),
                k = new e.Vs.DiscussionPost({
                    assignment: l.options.assignment,
                    staus: l.options.status,
                    messageId: 0,
                    parentId: j,
                    assignmentIndexId: l.options.assignmentIndexId
                });
            p3.rV(k, "#child-response-container-" + j, true);
            k.on("messageCreated", function(n) {
                if ($("#post-count").length > 0) {
                    n.set("OwnerPost", true)
                }
                $("#child-response-container-" + j).html('<div class="feed muted" style="margin-left: 8px; margin-top: 3px; margin-bottom: 3px;"><a href="#" class="add-child-response-btn" data-id="' + j + '"><i class="p3icon-comment iconSmall"></i> &nbsp; add response</a></div>');
                var m = new e.Vs.DiscussionItem({
                    assignment: l.options.assignment,
                    item: n,
                    isChild: true,
                    parentMessageId: j,
                    prepend: false,
                    assignmentIndexId: l.options.assignmentIndexId
                });
                p3.rV(m, $("#child-messages-" + j), false);
                if (l.childMessages) {
                    l.childMessages.push(n)
                }
                e.Us.showPostTotal()
            });
            return false
        },
        editMessage: function(k) {
            var q = this,
                j = $(k.currentTarget),
                n = j.data("id"),
                o = j.data("parentid"),
                l, m, p = new e.Vs.DiscussionPost({
                    assignment: q.options.assignment,
                    staus: q.options.status,
                    messageId: n,
                    parentId: o,
                    message: q.options.item,
                    assignmentIndexId: q.options.assignmentIndexId
                });
            q.$(".message-display").hide();
            q.$(".message-edit-container").show();
            p3.rV(p, q.$(".message-edit-container"), true);
            p.on("messageUpdated", function(i) {
                q.options.item = i;
                q.renderTemplate();
                q.$(".message-display").show();
                q.$(".message-edit-container").hide().html("");
                if (q.childMessages && q.childMessages.length > 0) {
                    for (l = 0; l < q.childMessages.length; l++) {
                        m = new e.Vs.DiscussionItem({
                            assignment: q.options.assignment,
                            staus: q.options.status,
                            item: q.childMessages[l],
                            isChild: true,
                            parentMessageId: n,
                            assignmentIndexId: q.options.assignmentIndexId
                        });
                        p3.rV(m, "#child-messages-" + n, false)
                    }
                }
                if (q.options.isChild && q.parentView) {
                    for (l = 0; l < q.parentView.childMessages.length; l++) {
                        if (q.parentView.childMessages[l].get("MessageId") == n) {
                            q.parentView.childMessages[l] = i;
                            break
                        }
                    }
                }
            });
            p.on("editCancel", function() {
                q.$(".message-display").show();
                q.$(".message-edit-container").hide().html("")
            });
            k.stopPropagation();
            k.preventDefault()
        },
        deleteMessage: function(l) {
            var o = this,
                j = $(l.currentTarget),
                n = j.data("id"),
                k, m;
            p3.showConfirm(null, "Are you sure you want to delete this?", null, function() {
                k = new e.Ms.DiscussionItemDelete({
                    Id: n,
                    contextLabelId: 5,
                    contextValue: o.options.assignment.get("AssignmentId")
                });
                k.destroy({
                    error: function() {
                        p3.displayError("Error deleting message")
                    },
                    success: function() {
                        j.parent().remove();
                        e.Us.showPostTotal();
                        e.Data.roster.fetch({
                            data: {
                                aiid: o.options.assignmentIndexId,
                                viewerId: p3.Data.Context.get("UserInfo").UserId
                            },
                            error: function(i, p) {
                                p3.displayError("Error loading Roster.")
                            }
                        });
                        if (o.parentView && o.parentView.childMessages) {
                            for (m = 0; m < o.parentView.childMessages; m++) {
                                if (o.parentView.childMessages[m].get("MessageId") == n) {
                                    o.parentView.childMessages.splice(m, 1);
                                    break
                                }
                            }
                        }
                    }
                })
            });
            l.stopPropagation();
            l.preventDefault()
        },
        hideMessage: function(j) {
            var k = this,
                i = $(j.currentTarget);
            k.setMessageVisibility(false);
            i.removeClass("message-hide-btn").addClass("message-show-btn badge").html('Response is Hidden&nbsp;<i class="p3icon-reviewReady iconColor"></i>')
        },
        showMessage: function(j) {
            var k = this,
                i = $(j.currentTarget);
            k.setMessageVisibility(true);
            i.removeClass("message-show-btn badge").addClass("message-hide-btn").html('<i class="p3icon-reviewReady"></i>')
        },
        setMessageVisibility: function(k) {
            var l = this,
                i = l.options.item.toJSON(),
                j;
            j = new e.Ms.DiscussionItemUpdate({
                MessageId: i.MessageId,
                Message: i.Message,
                ParentMessageId: i.ParentMessageId,
                ContextLabelId: 5,
                ContextValue: l.options.assignment.get("AssignmentId"),
                Attachments: i.Attachments,
                ApprovalInd: k
            });
            j.save({}, {
                error: function() {
                    p3.displayError("Error saving response")
                }
            })
        }
    });
    e.Vs.DiscussionPost = Bb.View.extend({
        template: "discussion/discussion.post.template.html",
        initialize: function(i) {
            this.Containers = {};
            _.bindAll(this, "doAttachFiles")
        },
        events: {
            "click .post-message-btn": "saveDiscussionItem",
            "click .attach-files-btn": "launchAttachmentBrowser",
            "click .attach-delete": "deleteAttachment",
            "click .embed-text-btn": "openEmbedDialog",
            "click .embed-delete": "deleteEmbed",
            "click .response-close-btn": "closeResponse"
        },
        render: function(i) {
            var j = this;
            $(i).html(j.el);
            j.renderTemplate()
        },
        renderTemplate: function() {
            var l = this,
                j = p3.Data.Context.get("UserInfo"),
                k, i = "";
            if (j.ProfilePhoto && j.ProfilePhoto.ThumbFilenameUrl) {
                k = j.ProfilePhoto.ThumbFilenameUrl
            } else {
                k = "/app/content/images/user.png"
            }
            if (l.options.messageId == 0) {
                l.attachments = [];
                l.embedId = 0;
                l.embedText = ""
            } else {
                l.attachments = l.options.message.get("Attachments");
                if (l.attachments == null) {
                    l.attachments = []
                }
                l.embedId = l.options.message.get("EmbedId");
                l.embedText = l.options.message.get("EmbedText");
                l.embedTitle = l.options.message.get("EmbedTitle");
                i = l.options.message.toJSON()
            }
            p3.fT(l.template, function(n) {
                l.$el.html(n({
                    userName: j.FirstName + " " + j.LastName,
                    userPhoto: k,
                    messageId: l.options.messageId,
                    parentId: l.options.parentId,
                    message: i,
                    allowAttach: l.options.assignment.get("AllowDiscussionAttach")
                }));
                var m = "response-text";
                if (l.options.parentId > 0) {
                    m += "_" + l.options.parentId
                }
                p3.showHtmlEditor(m, p3.Us.Enum.HtmlEditorCategories.FULL, false, undefined, p3.Us.Enum.HtmlEditorEncoding.NUMERIC)
            })
        },
        saveDiscussionItem: function(j) {
            var s = this,
                m = s.options.messageId,
                n = s.options.parentId,
                i = s.options.assignment.get("AssignmentId"),
                q, o, r, l = "response-text",
                k, p;
            if (s.options.parentId > 0) {
                l += "_" + s.options.parentId
            }
            k = tinyMCE.get(l);
            k.save();
            q = e.Us.removeWordMarkup($("#" + l).val(), true);
            if (s.embedId > 0 || s.embedText.length > 0) {
                if (s.embedText.length == 0) {
                    s.attachments.push({
                        AttachmentType: 1,
                        DeleteInd: true,
                        ContentItemId: s.embedId
                    })
                } else {
                    s.attachments.push({
                        AttachmentType: 1,
                        DeleteInd: false,
                        ContentItemId: s.embedId,
                        AttachmentDescription: s.embedTitle,
                        AttachmentText: s.embedText
                    })
                }
            }
            if (m == 0) {
                p = _.find(s.options.assignment.get("SectionLinks"), function(t) {
                    return t.AssignmentIndexId == s.options.assignmentIndexId
                });
                o = new e.Ms.DiscussionItemCreate({
                    MessageId: m,
                    Message: q,
                    ParentMessageId: n,
                    ContextLabelId: 5,
                    ContextValue: i,
                    Attachments: s.attachments,
                    ApprovalInd: true,
                    SectionId: p.SectionId
                });
                if (s.options.staus && s.options.staus.message_count == 0) {
                    r = true
                }
            } else {
                o = new e.Ms.DiscussionItemUpdate({
                    MessageId: m,
                    Message: q,
                    ParentMessageId: n,
                    ContextLabelId: 5,
                    ContextValue: i,
                    Attachments: s.attachments,
                    ApprovalInd: s.options.message.get("ApprovalInd")
                })
            }
            o.save({}, {
                error: function() {
                    p3.displayError("Error saving response")
                },
                success: function(t, u) {
                    if (!m) {
                        s.trigger("messageCreated", t)
                    } else {
                        s.trigger("messageUpdated", t)
                    }
                    if (r) {
                        $("#status-region").css("background-color", "#dbf3db").html('<h5 class="pull-right" style="padding:0px 15px 0px 8px; font-weight:400; margin:6px 0px 0px 0px">submitted on ' + e.Us.formatDateTime(d.getDate(t.get("MessageDate"))) + '</h5><div style="width:90px; background-color:#50a94f;padding:5px"><h5 class="p3formWhite"><i class="p3icon-check iconColor"></i> Completed</h5></div>')
                    }
                }
            })
        },
        launchAttachmentBrowser: function(i) {
            var j = new g.Vs.AttachFilesModal({
                googleDriveAllowed: true,
                googleLinksPermitted: false,
                permittedFileCount: this.options.assignment.get("DropboxNumFiles") > 0 ? this.options.assignment.get("DropboxNumFiles") : 10,
                visibleFileLimit: false,
                receiveFilesCallback: this.doAttachFiles
            });
            p3.rV(j, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            p3.initModalHeightTimer(p3.Layout.Containers.Modal)
        },
        doAttachFiles: function(i) {
            var j = this;
            i.each(function(m) {
                var n = m.getTempFileName(),
                    l, k;
                if (!p3.Data.fileTypes) {
                    l = new f.Cs.FileTypes({}, {});
                    p3.Data.fileTypes = l;
                    l.fetch({
                        async: false,
                        error: function() {
                            p3.displayError("Error loading filetypes")
                        }
                    })
                }
                k = p3.Data.fileTypes.get(n.substring(n.lastIndexOf(".")).toLowerCase());
                if (k) {
                    j.attachments.push({
                        AttachmentType: 0,
                        DeleteInd: false,
                        ContentItemId: 0,
                        AttachmentDescription: m.getFileName(),
                        AttachmentFilename: m.getFileName(),
                        Tempfilename: n,
                        AttachmentFileTypeId: k.get("fileTypeId")
                    });
                    if (e.Us.isImage(n)) {
                        $("#attached-files-region").append('<div class="attached-file" style="margin-top:5px;"><img style="max-height:200px;" src="/ftpimages/pdTemp/' + n + '"><button class="btn btn-default attach-delete" data-attachid="0" data-attachtemp="' + n + '" style="margin-left:5px;"><i class="p3icon-delete"></i></button></div>')
                    } else {
                        $("#attached-files-region").append('<div class="attached-file" style="margin-top:5px;"><a target="_blank" href="/ftpimages/pdTemp/' + n + '">' + m.get("fileName") + '</a><button class="btn btn-default attach-delete" data-attachid="0" data-attachtemp="' + n + '" style="margin-left:5px;"><i class="p3icon-delete"></i></button></div>')
                    }
                }
            })
        },
        deleteAttachment: function(k) {
            var o = this,
                j = $(k.currentTarget),
                m = j.data("attachid"),
                l, n;
            if (m > 0) {
                for (l = 0; l < o.attachments.length; l++) {
                    if (o.attachments[l].ContentItemId == m) {
                        o.attachments[l].DeleteInd = true;
                        break
                    }
                }
                j.parent().html('<div class="alert alert-error">This attachment will be deleted when the response is posted.</div>')
            } else {
                n = j.data("attachtemp");
                for (l = 0; l < o.attachments.length; l++) {
                    if (o.attachments[l].Tempfilename == n) {
                        o.attachments.splice(l, 1);
                        break
                    }
                }
                j.parent().remove()
            }
        },
        openEmbedDialog: function(i) {
            var k = this,
                j = new e.Vs.EmbedEditView({
                    title: k.embedTitle,
                    text: k.embedText,
                    embedId: k.embedId
                });
            p3.rV(j, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            j.on("embedSaved", function(l, m) {
                k.embedTitle = m;
                k.embedText = l;
                k.$("#embed-region").html('<div class="pull-left" style="margin-right:5px;"><button class="btn btn-default embed-delete"><i class="p3icon-delete"></i></button></div>' + l)
            })
        },
        deleteEmbed: function(i) {
            var j = this;
            if (j.embedId > 0) {
                j.$("#embed-region").html('<div class="alert alert-error">The embed will be deleted when the response is posted.</div>')
            } else {
                j.$("#embed-region").html("")
            }
            j.embedText = "";
            j.embedTitle = ""
        },
        closeResponse: function(i) {
            var j = this;
            if (j.options.messageId > 0) {
                j.trigger("editCancel")
            } else {
                if (j.options.parentId > 0) {
                    $("#child-response-container-" + j.options.parentId).html('<div class="feed muted" style="margin-left: 8px; margin-top: 3px; margin-bottom: 3px;"><a href="#" class="add-child-response-btn" data-id="' + j.options.parentId + '"><i class="p3icon-comment iconSmall"></i> &nbsp; add response</a></div>')
                } else {
                    $("#original-response-region").html('<div style="margin: 10px 10px 5px 90px; cursor: pointer;color: #0088cc;" id="original-response-button"><h3><i class="p3icon-comment iconSmall p3Blue"></i> &nbsp; add new response</h3></div>')
                }
            }
            return false
        }
    });
    e.Vs.EmbedEditView = Bb.View.extend({
        template: "discussion/discussion.embed.template.html",
        events: {
            "click #btnSaveEmbed": "doSave"
        },
        render: function(i) {
            $(i).append(this.el);
            this.renderTemplate()
        },
        renderTemplate: function() {
            var i = this;
            p3.fT(i.template, function(j) {
                i.$el.html(j());
                $("#embed-text").height(110);
                this.$("#embed-title").val(i.options.title);
                this.$("#embed-text").val(i.options.text)
            })
        },
        doSave: function(j) {
            var m = this,
                k = m.$("#embed-title").val(),
                i = m.$("#embed-text").val(),
                l = true;
            $("#btnSaveEmbed").button("loading");
            if (typeof k !== "string" || k === "") {
                m.$("#embed-title").closest(".control-group").addClass("error");
                l = false
            } else {
                m.$("#embed-title").closest(".control-group").removeClass("error")
            }
            if (typeof i !== "string" || i === "") {
                m.$("#embed-text").closest(".control-group").addClass("error");
                l = false
            } else {
                m.$("#embed-text").closest(".control-group").removeClass("error")
            }
            if (l) {
                m.trigger("embedSaved", m.$("#embed-text").val(), m.$("#embed-title").val());
                p3.showModal(p3.Layout.Containers.Modal, "hide")
            } else {
                $("#btnSaveEmbed").button("reset")
            }
            return false
        }
    });
    e.Vs.SectionDiscussion = Bb.View.extend({
        template: "discussion/discussion.section.layout.template.html",
        initialize: function(i) {
            var j = this;
            j.Containers = {};
            b.Data.Assignment = j.options.assignment;
            b.Data.Aiid = j.options.assignmentIndexId;
            b.Data.Aid = j.options.assignmentId;
            b.Data.SchoolYear = p3.Data.SchoolContext.get("CurrentSchoolYear").SchoolYearLabel;
            b.Data.MarkingPeriods = new b.Cs.MarkingPeriods();
            b.Data.Gradebook = new h.Cs.Gradebook();
            b.Data.GradeBookIndicator = j.options.assignment.get("IncGradeBook");
            j.studentId = 0
        },
        events: {
            "click #BackButton": "moveBack",
            "click #edit-discussion-btn": "editDiscussion"
        },
        render: function(i) {
            var j = this;
            $(i).html(j.el);
            j.renderTemplate()
        },
        renderTemplate: function() {
            var i = this;
            p3.fT(i.template, function(k) {
                i.$el.html(k({}));
                i.Containers.Roster = $("#roster-sidebar");
                i.Containers.Assignment = $("#assignment-detail-container");
                i.Containers.Discussion = $("#discussion-container");
                i.renderRoster();
                var j = new e.Ms.DiscussionStatus({
                    assignmentIndexId: i.options.assignmentIndexId
                });
                j.fetch({
                    error: function() {
                        p3.displayError("Error loading discussion status")
                    },
                    success: function(l, m) {
                        i.lastStatusResponse = m[0];
                        i.renderDetail(i.lastStatusResponse)
                    }
                })
            })
        },
        moveBack: function(i) {
            window.history.go(-1);
            i.preventDefault()
        },
        renderDetail: function(j) {
            var i = new e.Vs.DiscussionDetail({
                assignment: this.options.assignment,
                status: j,
                assignmentIndexId: this.options.assignmentIndexId,
                sectionDetail: true,
                studentId: this.studentId
            });
            p3.rV(i, this.Containers.Discussion, true)
        },
        renderAssignment: function() {
            var i = new e.Vs.AssignmentDetail({
                assignment: this.options.assignment,
                assignmentIndexId: this.options.assignmentIndexId
            });
            p3.rV(i, this.Containers.Assignment, true)
        },
        renderRoster: function() {
            var k = this,
                i = new b.Cs.AssignmentRoster(),
                j;
            e.Data.roster = i;
            i.on("reset", this.renderAssignment, this);
            j = new b.Vs.AssignmentGradesViewNew({
                collection: i,
                gradebookInd: k.options.assignment.get("IncGradeBook"),
                dropboxInd: false,
                discussionInd: true
            });
            p3.rV(j, this.Containers.Roster, true);
            j.on("studentSelected", function(l) {
                k.studentId = l;
                k.renderDetail()
            });
            j.on("detailsSelected", function() {
                k.studentId = 0;
                k.renderDetail(k.lastStatusResponse)
            })
        },
        editDiscussion: function(j) {
            var k = this,
                i = new a.Ms.Assignment();
            i.set("AssignmentId", k.options.assignment.get("AssignmentId"));
            i.fetch({
                async: false,
                error: function() {
                    p3.displayError("Error loading assignment")
                },
                success: function(m, n) {
                    var l = a.Us.AddDiscussionView(i, 0);
                    l.on("saveDiscussion", function() {
                        k.options.assignment.fetch({
                            async: false,
                            error: function() {
                                p3.displayError("Error loading assignment")
                            },
                            success: function(o, p) {
                                k.renderTemplate()
                            }
                        })
                    })
                }
            });
            return false
        }
    });
    e.Vs.AssignmentDetail = Bb.View.extend({
        template: "discussion/discussion.assignment.detail.template.html",
        events: {},
        render: function(i) {
            $(i).append(this.el);
            this.renderTemplate()
        },
        renderTemplate: function() {
            var j = this,
                i = e.Data.roster.at(0);
            p3.fT(j.template, function(m) {
                var k = j.options.assignment,
                    l = _.find(k.get("SectionLinks"), function(n) {
                        return n.AssignmentIndexId == j.options.assignmentIndexId
                    });
                if (!_.isUndefined(l.SectionId) && l.SectionId > 0) {
                    e.Data.SectionId = l.SectionId;
                    b.Data.SectionId = l.SectionId;
                    e.Data.DurationId = l.Section.Duration.Id;
                    if (_.isUndefined(e.Data.MarkingPeriods)) {
                        e.Data.MarkingPeriods = new b.Cs.MarkingPeriods()
                    }
                    if (e.Data.MarkingPeriods.length <= 0) {
                        e.Data.MarkingPeriods.fetch({
                            data: {
                                sectionList: e.Data.SectionId
                            },
                            error: function(n, o) {
                                p3.displayError("Error retreiving Marking Period Information.")
                            }
                        })
                    }
                    b.Data.MarkingPeriods = e.Data.MarkingPeriods
                }
                j.$el.html(m({
                    print: j.options.print,
                    rootUrl: p3.Config.RootPath,
                    aid: k.get("AssignmentId"),
                    aiid: j.options.assignmentIndexId,
                    title: k.get("ShortDescription"),
                    adate: l.AssignmentDate,
                    ddate: l.DueDate,
                    graded: i.get("graded_count"),
                    enrolled: i.get("enrollment_count"),
                    average: b.Us.getAverageGrade(k.get("MaxPoints"), e.Data.roster),
                    gradebookInd: k.get("IncGradeBook")
                }));
                e.Us.showPostTotal()
            })
        }
    });
    e.Us.showStudentDiscussion = function(j, k) {
        var i = new a.Ms.AssignmentGet();
        i.set("AssignmentId", j);
        i.fetch({
            error: function() {
                p3.displayError("Error loading assignment")
            },
            success: function(m, n) {
                var l = new e.Vs.StudentDiscussion({
                    assignment: i,
                    assignmentId: j,
                    assignmentIndexId: k
                });
                p3.renderMainPage(l)
            }
        })
    };
    e.Us.showSectionDiscussion = function(j, k) {
        var i = new a.Ms.AssignmentGet();
        i.set("AssignmentId", j);
        i.fetch({
            error: function() {
                p3.displayError("Error loading assignment")
            },
            success: function(l, m) {
                var n = new e.Vs.SectionDiscussion({
                    assignment: i,
                    assignmentId: j,
                    assignmentIndexId: k
                });
                p3.renderMainPage(n)
            }
        })
    };
    e.Us.getDayDifference = function(i, j) {
        i = Date.UTC(i.getFullYear(), i.getMonth(), i.getDate());
        j = Date.UTC(j.getFullYear(), j.getMonth(), j.getDate());
        var k = Math.abs(i - j);
        return Math.floor(k / 1000 / 60 / 60 / 24)
    };
    e.Us.formatDateTime = function(i) {
        var j = "";
        if (i) {
            j = d.displayDate(d.getDateString(i), "abbrDay") + " " + d.getDateString(i) + " at " + d.getTimeString(i)
        }
        return j
    };
    e.Us.isImage = function(i) {
        var j = false;
        if (i && i.indexOf(".") > -1) {
            switch (i.split(".").pop().toLowerCase()) {
                case "jpg":
                case "jpeg":
                case "png":
                case "gif":
                case "bmp":
                    j = true;
                    break
            }
        }
        return j
    };
    e.Us.showPostTotal = function() {
        $("#post-count").html($(".student-message").length)
    };
    e.Us.removeWordMarkup = function(m, j) {
        var o = "<!--",
            l = "-->",
            n, k, p, i;
        if (j) {
            p = document.createElement("DIV");
            p.innerHTML = m;
            i = p.innerText;
            $(p).remove()
        } else {
            i = m
        }
        if (i.indexOf("<w:WordDocument>") > -1) {
            while (i.indexOf(o) > -1 && i.indexOf(l) > -1) {
                n = i.indexOf(o);
                if (n > -1) {
                    k = i.indexOf(l, n);
                    if (k > -1) {
                        i = i.substring(0, n) + i.substring(k + l.length)
                    }
                }
            }
            m = i
        }
        return m
    };
    p3.router().route("discussiondetail/:id/:index", "discussiondetail", function(i, j) {
        e.Us.showStudentDiscussion(i, j)
    });
    p3.router().route("discussionsectiondetail/:id/:index/:print", "discussionsectiondetail", function(i, j, k) {
        e.Us.showSectionDiscussion(i, j, k == "1")
    })
}(p3.module("LMS/discussion")));
(function(a) {
    var b = p3.module("LMS/groupPageEdit");
    p3.router().route("dormpageedit/:sectionId/:leadSectionId", "dormpageedit", function(d, c) {
        p3.setTitle("Edit Bulletinboard");
        b.Us.loadPageEditor(c, d, 7, 23)
    })
}(p3.module("LMS/dormbulletinboard")));
(function(c) {
    var b = p3.module("shared/datepicker"),
        a = p3.Us.Culture;
    c.Data = {};
    c.Cs.SchoolYears = Bbc.extend({
        url: "datadirect/SchoolYearsGet"
    });
    c.Ms.Dorm = Bbm.extend({
        idAttribute: "BuildingId"
    });
    c.Cs.Dorms = Bbc.extend({
        model: c.Ms.Dorm,
        url: "dorm/dormsGet"
    });
    c.Ms.Member = Bbm.extend({
        idAttribute: "user_id"
    });
    c.Cs.ManageMembers = Bbc.extend({
        model: c.Ms.Member,
        url: "datadirect/managerosterget",
        getOwners: function() {
            return new Bbc(this.filter(function(d) {
                return d.get("owner_ind") === 1
            }))
        },
        getMembers: function() {
            return new Bbc(this.filter(function(d) {
                return d.get("owner_ind") !== 1
            }))
        }
    });
    c.Ms.ResidentSave = Bbm.extend({
        url: "roster/managesave"
    });
    c.Cs.FacultyRoles = Bbc.extend({
        url: "datadirect/facultyroleget"
    });
    c.Cs.DormLevels = Bbc.extend({
        url: function() {
            return aP + "datadirect/SchoolLevelGet/?offeringType=4"
        }
    });
    c.Vs.LayoutView = Bb.View.extend({
        template: "dormmanagement/layout.template.html",
        initialize: function(d) {
            this.Containers = {}
        },
        events: {
            "click .type-filter": "filterChange",
            "click .all-type-filter": "showAll",
            "change #year-dropdown": "yearChanged",
            "click #dorm-leader-button": "manageLeaders",
            "change #level-dropdown": "levelChanged"
        },
        renderTemplate: function() {
            var e = this,
                d = new c.Cs.DormLevels();
            d.fetch({
                async: false,
                success: function() {
                    if (d.length > 0) {
                        c.Data.levelNum = d.models[0].get("LevelNum")
                    }
                }
            });
            p3.fT(e.template, function(f) {
                e.$el.html(f({
                    schoolYears: e.schoolYears.toJSON(),
                    dormLevels: d.toJSON(),
                    showLevels: d.length > 1
                }))
            });
            e.selectedYear = p3.Data.SchoolContext.get("CurrentSchoolYear").SchoolYearLabel;
            e.getList("-1")
        },
        render: function(d) {
            var e = this;
            $(d).append(this.el);
            e.leaderTypes = new c.Cs.FacultyRoles();
            e.leaderTypes.fetch({
                data: {
                    associationId: 7
                },
                error: function() {
                    p3.displayError("Error leader types")
                }
            });
            e.schoolYears = new c.Cs.SchoolYears();
            e.schoolYears.fetch({
                success: function() {
                    e.renderTemplate()
                },
                error: function() {
                    p3.displayError("Error school years")
                }
            })
        },
        renderList: function(e, f) {
            var d, i = this,
                g = true,
                h = function(j) {
                    i.dorms = j
                };
            i.Containers.ListContainer = $("#list-container");
            e.each(function(k, j) {
                if (k.get("Rooms") && k.get("Rooms").length > 0) {
                    d = new c.Vs.BuildingView({
                        building: k,
                        filter: f,
                        leaderTypes: i.leaderTypes
                    });
                    p3.rV(d, i.Containers.ListContainer, g);
                    g = false;
                    d.on("buildingChange", h)
                }
            });
            if (g) {
                if (f === "-1") {
                    $("#list-container").html("<h5>Use this task to manage residents and dorm supervisors. Not seeing any Dorms below? Double check your set up under Core > School. You set up terms for your Dorms as well as create Dorm Buildings.</h5>")
                } else {
                    $("#list-container").html("<h5>No dorms found</h5>")
                }
            }
        },
        getList: function(e) {
            var f = this,
                d = new c.Cs.Dorms();
            d.fetch({
                data: {
                    schoolYear: f.selectedYear,
                    filter: e,
                    levelNum: c.Data.levelNum
                },
                success: function() {
                    if (f.Containers.ListContainer === undefined) {
                        f.Containers.ListContainer = $("#list-container")
                    }
                    f.dorms = d;
                    f.renderList(d, e)
                },
                error: function(g, h) {
                    p3.displayError("Error getting dorms")
                }
            })
        },
        displayAllOn: function() {
            $(".type-desc").css("color", "#999");
            $(".type-icon").removeClass("p3icon-ok").addClass("p3icon-check");
            $(".all-desc").css("color", "#424242");
            $(".all-icon").removeClass("p3icon-check").addClass("p3icon-ok")
        },
        filterChange: function(f) {
            var d = $(f.currentTarget),
                h = $(".type-icon").length,
                g = $(".type-icon.p3icon-ok").length;
            if (d.find(".type-icon").hasClass("p3icon-ok")) {
                if (g === 1) {
                    this.displayAllOn();
                    this.getList("-1")
                } else {
                    $(".all-desc").css("color", "#999");
                    $(".all-icon").removeClass("p3icon-ok").addClass("p3icon-check");
                    d.find(".type-desc").css("color", "#999");
                    d.find(".type-icon").removeClass("p3icon-ok").addClass("p3icon-check");
                    this.getList(this.getSelectedTypes())
                }
            } else {
                if (h - g === 1) {
                    this.displayAllOn();
                    this.getList("-1")
                } else {
                    $(".all-desc").css("color", "#999");
                    $(".all-icon").removeClass("p3icon-ok").addClass("p3icon-check");
                    d.find(".type-desc").css("color", "#424242");
                    d.find(".type-icon").removeClass("p3icon-check").addClass("p3icon-ok");
                    this.getList(this.getSelectedTypes())
                }
            }
            f.preventDefault()
        },
        showAll: function(f) {
            var d = $(f.currentTarget);
            if (!d.find(".all-icon").hasClass("p3icon-ok")) {
                this.displayAllOn();
                this.getList("-1")
            }
            f.preventDefault()
        },
        getSelectedTypes: function() {
            var e = "",
                d;
            $(".type-filter").each(function() {
                if ($(this).find(".type-icon").hasClass("p3icon-ok")) {
                    d = $(this).data("value");
                    if (e.length > 0) {
                        e += ","
                    }
                    e += d
                }
            });
            if (e.length === 0) {
                e = "-1"
            }
            return e
        },
        yearChanged: function(d) {
            this.selectedYear = $("#year-dropdown").val();
            this.getList(this.getSelectedTypes())
        },
        levelChanged: function(d) {
            c.Data.levelNum = $("#level-dropdown").val();
            this.getList(this.getSelectedTypes())
        },
        manageLeaders: function(d) {
            var g = this,
                f = new c.Vs.BulkLeaders({
                    dorms: g.dorms,
                    leaderTypes: g.leaderTypes
                });
            p3.rV(f, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            f.on("ownerChange", function() {
                g.getList(g.getSelectedTypes())
            });
            d.preventDefault()
        }
    });
    c.Vs.BuildingView = Bb.View.extend({
        template: "dormmanagement/building.template.html",
        events: {
            "show .collapse": "showAccordion",
            "hide .collapse": "hideAccordion",
            "click .available-spots-button": "manageAvailableSpots",
            "click .residents-button": "showResidents",
            "click .manage-leaders-button": "manageLeaders",
            "click .room-sort": "updateSort"
        },
        initialize: function(d) {
            this.Containers = {};
            this.Sort = "DisplayName";
            this.SortDesc = false;
            this.haveNumbers = false
        },
        renderTemplate: function(f, d) {
            var g = this,
                e = g.options.building.get("Rooms");
            p3.fT(g.template, function(h) {
                g.$el.html(h({
                    building: g.options.building.toJSON(),
                    Sort: g.Sort,
                    SortDesc: g.SortDesc,
                    open: f || d
                }))
            });
            if (e && e.length > 0) {
                if (!f) {
                    g.setRoomAttributes(g.options.building)
                }
                e = g.sortRooms(e);
                g.Containers.RoomContainer = g.$(".room-table");
                if (g.Containers.RoomContainer.length > 0) {
                    g.renderRooms(e)
                } else {
                    window.setTimeout(function() {
                        g.Containers.RoomContainer = g.$(".room-table");
                        g.renderRooms(e)
                    }, 400)
                }
            }
        },
        render: function(d) {
            var e = this;
            $(d).append(this.el);
            e.renderTemplate(false, false)
        },
        renderRooms: function(e) {
            var h = this,
                f, d, g = function() {
                    h.updateBuilding()
                };
            for (d = 0; d < e.length; d++) {
                f = new c.Vs.RoomView({
                    room: e[d],
                    building: h.options.building
                });
                p3.rV(f, h.Containers.RoomContainer, false);
                f.on("roomChange", g)
            }
        },
        showAccordion: function(d) {
            p3.slideArrowS(this.$("I.change-arrow"))
        },
        hideAccordion: function(d) {
            p3.slideArrowE(this.$("I.change-arrow"))
        },
        manageAvailableSpots: function(g) {
            var i = this,
                d, h, f;
            if (i.options.filter === "-1") {
                d = i.options.building
            } else {
                f = new c.Cs.Dorms();
                f.fetch({
                    async: false,
                    data: {
                        schoolYear: $("#year-dropdown").val(),
                        filter: "-1",
                        levelNum: c.Data.levelNum
                    },
                    success: function() {
                        d = f.get(i.options.building.get("BuildingId"));
                        i.setRoomAttributes(d)
                    },
                    error: function(e, j) {
                        p3.displayError("Error getting dorms")
                    }
                })
            }
            h = new c.Vs.AvailableSpots({
                building: d
            });
            p3.rV(h, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            h.on("residentChange", function() {
                i.updateBuilding()
            });
            g.preventDefault()
        },
        showResidents: function(d) {
            var g = this,
                f;
            f = new c.Vs.ResidentList({
                building: g.options.building
            });
            p3.rV(f, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            f.on("residentChange", function() {
                g.updateBuilding()
            });
            d.preventDefault()
        },
        manageLeaders: function(d) {
            var g = this,
                f = new c.Vs.BuildingLeaders({
                    building: g.options.building,
                    leaderTypes: g.options.leaderTypes
                });
            p3.rV(f, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            f.on("ownerChange", function() {
                g.updateBuilding()
            });
            d.preventDefault()
        },
        setRoomAttributes: function(d) {
            var p = this,
                l, m = d.get("Rooms"),
                n, o, f, e, k, h, g = true;
            for (h = 0; h < m.length; h++) {
                n = "--";
                o = "";
                f = 0;
                l = m[h];
                if (!l.Name) {
                    l.DisplayName = l.Number
                } else {
                    if (l.Name !== l.Number) {
                        l.DisplayName = l.Number + " " + l.Name
                    } else {
                        l.DisplayName = l.Name
                    }
                }
                if (isNaN(l.Number)) {
                    g = false
                }
                if (l.Capacity && l.Capacity > 0) {
                    e = parseInt(l.Capacity, 10);
                    if (l.RoomEnrollment && l.RoomEnrollment > 0) {
                        f = l.RoomEnrollment
                    }
                    if (f > e) {
                        n = "Over";
                        o = "p3Red"
                    } else {
                        if (e === f) {
                            n = "Full"
                        } else {
                            n = "Available";
                            o = "p3Green"
                        }
                    }
                    if (l.RoomEnrollment < 0) {
                        l.RoomEnrollment = 0
                    }
                    for (k = 0; k < (l.Capacity - l.RoomEnrollment); k++) {
                        l.Residents.push({
                            StudentDisplay: "-- empty --"
                        })
                    }
                }
                l.Status = n;
                l.StatusClass = o
            }
            p.haveNumbers = g
        },
        sortRooms: function(e) {
            var f = this,
                d = "";
            e = _.sortBy(e, function(g) {
                switch (f.Sort) {
                    case "Status":
                        d = g.Status;
                        break;
                    case "Capacity":
                        d = g.Capacity;
                        break;
                    default:
                        if (f.haveNumbers) {
                            d = parseInt(g.Number, 10)
                        } else {
                            d = g.DisplayName
                        }
                }
                return d
            });
            if (this.SortDesc) {
                e.reverse()
            }
            return e
        },
        updateSort: function(f) {
            var h = this,
                d = $(f.currentTarget),
                g = d.data("sort");
            if (g !== undefined) {
                if (g === h.Sort) {
                    h.SortDesc = !h.SortDesc
                } else {
                    h.SortDesc = false
                }
                h.Sort = g;
                h.renderTemplate(true, false)
            }
            f.preventDefault()
        },
        updateBuilding: function() {
            var f = this,
                e = new c.Cs.Dorms(),
                d = f.options.building.get("BuildingId");
            e.fetch({
                data: {
                    schoolYear: $("#year-dropdown").val(),
                    filter: f.options.filter,
                    levelNum: c.Data.levelNum
                },
                success: function() {
                    f.options.building = e.get(d);
                    f.renderTemplate(false, true);
                    f.trigger("buildingChange", e)
                },
                error: function(g, h) {
                    p3.displayError("Error getting dorms")
                }
            })
        }
    });
    c.Vs.RoomView = Bb.View.extend({
        template: "dormmanagement/room.template.html",
        tagName: "tr",
        events: {
            "click .manage-residents": "manageResidents"
        },
        renderTemplate: function() {
            var d = this;
            p3.fT(d.template, function(e) {
                d.$el.html(e({
                    room: d.options.room
                }))
            })
        },
        render: function(d) {
            var e = this;
            $(d).append(this.el);
            e.renderTemplate()
        },
        manageResidents: function(d) {
            var g = this,
                f = new c.Vs.ManageResidents({
                    room: g.options.room,
                    building: g.options.building
                });
            p3.rV(f, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            f.on("residentChange", function() {
                g.trigger("roomChange")
            });
            d.preventDefault()
        }
    });
    c.Vs.ManageResidents = Bb.View.extend({
        template: "dormmanagement/manage.residents.template.html",
        events: {
            "click #add-resident-link": "addResidentRow",
            "click .remove-btn": "removeResidentRow",
            "click .btn-denied": "dropSelected",
            "click #btnSave": "saveResidents"
        },
        renderTemplate: function() {
            var g = this,
                e, d, f = g.options.room;
            g.collection = new c.Cs.ManageMembers();
            g.collection.fetch({
                data: {
                    sectionId: g.options.building.get("SectionId"),
                    associationId: 7
                },
                success: function() {
                    if (f.Residents && f.Residents.length > 0) {
                        for (e = 0; e < f.Residents.length; e++) {
                            if (f.Residents[e].UserId) {
                                d = g.collection.get(f.Residents[e].UserId);
                                f.Residents[e].enroll_date = d.get("enroll_date")
                            }
                        }
                    }
                    p3.fT(g.template, function(h) {
                        g.$el.html(h({
                            room: g.options.room,
                            building: g.options.building.toJSON(),
                            schoolYear: $("#year-dropdown").val(),
                            dropDate: a.getDateString(a.localDateTime())
                        }))
                    });
                    if ($(".add-resident-box").length > 0) {
                        p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.TokenInput, g.initializeTokenInput, {
                            context: g
                        })
                    } else {
                        window.setTimeout(function() {
                            p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.TokenInput, g.initializeTokenInput, {
                                context: g
                            })
                        }, 400)
                    }
                    b.Us.initialize(".date-input")
                }
            })
        },
        render: function(d) {
            var e = this;
            $(d).append(this.el);
            e.renderTemplate()
        },
        addResidentRow: function(d) {
            var f = "add-box-" + $("#resident-table tr").length;
            $("#resident-table").append('<tr class="add-resident-row"><td colspan="3"><input id="' + f + '" type="text" class="input-xlarge add-resident-box col-sm-4" style="margin:0px"></td></tr>');
            p3.setModalHeight(p3.Layout.Containers.Modal);
            this.initializeTokenInput({
                context: this
            }, f);
            d.preventDefault()
        },
        initializeTokenInput: function(g, d) {
            g = g || {};
            var i = g.context || this,
                f = i.collection.getMembers(),
                e = [],
                h;
            if (d) {
                h = "#" + d
            } else {
                h = ".add-resident-box"
            }
            f.each(function(k) {
                if (k.get("enrolled_ind") !== 1) {
                    var m = k.get("nickname"),
                        j = k.get("grad_year"),
                        l = k.get("lastname") + ", " + k.get("firstname") + ((m !== undefined && m !== null && m !== "") ? (" (" + m + ") ") : " ") + ((j !== "undefined" && j !== null && j !== "") ? (" '" + j.substring(2)) : (""));
                    e.push({
                        id: k.get("user_id"),
                        name: l
                    })
                }
            });
            $(h).tokenInput(e, {
                minChars: 2,
                searchDelay: 100,
                preventDuplicates: true,
                animateDropdown: false,
                placeholder: "-- Add a Resident --",
                classes: {
                    tokenList: "token-input-list typeAheadFauxFocus input-medium col-sm-4",
                    token: "token-input-token token-input-token-hide",
                    dropdown: "token-input-dropdown"
                },
                resultsFormatter: function(j) {
                    var k = "";
                    k += j.name;
                    return "<li>" + k + "</li>"
                },
                onAdd: function(k) {
                    var j = "";
                    this.parents("tr").data("id", k.id);
                    j = '<td width="27%">';
                    j += '<p style="margin:3px 0px 3px 0px">' + k.name + "</p>";
                    j += '</td><td width="33%">';
                    j += '<div class="muted text-muted" style="margin-top:3px;">Started: <span class="enroll-date-val">' + a.getDateString(a.localDateTime()) + "</span></div>";
                    j += '</td><td width="40%">';
                    j += '<div class="pull-right"><button type="button" class="btn btn-default remove-btn"><i class="p3icon-delete"></i></button></div>';
                    j += "</td>";
                    this.parents("tr").html(j);
                    p3.setModalHeight(p3.Layout.Containers.Modal);
                    b.Us.initialize(".date-picker")
                }
            });
            $(".add-resident-box").each(function() {
                $("#token-input-" + $(this).attr("id")).attr("placeholder", "Add a Resident")
            })
        },
        removeResidentRow: function(d) {
            $(d.currentTarget).parents("tr").remove()
        },
        dropSelected: function(g) {
            var f = $(g.currentTarget),
                d = f.parents("tr").find(".drop-details");
            if (f.attr("disabled") === undefined) {
                f.siblings().removeClass("active");
                if (f.hasClass("active")) {
                    f.removeClass("active");
                    d.hide()
                } else {
                    f.addClass("active");
                    if (!d.hasClass("in")) {
                        d.show()
                    }
                }
                b.Us.initialize(".date-picker");
                p3.setModalHeight(p3.Layout.Containers.Modal)
            }
        },
        saveResidents: function(d) {
            var m = this,
                h = [],
                l = true,
                f = false,
                k, j, i = m.options.room.RoomId,
                g = [];
            this.$el.find(".error").removeClass("error");
            $("#manage-roster-error-messages").html("").hide();
            $("#resident-table tr").each(function() {
                k = $(this).data("id");
                if ($(this).hasClass("add-resident-row")) {
                    if (k) {
                        f = true;
                        h.push({
                            UserId: k,
                            EnrollDate: $(this).find(".enroll-date-val").html(),
                            DeleteInd: false,
                            RoomId: i
                        })
                    }
                } else {
                    if ($(this).find(".btn-denied.active").length > 0) {
                        f = true;
                        h.push({
                            UserId: k,
                            EnrollDate: $(this).find(".enroll-date-val").html(),
                            DeleteInd: true,
                            RoomId: i,
                            DropType: $(this).find(".btn-denied.active").data("drop-type"),
                            DropComment: "",
                            DropDate: $(this).find(".date-picker").val()
                        });
                        if ($(this).find(".date-picker").val().length === 0) {
                            l = false;
                            $(this).find(".date-picker").addClass("error");
                            if (g.indexOf("A date is required in order to drop someone from the roster") === -1) {
                                g.push("A date is required in order to drop someone from the roster")
                            }
                        }
                    } else {
                        h.push({
                            UserId: k,
                            EnrollDate: $(this).find(".enroll-date-val").html(),
                            DeleteInd: false,
                            RoomId: i
                        })
                    }
                }
            });
            if (f) {
                if (l) {
                    j = new c.Ms.ResidentSave();
                    j.save({
                        sectionId: m.options.building.get("SectionId"),
                        members: h
                    }, {
                        success: function() {
                            m.trigger("residentChange");
                            p3.Layout.Containers.Modal.modal("hide")
                        },
                        error: function() {
                            p3.Us.InfoMessage.ErrorBox("An error was encountered while trying to save the resident changes.", "#manage-roster-error-messages", false);
                            $("#manage-roster-error-messages").show()
                        }
                    })
                } else {
                    _.each(g, function(e) {
                        p3.Us.InfoMessage.ErrorBox(e, "#manage-roster-error-messages", false)
                    });
                    if (g.length > 0) {
                        $("#manage-roster-error-messages").show()
                    }
                }
            } else {
                p3.Layout.Containers.Modal.modal("hide")
            }
        }
    });
    c.Vs.AvailableSpots = Bb.View.extend({
        template: "dormmanagement/available.spots.template.html",
        events: {
            "click #btnSave": "saveResidents"
        },
        renderTemplate: function() {
            var d = this;
            d.collection = new c.Cs.ManageMembers();
            d.collection.fetch({
                data: {
                    sectionId: d.options.building.get("SectionId"),
                    associationId: 7
                },
                success: function() {
                    p3.fT(d.template, function(e) {
                        d.$el.html(e({
                            building: d.options.building.toJSON(),
                            addDate: a.getDateString(a.localDateTime())
                        }))
                    });
                    if ($(".add-resident-box").length > 0) {
                        p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.TokenInput, d.initializeTokenInput, {
                            context: d
                        })
                    } else {
                        window.setTimeout(function() {
                            p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.TokenInput, d.initializeTokenInput, {
                                context: d
                            })
                        }, 400)
                    }
                }
            })
        },
        render: function(d) {
            var e = this;
            $(d).append(this.el);
            e.renderTemplate()
        },
        initializeTokenInput: function(f) {
            f = f || {};
            var g = f.context || this,
                e = g.collection.getMembers(),
                d = [];
            e.each(function(i) {
                if (i.get("enrolled_ind") !== 1) {
                    var k = i.get("nickname"),
                        h = i.get("grad_year"),
                        j = i.get("lastname") + ", " + i.get("firstname") + ((k !== undefined && k !== null && k !== "") ? (" (" + k + ") ") : " ") + ((h !== "undefined" && h !== null && h !== "") ? (" '" + h.substring(2)) : (""));
                    d.push({
                        id: i.get("user_id"),
                        name: j
                    })
                }
            });
            $(".add-resident-box").tokenInput(d, {
                minChars: 2,
                searchDelay: 100,
                preventDuplicates: true,
                animateDropdown: false,
                placeholder: "-- Add a Resident --",
                classes: {
                    tokenList: "token-input-list typeAheadFauxFocus input-medium",
                    token: "token-input-token token-input-token-hide",
                    dropdown: "token-input-dropdown"
                },
                resultsFormatter: function(h) {
                    var i = "";
                    i += h.name;
                    return "<li>" + i + "</li>"
                },
                onAdd: function(h) {
                    this.parents(".add-resident-row").data("id", h.id);
                    this.parents(".add-resident-row").html('<p style="margin:3px 0px 3px 0px">' + h.name + "</p>")
                }
            });
            $(".add-resident-box").each(function() {
                $("#token-input-" + $(this).attr("id")).attr("placeholder", "Add a Resident")
            })
        },
        saveResidents: function(f) {
            var l = this,
                i = [],
                h = false,
                k, j, d, g = a.getDateString(a.localDateTime());
            this.$el.find(".error").removeClass("error");
            $("#manage-roster-error-messages").html("").hide();
            $("#spots-table tr.room-row").each(function() {
                d = $(this).find(".resident-cell");
                j = d.data("id");
                d.find(".add-resident-row").each(function() {
                    if ($(this).data("id")) {
                        h = true;
                        i.push({
                            UserId: $(this).data("id"),
                            EnrollDate: g,
                            DeleteInd: false,
                            RoomId: j
                        })
                    }
                })
            });
            if (h) {
                k = new c.Ms.ResidentSave();
                k.save({
                    sectionId: l.options.building.get("SectionId"),
                    members: i
                }, {
                    success: function() {
                        l.trigger("residentChange");
                        p3.Layout.Containers.Modal.modal("hide")
                    },
                    error: function() {
                        p3.Us.InfoMessage.ErrorBox("An error was encountered while trying to save the resident changes.", "#manage-roster-error-messages", false);
                        $("#manage-roster-error-messages").show()
                    }
                })
            } else {
                p3.Layout.Containers.Modal.modal("hide")
            }
        }
    });
    c.Vs.BuildingLeaders = Bb.View.extend({
        template: "dormmanagement/building.leaders.template.html",
        events: {
            "click #btnSave": "saveLeaders",
            "click .head-button": "setHead"
        },
        renderTemplate: function() {
            var d = this;
            d.collection = new c.Cs.ManageMembers();
            d.collection.fetch({
                data: {
                    sectionId: d.options.building.get("SectionId"),
                    associationId: 7
                },
                success: function() {
                    p3.fT(d.template, function(e) {
                        d.$el.html(e({
                            building: d.options.building.toJSON(),
                            addDate: a.getDateString(a.localDateTime()),
                            leaderTypes: d.options.leaderTypes.toJSON()
                        }))
                    });
                    if ($("#add-leader-box").length > 0) {
                        p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.TokenInput, d.initializeTokenInput, {
                            context: d
                        })
                    } else {
                        window.setTimeout(function() {
                            p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.TokenInput, d.initializeTokenInput, {
                                context: d
                            })
                        }, 400)
                    }
                }
            })
        },
        render: function(d) {
            var e = this;
            $(d).append(this.el);
            e.renderTemplate()
        },
        initializeTokenInput: function(g) {
            g = g || {};
            var h = g.context || this,
                f = h.collection.getOwners(),
                e = [],
                d = (p3.Config.uiVersion === 3) ? "fa fa-trash" : "p3icon-delete";
            f.each(function(i) {
                if (i.get("enrolled_ind") !== 1) {
                    e.push({
                        id: i.get("user_id"),
                        name: i.get("firstname") + " " + i.get("lastname")
                    })
                }
            });
            $("#add-leader-box").tokenInput(e, {
                minChars: 2,
                searchDelay: 100,
                preventDuplicates: true,
                animateDropdown: false,
                classes: {
                    tokenList: "token-input-list typeAheadFauxFocus input-medium",
                    token: "token-input-token token-input-token-hide",
                    dropdown: "token-input-dropdown"
                },
                resultsFormatter: function(i) {
                    var j = "";
                    j += i.name;
                    return "<li>" + j + "</li>"
                },
                onAdd: function(j) {
                    var k, i = h.$(".head-button.active").length === 0;
                    k = '<tr class="leader-row" data-id="' + j.id + '">';
                    k += '<td><div class="btn btn-default btn-mini btn-denied pull-right remove-leader-button" data-toggle="button" style="margin-left:10px"><i class="' + d + '"></i></div><div class="btn btn-mini btn-default btn-approve pull-right ';
                    if (i) {
                        k += " active"
                    }
                    k += ' head-button" data-toggle="button" style="margin-left:10px"><i class="p3icon-check"></i> Head</div>';
                    k += '<div class="pull-right"><select class="input-medium form-control leader-type-dropdown" style="margin: 0px 10px 0px 0px">';
                    h.options.leaderTypes.each(function(l) {
                        k += '<option value="' + l.get("role") + '">' + l.get("role_type") + "</option>"
                    });
                    k += "</select></div> " + j.name + "</td></tr>";
                    $("#leader-table").append(k);
                    p3.setModalHeight(p3.Layout.Containers.Modal)
                }
            });
            $("#token-input-add-leader-box").attr("placeholder", "Search by name").css("min-width", "150px")
        },
        saveLeaders: function(i) {
            var m = this,
                k = [],
                j = false,
                l, g = $("#manage-roster-error-messages"),
                h, f, d;
            this.$el.find(".error").removeClass("error");
            g.html("").hide();
            $(".leader-row").each(function() {
                h = $(this);
                f = h.find(".leader-type-dropdown");
                d = h.find(".head-button");
                if (h.find(".remove-leader-button").hasClass("active")) {
                    k.push({
                        UserId: h.data("id"),
                        DeleteInd: true,
                        OwnerType: f.val()
                    })
                } else {
                    if (d.hasClass("active")) {
                        j = true
                    }
                    k.push({
                        UserId: h.data("id"),
                        DeleteInd: false,
                        Head: d.hasClass("active"),
                        OwnerType: f.val()
                    })
                }
            });
            if (j) {
                l = new c.Ms.ResidentSave();
                l.save({
                    sectionId: m.options.building.get("SectionId"),
                    members: k
                }, {
                    success: function() {
                        m.trigger("ownerChange");
                        p3.Layout.Containers.Modal.modal("hide")
                    },
                    error: function() {
                        p3.Us.InfoMessage.ErrorBox("An error was encountered while trying to save the resident changes.", g, false);
                        g.show().addClass("alert-danger")
                    }
                })
            } else {
                p3.Us.InfoMessage.ErrorBox("A head leader is required.", g, false);
                g.show().addClass("alert-danger")
            }
        },
        setHead: function(f) {
            var d = $(f.currentTarget);
            if (d.hasClass("active")) {
                f.stopPropagation();
                f.preventDefault()
            } else {
                $(".head-button").removeClass("active")
            }
        }
    });
    c.Vs.BulkLeaders = Bb.View.extend({
        template: "dormmanagement/bulk.leaders.template.html",
        events: {
            "click #btnSave": "saveLeaders",
            "click .head-button": "setHead"
        },
        renderTemplate: function() {
            var d = this;
            d.collection = new c.Cs.ManageMembers();
            d.collection.fetch({
                data: {
                    sectionId: d.options.dorms.models[0].get("SectionId"),
                    associationId: 7
                },
                success: function() {
                    p3.fT(d.template, function(e) {
                        d.$el.html(e({
                            dorms: d.options.dorms.toJSON(),
                            addDate: a.getDateString(a.localDateTime()),
                            leaderTypes: d.options.leaderTypes.toJSON()
                        }))
                    });
                    if ($(".add-leader-box").length > 0) {
                        p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.TokenInput, d.initializeTokenInput, {
                            context: d
                        })
                    } else {
                        window.setTimeout(function() {
                            p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.TokenInput, d.initializeTokenInput, {
                                context: d
                            })
                        }, 400)
                    }
                }
            })
        },
        render: function(d) {
            var e = this;
            $(d).append(this.el);
            e.renderTemplate()
        },
        initializeTokenInput: function(g) {
            g = g || {};
            var h = g.context || this,
                f = h.collection.getOwners(),
                e = [],
                d;
            h.options.dorms.each(function(i) {
                d = _.pluck(i.get("Leaders"), "UserId");
                e = [];
                f.each(function(j) {
                    if (d.indexOf(j.get("user_id")) === -1) {
                        e.push({
                            id: j.get("user_id"),
                            name: j.get("firstname") + " " + j.get("lastname")
                        })
                    }
                });
                $("#add-leader-box-" + i.get("SectionId")).tokenInput(e, {
                    minChars: 2,
                    searchDelay: 100,
                    preventDuplicates: true,
                    animateDropdown: false,
                    classes: {
                        tokenList: "token-input-list typeAheadFauxFocus input-medium",
                        token: "token-input-token token-input-token-hide",
                        dropdown: "token-input-dropdown"
                    },
                    resultsFormatter: function(j) {
                        var k = "";
                        k += j.name;
                        return "<li>" + k + "</li>"
                    },
                    onAdd: function(k) {
                        var l, j = $(".leader-table[data-id='" + i.get("SectionId") + "']").find(".head-button.active").length === 0;
                        l = '<tr class="leader-row" data-id="' + k.id + '">';
                        l += '<td><div class="btn btn-default btn-mini btn-denied pull-right remove-leader-button" data-toggle="button" style="margin-left:10px;"><i class="p3icon-delete"></i></div><div class="btn btn-default btn-mini btn-approve pull-right ';
                        if (j) {
                            l += " active"
                        }
                        l += ' head-button" data-toggle="button" style="margin-left:10px;"><i class="p3icon-check"></i> Head</div>';
                        l += '<div class="pull-right"><select class="input-medium form-control leader-type-dropdown" style="margin: 0px 10px 0px 0px">';
                        h.options.leaderTypes.each(function(m) {
                            l += '<option value="' + m.get("role") + '">' + m.get("role_type") + "</option>"
                        });
                        l += "</select></div> " + k.name + "</td></tr>";
                        $("#empty-row-" + i.get("SectionId")).remove();
                        $(".leader-table[data-id='" + i.get("SectionId") + "']").append(l);
                        p3.setModalHeight(p3.Layout.Containers.Modal)
                    }
                });
                $("#token-input-add-leader-box-" + i.get("SectionId")).attr("placeholder", "Type a name")
            })
        },
        saveLeaders: function(j) {
            var o = this,
                k = [],
                n = true,
                l, m, d = $("#manage-roster-error-messages"),
                h, g, i, f;
            d.html("").hide();
            $(".leader-table").each(function() {
                h = $(this);
                g = h.find(".leader-row");
                if (g.length > 0) {
                    if (h.find(".head-button.active").length > 0) {
                        m = h.data("id");
                        g.each(function() {
                            f = $(this);
                            i = f.find(".leader-type-dropdown");
                            if (f.find(".remove-leader-button").hasClass("active")) {
                                k.push({
                                    UserId: f.data("id"),
                                    DeleteInd: true,
                                    OwnerType: i.val(),
                                    SectionId: m
                                })
                            } else {
                                k.push({
                                    UserId: f.data("id"),
                                    DeleteInd: false,
                                    Head: f.find(".head-button").hasClass("active"),
                                    OwnerType: i.val(),
                                    SectionId: m
                                })
                            }
                        })
                    } else {
                        n = false
                    }
                }
            });
            if (n) {
                l = new c.Ms.ResidentSave();
                l.save({
                    members: k
                }, {
                    success: function() {
                        o.trigger("ownerChange");
                        p3.Layout.Containers.Modal.modal("hide")
                    },
                    error: function() {
                        p3.Us.InfoMessage.ErrorBox("An error was encountered while trying to save the leader changes.", d, false);
                        d.show().addClass("alert-danger")
                    }
                })
            } else {
                p3.Us.InfoMessage.ErrorBox("A head leader is required for each building.", d, false);
                d.show().addClass("alert-danger")
            }
        },
        setHead: function(f) {
            var d = $(f.currentTarget);
            if (d.hasClass("active")) {
                f.stopPropagation();
                f.preventDefault()
            } else {
                d.parents("tbody").find(".head-button").removeClass("active")
            }
        }
    });
    c.Vs.ResidentList = Bb.View.extend({
        template: "dormManagement/resident.list.template.html",
        events: {
            "click .btn-denied": "dropSelected",
            "click #btnSave": "saveResidents",
            "click .resident-sort": "updateSort",
            "click #print-button": "printResidents",
            "change .room-dropdown": "roomChange"
        },
        initialize: function() {
            this.Sort = "RoomDisplay";
            this.SortDesc = false;
            this.haveNumbers = false
        },
        renderTemplate: function() {
            var d = this;
            p3.fT(d.template, function(e) {
                d.$el.html(e({
                    building: d.options.building.toJSON(),
                    schoolYear: $("#year-dropdown").val(),
                    dropDate: a.getDateString(a.localDateTime()),
                    residents: d.residents,
                    Sort: d.Sort,
                    SortDesc: d.SortDesc,
                    haveNoRoom: d.haveNoRoom
                }))
            });
            if ($("#add-resident-box").length > 0) {
                p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.TokenInput, d.initializeTokenInput, {
                    context: d
                })
            } else {
                window.setTimeout(function() {
                    p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.TokenInput, d.initializeTokenInput, {
                        context: d
                    })
                }, 400)
            }
            b.Us.initialize(".date-input")
        },
        buildResidentList: function() {
            var k = this,
                e, f, g = [],
                h = k.options.building.get("Rooms"),
                d = true;
            k.collection = new c.Cs.ManageMembers();
            k.collection.fetch({
                async: false,
                data: {
                    sectionId: k.options.building.get("SectionId"),
                    associationId: 7
                },
                success: function() {
                    for (e = 0; e < h.length; e++) {
                        if (isNaN(h[e].Number)) {
                            d = false
                        }
                        for (f = 0; f < h[e].Residents.length; f++) {
                            if (h[e].Residents[f].UserId > 0) {
                                g.push({
                                    StudentDisplay: h[e].Residents[f].StudentDisplay,
                                    UserId: h[e].Residents[f].UserId,
                                    RoomDisplay: h[e].DisplayName,
                                    RoomId: h[e].RoomId,
                                    RoomNumber: h[e].Number,
                                    RoomName: h[e].Name
                                })
                            }
                        }
                        if (h[e].RoomId === 0) {
                            k.haveNoRoom = true
                        }
                    }
                    k.residents = g;
                    k.haveNumbers = d
                }
            })
        },
        orderResidents: function() {
            var e = this,
                d;
            e.residents = _.sortBy(e.residents, function(f) {
                switch (e.Sort) {
                    case "StudentDisplay":
                        d = f.StudentDisplay;
                        break;
                    default:
                        if (e.haveNumbers) {
                            d = parseInt(f.RoomNumber, 10)
                        } else {
                            d = f.RoomDisplay
                        }
                }
                return d
            });
            if (e.SortDesc) {
                e.residents.reverse()
            }
        },
        render: function(d) {
            var e = this;
            $(d).append(this.el);
            e.buildResidentList();
            e.orderResidents();
            e.renderTemplate()
        },
        dropSelected: function(g) {
            var f = $(g.currentTarget),
                d = f.parents("tr").find(".drop-details");
            if (f.attr("disabled") === undefined) {
                f.siblings().removeClass("active");
                if (f.hasClass("active")) {
                    f.removeClass("active");
                    d.hide()
                } else {
                    f.addClass("active");
                    if (!d.hasClass("in")) {
                        d.show()
                    }
                }
                b.Us.initialize(".date-picker");
                p3.setModalHeight(p3.Layout.Containers.Modal);
                g.preventDefault();
                g.stopPropagation()
            }
        },
        saveResidents: function(d) {
            var n = this,
                i = [],
                m = true,
                g = false,
                l, k, h = [],
                f, j;
            this.$el.find(".error").removeClass("error");
            $("#manage-roster-error-messages").html("").hide();
            $("#resident-table .existing-resident-row").each(function() {
                l = $(this).data("id");
                f = n.collection.get(l);
                j = parseInt($(this).find(".room-dropdown").val(), 10);
                if ($(this).find(".btn-denied.active").length > 0) {
                    g = true;
                    i.push({
                        UserId: l,
                        EnrollDate: f.get("enroll_date"),
                        DeleteInd: true,
                        RoomId: $(this).data("room"),
                        DropType: $(this).find(".btn-denied.active").data("drop-type"),
                        DropComment: "",
                        DropDate: $(this).find(".date-picker").val()
                    });
                    if ($(this).find(".date-picker").val().length === 0) {
                        m = false;
                        $(this).find(".date-picker").addClass("error");
                        if (h.indexOf("A date is required in order to drop someone from the roster") === -1) {
                            h.push("A date is required in order to drop someone from the roster")
                        }
                    }
                } else {
                    if ($(this).data("room") !== j) {
                        g = true;
                        i.push({
                            UserId: l,
                            EnrollDate: f.get("enroll_date"),
                            DeleteInd: false,
                            RoomId: j || null
                        })
                    }
                }
            });
            $("#resident-table .new-resident-row").each(function() {
                g = true;
                l = $(this).data("id");
                j = parseInt($(this).find(".room-dropdown").val(), 10);
                i.push({
                    UserId: l,
                    EnrollDate: a.getDateString(a.localDateTime()),
                    DeleteInd: false,
                    RoomId: j || null
                })
            });
            if (g) {
                if (m) {
                    k = new c.Ms.ResidentSave();
                    k.save({
                        sectionId: n.options.building.get("SectionId"),
                        members: i
                    }, {
                        success: function() {
                            n.trigger("residentChange");
                            p3.Layout.Containers.Modal.modal("hide")
                        },
                        error: function() {
                            p3.Us.InfoMessage.ErrorBox("An error was encountered while trying to save the resident changes.", "#manage-roster-error-messages", false);
                            $("#manage-roster-error-messages").show()
                        }
                    })
                } else {
                    _.each(h, function(e) {
                        p3.Us.InfoMessage.ErrorBox(e, "#manage-roster-error-messages", false)
                    });
                    if (h.length > 0) {
                        $("#manage-roster-error-messages").show()
                    }
                }
            } else {
                p3.Layout.Containers.Modal.modal("hide")
            }
        },
        updateSort: function(f) {
            var h = this,
                d = $(f.currentTarget),
                g = d.data("sort");
            if (g !== undefined) {
                if (g === h.Sort) {
                    h.SortDesc = !h.SortDesc
                } else {
                    h.SortDesc = false
                }
                h.Sort = g;
                h.orderResidents();
                h.renderTemplate()
            }
            f.preventDefault()
        },
        printResidents: function(d) {
            var g = this,
                f;
            $("#print-area").empty();
            g.frame = $('<iframe id="print-frame" border="0" frameborder="0" name="print-frame" height="100%" width="100%"><html></html></iframe>');
            $(".edit-cell").hide();
            $(".resident-sort").hide();
            $(".print-header").show();
            $(".room-dropdown").hide();
            $(".room-display").show();
            f = '<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><title>' + g.options.building.get("BuildingName") + ' Residents</title><link rel="stylesheet" type="text/css" href="/app/src/css/p3._global.css"><link type="text/css" rel="stylesheet" href="/ftpimages/999/podium/libs/bootstrap/2.0.4/css/bootstrap.css"><link rel="stylesheet" type="text/css" href="/app/src/css/p3.bootstrap.css"></head><body>' + $("#resident-list").html() + "</body></html>";
            g.frame.load(function() {
                $(this).contents().find("html").html(f)
            }).appendTo("#print-area");
            window.setTimeout(function() {
                window.frames["print-frame"].focus();
                window.frames["print-frame"].print();
                $("#print-area").empty()
            }, 200);
            $(".edit-cell").show();
            $(".resident-sort").show();
            $(".print-header").hide();
            $(".room-dropdown").show();
            $(".room-display").hide()
        },
        roomChange: function(f) {
            var n = this,
                d = $(f.currentTarget),
                m = d.data("id"),
                j = parseInt(d.val(), 10),
                l = n.options.building.get("Rooms"),
                k, h, g;
            if (j === 0) {
                k = 0;
                h = "No Room"
            } else {
                for (g = 0; g < l.length; g++) {
                    if (l[g].RoomId === j) {
                        k = l[g].Number;
                        h = l[g].DisplayName;
                        break
                    }
                }
            }
            d.siblings(".room-display").html(h);
            for (g = 0; g < n.residents.length; g++) {
                if (n.residents[g].UserId === m) {
                    n.residents[g].RoomId = j;
                    n.residents[g].RoomNumber = k;
                    n.residents[g].RoomDisplay = h;
                    break
                }
            }
        },
        initializeTokenInput: function(f) {
            f = f || {};
            var g = f.context || this,
                e = g.collection.getMembers(),
                d = [];
            e.each(function(i) {
                if (i.get("enrolled_ind") !== 1) {
                    var k = i.get("nickname"),
                        h = i.get("grad_year"),
                        j = i.get("lastname") + ", " + i.get("firstname") + ((k !== undefined && k !== null && k !== "") ? (" (" + k + ") ") : " ") + ((h !== "undefined" && h !== null && h !== "") ? (" '" + h.substring(2)) : (""));
                    d.push({
                        id: i.get("user_id"),
                        name: j
                    })
                }
            });
            $("#add-resident-box").tokenInput(d, {
                minChars: 2,
                searchDelay: 100,
                preventDuplicates: true,
                animateDropdown: false,
                placeholder: "-- Add a Resident --",
                classes: {
                    tokenList: "token-input-list typeAheadFauxFocus input-medium",
                    token: "token-input-token token-input-token-hide",
                    dropdown: "token-input-dropdown"
                },
                resultsFormatter: function(h) {
                    var i = "";
                    i += h.name;
                    return "<li>" + i + "</li>"
                },
                onAdd: function(j) {
                    var h, l = g.options.building.get("Rooms"),
                        k = '<tr class="new-resident-row" data-id="' + j.id + '">';
                    k += '<td><select class="room-dropdown input-small" data-id="' + j.id + '">';
                    for (h = 0; h < l.length; h++) {
                        if (l[h].RoomId > 0) {
                            k += '<option value="' + l[h].RoomId + '">' + l[h].DisplayName + "</option>"
                        }
                    }
                    k += '<option value="0" selected="selected">No Room</option></select>';
                    k += '<p style="margin:3px 0px 3px 0px;display: none;" class="room-display">No Room</p></td>';
                    k += '<td><p style="margin:3px 0px 3px 0px">' + j.name + "</p>";
                    k += "</td><td></td></tr>";
                    $("#resident-table").append(k);
                    p3.setModalHeight(p3.Layout.Containers.Modal)
                }
            });
            $("#token-input-add-resident-box").attr("placeholder", "Add a Resident")
        }
    });
    p3.router().route("Dorms", "Dorms", function() {
        p3.renderMainPage(new c.Vs.LayoutView({}))
    })
}(p3.module("lms/dormmanagement")));
(function(j) {
    var g = p3.module("shared/datepicker"),
        k = p3.module("cms/shared/link"),
        q = p3.module("cms/shared/text"),
        h = p3.module("cms/shared/download"),
        l = p3.module("cms/shared/media"),
        a = p3.module("LMS/academicclass"),
        f = p3.Us.Culture,
        e = p3.module("cms/shared/content"),
        c = p3.module("cms/shared/announcement"),
        m = p3.module("cms/shared/news"),
        i = p3.module("cms/shared/event"),
        o = p3.module("lms/rssreader"),
        n = p3.module("cms/shared/photo"),
        d = p3.module("cms/shared/audio"),
        r = p3.module("cms/shared/video"),
        b = p3.module("lms/academiccontent"),
        p = p3.module("LMS/teampage");
    j.Data = {};
    j.Cs.Section = Bbc.extend({
        initialize: function(s, t) {
            this.sectionId = t.sectionId || 0;
            this.associationId = t.associationId || 0
        },
        url: function() {
            return aP + "datadirect/SectionInfoView/?format=json&sectionId=" + this.sectionId + "&associationId=" + this.associationId
        }
    });
    j.Ms.Content = Bbm.extend({
        idAttribute: "ContentId"
    });
    j.Cs.Content = Bbc.extend({
        model: j.Ms.Content,
        initialize: function(s, t) {
            this.sectionId = t.sectionId || 0;
            this.leadSectionId = t.leadSectionId || 0
        },
        url: function() {
            return aP + "datadirect/GroupPossibleContentGet/?format=json&leadSectionId=" + this.leadSectionId
        }
    });
    j.Cs.BulletinBoardContent = Bbc.extend({
        initialize: function(s, t) {
            this.sectionId = t.sectionId || 0;
            this.associationId = t.associationId || 0;
            this.pendingInd = t.pendingInd || false
        },
        url: function() {
            return aP + "datadirect/BulletinBoardContentGet/?format=json&sectionId=" + this.sectionId + "&associationId=" + this.associationId + "&pendingInd=" + this.pendingInd
        }
    });
    j.Ms.LayoutSave = Bbm.extend({
        url: function() {
            return aP + "bulletinboard/LayoutSave/?format=json"
        }
    });
    j.Ms.Sections = Bbm.extend({
        idAttribute: "SectionId",
        url: function() {
            return ""
        }
    });
    j.Cs.Sections = Bbc.extend({
        model: j.Ms.Sections,
        initialize: function(s, t) {
            this.sectionId = t.sectionId || 0
        },
        url: function() {
            return aP + "datadirect/SectionsForTeacher/?format=json"
        }
    });
    j.Cs.ExistingSchoolYears = Bbc.extend({
        url: "datadirect/SchoolYearsGet/"
    });
    j.Cs.ExistingSections = Bbc.extend({
        url: "datadirect/AssignmentSectionsForTeacher/"
    });
    j.Cs.ExistingSectionContent = Bbc.extend({
        url: "datadirect/ExistingSectionContent/"
    });
    j.Ms.ImportContent = Bbm.extend({
        url: function() {
            return aP + "content/importexistingcontent/?format=json"
        }
    });
    j.Cs.DefaultLayouts = Bbc.extend({
        url: "bulletinboard/DefaultBulletinBoardsGet/"
    });
    j.Cs.BulletinBoardLayout = Bbc.extend({
        url: "bulletinboard/BulletinBoardLayoutGet/"
    });
    j.Cs.PossibleContent = Bbc.extend({
        url: "bulletinboard/BulletinBoardPossibleContentGet/"
    });
    j.Ms.DefaultLayoutSave = Bbm.extend({
        idAttribute: "BulletinBoardLayoutId",
        url: function() {
            return aP + "bulletinboard/BulletinBoardDefaultLayoutSave/?format=json"
        }
    });
    j.Ms.RemoveDefault = Bbm.extend({
        idAttribute: "BulletinBoardLayoutId",
        url: function() {
            return aP + "bulletinboard/BulletinBoardRemoveDefault/?format=json&bulletinBoardLayoutId=" + this.get("BulletinBoardLayoutId")
        }
    });
    j.Ms.CreateDefault = Bbm.extend({
        url: function() {
            return aP + "bulletinboard/BulletinBoardCreateDefault/?format=json"
        }
    });
    j.Ms.WidgetCreate = Bbm.extend({
        idAttribute: "WidgetId",
        url: function() {
            return aP + "widget/create/?format=json"
        }
    });
    j.Ms.WidgetUpdate = Bbm.extend({
        idAttribute: "WidgetId",
        url: function() {
            return aP + "widget/update/" + this.get("WidgetId") + "/?format=json"
        }
    });
    j.Ms.WidgetDelete = Bbm.extend({
        idAttribute: "Id",
        url: function() {
            return aP + "widget/delete/" + this.get("Id") + "/?format=json"
        }
    });
    j.Ms.Widget = Bbm.extend({
        url: function() {
            return aP + "widget/WidgetGet/"
        }
    });
    j.Vs.EditDetail = Bb.View.extend({
        template: "grouppage/detail.edit.template.html",
        events: {
            "click #expand-channels-button": "expandChannels",
            "click #collapse-channels-button": "collapseChannels"
        },
        initialize: function() {
            this.Containers = {}
        },
        dispose: function() {
            p3.closeFixedSidebar();
            p3.closeFixedFooter()
        },
        render: function(s) {
            var t = this;
            $(s).html(t.el);
            p3.fT(t.template, function(v) {
                t.$el.html(v({}));
                t.Containers.WorkspaceWrap = $(".group-page-wrap");
                t.Containers.Workspace = $("#group-workspace");
                t.registrations = new i.Cs.Registrations();
                t.registrations.fetch({
                    error: function() {
                        p3.displayError("Error loading event registrations")
                    }
                });
                t.buildings = new i.Cs.Buildings();
                t.buildings.fetch({
                    error: function() {
                        p3.displayError("Error loading buildings")
                    }
                });
                var u = new j.Cs.Section({}, {
                    sectionId: t.options.leadSectionId,
                    associationId: t.options.associationId
                });
                u.fetch({
                    error: function() {
                        p3.displayError("Error loading section information")
                    },
                    success: function() {
                        t.isOwner = false;
                        u.each(function(w) {
                            if (w.get("Id") === parseInt(t.options.leadSectionId, 10)) {
                                t.GroupName = w.get("GroupName");
                                t.Identifier = w.get("Identifier");
                                if (w.get("Block") !== "Random") {
                                    t.Block = w.get("Block")
                                }
                                t.isManager = w.get("IsManager");
                                if (w.get("PendingLayoutId") !== null) {
                                    t.LayoutId = w.get("PendingLayoutId");
                                    t.pendingInd = true
                                } else {
                                    t.LayoutId = w.get("LayoutId");
                                    t.pendingInd = false
                                }
                            }
                            if (w.get("IsOwner")) {
                                t.isOwner = true
                            }
                        });
                        t.renderFooter();
                        t.selectedContent = new j.Cs.BulletinBoardContent({}, {
                            sectionId: t.options.leadSectionId,
                            associationId: t.options.associationId,
                            pendingInd: t.pendingInd
                        });
                        t.selectedContent.fetch({
                            error: function() {
                                p3.displayError("Error loading selected content")
                            },
                            success: function() {
                                t.renderSidebar();
                                t.renderBuilder()
                            }
                        })
                    }
                })
            })
        },
        renderSidebar: function() {
            var t = this,
                s = {};
            t.options.sidebarView = new j.Vs.Sidebar({
                parentView: t,
                sectionId: t.options.sectionId,
                associationId: t.options.associationId,
                leadSectionId: t.options.leadSectionId,
                GroupName: t.GroupName,
                Identifier: t.Identifier,
                Block: t.Block,
                isOwner: t.isOwner,
                LayoutId: t.LayoutId,
                selectedContent: t.selectedContent,
                isManager: t.isManager
            });
            p3.renderFixedSidebar(t.options.sidebarView, s);
            t.options.sidebarView.on("layoutChange", function(u) {
                t.LayoutId = u;
                t.pendingInd = true;
                t.selectedContent.pendingInd = true;
                t.selectedContent.fetch({
                    error: function() {
                        p3.displayError("Error loading selected content")
                    },
                    success: function() {
                        t.renderBuilder()
                    }
                });
                t.renderFooter()
            });
            t.options.sidebarView.on("dataImported", function(w) {
                if (w && w.length > 0) {
                    var v = t.builder.getLayoutOrder(0, 0, 0),
                        u, x;
                    if (w.length > 1) {
                        for (u = 0; u < v.length; u++) {
                            if (v[u].RowIndex === 0 && v[u].ColumnIndex === 0) {
                                v[u].CellIndex += w.length - 1
                            }
                        }
                    }
                    for (u = 0; u < w.length; u++) {
                        v.push({
                            ContentId: w[u],
                            ContentIndexId: 0,
                            RowIndex: 0,
                            ColumnIndex: 0,
                            CellIndex: u
                        })
                    }
                    x = new j.Ms.LayoutSave({
                        SectionId: t.options.leadSectionId,
                        AssociationId: t.options.associationId,
                        LayoutId: t.layoutId,
                        ChangeLayout: false,
                        PendingInd: true,
                        ContentItems: v
                    });
                    x.save({}, {
                        success: function(y, z) {
                            t.pendingInd = true;
                            t.selectedContent.pendingInd = true;
                            t.selectedContent.fetch({
                                error: function() {
                                    p3.displayError("Error loading selected content")
                                },
                                success: function() {
                                    t.renderSidebar();
                                    t.renderBuilder()
                                }
                            });
                            t.renderFooter()
                        },
                        error: function(y, z) {
                            p3.displayError("Error changing layout")
                        }
                    })
                } else {
                    t.renderBuilder()
                }
            })
        },
        renderBuilder: function() {
            var t = this,
                s;
            s = new j.Vs.Builder({
                layoutId: t.LayoutId,
                content: t.selectedContent,
                leadSectionId: t.options.leadSectionId,
                associationId: t.options.associationId,
                sectionId: t.options.sectionId,
                isOwner: t.isOwner,
                isManager: t.isManager,
                buildings: t.buildings,
                registrations: t.registrations
            });
            t.builder = s;
            p3.rV(s, t.Containers.Workspace, true);
            s.on("contentChange", function() {
                t.pendingInd = true;
                t.selectedContent.pendingInd = true;
                t.selectedContent.fetch({
                    error: function() {
                        p3.displayError("Error loading selected content")
                    },
                    success: function() {
                        t.renderBuilder()
                    }
                });
                t.renderFooter()
            });
            s.on("contentRemoved", function() {
                t.pendingInd = true;
                t.selectedContent.pendingInd = true;
                t.selectedContent.fetch({
                    error: function() {
                        p3.displayError("Error loading selected content")
                    },
                    success: function() {
                        t.renderSidebar()
                    }
                });
                t.renderFooter()
            });
            s.on("contentMove", function() {
                t.pendingInd = true;
                t.renderFooter()
            })
        },
        renderFooter: function() {
            var t = this,
                s;
            s = new j.Vs.Footer({
                leadSectionId: t.options.leadSectionId,
                sectionId: t.options.sectionId,
                pendingInd: t.pendingInd,
                associationId: t.options.associationId,
                layoutId: t.LayoutId
            });
            p3.renderFixedFooter(s);
            s.on("pendingCleared", function(u) {
                t.pendingInd = false;
                if (!u) {
                    var v = new j.Cs.Section({}, {
                        sectionId: t.options.leadSectionId,
                        associationId: t.options.associationId
                    });
                    v.fetch({
                        async: false,
                        error: function() {
                            p3.displayError("Error loading section information")
                        },
                        success: function() {
                            v.each(function(w) {
                                if (w.get("Id") === parseInt(t.options.sectionId, 10)) {
                                    t.LayoutId = w.get("LayoutId")
                                }
                            })
                        }
                    });
                    t.selectedContent.pendingInd = false;
                    t.selectedContent.fetch({
                        error: function() {
                            p3.displayError("Error loading selected content")
                        },
                        success: function() {
                            t.renderBuilder();
                            t.renderSidebar()
                        }
                    })
                }
                t.renderFooter()
            })
        },
        expandChannels: function(s) {
            $(".pages-layout-block-detail").show();
            $(".content-filter-options").show();
            return false
        },
        collapseChannels: function(s) {
            $(".pages-layout-block-detail").hide();
            $(".content-filter-options").hide();
            return false
        }
    });
    j.Vs.Footer = Bb.View.extend({
        template: "grouppage/footer.template.html",
        events: {
            "click #btn-cancel-pending": "cancelClick",
            "click #btn-publish": "publishClick",
            "click #btn-publish-view": "publishViewClick"
        },
        render: function(s) {
            var t = this;
            $(s).html(t.el);
            t.renderTemplate()
        },
        renderTemplate: function() {
            var s = this;
            p3.fT(s.template, function(t) {
                s.$el.html(t({
                    leadSectionId: s.options.leadSectionId,
                    sectionId: s.options.sectionId,
                    pendingInd: s.options.pendingInd,
                    association: s.options.associationId,
                    layoutId: s.options.layoutId
                }))
            })
        },
        cancelClick: function() {
            this.savePendingStatus(false, true, false)
        },
        publishClick: function() {
            this.savePendingStatus(true, false, false)
        },
        publishViewClick: function() {
            this.savePendingStatus(true, false, true)
        },
        savePendingStatus: function(u, s, t) {
            var w = this,
                v;
            v = new j.Ms.LayoutSave({
                SectionId: w.options.leadSectionId,
                AssociationId: w.options.associationId,
                PendingInd: false,
                CancelPending: s,
                PublishBulletinBoard: u
            });
            v.save({}, {
                success: function(x, y) {
                    if (t) {
                        p3.router().navigate(j.Us.getBulletinBoardUrl(w.options.associationId, w.options.sectionId), true)
                    } else {
                        w.trigger("pendingCleared", u)
                    }
                },
                error: function(x, y) {
                    p3.displayError("Error saving layout")
                }
            })
        }
    });
    j.Vs.Sidebar = Bb.View.extend({
        template: "grouppage/sidebar.template.html",
        className: "workspace-sidebar",
        events: {
            "click .page-layout-link": "saveLayoutChange",
            "click #import-button": "openImportDialog"
        },
        initialize: function() {
            this.Containers = {};
            this.schoolYears = new j.Cs.ExistingSchoolYears();
            this.schoolYears.fetch({
                error: function() {
                    p3.displayError("Error loading schoolYears")
                }
            })
        },
        render: function(s) {
            var u = this,
                t;
            $(s).html(u.el);
            t = new j.Cs.Content({}, {
                sectionId: u.options.sectionId,
                leadSectionId: u.options.leadSectionId
            });
            t.fetch({
                error: function() {
                    p3.displayError("Error loading available content")
                },
                success: function() {
                    var x = [],
                        w, v;
                    w = u.options.selectedContent.pluck("ContentId");
                    if (u.options.associationId.toString() === "2") {
                        w.push(268)
                    }
                    t.each(function(y) {
                        if (y.get("ShowContentType")) {
                            if (w.indexOf(y.get("ContentId")) === -1) {
                                v = e.Us.findContentById(y.get("ContentId"));
                                if (v) {
                                    x.push({
                                        Id: y.get("ContentId"),
                                        Name: v.Name,
                                        IconClass: v.IconClass
                                    })
                                }
                            }
                        }
                    });
                    u.unusedContent = x;
                    u.renderTemplate()
                }
            })
        },
        renderTemplate: function() {
            var s = this;
            p3.fT(s.template, function(v) {
                var u = j.Us.getLayoutIcon(s.options.LayoutId),
                    w = j.Us.getBulletinBoardUrl(s.options.associationId, s.options.sectionId),
                    t = [];
                t.push({
                    Id: 408,
                    Name: "Horizontal Line",
                    IconClass: "p3icon-line"
                });
                t.push({
                    Id: 407,
                    Name: "Spacer",
                    IconClass: "p3icon-spacer"
                });
                s.$el.html(v({
                    sectionId: s.options.sectionId,
                    GroupName: s.options.GroupName,
                    Identifier: s.options.Identifier,
                    Block: s.options.Block,
                    isOwner: s.options.isOwner,
                    groupLink: w,
                    elements: t,
                    unusedContent: s.unusedContent,
                    layoutIcon: u,
                    canEdit: s.options.isOwner || s.options.isManager
                }));
                if (s.options.isOwner || s.options.isManager) {
                    j.Us.initDraggable()
                }
            })
        },
        saveLayoutChange: function(t) {
            var w = this,
                s = $(t.currentTarget),
                u = s.data("id"),
                v;
            $(".btn-group").removeClass("open");
            if (u !== w.options.LayoutId) {
                $("#selected-layout-icon").removeClass().addClass(s.find("i").attr("class"));
                v = new j.Ms.LayoutSave({
                    SectionId: w.options.leadSectionId,
                    AssociationId: w.options.associationId,
                    LayoutId: u,
                    ChangeLayout: true,
                    PendingInd: true
                });
                v.save({}, {
                    async: false,
                    success: function(x, y) {
                        w.options.LayoutId = u;
                        w.trigger("layoutChange", u)
                    },
                    error: function(x, y) {
                        p3.displayError("Error changing layout")
                    }
                })
            }
            return false
        },
        openImportDialog: function() {
            var v = this,
                t, s, u;
            t = new j.Vs.ImportContent({
                schoolYears: v.schoolYears,
                currentSections: j.Data.sections,
                leadSectionId: v.options.leadSectionId,
                associationId: v.options.associationId
            });
            t.on("save", function(w) {
                var x = [];
                for (s = 0; s < w.length; s++) {
                    for (u = 0; u < v.unusedContent.length; u++) {
                        if (v.unusedContent[u].Id === w[s]) {
                            x.push(w[s]);
                            break
                        }
                    }
                }
                v.trigger("dataImported", x)
            });
            p3.rV(t, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            return false
        }
    });
    j.Vs.Builder = Bb.View.extend({
        template: "grouppage/builder.template.html",
        events: {
            "click .pages-layout-block-delete": "deleteContent",
            "click .block-options": "editOptions"
        },
        initialize: function() {
            this.Containers = {}
        },
        render: function(s) {
            var t = this;
            $(s).html(t.el);
            t.renderTemplate()
        },
        renderTemplate: function() {
            var t = this,
                s = j.Us.buildRows(t.options.layoutId);
            p3.fT(t.template, function(y) {
                t.$el.html(y({
                    rows: s
                }));
                var u = $("#group-workspace"),
                    x, w, v;
                u.css({
                    "background-color": "rgb(242,249,255)",
                    "background-image": "linear-gradient(90deg, transparent 28px, rgba(255,255,255,61) 38px)",
                    "background-size": "38px"
                });
                x = new j.Cs.Sections({}, {
                    sectionId: t.options.leadSectionId
                });
                j.Data.sections = x;
                if (t.options.isOwner) {
                    w = 0
                } else {
                    if (t.options.isManager) {
                        w = 1
                    } else {
                        w = 2
                    }
                }
                x.fetch({
                    async: false,
                    data: {
                        sectionId: t.options.leadSectionId,
                        filterInd: w
                    },
                    success: function() {
                        if (x.length > 0) {
                            var z = -1;
                            x.each(function(A) {
                                if (A.get("SectionId") === parseInt(t.options.leadSectionId, 10)) {
                                    A.set("Primary", true)
                                }
                                if (A.get("ContextLabelId") !== z) {
                                    A.set("GroupHead", A.get("Association"));
                                    A.set("ShowHead", (z === -1));
                                    z = A.get("ContextLabelId")
                                }
                            })
                        }
                    },
                    error: function() {
                        p3.displayError("Error loading teacher sections")
                    }
                });
                if (!t.options.isOwner && !t.options.isManager) {
                    v = new a.Cs.Content({}, {
                        sectionId: t.options.leadSectionId,
                        leadSectionId: t.options.leadSectionId
                    });
                    v.fetch({
                        async: false,
                        error: function() {
                            p3.displayError("Error loading available content")
                        }
                    })
                }
                p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.jQueryUI, function() {
                    window.setTimeout(function() {
                        if (t.options.isOwner || t.options.isManager) {
                            t.initSortable()
                        }
                        t.options.content.each(function(D) {
                            var B = false,
                                z, C, A;
                            if (t.options.isOwner || t.options.isManager) {
                                D.set("canEdit", true)
                            } else {
                                z = v.get(D.get("ContentId"));
                                if (z) {
                                    B = z.get("EditorAccess") === 1
                                }
                                D.set("canEdit", B)
                            }
                            C = e.Us.findContentById(D.get("ContentId"));
                            if (C) {
                                D.set("Name", C.Name);
                                D.set("IconClass", C.IconClass)
                            }
                            A = new j.Vs.ContentItem({
                                model: D,
                                leadSectionId: t.options.leadSectionId,
                                associationId: t.options.associationId,
                                sectionId: t.options.sectionId,
                                sections: x,
                                buildings: t.options.buildings,
                                registrations: t.options.registrations,
                                active: true,
                                future: false,
                                expired: false,
                                isNarrow: j.Us.isNarrowColumn(D.get("RowIndex"), D.get("ColumnIndex"), t.options.layoutId),
                                canRemove: t.options.isOwner || t.options.isManager
                            });
                            p3.rV(A, $("#column" + D.get("RowIndex") + "_" + D.get("ColumnIndex")), false)
                        })
                    }, 400)
                })
            })
        },
        initSortable: function() {
            var s = this;
            $(".pages-layout-col").sortable({
                items: "> DIV.pages-layout-block.editable",
                connectWith: ".pages-layout-col.editable",
                handle: ".pages-layout-block-header",
                placeholder: "pages-layout-placeholder",
                forcePlaceholderSize: true,
                tolerance: "pointer",
                delay: 300,
                stop: function(y, B) {
                    var u = $(B.item),
                        t = u.closest(".pages-layout-col"),
                        w = t.data("col"),
                        A = t.data("row"),
                        x = u.data("id"),
                        v = u.index(),
                        z;
                    if (u.hasClass("workspace-draggable-item")) {
                        _.defer(function() {
                            u.remove();
                            if (x < 407) {
                                $(".pages-layout-draggable-content[data-id='" + x + "']").remove()
                            }
                        });
                        z = s.getLayoutOrder(A, w, v);
                        s.addContent(z, x, 0, A, w, v)
                    } else {
                        z = s.getLayoutOrder(-1, -1, -1);
                        s.saveLayout(z, false, false)
                    }
                }
            })
        },
        getLayoutOrder: function(z, t, w) {
            var u = [],
                s = -1,
                y = -1,
                x = -1,
                v, A = this;
            $(".pages-layout-col").each(function(B, C) {
                y = $(C).data("row");
                s = $(C).data("col");
                x = -1;
                $(C).find(".pages-layout-block").each(function(E, D) {
                    if (z === y && t === s && E === w) {
                        x += 2
                    } else {
                        x += 1
                    }
                    v = $(D).find(".pages-layout-block-header").data("id");
                    if (v) {
                        u.push({
                            ContentId: v,
                            ContentIndexId: 0,
                            RowIndex: y,
                            ColumnIndex: s,
                            CellIndex: x,
                            GenericSettings: A.getSettings(v)
                        })
                    }
                })
            });
            return u
        },
        saveLayout: function(t, u, s) {
            var w = this,
                v;
            v = new j.Ms.LayoutSave({
                SectionId: w.options.leadSectionId,
                AssociationId: w.options.associationId,
                LayoutId: w.options.layoutId,
                ChangeLayout: false,
                PendingInd: true,
                ContentItems: t
            });
            v.save({}, {
                success: function(x, y) {
                    if (u) {
                        w.trigger("contentChange")
                    } else {
                        if (s) {
                            w.trigger("contentRemoved")
                        } else {
                            w.trigger("contentMove")
                        }
                    }
                },
                error: function(x, y) {
                    p3.displayError("Error changing layout")
                }
            })
        },
        addContent: function(w, u, v, x, t, s) {
            var y = this;
            w.push({
                ContentId: u,
                ContentIndexId: v,
                RowIndex: x,
                ColumnIndex: t,
                CellIndex: s
            });
            y.saveLayout(w, true, false)
        },
        deleteContent: function(u) {
            u.preventDefault();
            var s = $(u.currentTarget),
                t = s.data("id"),
                v = this;
            s.parents(".pages-layout-block").remove();
            v.saveLayout(v.getLayoutOrder(-1, -1, -1), false, t < 404)
        },
        editOptions: function(t) {
            var w = this,
                s = $(t.currentTarget).data("content"),
                u, v;
            w.options.content.each(function(x) {
                if (x.get("ContentId") === s) {
                    u = x
                }
            });
            v = new j.Vs.HeaderOptions({
                contentId: s,
                model: u
            });
            p3.rV(v, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            v.on("HeaderSaved", function() {
                w.saveLayout(w.getLayoutOrder(-1, -1, -1), false, false)
            });
            return false
        },
        getSettings: function(s) {
            var u = this,
                t = "";
            u.options.content.each(function(v) {
                if (v.get("ContentId") === s) {
                    if (v.get("GenericSettings")) {
                        t = v.get("GenericSettings")
                    }
                }
            });
            return t
        }
    });
    j.Vs.HeaderOptions = Bb.View.extend({
        template: "grouppage/header.options.template.html",
        events: {
            "click #btnSave": "saveHeader",
            "submit form": "saveHeader"
        },
        render: function(s) {
            var t = this;
            $(s).html(t.el);
            t.renderTemplate()
        },
        renderTemplate: function() {
            var u = this,
                t, s = "optTitle";
            if (u.model.get("GenericSettings")) {
                t = JSON.parse(u.model.get("GenericSettings"));
                if (t.DisplayOption) {
                    s = t.DisplayOption
                }
            }
            p3.fT(u.template, function(v) {
                u.$el.html(v({
                    HeaderText: j.Us.getCusomHeader(u.model),
                    ContentType: e.Us.findContentById(u.options.contentId).Name,
                    Link: u.options.contentId === 2,
                    linkOption: s
                }))
            })
        },
        saveHeader: function(s) {
            var w = this,
                u = {},
                v, t = $("#HeaderText").val();
            if (t.length > 0) {
                u.HeaderText = t
            }
            if (w.options.contentId === 2) {
                u.DisplayOption = $('input[type="radio"][name=DisplayOption]:checked:first').val()
            }
            if (u.HeaderText || u.DisplayOption) {
                v = JSON.stringify(u)
            }
            w.model.set("GenericSettings", v);
            w.trigger("HeaderSaved");
            p3.Layout.Containers.Modal.modal("hide")
        }
    });
    j.Vs.ContentItem = Bb.View.extend({
        className: "pages-layout-block editable",
        template: "grouppage/content.block.template.html",
        events: {
            "click .active-content-check": "contentFilterChange",
            "click .future-content-check": "contentFilterChange",
            "click .expired-content-check": "contentFilterChange",
            "change .event-date": "eventDateChange"
        },
        renderTemplate: function() {
            var u = this,
                t = true,
                s = false;
            switch (u.model.get("ContentId")) {
                case 41:
                case 250:
                case 407:
                case 408:
                case 45:
                case 71:
                case 387:
                    t = false;
                    break
            }
            if (u.model.get("ContentId") === 5) {
                s = true
            }
            p3.fT(u.template, function(v) {
                u.$el.html(v({
                    contentInfo: u.model.toJSON(),
                    showFilter: t,
                    active: u.active,
                    future: u.future,
                    expired: u.expired,
                    dateFilter: s,
                    fromDate: u.fromDate,
                    toDate: u.toDate,
                    canRemove: u.options.canRemove
                }))
            });
            if (u.model.get("ContentId") < 404) {
                window.setTimeout(function() {
                    g.Us.initialize(".date-input");
                    u.renderContent()
                }, 300)
            }
        },
        initialize: function() {
            var u = this,
                s, t;
            u.Containers = {};
            u.active = u.options.active;
            u.future = u.options.future;
            u.expired = u.options.expired;
            u.expanded = false;
            s = f.localDateTime();
            s.setDate(1);
            u.fromDate = f.getDateString(s);
            t = new Date(s);
            t.setMonth(s.getMonth() + 1);
            t.setDate(s.getDate() - 1);
            u.toDate = f.getDateString(t)
        },
        render: function(s) {
            $(s).append(this.el);
            this.renderTemplate()
        },
        renderContent: function() {
            var D = this,
                w, u, x = j.Us.getContextLabel(D.options.associationId),
                s = true,
                z, t, v, y = "",
                C = "",
                B, A;
            switch (D.model.get("ContentId")) {
                case 2:
                    if (D.options.associationId === 3) {
                        s = false
                    }
                    u = new k.Cs.Link({}, {
                        sectionId: D.options.sectionId,
                        leadSectionId: D.options.leadSectionId,
                        contextLabelId: x,
                        editMode: true,
                        active: D.active,
                        future: D.future,
                        expired: D.expired
                    });
                    if (D.active || D.future || D.expired) {
                        u.fetch({
                            async: false,
                            success: function() {
                                w = new k.Vs.LinkView({
                                    groupPageEdit: true,
                                    collection: u,
                                    leadSectionId: D.options.leadSectionId,
                                    editMode: true,
                                    sections: D.options.sections,
                                    contextLabelId: x,
                                    canEdit: D.model.get("canEdit"),
                                    allowExisting: s,
                                    ItemCount: 3,
                                    expanded: D.expanded
                                })
                            },
                            error: function() {
                                p3.displayError("Error loading downloads")
                            }
                        })
                    } else {
                        u.remove(u.at(0));
                        w = new k.Vs.LinkView({
                            groupPageEdit: true,
                            collection: u,
                            leadSectionId: D.options.leadSectionId,
                            editMode: true,
                            sections: D.options.sections,
                            contextLabelId: x,
                            canEdit: D.model.get("canEdit"),
                            allowExisting: s,
                            ItemCount: 3,
                            expanded: D.expanded
                        })
                    }
                    break;
                case 3:
                    u = new h.Cs.Download({}, {
                        sectionId: D.options.sectionId,
                        leadSectionId: D.options.leadSectionId,
                        editMode: true,
                        active: D.active,
                        future: D.future,
                        expired: D.expired,
                        contextLabelId: x
                    });
                    if (D.active || D.future || D.expired) {
                        u.fetch({
                            async: false,
                            success: function() {
                                w = new h.Vs.DownloadView({
                                    groupPageEdit: true,
                                    collection: u,
                                    leadSectionId: D.options.leadSectionId,
                                    editMode: true,
                                    sections: D.options.sections,
                                    contextLabelId: x,
                                    canEdit: D.model.get("canEdit"),
                                    ItemCount: 3,
                                    expanded: D.expanded
                                })
                            },
                            error: function() {
                                p3.displayError("Error loading downloads")
                            }
                        })
                    } else {
                        u.remove(u.at(0));
                        w = new h.Vs.DownloadView({
                            groupPageEdit: true,
                            collection: u,
                            leadSectionId: D.options.leadSectionId,
                            editMode: true,
                            sections: D.options.sections,
                            contextLabelId: x,
                            canEdit: D.model.get("canEdit"),
                            ItemCount: 3,
                            expanded: D.expanded
                        })
                    }
                    break;
                case 5:
                    u = new i.Cs.Event({}, {
                        sectionId: D.options.sectionId,
                        leadSectionId: D.options.leadSectionId,
                        contextLabelId: x,
                        editMode: true,
                        fromDate: D.fromDate,
                        toDate: D.toDate
                    });
                    u.fetch({
                        async: false,
                        success: function() {
                            w = new i.Vs.EventView({
                                groupPageEdit: true,
                                collection: u,
                                editMode: true,
                                leadSectionId: D.options.leadSectionId,
                                sections: D.options.sections,
                                registrations: D.options.registrations,
                                buildings: D.options.buildings,
                                canEdit: D.model.get("canEdit"),
                                contextLabelId: x,
                                ItemCount: 3,
                                expanded: D.expanded
                            })
                        },
                        error: function() {
                            p3.displayError("Error loading events")
                        }
                    });
                    break;
                case 6:
                    z = false;
                    if (p3.Data.Context.findByTaskId(53222)) {
                        t = new m.Ms.NewsCategory();
                        t.fetch({
                            data: {
                                id: 0,
                                contextLabelId: x
                            },
                            async: false,
                            success: function() {
                                z = (t.get("CommentApprovalInd") === 1)
                            },
                            error: function() {
                                p3.displayError("Error loading news category settings")
                            }
                        })
                    }
                    u = new m.Cs.News({}, {
                        sectionId: D.options.sectionId,
                        leadSectionId: D.options.leadSectionId,
                        editMode: true,
                        active: D.active,
                        future: D.future,
                        expired: D.expired,
                        contextLabelId: x
                    });
                    if (D.active || D.future || D.expired) {
                        u.fetch({
                            async: false,
                            success: function() {
                                w = new m.Vs.NewsView({
                                    groupPageEdit: true,
                                    collection: u,
                                    leadSectionId: D.options.leadSectionId,
                                    editMode: true,
                                    sections: D.options.sections,
                                    canEdit: D.model.get("canEdit"),
                                    contextLabelId: x,
                                    manageComments: z,
                                    ItemCount: 3,
                                    expanded: D.expanded
                                })
                            },
                            error: function() {
                                p3.displayError("Error loading news")
                            }
                        })
                    } else {
                        u.remove(u.at(0));
                        w = new m.Vs.NewsView({
                            groupPageEdit: true,
                            collection: u,
                            leadSectionId: D.options.leadSectionId,
                            editMode: true,
                            sections: D.options.sections,
                            canEdit: D.model.get("canEdit"),
                            contextLabelId: x,
                            manageComments: z,
                            ItemCount: 3,
                            expanded: D.expanded
                        })
                    }
                    break;
                case 10:
                    u = new c.Cs.Announcement({}, {
                        sectionId: D.options.sectionId,
                        leadSectionId: D.options.leadSectionId,
                        editMode: true,
                        active: D.active,
                        future: D.future,
                        expired: D.expired,
                        contextLabelId: x
                    });
                    if (D.active || D.future || D.expired) {
                        u.fetch({
                            async: false,
                            success: function() {
                                w = new c.Vs.AnnouncementView({
                                    groupPageEdit: true,
                                    collection: u,
                                    leadSectionId: D.options.leadSectionId,
                                    editMode: true,
                                    sections: D.options.sections,
                                    contextLabelId: x,
                                    canEdit: D.model.get("canEdit"),
                                    ItemCount: 3,
                                    expanded: D.expanded
                                })
                            },
                            error: function() {
                                p3.displayError("Error loading announcements")
                            }
                        })
                    } else {
                        u.remove(u.at(0));
                        w = new c.Vs.AnnouncementView({
                            groupPageEdit: true,
                            collection: u,
                            leadSectionId: D.options.leadSectionId,
                            editMode: true,
                            sections: D.options.sections,
                            contextLabelId: x,
                            canEdit: D.model.get("canEdit"),
                            ItemCount: 3,
                            expanded: D.expanded
                        })
                    }
                    break;
                case 31:
                    u = new l.Cs.Media({}, {
                        sectionId: D.options.sectionId,
                        leadSectionId: D.options.leadSectionId,
                        contentId: 31,
                        editMode: true,
                        active: D.active,
                        future: D.future,
                        expired: D.expired,
                        contextLabelId: x
                    });
                    if (D.active || D.future || D.expired) {
                        u.fetch({
                            async: false,
                            success: function() {
                                w = new n.Vs.AlbumView({
                                    groupPageEdit: true,
                                    collection: u,
                                    leadSectionId: D.options.leadSectionId,
                                    editMode: true,
                                    sections: D.options.sections,
                                    contextLabelId: x,
                                    canEdit: D.model.get("canEdit"),
                                    ItemCount: 3,
                                    expanded: D.expanded
                                })
                            },
                            error: function() {
                                p3.displayError("Error loading photos")
                            }
                        })
                    } else {
                        u.remove(u.at(0));
                        w = new n.Vs.AlbumView({
                            groupPageEdit: true,
                            collection: u,
                            leadSectionId: D.options.leadSectionId,
                            editMode: true,
                            sections: D.options.sections,
                            contextLabelId: x,
                            canEdit: D.model.get("canEdit"),
                            ItemCount: 3,
                            expanded: D.expanded
                        })
                    }
                    break;
                case 165:
                    u = new l.Cs.Media({}, {
                        sectionId: D.options.sectionId,
                        leadSectionId: D.options.leadSectionId,
                        contentId: 165,
                        editMode: true,
                        active: D.active,
                        future: D.future,
                        expired: D.expired,
                        contextLabelId: x
                    });
                    if (D.active || D.future || D.expired) {
                        u.fetch({
                            async: false,
                            success: function() {
                                w = new d.Vs.AlbumView({
                                    groupPageEdit: true,
                                    collection: u,
                                    leadSectionId: D.options.leadSectionId,
                                    editMode: true,
                                    sections: D.options.sections,
                                    contextLabelId: x,
                                    canEdit: D.model.get("canEdit"),
                                    ItemCount: 3,
                                    expanded: D.expanded
                                })
                            },
                            error: function() {
                                p3.displayError("Error loading audio")
                            }
                        })
                    } else {
                        u.remove(u.at(0));
                        w = new d.Vs.AlbumView({
                            groupPageEdit: true,
                            collection: u,
                            leadSectionId: D.options.leadSectionId,
                            editMode: true,
                            sections: D.options.sections,
                            contextLabelId: x,
                            canEdit: D.model.get("canEdit"),
                            ItemCount: 3,
                            expanded: D.expanded
                        })
                    }
                    break;
                case 167:
                    u = new l.Cs.Media({}, {
                        sectionId: D.options.sectionId,
                        leadSectionId: D.options.leadSectionId,
                        contentId: 167,
                        editMode: true,
                        active: D.active,
                        future: D.future,
                        expired: D.expired,
                        contextLabelId: x
                    });
                    if (D.active || D.future || D.expired) {
                        u.fetch({
                            async: false,
                            success: function() {
                                w = new r.Vs.AlbumView({
                                    groupPageEdit: true,
                                    collection: u,
                                    leadSectionId: D.options.leadSectionId,
                                    editMode: true,
                                    sections: D.options.sections,
                                    contextLabelId: x,
                                    canEdit: D.model.get("canEdit"),
                                    ItemCount: 3,
                                    expanded: D.expanded
                                })
                            },
                            error: function() {
                                p3.displayError("Error loading video")
                            }
                        })
                    } else {
                        u.remove(u.at(0));
                        w = new r.Vs.AlbumView({
                            groupPageEdit: true,
                            collection: u,
                            leadSectionId: D.options.leadSectionId,
                            editMode: true,
                            sections: D.options.sections,
                            contextLabelId: x,
                            canEdit: D.model.get("canEdit"),
                            ItemCount: 3,
                            expanded: D.expanded
                        })
                    }
                    break;
                case 41:
                    u = new o.Ms.RssReader({
                        leadSectionId: D.options.leadSectionId,
                        contextLabelId: x
                    });
                    u.fetch({
                        async: false,
                        success: function() {
                            w = new j.Vs.RssReaderView({
                                reader: u,
                                contextLabelId: x,
                                leadSectionId: D.options.leadSectionId,
                                canEdit: D.model.get("canEdit")
                            })
                        },
                        error: function() {
                            p3.displayError("Error loading Rss")
                        }
                    });
                    break;
                case 250:
                    u = new q.Cs.Text({}, {
                        sectionId: D.options.sectionId,
                        leadSectionId: D.options.leadSectionId,
                        contextLabelId: x
                    });
                    u.fetch({
                        async: false,
                        success: function() {
                            w = new j.Vs.TextView({
                                collection: u,
                                contextLabelId: x,
                                canEdit: D.model.get("canEdit")
                            })
                        },
                        error: function() {
                            p3.displayError("Error loading text")
                        }
                    });
                    break;
                case 78:
                case 79:
                case 80:
                    v = D.model.get("ContentId");
                    y = "Expectations";
                    C = "expe";
                    if (v === 78) {
                        y = "Syllabus";
                        C = "syll"
                    } else {
                        if (v === 79) {
                            y = "Grading Rubric";
                            C = "grad"
                        }
                    }
                    u = new b.Cs.AcademicContent({}, {
                        sectionId: D.options.sectionId,
                        leadSectionId: D.options.leadSectionId,
                        contentId: v,
                        active: D.active,
                        future: D.future,
                        expired: D.expired
                    });
                    u.fetch({
                        async: false,
                        success: function() {
                            w = new b.Vs.AcademicContentView({
                                groupPageEdit: true,
                                collection: u,
                                header: y,
                                prefix: C,
                                editMode: true,
                                active: D.active,
                                future: D.future,
                                expired: D.expired,
                                sections: D.options.sections,
                                contentId: v,
                                canEdit: D.model.get("canEdit"),
                                ItemCount: 3,
                                expanded: D.expanded
                            })
                        },
                        error: function() {
                            p3.displayError("Error loading academic content")
                        }
                    });
                    break;
                case 45:
                    B = new p.Cs.Opponent();
                    B.fetch({
                        async: false,
                        error: function() {
                            p3.displayError("Error loading athletic opponents")
                        }
                    });
                    u = new p.Cs.Results({}, {
                        sectionId: D.options.leadSectionId
                    });
                    u.fetch({
                        async: false,
                        data: {
                            sectionId: u.sectionId
                        },
                        success: function() {
                            w = new p.Vs.TeamScores({
                                editMode: true,
                                canEdit: D.model.get("canEdit"),
                                sections: D.options.sections,
                                possibleOpponents: B,
                                ItemCount: 3,
                                expanded: true,
                                isNarrow: D.options.isNarrow
                            });
                            w.parentView = D;
                            w.collection = u
                        },
                        error: function() {
                            p3.displayError("Error loading athletic results")
                        }
                    });
                    break;
                case 387:
                    A = new j.Ms.Widget({
                        contextValue: D.options.leadSectionId,
                        contextLabelId: x
                    });
                    A.fetch({
                        async: false,
                        data: {
                            contextLabelId: x,
                            contextValue: D.options.leadSectionId
                        },
                        success: function() {
                            w = new j.Vs.EmbedView({
                                model: A,
                                contextLabelId: x,
                                canEdit: D.model.get("canEdit"),
                                contextValue: D.options.leadSectionId
                            })
                        },
                        error: function() {
                            p3.displayError("Error loading embed")
                        }
                    });
                    break
            }
            if (w) {
                D.Containers.Content = D.$(".content-manage");
                p3.rV(w, D.Containers.Content, true);
                w.renderTemplate();
                w.on("showAll", function(E) {
                    D.expanded = E
                })
            }
        },
        contentFilterChange: function(t) {
            var u = this,
                s = $(t.currentTarget);
            if (s.hasClass("active-content-check")) {
                u.active = !u.active
            } else {
                if (s.hasClass("future-content-check")) {
                    u.future = !u.future
                } else {
                    u.expired = !u.expired
                }
            }
            u.renderContent()
        },
        eventDateChange: function(s) {
            var v = this,
                t = $("#event_from_date").datepicker("getDate"),
                u = $("#event_to_date").datepicker("getDate");
            v.fromDate = f.getDateString(t);
            v.toDate = f.getDateString(u);
            v.renderContent()
        }
    });
    j.Vs.TextView = Bb.View.extend({
        template: "grouppage/text.manage.template.html",
        events: {
            "click #edit_text": "openEditModal",
            "click #delete_text": "openDeleteModal"
        },
        renderTemplate: function(t) {
            var u = this,
                s = new q.Ms.TextProperties({
                    categoryId: u.collection.models[0].get("CategoryID")
                });
            s.fetch({
                success: function() {
                    u.properties = s.attributes[0]
                },
                error: function() {
                    p3.displayError("Error loading text properites")
                }
            });
            p3.fT(u.template, function(v) {
                u.$el.html(v({
                    text: u.collection.models[0].toJSON(),
                    canEdit: u.options.canEdit
                }))
            })
        },
        render: function(s) {
            $(s).append(this.el)
        },
        openEditModal: function() {
            var w, u = "",
                v = "",
                s = 0,
                t = 0;
            if (this.collection.models.length > 0) {
                w = this.collection.models[0];
                t = w.get("CategoryID");
                if (w.get("AlbumID") > 0) {
                    u = w.get("Description");
                    v = w.get("LongText");
                    s = w.get("AlbumID")
                }
            }
            p3.rV(new q.Vs.TextEditView({
                photos: this.collection,
                description: u,
                lng: v,
                albumId: s,
                textView: this,
                categoryId: t
            }), p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            return false
        },
        refreshText: function() {
            var s = this;
            q.Us.refreshText(true, s.options.collection.sectionId, s.options.collection.leadSectionId, s, s.options.contextLabelId)
        },
        openDeleteModal: function() {
            var s = this;
            this.on("textDeleted", this.refreshText, this);
            q.Us.textDeleteModal(this.collection.models[0].get("AlbumID"), s.options.contextLabelId, s);
            return false
        }
    });
    j.Vs.EmbedView = Bb.View.extend({
        template: "grouppage/embed.manage.template.html",
        events: {
            "click #edit_embed": "openEditModal",
            "click #delete_embed": "openDeleteModal"
        },
        renderTemplate: function(s) {
            var t = this;
            p3.fT(t.template, function(u) {
                t.$el.html(u({
                    embed: t.model.toJSON(),
                    canEdit: t.options.canEdit
                }))
            })
        },
        render: function(s) {
            $(s).append(this.el)
        },
        openEditModal: function() {
            var t = this,
                s = new j.Vs.EditEmbed({
                    model: t.model
                });
            p3.rV(s, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            s.on("embedSaved", function() {
                t.refreshEmbed()
            });
            return false
        },
        refreshEmbed: function() {
            var s = this;
            s.renderTemplate()
        },
        openDeleteModal: function() {
            var s = this;
            p3.showConfirm("Delete Embed", "Are you sure you wish to delete this Embed?", null, function() {
                var t = new j.Ms.WidgetDelete({
                    Id: s.model.get("WidgetId")
                });
                t.destroy({
                    error: function() {
                        p3.displayError("Error deleting embed")
                    },
                    success: function() {
                        s.model.set({
                            WidgetId: 0,
                            ShortDescription: "",
                            LongDescription: ""
                        });
                        s.refreshEmbed()
                    }
                })
            });
            return false
        }
    });
    j.Vs.Embed = Bb.View.extend({
        template: "grouppage/embed.template.html",
        renderTemplate: function(s) {
            var t = this;
            p3.fT(t.template, function(u) {
                t.$el.html(u({
                    embed: t.model.toJSON()
                }))
            })
        },
        render: function(s) {
            $(s).append(this.el)
        }
    });
    j.Vs.EditEmbed = Bb.View.extend({
        template: "grouppage/embed.edit.template.html",
        events: {
            "click #btnSaveEmbed": "saveEmbed"
        },
        renderTemplate: function(s) {
            var t = this;
            p3.fT(t.template, function(u) {
                t.$el.html(u({
                    embed: t.model.toJSON(),
                    mode: t.model.get("WidgetId") ? "Edit" : "Add"
                }))
            })
        },
        render: function(s) {
            $(s).append(this.el);
            this.renderTemplate()
        },
        saveEmbed: function(v) {
            var z = this,
                u = z.$("#embed-title"),
                t = z.$("#embed-text"),
                x = u.val(),
                w = t.val(),
                A, y = true,
                s = $("#btnSaveEmbed");
            s.button("loading");
            if (typeof x !== "string" || x === "") {
                u.closest(".control-group").addClass("error");
                y = false
            } else {
                u.closest(".control-group").removeClass("error")
            }
            if (typeof w !== "string" || w === "") {
                t.closest(".control-group").addClass("error");
                y = false
            } else {
                t.closest(".control-group").removeClass("error")
            }
            if (y) {
                if (!z.model.get("WidgetId")) {
                    A = new j.Ms.WidgetCreate({
                        ShortDescription: x,
                        LongDescription: w,
                        ContextLabelId: z.model.get("contextLabelId"),
                        ContextValue: z.model.get("contextValue"),
                        SortOrder: 0
                    })
                } else {
                    A = new j.Ms.WidgetUpdate({
                        WidgetId: z.model.get("WidgetId"),
                        ShortDescription: x,
                        LongDescription: w,
                        ContextLabelId: z.model.get("contextLabelId"),
                        ContextValue: z.model.get("contextValue"),
                        SortOrder: 0
                    })
                }
                A.save({}, {
                    error: function(B, C) {
                        s.button("reset")
                    },
                    success: function(B, C) {
                        z.model.set({
                            ShortDescription: x,
                            LongDescription: w,
                            WidgetId: z.model.get("WidgetId") || C
                        });
                        z.trigger("embedSaved");
                        p3.showModal(p3.Layout.Containers.Modal, "hide")
                    }
                })
            } else {
                s.button("reset")
            }
            return false
        }
    });
    j.Vs.RssReaderView = Bb.View.extend({
        template: "grouppage/rss.manage.template.html",
        events: {
            "click #edit_reader": "openEditModal",
            "click #delete_reader": "openDeleteModal"
        },
        renderTemplate: function(t) {
            var u = this,
                s = u.options.reader;
            p3.fT(u.template, function(v) {
                u.$el.html(v({
                    Url: s.get("Url"),
                    canEdit: u.options.canEdit
                }));
                if (t) {
                    if (s.get("Url")) {
                        $("#delete_reader").show()
                    }
                }
            })
        },
        render: function(s) {
            $(s).append(this.el)
        },
        openEditModal: function() {
            var s = this;
            p3.rV(new o.Vs.RssReaderEditView({
                reader: s.options.reader,
                leadSectionId: s.options.leadSectionId,
                contextLabelId: s.options.contextLabelId,
                parentView: s
            }), p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            return false
        },
        openDeleteModal: function() {
            var s = this;
            p3.showConfirm("Delete Rss Feed", "Warning: Once you hit confirm there is no undo button. Are you really sure you want to delete this forever?", null, function() {
                var t = new o.Ms.RssReaderDelete({
                    ReaderId: s.options.reader.get("ReaderId")
                });
                t.destroy({
                    error: function() {
                        p3.displayError("Error deleting rss Feed")
                    },
                    success: function() {
                        o.Us.refreshReader(true, s.options.leadSectionId, s, s.options.contextLabelId)
                    }
                })
            });
            return false
        }
    });
    j.Vs.LayoutView = Bb.View.extend({
        template: "grouppage/detail.layout.template.html",
        events: {},
        initialize: function() {
            var s = this;
            s.Containers = {};
            s.sectionId = this.options.sectionId || 0;
            s.leadSectionId = this.options.leadSectionId || 0;
            s.contentTypes = this.options.content;
            s.teacherId = this.options.teacherId || 0;
            s.userHasFullAccess = this.options.userHasFullAccess || 0;
            s.isOwner = this.options.isOwner || 0;
            s.isManager = this.options.isManager || 0;
            s.isEditor = false
        },
        render: function(s) {
            var t = this;
            p3.fT(t.template, function(w) {
                p3.setTitle("Bulletin Board");
                var v = j.Us.buildRows(t.options.layoutId),
                    u = t.userHasFullAccess;
                t.Rows = v;
                t.$el.html(w({
                    row: v,
                    preview: t.options.preview
                }));
                $(s).html(t.el);
                t.Containers.ManageContainer = $("#manage_container");
                $(".nav-pills li:first").addClass("active");
                t.renderContent();
                if (!t.options.preview) {
                    if (!u) {
                        t.contentTypes.each(function(x) {
                            if (x.get("EditorAccess")) {
                                t.isEditor = true;
                                u = true
                            }
                        })
                    }
                    if (u) {
                        p3.rV(new j.Vs.EditView({
                            sectionId: t.sectionId,
                            leadSectionId: t.leadSectionId,
                            associationId: t.options.associationId
                        }), t.Containers.ManageContainer, false)
                    }
                }
            })
        },
        renderContent: function() {
            var v = this,
                u = p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.MULTIMEDIA),
                s = new j.Cs.BulletinBoardContent({}, {
                    sectionId: v.options.leadSectionId,
                    associationId: v.options.associationId,
                    pendingInd: v.options.pendingInd
                }),
                t;
            s.fetch({
                error: function() {
                    p3.displayError("Error loading content layout")
                },
                success: function() {
                    var w;
                    if (v.options.associationId === 2) {
                        t = s.pluck("ContentId");
                        if (t.indexOf(45) > -1 || t.indexOf(71) > -1) {
                            w = new p.Cs.Results({}, {
                                sectionId: v.options.leadSectionId
                            });
                            w.fetch({
                                async: false,
                                data: {
                                    sectionId: w.sectionId
                                },
                                error: function() {
                                    p3.displayError("Error loading athletic results")
                                }
                            })
                        }
                    }
                    s.each(function(I) {
                        var B = I.get("ContentId"),
                            C = v.contentTypes.get(B),
                            G = j.Us.getCusomHeader(I),
                            z, H, A, D, F, y, K, E, L, M = false,
                            N = true,
                            J, x;
                        if (C || (u & (B === 31 || B === 165 || B === 167)) || B === 407 || B === 408) {
                            z = "#column" + I.get("RowIndex") + "_" + I.get("ColumnIndex");
                            x = $(z);
                            H = j.Us.isNarrowColumn(I.get("RowIndex"), I.get("ColumnIndex"), v.options.layoutId);
                            switch (B) {
                                case 2:
                                    if (I.get("GenericSettings")) {
                                        L = JSON.parse(I.get("GenericSettings"));
                                        if (L.DisplayOption) {
                                            switch (L.DisplayOption) {
                                                case "optImage":
                                                    N = false;
                                                    M = true;
                                                    break;
                                                case "optTitleImage":
                                                    M = true;
                                                    break
                                            }
                                        }
                                    }
                                    A = new k.Cs.Link({}, {
                                        sectionId: v.sectionId,
                                        leadSectionId: v.leadSectionId,
                                        contextLabelId: v.options.contextLabelId
                                    });
                                    D = new k.Vs.LinkView({
                                        collection: A,
                                        leadSectionId: v.leadSectionId,
                                        contextLabelId: v.options.contextLabelId,
                                        customHeader: G,
                                        showTitle: N,
                                        showImage: M
                                    });
                                    p3.rV(D, z, false);
                                    A.fetch({
                                        error: function() {
                                            p3.displayError("Error loading links")
                                        }
                                    });
                                    break;
                                case 3:
                                    A = new h.Cs.Download({}, {
                                        sectionId: v.sectionId,
                                        leadSectionId: v.leadSectionId,
                                        contextLabelId: v.options.contextLabelId
                                    });
                                    D = new h.Vs.DownloadView({
                                        collection: A,
                                        leadSectionId: v.leadSectionId,
                                        contextLabelId: v.options.contextLabelId,
                                        customHeader: G
                                    });
                                    p3.rV(D, z, false);
                                    A.fetch({
                                        error: function() {
                                            p3.displayError("Error loading downloads")
                                        }
                                    });
                                    break;
                                case 5:
                                    F = f.localDateTime();
                                    A = new i.Cs.Event({}, {
                                        editMode: true,
                                        fromDate: f.getDateString(F).ApiFormat(),
                                        sectionId: v.sectionId,
                                        leadSectionId: v.leadSectionId,
                                        contextLabelId: v.options.contextLabelId
                                    });
                                    D = new i.Vs.EventView({
                                        collection: A,
                                        fromDate: f.getDateString(F).ApiFormat(),
                                        leadSectionId: v.leadSectionId,
                                        contextLabelId: v.options.contextLabelId,
                                        customHeader: G
                                    });
                                    p3.rV(D, z, false);
                                    A.fetch({
                                        error: function() {
                                            p3.displayError("Error loading events")
                                        }
                                    });
                                    break;
                                case 6:
                                    A = new m.Cs.News({}, {
                                        sectionId: v.sectionId,
                                        leadSectionId: v.leadSectionId,
                                        editMode: false,
                                        active: true,
                                        future: false,
                                        expired: false,
                                        contextLabelId: v.options.contextLabelId
                                    });
                                    D = new m.Vs.NewsView({
                                        collection: A,
                                        leadSectionId: v.leadSectionId,
                                        contextLabelId: v.options.contextLabelId,
                                        newLayout: true,
                                        customHeader: G
                                    });
                                    p3.rV(D, z, false);
                                    A.fetch({
                                        error: function() {
                                            p3.displayError("Error loading news")
                                        }
                                    });
                                    break;
                                case 10:
                                    A = new c.Cs.Announcement({}, {
                                        sectionId: v.sectionId,
                                        leadSectionId: v.leadSectionId,
                                        editMode: false,
                                        active: true,
                                        future: false,
                                        expired: false,
                                        contextLabelId: v.options.contextLabelId
                                    });
                                    D = new c.Vs.AnnouncementView({
                                        collection: A,
                                        leadSectionId: v.leadSectionId,
                                        contextLabelId: v.options.contextLabelId,
                                        customHeader: G
                                    });
                                    p3.rV(D, z, false);
                                    A.fetch({
                                        error: function() {
                                            p3.displayError("Error loading announcements")
                                        }
                                    });
                                    break;
                                case 31:
                                    y = v.getMediaCellCount(I);
                                    A = new l.Cs.Media({}, {
                                        sectionId: v.sectionId,
                                        leadSectionId: v.leadSectionId,
                                        contentId: 31,
                                        editMode: false,
                                        active: true,
                                        future: false,
                                        expired: false,
                                        contextLabelId: v.options.contextLabelId
                                    });
                                    D = new l.Vs.MediaContentView({
                                        viewMode: true,
                                        haveData: false,
                                        mediaItem: A,
                                        contentId: 31,
                                        iconClass: "icon-picture",
                                        subFolder: "photo",
                                        useLarge: true,
                                        leadSectionId: v.leadSectionId,
                                        newLayout: true,
                                        spanClass: v.getSpanClass(y),
                                        customHeader: G
                                    });
                                    p3.rV(D, z, false);
                                    A.fetch({
                                        success: function() {
                                            var O = -1;
                                            A.each(function(P) {
                                                O += 1;
                                                if (O > 0 && O % y === 0) {
                                                    P.set("newRow", true)
                                                }
                                                if (P.get("FileCount") === 1) {
                                                    P.set("CountLabel", "1 photo")
                                                } else {
                                                    P.set("CountLabel", P.get("FileCount") + " photos")
                                                }
                                                if (P.get("NumberOfViews") === 1) {
                                                    P.set("ViewLabel", "1 view")
                                                } else {
                                                    P.set("ViewLabel", P.get("NumberOfViews") + " views")
                                                }
                                            });
                                            D.renderTemplate()
                                        },
                                        error: function() {
                                            p3.displayError("Error loading photos")
                                        }
                                    });
                                    break;
                                case 165:
                                    y = v.getMediaCellCount(I);
                                    A = new l.Cs.Media({}, {
                                        sectionId: v.sectionId,
                                        leadSectionId: v.leadSectionId,
                                        contentId: 165,
                                        editMode: false,
                                        active: true,
                                        future: false,
                                        expired: false,
                                        contextLabelId: v.options.contextLabelId
                                    });
                                    D = new l.Vs.MediaContentView({
                                        viewMode: true,
                                        haveData: false,
                                        mediaItem: A,
                                        contentId: 165,
                                        iconClass: "icon-volume-up",
                                        subFolder: "audio",
                                        useLarge: false,
                                        leadSectionId: v.leadSectionId,
                                        newLayout: true,
                                        spanClass: v.getSpanClass(y),
                                        customHeader: G
                                    });
                                    p3.rV(D, z, false);
                                    A.fetch({
                                        success: function() {
                                            var O = -1;
                                            A.each(function(P) {
                                                O += 1;
                                                if (O > 0 && O % y === 0) {
                                                    P.set("newRow", true)
                                                }
                                                K = new Date(parseInt(P.get("PublishDate").substr(6), 10));
                                                E = K.getMonth() + "/" + K.getDate() + "/" + K.getFullYear();
                                                P.set("PublishDisplay", E);
                                                if (P.get("FileCount") === 1) {
                                                    P.set("CountLabel", "1 audio clip")
                                                } else {
                                                    P.set("CountLabel", P.get("FileCount") + " audio clips")
                                                }
                                                if (P.get("NumberOfViews") === 1) {
                                                    P.set("ViewLabel", "1 view")
                                                } else {
                                                    P.set("ViewLabel", P.get("NumberOfViews") + " views")
                                                }
                                            });
                                            D.renderTemplate()
                                        },
                                        error: function() {
                                            p3.displayError("Error loading audio")
                                        }
                                    });
                                    break;
                                case 167:
                                    y = v.getMediaCellCount(I);
                                    A = new l.Cs.Media({}, {
                                        sectionId: v.sectionId,
                                        leadSectionId: v.leadSectionId,
                                        contentId: 167,
                                        editMode: false,
                                        active: true,
                                        future: false,
                                        expired: false,
                                        contextLabelId: v.options.contextLabelId
                                    });
                                    D = new l.Vs.MediaContentView({
                                        viewMode: true,
                                        haveData: false,
                                        mediaItem: A,
                                        contentId: 167,
                                        iconClass: "icon-play-circle",
                                        subFolder: "video",
                                        useLarge: false,
                                        leadSectionId: v.leadSectionId,
                                        newLayout: true,
                                        spanClass: v.getSpanClass(y),
                                        customHeader: G
                                    });
                                    p3.rV(D, z, false);
                                    A.fetch({
                                        success: function() {
                                            var O = -1;
                                            A.each(function(P) {
                                                O += 1;
                                                if (O > 0 && O % y === 0) {
                                                    P.set("newRow", true)
                                                }
                                                K = new Date(parseInt(P.get("PublishDate").substr(6), 10));
                                                E = K.getMonth() + "/" + K.getDate() + "/" + K.getFullYear();
                                                P.set("PublishDisplay", E);
                                                if (P.get("FileCount") === 1) {
                                                    P.set("CountLabel", "1 video")
                                                } else {
                                                    P.set("CountLabel", P.get("FileCount") + " videos")
                                                }
                                                if (P.get("NumberOfViews") === 1) {
                                                    P.set("ViewLabel", "1 view")
                                                } else {
                                                    P.set("ViewLabel", P.get("NumberOfViews") + " views")
                                                }
                                            });
                                            D.renderTemplate()
                                        },
                                        error: function() {
                                            p3.displayError("Error loading videos")
                                        }
                                    });
                                    break;
                                case 41:
                                    A = new o.Ms.RssReader({
                                        leadSectionId: v.leadSectionId,
                                        contextLabelId: v.options.contextLabelId
                                    });
                                    D = new o.Vs.RssReaderView({
                                        reader: A,
                                        leadSectionId: v.leadSectionId,
                                        contextLabelId: v.options.RssReader,
                                        customHeader: G
                                    });
                                    p3.rV(D, z, false);
                                    A.fetch({
                                        error: function() {
                                            p3.displayError("Error loading rss")
                                        },
                                        success: function() {
                                            D.renderTemplate(false)
                                        }
                                    });
                                    break;
                                case 78:
                                    A = new b.Cs.AcademicContent({}, {
                                        sectionId: v.sectionId,
                                        leadSectionId: v.leadSectionId,
                                        contentId: 78,
                                        active: true,
                                        future: false,
                                        expired: false
                                    });
                                    D = new b.Vs.AcademicContentView({
                                        collection: A,
                                        header: "Syllabus",
                                        prefix: "syll",
                                        contentId: 78,
                                        customHeader: G
                                    });
                                    p3.rV(D, z, false);
                                    A.fetch({
                                        error: function() {
                                            p3.displayError("Error loading syllabus")
                                        }
                                    });
                                    break;
                                case 79:
                                    A = new b.Cs.AcademicContent({}, {
                                        sectionId: v.sectionId,
                                        leadSectionId: v.leadSectionId,
                                        contentId: 79,
                                        active: true,
                                        future: false,
                                        expired: false
                                    });
                                    D = new b.Vs.AcademicContentView({
                                        collection: A,
                                        header: "Grading Rubric",
                                        prefix: "grad",
                                        contentId: 79,
                                        customHeader: G
                                    });
                                    p3.rV(D, z, false);
                                    A.fetch({
                                        error: function() {
                                            p3.displayError("Error loading rubric")
                                        }
                                    });
                                    break;
                                case 80:
                                    A = new b.Cs.AcademicContent({}, {
                                        sectionId: v.sectionId,
                                        leadSectionId: v.leadSectionId,
                                        contentId: 80,
                                        active: true,
                                        future: false,
                                        expired: false
                                    });
                                    D = new b.Vs.AcademicContentView({
                                        collection: A,
                                        header: "Expectations",
                                        prefix: "expe",
                                        contentId: 80,
                                        customHeader: G
                                    });
                                    p3.rV(D, z, false);
                                    A.fetch({
                                        error: function() {
                                            p3.displayError("Error loading expectations")
                                        }
                                    });
                                    break;
                                case 250:
                                    A = new q.Cs.Text({}, {
                                        sectionId: v.sectionId,
                                        leadSectionId: v.leadSectionId,
                                        contextLabelId: v.options.contextLabelId
                                    });
                                    D = new q.Vs.TextView({
                                        collection: A,
                                        contextLabelId: v.options.contextLabelId,
                                        newLayout: true
                                    });
                                    p3.rV(D, z, false);
                                    A.fetch({
                                        success: function() {
                                            D.renderTemplate(false)
                                        },
                                        error: function() {
                                            p3.displayError("Error loading text")
                                        }
                                    });
                                    break;
                                case 407:
                                    x.append('<div style="height:10px;">&nbsp;</div>');
                                    break;
                                case 408:
                                    x.append('<div><hr class="styleProp" style="margin-bottom:18px;"/></div>');
                                    break;
                                case 45:
                                    D = new p.Vs.TeamScores({
                                        editMode: false,
                                        canEdit: false,
                                        ItemCount: 3,
                                        expanded: true,
                                        isNarrow: H,
                                        customHeader: G
                                    });
                                    D.parentView = v;
                                    D.collection = w;
                                    p3.rV(D, z, false);
                                    D.renderTemplate();
                                    break;
                                case 71:
                                    D = new p.Vs.Statistics({
                                        isNarrow: H,
                                        customHeader: G
                                    });
                                    D.collection = w;
                                    p3.rV(D, z, false);
                                    D.renderTemplate();
                                    break;
                                case 387:
                                    J = new j.Ms.Widget();
                                    D = new j.Vs.Embed({
                                        model: J
                                    });
                                    p3.rV(D, z, false);
                                    J.fetch({
                                        data: {
                                            contextLabelId: v.options.contextLabelId,
                                            contextValue: v.leadSectionId
                                        },
                                        success: function() {
                                            D.renderTemplate()
                                        },
                                        error: function() {
                                            p3.displayError("Error loading embed")
                                        }
                                    });
                                    break
                            }
                        }
                    })
                }
            })
        },
        getSpanClass: function(s) {
            var t = "";
            switch (s) {
                case 1:
                    t = "span12 col-md-12";
                    break;
                case 2:
                    t = "span6 col-md-6";
                    break;
                case 3:
                    t = "span4 col-md-4";
                    break;
                case 4:
                    t = "span3 col-md-3";
                    break
            }
            return t
        },
        getMediaCellCount: function(s) {
            var u = this,
                t = 0;
            switch (u.Rows[s.get("RowIndex")].columns[s.get("ColumnIndex")].className) {
                case "span3":
                case "col-md-3":
                case "span3 col-md-3":
                case "span4":
                case "col-md-4":
                case "span4 col-md-4":
                    t = 1;
                    break;
                case "span6":
                case "col-md-6":
                case "span6 col-md-6":
                    t = 2;
                    break;
                case "span9":
                case "col-md-9":
                case "span9 col-md-9":
                    t = 3;
                    break;
                case "span12":
                case "col-md-12":
                case "span12 col-md-12":
                    t = 4;
                    break
            }
            return t
        }
    });
    j.Vs.EditView = Bb.View.extend({
        template: "grouppage/editbuilder.template.html",
        events: {},
        renderTemplate: function() {
            var t = this,
                s;
            switch (t.options.associationId) {
                case 1:
                    s = 53234;
                    break;
                case 3:
                    s = 53235;
                    break;
                case 9:
                    s = 53253;
                    break;
                case 8:
                    s = 53255;
                    break;
                case 2:
                    s = 53227;
                    break;
                case 7:
                    s = 52435;
                    break
            }
            p3.fT(t.template, function(u) {
                t.$el.html(u({
                    noImport: false,
                    sectionId: t.options.sectionId + "/" + t.options.leadSectionId,
                    taskId: s
                }))
            })
        },
        render: function(s) {
            this.renderTemplate();
            $(s).append(this.el)
        }
    });
    j.Vs.ImportContent = Bb.View.extend({
        template: "grouppage/import.content.template.html",
        events: {
            "change #school-year-dd": "yearChanged",
            "change #section-dd": "sectionChanged",
            "click #btnApply": "saveContent"
        },
        initialize: function() {
            var s = this;
            s.leadSectionId = s.options.leadSectionId;
            s.options.schoolYears.each(function(t) {
                if (t.get("Current")) {
                    s.activeYear = t.get("Label")
                }
            });
            this.Containers = {}
        },
        render: function(s) {
            var w = this,
                u = 0,
                v = new j.Cs.ExistingSections(),
                t;
            v.fetch({
                data: {
                    facultyUserId: p3.Data.Context.get("UserInfo").UserId,
                    schoolYear: w.activeYear,
                    associationId: w.options.associationId
                },
                success: function(y, z) {
                    var x = y.toJSON();
                    x = _.uniq(x, true, function(A) {
                        return A.SectionId
                    });
                    if (x.length > 0) {
                        for (t = 0; t < x.length; t++) {
                            if (x[t].SectionId === parseInt(w.leadSectionId, 10)) {
                                x.splice(t, 1);
                                break
                            }
                        }
                        if (x.length > 0) {
                            u = x[0].SectionId
                        }
                    }
                    p3.fT(w.template, function(B) {
                        w.$el.html(B({
                            schoolYears: w.options.schoolYears.toJSON(),
                            sections: x,
                            currentSections: w.options.currentSections.toJSON()
                        }));
                        $(s).html(w.el);
                        w.Containers.Content = $("#import-content-container");
                        var A = new j.Cs.ExistingSectionContent();
                        if (u > 0) {
                            A.fetch({
                                data: {
                                    sectionId: u
                                },
                                success: function() {
                                    w.renderContent(A)
                                },
                                error: function() {
                                    p3.displayError("Error retreiving existing content.")
                                }
                            })
                        } else {
                            A.remove(A.at(0));
                            w.renderContent(A)
                        }
                    })
                },
                error: function(x, y) {
                    p3.displayError("Error retreiving sections.")
                }
            })
        },
        renderContent: function(s) {
            var u = this,
                t = new j.Vs.ImportContentList({
                    content: s
                });
            u.listView = t;
            p3.rV(t, u.Containers.Content, true);
            p3.setModalHeight(p3.Layout.Containers.Modal)
        },
        yearChanged: function(s) {
            var w = this,
                u = 0,
                v, t;
            w.activeYear = $("#school-year-dd").val();
            $("#section-dd").empty();
            v = new j.Cs.ExistingSections();
            v.fetch({
                data: {
                    facultyUserId: p3.Data.Context.get("UserInfo").UserId,
                    schoolYear: w.activeYear,
                    associationId: w.options.associationId
                },
                success: function(y, z) {
                    var x = y.toJSON();
                    x = _.uniq(x, true, function(A) {
                        return A.SectionId
                    });
                    if (x.length > 0) {
                        for (t = 0; t < x.length; t++) {
                            if (x[t].SectionId !== parseInt(w.leadSectionId, 10)) {
                                if (u === 0) {
                                    u = x[t].SectionId
                                }
                                $("<option />", {
                                    val: x[t].SectionId,
                                    text: x[t].Name
                                }).appendTo("#section-dd")
                            }
                        }
                    }
                    w.updateContent(u)
                },
                error: function(x, y) {
                    p3.displayError("Error retreiving sections.")
                }
            })
        },
        sectionChanged: function(s) {
            var t = this;
            t.updateContent($("#section-dd").val())
        },
        updateContent: function(t) {
            var u = this,
                s = new j.Cs.ExistingSectionContent();
            if (t > 0) {
                s.fetch({
                    async: false,
                    data: {
                        sectionId: t
                    },
                    success: function() {
                        u.listView.content = s;
                        u.listView.renderTemplate()
                    },
                    error: function() {
                        p3.displayError("Error retreiving existing content.")
                    }
                })
            } else {
                s.remove(s.at(0));
                u.listView.content = s;
                u.listView.renderTemplate()
            }
        },
        saveContent: function(w) {
            var E = this,
                A = [],
                v = [],
                u = "",
                D = true,
                B = true,
                C = true,
                z = "",
                x, y, s = $(".btn-select-item.active"),
                t = $(".section-checkbox:checked");
            $("div.alert-error").remove();
            if (s.length === 0) {
                D = false;
                B = false
            }
            if (t.length === 0) {
                D = false;
                C = false
            } else {
                t.each(function() {
                    if (z.length > 0) {
                        z += ","
                    }
                    z += $(this).val()
                })
            }
            if (!D) {
                x = "Please select ";
                if (!B && !C) {
                    x += "at least one content item and a section to add it to."
                } else {
                    if (!B) {
                        x += "at least one content Item."
                    } else {
                        x += "at least one section to add content to."
                    }
                }
                p3.Us.InfoMessage.ErrorBox(x, "#import-content-container", false);
                $("#site-modal .modal-body").scrollTop(1)
            } else {
                s.each(function() {
                    u = $(this).data("content");
                    A.push({
                        ContentItemId: $(this).data("item"),
                        Type: u,
                        GroupId: $(this).data("group"),
                        ContextLabelId: $(this).data("context")
                    });
                    if (v.indexOf(u) === -1) {
                        v.push(u)
                    }
                });
                y = new j.Ms.ImportContent({
                    SectionList: z,
                    ContentItems: A
                });
                y.save({}, {
                    error: function() {
                        p3.showModal(p3.Layout.Containers.Modal, "hide");
                        p3.displayError("Error importing content")
                    },
                    success: function() {
                        E.trigger("save", v);
                        p3.showModal(p3.Layout.Containers.Modal, "hide")
                    }
                })
            }
        }
    });
    j.Vs.ImportContentList = Bb.View.extend({
        template: "grouppage/import.content.list.template.html",
        events: {
            "click .content-toggle": "toggleContent",
            "click .select-all-content": "selectAllContent",
            "click .btn-select-item": "selectItem"
        },
        renderTemplate: function() {
            var v = this,
                t = [],
                s = [],
                u = 0;
            v.content.each(function(w) {
                if (w.get("content_id") !== u) {
                    u = w.get("content_id");
                    s = [];
                    t.push({
                        content_id: u,
                        description: w.get("content_type_description"),
                        contentItems: s
                    })
                }
                if (w.get("publish_date")) {
                    w.set("publish_date", w.get("publish_date").split(" ")[0])
                }
                if (w.get("expire_date")) {
                    w.set("expire_date", w.get("expire_date").split(" ")[0])
                }
                s.push(w.toJSON())
            });
            p3.fT(v.template, function(w) {
                v.$el.html(w({
                    content: t,
                    haveData: v.content.length > 0
                }))
            })
        },
        initialize: function() {
            var s = this;
            s.content = s.options.content
        },
        render: function(s) {
            this.renderTemplate();
            $(s).append(this.el)
        },
        toggleSeason: function(u) {
            var t = $(u.currentTarget),
                v = t.data("season"),
                s = $("#season" + v);
            if (s.is(":visible")) {
                s.hide(200)
            } else {
                s.show(200)
            }
        },
        toggleContent: function(u) {
            var t = $(u.currentTarget),
                v = t.data("content"),
                s = $("#content" + v);
            if (s.is(":visible")) {
                s.hide(200);
                t.find(".p3icon-downArrow").removeClass("p3icon-downArrow").addClass("p3icon-sideArrow")
            } else {
                s.show(200);
                t.find(".p3icon-sideArrow").removeClass("p3icon-sideArrow").addClass("p3icon-downArrow")
            }
        },
        selectAllContent: function(v) {
            var t = $(v.currentTarget),
                u = t.data("content"),
                s = $("#content" + u);
            if (t.hasClass("active")) {
                $(".btn-select-item[data-content='" + u + "']").removeClass("active")
            } else {
                $(".btn-select-item[data-content='" + u + "']").addClass("active");
                if (!s.is(":visible")) {
                    s.show(200);
                    $(".content-toggle[data-content='" + u + "']").find(".p3icon-sideArrow").removeClass("p3icon-sideArrow").addClass("p3icon-downArrow")
                }
            }
        },
        selectItem: function(u) {
            var s = $(u.currentTarget),
                t = s.data("content");
            if (s.hasClass("active")) {
                $(".select-all-content[data-content='" + t + "']").removeClass("active")
            } else {
                if ($(".btn-select-item.active[data-content='" + t + "']").length + 1 === $(".btn-select-item[data-content='" + t + "']").length) {
                    $(".select-all-content[data-content='" + t + "']").addClass("active")
                }
            }
        }
    });
    j.Vs.DefaultLayouts = Bb.View.extend({
        template: "grouppage/default.layouts.template.html",
        events: {
            "click .create-custom-btn": "createLevelLayout",
            "click .default-level-btn": "deleteLevelLayout"
        },
        renderTemplate: function() {
            var x = this,
                v = new j.Cs.DefaultLayouts(),
                t = [],
                s = 0,
                w, u;
            v.fetch({
                success: function() {
                    v.each(function(y) {
                        if (!y.get("LevelNum")) {
                            y.set("LevelNum", 0)
                        }
                        if (y.get("LevelNum") === 0) {
                            s += 1;
                            switch (y.get("AssociationId")) {
                                case 1:
                                    u = "p3icon-classes";
                                    break;
                                case 2:
                                    u = "p3icon-teams";
                                    break;
                                case 3:
                                    u = "p3icon-community";
                                    break;
                                case 8:
                                    u = "p3icon-activities";
                                    break;
                                case 9:
                                    u = "p3icon-advisory";
                                    break;
                                case 7:
                                    u = "p3icon-dorms";
                                    break
                            }
                            w = (s % 3 === 1);
                            if (w && s > 1) {
                                t[s - 2].endRow = true
                            }
                            t.push({
                                AssociationId: y.get("AssociationId"),
                                AssociationDescription: y.get("AssociationDescription"),
                                newRow: w,
                                icon: u,
                                Customized: y.get("Customized"),
                                levels: [],
                                BulletinBoardLayoutId: y.get("BulletinBoardLayoutId")
                            })
                        } else {
                            t[s - 1].levels.push(y.toJSON())
                        }
                    });
                    if (s > 0) {
                        t[s - 1].endRow = true
                    }
                    p3.fT(x.template, function(y) {
                        x.$el.html(y({
                            associations: t
                        }))
                    })
                },
                error: function(y, z) {
                    p3.displayError("Error getting layouts.")
                }
            })
        },
        render: function(s) {
            this.renderTemplate();
            $(s).append(this.el)
        },
        createLevelLayout: function(u) {
            var s = $(u.currentTarget),
                t = s.data("id"),
                v = s.data("level"),
                w = new j.Ms.CreateDefault({
                    LevelNum: v,
                    AssociationId: t
                });
            w.save({}, {
                success: function(x, y) {
                    p3.router().navigate("#bulletinboardedit/" + y + "/" + t, true)
                },
                error: function(x, y) {
                    p3.displayError("Error creating custom layout")
                }
            });
            u.preventDefault()
        },
        deleteLevelLayout: function(v) {
            var s = $(v.currentTarget),
                u = s.data("id"),
                t = s.data("assoc"),
                w = s.data("level"),
                x = "",
                y = new j.Ms.RemoveDefault({
                    BulletinBoardLayoutId: u
                });
            p3.showConfirm("Remove Custom Layout", "Are you sure you want to remove this custom layout?", null, function() {
                y.destroy({
                    error: function() {
                        p3.displayError("Error deleting custom layout")
                    },
                    success: function() {
                        x = '<button class="btn btn-default disabled">Use Default</button><button class="btn btn-default dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></button>';
                        x += '<ul class="dropdown-menu"><li><a href="#" class="create-custom-btn" data-id="' + t + '" data-level="' + w + '">';
                        x += "Create Custom Layout</a></li></ul>";
                        s.parents(".btn-group").html(x)
                    }
                })
            });
            v.preventDefault()
        }
    });
    j.Vs.EditDefault = Bb.View.extend({
        template: "grouppage/detail.edit.template.html",
        initialize: function() {
            this.Containers = {};
            this.LayoutId = 0
        },
        dispose: function() {
            p3.closeFixedSidebar()
        },
        render: function(s) {
            var t = this;
            $(s).html(t.el);
            p3.fT(t.template, function(u) {
                t.$el.html(u({
                    defaultLayout: true
                }));
                t.Containers.WorkspaceWrap = $(".group-page-wrap");
                t.Containers.Workspace = $("#group-workspace");
                t.selectedContent = new j.Cs.BulletinBoardLayout();
                t.selectedContent.fetch({
                    data: {
                        bulletinBoardLayoutId: t.options.BulletinBoardLayoutId
                    },
                    error: function() {
                        p3.displayError("Error loading selected content")
                    },
                    success: function() {
                        if (t.selectedContent.length > 0) {
                            t.LayoutId = t.selectedContent.models[0].get("LayoutId")
                        }
                        t.renderSidebar();
                        t.renderBuilder()
                    }
                })
            })
        },
        renderSidebar: function() {
            var t = this,
                s = {};
            t.options.sidebarView = new j.Vs.DefaultSidebar({
                parentView: t,
                associationId: t.options.AssociationId,
                LayoutId: t.LayoutId,
                selectedContent: t.selectedContent,
                BulletinBoardLayoutId: t.options.BulletinBoardLayoutId
            });
            p3.renderFixedSidebar(t.options.sidebarView, s);
            t.options.sidebarView.on("layoutChange", function(u) {
                t.LayoutId = u;
                t.selectedContent.fetch({
                    data: {
                        bulletinBoardLayoutId: t.options.BulletinBoardLayoutId
                    },
                    error: function() {
                        p3.displayError("Error loading selected content")
                    },
                    success: function() {
                        t.renderBuilder()
                    }
                })
            })
        },
        renderBuilder: function() {
            var t = this,
                s;
            s = new j.Vs.DefaultBuilder({
                layoutId: t.LayoutId,
                content: t.selectedContent,
                associationId: t.options.associationId,
                bulletinBoardLayoutId: t.options.BulletinBoardLayoutId
            });
            t.builder = s;
            p3.rV(s, t.Containers.Workspace, true);
            s.on("contentChange", function() {
                t.selectedContent.fetch({
                    data: {
                        bulletinBoardLayoutId: t.options.BulletinBoardLayoutId
                    },
                    error: function() {
                        p3.displayError("Error loading selected content")
                    },
                    success: function() {
                        t.renderBuilder()
                    }
                })
            });
            s.on("contentRemoved", function() {
                t.selectedContent.fetch({
                    data: {
                        bulletinBoardLayoutId: t.options.BulletinBoardLayoutId
                    },
                    error: function() {
                        p3.displayError("Error loading selected content")
                    },
                    success: function() {
                        t.renderSidebar()
                    }
                })
            })
        }
    });
    j.Vs.DefaultSidebar = Bb.View.extend({
        template: "grouppage/defaultsidebar.template.html",
        className: "workspace-sidebar",
        events: {
            "click .page-layout-link": "saveLayoutChange"
        },
        initialize: function() {
            this.Containers = {}
        },
        render: function(s) {
            var A = this,
                v, z = [],
                y = [],
                x = _.filter(A.options.selectedContent.toJSON(), function(B) {
                    return B.Unavailable
                }),
                w, t, u;
            w = A.options.selectedContent.pluck("ContentId");
            if (A.options.associationId.toString() === "2") {
                w.push(268)
            }
            $(s).html(A.el);
            v = new j.Cs.PossibleContent();
            v.fetch({
                data: {
                    associationId: A.options.associationId
                },
                error: function() {
                    p3.displayError("Error loading possible content")
                },
                success: function() {
                    v.each(function(B) {
                        if (w.indexOf(B.get("ContentId")) === -1) {
                            t = e.Us.findContentById(B.get("ContentId"));
                            if (t) {
                                z.push({
                                    Id: B.get("ContentId"),
                                    Name: t.Name,
                                    IconClass: t.IconClass
                                })
                            }
                        }
                    });
                    if (x && x.length > 0) {
                        for (u = 0; u < x.length; u++) {
                            t = e.Us.findContentById(x[u].ContentId);
                            if (t) {
                                y.push({
                                    Id: x[u].ContentId,
                                    Name: t.Name,
                                    IconClass: t.IconClass
                                })
                            }
                        }
                    }
                    A.unusedContent = z;
                    A.unavailableContent = y;
                    A.renderTemplate()
                }
            })
        },
        renderTemplate: function() {
            var s = this;
            p3.fT(s.template, function(v) {
                var u = j.Us.getLayoutIcon(s.options.LayoutId),
                    t = [];
                t.push({
                    Id: 408,
                    Name: "Horizontal Line",
                    IconClass: "p3icon-line"
                });
                t.push({
                    Id: 407,
                    Name: "Spacer",
                    IconClass: "p3icon-spacer"
                });
                s.$el.html(v({
                    elements: t,
                    unusedContent: s.unusedContent,
                    layoutIcon: u,
                    unavailableContent: s.unavailableContent
                }));
                window.setTimeout(function() {
                    $(".pages-layout-draggable-content").draggable({
                        connectToSortable: ".drag-region",
                        placeholder: "pages-layout-placeholder",
                        forcePlaceholderSize: true,
                        tolerance: "pointer",
                        helper: "clone",
                        delay: 300,
                        appendTo: "body"
                    }).disableSelection();
                    $(".unavailable-item").draggable({
                        connectToSortable: "#unused-content",
                        placeholder: "pages-layout-placeholder",
                        forcePlaceholderSize: true,
                        tolerance: "pointer",
                        helper: "clone",
                        delay: 300,
                        appendTo: "body"
                    }).disableSelection()
                }, 100)
            })
        },
        saveLayoutChange: function(t) {
            var w = this,
                s = $(t.currentTarget),
                u = s.data("id"),
                v;
            $(".btn-group").removeClass("open");
            if (u !== w.options.LayoutId) {
                $("#selected-layout-icon").removeClass().addClass(s.find("i").attr("class"));
                v = new j.Ms.DefaultLayoutSave({
                    BulletinBoardLayoutId: w.options.BulletinBoardLayoutId,
                    LayoutId: u,
                    ChangeLayout: true
                });
                v.save({}, {
                    async: false,
                    success: function(x, y) {
                        w.options.LayoutId = u;
                        w.trigger("layoutChange", u)
                    },
                    error: function(x, y) {
                        p3.displayError("Error changing layout")
                    }
                })
            }
            return false
        }
    });
    j.Vs.DefaultBuilder = Bb.View.extend({
        template: "grouppage/builder.template.html",
        events: {
            "click .pages-layout-block-delete": "deleteContent"
        },
        initialize: function() {
            this.Containers = {}
        },
        render: function(s) {
            var t = this;
            $(s).html(t.el);
            t.renderTemplate()
        },
        renderTemplate: function() {
            var u = this,
                t = j.Us.buildRows(u.options.layoutId),
                s;
            p3.fT(u.template, function(w) {
                u.$el.html(w({
                    rows: t,
                    showMessage: true
                }));
                var v = $("#group-workspace");
                v.css({
                    "background-color": "rgb(242,249,255)",
                    "background-image": "linear-gradient(90deg, transparent 28px, rgba(255,255,255,61) 38px)",
                    "background-size": "38px"
                });
                p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.jQueryUI, function() {
                    window.setTimeout(function() {
                        u.initSortable();
                        u.options.content.each(function(y) {
                            if (!y.get("Unavailable")) {
                                var x;
                                x = e.Us.findContentById(y.get("ContentId"));
                                if (x) {
                                    y.set("Name", x.Name);
                                    y.set("IconClass", x.IconClass)
                                }
                                s = new j.Vs.DefaultContentItem({
                                    model: y
                                });
                                p3.rV(s, $("#column" + y.get("RowIndex") + "_" + y.get("ColumnIndex")), false)
                            }
                        })
                    }, 400)
                })
            })
        },
        initSortable: function() {
            var t = this,
                s = $("#unavailable-region");
            $(".pages-layout-col").sortable({
                items: "> DIV.pages-layout-block.editable",
                connectWith: ".pages-layout-col.editable",
                handle: ".pages-layout-block-header",
                placeholder: "pages-layout-placeholder",
                forcePlaceholderSize: true,
                tolerance: "pointer",
                delay: 300,
                stop: function(z, C) {
                    var v = $(C.item),
                        u = v.closest(".pages-layout-col"),
                        x = u.data("col"),
                        B = u.data("row"),
                        y = v.data("id"),
                        w = v.index(),
                        A;
                    if (v.hasClass("workspace-draggable-item")) {
                        _.defer(function() {
                            v.remove();
                            if (y < 407) {
                                $(".pages-layout-draggable-content[data-id='" + y + "']").remove()
                            }
                        });
                        A = t.getLayoutOrder(B, x, w, 0);
                        t.addContent(A, y, B, x, w, false)
                    } else {
                        A = t.getLayoutOrder(-1, -1, -1, 0);
                        t.saveLayout(A, false, false)
                    }
                }
            });
            s.sortable({
                items: ".available-content",
                connectWith: ".available-content",
                handle: ".available-content",
                placeholder: "pages-layout-placeholder",
                forcePlaceholderSize: true,
                tolerance: "pointer",
                delay: 300,
                stop: function(w, y) {
                    var u = $(y.item),
                        v = u.data("id"),
                        x;
                    if (v < 407) {
                        x = t.getLayoutOrder(-1, -1, -1, 0);
                        t.addContent(x, v, 0, 0, 0, true)
                    } else {
                        s.sortable("cancel");
                        u.remove()
                    }
                }
            });
            $("#unused-content").sortable({
                items: ".unavailable-item",
                connectWith: ".unavailable-item",
                handle: ".unavailable-item",
                placeholder: "pages-layout-placeholder",
                forcePlaceholderSize: true,
                tolerance: "pointer",
                delay: 300,
                stop: function(u, v) {
                    t.saveLayout(t.getLayoutOrder(-1, -1, -1, $(v.item).data("id")), false, true)
                }
            })
        },
        getLayoutOrder: function(A, t, x, w) {
            var u = [],
                s = -1,
                z = -1,
                y = -1,
                v;
            $(".pages-layout-col").each(function(B, C) {
                z = $(C).data("row");
                s = $(C).data("col");
                y = -1;
                $(C).find(".pages-layout-block").each(function(E, D) {
                    if (A === z && t === s && E === x) {
                        y += 2
                    } else {
                        y += 1
                    }
                    v = $(D).find(".pages-layout-block-header").data("id");
                    if (v) {
                        u.push({
                            ContentId: v,
                            RowIndex: z,
                            ColumnIndex: s,
                            CellIndex: y
                        })
                    }
                })
            });
            $(".unavailable-item").each(function() {
                v = $(this).data("id");
                if (v && v !== w) {
                    u.push({
                        ContentId: v,
                        RowIndex: 0,
                        ColumnIndex: 0,
                        CellIndex: 0,
                        Unavailable: true
                    })
                }
            });
            return u
        },
        saveLayout: function(t, u, s) {
            var w = this,
                v;
            v = new j.Ms.DefaultLayoutSave({
                BulletinBoardLayoutId: w.options.bulletinBoardLayoutId,
                LayoutId: w.options.layoutId,
                ChangeLayout: false,
                ContentItems: t
            });
            v.save({}, {
                success: function(x, y) {
                    if (u) {
                        w.trigger("contentChange")
                    } else {
                        if (s) {
                            w.trigger("contentRemoved");
                            window.setTimeout(function() {
                                w.initSortable()
                            }, 400)
                        } else {
                            w.trigger("contentMove")
                        }
                    }
                },
                error: function(x, y) {
                    p3.displayError("Error changing layout")
                }
            })
        },
        addContent: function(v, u, w, t, s, x) {
            var y = this;
            v.push({
                ContentId: u,
                RowIndex: w,
                ColumnIndex: t,
                CellIndex: s,
                Unavailable: x
            });
            y.saveLayout(v, !x, x)
        },
        deleteContent: function(u) {
            u.preventDefault();
            var s = $(u.currentTarget),
                t = s.data("id"),
                v = this;
            s.parents(".pages-layout-block").remove();
            v.saveLayout(v.getLayoutOrder(-1, -1, -1, 0), false, t < 404)
        }
    });
    j.Vs.DefaultContentItem = Bb.View.extend({
        className: "pages-layout-block editable",
        template: "grouppage/defaultcontent.block.template.html",
        renderTemplate: function() {
            var s = this;
            p3.fT(s.template, function(t) {
                s.$el.html(t({
                    contentInfo: s.model.toJSON(),
                    canRemove: true
                }))
            })
        },
        initialize: function() {
            var s = this;
            s.Containers = {}
        },
        render: function(s) {
            $(s).append(this.el);
            this.renderTemplate()
        }
    });
    j.Us.getLayoutIcon = function(t) {
        var s = "";
        switch (t) {
            case 0:
                s = "p3icon-2colLeft";
                break;
            case 1:
                s = "p3icon-2colRight";
                break;
            case 2:
                s = "p3icon-2rowLeft";
                break;
            case 3:
                s = "p3icon-2rowRight";
                break;
            case 4:
                s = "p3icon-2colSplit";
                break;
            case 5:
                s = "p3icon-3col";
                break
        }
        return s
    };
    j.Us.getContextLabel = function(s) {
        var t;
        switch (s) {
            case 1:
                t = 2;
                break;
            case 3:
                t = 12;
                break;
            case 9:
                t = 22;
                break;
            case 8:
                t = 24;
                break;
            case 2:
                t = 3;
                break;
            case 7:
                t = 23;
                break
        }
        return t
    };
    j.Us.initDraggable = function() {
        window.setTimeout(function() {
            $(".pages-layout-draggable-content").draggable({
                connectToSortable: ".pages-layout-col.editable",
                placeholder: "pages-layout-placeholder",
                forcePlaceholderSize: true,
                tolerance: "pointer",
                helper: "clone",
                delay: 300,
                appendTo: "body"
            }).disableSelection()
        }, 300)
    };
    j.Us.getBulletinBoardUrl = function(s, t) {
        var u = "";
        switch (s) {
            case 1:
                u = "#academicclass/" + t + "/0/bulletinboard";
                break;
            case 3:
                u = "#communitypage/" + t + "/bulletinboard";
                break;
            case 9:
                u = "#advisorypage/" + t + "/bulletinboard";
                break;
            case 8:
                u = "#activitypage/" + t + "/bulletinboard";
                break;
            case 2:
                u = "#athleticteam/" + t + "/teampage";
                break;
            case 7:
                u = "#dormpage/" + t + "/bulletinboard";
                break
        }
        return u
    };
    j.Us.loadPageEditor = function(u, v, s, t) {
        p3.renderMainPage(new j.Vs.EditDetail({
            leadSectionId: u,
            sectionId: v,
            associationId: s,
            contextLabelId: t
        }))
    };
    j.Us.isNarrowColumn = function(v, s, u) {
        var t = false;
        if (u === 5) {
            t = true
        } else {
            if (u < 4) {
                switch (u) {
                    case 0:
                        if (v === 0 && s === 1) {
                            t = true
                        }
                        break;
                    case 1:
                        if (v === 0 && s === 0) {
                            t = true
                        }
                        break;
                    case 2:
                        if (v === 1 && s === 1) {
                            t = true
                        }
                        break;
                    case 3:
                        if (v === 1 && s === 0) {
                            t = true
                        }
                        break
                }
            }
        }
        return t
    };
    j.Us.buildRows = function(t) {
        var u = [],
            s = [];
        u.push({
            rowId: 0,
            columns: s
        });
        switch (t) {
            case 0:
                s.push({
                    rowId: 0,
                    colId: 0,
                    className: "span9 col-md-9"
                });
                s.push({
                    rowId: 0,
                    colId: 1,
                    className: "span3 col-md-3"
                });
                break;
            case 1:
                s.push({
                    rowId: 0,
                    colId: 0,
                    className: "span3 col-md-3"
                });
                s.push({
                    rowId: 0,
                    colId: 1,
                    className: "span9 col-md-9"
                });
                break;
            case 2:
                s.push({
                    rowId: 0,
                    colId: 0,
                    className: "span12 col-md-12"
                });
                s = [];
                u.push({
                    rowId: 1,
                    columns: s
                });
                s.push({
                    rowId: 1,
                    colId: 0,
                    className: "span9 col-md-9"
                });
                s.push({
                    rowId: 1,
                    colId: 1,
                    className: "span3 col-md-3"
                });
                break;
            case 3:
                s.push({
                    rowId: 0,
                    colId: 0,
                    className: "span12 col-md-12"
                });
                s = [];
                u.push({
                    rowId: 1,
                    columns: s
                });
                s.push({
                    rowId: 1,
                    colId: 0,
                    className: "span3 col-md-3"
                });
                s.push({
                    rowId: 1,
                    colId: 1,
                    className: "span9 col-md-9"
                });
                break;
            case 4:
                s.push({
                    rowId: 0,
                    colId: 0,
                    className: "span6 col-md-6"
                });
                s.push({
                    rowId: 0,
                    colId: 1,
                    className: "span6 col-md-6"
                });
                break;
            case 5:
                s.push({
                    rowId: 0,
                    colId: 0,
                    className: "span4 col-md-4"
                });
                s.push({
                    rowId: 0,
                    colId: 1,
                    className: "span4 col-md-4"
                });
                s.push({
                    rowId: 0,
                    colId: 2,
                    className: "span4 col-md-4"
                });
                break
        }
        return u
    };
    j.Us.getCusomHeader = function(t) {
        var s = "",
            u;
        if (t.get("GenericSettings")) {
            u = JSON.parse(t.get("GenericSettings"));
            s = u.HeaderText
        }
        return s
    };
    p3.router().route("grouppreview/:leadsectionid/:sectionid/:association/:pending/:layoutid", "grouppreview", function(v, x, s, w, u) {
        var t = new j.Cs.Content({}, {
            sectionId: x,
            leadSectionId: v
        });
        t.fetch({
            error: function() {
                p3.displayError("Error loading available content")
            },
            success: function() {
                var y = (w === "true");
                p3.renderMainPage(new j.Vs.LayoutView({
                    sectionId: x,
                    leadSectionId: v,
                    associationId: s,
                    preview: true,
                    pendingInd: y,
                    layoutId: parseInt(u, 10),
                    content: t,
                    contextLabelId: j.Us.getContextLabel(parseInt(s, 10))
                }))
            }
        })
    });
    p3.router().route("bulletinboardlayout", "bulletinboardlayout", function() {
        p3.renderMainPage(new j.Vs.DefaultLayouts())
    });
    p3.router().route("bulletinboardedit/:id/:association", "bulletinboardedit", function(t, s) {
        p3.renderMainPage(new j.Vs.EditDefault({
            BulletinBoardLayoutId: t,
            AssociationId: s
        }))
    })
}(p3.module("LMS/groupPageEdit")));
(function(c) {
    var a = p3.module("shared/datepicker"),
        b = p3.Us.Enum;
    c.Data = {};
    c.Cs.SchoolYears = Bbc.extend({
        url: "DataDirect/SchoolYearsGet?display=0"
    });
    c.Cs.SchoolLevels = Bbc.extend({
        url: "DataDirect/SchoolLevelAssocGet"
    });
    c.Cs.GroupsByAssoc = Bbc.extend({
        url: "DataDirect/GroupsByAssociationGet"
    });
    c.Cs.GroupsPageAccess = Bbc.extend({
        url: "GroupAccess/GroupPageAccessGet"
    });
    c.Cs.UserTypes = Bbc.extend({
        url: "GroupAccess/AvailableUserTypesGet"
    });
    c.Ms.GroupsPageAccess = Bbm.extend({
        url: "GroupAccess/GroupPageAccessSave"
    });
    c.Ms.UserTypesAdd = Bbm.extend({
        url: "GroupAccess/AddUserTypes"
    });
    c.Ms.GroupsPageAccessDelete = Bbm.extend({
        idAttribute: "AppAssociationGroupId",
        url: function() {
            return aP + "GroupAccess/GroupPageAccessDelete/?format=json&agId=" + this.get("AppAssociationGroupId") + "&userType=" + this.get("UserTypeId") + "&associationId=" + this.get("AssociationId") + "&schoolYearLabel=" + this.get("SchoolYearLabel") + "&levelNum=" + this.get("LevelNum")
        }
    });
    c.Ms.GroupsPageOptions = Bbm.extend({
        url: "GroupOptions/GroupOptionsSave"
    });
    c.Cs.GroupsPageOption = Bbc.extend({
        url: "GroupOptions/GroupOptionsGet"
    });
    c.Vs.Layout = Bb.View.extend({
        template: "grouppagesettings/group.page.settings.template.html",
        events: {
            "click .group-type-btn": "associationChange"
        },
        initialize: function() {
            c.Data.SchoolYear = p3.Data.SchoolContext.get("CurrentSchoolYear").SchoolYearLabel;
            c.Data.ByLevel = true;
            c.Data.Assoc = b.Associations.ACADEMICS.Value;
            c.Data.SectionId = 0;
            this.groupOptions = this.options.groupOptions
        },
        render: function(d) {
            var e = this;
            $(d).html(e.el);
            e.renderTemplate()
        },
        renderTemplate: function() {
            var j = this,
                f, d, e, i, g, h;
            f = p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.COURSEMANAGEMENT) && p3.Data.Context.findByTaskId(52442);
            d = p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.ACTIVITYGROUPS) && p3.Data.Context.findByTaskId(52443);
            e = p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.ADVISORYGROUP) && p3.Data.Context.findByTaskId(52444);
            i = p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.ATHLETICGROUPS) && p3.Data.Context.findByTaskId(52446);
            g = p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.COMMUNITYGROUPS) && p3.Data.Context.findByTaskId(52447);
            h = p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.DORMGROUPS) && p3.Data.Context.findByTaskId(52448);
            if (!f && c.Data.Assoc === b.Associations.ACADEMICS.Value) {
                if (d) {
                    c.Data.Assoc = b.Associations.ACTIVITY.Value
                } else {
                    if (e) {
                        c.Data.Assoc = b.Associations.ADVISORY.Value
                    } else {
                        if (i) {
                            c.Data.Assoc = b.Associations.ATHLETICS.Value
                        } else {
                            if (g) {
                                c.Data.Assoc = b.Associations.COMMUNITY.Value
                            } else {
                                if (h) {
                                    c.Data.Assoc = b.Associations.DORM.Value
                                }
                            }
                        }
                    }
                }
            }
            p3.fT(j.template, function(k) {
                j.$el.html(k({
                    activeAssoc: c.Data.Assoc,
                    classes: f,
                    activities: d,
                    advisories: e,
                    teams: i,
                    communities: g,
                    dorms: h,
                    groupOptions: j.groupOptions
                }));
                j.Containers = [];
                j.Containers.Filters = $("#access-filters");
                j.Containers.Settings = $("#access-settings");
                j.renderFilter()
            })
        },
        renderFilter: function() {
            var f = this,
                d, e;
            if (c.Data.SchoolYears == null) {
                c.Data.SchoolYears = new c.Cs.SchoolYears();
                c.Data.SchoolYears.fetch({
                    async: false,
                    error: function() {
                        p3.displayError("Error getting school years.")
                    }
                })
            }
            if (c.Data.Assoc === 3) {
                c.Data.SchoolYear = ""
            } else {
                if (c.Data.SchoolYear === "") {
                    c.Data.SchoolYear = p3.Data.SchoolContext.get("CurrentSchoolYear").SchoolYearLabel
                }
            }
            e = new c.Cs.SchoolLevels();
            e.fetch({
                data: {
                    associationId: c.Data.Assoc,
                    schoolYearLabel: c.Data.SchoolYear
                },
                error: function() {
                    p3.displayError("Error getting school levels.")
                },
                success: function() {
                    if (e.length > 0) {
                        c.Data.SchoolLevel = e.models[0].get("level_num")
                    } else {
                        c.Data.SchoolLevel = 0
                    }
                    d = new c.Vs.Filters({
                        SchoolLevels: e,
                        groupOptions: f.groupOptions
                    });
                    p3.rV(d, f.Containers.Filters, true);
                    if (f.groupOptions) {
                        f.renderOptions()
                    } else {
                        f.renderAccess()
                    }
                    d.on("filterChange", function() {
                        if (f.groupOptions) {
                            f.renderOptions()
                        } else {
                            f.renderAccess()
                        }
                    })
                }
            })
        },
        associationChange: function(d) {
            c.Data.Assoc = parseInt($(d.currentTarget).data("assoc"), 10);
            c.Data.ByLevel = true;
            c.Data.SectionId = 0;
            $(".group-type-btn").parent().removeClass("active");
            $(d.currentTarget).parent().addClass("active");
            this.renderFilter();
            d.preventDefault()
        },
        renderAccess: function() {
            var j = this,
                d = new c.Cs.GroupsPageAccess(),
                g = null,
                e, f = true,
                h, i;
            if (!c.Data.ByLevel) {
                g = c.Data.SectionId;
                f = g > 0
            }
            if (f) {
                d.fetch({
                    data: {
                        schoolYear: c.Data.SchoolYear,
                        association: c.Data.Assoc,
                        level: c.Data.SchoolLevel,
                        pk: g
                    },
                    async: false,
                    error: function() {
                        p3.displayError("Error getting access.")
                    },
                    success: function() {
                        e = new c.Vs.Access({
                            access: d
                        });
                        p3.rV(e, j.Containers.Settings, e);
                        e.on("accessAdded", function() {
                            j.renderAccess()
                        })
                    }
                })
            } else {
                h = c.Us.GetSectionLabel().toLowerCase();
                i = '<h5 style="margin-top:5px;">Please Select a';
                if (c.Data.Assoc === b.Associations.ACTIVITY.Value || c.Data.Assoc === b.Associations.ADVISORY.Value) {
                    i += "n"
                }
                $("#access-settings").html(i + " " + h + ".</h5>")
            }
        },
        renderOptions: function() {
            var j = this,
                e = new c.Cs.GroupsPageOption(),
                g = null,
                f, d = true,
                h, i;
            if (!c.Data.ByLevel) {
                g = c.Data.SectionId;
                d = g > 0
            }
            if (d) {
                e.fetch({
                    data: {
                        schoolYear: c.Data.SchoolYear,
                        association: c.Data.Assoc,
                        level: c.Data.SchoolLevel,
                        pk: g
                    },
                    async: false,
                    error: function() {
                        p3.displayError("Error getting options.")
                    },
                    success: function() {
                        f = new c.Vs.Options({
                            groupOptions: e.models[0]
                        });
                        p3.rV(f, j.Containers.Settings, true)
                    }
                })
            } else {
                h = c.Us.GetSectionLabel().toLowerCase();
                i = '<h5 style="margin-top:5px;">Please Select a';
                if (c.Data.Assoc === b.Associations.ACTIVITY.Value || c.Data.Assoc === b.Associations.ADVISORY.Value) {
                    i += "n"
                }
                $("#access-settings").html(i + " " + h + ".</h5>")
            }
        }
    });
    c.Vs.Filters = Bb.View.extend({
        template: "grouppagesettings/group.page.access.filter.template.html",
        events: {
            "change #year-dropdown": "yearChanged",
            "change #level-dropdown": "levelChanged",
            "click #level-button": "accessTypeChanged",
            "click #class-button": "accessTypeChanged",
            "click #class-search-form": "searchClicked",
            "keyup #class-search": "searchClasses",
            "submit #class-search-form": "searchClasses",
            "click .class-item": "classClicked",
            "click #remove-access-link": "removeCustomAccess",
            "click #remove-all-access-link": "removeAllAccess"
        },
        render: function(d) {
            var e = this;
            $(d).html(e.el);
            e.renderTemplate()
        },
        renderTemplate: function() {
            var e = this,
                d = "A",
                f = c.Data.SchoolYears.toJSON();
            if (c.Data.Assoc === b.Associations.ACTIVITY.Value || c.Data.Assoc === b.Associations.ADVISORY.Value) {
                d = "An"
            }
            if (c.Data.Assoc === 3) {
                f.unshift({
                    Id: "",
                    Description: "Continuous"
                })
            }
            p3.fT(e.template, function(g) {
                e.$el.html(g({
                    SchoolYears: f,
                    SchoolLevels: e.options.SchoolLevels.toJSON(),
                    ByLevel: c.Data.ByLevel,
                    CurrentYear: c.Data.SchoolYear,
                    CurrentLevel: c.Data.SchoolLevel,
                    sectionText: c.Us.GetSectionLabel(),
                    pluralText: c.Us.GetSectionPlural(),
                    a: d,
                    lowerText: c.Us.GetSectionLabel().toLowerCase(),
                    groupOptions: e.options.groupOptions
                }))
            })
        },
        getSchoolLevels: function() {
            var d = new c.Cs.SchoolLevels();
            d.fetch({
                data: {
                    associationId: c.Data.Assoc,
                    schoolYearLabel: c.Data.SchoolYear
                },
                async: false,
                error: function() {
                    p3.displayError("Error getting school levels.")
                },
                success: function() {
                    if (d.length > 0) {
                        c.Data.SchoolLevel = d.models[0].get("level_num")
                    } else {
                        c.Data.SchoolLevel = 0
                    }
                }
            });
            return d
        },
        getGroups: function() {
            var d = new c.Cs.GroupsByAssoc();
            d.fetch({
                data: {
                    associationId: c.Data.Assoc,
                    schoolYearLabel: c.Data.SchoolYear,
                    levelNum: c.Data.SchoolLevel
                },
                async: false,
                error: function() {
                    p3.displayError("Error getting groups.")
                }
            });
            return d
        },
        yearChanged: function() {
            var e = this,
                d;
            c.Data.SchoolYear = $("#year-dropdown").val();
            c.Data.ByLevel = true;
            c.Data.SectionId = 0;
            c.Us.setClassDropdownText();
            $("#level-button").addClass("active");
            $("#class-button").removeClass("active");
            $("#class-dropdown-region").hide();
            $("#custom-note").hide();
            $("#remove-access-link").hide();
            $("#level-text").show();
            $("#group-text").hide();
            $("#level-dropdown").empty();
            d = e.getSchoolLevels();
            d.each(function(f) {
                $("<option />", {
                    val: f.get("level_num"),
                    text: f.get("level_description")
                }).appendTo("#level-dropdown")
            });
            e.trigger("filterChange")
        },
        levelChanged: function() {
            var d = this;
            c.Data.SchoolLevel = $("#level-dropdown").val();
            c.Data.SectionId = 0;
            c.Us.setClassDropdownText();
            if (!c.Data.ByLevel) {
                d.updateGroups()
            }
            $("#remove-access-link").hide();
            d.trigger("filterChange")
        },
        updateGroups: function() {
            var d = this;
            $("#groups-dd").empty();
            d.groups = d.getGroups();
            $("#class-list").empty();
            d.groups.each(function(e) {
                $("#class-list").append('<li class="select-item-li" style="margin-right:10px;"><a href="#" class="select-item class-item" data-val="' + e.get("pk") + '">' + e.get("group_name") + (e.get("custom_access") ? " (C)" : "") + "</a></li>")
            })
        },
        accessTypeChanged: function(d) {
            if (!$(d.currentTarget).hasClass("active")) {
                if (d.currentTarget.id === "level-button") {
                    c.Data.ByLevel = true;
                    $("#class-dropdown-region").hide();
                    $("#level-text").show();
                    $("#group-text").hide();
                    $("#custom-note").hide();
                    $("#remove-access-link").hide();
                    $("#remove-all-access-link").hide()
                } else {
                    c.Data.ByLevel = false;
                    this.updateGroups();
                    $("#class-dropdown-region").show();
                    $("#level-text").hide();
                    $("#group-text").show();
                    $("#custom-note").show();
                    if (!this.options.groupOptions) {
                        $("#remove-all-access-link").show()
                    }
                }
                this.trigger("filterChange")
            }
        },
        searchClicked: function(d) {
            d.stopPropagation();
            $("#class-search").focus();
            return false
        },
        searchClasses: function(d) {
            d.preventDefault();
            var h = this,
                g, f;
            f = h.groups.toJSON();
            g = $("#class-search").val();
            if (g && g.length > 0) {
                f = _.filter(f, function(e) {
                    return (e.group_name.toLowerCase().indexOf(g.toLowerCase()) > -1)
                })
            }
            $("#class-list").empty();
            _.each(f, function(e) {
                $("#class-list").append('<li class="select-item-li" style="margin-right:10px;"><a href="#" class="select-item class-item" data-val="' + e.pk + '">' + e.group_name + (e.custom_access ? " (C)" : "") + "</a></li>")
            })
        },
        classClicked: function(f) {
            var d = $(f.currentTarget),
                g = d.html();
            $("#selected-class").data("value", d.data("val"));
            if (g.indexOf(" (C)") === -1) {
                d.html(g + " (C)");
                $("#selected-class").html(g + " (C)")
            } else {
                $("#selected-class").html(g)
            }
            c.Data.SectionId = d.data("val");
            if (d.data("val") > 0) {
                $("#remove-access-link").show()
            } else {
                $("#remove-access-link").hide()
            }
            this.trigger("filterChange");
            f.preventDefault()
        },
        removeCustomAccess: function(f) {
            var g = this,
                d;
            p3.showConfirm("Remove Access", "Are you sure you want to remove custom access?", null, function() {
                d = new c.Ms.GroupsPageAccessDelete({
                    AppAssociationGroupId: c.Data.AGA
                });
                d.destroy({
                    error: function() {
                        p3.displayError("Error removing access")
                    },
                    success: function() {
                        $("#selected-class").data("value", 0);
                        $("#selected-class").html(c.Us.setClassDropdownText());
                        c.Data.SectionId = 0;
                        $("#remove-access-link").hide();
                        g.updateGroups();
                        g.trigger("filterChange")
                    }
                })
            })
        },
        removeAllAccess: function(f) {
            var g = this,
                d;
            p3.showConfirm("Remove All Custom Access", "Are you sure you want to remove all customized access?", null, function() {
                d = new c.Ms.GroupsPageAccessDelete({
                    AppAssociationGroupId: 0,
                    AssociationId: c.Data.Assoc,
                    SchoolYearLabel: c.Data.SchoolYear,
                    LevelNum: c.Data.SchoolLevel
                });
                d.destroy({
                    error: function() {
                        p3.displayError("Error removing access")
                    },
                    success: function() {
                        $("#selected-class").data("value", 0);
                        $("#selected-class").html(c.Us.setClassDropdownText());
                        c.Data.SectionId = 0;
                        $("#remove-access-link").hide();
                        g.updateGroups();
                        g.trigger("filterChange")
                    }
                })
            })
        }
    });
    c.Vs.Access = Bb.View.extend({
        template: "grouppagesettings/group.page.access.template.html",
        events: {
            "click .access-icon": "accessChange",
            "mouseover td.inline-edit": "handleHover",
            "mouseout td.inline-edit": "handleHoverOff",
            "click td.inline-edit": "inlineEdit",
            "blur INPUT": "datepickerBlur",
            "click .remove-access": "removeAccess",
            "click #add-access": "addAccess"
        },
        render: function(d) {
            var e = this;
            $(d).html(e.el);
            e.renderTemplate()
        },
        renderTemplate: function() {
            var g = this,
                e = c.Data.Assoc === b.Associations.ATHLETICS.Value,
                d = c.Data.Assoc === b.Associations.ACADEMICS.Value,
                f = c.Data.Assoc !== b.Associations.ATHLETICS.Value;
            g.appAssociationGroupId = g.options.access.models[0].get("AppAssociationGroupId");
            c.Data.AGA = g.appAssociationGroupId;
            p3.fT(g.template, function(h) {
                g.$el.html(h({
                    access: g.options.access.toJSON(),
                    showSchedule: e,
                    showAssign: d,
                    showTopic: f
                }))
            })
        },
        accessChange: function(g) {
            var f = $(g.currentTarget),
                d = f.parents("tr");
            if (f.data("access") === "ListOnly") {
                d.find(".access-icon").removeClass("p3icon-ok").addClass("p3icon-check");
                f.removeClass("p3icon-check").addClass("p3icon-ok")
            } else {
                if (f.hasClass("p3icon-check")) {
                    f.removeClass("p3icon-check").addClass("p3icon-ok");
                    d.find(".access-icon[data-access='ListOnly']").removeClass("p3icon-ok").addClass("p3icon-check")
                } else {
                    f.removeClass("p3icon-ok").addClass("p3icon-check");
                    if (d.find(".access-icon.p3icon-ok").length === 0) {
                        d.find(".access-icon[data-access='ListOnly']").removeClass("p3icon-check").addClass("p3icon-ok")
                    }
                }
            }
            this.saveAccess(d)
        },
        saveAccess: function(d, g) {
            var n = this,
                i = new c.Ms.GroupsPageAccess(),
                h = false,
                f = false,
                m = false,
                j = false,
                e = false,
                l = false,
                k;
            d.find(".access-icon").each(function() {
                switch ($(this).data("access")) {
                    case "ListOnly":
                        h = $(this).hasClass("p3icon-ok");
                        break;
                    case "BulletinBoardAccess":
                        f = $(this).hasClass("p3icon-ok");
                        break;
                    case "TopicAccess":
                        m = $(this).hasClass("p3icon-ok");
                        break;
                    case "RosterAccess":
                        j = $(this).hasClass("p3icon-ok");
                        break;
                    case "AssignmentAccess":
                        e = $(this).hasClass("p3icon-ok");
                        break;
                    case "ScheduleAccess":
                        l = $(this).hasClass("p3icon-ok");
                        break
                }
            });
            if (g) {
                k = g
            } else {
                k = d.find(".inline-edit").data("date")
            }
            i.set({
                AppAssociationGroupId: n.appAssociationGroupId,
                UserTypeId: d.data("id"),
                BulletinBoardAccess: f,
                TopicAccess: m,
                RosterAccess: j,
                AssignmentAccess: e,
                ScheduleAccess: l,
                StartDate: k,
                ListOnly: h
            });
            i.save({}, {
                error: function() {
                    p3.displayError("Error saving group page access")
                }
            })
        },
        handleHover: function(f) {
            var d = $(f.target).closest("td");
            if ($(".edit-cell-icon").length === 0) {
                if (!d.hasClass("edit-cell")) {
                    d.prepend($("<i>", {
                        "class": "p3icon-edit edit-cell-icon pull-right"
                    }))
                }
                d.addClass("on");
                d.mouseleave(function() {
                    if (d.hasClass("on")) {
                        d.removeClass("on")
                    }
                })
            }
        },
        handleHoverOff: function(d) {
            if (!$(d.target).hasClass("on")) {
                this.$("i.edit-cell-icon").remove()
            }
        },
        inlineEdit: function(f) {
            var d = $(f.target).closest("td");
            if (!d.hasClass("edit-cell")) {
                d.html('<input type="text" class="start-date-box input-small" value="' + d.find("P").html() + '"/>');
                d.addClass("edit-cell");
                d.find(".start-date-box").focus();
                a.Us.initialize(".start-date-box", {
                    numberOfMonths: 1,
                    stepMonths: 1,
                    defaultDate: d.find("P").html(),
                    show: true,
                    onClose: function() {
                        $(this).trigger("blur", {
                            propagate: true
                        })
                    }
                })
            }
        },
        inlineClose: function(g, e) {
            var d, f, h;
            d = $(g.target);
            h = d.closest("td").data("date");
            f = d.val();
            if (f && f.length > 0) {
                if (h !== f) {
                    this.saveAccess(d.parents("tr"), f);
                    d.closest("td").data("date", f).removeClass("edit-cell").html('<p style="margin:3px 0px 0px 0px">' + f + "</p>")
                } else {
                    d.closest("td").removeClass("edit-cell").html('<p style="margin:3px 0px 0px 0px">' + h + "</p>")
                }
            }
        },
        datepickerBlur: function(e, d) {
            if (d && d.propagate) {
                this.inlineClose(e)
            } else {
                e.stopPropagation()
            }
        },
        removeAccess: function(g) {
            var i = this,
                d = $(g.currentTarget).parents("tr.access-row"),
                h = d.data("id"),
                f;
            p3.showConfirm("Remove Access", "Are you sure you want to remove access?", null, function() {
                f = new c.Ms.GroupsPageAccessDelete({
                    AppAssociationGroupId: i.appAssociationGroupId,
                    UserTypeId: h
                });
                f.destroy({
                    error: function() {
                        p3.displayError("Error removing access")
                    },
                    success: function() {
                        d.remove()
                    }
                })
            })
        },
        addAccess: function(f) {
            var g = this,
                d = new c.Vs.AddAccess({
                    appAssociationGroupId: g.appAssociationGroupId
                });
            p3.rV(d, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            d.on("accessAdded", function() {
                g.trigger("accessAdded")
            })
        }
    });
    c.Vs.Options = Bb.View.extend({
        template: "grouppagesettings/group.page.options.template.html",
        events: {
            "click .feed-icon": "optionChange",
            "click .integration-icon": "optionChange",
            "change #assign-dropdown": "assignOptionChange"
        },
        render: function(d) {
            var e = this;
            $(d).html(e.el);
            e.renderTemplate()
        },
        renderTemplate: function() {
            var f = this,
                d = f.options.groupOptions.get("Feeds"),
                e;
            f.appAssociationGroupId = d[0].AppAssociationGroupId;
            for (e = 0; e < d.length; e++) {
                switch (d[e].ContentId) {
                    case 5:
                        d[e].Description = "iCal-Events";
                        break;
                    case 6:
                        d[e].Description = "RSS-News";
                        break;
                    case 10:
                        d[e].Description = "RSS-Announcements";
                        break;
                    case 45:
                        d[e].Description = "iCal-Team Schedule";
                        break;
                    case 58:
                        d[e].Description = "iCal-Assignments";
                        break;
                    case 69:
                        d[e].Description = "iCal-Practice Schedule";
                        break;
                    case 87:
                        d[e].Description = "iCal-Schedule";
                        break;
                    case 165:
                        d[e].Description = "Audio Podcast";
                        break
                }
            }
            p3.fT(f.template, function(g) {
                f.$el.html(g({
                    feeds: d,
                    integrations: f.options.groupOptions.get("Integrations"),
                    haveIntegrations: f.options.groupOptions.get("Integrations").length > 0
                }))
            })
        },
        optionChange: function(f) {
            var d = $(f.currentTarget);
            if (d.hasClass("p3icon-check")) {
                d.removeClass("p3icon-check").addClass("p3icon-ok")
            } else {
                d.removeClass("p3icon-ok").addClass("p3icon-check")
            }
            this.saveAccess()
        },
        assignOptionChange: function() {
            this.saveAccess()
        },
        saveAccess: function(d, e) {
            var i = this,
                h = new c.Ms.GroupsPageOptions(),
                f = [],
                g = [];
            $(".feed-icon").each(function() {
                if ($(this).data("id") === 58) {
                    f.push({
                        ContentId: 58,
                        Enabled: $(this).hasClass("p3icon-ok"),
                        AssignmentOption: $("#assign-dropdown").val()
                    })
                } else {
                    f.push({
                        ContentId: $(this).data("id"),
                        Enabled: $(this).hasClass("p3icon-ok"),
                        AssignmentOption: $("#assignment-dropdown").val()
                    })
                }
            });
            $(".integration-icon").each(function() {
                g.push({
                    VendorId: $(this).data("id"),
                    Enabled: $(this).hasClass("p3icon-ok")
                })
            });
            h.set({
                AppAssociationGroupId: i.appAssociationGroupId,
                Feeds: f,
                Integrations: g
            });
            h.save({}, {
                error: function() {
                    p3.displayError("Error saving group page options")
                }
            })
        }
    });
    c.Vs.AddAccess = Bb.View.extend({
        template: "grouppagesettings/group.page.add.access.template.html",
        events: {
            "click #btnSave": "saveAccess",
            "click #view-all-button": "viewAllClick"
        },
        renderTemplate: function() {
            var h = this,
                g = new c.Cs.UserTypes(),
                f, d, e;
            g.fetch({
                data: {
                    appAssocationGroupId: h.options.appAssociationGroupId
                },
                success: function() {
                    f = g.toJSON();
                    d = _.filter(f, function(i) {
                        return i.TopSection
                    });
                    e = _.filter(f, function(i) {
                        return !i.TopSection
                    });
                    p3.fT(h.template, function(i) {
                        h.$el.html(i({
                            primaryTypes: d,
                            secondaryTypes: e,
                            showSecondary: e.length > 0
                        }))
                    })
                },
                error: function() {
                    p3.displayError("Error getting available user types.")
                }
            })
        },
        render: function(d) {
            var e = this;
            $(d).append(this.el);
            e.renderTemplate()
        },
        saveAccess: function(d) {
            var h = this,
                f, g = [];
            if ($(".user-type-button.active").length > 0) {
                $("#btnSave").button("loading");
                $(".user-type-button.active").each(function(e) {
                    g.push({
                        UserTypeId: $(this).data("id")
                    })
                });
                f = new c.Ms.UserTypesAdd({
                    AppAssociationGroupId: h.options.appAssociationGroupId,
                    UserTypes: g
                });
                f.save({}, {
                    error: function() {
                        p3.showModal(p3.Layout.Containers.Modal, "hide");
                        p3.displayError("Error saving user types.")
                    },
                    success: function() {
                        h.trigger("accessAdded");
                        p3.showModal(p3.Layout.Containers.Modal, "hide")
                    }
                })
            }
        },
        viewAllClick: function(d) {
            if ($("#all").is(":visible")) {
                $("#all").hide()
            } else {
                $("#all").show()
            }
            p3.setModalHeight(p3.Layout.Containers.Modal);
            d.preventDefault()
        }
    });
    c.Us.setClassDropdownText = function() {
        var e = c.Us.GetSectionLabel(),
            d = "A";
        if (c.Data.Assoc === b.Associations.ACTIVITY.Value || c.Data.Assoc === b.Associations.ADVISORY.Value) {
            d = "An"
        }
        $("#selected-class").html("-- Select " + d + " " + e + " --")
    };
    c.Us.GetSectionLabel = function() {
        var d = "";
        switch (c.Data.Assoc) {
            case b.Associations.ACADEMICS.Value:
                d = "Class";
                break;
            case b.Associations.ACTIVITY.Value:
                d = "Activity";
                break;
            case b.Associations.ADVISORY.Value:
                d = "Advisory";
                break;
            case b.Associations.ATHLETICS.Value:
                d = "Team";
                break;
            case b.Associations.COMMUNITY.Value:
                d = "Community";
                break;
            case b.Associations.DORM.Value:
                d = "Dorm";
                break
        }
        return d
    };
    c.Us.GetSectionPlural = function() {
        var d = "";
        switch (c.Data.Assoc) {
            case b.Associations.ACADEMICS.Value:
                d = "Classes";
                break;
            case b.Associations.ACTIVITY.Value:
                d = "Activities";
                break;
            case b.Associations.ADVISORY.Value:
                d = "Advisories";
                break;
            case b.Associations.ATHLETICS.Value:
                d = "Teams";
                break;
            case b.Associations.COMMUNITY.Value:
                d = "Communities";
                break;
            case b.Associations.DORM.Value:
                d = "Dorms";
                break
        }
        return d
    };
    p3.router().route("grouppagesettings", "grouppagesettings", function() {
        p3.setTitle("Group Page Settings");
        p3.renderMainPage(new c.Vs.Layout({
            groupOptions: false
        }))
    });
    p3.router().route("grouppageoptions", "grouppageoptions", function() {
        p3.setTitle("Group Page Options");
        p3.renderMainPage(new c.Vs.Layout({
            groupOptions: true
        }))
    })
}(p3.module("LMS/grouppagesettings")));
(function(e) {
    var b = p3.Us.Enum,
        a = p3.Us.Culture,
        c = p3.module("utilities/filter"),
        h = p3.module("utilities/sort"),
        g = p3.module("utilities/smodal"),
        d = p3.Us.InfoMessageLibrary,
        f = p3.module("shared/ltitool");
    e.Ms.ProviderDetail = Bbm.extend({
        idAttribute: "ProviderId",
        urlRoot: "LtiProvider/Edit/",
        defaults: {
            ActiveInd: false,
            ProviderName: "",
            ProviderDescription: "",
            CredentialsTypeId: b.LtiCredentialsType.FIXED,
            LaunchUrl: "",
            ConsumerKey: "",
            SharedSecret: "",
            LtiVersionId: 100,
            GalleryId: 0,
            OutcomesPlacementsInd: false,
            BbInd: false,
            BbPlacementsInd: false,
            TopicInd: false,
            TopicPlacementsInd: false,
            AssignmentInd: false,
            AssignmentPlacementsInd: false,
            AssessmentInd: false,
            AssessmentPlacementsInd: false,
            DiscussionInd: false,
            DiscussionPlacementsInd: false,
            AnyPlacementsInd: false,
            ChangeContextFlag: 0,
            ConsentScreenInd: false,
            ChangeConsentScreenFlag: 0,
            OutcomesInd: false,
            ChangeOutcomesFlag: 0,
            MessagesInd: false,
            ChangeMessagesFlag: 0,
            SendUserName: 0,
            SendUserEmail: 0,
            SendUserRole: 0,
            SendUserImage: 0,
            ChangePrivacyFlag: 0,
            PresentationTarget: 1,
            PresentationHeight: null,
            PresentationWidth: null,
            ChangePresentationFlag: 0,
            ParametersInd: false,
            ChangeParameterFlag: 0,
            XmlInd: false,
            ChangeXmlFlag: 0,
            ConfigTypeId: null,
            ChangeConfigTypeFlag: 0,
            LaunchTypeId: null,
            ChangeLaunchTypeFlag: 0,
            CanEditInd: true,
            CanDeleteInd: true,
            Domains: []
        },
        validation: {
            GalleryId: [{
                min: 1,
                msg: d.P3.RequiredInfoNotEntered
            }],
            ProviderName: [{
                required: true,
                msg: d.P3.RequiredInfoNotEntered
            }],
            PresentationTarget: [{
                required: function(m, i, k) {
                    var j, l = false;
                    j = this.get("ChangePresentationFlag");
                    if (j === null && this.selectedGallery) {
                        j = this.selectedGallery.get("ChangePresentationFlag")
                    }
                    if (j > 0) {
                        l = j
                    }
                    return l
                },
                msg: d.P3.RequiredInfoNotEntered
            }],
            LaunchUrl: [{
                required: function(m, i, j) {
                    var l, k = false;
                    l = this.get("CredentialsTypeId");
                    if (l === null && this.selectedGallery) {
                        l = this.selectedGallery.get("CredentialsTypeId")
                    }
                    if (l) {
                        k = (l.toString() === b.LtiCredentialsType.FIXED.toString())
                    }
                    return k
                },
                msg: d.P3.RequiredInfoNotEntered
            }],
            ConsumerKey: [{
                required: function(m, i, j) {
                    var l, k = false;
                    l = this.get("CredentialsTypeId");
                    if (l === null && this.selectedGallery) {
                        l = this.selectedGallery.get("CredentialsTypeId")
                    }
                    if (l) {
                        k = (l.toString() === b.LtiCredentialsType.FIXED.toString())
                    }
                    return k
                },
                msg: d.P3.RequiredInfoNotEntered
            }]
        },
        changeGallery: function(j) {
            var i = this;
            i.set("ProviderId", 0);
            i.set("ProviderName", null);
            i.set("ProviderDescription", null);
            i.set("CredentialsTypeId", null);
            i.set("ChangeCredentialsTypeFlag", 0);
            i.set("LaunchUrl", null);
            i.set("ConsumerKey", null);
            i.set("SharedSecret", null);
            i.set("LtiVersionId", null);
            i.set("TopicInd", null);
            i.set("BbInd", null);
            i.set("AssignmentInd", null);
            i.set("AssessmentInd", null);
            i.set("DiscussionInd", null);
            i.set("ChangeContextFlag", 0);
            i.set("ConsentScreenInd", null);
            i.set("ChangeConsentScreenFlag", 0);
            i.set("OutcomesInd", null);
            i.set("ChangeOutcomesFlag", 0);
            i.set("MessagesInd", null);
            i.set("ChangeMessagesFlag", 0);
            i.set("SendUserName", null);
            i.set("SendUserEmail", null);
            i.set("SendUserRole", null);
            i.set("SendUserImage", null);
            i.set("ChangePrivacyFlag", 0);
            i.set("PresentationTarget", null);
            i.set("PresentationHeight", null);
            i.set("PresentationWidth", null);
            i.set("ChangePresentationFlag", 0);
            i.set("ParameterInd", null);
            i.set("ChangeParameterFlag", 0);
            i.set("XmlInd", null);
            i.set("ChangeXmlFlag", 0);
            i.set("ConfigTypeId", null);
            i.set("ChangeConfigTypeFlag", 0);
            i.set("LaunchTypeId", null);
            i.set("LaunchConfigTypeFlag", 0);
            if (j) {
                i.set("GalleryId", j.get("GalleryId"));
                i.syncWithGallery(j)
            }
        },
        syncWithGallery: function(j) {
            var i = this;
            if (j && j.get("GalleryId")) {
                i.syncProperty(j, "ChangeContextFlag", "TopicInd");
                i.syncProperty(j, "ChangeContextFlag", "BbInd");
                i.syncProperty(j, "ChangeContextFlag", "AssignmentInd");
                i.syncProperty(j, "ChangeContextFlag", "AssessmentInd");
                i.syncProperty(j, "ChangeContextFlag", "DiscussionInd");
                i.syncProperty(j, "ChangeContextFlag", "TopicInd");
                i.syncProperty(j, "ChangeConsentScreenFlag", "ConsentScreenInd");
                i.syncProperty(j, "ChangeOutcomesFlag", "OutcomesInd");
                i.syncProperty(j, "ChangeMessagesFlag", "MessagesInd");
                i.syncProperty(j, "ChangePrivacyFlag", "SendUserName");
                i.syncProperty(j, "ChangePrivacyFlag", "SendUserEmail");
                i.syncProperty(j, "ChangePrivacyFlag", "SendUserRole");
                i.syncProperty(j, "ChangePrivacyFlag", "SendUserImage");
                i.syncProperty(j, "ChangePresentationFlag", "PresentationTarget");
                i.syncProperty(j, "ChangePresentationFlag", "PresentationHeight");
                i.syncProperty(j, "ChangePresentationFlag", "PresentationWidth");
                i.syncProperty(j, "ChangeCredentialsTypeFlag", "CredentialsTypeId");
                i.syncProperty(j, "ChangeParameterFlag", "ParameterInd");
                i.syncProperty(j, "ChangeXmlFlag", "XmlInd");
                i.syncProperty(j, "ChangeLaunchTypeFlag", "LaunchTypeId");
                i.syncProperty(j, "ChangeConfigTypeFlag", "ConfigTypeId");
                i.set("ChangeCredentialsTypeFlag", j.get("ChangeCredentialsTypeFlag"));
                i.set("ChangeContextFlag", j.get("ChangeContextFlag"));
                i.set("ChangeConsentScreenFlag", j.get("ChangeConsentScreenFlag"));
                i.set("ChangeOutcomesFlag", j.get("ChangeOutcomesFlag"));
                i.set("ChangeMessagesFlag", j.get("ChangeMessagesFlag"));
                i.set("ChangePrivacyFlag", j.get("ChangePrivacyFlag"));
                i.set("ChangePresentationFlag", j.get("ChangePresentationFlag"));
                i.set("ChangeParameterFlag", j.get("ChangeParameterFlag"));
                i.set("ChangeXmlFlag", j.get("ChangeXmlFlag"));
                i.set("ChangeConfigTypeFlag", j.get("ChangeConfigTypeFlag"));
                i.set("ChangeLaunchTypeFlag", j.get("ChangeLaunchTypeFlag"))
            }
        },
        syncProperty: function(l, i, j) {
            var k = this;
            if (!l.get(i)) {
                k.set(j, null)
            } else {
                if (this.get(j) === null) {
                    k.set(j, l.get(j))
                }
            }
        }
    });
    e.Ms.GalleryDetail = Bbm.extend({
        getContextOptions: function() {
            var j, i = 0;
            if (this.get("ContextOptions") > 0) {
                i = this.get("ContextOptions")
            }
            j = {
                BB: ((i & 1) > 0),
                Topic: ((i & 2) > 0),
                Assignment: ((i & 4) > 0),
                Assessment: ((i & 8) > 0),
                Discussion: ((i & 16) > 0)
            };
            return j
        }
    });
    e.Cs.ProviderList = Bbc.extend({
        model: e.Ms.ProviderDetail,
        initialize: function() {
            _.extend(this, $.extend(true, {}, c.Us.CollectionFilter));
            _.extend(this, $.extend(true, {}, h.Us.CollectionSort))
        },
        url: "LtiProvider/List/"
    });
    e.Cs.GalleryPickList = Bbc.extend({
        model: e.Ms.GalleryDetail,
        url: "LtiProvider/GalleryList/",
        createPickList: function(i) {
            var k = i || 0,
                j = new e.Cs.GalleryPickList(this.filter(function(l) {
                    return (l.get("ActiveInd") === true || l.get("GalleryId") === k)
                }));
            return [{
                GalleryName: "-- select a provider type --",
                GalleryId: 0,
                ActiveInd: true
            }].concat(j.toJSON())
        },
        locateGallery: function(j) {
            var i;
            i = _.first(this.where({
                GalleryId: j
            }));
            if (!i) {
                i = new e.Ms.GalleryDetail()
            }
            return i
        }
    });
    e.Cs.PlacementList = Bbc.extend({
        url: "DataDirect/LtiProviderPlacementList/"
    });
    e.Cs.AuditlogList = Bbc.extend({
        url: "DataDirect/LtiProviderPlacementAuditlogList/"
    });
    e.Vs.Layout = Bb.View.extend({
        template: "page/page.10-2.header.template.html",
        initialize: function() {
            var i = this;
            i.Containers = {};
            if (p3.Config.uiVersion === 3) {
                i.template = "ltisettings/ltisettings.layout.template.html"
            }
        },
        render: function(i) {
            var j = this;
            p3.setTitle("Learning Tools");
            $(i).html(j.el);
            j.renderData()
        },
        renderData: function() {
            var i = this;
            p3.fT(i.template, function(l) {
                i.$el.html(l({}));
                if (p3.Config.uiVersion === 1) {
                    p3.rV(new e.Vs.Header(), i.$(".header"), false);
                    p3.rV(new e.Vs.Sidebar(), i.$(".col-right"), false)
                } else {
                    p3.rV(new e.Vs.Sidebar(), i.$("#add-container"), true)
                }
                var k = new e.Cs.ProviderList(),
                    j = new e.Vs.ProviderList({
                        collection: k
                    });
                p3.rV(j, i.$(".col-left"), false);
                p3.rV(new c.Vs.Filter({
                    template: "ltisettings/ltisettings.filter.template.html",
                    collection: k,
                    callback: function() {
                        j.renderData()
                    }
                }), i.$(".col-right"), false)
            })
        }
    });
    e.Vs.Header = Bb.View.extend({
        className: "subhead",
        render: function(i) {
            var j = this;
            $(i).html(j.el);
            j.renderData()
        },
        renderData: function() {
            var i = this;
            i.$el.html('<h1 class="was-jmbtrn">Learning Tools</h1><p class="lead">Use this task to configure third-party edtech tools that are LTI (Learning Tools Interoperability) compliant. You may need to consult with the provider for configuration information.</p>')
        }
    });
    e.Vs.Sidebar = Bb.View.extend({
        template: "ltisettings/ltisettings.sidebar.template.html",
        className: "ltisettings-sidebar",
        tagName: function() {
            var i = "div";
            if (p3.Config.uiVersion === 3) {
                i = "span"
            }
            return i
        },
        events: {
            "click #add-provider": "addProvider"
        },
        render: function(i) {
            var j = this;
            $(i).html(j.el);
            j.renderData()
        },
        renderData: function() {
            var i = this;
            p3.fT(i.template, function(j) {
                i.$el.html(j({}))
            })
        },
        addProvider: function(i) {
            i.stopPropagation();
            i.preventDefault();
            var k = this,
                j = new e.Vs.EditProvider({
                    model: new e.Ms.ProviderDetail(),
                    variables: {
                        collection: k.collection
                    }
                });
            p3.showModal(p3.Layout.Containers.Modal, {
                backOnHide: false
            });
            p3.rV(j, p3.Layout.Containers.Modal, true)
        }
    });
    e.Vs.ProviderList = Bb.View.extend({
        template: "ltisettings/ltisettings.provider.list.template.html",
        initialize: function(i) {
            var j = this;
            j.columns = [{
                SortName: "ProviderName",
                DisplayName: "Provider Name",
                Sortable: true,
                Width: "25%"
            }, {
                SortName: "ActiveInd",
                DisplayName: "Status",
                Sortable: true,
                Width: "20%"
            }, {
                SortName: "CredentialsTypeId",
                DisplayName: "Credentials",
                Sortable: true,
                Width: "20%"
            }, {
                SortName: "ModifiedDate",
                DisplayName: "Modified",
                Sortable: true
            }, {
                SortName: null,
                DisplayName: null,
                Sortable: false,
                Width: "20%"
            }];
            e.on("refreshProviderList", function() {
                j.$el.empty();
                j.renderData()
            }, j)
        },
        events: {
            "click th.sortable": "sort"
        },
        render: function(i) {
            var j = this;
            $(i).append(j.el);
            j.renderData()
        },
        renderData: function() {
            var j = this,
                i = j.collection.sortDirection === "asc" ? "p3icon-sortDown" : "p3icon-sortUp";
            j.collection.reset();
            p3.fT(j.template, function(k) {
                j.$el.html(k({
                    columns: j.columns
                }));
                j.$("th[data-sort=" + j.collection.sortProp + "]").removeClass("muted");
                j.$("th[data-sort=" + j.collection.sortProp + "]").find("i").removeClass("p3icon-sortOff").addClass(i);
                j.collection.fetch({
                    cache: false,
                    success: function() {
                        _.each(j.collection.models, function(l) {
                            var m = new e.Vs.LineItem({
                                model: l,
                                parentView: j
                            });
                            p3.rV(m, j.$(".providers-table tbody"), false)
                        })
                    }
                })
            })
        },
        sort: function(i) {
            var k = this,
                j = "";
            p3.fT(k.template, function(l) {
                k.collection.setSort($(i.currentTarget).data("sort"));
                k.$el.html(l({
                    columns: k.columns
                }));
                _.each(k.collection.models, function(m) {
                    var n = new e.Vs.LineItem({
                        model: m,
                        parentView: k
                    });
                    p3.rV(n, k.$(".providers-table tbody"), false)
                });
                j = k.collection.sortDirection === "asc" ? "p3icon-sortDown" : "p3icon-sortUp";
                k.$("th[data-sort=" + k.collection.sortProp + "]").removeClass("muted");
                k.$("th[data-sort=" + k.collection.sortProp + "]").find("i").removeClass("p3icon-sortOff").addClass(j)
            })
        }
    });
    e.Vs.LineItem = Bb.View.extend({
        template: "ltisettings/ltisettings.provider.detail.template.html",
        tagName: "tr",
        initialize: function() {
            var i = this;
            i.model.bind("sync", i.renderData, i);
            Bb.Validation.bind(i, {
                forceUpdate: true,
                selector: "name"
            })
        },
        events: {
            "click .edit": "editProvider",
            "click .delete:not(:disabled)": "deleteProvider"
        },
        render: function(i) {
            var j = this;
            $(i).append(j.el);
            j.renderData()
        },
        renderData: function() {
            var i = this;
            p3.fT(i.template, function(j) {
                i.$el.html(j({
                    model: i.model.toJSON()
                }))
            })
        },
        editProvider: function(i) {
            i.stopPropagation();
            i.preventDefault();
            var l = this,
                k, j;
            j = new e.Ms.ProviderDetail();
            j.fetch({
                cache: false,
                data: {
                    id: l.model.get("ProviderId")
                },
                success: function() {
                    k = new e.Vs.EditProvider({
                        model: j,
                        variables: {
                            collection: l.collection
                        }
                    });
                    p3.showModal(p3.Layout.Containers.Modal, {
                        backOnHide: false
                    });
                    p3.rV(k, p3.Layout.Containers.Modal, true)
                },
                error: function() {
                    p3.displayError("Error loading the Learning Tool Provider.")
                }
            })
        },
        deleteProvider: function(i) {
            i.preventDefault();
            var j = this;
            j.$(".delete").prop("disabled", true);
            p3.showConfirmCancel("Delete Learning Tool Provider", "Wait a minute. Are you really sure you want to delete " + j.model.get("ProviderName") + "?", null, function() {
                j.model.destroy({
                    success: function() {
                        $(j.el).remove();
                        j.$(".delete").prop("disabled", false)
                    },
                    error: function() {
                        p3.displayError("Error deleting the Learning Tool Provider.");
                        j.$(".delete").prop("disabled", false)
                    }
                })
            })
        }
    });
    e.Vs.EditProvider = g.Vs.Modal2.extend({
        template: "ltisettings/ltisettings.edit.layout.template.html",
        selector: "id",
        size: "md",
        modalRendered: function() {
            var i = this;
            i.ltiGalleries = new e.Cs.GalleryPickList();
            i.model.selectedGallery = null;
            i.ltiGalleries.fetch({
                success: function() {
                    i.model.selectedGallery = i.ltiGalleries.locateGallery(i.model.get("GalleryId"));
                    i.model.syncWithGallery(i.model.selectedGallery);
                    i.renderTemplate()
                },
                error: function() {
                    p3.displayError("Error loading the gallery list")
                }
            })
        },
        renderTemplate: function() {
            var i = this;
            i.generalView = new e.Vs.EditProviderGeneral({
                model: i.model,
                parentView: i
            });
            p3.rV(i.generalView, i.$("#general"), true);
            p3.setModalHeight(p3.Layout.Containers.Modal)
        },
        modalUpdate: function(s) {
            var u = this,
                m = $(s.eventCurrentTarget),
                r, p, q, j, i, k, n, l, o, t = true;
            p = m.attr(u.selector);
            if (p === "GalleryId") {
                r = parseInt(m.val(), 10);
                u.model.selectedGallery = u.ltiGalleries.locateGallery(r);
                $(".tooltip").remove();
                u.model.changeGallery(u.model.selectedGallery);
                u.renderTemplate();
                t = false
            } else {
                if (m.parent().attr(u.selector) === "Available") {
                    if (m.attr(u.selector) === "BbInd") {
                        u.setPropByString(u.model.attributes, "BbInd", !(m.hasClass("active")));
                        t = false
                    }
                    if (m.attr(u.selector) === "TopicInd") {
                        u.setPropByString(u.model.attributes, "TopicInd", !(m.hasClass("active")));
                        t = false
                    }
                    if (m.attr(u.selector) === "AssignmentInd") {
                        k = u.$("#outcomes-area");
                        l = u.$("#OutcomesInd");
                        u.setPropByString(u.model.attributes, "AssignmentInd", !(m.hasClass("active")));
                        if (!(m.hasClass("active"))) {
                            if (u.model.get("ChangeOutcomesFlag")) {
                                if (p3.Config.uiVersion === 3) {
                                    l.parent().addClass("active");
                                    u.setPropByString(u.model.attributes, "OutcomesInd", (l.parent().hasClass("active")))
                                } else {
                                    l.addClass("active");
                                    u.setPropByString(u.model.attributes, "OutcomesInd", (l.hasClass("active")))
                                }
                            }
                            k.show()
                        } else {
                            if (u.model.get("ChangeOutcomesFlag")) {
                                l.removeClass("active");
                                u.setPropByString(u.model.attributes, "OutcomesInd", (l.hasClass("active")))
                            }
                            k.hide()
                        }
                        t = false
                    }
                    if (m.attr(u.selector) === "AssessmentInd") {
                        u.setPropByString(u.model.attributes, "AssessmentInd", !(m.hasClass("active")));
                        t = false
                    }
                    if (m.attr(u.selector) === "DiscussionInd") {
                        u.setPropByString(u.model.attributes, "DiscussionInd", !(m.hasClass("active")));
                        t = false
                    }
                } else {
                    if (m.parent().attr(u.selector) === "CredentialsTypeId") {
                        j = u.$("#domain-area");
                        i = u.$("#credentials-area");
                        n = u.$("#xml-area");
                        o = u.$("#XmlInd");
                        if (p3.Config.uiVersion === 3) {
                            q = m.find("input").val()
                        } else {
                            q = m.context.value
                        }
                        if (q.toString() === b.LtiCredentialsType.BYDOMAIN.toString()) {
                            u.setPropByString(u.model.attributes, "CredentialsTypeId", b.LtiCredentialsType.BYDOMAIN);
                            if (u.model.get("ChangeXmlFlag")) {
                                o.removeClass("active");
                                u.setPropByString(u.model.attributes, "XmlInd", (o.hasClass("active")));
                                n.show()
                            }
                            u.generalView.domainListView.appendEmptyListItemIfNeeded();
                            i.hide();
                            j.show()
                        } else {
                            if (u.model.get("ChangeXmlFlag")) {
                                o.removeClass("active");
                                u.setPropByString(u.model.attributes, "XmlInd", (o.hasClass("active")));
                                n.hide()
                            }
                            if (q.toString() === b.LtiCredentialsType.FIXED.toString()) {
                                u.setPropByString(u.model.attributes, "CredentialsTypeId", b.LtiCredentialsType.FIXED);
                                j.hide();
                                i.show()
                            } else {
                                u.setPropByString(u.model.attributes, "CredentialsTypeId", b.LtiCredentialsType.PERLINK);
                                j.hide();
                                i.hide()
                            }
                        }
                        t = false
                    }
                }
            }
            p3.setModalHeight(p3.Layout.Containers.Modal);
            return t
        },
        modalSave: function() {
            var j = this,
                i;
            i = j.model.isValid(true);
            i = j.validateDomainList(i);
            if (i && !j.hasCredentials(b.LtiCredentialsType.FIXED)) {
                j.model.set("LaunchUrl", null);
                j.model.set("ConsumerKey", null);
                j.model.set("SharedSecret", null)
            }
            i = f.Us.ValidateParameterList(j, j.model, "Parameters", i);
            return i
        },
        validateDomainList: function(m) {
            var p = this,
                i, j, n, o, k = [],
                l = true;
            if (p.hasCredentials(b.LtiCredentialsType.BYDOMAIN)) {
                p.$el.find("#domain-area").removeClass("error");
                p.$el.find(".domain-field").removeClass("box-validate");
                p.$el.find(".key-field").removeClass("box-validate");
                i = $(".domain-entry");
                if (i.length > 0) {
                    _.each(i, function(q) {
                        j = $(q).find(".domain-field").val();
                        n = $(q).find(".key-field").val();
                        o = $(q).find(".secret-field").val();
                        if (j || n || o) {
                            if (j && n) {
                                k.push(new Bbm({
                                    Domain: j,
                                    ConsumerKey: n,
                                    SharedSecret: o
                                }))
                            } else {
                                if (!j) {
                                    $(q).find(".domain-field").addClass("box-validate")
                                }
                                if (!n) {
                                    $(q).find(".key-field").addClass("box-validate")
                                }
                                l = false
                            }
                        }
                    })
                }
            }
            if (!l) {
                p.$el.find("#domain-area").addClass("error")
            }
            p.model.set("Domains", k);
            return (m && l)
        },
        modalSavedError: function(i) {
            p3.displayError("There was an error saving the Learning Tool Provider. (" + i.error.responseText + ")")
        },
        modalSavedSucess: function(i) {
            e.trigger("refreshProviderList")
        },
        hasCredentials: function(j) {
            var n = this,
                l = n.model.get("CredentialsTypeId"),
                k = n.model.selectedGallery.get("CredentialsTypeId"),
                i = n.model.get("ChangeCredentialsTypeFlag"),
                m = false;
            if ((l !== undefined && l !== null && l.toString() === j.toString()) || (k !== undefined && k !== null && k.toString() === j.toString() && i.toString() === b.LtiChangeFlag.NONE.toString())) {
                m = true
            }
            return m
        }
    });
    e.Vs.EditProviderGeneral = Bb.View.extend({
        template: "ltisettings/ltisettings.edit.general.template.html",
        initialize: function(i) {
            var j = this;
            j.parentView = j.options.parentView
        },
        render: function(i) {
            var j = this;
            $(i).html(j.el);
            j.renderData()
        },
        renderData: function() {
            var k = this,
                j, i;
            j = f.Us.PresentationTargetPickList(k.model.selectedGallery.get("PresentationTargetOptions"));
            i = k.model.selectedGallery.getContextOptions();
            p3.fT(k.template, function(l) {
                k.$el.html(l({
                    model: k.model.toJSON(),
                    gallery: k.model.selectedGallery.toJSON(),
                    galleryList: k.parentView.ltiGalleries.createPickList(k.model.get("GalleryId")),
                    targets: j.toJSON(),
                    showCredentialsArea: k.parentView.hasCredentials(b.LtiCredentialsType.FIXED),
                    showDomainArea: k.parentView.hasCredentials(b.LtiCredentialsType.BYDOMAIN),
                    contextOptions: i
                }));
                k.domainListView = new e.Vs.EditProviderGeneralList({
                    model: k.model
                });
                p3.rV(k.domainListView, k.$("#domain-list-area"), true);
                if (k.model.get("ChangeParameterFlag") > 0) {
                    k.parameterListView = new f.Vs.EditToolGeneralList({
                        model: k.model
                    });
                    p3.rV(k.parameterListView, k.$("#param-list-area"), true)
                }
                p3.setModalHeight(p3.Layout.Containers.Modal)
            })
        }
    });
    e.Vs.EditProviderGeneralList = Bb.View.extend({
        id: "domain-list",
        initialize: function() {
            this.domainList = this.model.get("Domains")
        },
        events: {
            "blur .domain-input-field": "appendEmptyListItemIfNeeded"
        },
        render: function(i) {
            var j = this;
            $(i).html(j.el);
            j.renderData()
        },
        renderData: function() {
            var j = this,
                i;
            _.each(j.domainList, function(k) {
                i = new e.Vs.EditProviderGeneralListItem({
                    model: k
                });
                p3.rV(i, j.$el, false)
            });
            j.appendEmptyListItem()
        },
        appendEmptyListItemIfNeeded: function(j) {
            var p = this,
                i = p.$el,
                m = $(i).children(":last"),
                k, n, l, o;
            if (m) {
                k = $(m).find("input.domain-field");
                n = $(m).find("input.key-field");
                l = k ? k.val() : null;
                o = n ? n.val() : null;
                if (l.length > 0 && o.length > 0) {
                    $(m).find(".domain-delete-button").show();
                    p.appendEmptyListItem()
                }
            }
        },
        appendEmptyListItem: function() {
            var j = this,
                i;
            i = new e.Vs.EditProviderGeneralListItem();
            p3.rV(i, j.$el, false)
        }
    });
    e.Vs.EditProviderGeneralListItem = Bb.View.extend({
        template: "ltisettings/ltisettings.edit.general.domain.template.html",
        className: "domain-entry",
        events: {
            "click .domain-delete-button": "removeListItem"
        },
        render: function(i) {
            var j = this;
            $(i).append(j.el);
            j.renderData()
        },
        renderData: function() {
            var i = this;
            p3.fT(i.template, function(j) {
                i.$el.html(j({
                    model: (i.model || null)
                }));
                p3.setModalHeight(p3.Layout.Containers.Modal)
            })
        },
        removeListItem: function(i) {
            i.preventDefault();
            this.unbind();
            this.remove()
        }
    });
    e.Vs.PlacementLayout = Bb.View.extend({
        template: "ltisettings/ltisettings.placement.layout.template.html",
        listTemplate: "ltisettings/ltisettings.placement.item.template.html",
        initialize: function() {
            var i = this;
            i.LtiProviderId = i.options.ltiProviderId
        },
        events: {
            "click .slide-toggle": "slideContent"
        },
        render: function(i) {
            var j = this;
            p3.setTitle("Learning Tool Placements");
            $(i).html(j.el);
            j.renderData()
        },
        renderData: function() {
            var i = this;
            i.collection = new e.Cs.PlacementList();
            i.collection.fetch({
                cache: false,
                data: {
                    ltiProviderId: i.LtiProviderId
                },
                success: function() {
                    var r, q = 0,
                        k, p, l = "school_year_label",
                        m = "placement_type",
                        s = "",
                        t = "",
                        n = "",
                        o = "",
                        j = i.$el;
                    if (i.collection.length > 0) {
                        r = i.collection.models[0];
                        i.collection.each(function(v, u) {
                            if (v.get("lti_tool_id")) {
                                q = q + 1;
                                s = v.get(l);
                                t = v.get(m);
                                v.set("groupVal1", s);
                                v.set("groupId1", u);
                                v.set("groupVal2", t);
                                v.set("groupId2", u);
                                k = v.get("context_label_id");
                                if (k === 5) {
                                    v.set("itemDetails", a.getDateString(v.get("item_date_assigned")) + " - " + a.getDateString(v.get("item_date_due")))
                                } else {
                                    v.set("itemDetails", v.get("lti_tool_title"))
                                }
                                if (s !== n) {
                                    v.set("startGroup1", 1);
                                    n = s;
                                    v.set("startGroup2", 1);
                                    o = t
                                } else {
                                    if (t !== o) {
                                        v.set("startGroup2", 1);
                                        o = t
                                    }
                                }
                            }
                            if (u === (i.collection.length - 1)) {
                                v.set("closeGroup2", 1);
                                v.set("closeGroup1", 1)
                            } else {
                                p = i.collection.models[u + 1];
                                if (p.get(m) !== t) {
                                    v.set("closeGroup2", 1)
                                }
                                if (p.get(l) !== s) {
                                    v.set("closeGroup1", 1)
                                }
                            }
                        });
                        p3.fT(i.template, function(u) {
                            i.$el.html(u({
                                provider: r.toJSON(),
                                placementCount: q
                            }));
                            if (q) {
                                if (p3.Config.uiVersion === 3) {
                                    j = $("#placement-item-container")
                                }
                                p3.fT(i.listTemplate, function(v) {
                                    j.append(v({
                                        placementCount: q,
                                        placements: i.collection.toJSON()
                                    }))
                                })
                            }
                        })
                    }
                }
            })
        },
        slideContent: function(k) {
            var j = $(k.target),
                i;
            $(j.closest("div.accordion-toggle").attr("data-target")).slideToggle(200);
            i = j.closest("div.accordion-toggle").find("div.swaparrow");
            if (i.hasClass("arrow-e")) {
                p3.slideArrowS(i)
            } else {
                p3.slideArrowE(i)
            }
        }
    });
    e.Vs.AuditlogLayout = Bb.View.extend({
        template: "ltisettings/ltisettings.auditlog.layout.template.html",
        listTemplate: "ltisettings/ltisettings.auditlog.item.template.html",
        initialize: function() {
            var i = this;
            i.LtiProviderId = i.options.ltiProviderId;
            i.LtiToolIndexId = i.options.ltiToolIndexId;
            i.ContextLabelId = i.options.contextLabelId;
            i.ContextValue = i.options.contextValue
        },
        events: {
            "click .request-link": "clickRequest",
            "click .response-link": "clickResponse"
        },
        render: function(i) {
            var j = this;
            p3.setTitle("Learning Tool Log");
            $(i).html(j.el);
            j.renderData()
        },
        renderData: function() {
            var j = this,
                i = j.$el;
            j.collection = new e.Cs.AuditlogList();
            j.collection.fetch({
                cache: false,
                data: {
                    ltiProviderId: j.LtiProviderId,
                    ltiToolIndexId: j.LtiToolIndexId,
                    contextLabelId: j.ContextLabelId,
                    contextValue: j.ContextValue
                },
                success: function() {
                    var l, k = 0,
                        m = true;
                    if (j.collection.length > 0) {
                        l = j.collection.models[0];
                        if (l.get("lti_auditlog_id")) {
                            k = j.collection.length
                        } else {
                            k = j.collection.length - 1
                        }
                        p3.fT(j.template, function(n) {
                            j.$el.html(n({
                                placement: l.toJSON(),
                                logCount: k
                            }));
                            if (k) {
                                p3.fT(j.listTemplate, function(o) {
                                    if (p3.Config.uiVersion === 3) {
                                        i = $("#placement-log-container")
                                    }
                                    i.append(o({
                                        logCount: k,
                                        entries: j.collection.toJSON(),
                                        whmasteruser: m
                                    }))
                                })
                            }
                        })
                    }
                }
            })
        },
        clickRequest: function(i) {
            var j = this;
            i.stopPropagation();
            i.preventDefault();
            j.displayRequestResponse(i, "Request", "request")
        },
        clickResponse: function(i) {
            var j = this;
            i.stopPropagation();
            i.preventDefault();
            j.displayRequestResponse(i, "Response", "response")
        },
        displayRequestResponse: function(j, n, i) {
            var o = this,
                k = $(j.currentTarget).attr("data-id"),
                l, m;
            if (Number(k) > 0) {
                l = o.collection.findWhere({
                    lti_auditlog_id: parseInt(k, 10)
                });
                if (l) {
                    m = l.get(i);
                    p3.rV(new e.Vs.SimpleText({
                        Title: n,
                        Text: m
                    }), p3.Layout.Containers.Modal, true);
                    p3.showModal(p3.Layout.Containers.Modal)
                }
            }
        }
    });
    e.Vs.SimpleText = Bb.View.extend({
        template: "ltisettings/ltisettings.simpletext.template.html",
        events: {
            "click #btnClose": "doClose"
        },
        render: function(i) {
            var j = this;
            $(i).append(this.el);
            p3.fT(j.template, function(k) {
                j.$el.html(k({
                    Title: j.options.Title,
                    Text: j.options.Text
                }));
                j.trigger("render")
            })
        },
        doClose: function(i) {
            i.preventDefault();
            p3.Layout.Containers.Modal.modal("hide");
            return false
        }
    });
    p3.router().route("ltisettings(/:id)(/:ti)(/:cl)(/:cv)", "ltisettings", function(k, l, i, j) {
        if (k === null) {
            p3.renderMainPage(new e.Vs.Layout({}))
        } else {
            if (l === null || i === null || j === null) {
                p3.renderMainPage(new e.Vs.PlacementLayout({
                    ltiProviderId: k
                }))
            } else {
                p3.renderMainPage(new e.Vs.AuditlogLayout({
                    ltiProviderId: k,
                    ltiToolIndexId: l,
                    contextLabelId: i,
                    contextValue: j
                }))
            }
        }
    })
}(p3.module("lms/ltisettings")));
(function(a) {
    a.Ms.BaseTypes = Bbm.extend({
        idAttribute: "offering_type",
        url: function() {
            return ""
        }
    });
    a.Cs.BaseTypes = Bbc.extend({
        model: a.Ms.BaseTypes,
        url: function() {
            return aP + "datadirect/PersonellOfferingTypesGet/?format=json"
        }
    });
    a.Cs.PersonnelTypes = Bbc.extend({
        url: function() {
            return aP + "personneltype/get/?format=json"
        },
        filters: undefined,
        comparator: function(b) {
            return b.get("Type")
        },
        changeSort: function(b) {
            if (this.filters !== undefined) {
                this.comparator = this.filters[b]
            }
        }
    });
    a.Ms.Update = Bbm.extend({
        url: function() {
            return aP + "personneltype/update/?format=json"
        }
    });
    a.Ms.Create = Bbm.extend({
        url: function() {
            return aP + "personneltype/create/?format=json"
        }
    });
    a.Ms.DeleteType = Bbm.extend({
        idAttribute: "Role",
        url: function() {
            return aP + "personneltype/delete/?format=json&role=" + this.get("Role") + "&offeringType=" + this.get("OfferingType")
        }
    });
    a.Data = {};
    a.Data.ShowAll = true;
    a.Data.listSort = "Type";
    a.Vs.LayoutView = Bb.View.extend({
        template: "personneltypes/layout.template.html",
        initialize: function(b) {
            this.Containers = {};
            if (!a.Data.BaseTypes) {
                a.Data.BaseTypes = new a.Cs.BaseTypes();
                a.Data.BaseTypes.fetch({
                    async: false,
                    error: function(c, d) {
                        p3.displayError("Error getting types")
                    }
                })
            }
        },
        events: {
            "click .type-filter": "filterChange",
            "click .bounce-table-sort": "updateSort",
            "click .all-type-filter": "showAll",
            "click #add-type-button": "addType"
        },
        renderTemplate: function() {
            var b = this;
            p3.fT(b.template, function(c) {
                b.$el.html(c({
                    types: a.Data.BaseTypes.toJSON(),
                    showAll: a.Data.ShowAll
                }))
            });
            b.getList()
        },
        render: function(b) {
            $(b).append(this.el);
            this.renderTemplate()
        },
        renderList: function() {
            var c = this,
                b = new a.Vs.ListView();
            p3.rV(b, this.Containers.ListContainer, true);
            b.on("typeDeleted", function() {
                c.getList()
            })
        },
        getList: function() {
            var c = this,
                b = "-1";
            if (!a.Data.ShowAll) {
                b = "";
                a.Data.BaseTypes.each(function(d) {
                    if (d.get("selected")) {
                        if (b.length > 0) {
                            b += ","
                        }
                        b += d.get("offering_type")
                    }
                })
            }
            a.Data.PersonnelTypes = new a.Cs.PersonnelTypes();
            a.Data.PersonnelTypes.filters = {
                PersonnelDescription: function(f, g) {
                    var d = f.get("PersonnelDescription").toUpperCase() || "",
                        e = g.get("PersonnelDescription").toUpperCase() || "";
                    return d < e ? -1 : d > e ? 1 : 0
                },
                PersonnelDescription_invert: function(f, g) {
                    var d = f.get("PersonnelDescription").toUpperCase() || "",
                        e = g.get("PersonnelDescription").toUpperCase() || "";
                    return d < e ? 1 : d > e ? -1 : 0
                },
                Type: function(f, g) {
                    var d = f.get("Type").toUpperCase() || "",
                        e = g.get("Type").toUpperCase() || "",
                        h;
                    if (d < e) {
                        h = -1
                    } else {
                        if (d > e) {
                            h = 1
                        } else {
                            d = f.get("PersonnelDescription").toUpperCase() || "";
                            e = g.get("PersonnelDescription").toUpperCase() || "";
                            h = d < e ? -1 : d > e ? 1 : 0
                        }
                    }
                    return h
                },
                Type_invert: function(f, g) {
                    var d = f.get("Type").toUpperCase() || "",
                        e = g.get("Type").toUpperCase() || "",
                        h;
                    if (d < e) {
                        h = 1
                    } else {
                        if (d > e) {
                            h = -1
                        } else {
                            d = f.get("PersonnelDescription").toUpperCase() || "";
                            e = g.get("PersonnelDescription").toUpperCase() || "";
                            h = d < e ? -1 : d > e ? 1 : 0
                        }
                    }
                    return h
                }
            };
            a.Data.PersonnelTypes.fetch({
                data: {
                    offeringTypes: b
                },
                success: function() {
                    if (c.Containers.ListContainer === undefined) {
                        c.Containers.ListContainer = $("#personnel-types-container")
                    }
                    a.Data.PersonnelTypes.changeSort(a.Data.listSort);
                    a.Data.PersonnelTypes.sort();
                    c.renderList()
                },
                error: function(d, e) {
                    p3.displayError("Error getting personnel types")
                }
            })
        },
        showAll: function(c) {
            var b = $(c.currentTarget);
            if (!b.find(".all-icon").hasClass("p3icon-ok")) {
                this.displayAllOn();
                this.getList()
            }
            c.preventDefault()
        },
        displayAllOn: function() {
            a.Data.ShowAll = true;
            a.Data.BaseTypes.each(function(b) {
                b.set("selected", false)
            });
            $(".type-desc").css("color", "#999");
            $(".type-icon").removeClass("p3icon-ok").addClass("p3icon-check");
            $(".all-desc").css("color", "#424242");
            $(".all-icon").removeClass("p3icon-check").addClass("p3icon-ok")
        },
        filterChange: function(d) {
            var b = $(d.currentTarget),
                c = parseInt(b.data("value"), 10),
                g = false,
                f = false,
                h;
            h = a.Data.BaseTypes.get(c);
            h.set("selected", !b.find(".type-icon").hasClass("p3icon-ok"));
            if (a.Data.ShowAll) {
                a.Data.ShowAll = false;
                $(".all-desc").css("color", "#999");
                $(".all-icon").removeClass("p3icon-ok").addClass("p3icon-check");
                b.find(".type-desc").css("color", "#424242");
                b.find(".type-icon").removeClass("p3icon-check").addClass("p3icon-ok")
            } else {
                a.Data.BaseTypes.each(function(e) {
                    if (e.get("selected")) {
                        g = true
                    } else {
                        f = true
                    }
                });
                if (g && f) {
                    a.Data.ShowAll = false;
                    if (h.get("selected")) {
                        b.find(".type-desc").css("color", "#424242");
                        b.find(".type-icon").removeClass("p3icon-check").addClass("p3icon-ok")
                    } else {
                        b.find(".type-desc").css("color", "#999");
                        b.find(".type-icon").removeClass("p3icon-ok").addClass("p3icon-check")
                    }
                } else {
                    this.displayAllOn()
                }
            }
            this.getList();
            d.preventDefault()
        },
        updateSort: function(c) {
            var f = this,
                b = $(c.currentTarget),
                d = b.data("sort");
            if (d !== undefined) {
                if (a.Data.listSort === d) {
                    d = d + "_invert"
                }
                a.Data.listSort = d;
                a.Data.PersonnelTypes.changeSort(d);
                a.Data.PersonnelTypes.sort();
                f.renderList()
            }
            return false
        },
        addType: function(c) {
            var d = this,
                b = new a.Vs.AddView();
            p3.rV(b, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            b.on("typeSaved", function() {
                d.getList()
            });
            c.preventDefault()
        }
    });
    a.Vs.ListView = Bb.View.extend({
        template: "personneltypes/typelist.template.html",
        events: {
            "mouseover td.inline-edit": "handleHover",
            "mouseout td.inline-edit": "handleHoverOff",
            "click td.inline-edit": "inlineEdit",
            "focusout .edit-cell": "inlineClose",
            "click .delete-type": "deleteType"
        },
        renderTemplate: function() {
            var b = this;
            p3.fT(b.template, function(c) {
                b.$el.html(c({
                    list: a.Data.PersonnelTypes.toJSON(),
                    sort: a.Data.listSort
                }))
            })
        },
        render: function(b) {
            $(b).append(this.el);
            this.renderTemplate()
        },
        handleHover: function(c) {
            var b = $(c.target).closest("td");
            if ($(".edit-cell-icon").length === 0) {
                if (!b.hasClass("edit-cell")) {
                    b.prepend($("<i>", {
                        "class": "p3icon-edit edit-cell-icon pull-right"
                    }))
                }
                b.addClass("on");
                b.mouseleave(function() {
                    if (b.hasClass("on")) {
                        b.removeClass("on")
                    }
                })
            }
        },
        handleHoverOff: function(b) {
            if (!$(b.target).hasClass("on")) {
                this.$("i.edit-cell-icon").remove()
            }
        },
        inlineEdit: function(c) {
            var b = $(c.target).closest("td");
            if (!b.hasClass("edit-cell")) {
                b.html('<input type="text" class="list-desc-box input-large" max-length="100" value="' + b.find("P").html() + '"/>');
                b.addClass("edit-cell");
                b.find(".list-desc-box").focus()
            }
        },
        inlineClose: function(e, c) {
            var b, h, g, f, d, i;
            if (!_.isEqual(e.target, e.currentTarget)) {
                b = $(e.target);
                h = b.closest("td").data("role");
                g = (b.closest("td").data("offering"));
                f = b.closest("td").data("desc");
                d = b.val();
                if (f !== d) {
                    i = new a.Ms.Update({
                        Role: h,
                        OfferingType: g,
                        PersonnelDescription: d
                    });
                    i.save({}, {
                        error: function() {
                            p3.displayError("Error updating personnel type")
                        },
                        success: function() {
                            b.closest("td").data("desc", d);
                            b.closest("td").removeClass("edit-cell").html('<p style="margin:3px 0px 0px 0px">' + d + "</p>")
                        }
                    })
                } else {
                    b.closest("td").removeClass("edit-cell").html('<p style="margin:3px 0px 0px 0px">' + f + "</p>")
                }
            }
        },
        deleteType: function(d) {
            var h = this,
                b = $(d.currentTarget),
                g = b.data("role"),
                f = b.data("offering"),
                c;
            p3.showConfirm("Delete Personnel Type", "Are you sure you want to delete this Personnel Type?", null, function() {
                c = new a.Ms.DeleteType({
                    Role: g,
                    OfferingType: f
                });
                c.destroy({
                    error: function() {
                        p3.displayError("Error deleting personnel type")
                    },
                    success: function() {
                        h.trigger("typeDeleted")
                    }
                })
            });
            d.preventDefault()
        }
    });
    a.Vs.AddView = Bb.View.extend({
        template: "personneltypes/add.template.html",
        events: {
            "click #btnSave": "saveType",
            "click #btnSaveAdd": "saveType"
        },
        renderTemplate: function() {
            var b = this;
            p3.fT(b.template, function(c) {
                b.$el.html(c({
                    baseTypes: a.Data.BaseTypes.toJSON()
                }))
            })
        },
        render: function(b) {
            var c = this;
            $(b).append(this.el);
            c.renderTemplate()
        },
        saveType: function(j) {
            var m = this,
                i = (j.target.id === "btnSaveAdd"),
                k, l = true,
                h = $("#type-group"),
                c = $("#offering-group"),
                g = $("#type-box"),
                b = $("#offering-drop"),
                d = $("#btnSave"),
                f = $("#btnSaveAdd");
            h.removeClass("error has-error");
            c.removeClass("error has-error");
            if (g.val().length === 0) {
                h.addClass("error has-error");
                l = false
            }
            if (b.val() === "0") {
                c.addClass("error has-error");
                l = false
            }
            if (l) {
                d.button("loading");
                f.button("loading");
                k = new a.Ms.Create({
                    OfferingType: b.val(),
                    PersonnelDescription: g.val()
                });
                k.save({}, {
                    error: function() {
                        p3.showModal(p3.Layout.Containers.Modal, "hide");
                        p3.displayError("Error saving personnel type.")
                    },
                    success: function() {
                        m.trigger("typeSaved");
                        if (i) {
                            g.val("");
                            b.val("0");
                            d.button("reset");
                            f.button("reset")
                        } else {
                            p3.showModal(p3.Layout.Containers.Modal, "hide")
                        }
                    }
                })
            }
        }
    });
    p3.router().route("personneltypes", "personneltypes", function() {
        p3.renderMainPage(new a.Vs.LayoutView({}))
    })
}(p3.module("lms/personneltypes")));
(function(v) {
    var d = p3.Us.Culture,
        k = p3.Us.InfoMessage,
        g = p3.Us.Enum,
        e = p3.module("shared/datepicker"),
        c = p3.module("cms/shared/content"),
        l = p3.module("cms/shared/layoutbuilder"),
        t = p3.module("cms/pages"),
        f = p3.module("cms/shared/download"),
        m = p3.module("cms/shared/link"),
        p = p3.module("cms/shared/media"),
        q = p3.module("shared/mediaviewer"),
        h = p3.module("cms/shared/event"),
        u = p3.module("report"),
        o = p3.module("lists"),
        j = p3.module("LMS/shared/GroupFinder"),
        x = p3.module("shared/task"),
        w = p3.module("utilities/smodal"),
        n = p3.module("cms/shared/list"),
        y = p3.module("cms/shared/text"),
        i = p3.module("cms/shared/faq"),
        s = p3.module("cms/shared/news"),
        a = p3.module("cms/shared/announcement"),
        b = p3.module("admissions/candidateprogress"),
        r = p3.module("utilities/multifetch");
    v.Data = {};
    v.Data.Persona = 12;
    v.Data.Filter = 0;
    v.Ms.SchoolLevel = Bbm.extend({
        idAttribute: "DdId"
    });
    v.Cs.SchoolLevel = Bbc.extend({
        model: v.Ms.SchoolLevel,
        initialize: function(z, A) {
            if (A) {
                this.editMode = A.editMode || false
            }
        },
        url: function() {
            var z;
            if (this.editMode) {
                z = aP + "datadirect/SchoolLevelGet/"
            } else {
                z = aP + "datadirect/ResourceBoardUserLevelsGet/?personaId=" + p3.Data.Context.getSelectedPersona().Id
            }
            return z
        }
    });
    v.Ms.ResourceBoardContainer = Bbm.extend({
        idAttribute: "ResourceBoardContainerId",
        urlRoot: "resourceboardcontainer/crud"
    });
    v.Ms.ResourceBoardContainerGet = Bbm.extend({
        idAttribute: "ResourceBoardContainerId",
        urlRoot: "resourceboardcontainer/containerget"
    });
    v.Cs.ResourceBoardContainer = Bbc.extend({
        model: v.Ms.ResourceBoardContainer,
        initialize: function(z, A) {
            if (A) {
                this.editMode = A.editMode || false
            }
        },
        url: function() {
            var z;
            if (this.editMode) {
                z = aP + "resourceboardcontainer/list/"
            } else {
                z = aP + "resourceboardcontainer/usercontainersget/"
            }
            return z
        }
    });
    v.Cs.ResourceBoardContent = Bbc.extend({
        model: Bbm,
        url: "DataDirect/GetResourceBoardContent"
    });
    v.Ms.UpdatePending = Bbm.extend({
        url: function() {
            return aP + "resourceboardcontainer/updatepending?format=json&resourceboardContainerId=" + this.get("resourceBoardContainerId") + "&acceptPending=" + this.get("acceptPending")
        }
    });
    v.Ms.StyleOptions = Bbm.extend({
        url: "",
        defaults: {
            Class: "conDefault",
            Font: "",
            FontSize: "small",
            ShowIcon: false
        }
    });
    v.Cs.SchoolYears = Bbc.extend({
        url: "datadirect/SchoolYearsGet/"
    });
    v.Cs.UserForms = Bbc.extend({
        initialize: function(z, A) {
            if (A) {
                this.formIds = A.formIds || ""
            }
        },
        url: function() {
            return aP + "datadirect/formslistget?format=json&formIds=" + this.formIds
        }
    });
    v.Cs.Priorities = Bbc.extend({
        url: function() {
            return aP + "datadirect/ResourceBoardPrioritiesGet?format=json&personaId=" + v.Data.Persona
        }
    });
    v.Ms.SetPriorities = Bbm.extend({
        url: function() {
            return aP + "resourceboardcontainer/setpriorities"
        }
    });
    v.Cs.PushpageArchives = Bbc.extend({
        initialize: function(z, A) {
            if (A) {
                this.templateId = A.templateId || 0
            }
        },
        url: function() {
            return aP + "datadirect/PushpageArchivesGet?format=json&templateId=" + this.templateId
        }
    });
    v.Vs.ResourceBoards = Bb.View.extend({
        template: "resourceboard/resourceboard.container.template.html",
        events: {
            "click .persona-item": "switchBoard",
            "click #add-container-button": "addContainer",
            "click #edit-priority-buton": "showPriorityDialog"
        },
        initialize: function() {
            var A = new m.Cs.LinkCategory(),
                z;
            this.Containers = {};
            this.boardId = this.options.boardId;
            this.editMode = this.options.editMode;
            this.header = this.options.header;
            if (this.editMode) {
                this.linkCategories = A;
                A.fetch({
                    success: function() {
                        A.each(function(B) {
                            B.set("Id", parseInt(B.get("Id").split("_")[1], 10))
                        })
                    },
                    error: function() {
                        p3.displayError("Error loading link categories.")
                    }
                });
                z = new h.Cs.Registrations();
                this.eventReg = z;
                z.fetch({
                    error: function() {
                        p3.displayError("Error loading event registrations")
                    }
                })
            } else {
                u.loadReportList();
                o.loadLists();
                if (!v.Data.ClassYears) {
                    v.Data.ClassYears = new v.Cs.SchoolYears();
                    v.Data.ClassYears.fetch({
                        success: function() {
                            v.Data.ClassYears.each(function(B) {
                                if (B.get("Current")) {
                                    v.Data.CurrentYear = B.get("Id");
                                    v.Data.CurrentMode = "current"
                                }
                            })
                        },
                        error: function() {
                            p3.displayError("Error loading schoolYears")
                        }
                    })
                }
            }
        },
        dispose: function() {
            if (p3.Config.uiVersion === 1) {
                $("#site-main").addClass("container");
                $("body").removeClass("graniteCountertop")
            }
        },
        render: function(z) {
            var D = this,
                A, B, C;
            $(z).html(D.el);
            D.renderTemplate();
            A = D.editMode;
            window.setTimeout(function() {
                if (p3.Config.uiVersion === 1) {
                    $("#site-main").removeClass("container");
                    $("body").addClass("graniteCountertop")
                }
                B = "Alum";
                C = false;
                switch (v.Data.Persona) {
                    case 1:
                        B = "Parent";
                        C = true;
                        break;
                    case 2:
                        B = "Student";
                        C = true;
                        break;
                    case 11:
                        B = "Friend";
                        break;
                    case 3:
                        B = "Faculty";
                        C = true;
                        break
                }
                $("#current-persona-button").html(B + '<span class="caret pull-right" style="margin-left:5px">');
                if (C || !A) {
                    $("#level-filter-region").show()
                } else {
                    $("#level-filter-region").hide()
                }
            }, 100)
        },
        renderTemplate: function() {
            var z = this;
            p3.fT(z.template, function(B) {
                z.$el.html(B({
                    edit: z.editMode,
                    Header: z.header
                }));
                z.Containers.Filter = $("#filter-container");
                z.Containers.Board = $("#board-container");
                var A = p3.Data.Context.getSelectedPersona().Id;
                if (z.editMode || A == 1 || A == 2 || A == 3) {
                    if (v.Data.FilterLevels == null) {
                        v.Data.FilterLevels = new v.Cs.SchoolLevel({}, {
                            editMode: z.editMode
                        });
                        v.Data.FilterLevels.fetch({
                            async: false,
                            success: function() {
                                v.Data.FilterLevels.each(function(C) {
                                    C.set("Selected", true)
                                })
                            },
                            error: function() {
                                p3.displayError("Error loading levels")
                            }
                        })
                    }
                    z.renderFilter()
                }
                z.renderBoard()
            })
        },
        switchBoard: function(A) {
            var z = $(A.currentTarget),
                C, D, B;
            $(".btn-group.open").removeClass("open");
            C = z.data("persona");
            if (C != v.Data.Persona) {
                v.Data.Persona = C;
                B = "";
                D = true;
                switch (C) {
                    case 1:
                        B = "Parent";
                        break;
                    case 2:
                        B = "Student";
                        break;
                    case 3:
                        B = "Faculty";
                        break;
                    case 11:
                        B = "Friend";
                        D = false;
                        break;
                    case 12:
                        B = "Alum";
                        D = false;
                        break
                }
                $("#current-persona-button").html(B + '<span class="caret pull-right" style="margin-left:5px"></span>');
                if (D) {
                    $("#level-filter-region").show()
                } else {
                    $("#level-filter-region").hide()
                }
                this.renderBoard()
            }
            return false
        },
        addContainer: function(A) {
            var C = this,
                z = new v.Ms.ResourceBoardContainer({
                    ContentGroupId: 0,
                    ContentItemId: 0
                }),
                B = new v.Vs.ContainerEditView({
                    container: z,
                    linkCategories: C.linkCategories,
                    eventReg: C.eventReg
                });
            p3.rV(B, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            B.on("containerSaved", function() {
                C.renderBoard()
            })
        },
        renderFilter: function() {
            var A = this,
                z = new v.Vs.ResourceBoardFilter({
                    edit: A.editMode
                });
            z.on("filterChanged", function() {
                A.renderBoard()
            });
            p3.rV(z, A.Containers.Filter, true)
        },
        renderBoard: function() {
            var G = this,
                F = false,
                z, A, B, E, D, C;
            z = new v.Cs.ResourceBoardContainer({}, {
                editMode: G.editMode
            });
            z.remove(z.at(0));
            if (v.Data.FilterLevels && v.Data.FilterLevels.length > 1) {
                F = true
            }
            A = new v.Vs.ResourceBoard({
                collection: z,
                editMode: G.editMode,
                linkCategories: G.linkCategories,
                parentView: G,
                showLevels: F
            });
            p3.rV(A, G.Containers.Board, true);
            E = false;
            if (G.editMode) {
                D = v.Data.Persona
            } else {
                D = p3.Data.Context.getSelectedPersona().Id
            }
            switch (D) {
                case 11:
                case 12:
                    v.Us.getLevels(true, false);
                    B = v.Data.Levels;
                    E = true;
                    break;
                default:
                    B = v.Data.FilterLevels;
                    break
            }
            C = "";
            B.each(function(H) {
                if (H.get("Selected") || E) {
                    if (C.length > 0) {
                        C += ","
                    }
                    C += H.get("DdId")
                }
            });
            z.fetch({
                data: {
                    personaId: D,
                    dateMask: v.Data.Filter,
                    levels: C
                },
                success: function() {
                    z.each(function(H) {
                        H.set("LevelDescriptions", H.get("LevelDescriptions").replace(/\,/g, ", "));
                        switch (H.get("ContainerType")) {
                            case 0:
                                H.set("showDelete", G.editMode);
                                H.set("showEdit", false);
                                break;
                            case 1:
                                H.set("showDelete", G.editMode);
                                H.set("showEdit", G.editMode);
                                break;
                            case 2:
                                H.set("showDelete", false);
                                H.set("showEdit", G.editMode);
                                H.set("backcolor", "#ffe7c7");
                                H.set("systemImage", "/ftpimages/999/podium/libs/p3-cache/img/groupFinder.png");
                                H.set("viewLink", '<a href="/podium/default.aspx?t=52411&wapp=1">View All</a>');
                                break;
                            case 3:
                                H.set("showDelete", false);
                                H.set("showEdit", G.editMode);
                                H.set("backcolor", "#BDD9F2");
                                H.set("systemImage", "/ftpimages/999/podium/libs/p3-cache/img/lists.png");
                                H.set("viewLink", '<a href="/podium/default.aspx?t=23189&wapp=1">View All</a>');
                                break;
                            case 4:
                                H.set("showDelete", false);
                                H.set("showEdit", G.editMode);
                                H.set("backcolor", "#D6E0E1");
                                H.set("systemImage", "/ftpimages/999/podium/libs/p3-cache/img/reports.png");
                                H.set("viewLink", '<a href="/podium/default.aspx?t=1655&wapp=1">View All</a>');
                                break;
                            case 5:
                                H.set("showDelete", false);
                                H.set("showEdit", G.editMode);
                                H.set("backcolor", "#e6e6e6");
                                H.set("systemImage", "/ftpimages/999/podium/libs/p3-cache/img/portal.png");
                                break;
                            case 6:
                                H.set("showDelete", false);
                                H.set("showEdit", G.editMode);
                                H.set("backcolor", "#fef8c9");
                                H.set("systemImage", "/ftpimages/999/podium/libs/p3-cache/img/myFiles.png");
                                break;
                            case 7:
                                H.set("showDelete", false);
                                H.set("showEdit", G.editMode);
                                if (!H.get("ThumbFilename")) {
                                    H.set("backcolor", "#def2cb");
                                    H.set("systemImage", "/ftpimages/999/podium/libs/p3-cache/img/addAnother.png")
                                }
                                break;
                            case 8:
                                H.set("showDelete", G.editMode);
                                H.set("showEdit", G.editMode);
                                break
                        }
                    });
                    A.renderTemplate()
                },
                error: function() {
                    p3.displayError("Error loading resource board")
                }
            })
        },
        showPriorityDialog: function(z) {
            var B = this,
                A = new v.Vs.PriorityEditView();
            p3.rV(A, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            A.on("priorityChanged", function() {
                B.renderBoard()
            })
        }
    });
    v.Vs.ResourceBoardFilter = Bb.View.extend({
        template: "resourceboard/resourceboard.filter.template.html",
        events: {
            "click .filter-btn": "changeFilter",
            "click .filter-level-btn": "changeLevel",
            "click #set-priority-buton": "showPriorityDialog"
        },
        render: function(z) {
            var A = this;
            $(z).html(A.el);
            A.renderTemplate()
        },
        renderTemplate: function() {
            var z = this;
            p3.fT(z.template, function(G) {
                var D = false,
                    A = false,
                    E = false,
                    F = false,
                    C = true,
                    B = true;
                switch (v.Data.Filter) {
                    case 0:
                        D = true;
                        break;
                    case 1:
                        A = true;
                        break;
                    case 2:
                        F = true;
                        break;
                    case 3:
                        A = true;
                        F = true;
                        break;
                    case 4:
                        E = true;
                        break;
                    case 5:
                        A = true;
                        E = true;
                        break;
                    case 6:
                        E = true;
                        F = true;
                        break;
                    case 7:
                        E = true;
                        F = true;
                        break
                }
                v.Data.FilterLevels.each(function(H) {
                    if (!H.get("Selected")) {
                        C = false
                    } else {
                        B = false
                    }
                });
                z.$el.html(G({
                    allOn: D,
                    activeOn: A,
                    expiredOn: E,
                    futureOn: F,
                    haveLevels: v.Data.FilterLevels.length > 1,
                    levels: v.Data.FilterLevels.toJSON(),
                    allLevelsOn: C || B,
                    edit: z.options.edit
                }))
            })
        },
        changeFilter: function(A) {
            var D = this,
                B = v.Data.Filter,
                z = $(A.currentTarget),
                C = z.data("val");
            if (C == 0) {
                v.Data.Filter = 0
            } else {
                if (z.hasClass("active")) {
                    v.Data.Filter = v.Data.Filter - C
                } else {
                    v.Data.Filter = v.Data.Filter + C;
                    if (v.Data.Filter == 7) {
                        v.Data.Filter = 0
                    }
                }
            }
            if (B != v.Data.Filter) {
                D.renderTemplate();
                D.trigger("filterChanged")
            }
        },
        changeLevel: function(A) {
            var D = this,
                z = $(A.currentTarget),
                C = z.data("val"),
                B;
            if (C == 0) {
                v.Data.FilterLevels.each(function(E) {
                    E.set("Selected", true)
                })
            } else {
                B = v.Data.FilterLevels.get(C);
                if ($("#filter-level-all").hasClass("active")) {
                    v.Data.FilterLevels.each(function(E) {
                        E.set("Selected", false)
                    });
                    B.set("Selected", true)
                } else {
                    if (z.hasClass("active")) {
                        B.set("Selected", false)
                    } else {
                        B.set("Selected", true)
                    }
                }
            }
            D.renderTemplate();
            D.trigger("filterChanged")
        },
        showPriorityDialog: function(z) {
            var B = this,
                A = new v.Vs.PriorityEditView();
            p3.rV(A, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            A.on("priorityChanged", function() {
                B.trigger("filterChanged")
            })
        }
    });
    v.Vs.ResourceBoard = Bb.View.extend({
        template: "resourceboard/resourceboard.template.html",
        events: {
            "click .container-container": "handleBoardClick",
            "click .container-delete": "deleteContainer",
            "click .container-edit": "editContainer",
            "click #application": "application",
            "change #portal-drop-down": "openPortal",
            "change #page-drop-down": "openPage",
            "change #group-finder-dropdown": "updateGroupFinder",
            modalsave: "modalSave",
            modalcustom: "modalCustom",
            modalupdated: "modalUpdated"
        },
        initialize: function() {
            var z = this;
            z.instanceIds = new b.Cs.ProspectInstanceIds()
        },
        render: function(z) {
            var A = this;
            $(z).html(A.el);
            A.dictionaries = {};
            A.dictionaries.applicationForms = new b.Cs.ApplicationForms();
            A.dictionaries.applicationForms.fetch({
                cache: false,
                async: false,
                data: {
                    activeApps: true,
                    formType: 1
                },
                success: function(B, C) {
                    A.dictionaries.applicationForms.dictionary = C
                }
            })
        },
        handleBoardClick: function(D) {
            var E = this,
                z = $(D.currentTarget),
                B = z.data("rbcid"),
                C = z.data("type"),
                A;
            u.Us.InteractionEventLog(g.InteractionEventType.ViewResourceBoardItem, B);
            switch (C) {
                case 0:
                    if (E.options.editMode) {
                        p3.router().navigate("#resourceboarddetailedit/" + B + "/settings", true)
                    } else {
                        p3.router().navigate("#resourceboarddetail/" + B, true)
                    }
                    break;
                case 1:
                    A = E.collection.get(B);
                    if (A.get("UrlDisplay")) {
                        window.open(A.get("UrlDisplay"), "_blank")
                    }
                    break;
                case 7:
                    E.application(null);
                    break;
                case 8:
                    A = new v.Ms.ResourceBoardContainerGet({
                        ResourceBoardContainerId: B
                    });
                    A.fetch({
                        data: {
                            containerId: B
                        },
                        success: function() {
                            if (A.get("ContentIndexId")) {
                                window.location.href = "/podium/default.aspx?t=36644&wapp=1&rid=" + A.get("ContentIndexId")
                            }
                        },
                        error: function() {
                            p3.displayError("Error loading registration post")
                        }
                    });
                    break;
                default:
                    break
            }
        },
        renderTemplate: function() {
            var B = this,
                A, z;
            B.collection.each(function(C) {
                C.set("LongDescription", C.get("LongDescription").replace(/[\n\r]/g, "<br />"));
                switch (C.get("ContainerType")) {
                    case 2:
                        if (B.options.showLevels) {
                            C.set("ContainerHeight", "296px")
                        } else {
                            C.set("ContainerHeight", "266px")
                        }
                        break;
                    case 3:
                    case 4:
                        if (B.options.showLevels) {
                            C.set("ContainerHeight", "259px")
                        } else {
                            C.set("ContainerHeight", "229px")
                        }
                        break;
                    case 5:
                        if (B.options.showLevels) {
                            C.set("ContainerHeight", "322px")
                        } else {
                            C.set("ContainerHeight", "292px")
                        }
                        break
                }
            });
            A = {};
            A.showApplyLink = (B.dictionaries.applicationForms.dictionary && B.dictionaries.applicationForms.dictionary.length > 0) ? true : false;
            p3.fT(B.template, function(C) {
                B.$el.html(C({
                    containers: B.collection.toJSON(),
                    schoolId: p3.Data.SchoolContext.get("SchoolInfo").SchoolId,
                    edit: B.options.editMode,
                    templateOptions: A,
                    showLevels: B.options.showLevels
                }))
            });
            $("#board-container").hide();
            $("#load-container").append('<div id="loading-icon"></div>');
            z = $("#loading-icon");
            if (p3.Config.uiVersion === 3) {
                z.css("height", "50px").css("background-color", "#fff")
            }
            p3.loadingIcon("#loading-icon");
            p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.Isotope, function() {
                window.setTimeout(function() {
                    z.remove();
                    $("#board-container").show();
                    $(".board-container").isotope({
                        itemSelector: ".container-container",
                        getSortData: {
                            type: function(C) {
                                return parseInt(C.data("sort"), 10)
                            }
                        },
                        sortBy: "type"
                    });
                    $(".board-container").imagesLoaded(function() {
                        $(".board-container").isotope({
                            itemSelector: ".container-container"
                        })
                    })
                }, 2000)
            })
        },
        deleteContainer: function(C) {
            C.preventDefault();
            C.stopPropagation();
            var D = this,
                z = $(C.currentTarget),
                B = z.data("id"),
                A = D.collection.get(B);
            p3.showConfirm("Delete Post", "Are you sure you want to remove this post?", null, function() {
                var E = new v.Ms.ResourceBoardContainer({
                    ResourceBoardContainerId: B
                });
                E.destroy({
                    success: function() {
                        p3.displaySiteMessage("Post deleted successfully.", "alert-success");
                        D.collection.remove(A);
                        D.renderTemplate()
                    },
                    error: function() {
                        p3.displayError("Error deleting post.")
                    }
                })
            })
        },
        editContainer: function(C) {
            C.preventDefault();
            C.stopPropagation();
            var D = this,
                z = $(C.currentTarget),
                B = z.data("id"),
                A = new v.Ms.ResourceBoardContainer({
                    ResourceBoardContainerId: B
                });
            A.fetch({
                data: {
                    containerId: B
                },
                success: function() {
                    var H, F, E, G;
                    if (A.get("ContainerType") == 1) {
                        E = D.options.linkCategories.where({
                            Id: A.get("ContentGroupId")
                        });
                        A.set("LinkGroup", E[0].get("Name"));
                        H = new m.Cs.Link({}, {
                            categoryId: A.get("ContentGroupId"),
                            active: true,
                            future: false,
                            expired: false
                        });
                        H.fetch({
                            async: false,
                            success: function() {
                                var I = H.where({
                                    LinkID: A.get("ContentItemId")
                                });
                                if (I && I.length > 0) {
                                    A.set("Link", I[0].get("ShortDescription"))
                                } else {
                                    A.set("ContentIndexId", 0);
                                    A.set("ContentItemId", 0)
                                }
                            },
                            error: function() {
                                p3.displayError("Error loading links.")
                            }
                        });
                        F = new v.Vs.ContainerEditView({
                            container: A,
                            linkCategories: D.options.linkCategories,
                            links: H
                        })
                    } else {
                        if (A.get("ContainerType") == 7) {
                            F = new v.Vs.ContainerEditView({
                                container: A
                            })
                        } else {
                            if (A.get("ContainerType") == 8) {
                                G = new h.Cs.Registrations();
                                G.fetch({
                                    async: false,
                                    success: function() {
                                        var I = G.get(A.get("ContentIndexId"));
                                        if (I) {
                                            A.set("Link", I.get("Description"))
                                        } else {
                                            A.set("ContentIndexId", 0)
                                        }
                                    },
                                    error: function() {
                                        p3.displayError("Error loading event registrations")
                                    }
                                });
                                F = new v.Vs.ContainerEditView({
                                    container: A,
                                    eventReg: G
                                })
                            } else {
                                F = new v.Vs.SystemEditView({
                                    container: A
                                })
                            }
                        }
                    }
                    p3.rV(F, p3.Layout.Containers.Modal, true);
                    p3.showModal(p3.Layout.Containers.Modal);
                    F.on("containerSaved", function(I) {
                        D.options.parentView.renderBoard()
                    })
                },
                error: function() {
                    p3.displayError("Error loading resource board")
                }
            })
        },
        application: function(A) {
            if (A) {
                A.preventDefault();
                A.stopPropagation()
            }
            var B = this,
                z = new b.Ms.CreateAccount();
            B.dictionaries.enteringYears = new b.Ms.LoginSetup();
            B.dictionaries.enteringGrades = new b.Cs.EnteringGrades();
            B.dictionaries.childrenNonStudent = new b.Cs.ChildrenNonStudent();
            r.Us.Fetch({
                EnteringYears: B.dictionaries.enteringYears,
                EnteringGrades: B.dictionaries.enteringGrades,
                ChildrenNonStudent: B.dictionaries.childrenNonStudent
            }, function(C, E, D) {
                B.dictionaries.enteringYears.dictionary = C.EnteringYears.toJSON();
                B.dictionaries.enteringGrades.dictionary = C.EnteringGrades.toJSON();
                B.dictionaries.childrenNonStudent.dictionary = C.ChildrenNonStudent.toJSON();
                B.dictionaries.applicationForms.fetch({
                    cache: false,
                    data: {
                        activeApps: true,
                        formType: 1
                    },
                    success: function(F, G) {
                        B.dictionaries.applicationForms.dictionary = G;
                        B.dictionaries.enteringYears.dictionary = _.filter(B.dictionaries.enteringYears.toJSON().CreateAccountSchoolYears, function(H) {
                            return H.SelectedInd == true
                        });
                        if (B.dictionaries.enteringYears.dictionary.length > 1) {
                            B.singleEnteringYear = false
                        } else {
                            B.singleEnteringYear = true;
                            z.set({
                                EnteringYear: B.dictionaries.enteringYears.dictionary[0].SchoolYearLabel
                            })
                        }
                        p3.showModal(p3.Layout.Containers.Modal, {
                            backOnHide: false
                        });
                        p3.rV(new w.Vs.ModelModal({
                            template: "resourceboard/resourceboard.application.template.html",
                            model: z,
                            parentView: B
                        }), p3.Layout.Containers.Modal, true);
                        B.disableSubmitted()
                    }
                })
            })
        },
        disableSubmitted: function() {
            var z = this;
            _.each(z.dictionaries.childrenNonStudent.dictionary, function(A) {
                z.instanceIds.fetch({
                    update: true,
                    cache: false,
                    data: {
                        userId: A.dd_id
                    },
                    success: function(B, C) {
                        if (B.models[0].attributes.AppFormId == -1) {
                            $("input[value='" + A.dd_id + "']").attr("disabled", "disabled")
                        }
                    }
                })
            })
        },
        modalUpdated: function(z) {
            var A = this;
            if (z.updateTarget.attr("name") == "ProspectUserId") {
                A.instanceIds.fetch({
                    update: true,
                    cache: false,
                    data: {
                        userId: z.context.model.get("ProspectUserId")
                    },
                    success: function(D, H) {
                        var C, B, E, G, F;
                        A.candidate = false;
                        A.currentCandidate = false;
                        A.currentProspectInstanceId = 0;
                        A.enteringGradeId = null;
                        if (D.models.length > 0) {
                            A.candidate = true;
                            B = _.filter(D.toJSON(), function(I) {
                                return I.AdmCurrentYearInd == true
                            });
                            C = _.chain(B).pluck("AppFormId").uniq().value();
                            A.appFormId = _.filter(C, function(I) {
                                return I != null
                            });
                            if (B.length > 0) {
                                A.currentCandidate = true
                            }
                            E = _.chain(B).pluck("ProspectInstanceId").uniq().value();
                            A.currentProspectInstanceId = E[0];
                            G = D.find(function(I) {
                                return I.get("ProspectInstanceId") == A.currentProspectInstanceId
                            });
                            if (G) {
                                A.enteringGradeId = G.get("EnteringGradeId")
                            }
                        }
                        F = _.pluck(D.toJSON(), "EnteringYear");
                        $('[name="EnteringYear"] option').remove();
                        if (!A.singleEnteringYear) {
                            $('[name="EnteringYear"]').append('<option value="">-- Select an Option --</option>')
                        }
                        _.each(A.dictionaries.enteringYears.dictionary, function(I) {
                            if (!_.contains(F, I.SchoolYearLabel)) {
                                $('[name="EnteringYear"]').append('<option value="' + I.SchoolYearLabel + '">' + I.SchoolYearLabel + "</option>")
                            }
                        });
                        if (z.context.model.get("ProspectUserId") == "0") {
                            z.context.model.set({
                                CurrentApplicant: false
                            });
                            z.context.$(".new-candidate").show();
                            z.context.$(".new-candidate-year").show()
                        } else {
                            if (A.candidate) {
                                if (A.currentCandidate) {
                                    z.context.model.set({
                                        CurrentApplicant: true
                                    });
                                    z.context.$(".new-candidate").hide();
                                    z.context.$(".new-candidate-year").hide()
                                } else {
                                    z.context.model.set({
                                        CurrentApplicant: false
                                    });
                                    z.context.$(".new-candidate").hide();
                                    z.context.$(".new-candidate-year").show()
                                }
                            } else {
                                z.context.model.set({
                                    CurrentApplicant: false
                                });
                                z.context.$(".new-candidate").hide();
                                z.context.$(".new-candidate-year").show()
                            }
                        }
                        p3.setModalHeight(p3.Layout.Containers.Modal)
                    }
                });
                z.context.model.set({
                    CandidateFirstName: null,
                    CandidateLastName: null,
                    NickName: null,
                    CandidateDOB: null,
                    EnteringGradeId: null,
                    Agree: false
                });
                $('[name="CandidateFirstName"]').val("");
                $('[name="CandidateLastName"]').val("");
                $('[name="NickName"]').val("");
                $('[name="CandidateDOB"]').val(z.context.model.get("CandidateDOB"));
                $('[name="EnteringGradeId"]').val(z.context.model.get("EnteringGradeId"));
                $('[name="Agree"]').prop("checked", false);
                if (z.context.options.parentView.singleEnteringYear == false) {
                    z.context.model.set({
                        EnteringYear: null
                    });
                    $('[name="EnteringYear"]').val(z.context.model.get("EnteringYear"))
                }
                Bb.Validation.callbacks.valid(z.context, "CandidateFirstName", "name");
                Bb.Validation.callbacks.valid(z.context, "CandidateLastName", "name");
                Bb.Validation.callbacks.valid(z.context, "NickName", "name");
                Bb.Validation.callbacks.valid(z.context, "CandidateDOB", "name");
                Bb.Validation.callbacks.valid(z.context, "EnteringYear", "name");
                Bb.Validation.callbacks.valid(z.context, "EnteringGradeId", "name");
                Bb.Validation.callbacks.valid(z.context, "Agree", "name");
                z.context.$("#infomessage-error").remove()
            }
        },
        modalSave: function(z) {
            var A = this;
            z.preventDefault();
            z.context.$(".save").button("loading");
            if (z.context.model.isValid(true)) {
                if (A.currentCandidate) {
                    if (A.appFormId > 0) {
                        p3.router().navigate("#application/" + A.appFormId + "/keyid=" + A.currentProspectInstanceId, true)
                    } else {
                        A.appFormNavigate(z, A.enteringGradeId, A.currentProspectInstanceId)
                    }
                } else {
                    z.context.model.set({
                        FieldsToNull: []
                    });
                    _.each(z.context.model.attributes, function(D, B, C) {
                        z.context.recursiveFunction(D, B, C, "")
                    });
                    if (z.context.model.get("ProspectUserId") != "0") {
                        z.context.model.set({
                            CandidateFirstName: null,
                            CandidateLastName: null,
                            NickName: null
                        })
                    }
                    z.context.model.save({}, {
                        dataParam: z.context.options.dataParam,
                        success: function(B, C) {
                            p3.Data.Context.forceRefresh({
                                success: function(D) {
                                    $("#topnav-containter").trigger("renderSiteNav");
                                    $("#site-switcher-container").trigger("renderPersona");
                                    A.appFormNavigate(z, z.context.model.get("EnteringGradeId"), z.context.model.get("ProspectInstanceId"))
                                }
                            })
                        },
                        error: function(C, B) {
                            z.context.$(".save").button("reset")
                        }
                    })
                }
            } else {
                z.context.$(".save").button("reset")
            }
        },
        modalCustom: function(z) {
            p3.router().navigate(z.context.model.get("ApplicationForm"), true)
        },
        appFormNavigate: function(A, z, C) {
            var D = this,
                B = D.dictionaries.applicationForms.getFormsForGrade(z, true);
            if (B && B.length) {
                D.dictionaries.applicationForms.dictionary = _.invoke(B, "toJSON");
                if (D.dictionaries.applicationForms.dictionary.length == 1) {
                    p3.router().navigate("#application/" + D.dictionaries.applicationForms.dictionary[0].ApplicationFormId + "/keyid=" + C, true)
                } else {
                    p3.rV(new w.Vs.ModelModal({
                        template: "resourceboard/resourceboard.applicationselect.template.html",
                        parentView: D,
                        variables: {
                            prospectInstanceId: C
                        }
                    }), A.context.$el, true)
                }
            } else {
                k.ErrorBox("There are no available applications at this time.", A.context.$(".modal-body"), false);
                A.context.$(".modal-body").animate({
                    scrollTop: 0
                }, "fast");
                A.context.$("button.save").button("reset")
            }
        },
        openPortal: function(z) {
            var A = $("#portal-drop-down").val();
            $("#portal-drop-down").val("0");
            window.location.href = "/podium/default.aspx?t=" + A + "&wapp=1"
        },
        openPage: function(z) {
            var A = $("#page-drop-down").val(),
                B = $("#page-drop-down").find(":selected").data("url");
            $("#page-drop-down").val("0");
            if (B) {
                if (B.indexOf("://") == -1) {
                    B = "http://" + B
                }
                window.location.href = B
            } else {
                window.location.href = "/podium/default.aspx?t=" + A + "&wapp=1"
            }
        },
        updateGroupFinder: function(B) {
            var z = $("#group-finder-dropdown"),
                A;
            A = $("option:selected", z);
            v.Data.CurrentYear = z.val();
            v.Data.CurrentMode = A.data("mode");
            $(".group-list").remove();
            v.Us.initializeGroupInput()
        }
    });
    v.Vs.ContainerEditView = Bb.View.extend({
        template: "resourceboard/resourceboard.container.edit.template.html",
        events: {
            "click #chkSelectAll": "selectAll",
            "click #select-all-boards": "selectAllSystem",
            "click #apply-button": "copyDefaultValues",
            "click .persona-check": "personaChange",
            "click #btnSave": "saveContainer",
            "click #btnSaveAdd": "saveContainer",
            "click #btnSaveEdit": "saveContainer",
            "click .btn-gray": "clearError",
            "click .btn-layout": "clearError",
            "change #txtTitle": "clearTitle",
            "keyup #txtDescription": "updateDescriptionCount",
            "change #txtDescription": "updateDescriptionCount",
            "click .btn-container-type": "changePageType",
            "click .select-search-form": "searchClicked",
            "keyup .select-search": "searchItems",
            "submit .select-search-form": "searchItems",
            "click .select-item": "contentClicked",
            "click .post-photo-delete": "deletePhoto"
        },
        render: function(z) {
            var A = this;
            $(z).html(A.el);
            A.renderTemplate();
            p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.jQueryUI, function() {
                p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.FileUpload, A.initializeFileUpload)
            })
        },
        renderTemplate: function() {
            var H = this,
                F = v.Us.getPersonaLevels(false),
                z = d.getDateString(d.localDateTime()),
                B, C, D, E, A, G;
            if (H.options.container.get("ResourceBoardContainerId") > 0) {
                G = H.options.container.get("PersonaLevels");
                for (B = 0; B < F.length; B++) {
                    F[B].Selected = false;
                    for (C = 0; C < G.length; C++) {
                        if ((G[C].LevelId == F[B].LevelId || F[B].LevelId == -1) && G[C].PersonaId == F[B].persona) {
                            F[B].Selected = true;
                            F[B].PublishDate = G[C].PublishDate.split(" ")[0];
                            if (G[C].ExpireDate) {
                                F[B].ExpireDate = G[C].ExpireDate.split(" ")[0]
                            }
                            break
                        }
                    }
                }
            } else {
                for (B = 0; B < F.length; B++) {
                    if (F[B].Selected) {
                        F[B].PublishDate = z
                    }
                }
            }
            if (H.options.linkCategories) {
                D = H.options.linkCategories.toJSON()
            }
            if (H.options.links) {
                E = H.options.links.toJSON()
            }
            if (H.options.eventReg) {
                if (H.options.eventReg.length > 0) {
                    if (!H.options.eventReg.models[0].get("Id")) {
                        H.options.eventReg.remove(H.options.eventReg.at(0))
                    }
                }
                A = H.options.eventReg.toJSON()
            }
            p3.fT(H.template, function(I) {
                H.$el.html(I({
                    container: H.options.container.toJSON(),
                    schoolId: p3.Data.SchoolContext.get("SchoolInfo").SchoolId,
                    personaLevels: F,
                    defaultDate: z,
                    linkCategories: D,
                    links: E,
                    eventReg: A,
                    showReg: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.EVENTREGISTRATION)
                }))
            });
            window.setTimeout(function() {
                e.Us.initialize(".date-box", {
                    changeMonth: true,
                    changeYear: true
                });
                H.updateDescriptionCount()
            }, 600)
        },
        initializeFileUpload: function() {
            window.setTimeout(function() {
                $("#fileupload").fileupload({
                    url: p3.Config.RootPath + "utilities/FileTransferHandler.ashx",
                    autoUpload: true
                }).on("fileuploadadd", function(A, z) {
                    if ($("#resource-board-file-error").length > 0) {
                        $("#resource-board-file-error").remove()
                    }
                    z.files[0].isValidUpload = p3.Us.FileTools.isValidFile(p3.Us.Enum.UploadType.All, z.files[0].name);
                    if (z.files[0].isValidUpload) {
                        z.submit()
                    } else {
                        $("#fileupload").before($("<div>").attr("id", "resource-board-file-error").addClass("alert alert-error").html("The file " + z.files[0].name + " is not a supported type and was not uploaded."))
                    }
                }).bind("fileuploaddone", function(A, z) {
                    if (z.files[0].isValidUpload) {
                        $("#image-region").removeClass("dragRegion").html('<img id="container-image" class="mediaContainer" src="/ftpimages/pdTemp/' + z.result[0].name + '">')
                    }
                })
            }, 100)
        },
        clearError: function(z) {
            $("#container_edit_error_region").html("");
            $("#container_edit_error_region").removeClass()
        },
        clearTitle: function(z) {
            $(".topic-title-group").removeClass("error")
        },
        copyDefaultValues: function(z) {
            var B = $("#default-publish").val(),
                A = $("#default-expire").val();
            $("tr.persona-row").each(function(C) {
                if ($(this).find(".persona-check").is(":checked")) {
                    $(this).find(".publish-date").val(B);
                    $(this).find(".expire-date").val(A)
                }
            });
            return false
        },
        selectAll: function(z) {
            $("tr.persona-row").each(function(A) {
                $(this).find(".persona-check").prop("checked", z.target.checked)
            })
        },
        selectAllSystem: function(z) {
            $("tr.persona-row").each(function(A) {
                $(this).find(".group-item").addClass("active")
            })
        },
        personaChange: function(z) {
            var A = $(".persona-check:checked"),
                B = $(".persona-row");
            if (A.length >= B.length) {
                $("#chkSelectAll").prop("checked", true)
            } else {
                $("#chkSelectAll").prop("checked", false)
            }
        },
        saveContainer: function(D) {
            $("#btnSave").button("loading");
            $("#btnSaveAdd").button("loading");
            $("#btnSaveEdit").button("loading");
            var R = this,
                A = (D.target.id == "btnSaveAdd"),
                M = (D.target.id == "btnSaveEdit"),
                I = [],
                G = R.options.container,
                Q = true,
                F = "",
                C = false,
                L = false,
                N, H, E, P, J, B, O, z, K;
            if (G.get("ResourceBoardContainerId") > 0) {
                C = (G.get("ContainerType") == 1);
                L = (G.get("ContainerType") == 8)
            } else {
                C = $("#btn-direct-link").hasClass("active");
                L = $("#btn-registration").hasClass("active")
            }
            if ($("#txtTitle").val().length == 0) {
                Q = false;
                $(".topic-title-group").addClass("error")
            }
            if (C) {
                if ($("#link-button").data("value") == 0) {
                    Q = false;
                    F = "Please select a link."
                }
            } else {
                if (L) {
                    if ($("#reg-button").data("value") == 0) {
                        Q = false;
                        F = "Please select a registration."
                    }
                } else {
                    if ($(".btn-gray.active").length == 0 && $(".btn-layout.active").length == 0) {
                        Q = false;
                        F = "Please select a page layout."
                    }
                }
            }
            if (Q) {
                if (G.get("ContainerType") == 7) {
                    N = $(".group-item.active");
                    K = d.getDateString(d.localDateTime());
                    $("tr.persona-row").each(function(S) {
                        z = $(this).find(".group-item");
                        if (z.hasClass("active")) {
                            if (z.data("persona") == 11 || z.data("persona") == 12) {
                                v.Data.Levels.each(function(T) {
                                    I.push({
                                        PersonaId: z.data("persona"),
                                        LevelId: T.get("DdId"),
                                        PublishDate: K
                                    })
                                })
                            } else {
                                I.push({
                                    PersonaId: z.data("persona"),
                                    LevelId: z.data("level"),
                                    PublishDate: K
                                })
                            }
                        }
                    })
                } else {
                    N = $(".persona-check:checked");
                    if (N.length > 0) {
                        $("tr.persona-row").each(function(T) {
                            var U, S;
                            z = $(this).find(".persona-check");
                            if (z.is(":checked")) {
                                if ($(this).find(".publish-date").val().length == 0) {
                                    Q = false;
                                    F = "A publish date is required for each selected persona."
                                } else {
                                    if (z.data("persona") == 11 || z.data("persona") == 12) {
                                        U = $(this).find(".publish-date").datepicker("getDate");
                                        S = "";
                                        if ($(this).find(".expire-date").val().length > 0) {
                                            S = $(this).find(".expire-date").datepicker("getDate")
                                        }
                                        v.Data.Levels.each(function(V) {
                                            I.push({
                                                PersonaId: z.data("persona"),
                                                LevelId: V.get("DdId"),
                                                PublishDate: U,
                                                ExpireDate: S,
                                                PersonaLevelDescription: z.parent().text().trim()
                                            })
                                        })
                                    } else {
                                        U = $(this).find(".publish-date").datepicker("getDate");
                                        S = "";
                                        if ($(this).find(".expire-date").val().length > 0) {
                                            S = $(this).find(".expire-date").datepicker("getDate")
                                        }
                                        I.push({
                                            PersonaId: z.data("persona"),
                                            LevelId: z.data("level"),
                                            PublishDate: U,
                                            ExpireDate: S,
                                            PersonaLevelDescription: z.parent().text().trim()
                                        })
                                    }
                                }
                            }
                        })
                    } else {
                        Q = false;
                        F = "Please select a persona"
                    }
                }
            }
            if (Q) {
                E = false;
                P = "";
                J = "";
                B = $("#delete-photo-alert").is(":visible");
                if ($("#container-image").length > 0) {
                    E = true;
                    O = $("#container-image").attr("src");
                    if (O.indexOf("/pdTemp/") > -1) {
                        P = O
                    }
                    H = O.split(".");
                    J = "." + H[H.length - 1]
                }
                G.set({
                    ShortDescription: $("#txtTitle").val(),
                    LongDescription: $("#txtDescription").val(),
                    PersonaLevels: I,
                    HasPhoto: E,
                    PhotoExtension: J,
                    TempPhoto: P,
                    DeletePhoto: B
                });
                if (C) {
                    G.set("ContentItemId", $("#link-button").data("value"));
                    G.set("ContentGroupId", $("#link-category-button").data("value"));
                    G.set("ContainerType", 1);
                    G.set("LayoutId", 0)
                } else {
                    if (L) {
                        G.set("ContentItemId", $("#reg-button").data("value"));
                        G.set("ContainerType", 8);
                        G.set("LayoutId", 0)
                    } else {
                        if (p3.Config.uiVersion === 1) {
                            G.set("LayoutId", $(".btn-gray.active").data("layout"))
                        } else {
                            G.set("LayoutId", $(".btn-layout.active").data("layout"))
                        }
                        G.set("ContainerType", 0)
                    }
                }
                G.save({}, {
                    error: function() {
                        p3.showModal(p3.Layout.Containers.Modal, "hide");
                        p3.displayError("Error saving resource board")
                    },
                    success: function() {
                        if (B) {
                            G.set("ThumbFilename", "")
                        } else {
                            if (E && !G.get("ThumbFilename")) {
                                G.set("ThumbFilename", "thumb_rb_container_" + G.get("ResourceBoardContainerId") + J)
                            }
                        }
                        if (M) {
                            p3.showModal(p3.Layout.Containers.Modal, "hide");
                            p3.router().navigate("#resourceboarddetailedit/" + G.get("ResourceBoardContainerId") + "/settings", true)
                        } else {
                            R.trigger("containerSaved", G);
                            if (A) {
                                R.options.container = new v.Ms.ResourceBoardContainer({});
                                R.renderTemplate();
                                p3.setModalHeight(p3.Layout.Containers.Modal);
                                p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.jQueryUI, function() {
                                    p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.FileUpload, R.initializeFileUpload)
                                })
                            } else {
                                p3.showModal(p3.Layout.Containers.Modal, "hide")
                            }
                        }
                    }
                })
            } else {
                $("#btnSave").button("reset");
                $("#btnSaveAdd").button("reset");
                $("#btnSaveEdit").button("reset");
                if (F.length > 0) {
                    $("#container_edit_error_region").html(F);
                    $("#container_edit_error_region").addClass("alert").addClass("alert-error alert-danger")
                } else {
                    $("#container_edit_error_region").html("");
                    $("#container_edit_error_region").removeClass()
                }
            }
        },
        updateDescriptionCount: function(z) {
            $("#titleCountField").html($("#txtDescription").val().length)
        },
        changePageType: function(A) {
            var z = $(A.currentTarget);
            $(".btn-container-type").removeClass("active");
            z.addClass("active");
            if (A.currentTarget.id == "btn-direct-link") {
                $("#direct-link-region").show();
                $("#detail-page-type").hide();
                $("#registration-region").hide();
                $("#btnSaveEdit").hide()
            } else {
                if (A.currentTarget.id == "btn-registration") {
                    $("#direct-link-region").hide();
                    $("#detail-page-type").hide();
                    $("#registration-region").show();
                    $("#btnSaveEdit").hide()
                } else {
                    $("#direct-link-region").hide();
                    $("#detail-page-type").show();
                    $("#registration-region").hide();
                    $("#btnSaveEdit").show()
                }
            }
            return false
        },
        searchClicked: function(z) {
            z.stopPropagation();
            $(z.currentTarget).find(".select-search").focus();
            return false
        },
        searchItems: function(A) {
            A.preventDefault();
            var G = this,
                F, D, B = false,
                C = false,
                z, E;
            if (A.currentTarget.id == "link-select") {
                D = G.links.toJSON();
                z = $("#link-list");
                B = true;
                F = $("#link-select").val()
            } else {
                if (A.currentTarget.id == "reg-select") {
                    D = G.options.eventReg.toJSON();
                    z = $("#reg-list");
                    C = true;
                    F = $("#reg-select").val()
                } else {
                    D = G.options.linkCategories.toJSON();
                    z = $("#link-category-list");
                    F = $("#link-category-select").val()
                }
            }
            if (F && F.length > 0) {
                D = _.filter(D, function(H) {
                    if (B) {
                        E = (H.ShortDescription.toLowerCase().indexOf(F.toLowerCase()) > -1)
                    } else {
                        if (C) {
                            E = (H.Description.toLowerCase().indexOf(F.toLowerCase()) > -1)
                        } else {
                            E = (H.Name.toLowerCase().indexOf(F.toLowerCase()) > -1)
                        }
                    }
                    return E
                })
            }
            z.empty();
            _.each(D, function(H) {
                if (B) {
                    z.append('<li class="select-item-li"><a href="#" class="select-item link-item" data-val="' + H.LinkID + '">' + H.ShortDescription + "</a></li>")
                } else {
                    if (C) {
                        z.append('<li class="select-item-li"><a href="#" class="select-item reg-item" data-val="' + H.Id + '">' + H.Description + "</a></li>")
                    } else {
                        z.append('<li class="select-item-li"><a href="#" class="select-item link-category-item" data-val="' + H.Id + '">' + H.Name + "</a></li>")
                    }
                }
            })
        },
        contentClicked: function(C) {
            C.preventDefault();
            var F = this,
                A = $(C.currentTarget),
                D = A.data("val"),
                B = A.html(),
                z, E;
            if (A.hasClass("link-item")) {
                z = $("#link-button")
            } else {
                if (A.hasClass("reg-item")) {
                    z = $("#reg-button")
                } else {
                    $("#link-select").val("");
                    z = $("#link-category-button");
                    $("#link-button").data("value", "0").html('<span class="select-label style-css data-value="0" id="link">-- Select Link --</span><span class="caret pull-right"></span>');
                    E = new m.Cs.Link({}, {
                        categoryId: D,
                        active: true,
                        future: false,
                        expired: false
                    });
                    F.links = E;
                    E.fetch({
                        success: function() {
                            var G = $("#link-list");
                            G.empty();
                            E.each(function(H) {
                                G.append('<li class="select-item-li"><a href="#" class="select-item link-item" data-val="' + H.get("LinkID") + '">' + H.get("ShortDescription") + "</a></li>")
                            })
                        },
                        error: function() {
                            p3.displayError("Error loading links.")
                        }
                    })
                }
            }
            z.data("value", D);
            z.html(B)
        },
        deletePhoto: function(z) {
            $("#image-region").hide();
            $("#delete-photo-alert").show();
            $(".post-photo-delete").hide();
            $(".fileinput-button").hide()
        }
    });
    v.Vs.SystemEditView = Bb.View.extend({
        template: "resourceboard/resourceboard.system.edit.template.html",
        events: {
            "click #select-all-boards": "selectAll",
            "click #btnSave": "saveContainer"
        },
        render: function(z) {
            var A = this;
            $(z).html(A.el);
            A.renderTemplate()
        },
        renderTemplate: function() {
            var D = this,
                z, A, B = v.Us.getPersonaLevels(true),
                C = D.options.container.get("PersonaLevels");
            if (C) {
                for (z = 0; z < B.length; z++) {
                    B[z].Selected = false;
                    for (A = 0; A < C.length; A++) {
                        if ((C[A].LevelId == B[z].LevelId || B[z].LevelId == -1) && C[A].PersonaId == B[z].persona) {
                            B[z].Selected = true;
                            break
                        }
                    }
                }
            }
            p3.fT(D.template, function(E) {
                D.$el.html(E({
                    container: D.options.container.toJSON(),
                    personaLevels: B
                }))
            })
        },
        selectAll: function(z) {
            $("tr.persona-row").each(function(A) {
                $(this).find(".group-item").addClass("active")
            })
        },
        saveContainer: function(A) {
            $("#btnSave").button("loading");
            var F = this,
                C = [],
                B = F.options.container,
                E, z, D;
            E = $(".group-item.active");
            if (E.length > 0) {
                D = d.getDateString(d.localDateTime());
                $("tr.persona-row").each(function(G) {
                    z = $(this).find(".group-item");
                    if (z.hasClass("active")) {
                        if (z.data("persona") == 11 || z.data("persona") == 12) {
                            v.Data.Levels.each(function(H) {
                                C.push({
                                    PersonaId: z.data("persona"),
                                    LevelId: H.get("DdId"),
                                    PublishDate: D
                                })
                            })
                        } else {
                            C.push({
                                PersonaId: z.data("persona"),
                                LevelId: z.data("level"),
                                PublishDate: D
                            })
                        }
                    }
                })
            }
            B.set("PersonaLevels", C);
            B.save({}, {
                error: function() {
                    p3.showModal(p3.Layout.Containers.Modal, "hide");
                    p3.displayError("Error saving system post settings")
                },
                success: function() {
                    F.trigger("containerSaved", B);
                    p3.showModal(p3.Layout.Containers.Modal, "hide")
                }
            })
        }
    });
    v.Vs.EditDetail = Bb.View.extend({
        template: "resourceboard/resourceboard.detail.edit.template.html",
        initialize: function() {
            this.Containers = {};
            this.options.editMode = this.options.editMode || "content"
        },
        dispose: function() {
            p3.closeFixedSidebar();
            p3.closeFixedFooter();
            this.disposeData()
        },
        render: function(z) {
            var A = this;
            $(z).html(A.el);
            p3.fT(A.template, function(B) {
                A.$el.html(B({
                    layout: A.model.toJSON()
                }));
                A.Containers.WorkspaceWrap = $(".workspace-page-wrap");
                A.Containers.Workspace = $("#pages-workspace");
                A.initData();
                A.renderSidebar();
                A.renderFooter();
                if (A.options.editMode == "style") {
                    A.renderStyler()
                } else {
                    A.renderBuilder()
                }
                A.updateView()
            })
        },
        initData: function() {
            v.Us.getLevels(true, true);
            var B = this,
                z = B.options.page.get("SiteLayout"),
                A = B.options.page.get("PageRegions");
            B.options.builderData = new l.Ms.BuilderData({
                Structure: z ? z.LayoutRegions : null,
                PageRegions: A,
                Mode: "page",
                Editable: false,
                RegionEditable: false,
                MaxCols: 24,
                SiteId: B.options.page.get("SiteId"),
                PageContentArea: true,
                FixedLayout: true,
                IsResourceBoard: true
            });
            B.options.builderData.on("pageregion", function(C) {
                B.options.page.set({
                    PageRegions: C,
                    PendingInd: true
                }, {
                    silent: true
                });
                B.savePage()
            });
            B.options.page.on("change", function() {
                B.updateView()
            })
        },
        disposeData: function() {
            var z = this;
            if (z.options.builderData) {
                z.options.builderData.off();
                z.options.builderData = null
            }
        },
        renderSidebar: function() {
            var A = this,
                z = {};
            A.options.sidebarView = new v.Vs.Sidebar({
                model: A.model,
                builderData: A.options.builderData,
                editMode: A.options.editMode,
                parentView: A
            });
            p3.renderFixedSidebar(A.options.sidebarView, z)
        },
        renderFooter: function() {
            var A = this,
                z = new l.Vs.Footer({
                    model: A.options.page,
                    builderData: A.options.builderData,
                    editMode: A.options.editMode,
                    resourceBoardId: A.model.get("ResourceBoardContainerId")
                });
            A.footerView = z;
            z.on("publish", function() {
                A.updatePending(1)
            }).on("cancel", function() {
                A.updatePending(2)
            }).on("stylemode", function() {
                A.updatePending(2)
            });
            p3.renderFixedFooter(z)
        },
        renderBuilder: function() {
            var A = this,
                z = new l.Vs.Builder({
                    model: A.options.builderData
                });
            p3.rV(z, A.Containers.Workspace, true)
        },
        renderStyler: function() {
            var A = this,
                z = new v.Vs.ViewDetail({
                    model: A.options.model,
                    page: A.options.page,
                    mode: "style"
                });
            p3.rV(z, A.Containers.Workspace, true)
        },
        savePage: function() {
            var z = this;
            z.options.page.save({}, {
                dataParam: {
                    saveStructure: true,
                    returnModel: true
                },
                success: function(A, B) {
                    z.options.builderData.set({
                        PageRegions: A.get("PageRegions")
                    }, {
                        silent: true
                    });
                    z.options.builderData.trigger("save");
                    z.options.page.trigger("change")
                },
                error: function() {
                    p3.displayError("Error saving page")
                }
            })
        },
        updatePending: function(z) {
            var B = this,
                A = new t.Ms.PendingStatus({
                    id: B.options.page.get("PageTaskId"),
                    action: z
                });
            A.save({}, {
                success: function(D, E) {
                    var C = new v.Ms.UpdatePending({
                        resourceBoardContainerId: B.model.get("ResourceBoardContainerId"),
                        acceptPending: z == 1
                    });
                    C.save({}, {
                        success: function(F, G) {
                            v.Us.renderBoardEditDetail(B.model.get("ResourceBoardContainerId"), B.options.editMode)
                        },
                        error: function() {
                            p3.displayError("Error saving board pending status")
                        }
                    })
                },
                error: function() {
                    p3.displayError("Error saving page")
                }
            })
        },
        updateView: function() {
            var B = this,
                z = B.$el.find(".pages-layout-pending-alert"),
                A = B.options.page.get("LastModifyDate");
            if (B.options.page.get("PendingInd") == true) {
                z.html("<i>This version was autosaved " + d.todayAt(A, false) + ".</i><p>You have changed the appearance of this detail page. This version has not been made live.</p>").slideDown()
            } else {
                z.empty().slideUp()
            }
        }
    });
    v.Vs.ViewDetail = Bb.View.extend({
        template: "resourceboard/resourceboard.detail.template.html",
        initialize: function() {
            $("#site-main").addClass("container");
            $("body").removeClass("graniteCountertop");
            this.Containers = {};
            if (this.options.mode == "style") {
                this.styleMode = true
            } else {
                this.styleMode = false
            }
        },
        render: function(z) {
            var A = this;
            $(z).html(A.el);
            p3.fT(A.template, function(F) {
                var E = A.options.page.get("PageRegions")[0].Rows,
                    C, D, B = (p3.Config.uiVersion === 1) ? "span" : "col-md-";
                for (C = 0; C < E.length; C++) {
                    for (D = 0; D < E[C].Columns.length; D++) {
                        E[C].Columns[D].className = B + (E[C].Columns[D].Size / 2);
                        E[C].Columns[D].id = "column_" + C + "_" + D
                    }
                }
                A.$el.html(F({
                    row: E
                }));
                A.renderContent(E)
            })
        },
        renderContent: function(E) {
            var F = this,
                B, C, D, z, A;
            for (B = 0; B < E.length; B++) {
                for (C = 0; C < E[B].Columns.length; C++) {
                    z = E[B].Columns[C];
                    for (D = 0; D < z.ContentBlocks.length; D++) {
                        A = new v.Vs.ContentItem({
                            model: F.model,
                            containerId: z.id,
                            contentPk: z.ContentBlocks[D].ContentPk,
                            contentTypeId: z.ContentBlocks[D].ContentTypeId,
                            contentOptions: z.ContentBlocks[D].Options,
                            styleMode: F.styleMode,
                            row: B,
                            column: C,
                            block: D,
                            page: F.options.page
                        });
                        p3.rV(A, $("#" + z.id), false)
                    }
                }
            }
        }
    });
    v.Vs.ContentItem = Bb.View.extend({
        events: {
            "click .media-cover": "showMediaViewer",
            "click .style-element": "setSelectedElement",
            "click .btn-show-more": "toggleAdditionalItems",
            "click a.btn-pager": "switchImage",
            "click a.faq-link": "toggleFaq",
            "click a.announce-link": "toggleAnnouncement",
            "click a.list-link": "toggleList"
        },
        render: function(C) {
            var V = this,
                L = false,
                K = 0,
                I = "",
                T = false,
                E = "",
                J = "",
                R = "",
                G, U = p3.Data.Context.get("UserInfo").UserId,
                P = true,
                O = false,
                H = "",
                D = false,
                B, S, F, z, A, Q, N = false,
                M = false;
            $(C).append(V.el);
            switch (V.options.contentTypeId) {
                case 405:
                    V.template = "resourceboard/resourceboard.covertitle.template.html";
                    break;
                case 406:
                    V.template = "resourceboard/resourceboard.coverbrief.template.html";
                    break;
                case 404:
                    V.template = "resourceboard/resourceboard.coverimage.template.html";
                    V.model.set("schoolId", p3.Data.SchoolContext.get("SchoolInfo").SchoolId);
                    break;
                case 391:
                    V.template = "resourceboard/resourceboard.header.template.html";
                    if (V.options.contentOptions != null) {
                        I = V.options.contentOptions.HeaderText
                    }
                    break;
                case 408:
                    V.template = "resourceboard/resourceboard.line.template.html";
                    break;
                case 407:
                    V.template = "resourceboard/resourceboard.spacer.template.html";
                    break;
                case 387:
                    V.template = "resourceboard/resourceboard.embed.template.html";
                    if (V.options.contentOptions != null) {
                        I = V.options.contentOptions.HeaderText;
                        R = V.options.contentOptions.EmbedCode
                    }
                    break;
                case 250:
                    V.template = "resourceboard/resourceboard.text.template.html";
                    if (V.options.contentOptions != null) {
                        I = V.options.contentOptions.HeaderText;
                        R = V.options.contentOptions.Text
                    }
                    break;
                case 3:
                    V.template = "resourceboard/resourceboard.download.template.html";
                    if (V.options.contentOptions != null) {
                        K = V.options.contentOptions.ItemCount;
                        if (V.options.contentOptions.HeaderTextOption == "optCategoryName") {
                            T = true
                        } else {
                            I = V.options.contentOptions.HeaderText
                        }
                    }
                    B = new f.Cs.ForResourceBoard({}, {
                        categoryId: V.options.contentPk,
                        itemCount: 0,
                        userId: U
                    });
                    L = true;
                    break;
                case 2:
                    V.template = "resourceboard/resourceboard.link.template.html";
                    if (V.options.contentOptions != null) {
                        K = V.options.contentOptions.ItemCount;
                        if (V.options.contentOptions.HeaderTextOption == "optCategoryName") {
                            T = true
                        } else {
                            I = V.options.contentOptions.HeaderText
                        }
                        switch (V.options.contentOptions.DisplayOption) {
                            case "optImage":
                                P = false;
                                O = true;
                                break;
                            case "optTitleImage":
                                P = true;
                                O = true;
                                break
                        }
                    } else {
                        P = true
                    }
                    B = new m.Cs.ForResourceBoard({}, {
                        categoryId: V.options.contentPk,
                        itemCount: 0,
                        userId: U
                    });
                    L = true;
                    break;
                case 5:
                    S = true;
                    V.template = "resourceboard/resourceboard.event.template.html";
                    if (V.options.contentOptions != null) {
                        K = V.options.contentOptions.ItemCount;
                        if (V.options.contentOptions.HeaderTextOption == "optCategoryName") {
                            T = true
                        } else {
                            I = V.options.contentOptions.HeaderText
                        }
                        if (V.options.contentOptions.ShowOption == "optShowAll") {
                            S = false
                        }
                    }
                    B = new h.Cs.ForResourceBoard({}, {
                        categoryId: V.options.contentPk,
                        itemCount: 0,
                        upcoming: S,
                        userId: U
                    });
                    L = true;
                    break;
                case 31:
                case 165:
                case 167:
                    V.template = "resourceboard/resourceboard.media.template.html";
                    if (V.options.contentOptions != null) {
                        K = V.options.contentOptions.ItemCount;
                        if (V.options.contentOptions.HeaderTextOption == "optCategoryName") {
                            T = true
                        } else {
                            I = V.options.contentOptions.HeaderText
                        }
                        M = V.options.contentOptions.ShowBanner
                    }
                    switch (V.options.contentTypeId) {
                        case 31:
                            E = "photo";
                            J = "p3icon-topicPhoto";
                            break;
                        case 165:
                            E = "audio";
                            J = "p3icon-topicAudio";
                            break;
                        case 167:
                            E = "video";
                            J = "p3icon-topicVideo";
                            break
                    }
                    B = new p.Cs.ForResourceBoard({}, {
                        categoryId: V.options.contentPk,
                        contentId: V.options.contentTypeId,
                        userId: U
                    });
                    L = true;
                    break;
                case 94:
                    V.template = "resourceboard/resourceboard.formslist.template.html";
                    if (V.options.contentOptions != null) {
                        I = V.options.contentOptions.IntroText;
                        if (V.options.contentOptions.formlist.length > 0) {
                            F = new v.Cs.UserForms({}, {
                                formIds: V.options.contentOptions.formlist
                            });
                            F.fetch({
                                async: false,
                                success: function() {
                                    F.each(function(W) {
                                        W.set("form_arg", "pk=" + W.get("form_id"))
                                    });
                                    G = F.toJSON()
                                },
                                error: function() {
                                    p3.displayError("Error loading forms.")
                                }
                            })
                        }
                    }
                    break;
                case 24:
                    V.template = "resourceboard/resourceboard.list.template.html";
                    if (V.options.contentOptions != null) {
                        K = V.options.contentOptions.ItemCount;
                        if (V.options.contentOptions.HeaderTextOption == "optCategoryName") {
                            T = true
                        } else {
                            I = V.options.contentOptions.HeaderText
                        }
                        D = (V.options.contentOptions.DisplayOption == "optExpandable")
                    }
                    B = new n.Cs.ForResourceBoard({}, {
                        categoryId: V.options.contentPk,
                        userId: U
                    });
                    L = true;
                    break;
                case 1:
                    V.template = "resourceboard/resourceboard.text.category.template.html";
                    if (V.options.contentOptions != null) {
                        if (V.options.contentOptions.HeaderTextOption == "optCategoryName") {
                            T = true
                        } else {
                            I = V.options.contentOptions.HeaderText
                        }
                    }
                    B = new y.Ms.ForResourceBoard({
                        categoryId: V.options.contentPk,
                        userId: U
                    });
                    L = true;
                    break;
                case 7:
                    V.template = "resourceboard/resourceboard.faq.template.html";
                    if (V.options.contentOptions != null) {
                        K = V.options.contentOptions.ItemCount;
                        if (V.options.contentOptions.HeaderTextOption == "optCategoryName") {
                            T = true
                        } else {
                            I = V.options.contentOptions.HeaderText
                        }
                    }
                    B = new i.Cs.ForResourceBoard({}, {
                        categoryId: V.options.contentPk
                    });
                    L = true;
                    break;
                case 77:
                    V.template = "resourceboard/resourceboard.pushpage.template.html";
                    if (V.options.contentOptions != null) {
                        K = V.options.contentOptions.ItemCount;
                        if (V.options.contentOptions.HeaderTextOption == "optCategoryName") {
                            T = true
                        } else {
                            I = V.options.contentOptions.HeaderText
                        }
                    }
                    B = new v.Cs.PushpageArchives({}, {
                        templateId: V.options.contentPk
                    });
                    L = true;
                    break;
                case 6:
                    V.template = "resourceboard/resourceboard.news.template.html";
                    if (V.options.contentOptions != null) {
                        K = V.options.contentOptions.ItemCount;
                        if (V.options.contentOptions.HeaderTextOption == "optCategoryName") {
                            T = true
                        } else {
                            I = V.options.contentOptions.HeaderText
                        }
                    }
                    B = new s.Cs.ForResourceBoard({}, {
                        categoryId: V.options.contentPk
                    });
                    L = true;
                    break;
                case 10:
                    V.template = "resourceboard/resourceboard.announcement.template.html";
                    if (V.options.contentOptions != null) {
                        K = V.options.contentOptions.ItemCount;
                        if (V.options.contentOptions.HeaderTextOption == "optCategoryName") {
                            T = true
                        } else {
                            I = V.options.contentOptions.HeaderText
                        }
                    }
                    B = new a.Cs.ForResourceBoard({}, {
                        categoryId: V.options.contentPk
                    });
                    L = true;
                    break
            }
            z = V.getBlock();
            A = "conDefault";
            Q = "";
            N = false;
            if (z.StyleOptions != null) {
                A = z.StyleOptions.Class;
                if (A == "conPrimary") {
                    A += " pri-100-bgc"
                }
                if (A == "conSecondary") {
                    A += " sec-15-bgc"
                }
                if (z.StyleOptions.Font.length) {
                    Q = "font-family:" + z.StyleOptions.Font + ";"
                }
                if (z.StyleOptions.FontSize.length) {
                    switch (z.StyleOptions.FontSize) {
                        case "small":
                            Q += "font-size:13px;";
                            break;
                        case "medium":
                            Q += "font-size:14px;";
                            break;
                        case "large":
                            Q += "font-size:16px;";
                            break
                    }
                }
                N = (z.StyleOptions.ShowIcon)
            }
            if (L) {
                B.fetch({
                    success: function() {
                        p3.fT(V.template, function(aa) {
                            var W = 0,
                                Z = false,
                                X = false,
                                Y;
                            if (V.options.contentTypeId > 1) {
                                B.each(function(ab) {
                                    if (T) {
                                        if (ab.get("ItemData") && ab.get("ItemData").length > 0) {
                                            I = ab.get("ItemData")[0].GroupName
                                        } else {
                                            if (V.options.contentTypeId == 24 || V.options.contentTypeId == 7) {
                                                I = ab.get("CategoryName")
                                            } else {
                                                I = ab.get("GroupName")
                                            }
                                        }
                                    }
                                    if ((V.options.contentTypeId == 2 || V.options.contentTypeId == 3) && ab.get("ItemData").length > 0) {
                                        H = ab.get("ItemData")[0].GroupLongDescription
                                    }
                                    if (K > 0) {
                                        if (V.options.contentTypeId == 2 || V.options.contentTypeId == 3) {
                                            var ac = ab.get("ItemData"),
                                                ad;
                                            if (ac.length > 0) {
                                                for (ad = 0; ad < ac.length; ad++) {
                                                    W += 1;
                                                    if (W > K) {
                                                        if (ad == 0) {
                                                            ab.set("hide", true)
                                                        }
                                                        ac[ad].hide = true;
                                                        Z = true
                                                    }
                                                }
                                            } else {
                                                ab.set("SubCategoryID", 0)
                                            }
                                        } else {
                                            W += 1;
                                            if (W > K) {
                                                ab.set("hide", true);
                                                Z = true
                                            }
                                        }
                                    } else {
                                        if (V.options.contentTypeId == 2 || V.options.contentTypeId == 3) {
                                            if (ab.get("ItemData").length == 0) {
                                                ab.set("SubCategoryID", 0)
                                            }
                                        }
                                    }
                                })
                            } else {
                                if (T) {
                                    I = B.get("Description")
                                }
                                Y = B.get("Photos");
                                X = Y && Y.length > 1
                            }
                            V.$el.html(aa({
                                model: V.model.toJSON(),
                                collection: B.toJSON(),
                                headerText: I,
                                useCategory: T,
                                schoolId: p3.Data.SchoolContext.get("SchoolInfo").SchoolId,
                                contentId: V.options.contentTypeId,
                                folder: E,
                                styleMode: V.options.styleMode,
                                row: V.options.row,
                                column: V.options.column,
                                block: V.options.block,
                                className: A,
                                styleAttributes: Q,
                                showIcon: N,
                                iconClass: J,
                                showMore: Z,
                                showImage: O,
                                showTitle: P,
                                groupDescription: H,
                                pageImages: X,
                                userId: p3.Data.Context.get("UserInfo").UserId,
                                expandable: D,
                                showBanner: M
                            }))
                        })
                    },
                    error: function() {
                        p3.displayError("Error loading resource board content.")
                    }
                })
            } else {
                p3.fT(V.template, function(W) {
                    V.$el.html(W({
                        model: V.model.toJSON(),
                        styleMode: V.options.styleMode,
                        row: V.options.row,
                        column: V.options.column,
                        block: V.options.block,
                        className: A,
                        styleAttributes: Q,
                        showIcon: N,
                        headerText: I,
                        forms: G,
                        text: R
                    }))
                })
            }
        },
        showMediaViewer: function(C) {
            var z = $(C.currentTarget).attr("data-album"),
                B = $(C.currentTarget).attr("data-type"),
                A = "";
            switch (B) {
                case "31":
                    A = "photo";
                    break;
                case "165":
                    A = "audio";
                    break;
                case "167":
                    A = "video";
                    break;
                default:
                    break
            }
            q.Us.showModal(z, A);
            return false
        },
        getBlock: function() {
            var A = this,
                z = A.options.page.get("PageRegions")[0];
            return z.Rows[A.options.row].Columns[A.options.column].ContentBlocks[A.options.block]
        },
        setSelectedElement: function(C) {
            var D = this,
                z = $(C.currentTarget),
                A, B;
            $("#pages-layout-sidebar-help").hide();
            $("#pages-layout-sidebar-styler").show();
            $(".style-element").removeClass("selected");
            z.addClass("selected");
            $(".style-button").removeClass("active");
            $(".btn-font-size").removeClass("active");
            $(".btn-show-icon").removeClass("active");
            A = D.getBlock();
            B = "conNone";
            if (A.StyleOptions != null) {
                B = A.StyleOptions.Class;
                if (A.StyleOptions.Font.length > 0) {
                    $("#font-dropdown").val(A.StyleOptions.Font)
                } else {
                    $("#font-dropdown").prop("selectedIndex", 0)
                }
                switch (A.StyleOptions.FontSize) {
                    case "small":
                        $("#btn-font-small").addClass("active");
                        break;
                    case "medium":
                        $("#btn-font-medium").addClass("active");
                        break;
                    case "large":
                        $("#btn-font-large").addClass("active");
                        break
                }
                if (A.StyleOptions.ShowIcon) {
                    $("#btn-icon-yes").addClass("active")
                } else {
                    $("#btn-icon-no").addClass("active")
                }
            } else {
                $("#font-dropdown").prop("selectedIndex", 0);
                $("#btn-font-small").addClass("active");
                $("#btn-icon-no").addClass("active")
            }
            switch (B) {
                case "conDefault":
                    $("#btnDefault").addClass("active");
                    break;
                case "conPrimary":
                    $("#btnPrimary").addClass("active");
                    break;
                case "conSecondary":
                    $("#btnSecondary").addClass("active");
                    break;
                case "conRed":
                    $("#btnRed").addClass("active");
                    break;
                case "conYellow":
                    $("#btnYellow").addClass("active");
                    break;
                case "conBlue":
                    $("#btnBlue").addClass("active");
                    break;
                case "conNone":
                    $("#btnNone").addClass("active");
                    break
            }
        },
        toggleAdditionalItems: function(D) {
            var A = $(D.currentTarget),
                E = A.data("row"),
                C = A.data("column"),
                B = A.data("block"),
                z = $("div[data-row='" + E + "'][data-column='" + C + "'][data-block='" + B + "']");
            if (A.hasClass("show-data")) {
                A.removeClass("show-data").addClass("hide-data").html("Show Less");
                z.find(".hidden-content").show();
                z.find(".hidden-subcategory").show()
            } else {
                A.removeClass("hide-data").addClass("show-data").html("Show All");
                z.find(".hidden-content").hide();
                z.find(".hidden-subcategory").hide()
            }
        },
        switchImage: function(z) {
            return p3.switchImage(z)
        },
        toggleFaq: function(A) {
            var z = $(A.currentTarget),
                B = z.data("index");
            $("div.faq-answer[data-index='" + B + "']").toggle();
            return false
        },
        toggleAnnouncement: function(A) {
            var z = $(A.currentTarget),
                B = z.data("index");
            $("div.announce-description[data-index='" + B + "']").toggle();
            return false
        },
        toggleList: function(A) {
            var z = $(A.currentTarget),
                B = z.data("index");
            $("div.list-description[data-index='" + B + "']").toggle();
            return false
        }
    });
    v.Vs.Sidebar = Bb.View.extend({
        template: "resourceboard/resourceboard.sidebar.template.html",
        className: "workspace-sidebar",
        events: {
            "click .workspace-sidebar-tab": "tabClicked",
            "click #pages-layout-settings": "showEditSettings",
            "click .style-button": "setSelectedStyle",
            "change #font-dropdown": "setSelectedFont",
            "click .btn-font-size": "setFontSize",
            "click .btn-show-icon": "toggleIcon"
        },
        initialize: function() {
            this.Containers = {}
        },
        render: function(z) {
            var A = this;
            $(z).html(A.el);
            A.loadContentData(function() {
                A.renderTemplate()
            })
        },
        renderTemplate: function() {
            var z = this;
            p3.fT(z.template, function(B) {
                var A = z.getLayoutIcon(z.model.get("LayoutId"));
                z.$el.html(B({
                    model: z.model.toJSON(),
                    layoutIcon: A,
                    content: z.filterContentData(16),
                    elements: z.filterContentData(32),
                    boardElements: z.filterContentData(64)
                }));
                z.selectTab(z.options.editMode);
                z.updateView()
            })
        },
        getLayoutIcon: function(A) {
            var z = "";
            switch (A) {
                case 0:
                    z = "p3icon-2colLeft";
                    break;
                case 1:
                    z = "p3icon-2colRight";
                    break;
                case 2:
                    z = "p3icon-2rowLeft";
                    break;
                case 3:
                    z = "p3icon-2rowRight";
                    break;
                case 4:
                    z = "p3icon-2colSplit";
                    break;
                case 5:
                    z = "p3icon-3col";
                    break
            }
            return z
        },
        tabClicked: function(B) {
            B.preventDefault();
            var D = this,
                z = $(B.currentTarget),
                A = z.data("action"),
                C = x.Us.getUrlById(53119, D.model.get("ResourceBoardContainerId") + "/" + A);
            if (C) {
                p3.router().navigate(C, true)
            }
            return false
        },
        selectTab: function(z) {
            var A = this;
            A.$el.find(".workspace-sidebar-tabs LI.active").removeClass("active");
            $(".workspace-sidebar-tab").removeClass("active");
            A.$el.find(".workspace-sidebar-content > div").hide();
            A.$el.find('.workspace-sidebar-tab[data-action="' + z + '"]').parent().addClass("active");
            A.$el.find('.workspace-sidebar-tab[data-action="' + z + '"]').addClass("active");
            A.$el.find('.workspace-sidebar-content > div[data-id="' + z + '"]').show()
        },
        loadContentData: function(A) {
            var B = this,
                z;
            if (B.options.boardContent) {
                return A()
            }
            z = new v.Cs.ResourceBoardContent();
            z.fetch({
                success: function() {
                    B.options.boardContent = z.toJSON();
                    return A()
                },
                error: function() {
                    p3.displayError("Error loading resource board content blocks.")
                }
            })
        },
        filterContentData: function(C) {
            var D = this,
                A = [],
                z, B;
            if (D.options.boardContent) {
                z = D.options.boardContent;
                _.each(z, function(E) {
                    if (E.ObjectTypeId == C) {
                        B = c.Us.findContentById(E.Id);
                        if (B) {
                            E.Name = E.Id == 1 ? "Text Category" : B.Name;
                            E.IconClass = B.IconClass;
                            A.push(E)
                        }
                    }
                })
            }
            return A
        },
        getElements: function() {
            var z = [];
            z.push({
                Id: 0,
                Name: "Header",
                IconClass: "p3icon-header"
            });
            return z
        },
        getBoardElements: function() {
            var z = [];
            z.push({
                Id: 0,
                Name: "Cover Image",
                IconClass: "p3icon-image"
            });
            return z
        },
        updateView: function() {
            var B = this,
                z, A;
            $("#board-name").html(B.model.get("ShortDescription"));
            $("#layout-icon").removeClass().addClass(B.getLayoutIcon(B.model.get("LayoutId")));
            $("#persona-level-list").children().remove();
            A = B.model.get("PersonaLevels");
            for (z = 0; z < A.length; z++) {
                $("#persona-level-list").append("<li>" + A[z].PersonaLevelDescription + "</li>")
            }
        },
        showEditSettings: function(z) {
            z.preventDefault();
            var B = this,
                A = new v.Vs.ContainerEditView({
                    container: B.model
                });
            p3.rV(A, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            A.on("containerSaved", function(D) {
                B.model.set(D.toJSON(), {
                    silent: true
                });
                B.updateView();
                var C = new t.Ms.Page({
                    Id: 0,
                    PageTaskId: B.model.get("TaskId")
                });
                C.fetch({
                    data: {
                        pendingInd: true
                    },
                    success: function() {
                        B.options.builderData.set("Structure", C.get("SiteLayout").LayoutRegions);
                        B.options.builderData.set("PageRegions", C.get("PageRegions"));
                        var E = new l.Vs.Builder({
                            model: B.options.builderData
                        });
                        B.options.parentView.options.page = C;
                        p3.rV(E, $("#pages-workspace"), true);
                        B.options.parentView.updateView();
                        B.options.parentView.footerView.model.set("PendingInd", C.get("PendingInd"))
                    },
                    error: function() {
                        p3.displayError("Error loading page")
                    }
                })
            });
            return false
        },
        setSelectedStyle: function(B) {
            var D = this,
                z = $(B.currentTarget),
                A = D.getBlockModel(),
                C = new v.Ms.StyleOptions(A.StyleOptions);
            $(".style-button").removeClass("active");
            z.addClass("active");
            $(".style-element.selected").removeClass("conNone conDefault conPrimary conSecondary conRed conBlue conYellow sec-15-bgc pri-100-bgc").addClass(z.children()[0].className);
            C.set("Class", z.children()[0].className);
            A.StyleOptions = C.toJSON();
            D.savePage();
            return false
        },
        setSelectedFont: function(B) {
            var D = this,
                z = $(B.currentTarget),
                A = D.getBlockModel(),
                C = new v.Ms.StyleOptions(A.StyleOptions);
            if (z.prop("selectedIndex") == 0) {
                $(".style-element.selected").css("font-family", "inherit");
                C.set("Font", "")
            } else {
                $(".style-element.selected").css("font-family", z.val());
                C.set("Font", z.val())
            }
            A.StyleOptions = C.toJSON();
            D.savePage()
        },
        setFontSize: function(A) {
            var D = this,
                z = D.getBlockModel(),
                B = new v.Ms.StyleOptions(z.StyleOptions),
                C = "";
            switch (A.currentTarget.id) {
                case "btn-font-small":
                    C = "13px";
                    B.set("FontSize", "small");
                    break;
                case "btn-font-medium":
                    C = "14px";
                    B.set("FontSize", "medium");
                    break;
                case "btn-font-large":
                    B.set("FontSize", "large");
                    C = "16px";
                    break
            }
            $(".style-element.selected").css("font-size", C);
            z.StyleOptions = B.toJSON();
            D.savePage()
        },
        toggleIcon: function(A) {
            var C = this,
                z = C.getBlockModel(),
                B = new v.Ms.StyleOptions(z.StyleOptions);
            if (A.currentTarget.id == "btn-icon-yes") {
                $(".style-element.selected").find("i.channel-icon").show();
                B.set("ShowIcon", true)
            } else {
                $(".style-element.selected").find("i.channel-icon").hide();
                B.set("ShowIcon", false)
            }
            z.StyleOptions = B.toJSON();
            C.savePage()
        },
        getBlockModel: function() {
            var E = this,
                B = E.options.parentView.options.page,
                C = B.get("PageRegions")[0],
                D = $(".style-element.selected").data("row"),
                A = $(".style-element.selected").data("column"),
                z = $(".style-element.selected").data("block");
            return C.Rows[D].Columns[A].ContentBlocks[z]
        },
        savePage: function() {
            var A = this,
                z = A.options.parentView.options.page;
            z.set("PendingInd", true);
            z.save({}, {
                dataParam: {
                    saveStructure: true,
                    returnModel: true
                },
                success: function(B, C) {
                    A.options.builderData.set({
                        PageRegions: B.get("PageRegions")
                    }, {
                        silent: true
                    });
                    A.options.builderData.trigger("save");
                    z.trigger("change")
                },
                error: function() {
                    p3.displayError("Error saving page")
                }
            })
        }
    });
    v.Vs.PriorityEditView = Bb.View.extend({
        template: "resourceboard/resourceboard.priority.template.html",
        events: {
            "click #btnSave": "savePriority",
            "click .move-top-button": "moveToTop"
        },
        render: function(z) {
            var A = this;
            $(z).html(A.el);
            A.renderTemplate()
        },
        renderTemplate: function() {
            var A = this,
                z = new v.Cs.Priorities();
            z.fetch({
                success: function() {
                    z.each(function(B) {
                        switch (B.get("container_type")) {
                            case 2:
                                B.set("systemImage", "/ftpimages/999/podium/libs/p3-cache/img/groupFinder.png");
                                break;
                            case 3:
                                B.set("systemImage", "/ftpimages/999/podium/libs/p3-cache/img/lists.png");
                                break;
                            case 4:
                                B.set("systemImage", "/ftpimages/999/podium/libs/p3-cache/img/reports.png");
                                break;
                            case 5:
                                B.set("systemImage", "/ftpimages/999/podium/libs/p3-cache/img/portal.png");
                                break;
                            case 6:
                                B.set("systemImage", "/ftpimages/999/podium/libs/p3-cache/img/myFiles.png");
                                break;
                            case 7:
                                B.set("systemImage", "/ftpimages/999/podium/libs/p3-cache/img/addAnother.png");
                                break
                        }
                        if (B.get("container_levels")) {
                            B.set("container_levels", B.get("container_levels").replace(/\,/g, ", "))
                        }
                        if (B.get("active_ind") == 1) {
                            B.set("inactiveMessage", "Future Publish Date")
                        }
                        if (B.get("active_ind") == 2) {
                            B.set("inactiveMessage", "Expired")
                        }
                    });
                    p3.fT(A.template, function(B) {
                        A.$el.html(B({
                            priority: z.toJSON()
                        }))
                    });
                    p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.jQueryUI, function() {
                        var B = function(C, D) {
                            D.children().each(function() {
                                $(this).width($(this).width())
                            });
                            return D
                        };
                        window.setTimeout(function() {
                            $(".sortContainer tbody").sortable({
                                items: "tr.postContainer",
                                helper: B
                            }).disableSelection()
                        }, 400)
                    })
                },
                error: function() {
                    p3.displayError("Error loading priorities")
                }
            })
        },
        savePriority: function(z) {
            var D = this,
                C = [],
                B = 0,
                A;
            $("#btnSave").button("loading");
            $(".postContainer").each(function() {
                B += 1;
                C.push({
                    ResourceBoardContainerId: $(this).data("id"),
                    SortOrder: B
                })
            });
            A = new v.Ms.SetPriorities({
                PersonaId: v.Data.Persona,
                SortList: C
            });
            A.save({}, {
                error: function() {
                    p3.showModal(p3.Layout.Containers.Modal, "hide");
                    p3.displayError("Error saving priority")
                },
                success: function() {
                    D.trigger("priorityChanged");
                    p3.showModal(p3.Layout.Containers.Modal, "hide")
                }
            })
        },
        moveToTop: function(B) {
            var A = $(B.currentTarget),
                z = A.parentsUntil(1, "tr"),
                D = z.data("id"),
                C = z.html();
            z.remove();
            $(".sortContainer tr:first").after('<tr class="postContainer sort-hover" data-id="' + D + '">' + C + "</tr>")
        }
    });
    v.Us.renderBoardEditDetail = function(A, B) {
        var z = new v.Ms.ResourceBoardContainer({
            ResourceBoardContainerId: A
        });
        z.fetch({
            data: {
                containerId: A
            },
            success: function() {
                var C = new t.Ms.Page({
                    Id: 0,
                    PageTaskId: z.get("TaskId")
                });
                C.fetch({
                    data: {
                        pendingInd: true
                    },
                    success: function() {
                        p3.renderMainPage(new v.Vs.EditDetail({
                            model: z,
                            editMode: B,
                            page: C
                        }), true)
                    },
                    error: function() {
                        p3.displayError("Error loading page")
                    }
                })
            },
            error: function() {
                p3.displayError("Error loading resource board")
            }
        })
    };
    v.Us.renderBoardDetail = function(A, B) {
        var z = new v.Ms.ResourceBoardContainerGet({
            ResourceBoardContainerId: A
        });
        z.fetch({
            data: {
                containerId: A
            },
            success: function() {
                var C = new t.Ms.PageGet({
                    Id: 0,
                    PageTaskId: z.get("TaskId")
                });
                C.fetch({
                    data: {
                        pendingInd: B
                    },
                    success: function() {
                        p3.renderMainPage(new v.Vs.ViewDetail({
                            model: z,
                            page: C,
                            mode: "view"
                        }))
                    },
                    error: function() {
                        p3.displayError("Error loading page")
                    }
                })
            },
            error: function() {
                p3.displayError("Error loading resource board")
            }
        })
    };
    v.Us.getLevels = function(A, z) {
        if (v.Data.Levels == null) {
            v.Data.Levels = new v.Cs.SchoolLevel({}, {
                editMode: A
            });
            v.Data.Levels.fetch({
                async: z,
                error: function() {
                    p3.displayError("Error loading levels")
                }
            })
        }
    };
    v.Us.initializeReportInput = function() {
        $.ajax({
            url: aP + "reportlist/?format=json&reportType=0",
            cache: false,
            success: function(z) {
                $("#report").tokenInput(z, {
                    minChars: 2,
                    searchDelay: 100,
                    preventDuplicates: true,
                    animateDropdown: false,
                    hintText: "Search Reports",
                    classes: {
                        tokenList: "token-input-list",
                        dropdown: "token-input-dropdown"
                    },
                    resultsFormatter: function(A) {
                        var B = "";
                        B += A.name;
                        return "<li>" + B + "</li>"
                    },
                    onAdd: function(A) {
                        u.Us.reportLoad(p3.Data.ReportList)
                    }
                })
            },
            complete: function(z, A) {
                u.PrepopulateData = null
            }
        })
    };
    v.Us.initializeListInput = function() {
        $.ajax({
            url: aP + "datadirect/ListGet/?format=json",
            cache: false,
            success: function(z) {
                $("#lists").tokenInput(z, {
                    minChars: 2,
                    searchDelay: 100,
                    preventDuplicates: true,
                    animateDropdown: false,
                    hintText: "Search Lists",
                    classes: {
                        tokenList: "token-input-list",
                        dropdown: "token-input-dropdown"
                    },
                    resultsFormatter: function(A) {
                        var B = "";
                        B += A.name;
                        return "<li>" + B + "</li>"
                    },
                    onAdd: function(A) {
                        o.Us.ListsLoad(p3.Data.List)
                    }
                })
            },
            complete: function(z, A) {
                o.PrepopulateData = null
            }
        })
    };
    v.Us.initializeGroupInput = function() {
        var A = new j.Cs.GroupsByYear(),
            z, B = "GroupFinder/groupfinder.item.template.html",
            C;
        p3.fT(B, function(D) {
            A.fetch({
                data: {
                    schoolYearLabel: v.Data.CurrentYear
                },
                success: function(E) {
                    if (v.Data.CurrentMode === "current") {
                        z = new j.Cs.GroupsByYear();
                        E.each(function(F) {
                            if (F.get("current_ind")) {
                                z.push(F)
                            }
                        })
                    } else {
                        z = E
                    }
                    $("#group-finder").tokenInput(z.toJSON(), {
                        minChars: 2,
                        searchDelay: 100,
                        preventDuplicates: true,
                        animateDropdown: false,
                        hintText: "Type a Group Name",
                        propertyToSearch: "group_name",
                        classes: {
                            tokenList: "token-input-list group-list",
                            dropdown: "token-input-dropdown"
                        },
                        resultsFormatter: function(F) {
                            var G = "",
                                H = false;
                            if ($(".token-input-dropdown:visible li").length === 0) {
                                C = -1
                            }
                            if (F.association_id !== C) {
                                H = true;
                                C = F.association_id
                            }
                            G += D({
                                item: F,
                                resourceBoard: true,
                                showHeader: H
                            });
                            return "<li>" + G + "</li>"
                        },
                        onAdd: function(F) {
                            $("li.token-input-token").remove();
                            j.Us.accessGroupPage(F.lead_pk, F.association_id)
                        }
                    })
                },
                error: function() {
                    p3.displayError("Error loading groups")
                }
            })
        })
    };
    v.Us.getPages = function(A, B) {
        var z;
        if (!B) {
            z = A.filter(function(C) {
                return C.get("ParentTaskId") == null
            })
        } else {
            z = A.filter(function(C) {
                return C.get("ParentTaskId") == B
            })
        }
        return new x.Cs.Tasks(z)
    };
    v.Us.getPersonaLevels = function(D) {
        v.Us.getLevels(true, false);
        var C = v.Data.Levels.length > 0,
            B = [],
            A, z;
        if (D) {
            A = v.Data.Levels
        } else {
            A = v.Data.FilterLevels
        }
        if (C) {
            B.push({
                persona: 12,
                LevelId: -1,
                LevelDescription: "Alum",
                Selected: v.Data.Persona == 12
            });
            A.each(function(E) {
                B.push({
                    persona: 3,
                    LevelId: E.get("DdId"),
                    LevelDescription: "Faculty - " + E.get("DdDescription"),
                    Selected: v.Data.Persona == 3 && E.get("Selected")
                })
            });
            B.push({
                persona: 11,
                LevelId: -1,
                LevelDescription: "Friend",
                Selected: v.Data.Persona == 11
            });
            A.each(function(E) {
                B.push({
                    persona: 1,
                    LevelId: E.get("DdId"),
                    LevelDescription: "Parent - " + E.get("DdDescription"),
                    Selected: v.Data.Persona == 1 && E.get("Selected")
                })
            });
            A.each(function(E) {
                B.push({
                    persona: 2,
                    LevelId: E.get("DdId"),
                    LevelDescription: "Student - " + E.get("DdDescription"),
                    Selected: v.Data.Persona == 2 && E.get("Selected")
                })
            })
        } else {
            z = A.models[0].get("DdId");
            B.push({
                persona: 12,
                LevelId: z,
                LevelDescription: "Alum",
                Selected: v.Data.Persona == 12
            });
            B.push({
                persona: 3,
                LevelId: z,
                LevelDescription: "Faculty",
                Selected: v.Data.Persona == 3
            });
            B.push({
                persona: 11,
                LevelId: z,
                LevelDescription: "Friend",
                Selected: v.Data.Persona == 11
            });
            B.push({
                persona: 1,
                LevelId: z,
                LevelDescription: "Parent",
                Selected: v.Data.Persona == 1
            });
            B.push({
                persona: 2,
                LevelId: z,
                LevelDescription: "Student",
                Selected: v.Data.Persona == 2
            })
        }
        return B
    };
    Hb.registerHelper("getUserControls", function(z, G) {
        var F = '<div style="margin:0px 20px 15px 15px;height:',
            D, C, B, H, A, E;
        switch (z) {
            case 2:
                F += '75;"><select id="group-finder-dropdown" style="width:100%;">';
                v.Data.ClassYears.each(function(I) {
                    if (I.get("Current")) {
                        F += '<option data-mode="current" data-label="' + I.get("Id") + '" value="' + I.get("Id") + '"';
                        if (I.get("Id") == v.Data.CurrentYear && v.Data.CurrentMode === "current") {
                            F += " selected"
                        }
                        F += ">" + I.get("Id") + j.Data.yearSuffixCurrent + "</option>";
                        F += '<option data-mode="all" data-label="' + I.get("Id") + '" value="' + I.get("Id") + '"';
                        if (I.get("Id") == v.Data.CurrentYear && v.Data.CurrentMode === "all") {
                            F += " selected"
                        }
                        F += ">" + I.get("Id") + j.Data.yearSuffixAll + "</option>"
                    } else {
                        F += '<option data-mode="none" data-label="' + I.get("Id") + '" value="' + I.get("Id") + '"';
                        if (I.get("Id") == v.Data.CurrentYear) {
                            F += " selected"
                        }
                        F += ">" + I.get("Id") + j.Data.yearSuffix + "</option>"
                    }
                });
                F += "</select>";
                F += '<div id="group-finder"></div>';
                p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.TokenInput, v.Us.initializeGroupInput);
                break;
            case 3:
                F += '30;"><div id="lists"></div>';
                p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.TokenInput, v.Us.initializeReportInput);
                break;
            case 4:
                F += '30;"><div id="report"></div>';
                p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.TokenInput, v.Us.initializeListInput);
                break;
            case 5:
                D = p3.Data.Context.getAllPortals();
                F += '115;"><select id="portal-drop-down">';
                F += '<option value="0">-- Select A Portal --</option>';
                for (A = 0; A < D.length; A++) {
                    F += '<option value="' + D[A].TaskId + '">' + D[A].Description + "</option>"
                }
                F += "</select>";
                F += '<h3 style="margin: 10px 0px 5px 0px">Private Pages</h3>';
                C = p3.Data.Context.getPrivatePages();
                B = new x.Cs.Tasks(C);
                H = v.Us.getPages(B);
                H.each(function(I) {
                    I.set("childPages", v.Us.getPages(B, I.get("TaskId")));
                    if (I.get("childPages").length > 0) {
                        I.get("childPages").each(function(J) {
                            J.set("childPages", v.Us.getPages(B, J.get("TaskId")))
                        })
                    }
                });
                C = H.toJSON();
                F += '<select id="page-drop-down">';
                F += '<option value="0">-- Select A Page --</option>';
                E = function(I) {
                    F += "<option";
                    if (I.PageUrl) {
                        F += ' data-url="' + I.PageUrl + '"'
                    }
                    F += ' value="' + I.get("TaskId") + '">&nbsp;&nbsp;&nbsp;&nbsp;' + I.get("Description") + "</option>";
                    if (I.get("childPages").length > 0) {
                        I.get("childPages").each(function(J) {
                            F += "<option";
                            if (J.PageUrl) {
                                F += ' data-url="' + J.PageUrl + '"'
                            }
                            F += ' value="' + J.get("TaskId") + '">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' + J.get("Description") + "</option>"
                        })
                    }
                };
                for (A = 0; A < C.length; A++) {
                    if (C[A].TaskTypeId == 2) {
                        F += "<option";
                        if (C[A].PageUrl) {
                            F += ' data-url="' + C[A].PageUrl + '"'
                        }
                        F += ' value="' + C[A].TaskId + '">' + C[A].Description + "</option>";
                        if (C[A].childPages.length > 0) {
                            C[A].childPages.each(E)
                        }
                    }
                }
                F += "</select>";
                break;
            case 6:
                break;
            case 7:
                if (G.showApplyLink) {
                    F += '30;"><a href="#" id="application">Begin Application</a>'
                } else {
                    F += '30;">Currently there are no active applications.'
                }
                break
        }
        F += "</div>";
        return new Hb.SafeString(F)
    });
    p3.router().route("resourceboards", "resourceboards", function() {
        p3.setTitle("Resource Boards");
        p3.renderMainPage(new v.Vs.ResourceBoards({
            editMode: true,
            header: "Resource Boards"
        }))
    });
    p3.router().route("resourceboard", "resourceboard", function() {
        p3.setTitle("Resource Board");
        p3.renderMainPage(new v.Vs.ResourceBoards({
            editMode: false,
            header: ""
        }))
    });
    p3.router().route("resourceboarddetailedit/:id(/:mode)", "resourceboarddetailedit", function(z, A) {
        p3.setTitle("Edit Resource Board");
        v.Us.renderBoardEditDetail(z, A)
    });
    p3.router().route("resourceboarddetail/:id(/:mode)", "resourceboarddetail", function(z, A) {
        p3.setTitle("Resource Board");
        var B = false;
        if (A === "pending") {
            B = true
        }
        v.Us.renderBoardDetail(z, B)
    })
}(p3.module("lms/resourceboard")));
(function(i) {
    var j = p3.module("shared/task"),
        f = p3.module("shared/message"),
        h = p3.module("report"),
        g = p3.module("shared/profile"),
        c = p3.Us.Culture,
        e = p3.module("LMS/groupPageEdit"),
        a = p3.module("LMS/Shared/AssignmentTools"),
        d = p3.module("shared/datepicker");
    i.Ms.Student = Bbm.extend({
        idAttribute: "Id"
    });
    i.Cs.Student = Bbc.extend({
        model: i.Ms.Student,
        initialize: function(k, l) {
            this.sectionId = l.sectionId || 0;
            this.leadSectionId = l.leadSectionId || 0
        },
        url: function() {
            var k = this.sectionId;
            if (i.Data.AssociationId === 3) {
                k = this.leadSectionId
            }
            return aP + "datadirect/sectionrosterget/" + k + "/?format=json"
        }
    });
    i.Ms.LearningProfileActiveFormsByStudent = Bbm.extend({
        idAttribute: "Id",
        url: function() {
            return aP + "datadirect/LearningProfileActiveFormsByStudent/"
        }
    });
    i.Cs.LearningProfileActiveFormsByStudent = Bbc.extend({
        model: i.Ms.LearningProfileActiveFormsByStudent,
        url: function() {
            return aP + "datadirect/LearningProfileActiveFormsByStudent/?format=json"
        }
    });
    i.Ms.Relationship = Bbm.extend({
        idAttribute: "Id"
    });
    i.Cs.Relationship = Bbc.extend({
        model: i.Ms.Relationship,
        initialize: function(k, l) {
            this.studentId = l.studentId || 0
        },
        url: function() {
            return aP + "datadirect/studentrelationshipsget/" + this.studentId + "/?format=json"
        }
    });
    i.Cs.ManageMembers = Bbc.extend({
        url: "datadirect/managerosterget",
        getOwners: function() {
            return new Bbc(this.filter(function(k) {
                return k.get("owner_ind") === 1
            }))
        },
        getMembers: function() {
            return new Bbc(this.filter(function(k) {
                return k.get("owner_ind") !== 1
            }))
        }
    });
    i.Cs.FacultyRoles = Bbc.extend({
        url: "datadirect/facultyroleget"
    });
    i.Cs.GroupOwnerRoles = Bbc.extend({
        url: "datadirect/GroupOwnerRoleGet"
    });
    i.Ms.ManagedRoster = Bbm.extend({
        url: "roster/managesave"
    });
    i.Cs.Rooms = Bbc.extend({
        url: "datadirect/RoomsGet"
    });
    i.Cs.SectionTerms = Bbc.extend({
        url: "academics/SectionTermGet"
    });
    i.Ms.ConnectEE = Bbm.extend({
        url: function() {
            return aP + "datadirect/EEConnectEEAttendanceFlag/"
        }
    });
    i.Us.MessageType = {
        Both: 0,
        Parents: 1,
        Students: 2
    };
    i.Us.GroupTypes = {
        Academics: {
            id: 1,
            memberEdit: 2611,
            ownerEdit: 2568
        },
        Athletics: {
            id: 2,
            memberEdit: 1209,
            ownerEdit: 1305
        },
        Communities: {
            id: 3,
            memberEdit: -1,
            ownerEdit: 3002
        },
        Activities: {
            id: 8,
            memberEdit: 23123,
            ownerEdit: 23127
        },
        Advisories: {
            id: 9,
            memberEdit: 23082,
            ownerEdit: 23086
        },
        Dorms: {
            id: 7,
            memberEdit: 23098,
            ownerEdit: 23102
        }
    };
    i.Us.ComposeUserMessage = function(l, k, n) {
        var o = [],
            m;
        if (k) {
            if (l.length > 0) {
                f.Us.composeMessageOrEmail(l, undefined, n)
            }
        } else {
            if (l && l instanceof Array) {
                for (m = 0; m < l.length; m++) {
                    o.push("12_" + l[m] + "_0")
                }
            } else {
                if (typeof l === "number") {
                    o.push("12_" + l + "_0")
                } else {
                    return
                }
            }
            if (o.length > 0) {
                f.Us.composeMessageOrEmail(o, undefined, n)
            }
        }
    };
    i.Data = {};
    i.Data.CurrentRoster = undefined;
    i.Data.AssociationId = 1;
    i.Data.DormSort = "userSort";
    i.Data.DormSortDesc = false;
    i.Data.RoomsNumeric = false;

    function b(o) {
        var k = o.get("allergies"),
            l = o.get("conditions"),
            m = "",
            n = o.get("medications");
        if (k) {
            m = "Allergic to: " + k
        }
        if (l) {
            if (m) {
                m += "<br />"
            }
            m += "Condition(s): " + l
        }
        if (n) {
            if (m) {
                m += "<br />"
            }
            m += "Medication(s): " + n
        }
        o.set("medicalSummary", m)
    }
    i.Vs.RosterView = Bb.View.extend({
        template: "roster/roster.template.html",
        events: {
            "click .user-relationships-initial": "displayRelationships",
            "click .user-relationships-expanded": "collapseRelationships",
            "click .user-relationships-collapsed": "expandRelationships",
            "click .send-message": "sendMessage",
            "doSearch #RosterCardContainer": "renderCards"
        },
        renderTemplate: function() {
            var k = this;
            k.collection.fetch({
                success: function(l) {
                    var n = k.getReports(),
                        m;
                    i.Data.CurrentRoster = l;
                    m = k.collection.find(function(o) {
                        return o.get("Id") === p3.Data.Context.get("UserInfo").UserId
                    });
                    p3.fT(k.template, function(o) {
                        k.$el.html(o({
                            isOwner: k.options.isOwner,
                            associationId: k.options.associationId,
                            roster: k.collection.toJSON(),
                            report: n.toJSON(),
                            haveReports: n.length > 0,
                            leadSectionId: k.options.leadSectionId,
                            hasComposeAccess: (f.Us.hasComposeAccess() && (p3.Data.SchoolContext.get("SchoolInfo").BulkMessageEnabled || p3.Data.SchoolContext.get("SchoolInfo").BulkEmailEnabled)),
                            isTeacher: p3.Data.Context.getSelectedPersona().Id == 3 || p3.Data.Context.getSelectedPersona().Id == 5,
                            isCommunityGroup: k.options.associationId === 3 && m !== undefined,
                            memberCount: (k.collection.length)
                        }));
                        if (p3.Config.uiVersion < 3) {
                            k.Containers.rosterReport = k.$("#roster-reports")
                        }
                        p3.rV(new i.Vs.rosterReport({
                            collection: k.collection,
                            reports: n
                        }), k.Containers.rosterReport, true)
                    });
                    setTimeout(function() {
                        $(".btn").tooltip();
                        k.renderCards()
                    }, 200)
                },
                error: function() {
                    p3.displayError("Error loading roster")
                }
            })
        },
        initialize: function() {
            var k = new i.Cs.Student({}, {
                sectionId: this.options.sectionId,
                leadSectionId: this.options.leadSectionId
            });
            this.collection = k;
            if (typeof this.options.associationId === "number") {
                i.Data.AssociationId = this.options.associationId
            } else {
                i.Data.AssociationId = 1
            }
            this.collection.comparator = function(l, o) {
                var m = l.get("teacherType"),
                    p = o.get("teacherType"),
                    n;
                if (m !== null && p === null) {
                    n = -1
                } else {
                    if (p !== null && m === null) {
                        n = 1
                    } else {
                        n = l.get("lastName").localeCompare(o.get("lastName"))
                    }
                }
                return n
            };
            this.collection.on("reset", this.renderCards, this)
        },
        dispose: function() {
            $(".tooltip").remove();
            i.Data.AssociationId = 0;
            this.collection.off("reset", this.renderCards)
        },
        render: function(l) {
            var m = this,
                k = function() {
                    m.fetchMissingAssignmentData(l)
                };
            m.Containers = {};
            h.loadReportList2(k, k)
        },
        fetchMissingAssignmentData: function(k) {
            var n = this,
                m = p3.Data.Context.getSelectedPersona().Id,
                l;
            n.missingAssignmentInd = false;
            if (m === 3 && n.options.associationId === 9 && n.options.isOwner) {
                l = new a.Ms.AdvisorMissingAssignmentCheck();
                l.fetch({
                    data: {
                        id: n.options.leadSectionId
                    },
                    success: function() {
                        n.missingAssignmentInd = l.hasMissingAssignments();
                        n.rV(k)
                    },
                    error: function() {
                        p3.displayError("Error loading missing assignment information");
                        n.missingAssignmentInd = true;
                        n.rV(k)
                    }
                })
            } else {
                n.rV(k)
            }
        },
        rV: function(k) {
            var l = this;
            if (this.options.enableSearch) {
                this.content = new e.Cs.Content({}, {
                    leadSectionId: l.options.leadSectionId
                });
                this.content.fetch({
                    success: function(m) {
                        var o = m.find(function(p) {
                                return p.get("ContentId") == 434
                            }),
                            n = l.collection.find(function(p) {
                                return p.get("Id") === p3.Data.Context.get("UserInfo").UserId
                            });
                        p3.rV(new i.Vs.RosterSearchView({
                            collection: l.collection,
                            sectionId: l.options.sectionId,
                            isOwner: l.options.isOwner,
                            durationId: l.options.durationId,
                            editAccess: o !== undefined ? o.get("EditorAccess") : false,
                            buildingId: l.options.buildingId,
                            missingAssignmentInd: l.missingAssignmentInd,
                            associationId: l.options.associationId,
                            leadSectionId: l.options.leadSectionId,
                            hasComposeAccess: (f.Us.hasComposeAccess() && (p3.Data.SchoolContext.get("SchoolInfo").BulkMessageEnabled || p3.Data.SchoolContext.get("SchoolInfo").BulkEmailEnabled)),
                            isTeacher: p3.Data.Context.getSelectedPersona().Id == 3 || p3.Data.Context.getSelectedPersona().Id == 5,
                            isCommunityGroup: l.options.associationId === 3 && n !== undefined,
                            viewContainers: l.Containers
                        }), k, false);
                        $(k).append(l.el);
                        p3.loadingIcon(l.el);
                        if ((p3.Data.Context.findByTaskId(53344)) && (p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.CONNECTEE)) && (p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.ATTENDANCELITE))) {
                            new i.Ms.ConnectEE().fetch({
                                success: function(p, q) {
                                    if (q.use_onc_attendance === undefined) {
                                        l.options.UseFAWebAtt = false
                                    } else {
                                        l.options.UseFAWebAtt = (parseInt(q.use_onc_attendance, 10) === 1) ? true : false
                                    }
                                    l.renderTemplate()
                                }
                            })
                        } else {
                            l.renderTemplate()
                        }
                    }
                })
            } else {
                $(k).append(this.el);
                p3.loadingIcon(this.el);
                l.renderTemplate()
            }
        },
        renderCards: function() {
            if (i.Data.AssociationId === i.Us.GroupTypes.Dorms.id) {
                this.renderDormRoster()
            } else {
                var o = this,
                    l = $("#RosterCardContainer"),
                    k, n = o.collection.searchTerm,
                    m = 0;
                if (l.length > 0) {
                    l.html("");
                    o.collection.each(function(q) {
                        var p = q.get("firstName") || "",
                            s = q.get("nickName") || "",
                            r = q.get("lastName") || "";
                        if (n !== undefined && (p.toLowerCase().indexOf(n.toLowerCase()) === -1 && r.toLowerCase().indexOf(n.toLowerCase()) === -1 && s.toLowerCase().indexOf(n.toLowerCase()) === -1)) {
                            return
                        }
                        if (m++ % 3 === 0) {
                            k = $("<div>").addClass("row");
                            l.append(k)
                        }
                        p3.rV(new i.Vs.Card({
                            model: q,
                            isOwner: o.options.isOwner,
                            associationId: o.options.associationId,
                            disableLearningProfiles: o.options.disableLearningProfiles
                        }), k, false)
                    });
                    if (m === 0) {
                        l.append($("<div>").html("No results found."))
                    }
                }
            }
        },
        renderDormRoster: function() {
            var q = this,
                o = q.collection.searchTerm,
                n = [],
                m = [],
                l = 0,
                p, k;
            i.Data.RoomsNumeric = true;
            q.collection.each(function(t) {
                var r = t.get("firstName") || "",
                    w = t.get("nickName") || "",
                    v = t.get("lastName") || "",
                    u, x, s, y;
                if (o === undefined || r.toLowerCase().indexOf(o.toLowerCase()) > -1 || v.toLowerCase().indexOf(o.toLowerCase()) > -1 || w.toLowerCase().indexOf(o.toLowerCase()) > -1) {
                    if (t.get("teacherType") && t.get("teacherType").length > 0) {
                        l += 1;
                        if (l == 1 || (l - 1) % 3 == 0) {
                            p = true
                        } else {
                            p = false
                        }
                        if (l > 1 && l % 3 == 0) {
                            k = true
                        } else {
                            k = false
                        }
                        m.push({
                            ownerType: t.get("teacherType"),
                            name: t.get("name"),
                            id: t.get("Id"),
                            photo: t.get("userThumb"),
                            startRow: p,
                            endRow: k
                        })
                    } else {
                        u = "";
                        x = p3.Config.FtpImagePath + "user/" + t.get("userThumb");
                        s = typeof t.get("gradYear") === "string" ? t.get("gradYear").substring(2, 4) : undefined;
                        y = "";
                        if (!t.get("roomName")) {
                            t.set("room", t.get("roomNumber"));
                            t.set("roomSort", t.get("roomNumber"))
                        } else {
                            if (t.get("roomName") !== t.get("roomNumber")) {
                                t.set("room", t.get("roomNumber") + " " + t.get("roomName"));
                                t.set("roomSort", t.get("roomName"))
                            } else {
                                t.set("room", t.get("roomName"));
                                t.set("roomSort", t.get("roomName"))
                            }
                        }
                        if (!t.get("roomNumber") || t.get("roomNumber").length === 0 || isNaN(t.get("roomNumber"))) {
                            i.Data.RoomsNumeric = false
                        }
                        if (t.get("boardingOrDay") === "B") {
                            t.set("boarding", "Boarding")
                        } else {
                            t.set("boarding", "Day")
                        }
                        t.set("userSort", v + "," + r);
                        if (t.get("NumForms") == 1) {
                            y = j.Us.getUrlById(1691, "pk=393&__pd=gm_fv&ext=pdf&sid=" + t.get("Id") + "&fiid=" + t.get("FormInstanceId"));
                            u = '<a target="_blank" href="' + y + '" rel="tooltip" class="btn btn-default pull-left" data-original-title="Profile: ' + t.get("FormName") + '" style="margin-right:5px;"> <i class="p3icon-learningProfile"></i></a>'
                        }
                        if (t.get("NumForms") > 1) {
                            u = '<span id="LP_' + t.get("Id") + '"></span>';
                            i.Us.LearningProfileButton(t.toJSON(), 5)
                        }
                        if (p3.Data.Context.findByTaskId(53394)) {
                            b(t)
                        }
                        t.set({
                            learningProfile: q.options.disableLearningProfiles ? "" : u,
                            profilePicture: x,
                            gYear: s
                        });
                        n.push(t.toJSON())
                    }
                }
            });
            if (m.length === 0 && n.length === 0) {
                $("#RosterCardContainer").html("No results found.")
            } else {
                if (m.length > 0) {
                    m[m.length - 1].endRow = true
                }
                p3.rV(new i.Vs.DormRoster({
                    residents: n,
                    owners: m,
                    isOwner: q.options.isOwner,
                    associationId: q.options.associationId,
                    disableLearningProfiles: q.options.disableLearningProfiles
                }), $("#RosterCardContainer"), true)
            }
        },
        displayRelationships: function(k) {
            var m = k.target.hash.substring(1),
                l = new i.Cs.Relationship({}, {
                    studentId: m
                });
            l.fetch({
                success: function() {
                    var n = [m],
                        r = (p3.Config.uiVersion === 3),
                        q = '<table class="table table-striped table-condensed well" style="margin:0px 0px 0px 0px">',
                        o = "",
                        p;
                    if (r) {
                        q = '<table class="table table-condensed" style="margin:0px 0px 0px 0px">'
                    }
                    l.each(function(s) {
                        q += '<tr><td><p style="margin-top:5px">';
                        q += s.get("firstName");
                        q += " ";
                        q += s.get("lastName");
                        q += " (";
                        q += s.get("relationship");
                        if (s.get("email")) {
                            q += ')<br><a href="mailto:';
                            q += s.get("email");
                            q += '">';
                            q += s.get("email");
                            q += "</a></p></td><td>"
                        } else {
                            q += ")</p></td><td>"
                        }
                        if (f.Us.hasComposeAccess() && p3.Data.SchoolContext.get("SchoolInfo").IndividualMessageEnabled && (p3.Data.Context.getSelectedPersona().Id !== 2 || (p3.Data.Context.getSelectedPersona().Id === 2 && m == p3.Data.Context.get("UserInfo").UserId))) {
                            q += '<a class="btn btn-default pull-right send-message" href="#" rel="tooltip" data-original-title="Send Message" data-user-id="';
                            q += $.trim(s.get("Id"));
                            q += '"> <i class="p3icon-message"></i></a>'
                        }
                        if (s.get("publishPage")) {
                            q += '<a href="#profile/' + s.get("Id") + '/contactcard" class="btn btn-default  pull-right" style="margin-right:5px" rel="tooltip" data-original-title="Contact Card"><i class="p3icon-contactCard"></i></a>'
                        }
                        q += "</td></tr>";
                        n.push(s.get("Id"))
                    });
                    for (p = 0; p < n.length; p++) {
                        if (o.length > 0) {
                            o += ","
                        }
                        o += n[p]
                    }
                    if (f.Us.hasComposeAccess() && p3.Data.SchoolContext.get("SchoolInfo").IndividualMessageEnabled && (p3.Data.Context.getSelectedPersona().Id !== 2 || (p3.Data.Context.getSelectedPersona().Id === 2 && m == p3.Data.Context.get("UserInfo").UserId))) {
                        if (r) {
                            q += '<tr class="message-all-row"><td>&nbsp;</td><td><a href="#" class="btn btn-default pull-right send-message" data-user-id="' + o + '"><i class="p3icon-message"></i> Message All</a></td></tr>'
                        } else {
                            q += '<tr class="message-all-row"><td>&nbsp;</td><td><a href="#" class="btn btn-default pull-right send-message" data-user-id="' + o + '"><h4><i class="p3icon-message"></i> Message All</h4></a></td></tr>'
                        }
                    }
                    q += "</table>";
                    $("#relate_region_" + m).html(q);
                    $("#relate_region_" + m).slideDown();
                    $(k.target).removeClass("user-relationships-initial").addClass("user-relationships-expanded");
                    $(".btn").tooltip()
                },
                error: function() {
                    p3.displayError("Error loading relationships")
                }
            });
            return false
        },
        expandRelationships: function(k) {
            var l = k.target.hash.substring(1);
            $(k.target).removeClass("user-relationships-collapsed").addClass("user-relationships-expanded");
            $("#relate_region_" + l).slideDown();
            return false
        },
        collapseRelationships: function(k) {
            var l = k.target.hash.substring(1);
            $(k.target).removeClass("user-relationships-expanded").addClass("user-relationships-collapsed");
            $("#relate_region_" + l).slideUp();
            return false
        },
        sendMessage: function(k) {
            i.Us.SendMessage(k, this);
            return false
        },
        getReports: function() {
            var m = this,
                l = new h.Cs.ReportList(),
                k, n;
            l.remove(l.at(0));
            if (h.hasAccessToReportId(431, true)) {
                n = j.Us.getUrlById(1691, "__pd=gm_fv&pk=431&ext=vw&opk=" + m.options.sectionId);
                k = new h.Ms.ReportList({
                    ReportName: "Comments by Section",
                    Link: n
                });
                l.add(k)
            }
            if (h.hasAccessToReportId(194, true)) {
                n = j.Us.getUrlById(1691, "__pd=gm_fv&pk=194&ext=vw&o_pk=" + m.options.sectionId);
                k = new h.Ms.ReportList({
                    ReportName: "Course Roster",
                    Link: n
                });
                l.add(k)
            }
            if (h.hasAccessToReportId(373, true)) {
                n = j.Us.getUrlById(1691, "__pd=gm_fv&pk=373&ext=vw&o_pk=" + m.options.sectionId);
                k = new h.Ms.ReportList({
                    ReportName: "Emergency Contacts",
                    Link: n
                });
                l.add(k)
            }
            if (h.hasAccessToReportId(401, true)) {
                n = j.Us.getUrlById(1691, "__pd=gm_fv&pk=401&ext=pdf&sid=" + m.options.sectionId);
                k = new h.Ms.ReportList({
                    ReportName: "Learning Profiles",
                    Link: n
                });
                l.add(k)
            }
            if (h.hasAccessToReportId(319, true)) {
                n = j.Us.getUrlById(1691, "__pd=gm_fv&pk=319&ext=vw&o_pk=" + m.options.sectionId);
                k = new h.Ms.ReportList({
                    ReportName: "Roster Block Schedule",
                    Link: n
                });
                l.add(k)
            }
            if (h.hasAccessToReportId(226, true)) {
                n = j.Us.getUrlById(1691, "__pd=gm_fv&pk=226&ext=vw&o_pk=|" + m.options.durationId + "|" + m.options.sectionId + "|1|");
                k = new h.Ms.ReportList({
                    ReportName: "Roster Enrollments",
                    Link: n
                });
                l.add(k)
            }
            if (h.hasAccessToReportId(404, true)) {
                n = j.Us.getUrlById(1691, "__pd=gm_fv&pk=404&ext=vw&sid=" + m.options.sectionId);
                k = new h.Ms.ReportList({
                    ReportName: "Pre-excused Absences by Student",
                    Link: n
                });
                l.add(k)
            }
            if ((h.hasAccessToReportId(121, true)) && (!m.options.UseFAWebAtt)) {
                n = j.Us.getUrlById(1691, "__pd=gm_fv&pk=121&ext=vw&o_pk=" + m.options.sectionId);
                k = new h.Ms.ReportList({
                    ReportName: "Attendance History - By Section",
                    Link: n
                });
                l.add(k)
            }
            if ((h.hasAccessToReportId(500, true)) && (!m.options.UseFAWebAtt)) {
                n = j.Us.getUrlById(1691, "__pd=gm_fv&pk=500&ext=vw&o_pk=" + m.options.sectionId);
                k = new h.Ms.ReportList({
                    ReportName: "Attendance History - By Section",
                    Link: n
                });
                l.add(k)
            }
            if (h.hasAccessToReportId(508, true)) {
                n = j.Us.getUrlById(1691, "__pd=gm_fv&pk=508&sectionId=" + m.options.sectionId);
                k = new h.Ms.ReportList({
                    ReportName: "School Forms",
                    Link: n
                });
                l.add(k)
            }
            if (i.Data.AssociationId == 9) {
                if (h.hasAccessToReportId(248, true)) {
                    n = j.Us.getUrlById(1691, "__pd=gm_fv&pk=248&ext=vw&s_pk=" + m.options.sectionId);
                    k = new h.Ms.ReportList({
                        ReportName: "Assignment Grades with Comments - By Student for All Sections",
                        Link: n
                    });
                    l.add(k)
                }
                if (h.hasAccessToReportId(211, true)) {
                    n = j.Us.getUrlById(1691, "__pd=gm_fv&pk=211&ext=vw&s_pk=" + m.options.sectionId);
                    k = new h.Ms.ReportList({
                        ReportName: "Assignment Grades - By Student for All Sections",
                        Link: n
                    });
                    l.add(k)
                }
                if (h.hasAccessToReportId(260, true)) {
                    n = j.Us.getUrlById(1691, "__pd=gm_fv&pk=260&ext=vw&s_pk=" + m.options.sectionId);
                    k = new h.Ms.ReportList({
                        ReportName: "Cumulative Grades - By Student for all Sections",
                        Link: n
                    });
                    l.add(k)
                }
                if (h.hasAccessToReportId(324, true)) {
                    n = j.Us.getUrlById(1691, "__pd=gm_fv&pk=324&ext=vw&o_pk=" + m.options.sectionId);
                    k = new h.Ms.ReportList({
                        ReportName: "Roster Assignments Due - By Section",
                        Link: n
                    });
                    l.add(k)
                }
                if (h.hasAccessToReportId(82, true)) {
                    n = j.Us.getUrlById(1691, "__pd=gm_fv&pk=82&ext=vw&o_pk=" + m.options.sectionId);
                    k = new h.Ms.ReportList({
                        ReportName: "Roster Major Assignment - By Section",
                        Link: n
                    });
                    l.add(k)
                }
                if (h.hasAccessToReportId(417, true)) {
                    n = j.Us.getUrlById(1691, "__pd=gm_fv&pk=417&ext=vw&sid=" + m.options.sectionId);
                    k = new h.Ms.ReportList({
                        ReportName: "Student Schedules - By Advisor",
                        Link: n
                    });
                    l.add(k)
                }
                if (h.hasAccessToReportId(450, true)) {
                    n = j.Us.getUrlById(1691, "__pd=gm_fv&pk=450&ext=vw&sid=" + m.options.sectionId);
                    k = new h.Ms.ReportList({
                        ReportName: "Submitted Assignments - By Students",
                        Link: n
                    });
                    l.add(k)
                }
            }
            if (p3.Data.Context.findByTaskId(53477) && !p3.Data.Context.get("IsImpersonating")) {
                n = window.location.pathname + j.Us.getUrlById(53477, m.options.sectionId);
                k = new h.Ms.ReportList({
                    ReportName: "Medical Contact Cards",
                    Link: n
                });
                l.add(k)
            }
            return l
        }
    });
    i.Vs.rosterReport = Bb.View.extend({
        tagName: "ul",
        className: "dropdown-menu",
        initialize: function(k) {
            this.button = $("<button>", {
                "class": "btn dropdown-toggle",
                "data-toggle": "dropdown"
            }).hide();
            this.listenTo(this.collection, "reset", this.renderReports);
            this.renderReports()
        },
        render: function(k) {
            $(k).append(this.button.append("Run Roster/Student Reports ", $("<span>", {
                "class": "caret"
            })), this.$el)
        },
        renderReports: function() {
            this.$el.empty();
            if (this.options.reports.length > 0) {
                this.button.show()
            }
            this.options.reports.each(function(k) {
                this.$el.append($("<li>").append($("<a>", {
                    target: "_blank",
                    href: k.get("Link")
                }).html(k.get("ReportName"))))
            }, this)
        }
    });
    i.Vs.RosterSearchView = Bb.View.extend({
        template: "roster/roster.search.template.html",
        events: {
            "click #rosterSearchButton": "doSearch",
            "keydown #rosterSearchField": "doSearchEnter",
            "click #rosterManageButton": "doManageRoster",
            "click #missingAssignmentButton": "doMissingAssignment",
            "click .send-message": "sendMessage",
            "change #roster-term-picker": "changeTermPicker"
        },
        initialize: function(k) {
            k = k || {};
            this.collection = k.collection || null;
            if (this.collection !== null) {
                this.collection.once("reset", this.renderTemplate, this);
                this.collection.on("reset", this.setManagementLink, this)
            }
        },
        dispose: function() {
            if (this.collection !== null) {
                this.collection.off("reset", this.renderTemplate);
                this.collection.off("reset", this.setManagementLink)
            }
        },
        render: function(k) {
            if (this.collection !== null) {
                $(k).append(this.el)
            }
        },
        renderTemplate: function() {
            var k = this;
            switch (i.Data.AssociationId) {
                case i.Us.GroupTypes.Academics.id:
                    k.managementLink = this.options.editAccess && (p3.Data.Context.findByTaskId(i.Us.GroupTypes.Academics.memberEdit) || p3.Data.Context.findByTaskId(i.Us.GroupTypes.Academics.ownerEdit));
                    break;
                case i.Us.GroupTypes.Athletics.id:
                    k.managementLink = this.options.editAccess && (p3.Data.Context.findByTaskId(i.Us.GroupTypes.Athletics.memberEdit) || p3.Data.Context.findByTaskId(i.Us.GroupTypes.Athletics.ownerEdit));
                    break;
                case i.Us.GroupTypes.Communities.id:
                    k.managementLink = this.options.editAccess && (p3.Data.Context.findByTaskId(i.Us.GroupTypes.Communities.memberEdit) || p3.Data.Context.findByTaskId(i.Us.GroupTypes.Communities.ownerEdit));
                    break;
                case i.Us.GroupTypes.Activities.id:
                    k.managementLink = this.options.editAccess && (p3.Data.Context.findByTaskId(i.Us.GroupTypes.Activities.memberEdit) || p3.Data.Context.findByTaskId(i.Us.GroupTypes.Activities.ownerEdit));
                    break;
                case i.Us.GroupTypes.Advisories.id:
                    k.managementLink = this.options.editAccess && (p3.Data.Context.findByTaskId(i.Us.GroupTypes.Advisories.memberEdit) || p3.Data.Context.findByTaskId(i.Us.GroupTypes.Advisories.ownerEdit));
                    break;
                case i.Us.GroupTypes.Dorms.id:
                    k.managementLink = this.options.editAccess && (p3.Data.Context.findByTaskId(i.Us.GroupTypes.Dorms.memberEdit) || p3.Data.Context.findByTaskId(i.Us.GroupTypes.Dorms.ownerEdit));
                    break;
                default:
                    k.managementLink = undefined
            }
            p3.fT(k.template, function(l) {
                k.$el.html(l({
                    memberCount: (k.collection.length),
                    managementLink: typeof k.managementLink === "object" ? k.managementLink.TaskId : undefined,
                    missingAssignmentInd: k.options.missingAssignmentInd,
                    sectionId: k.options.sectionId,
                    leadSectionId: k.options.leadSectionId,
                    hasComposeAccess: k.options.hasComposeAccess,
                    isTeacher: k.options.isTeacher,
                    isCommunityGroup: k.options.isCommunityGroup
                }));
                k.setManagementLink();
                if (p3.Config.uiVersion === 3) {
                    k.options.viewContainers.rosterReport = k.$("#roster-reports")
                }
                k.Containers = {
                    termPicker: k.$("#term-picker")
                };
                p3.rV(new i.Vs.TermPicker({
                    leadSectionId: k.options.leadSectionId,
                    sectionId: k.options.sectionId
                }), k.Containers.termPicker, true)
            })
        },
        doSearchEnter: function(k) {
            if (k.keyCode === 13) {
                this.doSearch(k)
            }
        },
        doSearch: function(l) {
            var k = $(l.currentTarget),
                m;
            if (k.length > 0) {
                m = $("#rosterSearchField").val() || k.val();
                if (m === "") {
                    this.collection.searchTerm = undefined
                } else {
                    this.collection.searchTerm = m
                }
                $("#RosterCardContainer").trigger("doSearch")
            }
        },
        doManageRoster: function(k) {
            if (i.Data.AssociationId !== 3) {
                var l = new i.Vs.ManageRosterView({
                    sectionId: this.options.sectionId,
                    roster: this.collection,
                    durationId: this.options.durationId,
                    buildingId: this.options.buildingId
                });
                k.preventDefault();
                k.stopPropagation();
                p3.rV(l, p3.Layout.Containers.Modal, true);
                p3.showModal(p3.Layout.Containers.Modal)
            }
        },
        doMissingAssignment: function(k) {
            var l = this;
            k.preventDefault();
            k.stopPropagation();
            a.Us.showAdvisorMissingAssignmentList(l.options.sectionId)
        },
        sendMessage: function(k) {
            i.Us.SendMessage(k, this);
            return false
        },
        changeTermPicker: function(k) {
            this.options.sectionId = $(k.currentTarget).val();
            this.collection.sectionId = this.options.sectionId;
            this.collection.fetch()
        },
        setManagementLink: function() {
            if (typeof this.managementLink === "object") {
                this.$("#rosterManageButton").prop("href", "/podium/default.aspx?t=" + this.managementLink.TaskId + "&pk=" + this.options.sectionId)
            }
        }
    });
    i.Vs.TermPicker = Bb.View.extend({
        tagName: "select",
        className: "form-control input-medium mr-5",
        attributes: {
            id: "roster-term-picker"
        },
        initialize: function(k) {
            this.collection = new i.Cs.SectionTerms();
            this.$el.hide();
            this.collection.fetch({
                data: {
                    leadSectionId: this.options.leadSectionId
                }
            });
            this.listenTo(this.collection, "reset", this.renderTemplate)
        },
        render: function(k) {
            $(k).append(this.el)
        },
        renderTemplate: function(k) {
            if (k.length > 0) {
                k.each(function(l) {
                    this.$el.append($("<option>", {
                        value: l.get("Id")
                    }).html(l.get("Duration").Name + " " + l.get("Duration").ShortDescription))
                }, this);
                this.$el.show().val(this.options.sectionId || this.options.leadSectionId)
            } else {
                this.remove()
            }
        }
    });
    i.Vs.Card = Bb.View.extend({
        template: "roster/roster.card.template.html",
        className: "span4 col-md-4",
        events: {
            "click .user-relationships-initial": "displayRelationships",
            "click .user-relationships-expanded": "collapseRelationships",
            "click .user-relationships-collapsed": "expandRelationships",
            'click [data-action="schedule"]': "openSchedule"
        },
        initialize: function(k) {
            k = k || {};
            if (_.isUndefined(k.isOwner)) {
                this.options.isOwner = 0
            }
            if (_.isUndefined(k.associationId)) {
                this.options.associationId = -1
            }
            this.model = k.model || undefined
        },
        render: function(k) {
            $(k).append(this.el);
            this.renderTemplate()
        },
        renderTemplate: function() {
            var u = this,
                r = p3.Data.Context.getSelectedPersona().Id,
                p = (r == 3 || r == 5) && !u.model.get("teacherType"),
                l = f.Us.hasComposeAccess() && p3.Data.SchoolContext.get("SchoolInfo").IndividualMessageEnabled,
                q = "",
                s = (u.model.get("homePhone") !== undefined || u.model.get("wireless") !== undefined),
                k = "",
                n = p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.COMMENT),
                m = ((u.options.isOwner == 1) && (u.options.associationId == 9)),
                t = p3.Config.FtpImagePath + "user/" + u.model.get("userThumb"),
                o = typeof u.model.get("gradYear") === "string" ? u.model.get("gradYear").substring(2, 4) : undefined,
                v;
            if (u.model.get("addressLine1")) {
                k = "<div>" + u.model.get("addressLine1");
                if (u.model.get("addressLine2")) {
                    k += "</div><div>" + u.model.get("addressLine2");
                    if (u.model.get("addressLine3")) {
                        k += "</div><div>" + u.model.get("addressLine3")
                    }
                }
            }
            if (u.model.get("city")) {
                if (u.model.get("addressLine1")) {
                    k += "</div><div>"
                } else {
                    k = "<div>"
                }
                k += u.model.get("city")
            }
            if (u.model.get("state")) {
                if (u.model.get("city") || u.model.get("addressLine1")) {
                    k += ", "
                }
                if (k === "") {
                    k = "<div>"
                }
                k += u.model.get("state")
            }
            if (u.model.get("zip")) {
                k += " " + u.model.get("zip")
            }
            if (k.length > 0) {
                k += "</div>"
            }
            if (u.model.get("NumForms") == 1) {
                v = j.Us.getUrlById(1691, "pk=393&__pd=gm_fv&ext=pdf&sid=" + u.model.get("Id") + "&fiid=" + u.model.get("FormInstanceId"));
                q = '<a target="_blank" href="' + v + '" rel="tooltip" ';
                if (p) {
                    q += 'class="btn btn-default contact-card-teacher-right-btn" '
                } else {
                    q += 'class="btn btn-default contact-card-right-btn" '
                }
                q += 'data-original-title="Profile: ' + u.model.get("FormName") + '"> <i class="p3icon-learningProfile"></i></a>'
            }
            if (u.model.get("NumForms") > 1) {
                q = '<span id="LP_' + u.model.get("Id") + '"></span>';
                i.Us.LearningProfileButton(u.model.toJSON(), 5)
            }
            if (p3.Data.Context.findByTaskId(53394)) {
                b(u.model)
            }
            p3.fT(u.template, function(w) {
                u.$el.html(w({
                    contact: u.model.toJSON(),
                    isTeacher: p,
                    canMessage: l,
                    learningProfile: u.options.disableLearningProfiles ? "" : q,
                    phone: s,
                    address: k,
                    userThumb: u.model.get("userThumb"),
                    profilePicture: t,
                    gYear: o,
                    canSeeCourseRequests: m,
                    canSeeOfficialNotes: n,
                    hasConduct: (p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.CONDUCT) && p3.Data.Context.findByTaskId(53460)) ? true : false
                }));
                u.$el.find(".btn").tooltip()
            })
        },
        displayRelationships: function(k) {
            var m = k.target.hash.substring(1),
                l = new i.Cs.Relationship({}, {
                    studentId: m
                });
            l.fetch({
                success: function() {
                    var n = [m],
                        r = (p3.Config.uiVersion === 3),
                        q = '<table class="table table-striped table-condensed well" style="margin:0px 0px 0px 0px">',
                        o = "",
                        p;
                    if (r) {
                        q = '<table class="table table-condensed" style="margin:0px 0px 0px 0px">'
                    }
                    l.each(function(s) {
                        if (r) {
                            q += "<tr><td>";
                            if (f.Us.hasComposeAccess() && p3.Data.SchoolContext.get("SchoolInfo").IndividualMessageEnabled && (p3.Data.Context.getSelectedPersona().Id !== 2 || (p3.Data.Context.getSelectedPersona().Id === 2 && m == p3.Data.Context.get("UserInfo").UserId))) {
                                q += '<a class="btn btn-sm btn-default send-message" style="margin-right:5px" href="#" rel="tooltip" data-original-title="Send Message" data-user-id="';
                                q += $.trim(s.get("Id"));
                                q += '"> <i class="p3icon-message" style="color:black;"></i></a>'
                            }
                            if (s.get("publishPage")) {
                                q += '<a href="#profile/' + s.get("Id") + '/contactcard" class="btn btn-sm btn-default" rel="tooltip" data-original-title="Contact Card">View</a>'
                            }
                            q += "</td><td>";
                            q += s.get("firstName");
                            q += " ";
                            q += s.get("lastName");
                            q += " (";
                            q += s.get("relationship");
                            q += ")";
                            if (s.get("email")) {
                                q += '<br><a href="mailto:';
                                q += s.get("email");
                                q += '">';
                                q += s.get("email");
                                q += "</a>"
                            }
                            q += "</td></tr>"
                        } else {
                            q += '<tr><td><p style="margin-top:5px">';
                            q += s.get("firstName");
                            q += " ";
                            q += s.get("lastName");
                            q += " (";
                            q += s.get("relationship");
                            if (s.get("email")) {
                                q += ')<br><a href="mailto:';
                                q += s.get("email");
                                q += '">';
                                q += s.get("email");
                                q += "</a></p></td><td>"
                            } else {
                                q += ")</p></td><td>"
                            }
                            if (f.Us.hasComposeAccess() && p3.Data.SchoolContext.get("SchoolInfo").IndividualMessageEnabled && (p3.Data.Context.getSelectedPersona().Id !== 2 || (p3.Data.Context.getSelectedPersona().Id === 2 && m == p3.Data.Context.get("UserInfo").UserId))) {
                                q += '<a class="btn btn-default pull-right send-message" href="#" rel="tooltip" data-original-title="Send Message" data-user-id="';
                                q += $.trim(s.get("Id"));
                                q += '"> <i class="p3icon-message"></i></a>'
                            }
                            if (s.get("publishPage")) {
                                q += '<a href="#profile/' + s.get("Id") + '/contactcard" class="btn btn-default pull-right" style="margin-right:5px" rel="tooltip" data-original-title="Contact Card"><i class="p3icon-contactCard"></i></a>'
                            }
                            q += "</td></tr>"
                        }
                        n.push(s.get("Id"))
                    });
                    for (p = 0; p < n.length; p++) {
                        if (o.length > 0) {
                            o += ","
                        }
                        o += n[p]
                    }
                    if (f.Us.hasComposeAccess() && p3.Data.SchoolContext.get("SchoolInfo").IndividualMessageEnabled && (p3.Data.Context.getSelectedPersona().Id !== 2 || (p3.Data.Context.getSelectedPersona().Id === 2 && m == p3.Data.Context.get("UserInfo").UserId))) {
                        if (r) {
                            q += '<tr class="message-all-row"><td><a href="#" class="btn btn-default send-message" data-user-id="' + o + '">Message All</a></td><td>&nbsp;</td></tr>'
                        } else {
                            q += '<tr class="message-all-row"><td>&nbsp;</td><td><a href="#" class="btn btn-default pull-right send-message" data-user-id="' + o + '"><h4><i class="p3icon-message"></i> Message All</h4></a></td></tr>'
                        }
                    }
                    q += "</table>";
                    $("#relate_region_" + m).html(q);
                    $("#relate_region_" + m).slideDown();
                    $(k.target).removeClass("user-relationships-initial").addClass("user-relationships-expanded");
                    $(".btn").tooltip()
                },
                error: function() {
                    p3.displayError("Error loading relationships")
                }
            });
            return false
        },
        expandRelationships: function(k) {
            var l = k.target.hash.substring(1);
            $(k.target).removeClass("user-relationships-collapsed").addClass("user-relationships-expanded");
            $("#relate_region_" + l).slideDown();
            return false
        },
        collapseRelationships: function(k) {
            var l = k.target.hash.substring(1);
            $(k.target).removeClass("user-relationships-expanded").addClass("user-relationships-collapsed");
            $("#relate_region_" + l).slideUp();
            return false
        },
        openSchedule: function() {
            p3.Data.ViewAsStudent = true
        }
    });
    i.Vs.DormRoster = Bb.View.extend({
        template: "roster/roster.dorm.template.html",
        events: {
            "click .resident-sort": "updateSort"
        },
        initialize: function(k) {
            k = k || {};
            if (_.isUndefined(k.isOwner)) {
                this.options.isOwner = 0
            }
            if (_.isUndefined(k.associationId)) {
                this.options.associationId = -1
            }
        },
        render: function(k) {
            $(k).append(this.el);
            this.renderTemplate()
        },
        renderTemplate: function() {
            var p = this,
                n = p3.Data.Context.getSelectedPersona().Id,
                m = (n == 3 || n == 5),
                k = f.Us.hasComposeAccess() && p3.Data.SchoolContext.get("SchoolInfo").IndividualMessageEnabled,
                l = p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.COMMENT),
                o;
            if (p.options.residents.length > 0) {
                p.options.residents = _.sortBy(p.options.residents, function(q) {
                    switch (i.Data.DormSort) {
                        case "boarding":
                            o = q.boarding;
                            break;
                        case "roomSort":
                            if (i.Data.RoomsNumeric) {
                                o = parseInt(q.roomSort, 10)
                            } else {
                                o = q.roomSort
                            }
                            break;
                        default:
                            o = q.userSort;
                            break
                    }
                    return o
                });
                if (i.Data.DormSortDesc) {
                    p.options.residents.reverse()
                }
            }
            p3.fT(p.template, function(q) {
                p.$el.html(q({
                    residents: p.options.residents,
                    owners: p.options.owners,
                    isTeacher: m,
                    canMessage: k,
                    canSeeOfficialNotes: l,
                    schoolId: p3.Data.SchoolContext.attributes.SchoolInfo.SchoolId,
                    Sort: i.Data.DormSort,
                    SortDesc: i.Data.DormSortDesc,
                    hasConduct: (p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.CONDUCT)) ? true : false
                }));
                p.$el.find(".btn").tooltip()
            })
        },
        updateSort: function(l) {
            var n = this,
                k = $(l.currentTarget),
                m = k.data("sort");
            if (m !== undefined) {
                if (m === i.Data.DormSort) {
                    i.Data.DormSortDesc = !i.Data.DormSortDesc
                } else {
                    i.Data.DormSortDesc = false
                }
                i.Data.DormSort = m;
                n.renderTemplate()
            }
            l.preventDefault()
        }
    });
    i.Vs.ManageRosterView = Bb.View.extend({
        template: "roster/roster.manage.template.html",
        events: {
            "click #rosterManageSave": "doSave",
            changehead: "doChangeHead"
        },
        initialize: function() {
            this.facultyRoles = new i.Cs.FacultyRoles();
            this.groupOwnerRoles = new i.Cs.GroupOwnerRoles();
            this.rooms = new i.Cs.Rooms();
            if (!_.isUndefined(this.options) && this.options.sectionId > 0) {
                this.collection = new i.Cs.ManageMembers();
                this.collection.on("reset", this.renderItems, this)
            }
            this.roster = this.options.roster || undefined;
            this.facultyRoles.fetch({
                data: {
                    associationId: i.Data.AssociationId
                }
            });
            this.groupOwnerRoles.fetch({
                data: {
                    associationId: i.Data.AssociationId
                }
            });
            if (i.Data.AssociationId === 7) {
                this.rooms.fetch({
                    data: {
                        buildingId: this.options.buildingId
                    }
                })
            }
        },
        dispose: function() {
            this.collection.off("reset", this.renderItems).off("reset", this.initializeTokenInput)
        },
        render: function(k) {
            $(k).append(this.el);
            this.renderTemplate()
        },
        renderTemplate: function() {
            var o = this,
                k = false,
                l = false,
                m = "",
                n = "";
            switch (i.Data.AssociationId) {
                case i.Us.GroupTypes.Academics.id:
                    m = "Teachers";
                    n = "Students";
                    k = p3.Data.Context.findByTaskId(i.Us.GroupTypes.Academics.ownerEdit);
                    l = p3.Data.Context.findByTaskId(i.Us.GroupTypes.Academics.memberEdit);
                    break;
                case i.Us.GroupTypes.Athletics.id:
                    m = "Coaches";
                    n = "Athletes";
                    k = p3.Data.Context.findByTaskId(i.Us.GroupTypes.Athletics.ownerEdit);
                    l = p3.Data.Context.findByTaskId(i.Us.GroupTypes.Athletics.memberEdit);
                    break;
                case i.Us.GroupTypes.Communities.id:
                    break;
                case i.Us.GroupTypes.Activities.id:
                    m = "Activity Leaders";
                    n = "Students";
                    k = p3.Data.Context.findByTaskId(i.Us.GroupTypes.Activities.ownerEdit);
                    l = p3.Data.Context.findByTaskId(i.Us.GroupTypes.Activities.memberEdit);
                    break;
                case i.Us.GroupTypes.Advisories.id:
                    m = "Advisors";
                    n = "Advisees";
                    k = p3.Data.Context.findByTaskId(i.Us.GroupTypes.Advisories.ownerEdit);
                    l = p3.Data.Context.findByTaskId(i.Us.GroupTypes.Advisories.memberEdit);
                    break;
                case i.Us.GroupTypes.Dorms.id:
                    m = "Dorm Leaders";
                    n = "Residents";
                    k = p3.Data.Context.findByTaskId(i.Us.GroupTypes.Dorms.ownerEdit);
                    l = p3.Data.Context.findByTaskId(i.Us.GroupTypes.Dorms.memberEdit);
                    break;
                default:
                    m = "Owners";
                    n = "Members";
                    k = false;
                    l = false;
                    break
            }
            p3.fT(o.template, function(p) {
                o.$el.html(p({
                    canEditLeaders: k,
                    canEditMembers: l,
                    leaderTitle: m,
                    memberTitle: n
                }));
                o.collection.fetch({
                    data: {
                        sectionId: o.options.sectionId,
                        associationId: i.Data.AssociationId
                    },
                    success: function() {
                        o.nextRenderPos = 1;
                        o.collection.each(function(q) {
                            q.set("renderPos", o.nextRenderPos++)
                        });
                        o.nextRenderPos = -1;
                        p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.TokenInput, o.initializeTokenInput, {
                            context: o
                        });
                        o.collection.on("reset", o.initializeTokenInput, this)
                    }
                })
            })
        },
        renderItems: function() {
            var m = this,
                k = this.collection.getOwners(),
                l = this.collection.getMembers();
            k.comparator = function(n) {
                return n.get("renderPos")
            };
            k.sort();
            $("#leaderManagementListing").html("");
            k.each(function(n) {
                if (n.get("enrolled_ind") === 1) {
                    var o = new i.Vs.ManageLeaderItem({
                        model: n,
                        OwnerTypes: m.groupOwnerRoles,
                        FacultyRoles: m.facultyRoles
                    });
                    p3.rV(o, $("#leaderManagementListing"), false)
                }
            });
            l.comparator = function(n) {
                return n.get("renderPos")
            };
            l.sort();
            $("#memberManagementListing").html("");
            l.each(function(n) {
                if (n.get("enrolled_ind") === 1) {
                    p3.rV(new i.Vs.ManageMemberItem({
                        model: n,
                        rooms: m.rooms
                    }), $("#memberManagementListing"), false)
                }
            });
            p3.initModalHeightTimer(p3.Layout.Containers.Modal)
        },
        initializeTokenInput: function(o) {
            o = o || {};
            var p = o.context || this,
                l = p.collection.getOwners(),
                n = p.collection.getMembers(),
                k = [],
                m = [];
            l.each(function(q) {
                if (q.get("enrolled_ind") !== 1) {
                    k.push({
                        id: q.get("user_id"),
                        name: q.get("firstname") + " " + q.get("lastname")
                    })
                }
            });
            n.each(function(r) {
                if (r.get("enrolled_ind") !== 1) {
                    var t = r.get("nickname"),
                        q = r.get("grad_year"),
                        s = r.get("lastname") + ", " + r.get("firstname") + ((t !== undefined && t !== null && t !== "") ? (" (" + t + ") ") : " ") + ((q !== "undefined" && q !== null && q !== "") ? (" '" + q.substring(2)) : (""));
                    m.push({
                        id: r.get("user_id"),
                        name: s
                    })
                }
            });
            $("#leaderLookUpBox").tokenInput(k, {
                minChars: 2,
                searchDelay: 100,
                preventDuplicates: true,
                animateDropdown: false,
                classes: {
                    tokenList: "token-input-list typeAheadFauxFocus input-medium",
                    token: "token-input-token token-input-token-hide",
                    dropdown: "token-input-dropdown"
                },
                resultsFormatter: function(q) {
                    return "<li>" + q.name + "</li>"
                },
                onAdd: function(q) {
                    p.doAddMember(q.id)
                }
            });
            $("#memberLookUpBox").tokenInput(m, {
                minChars: 2,
                searchDelay: 100,
                preventDuplicates: true,
                animateDropdown: false,
                classes: {
                    tokenList: "token-input-list typeAheadFauxFocus input-medium",
                    token: "token-input-token token-input-token-hide",
                    dropdown: "token-input-dropdown"
                },
                resultsFormatter: function(q) {
                    var r = "";
                    r += q.name;
                    return "<li>" + r + "</li>"
                },
                onAdd: function(q) {
                    p.doAddMember(q.id)
                }
            })
        },
        doAddMember: function(k) {
            var n = this,
                m = n.collection.find(function(o) {
                    return o.get("user_id") === k
                }),
                l = c.localDateTime();
            if (m !== undefined && m !== null) {
                m.set("enrolled_ind", 1);
                m.set("renderPos", n.nextRenderPos--);
                m.set("enroll_date", c.getDateString(l) + " " + c.getTimeString(l));
                if (m.get("owner_ind") && n.facultyRoles.length > 0) {
                    m.set("owner_type", n.facultyRoles.at(0).get("role"));
                    if ($(".manage-roster-owner-row").length === 0) {
                        m.set("head", true)
                    }
                }
                n.renderItems()
            }
        },
        doSave: function(k) {
            var p = this,
                m = [],
                n = [],
                l = false,
                o;
            this.$el.find(".error").removeClass("error");
            $("#manage-roster-error-messages").html("").hide();
            this.collection.each(function(q) {
                if (q.get("enrolled_ind")) {
                    var r = {
                        UserId: q.get("user_id"),
                        EnrollDate: q.get("enroll_date"),
                        DeleteInd: q.get("delete_ind") || false
                    };
                    if (q.get("owner_ind")) {
                        r.Head = q.get("head");
                        r.OwnerType = q.get("owner_type")
                    } else {
                        if (i.Data.AssociationId === 7 && q.get("room_id")) {
                            r.RoomId = q.get("room_id")
                        }
                    }
                    if (q.get("delete_ind") && !q.get("owner_ind")) {
                        r.DropType = q.get("drop_type");
                        r.DropComment = "";
                        r.DropDate = q.get("drop_date");
                        if (_.isUndefined(r.DropType) || r.DropType === null) {
                            $("#manage-roster-drop-reason-" + r.UserId).addClass("error");
                            if (n.indexOf("A reason is required in order to drop someone from the roster") === -1) {
                                n.push("A reason is required in order to drop someone from the roster")
                            }
                            l = true
                        }
                        if (_.isUndefined(r.DropDate) || r.DropDate === null || r.DropDate === "") {
                            $("#manage-roster-drop-date-" + r.UserId).addClass("error");
                            if (n.indexOf("A date is required in order to drop someone from the roster") === -1) {
                                n.push("A date is required in order to drop someone from the roster")
                            }
                            l = true
                        }
                    }
                    m.push(r)
                }
            });
            if (l) {
                _.each(n, function(q) {
                    p3.Us.InfoMessage.ErrorBox(q, "#manage-roster-error-messages", false)
                });
                if (n.length > 0) {
                    $("#manage-roster-error-messages").show()
                }
            } else {
                o = new i.Ms.ManagedRoster();
                o.save({
                    sectionId: p.options.sectionId,
                    members: m
                }, {
                    success: function() {
                        if (!_.isUndefined(p.roster)) {
                            p.roster.fetch()
                        }
                        if (typeof p.options.onSave === "function") {
                            p.options.onSave()
                        }
                        p3.Layout.Containers.Modal.modal("hide")
                    },
                    error: function() {
                        p3.Us.InfoMessage.ErrorBox("An error was encountered while trying to save the roster changes.", "#manage-roster-error-messages", false);
                        $("#manage-roster-error-messages").show()
                    }
                })
            }
        },
        doChangeHead: function(k) {
            var l = this.collection.find(function(m) {
                return m.get("user_id") === k.userId
            });
            if (l !== undefined && l !== null) {
                l.set("head", false)
            }
        }
    });
    i.Vs.ManageLeaderItem = Bb.View.extend({
        template: "roster/roster.manage.leader.item.template.html",
        events: {
            "click .btn-approve": "toggleHead",
            "click .btn-denied": "toggleDelete",
            "change .manage-roster-owner-type-select": "updateOwnerType"
        },
        tagName: "tr",
        initialize: function() {
            this.OwnerTypes = this.options.OwnerTypes;
            this.FacultyRoles = this.options.FacultyRoles
        },
        render: function(k) {
            var l = this;
            $(k).append(l.el);
            l.$el.data("userId", l.model.get("user_id"));
            p3.fT(l.template, function(m) {
                l.$el.html(m({
                    model: l.model.toJSON(),
                    leaderType: l.FacultyRoles.toJSON(),
                    OwnerRoles: l.OwnerTypes.toJSON()
                }))
            })
        },
        toggleHead: function(l) {
            var k = $("#leaderManagementListing .btn-approve.active"),
                m;
            if (k.length) {
                m = k.closest("tr").data("userId");
                k.removeClass("active");
                if (m > 0) {
                    this.$el.trigger({
                        type: "changehead",
                        userId: m
                    })
                }
            }
            this.model.set("head", !$(l.currentTarget).hasClass("active"))
        },
        toggleDelete: function(k) {
            this.model.set("delete_ind", !$(k.currentTarget).hasClass("active"))
        },
        updateOwnerType: function(k) {
            this.model.set("owner_type", $(k.currentTarget).val())
        }
    });
    i.Vs.ManageMemberItem = Bb.View.extend({
        template: "roster/roster.manage.member.item.template.html",
        events: {
            "click .btn-denied": "showDelete",
            "change .date-picker": "setDropDate",
            "click .manage-roster-drop-type": "setDropType",
            "change .room-dd": "setRoomId"
        },
        tagName: "tr",
        dispose: function() {
            this.$el.find(".collapse").off("hidden")
        },
        render: function(k) {
            var l = this;
            $(k).append(this.el);
            l.$el.data("userId", l.model.get("user_id"));
            if (l.model.get("grad_year") !== undefined && l.model.get("grad_year") !== null && l.model.get("grad_year").length === 4) {
                l.model.set("gradYearShort", l.model.get("grad_year").substring(2))
            }
            p3.fT(l.template, function(m) {
                l.$el.html(m({
                    model: l.model.toJSON(),
                    date: c.getDateString(c.localDateTime()),
                    rooms: l.options.rooms.toJSON(),
                    association: i.Data.AssociationId
                }));
                d.Us.initialize(".date-picker", {
                    changeMonth: true,
                    changeYear: true
                });
                l.$el.find(".collapse").on("hidden", function(n) {
                    n.stopPropagation()
                })
            })
        },
        showDelete: function(k) {
            this.model.set("delete_ind", !$(k.currentTarget).hasClass("active"));
            $("#delete-view-" + $(k.currentTarget).data("userId")).toggle();
            if (this.model.get("drop_date") === undefined || this.model.get("drop_date") === null) {
                this.model.set("drop_date", c.getDateString(c.localDateTime()))
            }
        },
        setDropDate: function(k) {
            this.model.set("drop_date", $(k.currentTarget).val())
        },
        setDropType: function(m) {
            var n = this,
                l = $(m.currentTarget),
                k = n.$el.find(".manage-roster-drop-details");
            if (l.attr("disabled") === undefined) {
                l.siblings().removeClass("active");
                if (l.hasClass("active")) {
                    l.removeClass("active");
                    this.model.set("drop_type", null);
                    k.collapse("hide")
                } else {
                    l.addClass("active");
                    this.model.set("drop_type", l.data("dropType"));
                    if (!k.hasClass("in")) {
                        k.collapse("show")
                    }
                }
                this.model.set("delete_ind", l.hasClass("active"));
                switch (this.model.get("drop_type")) {
                    case 0:
                        l.parent().siblings(".roster-drop-reason-note").html("Note: this option will Remove the Course Record").show();
                        break;
                    case 2:
                        l.parent().siblings(".roster-drop-reason-note").html("Note: this option will Leave the Course Record").show();
                        break;
                    default:
                        l.parent().siblings(".roster-drop-reason-note").html("").hide();
                        break
                }
            }
        },
        setRoomId: function(k) {
            if ($(k.currentTarget).val() === "0") {
                this.model.set("room_id", null)
            } else {
                this.model.set("room_id", parseInt($(k.currentTarget).val(), 10))
            }
        },
        doBeginDateEdit: function(l) {
            var k = $(l.currentTarget);
            k.children("span").hide();
            k.children("input").show().focus()
        },
        doEndDateEdit: function(m) {
            var k = $(m.currentTarget),
                l;
            if (k.length > 0) {
                l = c.getDate(k.val());
                this.model.set("enroll_date", c.getDateString(l) + " " + c.getTimeString(l));
                k.hide();
                k.siblings("span").html(c.getDateString(l));
                k.siblings("span").show()
            }
        }
    });
    Hb.registerHelper("rosterOutput", function(r, n, k) {
        var o = p3.Data.Context.getSelectedPersona().Id == 3 || p3.Data.Context.getSelectedPersona().Id == 5,
            l = false,
            s = "",
            q = '<div class="clear">',
            m, u, t, p;
        for (m = 0; m < r.length; m++) {
            l = false;
            if (m % 3 == 0) {
                if (m > 0) {
                    q += "</ul>"
                }
                q += '<ul class="thumbnails">'
            }
            q += '<li class="span4 col-md-4"><div class="rosterHeader">';
            if (r[m].teacherType) {
                q += '<div class="teacherheader"><h6 class="teacherheader-text test">' + r[m].teacherType + "</h6></div>"
            }
            q += '</div><div class="contactWell"><div class="container row-fluid" style="width:92%;"><div class="row" style="width:100%;margin-left:10px;"><div class="span12 col-md-12"><div class="container row-fluid"><div class="row">';
            if (r[m].userThumb) {
                q += '<div class="span2 col-md-2"><img class="imgNice" src="';
                q += p3.Config.FtpImagePath;
                q += "user/";
                q += r[m].userThumb;
                q += '"></div>';
                q += '<div class="span9 col-md-9">';
                q += '<div class="margin-left-20"><h3>'
            } else {
                q += '<div class="span11 col-md-11">';
                q += "<div><h3>"
            }
            if (r[m].nickName) {
                q += r[m].nickName
            } else {
                q += r[m].firstName
            }
            q += " ";
            q += r[m].lastName;
            if (r[m].gradYear) {
                q += " '";
                q += r[m].gradYear.slice(2)
            }
            q += "</h3>";
            q += '<p class="contactCardP">';
            if (r[m].email) {
                if (r[m].emailBad == "Yes") {
                    q += r[m].email
                } else {
                    q += '<a href="mailto:';
                    q += r[m].email;
                    q += '">';
                    q += r[m].email;
                    q += "</a>"
                }
                q += "<br />";
                l = true
            }
            if (r[m].state) {
                s = r[m].state
            } else {
                if (r[m].province) {
                    s = r[m].province
                } else {
                    s = ""
                }
            }
            if (r[m].addressLine1 || r[m].city || s) {
                if (r[m].addressLine1) {
                    q += r[m].addressLine1
                }
                if (r[m].addressLine2) {
                    q += " ";
                    q += r[m].addressLine2
                }
                if (r[m].addressLine3) {
                    q += " ";
                    q += r[m].addressLine3
                }
                if (r[m].city) {
                    if (r[m].addressLine1 || r[m].addressLine2) {
                        q += ", "
                    }
                    q += r[m].city
                }
                if (s) {
                    if (r[m].city) {
                        q += ", "
                    }
                    q += s
                }
                if (r[m].zip) {
                    q += " ";
                    q += r[m].zip
                }
                q += "<br />";
                l = true
            }
            if (r[m].homePhone) {
                q += "H: ";
                q += r[m].homePhone;
                q += " ";
                l = false
            }
            if (r[m].wireless) {
                q += "C: ";
                q += r[m].wireless;
                l = false
            }
            if (r[m].hasRelationships == 1) {
                if (!l) {
                    q += "<br />"
                }
                q += '<a class="btn btn-default user-relationships-initial hidden-mobile-card" href="#';
                q += r[m].Id;
                q += '">View Relationships</a>'
            }
            q += "</p></div></div>";
            q += '<div class="span1 col-md-1">';
            if (f.Us.hasComposeAccess() && p3.Data.SchoolContext.get("SchoolInfo").IndividualMessageEnabled) {
                if ((p3.Data.Context.getSelectedPersona().Id === 1 && r[m].teacherType !== null) || p3.Data.Context.getSelectedPersona().Id !== 1) {
                    q += '<a data-toggle="modal" href="#" rel="tooltip" data-original-title="Send Message" ';
                    if (o && !r[m].teacherType) {
                        q += 'class="btn btn-default send-message contact-card-teacher-right-btn" '
                    } else {
                        q += 'class="btn btn-default send-message contact-card-right-btn" '
                    }
                    q += 'data-user-id="' + $.trim(r[m].Id) + '"> <i class="p3icon-message"></i></a>'
                }
            }
            if (r[m].NumForms == 1) {
                u = j.Us.getUrlById(1691, "pk=393&__pd=gm_fv&ext=pdf&sid=" + r[m].Id + "&fiid=" + r[m].FormInstanceId);
                q += '<a target="_blank" href="' + u + '" rel="tooltip" ';
                if (o && !r[m].teacherType) {
                    q += 'class="btn btn-default contact-card-teacher-right-btn" '
                } else {
                    q += 'class="btn btn-default contact-card-right-btn" '
                }
                q += 'data-original-title="Profile: ' + r[m].FormName + '"> <i class="p3icon-learningProfile"></i></a>'
            }
            if (r[m].NumForms > 1) {
                q += '<span id="LP_' + r[m].Id + '"></span>';
                i.Us.LearningProfileButton(r[m], m)
            }
            t = r[m].Id;
            if (o && !r[m].teacherType) {
                g.Data.ShowBackButton = true;
                p = '<li><a href="#profile/' + t + '/progress"><i class="p3icon-progress"></i> Progress</a> </li>';
                p += '<li><a href="#profile/' + t + '/schedule"><i class="p3icon-schedule"></i> Schedule</a></li>';
                p += '<li><a href="#profile/' + t + '/assignments"><i class="p3icon-assignments"></i> Assignments</a></li>';
                p += '<li><a href="#officialnote/history/' + t + '"><i class="p3icon-officalNote"></i> Official Notes</a></li>';
                if ((n == 1) && (k == 9)) {
                    p += '<li><a href="#profile/' + t + '/courserequest"><i class="p3icon-courseRequest"></i> Course Request</a></li>'
                }
                p += '<li><a href="#profile/' + t + '/contactcard""><i class="p3icon-contactCard"></i> Contact Card</a></li>';
                if ((p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.CONDUCT)) && (p3.Data.Context.findByTaskId(53460))) {
                    p += '<li><a href="#profile/' + t + '/conduct""><i class="p3icon-contactCard"></i> Conduct</a></li>'
                }
                p += "</ul>";
                q += '<div class="btn-group contact-card-right-btn-group hidden-mobile-card">';
                q += '<button class="btn btn-default dropdown-toggle contact-card-right-btn" data-toggle="dropdown" rel="tooltip" data-original-title="Profile"><i class="p3icon-contactCard"></i> <span class="caret"></span></button>';
                q += '<ul class="dropdown-menu">' + p;
                q += "</div>";
                q += '<button class="btn btn-default contact-card-right-btn visible-mobile-card" data-toggle="collapse" data-target="#user-profile-menu-' + t + '"><i class="p3icon-contactCard"></i> <span class="caret"></span></button>';
                q += '<ul id="user-profile-menu-' + t + '" class="collapse visible-mobile-card">' + p
            } else {
                q += '<a rel="tooltip" class="btn btn-default btn-contact-card" href="#profile/' + t + '/contactcard" data-original-title="Contact Card"> <i class="p3icon-contactCard"></i></a>'
            }
            if (r[m].hasRelationships == 1) {
                if (!l) {
                    q += '<br class="hidden-mobile-card" />'
                }
                q += '<a class="btn btn-default user-relationships-initial visible-mobile-card" href="#';
                q += r[m].Id;
                q += '">View Relationships</a>'
            }
            q += "</div>";
            q += "</div></div></div></div></div></div>";
            if (r[m].hasRelationships == 1) {
                q += '<div style="display:none;" id="relate_region_';
                q += r[m].Id;
                q += '"></div>'
            }
            q += "</li>"
        }
        if (r.length > 0) {
            q += "</ul></div><br />"
        }
        return new Hb.SafeString(q)
    });
    i.Us.LearningProfileButton = function(n, k) {
        var m = "",
            l = new i.Cs.LearningProfileActiveFormsByStudent(),
            o = (p3.Config.uiVersion === 3);
        if (o) {
            m = "&nbsp;&nbsp;"
        }
        setTimeout(function() {
            l.fetch({
                data: {
                    viewType: 2,
                    studentUserId: n.Id
                },
                error: function() {
                    p3.displayError("Error loading Learning Profiles")
                },
                success: function(p) {
                    var q = 0;
                    p.each(function(r) {
                        var s = j.Us.getUrlById(1691, "pk=393&__pd=gm_fv&ext=pdf&sid=" + r.get("StudentUserId") + "&fiid=" + r.get("FormInstanceId"));
                        if (o) {
                            m = m + '<a class="btn btn-default lp" rel="tooltip" data-original-title="Profile: ' + r.get("FormName") + '" style="margin-left:5px;" href="' + s + '" target="_blank"><i class="p3icon-learningProfile"></i></a>'
                        } else {
                            m = m + '<a class="btn btn-default lp" rel="tooltip" data-original-title="Profile: ' + r.get("FormName") + '" style="margin-bottom:5px;" href="' + s + '" target="_blank"><i class="p3icon-learningProfile"></i></a>'
                        }
                        q = r.get("StudentUserId")
                    });
                    $("#LP_" + q).html(m);
                    $(".lp").tooltip()
                }
            })
        }, (k * 100))
    };
    i.Us.SendMessage = function(l, u) {
        var r = $(l.currentTarget),
            p = p3.Data.SchoolContext.get("SchoolInfo"),
            o = (p.BulkEmailEnabled && p.BulkMessageEnabled) ? 2 : ((p.BulkEmailEnabled && !p.BulkMessageEnabled) ? 1 : 0),
            s, m, n, q, k;
        if (r !== undefined) {
            s = $(r).data("messageType");
            m = $(r).data("userId");
            if (s === undefined && typeof m === "number") {
                i.Us.ComposeUserMessage(m, false, {})
            } else {
                if (s === undefined && typeof m === "string") {
                    n = m.split(",");
                    if (n.length > 0) {
                        i.Us.ComposeUserMessage(n, false, {})
                    }
                } else {
                    if (typeof s === "number") {
                        q = parseInt(u.options.sectionId, 10);
                        k = i.Data.AssociationId + "_";
                        if (typeof q === "number") {
                            switch (s) {
                                case i.Us.MessageType.Both:
                                    if (i.Data.AssociationId == 3) {
                                        i.Us.ComposeUserMessage([k + q + "_1", k + q + "_4"], true, {
                                            mode: o,
                                            type: f.Enum.bulkType.all,
                                            sectionId: u.options.leadSectionId
                                        })
                                    } else {
                                        if (i.Data.AssociationId === 7) {
                                            i.Us.ComposeUserMessage([k + q + "_8", k + q + "_16", k + q + "_32", k + q + "_64", k + q + "_4"], true, {
                                                mode: o,
                                                type: f.Enum.bulkType.all,
                                                sectionId: q,
                                                assoc: 7
                                            })
                                        } else {
                                            i.Us.ComposeUserMessage([k + q + "_1", k + q + "_2", k + q + "_4"], true, {
                                                mode: o,
                                                type: f.Enum.bulkType.all,
                                                sectionId: q
                                            })
                                        }
                                    }
                                    break;
                                case i.Us.MessageType.Parents:
                                    if (i.Data.AssociationId === 7) {
                                        i.Us.ComposeUserMessage([k + q + "_16", k + q + "_64"], true, {
                                            mode: o,
                                            type: f.Enum.bulkType.parent,
                                            sectionId: q,
                                            assoc: 7
                                        })
                                    } else {
                                        i.Us.ComposeUserMessage([k + q + "_2"], true, {
                                            mode: o,
                                            type: f.Enum.bulkType.parent,
                                            sectionId: q
                                        })
                                    }
                                    break;
                                case i.Us.MessageType.Students:
                                    if (i.Data.AssociationId == 3) {
                                        i.Us.ComposeUserMessage([k + q + "_1"], true, {
                                            mode: o,
                                            type: f.Enum.bulkType.student,
                                            sectionId: u.options.leadSectionId
                                        })
                                    } else {
                                        if (i.Data.AssociationId === 7) {
                                            i.Us.ComposeUserMessage([k + q + "_8", k + q + "_32"], true, {
                                                mode: o,
                                                type: f.Enum.bulkType.student,
                                                sectionId: q,
                                                assoc: 7
                                            })
                                        } else {
                                            i.Us.ComposeUserMessage([k + q + "_1"], true, {
                                                mode: o,
                                                type: f.Enum.bulkType.student,
                                                sectionId: q
                                            })
                                        }
                                    }
                                    break;
                                default:
                                    break
                            }
                        }
                    }
                }
            }
        }
    }
}(p3.module("LMS/roster")));
(function(b) {
    var a = p3.module("pager");
    b.Ms.RssReader = Bbm.extend({
        idAttribute: "ReaderId",
        url: function() {
            return aP + "rssreader/forsection/?format=json&contextValue=" + this.get("leadSectionId") + "&contextLabelId=" + this.get("contextLabelId")
        }
    });
    b.Ms.RssReaderSave = Bbm.extend({
        idAttribute: "ReaderId",
        url: function() {
            var c;
            if (this.get("ReaderId") == 0) {
                c = aP + "rssreader/create/?format=json"
            } else {
                c = aP + "rssreader/update/?format=json"
            }
            return c
        }
    });
    b.Ms.RssReaderDelete = Bbm.extend({
        idAttribute: "ReaderId",
        url: function() {
            return aP + "rssreader/delete/?format=json&readerId=" + this.get("ReaderId")
        }
    });
    b.Vs.RssReaderView = Bb.View.extend({
        template: "classpage/rssreader.template.html",
        events: {
            "click #edit_reader": "openEditModal",
            "click #delete_reader": "openDeleteModal"
        },
        renderTemplate: function(e) {
            var f = this,
                d = f.options.reader,
                c = false;
            if (d.get("Url")) {
                c = true
            }
            p3.fT(f.template, function(g) {
                f.$el.html(g({
                    reader: d,
                    haveData: c,
                    viewMode: !f.options.editMode,
                    canEdit: f.options.canEdit,
                    customHeader: f.options.customHeader
                }));
                if (e) {
                    $("#edit_reader").show();
                    if (c) {
                        $("#delete_reader").show()
                    }
                }
                if (c) {
                    p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.jQueryFeed, function() {
                        $("#rss_results").feeds({
                            feeds: {
                                feed1: d.get("Url")
                            },
                            preprocess: function(h) {
                                this.publishedDate = p3.Us.Tools.dateDisplay(this.publishedDate);
                                this.contentSnippet = this.contentSnippet + "<br /><br />"
                            },
                            onComplete: function(h) {
                                var i = -1,
                                    j;
                                $(".feeds-entry").each(function() {
                                    i += 1;
                                    $(this).attr("id", "entry_" + i);
                                    if (i > 2) {
                                        $(this).hide()
                                    }
                                });
                                if (i + 1 > 3) {
                                    j = new a.Cs.Pager();
                                    j.getPages(i + 1, 1);
                                    p3.rV(new a.Vs.PagerView({
                                        collection: j,
                                        prefix: "entry",
                                        itemCount: i + 1
                                    }), $("#reader_pager"), true)
                                }
                            },
                            max: d.get("NumberOfItems")
                        })
                    })
                }
            })
        },
        render: function(c) {
            $(c).append(this.el)
        },
        openEditModal: function() {
            var c = this;
            p3.rV(new b.Vs.RssReaderEditView({
                reader: c.options.reader,
                leadSectionId: c.options.leadSectionId,
                contextLabelId: c.options.contextLabelId,
                parentView: c
            }), p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            return false
        },
        openDeleteModal: function() {
            var c = this;
            p3.showConfirm("Delete Rss Feed", "Warning: Once you hit confirm there is no undo button. Are you really sure you want to delete this forever?", null, function() {
                var d = new b.Ms.RssReaderDelete({
                    ReaderId: c.options.reader.get("ReaderId")
                });
                d.destroy({
                    error: function() {
                        p3.displayError("Error deleting rss Feed")
                    },
                    success: function() {
                        b.Us.refreshReader(true, c.options.leadSectionId, c, c.options.contextLabelId)
                    }
                })
            });
            return false
        }
    });
    b.Vs.RssReaderEditView = Bb.View.extend({
        template: "rssreader/rssreader.edit.template.html",
        events: {
            "click #btnSave": "saveReader",
            "click #btnSaveAdd": "saveReader",
            "change #txtUrl": "removeUrlValidation",
            "change #txtNumber": "removeNumberValidation"
        },
        renderTemplate: function() {
            var c = this;
            p3.fT(c.template, function(d) {
                c.$el.html(d({
                    reader: c.options.reader.toJSON()
                }))
            })
        },
        render: function(c) {
            var d = this;
            d.renderTemplate();
            $(c).append(d.el)
        },
        saveReader: function(c) {
            var g = this,
                f = true,
                d, e;
            $("#btnSave").button("loading");
            if ($("#txtUrl").val().length === 0) {
                $(".rss-url-group").addClass("error");
                $("#btnSave").button("reset");
                f = false
            }
            if ($("#txtNumber").val().length === 0 || isNaN($("#txtNumber").val())) {
                $(".rss-num-group").addClass("error");
                $("#btnSave").button("reset");
                f = false
            }
            if (f) {
                d = 0;
                if (g.options.reader.get("ReaderId")) {
                    d = g.options.reader.get("ReaderId")
                }
                e = new b.Ms.RssReaderSave({
                    ReaderId: d,
                    contextLabelId: g.options.contextLabelId,
                    contextValue: g.options.leadSectionId,
                    Url: $("#txtUrl").val(),
                    NumberOfItems: $("#txtNumber").val()
                });
                e.save({}, {
                    error: function() {
                        p3.showModal(p3.Layout.Containers.Modal, "hide");
                        p3.displayError("Error saving reader")
                    },
                    success: function() {
                        p3.showModal(p3.Layout.Containers.Modal, "hide");
                        b.Us.refreshReader(true, g.options.leadSectionId, g.options.parentView, g.options.contextLabelId)
                    }
                })
            }
            return false
        },
        removeUrlValidation: function(c) {
            $(".rss-url-group").removeClass("error")
        },
        removeNumberValidation: function(c) {
            $(".rss-num-group").removeClass("error")
        }
    });
    b.Us.refreshReader = function(d, e, g, c) {
        var f = new b.Ms.RssReader({
            leadSectionId: e,
            contextLabelId: c
        });
        f.fetch({
            success: function() {
                g.options.editMode = d;
                g.options.reader = f;
                g.renderTemplate(d)
            },
            error: function() {
                p3.displayError("Error loading reader")
            }
        })
    }
}(p3.module("lms/rssreader")));
(function(d) {
    var c = p3.module("shared/datepicker"),
        a = p3.module("cms/shared/content"),
        b = p3.Us.Culture,
        e = p3.module("system/shared/style");
    d.Ms.Settings = Bbm.extend({
        urlRoot: "scoreboardsettings/settingsget"
    });
    d.Ms.SettingsSave = Bbm.extend({
        urlRoot: "scoreboardsettings/settingssave"
    });
    d.Ms.NavSettings = Bbm.extend({
        idAttribute: "SchoolId",
        urlRoot: "navsettings/edit"
    });
    d.Ms.NavSettingsGet = Bbm.extend({
        idAttribute: "SchoolId",
        urlRoot: "navsettings/view"
    });
    d.Cs.AthleticScoreboard = Bbc.extend({
        initialize: function(f, g) {
            this.lookupDate = g.lookupDate;
            this.endDate = g.endDate
        },
        url: function() {
            return aP + "datadirect/DashboardScoreboardGet/?format=json&lookupDate=" + this.lookupDate + "&endDate=" + this.endDate
        },
        parse: function(g) {
            var f = [];
            if (d.Data.ViewType == 1) {
                _.each(g, function(h) {
                    var i, j = _.find(f, function(l) {
                            return l.ath_schedule_id === h.ath_schedule_id
                        }),
                        k;
                    if (j === undefined) {
                        j = h;
                        f.push(j);
                        k = b.getDate(h.schedule_date);
                        j.display_date = b.displayDate(k, "longDate");
                        if (h.news_id || h.result || h.score) {
                            j.edit = true
                        }
                    }
                    i = j.opponents;
                    if (i === undefined || i === null) {
                        i = [];
                        j.opponents = i
                    }
                    i.push({
                        name: h.name,
                        result: h.result,
                        score: h.score,
                        score_vs: h.score_vs
                    })
                })
            } else {
                f = g
            }
            return f
        }
    });
    d.Vs.LayoutView = Bb.View.extend({
        template: "scoreboard/scoreboard.layout.template.html",
        initialize: function() {
            this.Containers = {};
            if (_.isUndefined(d.Data.DateView)) {
                d.Data = {};
                d.Data.DateView = 0;
                d.Us.getRange();
                var f = new d.Ms.Settings();
                f.fetch({
                    async: false,
                    error: function() {
                        p3.displayError("Error getting settings")
                    },
                    success: function() {
                        if (f.get("DefaultGrid")) {
                            d.Data.ViewType = 0
                        } else {
                            d.Data.ViewType = 1
                        }
                        if (f.get("LogoId") > 0) {
                            d.Data.DefaultLogo = f.get("Filename")
                        } else {
                            d.Data.DefaultLogo = ""
                        }
                    }
                })
            }
        },
        render: function(f) {
            p3.setTitle("Scoreboard");
            var g = this;
            $(f).html(g.el);
            g.renderTemplate()
        },
        renderTemplate: function() {
            var f = this;
            p3.fT(f.template, function(g) {
                f.$el.html(g({}));
                f.Containers.Header = $("#score-header");
                f.Containers.Results = $("#score-results");
                f.renderHeader();
                f.renderScoreboard()
            })
        },
        renderHeader: function() {
            var g = this,
                f = new d.Vs.Header({});
            p3.rV(f, g.Containers.Header, true);
            f.on("DateRangeChanged", function() {
                g.renderScoreboard()
            });
            f.on("ViewTypeChanged", function() {
                g.renderScoreboard()
            })
        },
        renderScoreboard: function() {
            var j = this,
                i, f, h, g;
            if (d.Data.DateView == 2) {
                i = d.Data.CustomStart;
                f = d.Data.CustomEnd
            } else {
                i = d.Data.StartDate;
                f = d.Data.EndDate
            }
            h = new d.Cs.AthleticScoreboard({}, {
                lookupDate: b.getDateString(i).ApiFormat(),
                endDate: b.getDateString(f).ApiFormat()
            });
            g = new d.Vs.Scoreboard({
                parentView: j,
                scores: h
            });
            h.fetch({
                success: function() {
                    p3.rV(g, j.Containers.Results, true)
                },
                error: function() {
                    p3.displayError("Error loading scoreboard")
                }
            })
        }
    });
    d.Vs.Scoreboard = Bb.View.extend({
        template: "dashboard/dashboard.athletics.scoreboard.template.html",
        events: {},
        renderTemplate: function() {
            var h = this,
                f, g;
            if (h.collection.length > 0) {
                f = 0;
                if (d.Data.ViewType == 0) {
                    h.collection.each(function(i) {
                        if (i.get("ath_schedule_id") != f) {
                            f = i.get("ath_schedule_id");
                            g = [];
                            i.set("opponents", g);
                            i.set("haveOpponent", (i.get("sort_order") != null))
                        } else {
                            i.set("hide", true)
                        }
                        g.push({
                            name: i.get("name"),
                            result: i.get("result"),
                            score: i.get("score"),
                            score_vs: i.get("score_vs")
                        });
                        var j = b.getDate(i.get("schedule_date"));
                        i.set("display_date", b.displayDate(j, "longDate"))
                    })
                }
                if (d.Data.ViewType == 1) {
                    h.template = "scoreboard/scoreboard.list.template.html"
                }
                p3.fT(h.template, function(i) {
                    h.$el.html(i({
                        events: h.collection.toJSON(),
                        schoolId: p3.Data.SchoolContext.get("SchoolInfo").SchoolId,
                        schoolName: p3.Data.SchoolContext.get("SchoolInfo").SchoolName,
                        viewOnly: true,
                        DefaultLogo: d.Data.DefaultLogo
                    }));
                    $(".btn-add").bind("click", function(j) {
                        h.showAddDialog(j)
                    });
                    $(".btn-edit").bind("click", function(j) {
                        h.showEditDialog(j)
                    })
                });
                p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.Isotope, function() {
                    window.setTimeout(function() {
                        $(".scoreboard-container").isotope({
                            itemSelector: ".score-container"
                        });
                        $(".scoreboard-container").imagesLoaded(function() {
                            $(".scoreboard-container").isotope({
                                itemSelector: ".score-container"
                            })
                        })
                    }, 200)
                })
            } else {
                h.$el.html('<h4 style="margin-left:10px;">There are not any scoreboard results available for the date range you have selected.</h4>')
            }
        },
        initialize: function() {
            var f = this;
            f.parentView = f.options.parentView;
            f.collection = f.options.scores
        },
        render: function(f) {
            $(f).append(this.el);
            this.renderTemplate()
        }
    });
    d.Vs.Header = Bb.View.extend({
        template: "scoreboard/scoreboard.header.template.html",
        events: {
            "click #this-week-button": "thisWeekClick",
            "click #last-week-button": "lastWeekClick",
            "click #custom-range-button": "customRangeClick",
            "click #scoreboard-list-button": "scoreboardListClick",
            "click #scoreboard-grid-button": "scoreboardGridClick",
            "click .dropdown-menu.range-dropdown": "rangeClick",
            "change #range-start-date": "setDateRange",
            "change #range-end-date": "setDateRange"
        },
        renderTemplate: function() {
            var h = this,
                g, f;
            if (d.Data.CustomStart && d.Data.CustomStart != "undefined") {
                g = b.getDateString(d.Data.CustomStart)
            }
            if (d.Data.CustomEnd && d.Data.CustomEnd != "undefined") {
                f = b.getDateString(d.Data.CustomEnd)
            }
            p3.fT(h.template, function(i) {
                h.$el.html(i({
                    dateType: d.Data.DateView,
                    viewType: d.Data.ViewType,
                    start: g,
                    end: f
                }))
            })
        },
        render: function(f) {
            $(f).append(this.el);
            this.renderTemplate();
            window.setTimeout(function() {
                c.Us.initialize(".date-input")
            }, 400)
        },
        thisWeekClick: function(f) {
            $(".scoreboard-view-item").removeClass("active");
            $("#this-week-item").addClass("active");
            d.Data.DateView = 0;
            $(".range-dropdown").hide();
            d.Us.getRange();
            this.trigger("DateRangeChanged");
            return false
        },
        lastWeekClick: function(f) {
            $(".scoreboard-view-item").removeClass("active");
            $("#last-week-item").addClass("active");
            d.Data.DateView = 1;
            $(".range-dropdown").hide();
            d.Us.getRange();
            this.trigger("DateRangeChanged");
            return false
        },
        customRangeClick: function(f) {
            if (!$("#custom-range-button").hasClass("active") && !_.isUndefined(d.Data.CustomStart) && !_.isUndefined(d.Data.CustomEnd)) {
                d.Data.DateView = 2;
                $(".scoreboard-view-item").removeClass("active");
                $("#custom-range-item").addClass("active");
                this.trigger("DateRangeChanged")
            }
            $(".range-dropdown").toggle();
            return false
        },
        scoreboardListClick: function(f) {
            $("#scoreboard-grid-item").removeClass("active");
            $("#scoreboard-list-item").addClass("active");
            d.Data.ViewType = 1;
            $(".range-dropdown").hide();
            this.trigger("ViewTypeChanged");
            return false
        },
        scoreboardGridClick: function(f) {
            $("#scoreboard-grid-item").addClass("active");
            $("#scoreboard-list-item").removeClass("active");
            d.Data.ViewType = 0;
            $(".range-dropdown").hide();
            this.trigger("ViewTypeChanged");
            return false
        },
        setDateRange: function(f) {
            var i = true,
                h, g;
            if ($("#range-start-date").val() == "") {
                i = false
            } else {
                h = b.getDate($("#range-start-date").val())
            }
            if ($("#range-end-date").val() == "") {
                i = false
            } else {
                g = b.getDate($("#range-end-date").val())
            }
            if (i) {
                $(".scoreboard-view-item").removeClass("active");
                $("#custom-range-item").addClass("active");
                d.Data.DateView = 2;
                d.Data.CustomStart = h;
                d.Data.CustomEnd = g;
                this.trigger("DateRangeChanged");
                $(".range-dropdown").hide()
            }
        },
        rangeClick: function(f) {
            f.preventDefault();
            f.stopPropagation()
        }
    });
    d.Vs.Settings = Bb.View.extend({
        template: "scoreboard/scoreboard.settings.template.html",
        events: {
            "click #btn-show-yes": "showClick",
            "click #btn-show-no": "hideClick",
            "click #btn-list-view": "listClick",
            "click #btn-grid-view": "gridClick",
            "click #btn-change-logo": "changeLogo"
        },
        renderTemplate: function() {
            var f = this;
            p3.fT(f.template, function(g) {
                f.$el.html(g({
                    DefaultGrid: f.settings.get("DefaultGrid"),
                    ShowScoreboard: f.navSettings.get("ShowScoreboard"),
                    LogoId: f.settings.get("LogoId"),
                    Filename: f.settings.get("Filename"),
                    imagePath: p3.Config.FtpImagePath + "logo/"
                }))
            })
        },
        initialize: function() {
            var f = this;
            f.getSettings();
            this.navSettings = new d.Ms.NavSettings({
                SchoolId: p3.Data.SchoolContext.get("SchoolInfo").SchoolId
            });
            this.navSettings.fetch({
                async: false,
                error: function() {
                    p3.displayError("Error getting nav settings")
                }
            })
        },
        render: function(f) {
            var g = this;
            $(f).html(g.el);
            this.renderTemplate()
        },
        showClick: function(f) {
            var g = this;
            g.saveNavSettings(1)
        },
        hideClick: function(f) {
            var g = this;
            g.saveNavSettings(0)
        },
        listClick: function(f) {
            var g = this;
            g.settings.set("DefaultGrid", false);
            g.saveSettings()
        },
        gridClick: function(f) {
            var g = this;
            g.settings.set("DefaultGrid", true);
            g.saveSettings()
        },
        saveNavSettings: function(g) {
            var f = new d.Ms.NavSettings({
                SchoolId: p3.Data.SchoolContext.get("SchoolInfo").SchoolId,
                ShowScoreboard: g
            });
            f.save({}, {
                error: function() {
                    p3.displayError("Error saving nav settings.")
                }
            })
        },
        saveSettings: function() {
            this.settings.save({}, {
                error: function() {
                    p3.displayError("Error saving settings.")
                }
            })
        },
        changeLogo: function(f) {
            var i = this,
                h = new e.Cs.SchoolLogos(),
                g = new e.Ms.SchoolLogo();
            g.bind("sync", i.renderData, i);
            h.fetch({
                cache: true,
                success: function(k) {
                    p3.showModal(p3.Layout.Containers.Modal, {
                        backOnHide: false
                    });
                    var j = new d.Vs.EditLogo({
                        model: g,
                        collection: k,
                        settingsModel: i.settings,
                        layoutView: i
                    });
                    p3.rV(j, p3.Layout.Containers.Modal, true);
                    j.on("logoSaved", function() {
                        i.getSettings();
                        i.renderTemplate()
                    })
                }
            })
        },
        getSettings: function() {
            var g = this,
                f = new d.Ms.Settings();
            f.fetch({
                async: false,
                error: function() {
                    p3.displayError("Error getting settings")
                },
                success: function() {
                    var h = f.get("LogoId"),
                        i;
                    if (h < 0) {
                        h = 0
                    }
                    i = new d.Ms.SettingsSave({
                        DefaultGrid: f.get("DefaultGrid"),
                        LogoId: h,
                        Filename: f.get("Filename")
                    });
                    g.settings = i
                }
            })
        }
    });
    d.Vs.EditLogo = Bb.View.extend({
        template: "scoreboard/scoreboard.logo.edit.template.html",
        initialize: function(f) {
            var g = this;
            g.model.defaults = $.extend(true, {}, g.model.attributes);
            g.selector = g.options.selector || "name";
            Bb.Validation.bind(g, {
                forceUpdate: true,
                selector: g.selector
            })
        },
        events: {
            "click button.cancel": "cancelModel",
            "click button.save": "savePath",
            "click .logoGroup .btn": "selectLogo"
        },
        render: function(f) {
            var g = this;
            $(f).append(g.el);
            p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.jQueryUI, function() {
                p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.FileUpload, g.initializeFileUpload, g)
            });
            g.renderData()
        },
        renderData: function() {
            var f = this;
            p3.fT(f.template, function(h) {
                var g = {};
                g.model = f.model.toJSON();
                g.collection = f.options.collection.toJSON();
                g.layoutView = f.options.layoutView;
                g.dictionaries = f.options.dictionaries;
                g.variables = f.options.variables;
                g.options = f.options;
                g.imagePath = p3.Config.FtpImagePath + "logo/";
                g.canDrag = !window.head.browser.ie;
                g.editMode = false;
                g.selectedLogo = f.options.settingsModel.get("LogoId");
                f.$el.html(h(g));
                f.setFocus();
                $(".required-indicator").tooltip()
            })
        },
        initializeFileUpload: function(f) {
            window.setTimeout(function() {
                var g = p3.Us.Enum.UploadType.JPGPNG;
                $("#fileupload").fileupload({
                    url: p3.Config.RootPath + "utilities/FileTransferHandler.ashx",
                    autoUpload: true,
                    acceptFileTypes: g.ValidExtensions,
                    dropZone: ".dragRegion",
                    add: function(i, h) {
                        var j = p3.Us.FileTools.isValidFile(g, h.files[0].name);
                        if (j) {
                            h.submit()
                        } else {
                            f.$el.find("#invalid_filetype").append(p3.Us.FileTools.validateFiles(g, h))
                        }
                    }
                }).bind("fileuploaddone", function(i, h) {
                    f.showUploadedFile(i, h)
                })
            }, 100)
        },
        showUploadedFile: function(g, f) {
            if (this.$el.find(".alert-error").length > 0) {
                this.$el.find(".alert-error").remove()
            }
            this.$el.find(".uploaded-file-region img").attr("src", "/ftpimages/pdTemp/" + f.result[0].name);
            this.$el.find("#UploadedFile").attr("data-img-val", f.result[0].name);
            this.$el.find(".uploaded-file-region").show();
            this.$el.find("#UploadedFile").val(f.files[0].name);
            $(".logoGroup .btn").removeClass("active");
            this.uploadFile = true;
            window.setTimeout(function() {
                p3.setModalHeight(p3.Layout.Containers.Modal)
            }, 100)
        },
        savePath: function(f) {
            var h = this,
                g;
            if (h.uploadFile) {
                h.saveUpload()
            } else {
                g = $(".logo-select.active").data("id");
                h.updateSettings(g)
            }
        },
        saveUpload: function() {
            var h = this,
                g = this.$el.find("#UploadedFile").attr("data-img-val"),
                f;
            h.model.set({
                ShortDescription: h.$el.find("#ShortDescription").val(),
                Type: "image/pjpe",
                FileName: h.$el.find("#UploadedFile").val(),
                DefaultLogo: false,
                DefaultSeal: false,
                BannerInd: 0,
                UploadedFile: g
            });
            if (g == undefined) {
                if ($(".modal-body").find(".alert-error").length == 0) {
                    p3.Us.InfoMessage.ErrorBox("Please select a file.", ".modal-body", false);
                    p3.setModalHeight(p3.Layout.Containers.Modal)
                }
                h.$(".save").button("reset")
            } else {
                if (h.$el.find("#UploadedFile").val() == "") {
                    if ($(".modal-body").find(".alert-error").length == 0) {
                        f = h.$el.find("#UploadedFile");
                        f.closest("div.control-group").addClass("error");
                        f.addClass("box-validate");
                        p3.Us.InfoMessage.ErrorBox("Please enter a file name.", ".modal-body", false);
                        p3.setModalHeight(p3.Layout.Containers.Modal)
                    }
                    h.$(".save").button("reset")
                } else {
                    if (h.model.isValid(true)) {
                        h.model.save({}, {
                            success: function(i, j) {
                                if (i.get("LogoId") == 0) {
                                    if (!h.options.editMode) {
                                        h.model.clear({
                                            silent: true
                                        })
                                    }
                                    if ($(".modal-body").find(".alert-error").length == 0) {
                                        p3.Us.InfoMessage.ErrorBox("The file name for this image has already be used for one previously uploaded. Change the file name in order to upload this image.", ".modal-body", false);
                                        p3.setModalHeight(p3.Layout.Containers.Modal);
                                        h.$(".save").button("reset")
                                    }
                                } else {
                                    var k = i.get("LogoId");
                                    h.updateSettings(k)
                                }
                            },
                            error: function() {
                                p3.displayError("Error saving logo.");
                                h.$(".save").button("reset")
                            }
                        })
                    } else {
                        h.$(".save").button("reset")
                    }
                }
            }
        },
        selectLogo: function(g) {
            g.preventDefault();
            var f = $(g.currentTarget).hasClass("active");
            $(".logoGroup .btn").removeClass("active");
            if (!f) {
                $(g.currentTarget).addClass("active")
            }
        },
        cancelModel: function(f) {
            this.model.set(this.model.defaults)
        },
        updateSettings: function(f) {
            var g = this;
            g.options.settingsModel.set("LogoId", f);
            g.options.settingsModel.save({}, {
                success: function(h) {
                    g.trigger("logoSaved");
                    $("#site-modal").modal("hide");
                    p3.displaySiteMessage("Changes saved successfully.", "alert-success");
                    p3.Data.SchoolContext.fetch()
                },
                error: function() {
                    p3.displayError("Error saving logos.");
                    g.$(".save").button("reset")
                }
            })
        },
        setFocus: function() {
            $("form:first *:input[type!=hidden]:first").focus()
        }
    });
    d.Us.getRange = function() {
        if (d.Data.DateView < 2) {
            var i = b.localDateTime(),
                h, g, f;
            if (d.Data.DateView == 1) {
                i = new Date(i.setDate(i.getDate() - 7))
            }
            h = i.getDay();
            if (h == 0) {
                g = i
            } else {
                g = new Date(i.getTime());
                g = new Date(g.setDate(g.getDate() - h))
            }
            if (h == 6) {
                f = i
            } else {
                f = new Date(i.getTime());
                f = new Date(f.setDate(f.getDate() + (6 - h)))
            }
            d.Data.StartDate = g;
            d.Data.EndDate = f
        }
    };
    p3.router().route("Scoreboard", "Scoreboard", function() {
        p3.rV(new a.Vs.NewsSubNav({
            page: "scoreboard"
        }), p3.Layout.Containers.LowerNav, true);
        p3.renderMainPage(new d.Vs.LayoutView({}))
    });
    p3.router().route("ScoreboardSettings", "ScoreboardSettings", function() {
        p3.renderMainPage(new d.Vs.Settings())
    })
}(p3.module("lms/scoreboard")));
(function(n) {
    var m = p3.module("shared/task"),
        a = p3.module("cms/shared/announcement"),
        o = p3.module("cms/shared/text"),
        i = p3.module("cms/shared/link"),
        f = p3.module("cms/shared/download"),
        j = p3.module("cms/shared/media"),
        k = p3.module("cms/shared/news"),
        d = p3.Us.Culture,
        e = p3.module("shared/datepicker"),
        p = p3.module("shared/timepicker"),
        l = p3.module("shared/notification"),
        h = p3.module("cms/shared/grouppublish"),
        c = p3.module("LMS/classpage"),
        b = p3.module("LMS/Shared/AthleticsLiteScoreBoard"),
        g = p3.module("LMS/groupPageEdit");
    n.Ms.Sections = Bbm.extend({
        idAttribute: "SectionId",
        url: function() {
            return ""
        }
    });
    n.Cs.Sections = Bbc.extend({
        model: n.Ms.Sections,
        initialize: function(q, r) {
            this.sectionId = r.sectionId || 0
        },
        url: function() {
            return aP + "datadirect/SectionsForTeacher/?format=json"
        }
    });
    n.Ms.Results = Bbm.extend({
        url: function() {
            return ""
        }
    });
    n.Cs.Results = Bbc.extend({
        model: n.Ms.Results,
        initialize: function(q, r) {
            this.sectionId = r.sectionId || 0
        },
        url: function() {
            return aP + "datadirect/athleticresultsget/?format=json"
        }
    });
    n.Cs.OpponentResults = Bbc.extend({
        initialize: function(q, r) {
            this.athScheduleId = r.athScheduleId || 0
        },
        url: function() {
            return aP + "datadirect/OpponentResultsGet/?format=json"
        }
    });
    n.Ms.ResultsSave = Bbm.extend({
        url: function() {
            return aP + "athleticschedule/ResultsSave"
        }
    });
    n.Cs.Opponent = Bbc.extend({
        url: function() {
            return aP + "datadirect/athleticopponentsget/"
        }
    });
    n.Vs.TeamPageLayoutView = Bb.View.extend({
        template: "grouppage/layout.template.html",
        events: {
            "click #edit_on": "switchEditMode",
            "click #edit_off": "switchEditMode",
            "click #btn-import": "openImportDialog"
        },
        initialize: function() {
            var q = this;
            q.Containers = {};
            q.sectionId = q.options.sectionId || 0;
            q.leadSectionId = q.options.leadSectionId || 0;
            q.contentTypes = q.options.content;
            q.coachId = q.options.coachId || 0;
            q.userHasFullAccess = this.options.userHasFullAccess || 0;
            q.isOwner = this.options.isOwner || 0;
            q.isManager = this.options.isManager || 0;
            q.isEditor = false;
            q.schoolYears = new c.Cs.ExistingSchoolYears();
            q.schoolYears.fetch({
                error: function() {
                    p3.displayError("Error loading schoolYears")
                }
            });
            q.possibleOpponents = new n.Cs.Opponent();
            if (q.userHasFullAccess) {
                q.possibleOpponents.fetch({
                    error: function() {
                        p3.displayError("Error loading athletic opponents")
                    }
                })
            }
        },
        render: function(q) {
            var r = this;
            p3.fT(r.template, function(s) {
                p3.setTitle("Team Page");
                r.$el.html(s({
                    leftClass: "span6 col-md-6",
                    rightClass: "span6 col-md-6"
                }));
                $(q).html(r.el);
                r.Containers.LeftColumn = $("#left_column");
                r.Containers.RightColumn = $("#right_column");
                r.Containers.MediaContainer = $("#media_container");
                r.Containers.ManageContainer = $("#manage_container");
                $("#manage_container").hide();
                $(".nav-pills li:first").addClass("active");
                r.renderContent()
            })
        },
        renderContent: function() {
            var Z = this,
                T = 0,
                L = 0,
                O = 0,
                N = 0,
                Q = 0,
                M = 0,
                U = 0,
                S = 0,
                R = 0,
                P = 0,
                D, K, y, z, I, J, V, W, r, q, F, E, v, C, u, x, w, B, A, H, Y, t, G, X, s;
            this.contentTypes.each(function(aa) {
                y = aa.get("EditorAccess");
                switch (aa.get("ContentId")) {
                    case 2:
                        if (Z.userHasFullAccess || y) {
                            O = 2;
                            Z.isEditor = true
                        } else {
                            O = 1
                        }
                        break;
                    case 3:
                        if (Z.userHasFullAccess || y) {
                            N = 2;
                            Z.isEditor = true
                        } else {
                            N = 1
                        }
                        break;
                    case 6:
                        if (Z.userHasFullAccess || y) {
                            P = 2;
                            Z.isEditor = true
                        } else {
                            P = 1
                        }
                        break;
                    case 10:
                        if (Z.userHasFullAccess || y) {
                            L = 2;
                            Z.isEditor = true
                        } else {
                            L = 1
                        }
                        break;
                    case 31:
                        if (Z.userHasFullAccess || y) {
                            Q = 2;
                            Z.isEditor = true
                        } else {
                            Q = 1
                        }
                        break;
                    case 45:
                        if (Z.userHasFullAccess || y) {
                            R = 2;
                            Z.isEditor = true
                        } else {
                            R = 1
                        }
                        break;
                    case 71:
                        if (Z.userHasFullAccess || y) {
                            S = 2;
                            Z.isEditor = true
                        } else {
                            S = 1
                        }
                        break;
                    case 165:
                        if (Z.userHasFullAccess || y) {
                            M = 2;
                            Z.isEditor = true
                        } else {
                            M = 1
                        }
                        break;
                    case 167:
                        if (Z.userHasFullAccess || y) {
                            U = 2;
                            Z.isEditor = true
                        } else {
                            U = 1
                        }
                        break;
                    case 250:
                        if (Z.userHasFullAccess || y) {
                            T = 2;
                            Z.isEditor = true
                        } else {
                            T = 1
                        }
                        break;
                    default:
                        break
                }
            });
            K = new n.Cs.Sections({}, {
                sectionId: Z.sectionId
            });
            Z.sections = K;
            if (Z.userHasFullAccess || Z.isEditor) {
                if (Z.isOwner) {
                    z = 0
                } else {
                    if (Z.isManager) {
                        z = 1
                    } else {
                        z = 2
                    }
                }
                K.fetch({
                    async: false,
                    data: {
                        sectionId: Z.sectionId,
                        filterInd: z
                    },
                    success: function() {
                        if (K.length > 0) {
                            var aa = -1;
                            K.each(function(ab) {
                                if (ab.get("SectionId") == Z.sectionId) {
                                    ab.set("Primary", true)
                                }
                                if (ab.get("ContextLabelId") != aa) {
                                    ab.set("GroupHead", ab.get("Association"));
                                    ab.set("ShowHead", (aa == -1));
                                    aa = ab.get("ContextLabelId")
                                }
                            })
                        }
                    },
                    error: function() {
                        p3.displayError("Error loading coach sections")
                    }
                })
            }
            if (R || S) {
                I = new n.Cs.Results({}, {
                    sectionId: this.leadSectionId
                });
                J = new n.Vs.ScoreboardView({
                    editMode: false,
                    canEdit: (Z.userHasFullAccess || R == 2),
                    showScores: R,
                    showStats: S,
                    sections: K,
                    possibleOpponents: Z.possibleOpponents
                });
                J.parentView = Z;
                J.collection = I;
                p3.rV(J, this.Containers.LeftColumn, false);
                I.fetch({
                    data: {
                        sectionId: I.sectionId
                    },
                    success: function() {
                        J.renderTemplate()
                    },
                    error: function() {
                        p3.displayError("Error loading athletic results")
                    }
                })
            } else {
                $("#left_column").html("&nbsp")
            }
            this.scoreboardView = J;
            if (T) {
                V = new o.Cs.Text({}, {
                    sectionId: this.sectionId,
                    leadSectionId: this.leadSectionId,
                    contextLabelId: 3
                });
                W = new o.Vs.TextView({
                    collection: V,
                    contextLabelId: 3,
                    canEdit: (Z.userHasFullAccess || T == 2)
                });
                p3.rV(W, this.Containers.RightColumn, false);
                V.fetch({
                    success: function() {
                        W.renderTemplate(false)
                    },
                    error: function() {
                        p3.displayError("Error loading text")
                    }
                })
            }
            if (L) {
                q = new a.Cs.Announcement({}, {
                    sectionId: this.sectionId,
                    leadSectionId: this.leadSectionId,
                    editMode: false,
                    active: true,
                    future: false,
                    expired: false,
                    contextLabelId: 3
                });
                D = m.Us.getUrlById(300, "clid=2&cv=" + this.leadSectionId);
                r = new a.Vs.AnnouncementView({
                    collection: q,
                    manageTask: D,
                    leadSectionId: this.leadSectionId,
                    editMode: false,
                    active: true,
                    future: false,
                    expired: false,
                    sections: K,
                    contextLabelId: 3,
                    canEdit: (Z.userHasFullAccess || L == 2)
                });
                p3.rV(r, this.Containers.RightColumn, false);
                q.fetch({
                    error: function() {
                        p3.displayError("Error loading announcements")
                    }
                })
            }
            this.announceView = r;
            if (P) {
                E = new k.Cs.News({}, {
                    sectionId: this.sectionId,
                    leadSectionId: this.leadSectionId,
                    editMode: false,
                    active: true,
                    future: false,
                    expired: false,
                    contextLabelId: 3
                });
                D = m.Us.getUrlById(300, "clid=2&cv=" + this.leadSectionId);
                v = function() {
                    Z.scoreboardView.collection.fetch({
                        async: false,
                        data: {
                            sectionId: Z.leadSectionId
                        },
                        success: function() {
                            Z.scoreboardView.renderTemplate()
                        },
                        error: function() {
                            p3.displayError("Error loading athletic results")
                        }
                    })
                };
                C = false;
                if (Z.userHasFullAccess || P == 2) {
                    if (p3.Data.Context.findByTaskId(53222)) {
                        u = new k.Ms.NewsCategory();
                        u.fetch({
                            data: {
                                id: 0,
                                contextLabelId: 3
                            },
                            async: false,
                            success: function() {
                                C = (u.get("CommentApprovalInd") == 1)
                            },
                            error: function() {
                                p3.displayError("Error loading news category settings")
                            }
                        })
                    }
                }
                F = new k.Vs.NewsView({
                    collection: E,
                    manageTask: D,
                    leadSectionId: this.leadSectionId,
                    editMode: false,
                    active: true,
                    future: false,
                    expired: false,
                    sections: K,
                    canEdit: (Z.userHasFullAccess || P == 2),
                    contextLabelId: 3,
                    narrowChannel: true,
                    contextValue: this.leadSectionId,
                    deleteCallback: v,
                    manageComments: C
                });
                p3.rV(F, this.Containers.RightColumn, false);
                E.fetch({
                    error: function() {
                        p3.displayError("Error loading news")
                    }
                })
            }
            this.newsView = F;
            if (N) {
                w = new f.Cs.Download({}, {
                    sectionId: this.sectionId,
                    leadSectionId: this.leadSectionId,
                    contextLabelId: 3
                });
                D = m.Us.getUrlById(185, "clid=2&cv=" + this.leadSectionId);
                x = new f.Vs.DownloadView({
                    collection: w,
                    manageTask: D,
                    leadSectionId: this.leadSectionId,
                    editMode: false,
                    active: true,
                    future: false,
                    expired: false,
                    sections: K,
                    contextLabelId: 3,
                    canEdit: (Z.userHasFullAccess || N == 2)
                });
                p3.rV(x, this.Containers.RightColumn, false);
                w.fetch({
                    error: function() {
                        p3.displayError("Error loading downloads")
                    }
                })
            }
            this.downloadView = x;
            if (O) {
                A = new i.Cs.Link({}, {
                    sectionId: this.sectionId,
                    leadSectionId: this.leadSectionId,
                    contextLabelId: 3
                });
                D = m.Us.getUrlById(96, "clid=2&cv=" + this.leadSectionId);
                B = new i.Vs.LinkView({
                    collection: A,
                    manageTask: D,
                    leadSectionId: this.leadSectionId,
                    editMode: false,
                    active: true,
                    future: false,
                    expired: false,
                    sections: K,
                    contextLabelId: 3,
                    canEdit: (Z.userHasFullAccess || O == 2)
                });
                p3.rV(B, this.Containers.RightColumn, false);
                A.fetch({
                    error: function() {
                        p3.displayError("Error loading links")
                    }
                })
            }
            this.linkView = B;
            if (Z.userHasFullAccess || Z.isEditor) {
                p3.rV(new n.Vs.EditView({
                    sectionId: this.sectionId,
                    leadSectionId: this.leadSectionId
                }), this.Containers.ManageContainer, false)
            }
            if (M || Q || U) {
                H = false;
                Y = false;
                t = false;
                G = new j.Cs.Media({}, {
                    sectionId: this.sectionId,
                    leadSectionId: this.leadSectionId,
                    contentId: 31,
                    editMode: false,
                    active: true,
                    future: false,
                    expired: false,
                    contextLabelId: 3
                });
                X = new j.Cs.Media({}, {
                    sectionId: this.sectionId,
                    leadSectionId: this.leadSectionId,
                    contentId: 167,
                    editMode: false,
                    active: true,
                    future: false,
                    expired: false,
                    contextLabelId: 3
                });
                s = new j.Cs.Media({}, {
                    sectionId: this.sectionId,
                    leadSectionId: this.leadSectionId,
                    contentId: 165,
                    editMode: false,
                    active: true,
                    future: false,
                    expired: false,
                    contextLabelId: 3
                });
                if (Q) {
                    G.fetch({
                        success: function() {
                            var aa = -1;
                            G.each(function(ab) {
                                aa += 1;
                                if (aa > 0 && aa % 4 === 0) {
                                    ab.set("newRow", true)
                                }
                                if (ab.get("FileCount") == 1) {
                                    ab.set("CountLabel", "1 photo")
                                } else {
                                    ab.set("CountLabel", ab.get("FileCount") + " photos")
                                }
                                if (ab.get("NumberOfViews") == 1) {
                                    ab.set("ViewLabel", "1 view")
                                } else {
                                    ab.set("ViewLabel", ab.get("NumberOfViews") + " views")
                                }
                            });
                            H = true;
                            if (H && Y && t) {
                                Z.renderMedia(Z, M, U, Q, s, X, G, K)
                            }
                        },
                        error: function() {
                            p3.displayError("Error loading photos")
                        }
                    })
                } else {
                    H = true
                }
                if (M) {
                    s.fetch({
                        success: function() {
                            var ab = -1,
                                ac, aa;
                            s.each(function(ad) {
                                ab += 1;
                                if (ab > 0 && ab % 4 === 0) {
                                    ad.set("newRow", true)
                                }
                                ac = new Date(parseInt(ad.get("PublishDate").substr(6), 10));
                                aa = ac.getMonth() + "/" + ac.getDate() + "/" + ac.getFullYear();
                                ad.set("PublishDisplay", aa);
                                if (ad.get("FileCount") == 1) {
                                    ad.set("CountLabel", "1 audio clip")
                                } else {
                                    ad.set("CountLabel", ad.get("FileCount") + " audio clips")
                                }
                                if (ad.get("NumberOfViews") == 1) {
                                    ad.set("ViewLabel", "1 view")
                                } else {
                                    ad.set("ViewLabel", ad.get("NumberOfViews") + " views")
                                }
                            });
                            t = true;
                            if (H && Y && t) {
                                Z.renderMedia(Z, M, U, Q, s, X, G, K)
                            }
                        },
                        error: function() {
                            p3.displayError("Error loading audio")
                        }
                    })
                } else {
                    t = true
                }
                if (U) {
                    X.fetch({
                        success: function() {
                            var aa = -1;
                            X.each(function(ac) {
                                var ad, ab;
                                aa += 1;
                                if (aa > 0 && aa % 4 === 0) {
                                    ac.set("newRow", true)
                                }
                                ad = new Date(parseInt(ac.get("PublishDate").substr(6), 10));
                                ab = ad.getMonth() + "/" + ad.getDate() + "/" + ad.getFullYear();
                                ac.set("PublishDisplay", ab);
                                if (ac.get("FileCount") == 1) {
                                    ac.set("CountLabel", "1 video")
                                } else {
                                    ac.set("CountLabel", ac.get("FileCount") + " videos")
                                }
                                if (ac.get("NumberOfViews") == 1) {
                                    ac.set("ViewLabel", "1 view")
                                } else {
                                    ac.set("ViewLabel", ac.get("NumberOfViews") + " views")
                                }
                            });
                            Y = true;
                            if (H && Y && t) {
                                Z.renderMedia(Z, M, U, Q, s, X, G, K)
                            }
                        },
                        error: function() {
                            p3.displayError("Error loading videos")
                        }
                    })
                } else {
                    Y = true
                }
            }
            $("#manage_container").show()
        },
        renderMedia: function(G, B, E, C, q, F, z, A) {
            var s = (G.userHasFullAccess || C == 2),
                t = (G.userHasFullAccess || E == 2),
                r = (G.userHasFullAccess || B == 2),
                u = (B && q.length > 0),
                x = (E && F.length > 0),
                w = (C && z.length > 0),
                v = u || x || w,
                D, y;
            C = (w || s);
            B = (u || r);
            E = (x || t);
            D = (B && E) || (C && E) || (B && C);
            y = new j.Vs.MediaView({
                haveData: v,
                showTabs: D,
                audio: q,
                photo: z,
                video: F,
                showAudio: B,
                showVideo: E,
                showPhoto: C,
                sections: A,
                leadSectionId: G.leadSectionId,
                contextLabelId: 3,
                editPhoto: s,
                editVideo: t,
                editAudio: r
            });
            p3.rV(y, G.Containers.MediaContainer, false);
            y.renderTemplate();
            G.mediaView = y
        },
        switchEditMode: function(s) {
            var r = true,
                t = this,
                q;
            if (s.target.id == "edit_on") {
                $("a.btn.edit-btn").show();
                $("div.btn-manage").show();
                $("div.view-range").show();
                $(".edit-header").show();
                $("#edit_on").html("<h5>ON</h5>");
                $("#edit_on").attr("style", "border-color:#67b65c");
                $("#edit_off").html("OFF");
                $("#edit_off").attr("style", "");
                $(".announce-edit-button").show();
                $(".announce-delete-button").show();
                $(".tab-nodata").show();
                if ($(".tab-pane.active").length === 0) {
                    $(".tab-pane").first().addClass("active")
                }
                if (t.isOwner) {
                    $("#btn-import").show()
                }
            } else {
                r = false;
                $("a.btn.edit-btn").hide();
                $("div.btn-manage").hide();
                $("div.view-range").hide();
                $(".edit-header").hide();
                $("#edit_off").html("<h5>OFF</h5>");
                $("#edit_off").attr("style", "border-color:#67b65c");
                $("#edit_on").html("ON");
                $("#edit_on").attr("style", "");
                $(".announce-edit-button").hide();
                $(".announce-delete-button").hide();
                $(".tab-nodata").hide();
                if ($(".tab-nodata.active").length === 1) {
                    q = $("ul.nav-tabs").children(".inactive").first();
                    $(".tab-nodata.active").removeClass("active").addClass("inactive");
                    q.removeClass("inactive").addClass("active");
                    $(".tab-pane").removeClass("active");
                    $("#mediaPane_" + q.children("a").attr("href").substring(1)).addClass("active")
                }
                $("#btn-import").hide()
            }
            if (this.announceView && this.announceView.options.canEdit) {
                a.Us.refreshAnnouncements(r, this.sectionId, this.leadSectionId, this.announceView)
            }
            if (this.newsView && this.newsView.options.canEdit) {
                k.Us.refreshNews(r, this.sectionId, this.leadSectionId, this.newsView)
            }
            if (this.linkView && this.linkView.options.canEdit) {
                i.Us.refreshLinks(r, this.sectionId, this.leadSectionId, this.linkView)
            }
            if (this.downloadView && this.announceView.options.canEdit) {
                f.Us.refreshDownloads(r, this.sectionId, this.leadSectionId, this.downloadView)
            }
            if (this.mediaView.photoView && this.mediaView.options.editPhoto) {
                j.Us.refreshMediaTab(r, this.sectionId, this.leadSectionId, this.mediaView.photoView)
            }
            if (this.mediaView.audioView && this.mediaView.options.editAudio) {
                j.Us.refreshMediaTab(r, this.sectionId, this.leadSectionId, this.mediaView.audioView)
            }
            if (this.mediaView.videoView && this.mediaView.options.editVideo) {
                j.Us.refreshMediaTab(r, this.sectionId, this.leadSectionId, this.mediaView.videoView)
            }
            if (this.scoreboardView && this.scoreboardView.options.canEdit) {
                this.scoreboardView.switchEditMode(r)
            }
        },
        openImportDialog: function() {
            var r = this,
                q = new c.Vs.ImportContent({
                    schoolYears: r.schoolYears,
                    currentSections: r.sections,
                    leadSectionId: r.leadSectionId,
                    associationId: 2
                });
            q.on("save", function(s) {
                if (r.linkView && s.indexOf(2) !== -1) {
                    i.Us.refreshLinks(true, r.sectionId, r.leadSectionId, r.linkView)
                }
                if (r.downloadView && s.indexOf(3) !== -1) {
                    f.Us.refreshDownloads(true, r.sectionId, r.leadSectionId, r.downloadView)
                }
                if (r.mediaView) {
                    if (r.mediaView.photoView && s.indexOf(31) !== -1) {
                        j.Us.refreshMediaTab(true, r.sectionId, r.leadSectionId, r.mediaView.photoView)
                    }
                    if (r.mediaView.audioView && s.indexOf(165) !== -1) {
                        j.Us.refreshMediaTab(true, r.sectionId, r.leadSectionId, r.mediaView.audioView)
                    }
                    if (r.mediaView.videoView && s.indexOf(167) !== -1) {
                        j.Us.refreshMediaTab(true, r.sectionId, r.leadSectionId, r.mediaView.videoView)
                    }
                }
            });
            p3.rV(q, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal)
        }
    });
    n.Vs.EditView = Bb.View.extend({
        template: "grouppage/editbuilder.template.html",
        events: {},
        renderTemplate: function() {
            var q = this;
            p3.fT(q.template, function(r) {
                q.$el.html(r({}))
            })
        },
        render: function(q) {
            this.renderTemplate();
            $(q).append(this.el)
        }
    });
    n.Vs.EditResultsView = Bb.View.extend({
        template: "athleticteam/athleticteam.result.edit.template.html",
        events: {
            "click #btnSaveResults": "saveResult",
            "click #btnDeleteHighlight": "deleteHighlight",
            "click .result-type-button": "switchResultType",
            "click .opponent-link": "addOpponent",
            "click input[type=score]": "setScoreFocus"
        },
        setScoreFocus: function(q) {
            $(q.currentTarget).focus();
            q.preventDefault()
        },
        initialize: function() {
            var r = this,
                q;
            this.gameId = this.options.gameId || 0;
            this.parentView = this.options.parentView;
            this.existingData = this.options.existingData || false;
            this.newsId = this.options.newsId || 0;
            this.siteInd = this.options.siteInd;
            r.Containers = {};
            q = new n.Ms.Sections({
                PhotoTitleInd: 0,
                PhotoCaptionInd: 1,
                PhotoDescriptionInd: 0
            });
            r.options.photoItem = q;
            p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.jQueryUI, function() {
                p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.FileUpload, r.initializeFileUpload, r)
            });
            if (p3.Config.uiVersion === 3) {
                p3.Layout.Containers.Modal.on("shown.bs.modal", function() {
                    r.initializePlugins()
                })
            } else {
                p3.Layout.Containers.Modal.on("shown", function() {
                    r.initializePlugins()
                })
            }
        },
        initializePlugins: function() {
            window.setTimeout(function() {
                e.Us.initialize(".dp-non-pre-pop");
                p3.showHtmlEditor("fldDescription", p3.Us.Enum.HtmlEditorCategories.FULL, false, undefined, p3.Us.Enum.HtmlEditorEncoding.NUMERIC);
                p3.showHtmlEditor("fldBriefDescription", p3.Us.Enum.HtmlEditorCategories.FULL, false, undefined, p3.Us.Enum.HtmlEditorEncoding.NUMERIC);
                p3.setModalHeight(p3.Layout.Containers.Modal);
                p.Us.initialize(".time-picker-field");
                $("#photo_table tbody.sort-container").sortable({});
                $("#send_notif_label").tooltip()
            }, 400)
        },
        initializeFileUpload: function(q) {
            window.setTimeout(function() {
                $("#fileupload").fileupload({
                    url: p3.Config.RootPath + "utilities/FileTransferHandler.ashx",
                    autoUpload: true,
                    acceptFileTypes: /(\.|\/)(gif|jpe?g|png)$/i,
                    dropZone: ".dragRegion"
                }).bind("fileuploaddone", function(s, r) {
                    j.Us.mediaFileCompleted(s, r, "photo", q)
                }).bind("fileuploadadd", function(s, r) {
                    if (j.Us.mediaFileSelected(s, r, "photo")) {
                        r.submit()
                    }
                }).bind("fileuploadprogress", function(s, r) {
                    j.Us.mediaFileUpdateProgress(s, r, "tr.photo-item-row")
                })
            }, 300)
        },
        render: function(s) {
            var C = this,
                w = "",
                q = "",
                u = "",
                y = [],
                v = [],
                B = false,
                r = "",
                t = d.getDateString(d.localDateTime()),
                x, A, z;
            if (C.newsId > 0) {
                x = (C.options.isLite ? new b.Ms.News({}, {
                    newsId: C.newsId
                }) : new k.Ms.News({}, {
                    newsId: C.newsId
                }));
                x.fetch({
                    async: false,
                    error: function() {
                        p3.displayError("Error loading news")
                    },
                    success: function() {
                        var D;
                        w = x.get("Name");
                        B = x.get("CommentType") != 0;
                        y = x.get("PhotoList");
                        q = x.get("Author");
                        r = x.get("BriefDescription");
                        u = x.get("Description");
                        if (y.length > 0) {
                            for (D = 0; D < y.length; D++) {
                                y[D].Id = y[D].LargeFilename.split("_")[2].split(".")[0]
                            }
                        }
                    }
                });
                v = new k.Cs.NewsIndex({}, {
                    newsId: C.newsId
                });
                v.fetch({
                    async: false,
                    data: {
                        Id: v.newsId
                    },
                    success: function() {
                        v.each(function(E) {
                            var F;
                            if (E.get("PublishDate")) {
                                F = E.get("PublishDate").split(" ");
                                E.set("PublishDate", F[0]);
                                if (F[1] != "00:00:00") {
                                    E.set("PTime", F[1])
                                }
                                E.set("IsSelected", true)
                            }
                            if (E.get("ExpireDate")) {
                                F = E.get("ExpireDate").split(" ");
                                E.set("ExpireDate", F[0]);
                                if (F[1] != "00:00:00") {
                                    E.set("ETime", F[1])
                                }
                            }
                        });
                        var D = new k.Cs.NewsIndex({}, {
                            newsId: C.newsId
                        });
                        D = h.Us.buildPublishGroupList(null, v, 3);
                        v = D
                    },
                    error: function() {
                        p3.displayError("Error loading news index")
                    }
                })
            } else {
                v = C.parentView.options.sections;
                v.models[0].set("PublishDate", t)
            }
            C.photoList = y;
            A = new l.Cs.NotificationActive({}, {
                actionId: 45,
                pk: C.parentView.options.sections.sectionId
            });
            A.fetch({
                async: false,
                success: function() {
                    A.setNotificationProperties()
                },
                error: function() {
                    p3.displayError("Error loading notification settings")
                }
            });
            if (!C.options.possibleOpponents) {
                C.options.possibleOpponents = new n.Cs.Opponent();
                C.options.possibleOpponents.fetch({
                    async: false,
                    error: function() {
                        p3.displayError("Error loading athletic opponents")
                    }
                })
            }
            z = new n.Cs.OpponentResults({}, {
                athScheduleId: C.gameId
            });
            z.fetch({
                data: {
                    athScheduleId: z.athScheduleId
                },
                success: function() {
                    var H = false,
                        E = -1,
                        F = 0,
                        D = "",
                        G;
                    C.noResults = (z.length < 2);
                    z.each(function(I) {
                        E += 1;
                        if (I.get("result") && I.get("result").length > 0) {
                            var J = I.get("result");
                            I.set("result", J.charAt(0).toUpperCase() + J.substring(1))
                        }
                        if (I.get("opponent_id") === null) {
                            F = E
                        }
                        if (I.get("schedule_type") !== null) {
                            H = (I.get("schedule_type") == 1)
                        }
                        if (I.get("score_conversion_delete") && I.get("score_conversion_delete").length > 0) {
                            if (D.length > 0) {
                                D += ", "
                            }
                            D += I.get("score_conversion_delete")
                        }
                    });
                    C.thisSchool = z.models[F].toJSON();
                    C.conversionScore = D;
                    G = "";
                    if (C.siteInd == 0) {
                        G = "VS"
                    } else {
                        if (C.siteInd == 1) {
                            G = "@"
                        }
                    }
                    C.usePoints = H;
                    C.results = z;
                    C.siteText = G;
                    p3.fT(C.template, function(I) {
                        C.$el.html(I({
                            existingData: C.existingData,
                            canDrag: !window.head.browser.ie,
                            headline: w,
                            author: q,
                            description: u,
                            useComments: B,
                            PhotoList: y,
                            briefDescription: r,
                            newsId: C.newsId,
                            notifEnabled: A.enabled,
                            notifTooltip: A.tooltip,
                            isLite: C.options.isLite || false,
                            possibleOpponents: C.options.possibleOpponents.toJSON(),
                            usePoints: C.usePoints
                        }));
                        $(s).html(C.el);
                        C.groupView = new h.Vs.PublishView({
                            groups: v,
                            defaultDate: t,
                            showPublish: true,
                            showPublishTime: true,
                            showExpire: true,
                            showExpireTime: true,
                            showPrimary: true,
                            isEdit: C.existingData,
                            contentId: 6
                        });
                        window.setTimeout(function() {
                            p3.rV(C.groupView, $("#groups-container"), true);
                            window.setTimeout(function() {
                                p3.setModalHeight(p3.Layout.Containers.Modal);
                                if (C.parentView.options.sections) {
                                    e.Us.LoadPreSelDatePickers(C.parentView.options.sections.toJSON())
                                }
                            }, 1000);
                            C.Containers.ResultContainer = C.$("#result-list-container");
                            C.renderResults()
                        }, 100)
                    })
                },
                error: function() {
                    p3.displayError("Error loading opponent results")
                }
            })
        },
        dispose: function() {
            var q;
            q = tinyMCE.get("fldDescription");
            if (q) {
                q.remove()
            }
            q = tinyMCE.get("fldBriefDescription");
            if (q) {
                q.remove()
            }
        },
        validateNews: function() {
            var v = this,
                u = true,
                q, s, t = (v.newsId > 0 || v.noResults),
                r = true;
            if ($("#txtHeadline").val().length === 0) {
                u = false;
                r = false
            } else {
                t = true
            }
            q = tinyMCE.get("fldDescription");
            if (q) {
                q.save();
                if ($("#fldDescription").val().length > 0) {
                    t = true
                }
            }
            q = tinyMCE.get("fldBriefDescription");
            if (q) {
                q.save();
                if ($("#fldBriefDescription").val().length > 0) {
                    t = true
                }
            }
            if ($("#txtAuthor").val().length > 0) {
                t = true
            }
            if ($("tr.photo-item-row").length > 0) {
                t = true
            }
            if (t && u) {
                s = 1
            } else {
                if (t) {
                    if (!r) {
                        $(".news-headline-group").addClass("error")
                    }
                    s = 2
                } else {
                    s = 0
                }
            }
            return s
        },
        saveResult: function(q) {
            var A = this,
                z = true,
                v = [],
                t = "",
                r, w = [],
                x, u, s, y;
            $("#btnSaveResults").button("loading");
            if ($(".modal-body").children()[0].className == "alert alert-error") {
                $(".modal-body").find("div.alert-error:first").remove()
            }
            if (A.conversionScore.length > 0) {
                $(".opponent-score").each(function(B) {
                    if ($(this).val().length === 0) {
                        t = "Please update scores.";
                        z = false
                    }
                });
                if (z && !A.usePoints) {
                    $(".school-score").each(function(B) {
                        if ($(this).val().length === 0) {
                            t = "Please update scores.";
                            z = false
                        }
                    })
                }
            }
            if (z) {
                u = A.validateNews();
                if (u == 2) {
                    z = false
                } else {
                    if (u == 1) {
                        z = A.groupView.getSelectedGroupArray();
                        if (z) {
                            r = A.groupView.selectedArray
                        } else {
                            t = A.groupView.errorMessage
                        }
                        w = [];
                        $("tr.photo-item-row").each(function(C) {
                            var F = $(this).find("td:first").attr("pid").length ? $(this).find("td:first").attr("pid") : 0,
                                D, G, B, E;
                            if (F == 0) {
                                D = $(this).find("td:first").attr("tfn");
                                G = 0;
                                B = 0
                            } else {
                                for (s = 0; s < A.photoList.length; s++) {
                                    E = A.photoList[s];
                                    if (E.Id == F) {
                                        D = E.LargeFilename;
                                        B = E.LargeHeight;
                                        G = E.LargeWidth;
                                        break
                                    }
                                }
                            }
                            w.push({
                                DeleteInd: $(this).find(".photo-delete-check").is(":checked"),
                                caption: $(this).find(".photo-caption-box").val(),
                                photo_Id: F,
                                large_filename: D,
                                sort: C + 1,
                                pk: C + 1,
                                original_height: B,
                                original_width: G,
                                large_height: B,
                                large_width: G
                            })
                        })
                    }
                }
            }
            if (z) {
                if (!A.noResults) {
                    y = 0;
                    if (A.usePoints) {
                        y = 1
                    }
                    x = new n.Ms.ResultsSave({
                        schedule_id: A.gameId,
                        SendNotification: $("#send_notif_check").hasClass("active"),
                        schedule_type: y
                    });
                    A.collectOpponents(true, 0, "");
                    A.results.each(function(B) {
                        if (A.usePoints) {
                            v.push({
                                Id: B.get("opponent_id") > 0 ? B.get("opponent_id") : -1,
                                Score: B.get("score"),
                                WinLoss: B.get("opponent_id") > 0 ? "" : B.get("result")
                            })
                        } else {
                            if (B.get("opponent_id") > 0) {
                                v.push({
                                    Id: B.get("opponent_id"),
                                    Score: B.get("score"),
                                    WinLoss: B.get("result"),
                                    ScoreVersus: B.get("score_vs")
                                })
                            }
                        }
                    });
                    x.set("opponentList", v);
                    x.save({}, {
                        error: function() {
                            p3.showModal(p3.Layout.Containers.Modal, "hide");
                            p3.displayError("Error saving results")
                        },
                        success: function(B, C) {
                            if (u == 1) {
                                A.saveNews(r, w)
                            } else {
                                A.saveSuccessfull()
                            }
                        }
                    })
                } else {
                    if (u == 1) {
                        A.saveNews(r, w)
                    }
                }
            } else {
                $("#btnSaveResults").button("reset");
                if (t.length > 0) {
                    p3.Us.InfoMessage.ErrorBox(t, ".modal-body", false)
                }
            }
            return false
        },
        saveNews: function(r, t) {
            var u = this,
                s, q = 0;
            if (u.newsId == 0) {
                s = new k.Ms.NewsCreate({
                    news_id: 0,
                    ScheduleId: u.gameId
                })
            } else {
                s = new k.Ms.NewsUpdate({
                    news_id: u.newsId,
                    ScheduleId: u.gameId
                })
            }
            if ($("#chkComment").find(".active").hasClass("btn-approve")) {
                q = 1
            }
            s.set({
                headline: $("#txtHeadline").val(),
                author: $("#txtAuthor").val(),
                brief_description: $("#fldBriefDescription").val(),
                groups: r,
                photo_list: t,
                comment_type: q,
                description: $("#fldDescription").val()
            });
            s.save({}, {
                error: function() {
                    p3.showModal(p3.Layout.Containers.Modal, "hide");
                    p3.displayError("Error saving news")
                },
                success: function() {
                    u.saveSuccessfull()
                }
            })
        },
        saveSuccessfull: function() {
            var r = this,
                q;
            p3.showModal(p3.Layout.Containers.Modal, "hide");
            r.parentView.collection.fetch({
                async: false,
                data: {
                    sectionId: r.parentView.collection.sectionId
                },
                success: function() {
                    r.parentView.renderTemplate()
                },
                error: function() {
                    p3.displayError("Error loading athletic results")
                }
            });
            if (r.parentView.parentView.newsView) {
                q = r.parentView.collection.sectionId;
                k.Us.refreshNews(true, q, q, r.parentView.parentView.newsView)
            }
        },
        deleteHighlight: function() {
            var r = this,
                q;
            q = new k.Cs.NewsIndex({}, {
                newsId: r.newsId,
                groupId: 0
            });
            q.fetch({
                data: {
                    Id: q.newsId,
                    groupId: q.groupId
                },
                success: function() {
                    var u = '<div class="modal hide " tabindex="-1" id="delete-highlight-modal"></div>',
                        s, t;
                    $(u).modal();
                    s = function() {
                        var w, v;
                        r.newsId = 0;
                        $("#btnDeleteHighlight").hide();
                        $("#txtHeadline").val("");
                        $("#txtAuthor").val("");
                        $("#fldBriefDescription").val("");
                        v = tinyMCE.get("fldBriefDescription");
                        v.setContent("");
                        v.save();
                        $("#fldDescription").val("");
                        v = tinyMCE.get("fldDescription");
                        v.setContent("");
                        v.save();
                        $("#comment-yes-button").removeClass("active");
                        $("#comment-no-button").addClass("active");
                        $("#photo_table tbody").children().remove();
                        $(".group-header-row").each(function(x) {
                            if ($(this).children()[0].innerText.indexOf("Athletics") === -1) {
                                $(this).remove()
                            }
                        });
                        $('.group-row[data-contextLabel!="3"]').remove();
                        $(".group-row").each(function(x) {
                            if ($(this).find(".group-section-check").data("contextvalue") != r.parentView.collection.sectionId) {
                                $(this).remove()
                            }
                        });
                        $(".pub-date-box").val(d.getDateString(d.localDateTime()));
                        p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.FileUpload, r.initializeFileUpload, r);
                        $("#delete-highlight-modal").modal("hide");
                        $("delete-highlight-modal").remove();
                        r.parentView.collection.fetch({
                            async: false,
                            data: {
                                sectionId: r.parentView.collection.sectionId
                            },
                            success: function() {
                                r.parentView.renderTemplate()
                            },
                            error: function() {
                                p3.displayError("Error loading athletic results")
                            }
                        });
                        if (r.parentView.parentView.newsView) {
                            w = r.parentView.collection.sectionId;
                            k.Us.refreshNews(true, w, w, r.parentView.parentView.newsView)
                        }
                    };
                    t = q.length > 1;
                    p3.rV(new k.Vs.NewsDeleteView({
                        groups: q,
                        showRadios: t,
                        newsView: r,
                        Id: r.newsId,
                        groupId: 0,
                        confirmCallback: s,
                        contextValue: r.parentView.collection.sectionId
                    }), "#delete-highlight-modal", true)
                },
                error: function() {
                    p3.displayError("Error loading news index")
                }
            })
        },
        switchResultType: function(r) {
            var s = this,
                q;
            s.collectOpponents(false, 0, "");
            if (r.currentTarget.id == "versus-button") {
                s.usePoints = false
            } else {
                s.usePoints = true
            }
            q = tinyMCE.get("fldDescription");
            if (q) {
                q.save();
                q.remove();
                q = null
            }
            q = tinyMCE.get("fldBriefDescription");
            if (q) {
                q.save();
                q.remove();
                q = null
            }
            s.renderResults()
        },
        renderResults: function() {
            var r = this,
                q;
            q = new n.Vs.ResultsList({
                opponents: r.results,
                usePoints: r.usePoints,
                thisSchool: r.thisSchool,
                noResults: r.noResults,
                conversionScores: r.conversionScore,
                siteText: r.siteText
            });
            p3.rV(q, r.Containers.ResultContainer, true)
        },
        addOpponent: function(r) {
            var t = this,
                q = true,
                s = $(r.currentTarget).data("id");
            $("tr.result-row").each(function(u) {
                if ($(this).data("id") == s) {
                    q = false
                }
            });
            if (q) {
                t.collectOpponents(true, s, $(r.currentTarget).text());
                t.renderResults()
            }
            $(".btn-group.open").removeClass("open");
            $("#site-modal .modal-body").scrollTop(1);
            return false
        },
        collectOpponents: function(s, r, q) {
            var v = this,
                t, u = 0;
            v.results.reset();
            if (!v.usePoints) {
                v.results.add(v.thisSchool)
            }
            $(".result-row").each(function(w) {
                u += 1;
                t = new n.Ms.Results({
                    opponent_id: $(this).data("id"),
                    schedule_type: v.usePoints ? 1 : 0,
                    name: $(this).data("name"),
                    sort_order: u
                });
                if (s) {
                    if (v.usePoints) {
                        t.set("score", $(this).find(".opponent-score").val())
                    } else {
                        t.set("score", $(this).find(".school-score").val());
                        t.set("score_vs", $(this).find(".opponent-score").val())
                    }
                    if (!v.usePoints || !$(this).data("id")) {
                        if ($(this).find(".win-button").hasClass("active")) {
                            t.set("result", "Win")
                        } else {
                            if ($(this).find(".loss-button").hasClass("active")) {
                                t.set("result", "Loss")
                            } else {
                                if ($(this).find(".tie-button").hasClass("active")) {
                                    t.set("result", "Tie")
                                }
                            }
                        }
                    }
                }
                v.results.add(t)
            });
            if (r > 0) {
                if (v.usePoints && v.results.length === 0) {
                    v.results.add(v.thisSchool)
                }
                u += 1;
                t = new n.Ms.Results({
                    opponent_id: r,
                    schedule_type: v.usePoints ? 1 : 0,
                    name: q,
                    sort_order: u
                });
                v.results.add(t)
            }
            v.noResults = (v.results.length < 2)
        }
    });
    n.Vs.ResultsList = Bb.View.extend({
        template: "athleticteam/athleticteam.versus.result.list.template.html",
        events: {
            "click .delete-opponent-button": "deleteOpponent"
        },
        renderTemplate: function() {
            var r = this,
                q = "";
            if (r.options.usePoints) {
                r.template = "athleticteam/athleticteam.points.result.list.template.html"
            }
            if (r.options.opponents.length > 1) {
                if (r.options.opponents.models[1].get("score_conversion_delete") != null) {
                    q = r.options.opponents.models[1].get("score_conversion_delete")
                }
            }
            p3.fT(r.template, function(s) {
                r.$el.html(s({
                    opponents: r.options.opponents.toJSON(),
                    noResults: r.options.noResults,
                    thisSchool: r.options.thisSchool,
                    conversionScores: r.options.conversionScores,
                    siteText: r.options.siteText,
                    scoreConversion: q
                }));
                p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.jQueryUI, function() {
                    var t = function(u, v) {
                        v.children().each(function() {
                            $(this).width($(this).width())
                        });
                        return v
                    };
                    window.setTimeout(function() {
                        $(".sortContainer tbody").sortable({
                            items: "tr.result-row",
                            helper: t
                        })
                    }, 400)
                })
            })
        },
        render: function(q) {
            $(q).append(this.el);
            this.renderTemplate()
        },
        deleteOpponent: function(q) {
            $('.result-row[data-id="' + $(q.currentTarget).data("id") + '"]').remove()
        }
    });
    n.Vs.TeamScores = Bb.View.extend({
        template: "athleticteam/athleticteam.scores.template.html",
        events: {
            "click .result-edit-link": "editResults",
            "click #scores-show-all": "toggleItems"
        },
        renderTemplate: function() {
            var A = this,
                q = [],
                s = -1,
                t = 0,
                y, u, r, v, w = "",
                x = "",
                z = (p3.Config.uiVersion === 1) ? "2" : "0";
            A.collection.each(function(B) {
                r = (B.get("result") || B.get("score") || B.get("news_id") || (s >= 0 && q[s].gameId == B.get("ath_schedule_id")));
                if (A.editMode || r) {
                    w = "";
                    x = "";
                    v = B.get("result");
                    if (v) {
                        v = v.toUpperCase()
                    }
                    switch (v) {
                        case "WIN":
                            w = "teamWin";
                            x = "W";
                            break;
                        case "LOSS":
                            w = "teamLoss";
                            x = "L";
                            break;
                        case "TIE":
                            w = "teamTie";
                            x = "T";
                            break
                    }
                    y = "";
                    u = "";
                    if (B.get("ath_schedule_id") != t) {
                        s += 1;
                        t = B.get("ath_schedule_id");
                        var C = d.getDate(B.get("schedule_date"));
                        if (B.get("schedule_type") == "Game") {
                            if (B.get("score") != null) {
                                y = '<h4 style="line-height:25px;margin-top:0px;">' + B.get("score");
                                if (B.get("score_vs") && B.get("score_vs").length > 0) {
                                    y += "-" + B.get("score_vs")
                                }
                                y += "</h4>"
                            }
                            u = '<div style="margin-top:3px;">';
                            if (B.get("site_ind") == 0) {
                                u += "vs "
                            } else {
                                if (B.get("site_ind") == 1) {
                                    u += "@ "
                                }
                            }
                            if (B.get("opponent_id") != null) {
                                if (B.get("name") != null) {
                                    u += B.get("name")
                                } else {
                                    u += "&nbsp;"
                                }
                            }
                            u += "</div>"
                        } else {
                            y = '<div style="margin-top:5px;">';
                            if (B.get("score") != null && B.get("score").length > 0) {
                                y += B.get("score")
                            } else {
                                y += "&nbsp;"
                            }
                            y += "</div>";
                            u = '<div style="margin-top:5px;">';
                            if (B.get("name") != null) {
                                u += B.get("name")
                            } else {
                                u += "&nbsp;"
                            }
                            u += "</div>"
                        }
                        q.push({
                            gameId: t,
                            gameDate: d.displayDate(C, "shortDayMonthDate"),
                            isMeet: (B.get("schedule_type") == "Meet"),
                            newsId: B.get("news_id"),
                            haveResult: r,
                            siteInd: B.get("site_ind"),
                            description: B.get("short_description"),
                            opponent: u,
                            resultDisplay: v ? '<div class="' + w + ' pull-right" style="margin-top:' + z + 'px;margin-bottom:3px;margin-right:10px;">' + x + "</div>" : "",
                            scoreDisplay: y,
                            hide: s >= A.options.ItemCount
                        })
                    } else {
                        if (B.get("schedule_type") == "Game") {
                            if (B.get("score") && B.get("score").length > 0) {
                                y = '<h4 style="line-height:25px;margin-top:0px;">' + B.get("score")
                            }
                            if (B.get("score_vs") && B.get("score_vs").length > 0) {
                                y += "-" + B.get("score_vs")
                            }
                            y += "</h4>";
                            if (B.get("site_ind") == 0) {
                                u += "vs "
                            } else {
                                if (B.get("site_ind") == 1) {
                                    u += "@ "
                                }
                            }
                            u += B.get("name");
                            q[s].scoreDisplay += y;
                            q[s].resultDisplay += '<div class="' + w + ' pull-right" style="margin-top:2px;margin-bottom:3px;margin-right:10px;">' + x + "</div>";
                            q[s].opponent += '<div style="margin-top:7px;">' + u + "</div>"
                        } else {
                            if (B.get("score") != null) {
                                y = B.get("score") + "<br />"
                            } else {
                                y = "<br />"
                            }
                            u = B.get("name") + "<br />";
                            q[s].scoreDisplay += y;
                            q[s].opponent += u;
                            if (v && q[s].resultDisplay.length == 0) {
                                q[s].resultDisplay += '<div class="' + w + ' pull-right" style="margin-top:2px;margin-bottom:3px;margin-right:10px;">' + x + "</div>"
                            }
                        }
                    }
                }
            });
            p3.fT(A.template, function(C) {
                var B = 0;
                if (A.editMode) {
                    B = A.options.sections.sectionId
                }
                A.$el.html(C({
                    games: q,
                    editMode: A.editMode,
                    sectionId: B,
                    expanded: A.options.expanded,
                    showViewAll: q.length > A.options.ItemCount,
                    isNarrow: A.options.isNarrow,
                    customHeader: A.options.customHeader,
                    canEdit: A.options.canEdit
                }))
            })
        },
        initialize: function() {
            var q = this;
            q.editMode = q.options.editMode
        },
        render: function(q) {
            $(q).append(this.el)
        },
        editResults: function(s) {
            var t = this,
                q = $(s.currentTarget),
                r = q.hasClass("existing");
            p3.rV(new n.Vs.EditResultsView({
                gameId: q.data("gameid"),
                existingData: r,
                parentView: t,
                newsId: q.data("newsid"),
                siteInd: q.data("site"),
                possibleOpponents: t.options.possibleOpponents
            }), p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            return false
        },
        toggleItems: function(q) {
            var r = false;
            if ($("#scores-show-all").hasClass("show-data")) {
                r = true;
                $("#scores-show-all").removeClass("show-data").addClass("hide-data").html("Show Less");
                $(".score-region.initial-hide").show()
            } else {
                $("#scores-show-all").removeClass("hide-data").addClass("show-data").html("Show All");
                $(".score-region.initial-hide").hide()
            }
            this.options.expanded = r;
            this.trigger("showAll", r)
        }
    });
    n.Vs.Statistics = Bb.View.extend({
        template: "athleticteam/athleticteam.statistics.template.html",
        renderTemplate: function() {
            var y = this,
                t = 0,
                q = 0,
                s = 0,
                x = 0,
                u = 0,
                w = 0,
                r = "-",
                v = "-";
            y.collection.each(function(z) {
                if (z.get("result") && !z.get("scrimmage_ind")) {
                    var B, A;
                    A = z.get("league_ind");
                    B = z.get("result");
                    if (B) {
                        B = B.toUpperCase()
                    }
                    switch (B) {
                        case "WIN":
                            if (A) {
                                t += 1
                            } else {
                                x += 1
                            }
                            break;
                        case "LOSS":
                            if (A) {
                                q += 1
                            } else {
                                u += 1
                            }
                            break;
                        case "TIE":
                            if (A) {
                                s += 1
                            } else {
                                w += 1
                            }
                            break
                    }
                }
            });
            r = y.getPercentage(t, q, s);
            v = y.getPercentage(x, u, w);
            p3.fT(y.template, function(z) {
                y.$el.html(z({
                    leagueWins: t,
                    leagueLosses: q,
                    leagueTies: s,
                    nonLeagueWins: x,
                    nonLeagueLosses: u,
                    nonLeagueTies: w,
                    leaguePercentage: r,
                    nonLeaguePercentage: v,
                    isNarrow: y.options.isNarrow,
                    customHeader: y.options.customHeader
                }))
            })
        },
        render: function(q) {
            $(q).append(this.el)
        },
        getPercentage: function(t, q, s) {
            var r = "-";
            if (t + q + s > 0) {
                if (t == 0) {
                    r = ".000"
                } else {
                    if (q == 0) {
                        r = "1.000"
                    } else {
                        r = (t / (t + q)).toFixed(3).substring(1)
                    }
                }
            }
            return r
        }
    });
    p3.router().route("teampageedit/:sectionId/:leadSectionId", "teampageedit", function(r, q) {
        p3.setTitle("Edit Team Page");
        g.Us.loadPageEditor(q, r, 2, 3)
    })
}(p3.module("LMS/teampage")));
(function(q) {
    var o = p3.module("shared/tabs"),
        e = p3.module("shared/datepicker"),
        m = p3.module("shared/mediaviewer"),
        j = p3.module("cms/shared/link"),
        p = p3.module("cms/shared/text"),
        g = p3.module("cms/shared/download"),
        l = p3.module("cms/shared/media"),
        a = p3.module("shared/base"),
        d = p3.Us.Culture,
        b = p3.module("cms/shared/content"),
        i = p3.module("cms/shared/grouppublish"),
        k = p3.module("shared/ltitool"),
        n = p3.module("utilities/smodal"),
        h = p3.Us.Enum,
        f = p3.module("LMS/discussion"),
        c = p3.module("cms/shared/contentsubcategory");
    q.Ms.Topic = Bbm.extend({
        idAttribute: "Id",
        url: function() {
            return aP || ""
        }
    });
    q.Ms.TopicWarningSave = Bbm.extend({
        idAttribute: "TopicIndexId",
        urlRoot: "Topic/TopicWarningSave"
    });
    q.Cs.Topic = Bbc.extend({
        model: q.Ms.Topic,
        initialize: function(r, s) {
            this.sectionId = s.sectionId || 0;
            this.leadSectionId = s.leadSectionId || 0;
            this.active = s.active || false;
            this.future = s.future || false;
            this.expired = s.expired || false;
            this.shared = s.shared || false
        },
        url: function() {
            return aP + "datadirect/sectiontopicsget/" + this.leadSectionId + "/?format=json&active=" + this.active + "&future=" + this.future + "&expired=" + this.expired + "&sharedTopics=" + this.shared
        }
    });
    q.Cs.ExistingTopic = Bbc.extend({
        model: q.Ms.Topic,
        initialize: function(r, s) {
            this.sectionId = s.sectionId || 0;
            this.leadSectionId = s.leadSectionId || 0;
            this.active = s.active || false;
            this.future = s.future || false;
            this.expired = s.expired || false;
            this.shared = s.shared || false
        },
        url: function() {
            return aP + "datadirect/sectiontopicsget/" + this.leadSectionId + "/?format=json&active=" + this.active + "&future=" + this.future + "&expired=" + this.expired + "&sharedTopics=" + this.shared
        },
        filters: undefined,
        comparator: function(r) {
            return r.get("Name")
        },
        changeSort: function(r) {
            if (!_.isUndefined(this.filters)) {
                this.comparator = this.filters[r]
            }
        }
    });
    q.Ms.Sections = Bbm.extend({
        idAttribute: "SectionId",
        url: function() {
            return ""
        }
    });
    q.Cs.Sections = Bbc.extend({
        model: q.Ms.Sections,
        initialize: function(r, s) {
            this.sectionId = s.sectionId || 0
        },
        url: function() {
            return aP + "datadirect/SectionsForTeacher/?format=json"
        }
    });
    q.Ms.TopicSave = Bbm.extend({
        idAttribute: "TopicId",
        url: function() {
            var r;
            if (this.get("TopicId") > 0) {
                r = aP + "topic/update/?format=json"
            } else {
                r = aP + "topic/create/?format=json"
            }
            return r
        }
    });
    q.Cs.TopicCopy = Bbc.extend({
        model: Bbm.extend({
            idAttribute: "TopicId"
        }),
        url: function() {
            return aP + "topic/copy/?format=json"
        }
    });
    q.Ms.TopicGroup = Bbm.extend({
        idAttribute: "Id",
        url: function() {
            return aP || ""
        }
    });
    q.Cs.TopicGroup = Bbc.extend({
        model: q.Ms.TopicGroup,
        initialize: function(r, s) {
            this.topicId = s.topicId || 0
        },
        url: function() {
            return aP + "datadirect/topicget/" + this.topicId + "/?format=json"
        },
        useFullEditModal: function(s) {
            var r = this,
                t = false;
            r.each(function(u) {
                if (u.get("Primary") && u.get("ViewerIsOwnerInd")) {
                    t = true
                }
                if (u.get("Primary") && u.get("SectionId").toString() === s.toString()) {
                    t = true
                }
            });
            return t
        },
        isPrimarySection: function(s) {
            var r = this,
                t = false;
            s = s.toString();
            r.each(function(u) {
                if (s === u.get("SectionId").toString() && u.get("Primary")) {
                    t = true
                }
            });
            return t
        },
        getShareInfo: function(A) {
            var r = this,
                x = 0,
                z = "",
                y = "",
                s = "",
                w, v, t, u;
            A = A.toString();
            r.each(function(B) {
                v = B.get("SectionId").toString();
                t = B.get("GroupName");
                u = B.get("Primary");
                w = B.get("SchoolYear");
                if (w !== undefined && w !== null && w.length > 0) {
                    w = " (" + w + ")"
                } else {
                    w = ""
                }
                if (r.isPrimarySection(A)) {
                    if ((A !== v) && !u) {
                        x = x + 1;
                        y = "Shared with: ";
                        z = z + (z.length > 0 ? "; " : "") + t + w
                    }
                } else {
                    if ((A !== v) && u) {
                        x = x + 1;
                        y = "Shared from: ";
                        z = z + (z.length > 0 ? "; " : "") + t + w
                    }
                }
                if (u) {
                    if (s.length === 0) {
                        s = B.get("CreatedByUser")
                    }
                }
                if ((A === v) && (B.get("ShareWarningInd") === 0) && (q.Data.shareWarningDismissed === false)) {
                    q.Data.shareWarningDismissed = true
                }
            });
            return {
                createText: s,
                shareLabelText: y,
                shareText: z,
                shareCount: x
            }
        }
    });
    q.Ms.TopicDelete = Bbm.extend({
        idAttribute: "Id",
        url: function() {
            return aP + "topic/delete/" + this.get("Id") + "/?format=json&sections=" + this.get("sections") + "&option=" + this.get("option")
        }
    });
    q.Ms.TopicContent = Bbm.extend({
        url: function() {
            return aP || ""
        }
    });
    q.Cs.TopicContent = Bbc.extend({
        model: q.Ms.TopicContent,
        initialize: function(r, s) {
            this.topicId = s.topicId || 0;
            this.topicIndexId = s.topicIndexId || 0
        },
        url: function() {
            return aP + "datadirect/topiccontentget/" + this.topicId + "/?format=json&index_id=" + this.topicIndexId
        }
    });
    q.Ms.TopicWidgetCreate = Bbm.extend({
        idAttribute: "WidgetId",
        url: function() {
            return aP + "widget/create/?format=json"
        }
    });
    q.Ms.TopicWidgetUpdate = Bbm.extend({
        idAttribute: "WidgetId",
        url: function() {
            return aP + "widget/update/" + this.get("WidgetId") + "/?format=json"
        }
    });
    q.Ms.TopicWidgetDelete = Bbm.extend({
        idAttribute: "Id",
        url: function() {
            return aP + "widget/delete/" + this.get("Id") + "/?format=json"
        }
    });
    q.Ms.TopicContentSort = Bbm.extend({
        idAttribute: "TopicId",
        url: function() {
            return aP + "topic/updatecontentsort/?format=json"
        }
    });
    q.Ms.DiscussionItem = Bbm.extend({
        idAttribute: "MessageId",
        url: function() {
            return aP || ""
        }
    });
    q.Cs.DiscussionItem = Bbc.extend({
        model: q.Ms.DiscussionItem,
        initialize: function(r, s) {
            this.topicIndexId = s.topicIndexId || 0;
            this.lastDate = s.lastDate || ""
        },
        url: function() {
            return aP + "discussionitem/discussionitemsget/?format=json&contentIndexId=" + this.topicIndexId + "&viewDate=" + this.lastDate + "&contentId=386"
        }
    });
    q.Cs.DiscussionItemRefresh = a.Cs.Stream.extend({
        model: q.Ms.DiscussionItem,
        initialize: function(r, s) {
            this.topicIndexId = s.topicIndexId || 0;
            this.lastDate = s.lastDate || "";
            this.count = 0
        },
        add: function(w, x) {
            var t = [],
                r, v, s, u;
            if (w.length) {
                s = 0;
                u = _.max(w, function(y) {
                    return y.ModifiedDateTicks
                });
                if (u && u.ModifiedDateTicks) {
                    this.lastDate = u.ModifiedDateTicks
                }
                for (r = 0; r < w.length; r++) {
                    v = w[r];
                    switch (v.AuditAction) {
                        case "D":
                            $("#message_container_" + v.MessageId).remove();
                            break;
                        case "I":
                            if (_.isUndefined(this.get(v.MessageId))) {
                                s += 1;
                                t.push(v)
                            }
                            break;
                        case "U":
                            $("#msgDisplay_" + v.MessageId).html("<p>" + v.Message + "</p>");
                            $("#msgEdit_" + v.MessageId).text(v.Message);
                            break;
                        default:
                            break
                    }
                }
                this.count = this.count + s;
                if (s > 0) {
                    $("#messageLoadButton").html("(  <strong>" + this.count + "</strong> ) Load New Content");
                    $("#messageLoadRegion").show()
                }
            }
            return Bbc.prototype.add.call(this, t, x)
        },
        url: function() {
            return aP + "discussionitem/discussionitemsrefresh/?format=json&contentIndexId=" + this.topicIndexId + "&viewDate=" + this.lastDate + "&contentId=386"
        }
    });
    q.Ms.DiscussionItemCreate = Bbm.extend({
        idAttribute: "MessageId",
        url: function() {
            return aP + "discussionitem/create/?format=json"
        }
    });
    q.Ms.DiscussionItemUpdate = Bbm.extend({
        idAttribute: "MessageId",
        url: function() {
            return aP + "discussionitem/update/?format=json"
        }
    });
    q.Ms.DiscussionItemDelete = Bbm.extend({
        idAttribute: "Id",
        url: function() {
            return aP + "discussionitem/delete/" + this.get("Id") + "/?format=json&contextLabelId=27&contextValue=" + this.get("contextValue")
        }
    });
    q.Cs.ExistingSchoolYears = Bbc.extend({
        url: "datadirect/SchoolYearsGet/"
    });
    q.Cs.ExistingSections = Bbc.extend({
        url: "datadirect/TopicSectionsForTeacher/"
    });
    q.Cs.SchoolYearTermGet = Bbc.extend({
        url: function() {
            return aP + "datadirect/SchoolYearTermGet/"
        }
    });
    q.Cs.TopicContentTypes = Bbc.extend({
        model: Bbm,
        url: "DataDirect/TopicContentTypesGet"
    });
    q.Ms.TopicContentIndex = Bbm.extend({
        url: function() {
            return aP + "datadirect/topiccontentindexget?format=json&topicId=" + this.get("topicId") + "&contentId=" + this.get("contentId")
        }
    });
    q.Cs.ExistingContent = Bbc.extend({
        initialize: function(r, s) {
            this.contentId = s.contentId || 0;
            this.sectionId = s.sectionId || 0
        },
        url: function() {
            return aP + "datadirect/movecontentget?format=json&contentId=" + this.contentId + "&sectionId=" + this.sectionId
        },
        changeSort: function(r) {
            if (!_.isUndefined(this.filters)) {
                this.comparator = this.filters[r]
            }
        }
    });
    q.Ms.TopicContentMove = Bbm.extend({
        url: function() {
            return aP + "topic/movecontentsave/?format=json"
        }
    });
    q.Ms.RemoveContent = Bbm.extend({
        url: function() {
            return aP + "topic/removecontent/?format=json"
        }
    });
    q.Cs.SectionsByYear = Bbc.extend({
        url: "datadirect/AssignmentSectionsForTeacher/"
    });
    q.Ms.SetPriorities = Bbm.extend({
        url: function() {
            return aP + "topic/setpriorities"
        }
    });
    q.Cs.CurrentYearFaculty = Bbc.extend({
        url: "datadirect/CurrentYearFaculty/"
    });
    q.Cs.CopyableFaculty = Bbc.extend({
        url: "datadirect/GetCopyableTopicOwners/"
    });
    q.Vs.TopicManageView = Bb.View.extend({
        template: "topic/topic.manage.template.html",
        events: {
            "click input": "refreshTopics",
            "click .topic-add-button": "openAddModal",
            "click #import-topic-btn": "openImportModal",
            "click img.mediaContainer": "showImgTopicDetail",
            "click .fadeBox": "showTopicDescription",
            "click .topic-delete": "showTopicDelete",
            "click #set-priority-buton": "showPriorityDialog",
            "click .topic-share": "showTopicShare",
            "click .topic-publish-box": "showTopicPublish",
            "click .topic-share-edit": "showTopicPublish"
        },
        renderTemplate: function() {
            var t = this,
                s = p3.Data.Context.getSelectedPersona().Id,
                r = (s !== h.AppPersona.PARENT.Value && s !== h.AppPersona.STUDENT.Value && s !== h.AppPersona.FRIEND.Value && s !== h.AppPersona.ALUM.Value);
            t.options.studentId = t.options.studentId || 0;
            t.collection.fetch({
                success: function() {
                    if (t.collection.length > 0) {
                        var u = -1;
                        t.collection.each(function(v) {
                            u += 1;
                            if (u > 0 && u % 4 === 0) {
                                v.set("newRow", true)
                            }
                            if (v.get("TopicAuthorShare") && v.get("TopicAuthorShare").length > 0 && v.get("PublishDate") === null && v.get("TopicAuthorCopy") === null) {
                                v.set("ShowPublish", true)
                            }
                        })
                    }
                    p3.fT(t.template, function(v) {
                        t.$el.html(v({
                            topic: t.collection.toJSON(),
                            active: t.options.active,
                            future: t.options.future,
                            expired: t.options.expired,
                            shared: t.options.shared,
                            schoolId: p3.Data.SchoolContext.get("SchoolInfo").SchoolId,
                            canAdd: t.canEdit,
                            leadSectionId: t.options.leadSectionId,
                            sectionId: t.options.sectionId,
                            studentId: t.options.studentId,
                            displayTopicAuthorInfo: r
                        }))
                    });
                    window.setTimeout(function() {
                        $(".topicBox").each(function(w, v) {
                            if (v.scrollHeight === v.clientHeight) {
                                $("#topicFade_" + v.id.substring(9)).hide()
                            }
                        })
                    }, 100)
                },
                error: function() {
                    p3.displayError("Error loading current date")
                }
            })
        },
        initialize: function(u) {
            var y = this,
                x = new q.Cs.Topic({}, {
                    sectionId: this.options.sectionId,
                    leadSectionId: this.options.leadSectionId,
                    active: this.options.active,
                    future: this.options.future,
                    expired: this.options.expire,
                    shared: this.options.shared
                }),
                r, w, t, s, v;
            this.collection = x;
            this.userHasFullAccess = this.options.userHasFullAccess || false;
            this.isOwner = this.options.isOwner || false;
            this.isManager = this.options.isManager || false;
            this.content = this.options.content;
            this.canEdit = false;
            this.isEditor = false;
            if (this.userHasFullAccess) {
                this.canEdit = true
            } else {
                if (this.content) {
                    r = this.content.get(386);
                    if (r && r.get("EditorAccess")) {
                        this.canEdit = true;
                        this.isEditor = true
                    }
                }
            }
            w = new q.Cs.Sections({}, {
                sectionId: this.options.leadSectionId
            });
            this.sections = w;
            if (this.canEdit) {
                if (y.isOwner) {
                    t = 0
                } else {
                    if (y.isManager) {
                        t = 1
                    } else {
                        t = 2
                    }
                }
                w.fetch({
                    async: false,
                    data: {
                        sectionId: w.sectionId,
                        associationId: 1,
                        filterInd: t
                    },
                    error: function() {
                        p3.displayError("Error loading teacher sections")
                    },
                    success: function() {
                        if (w.length > 0) {
                            w.each(function(z) {
                                if (z.get("SectionId") == y.options.sectionId) {
                                    z.set("Primary", true)
                                }
                            })
                        }
                    }
                })
            }
            s = new g.Cs.FileTypes({}, {});
            p3.Data.fileTypes = s;
            s.fetch({
                error: function() {
                    p3.displayError("Error loading filetypes")
                }
            });
            v = new q.Cs.ExistingSchoolYears({}, {});
            this.schoolYears = v;
            v.fetch({
                error: function() {
                    p3.displayError("Error loading school years")
                }
            });
            if (_.isUndefined(q.Data)) {
                q.Data = {}
            }
            q.Data.LevelNum = u.levelNum;
            q.Data.DurationId = u.durationId;
            q.Data.Duration = null;
            q.Data.SchoolYear = u.schoolYearLabel;
            q.Data.contextLabelId = this.options.contextLabelId
        },
        render: function(r) {
            $(r).append(this.el);
            this.renderTemplate()
        },
        refreshTopics: function() {
            q.Us.refreshTopics(true, 0, this.options.leadSectionId, this)
        },
        openAddModal: function(r) {
            var s = new q.Ms.Topic({
                Id: 0
            });
            q.Us.showEditModal(s, this.sections, this)
        },
        openImportModal: function(r) {
            var t = this,
                s = new q.Vs.ImportWindow({
                    schoolYears: t.schoolYears,
                    sections: t.sections,
                    currentSection: t.options.sectionId,
                    leadSectionId: t.options.leadSectionId,
                    topicView: t
                });
            p3.rV(s, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal)
        },
        showImgTopicDetail: function(r) {
            p3.router().navigate("#topicdetail/" + r.currentTarget.id.substring(4) + "/" + this.options.leadSectionId + "/" + this.options.sectionId + "/" + $("#" + r.currentTarget.id).attr("tiid") + "/" + this.options.studentId + "/0", true);
            return false
        },
        showTopicDescription: function(t) {
            var u = t.currentTarget.id.substring(10),
                r = $("#topicBox_" + u),
                s = $("#topicFade_" + u).children()[0];
            if (r.hasClass("topicBox-expanded")) {
                r.removeClass("topicBox-expanded").addClass("topicBox");
                s.innerHTML = '<i class="p3icon-moreInfo"></i> Show Full Description'
            } else {
                r.removeClass("topicBox").addClass("topicBox-expanded");
                s.innerHTML = '<i class="p3icon-moreInfo"></i> Hide Full Description'
            }
            return false
        },
        showTopicDelete: function(s) {
            var w = this,
                r = $(s.currentTarget),
                t = r.data("id"),
                v = w.getTopic(t),
                u;
            u = v.length > 1;
            p3.rV(new q.Vs.TopicDeleteView({
                topicId: t,
                groups: v,
                showRadios: u,
                sectionId: w.sections.sectionId,
                leadSectionId: w.options.leadSectionId,
                topicView: w
            }), p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal, {});
            return false
        },
        showTopicShare: function(s) {
            var v = this,
                r = $(s.currentTarget),
                t = r.data("id"),
                u = v.getTopic(t);
            p3.rV(new q.Vs.ShareModal({
                topicId: t,
                leadSectionId: v.options.leadSectionId,
                groups: u,
                topicView: v
            }), p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal, {});
            return false
        },
        showTopicPublish: function(s) {
            var w = this,
                r = $(s.currentTarget),
                t = r.data("id"),
                v = w.getTopic(t),
                u = w.collection.find(function(x) {
                    return x.get("TopicID") == t
                });
            p3.rV(new q.Vs.PublishShareModal({
                topicId: t,
                leadSectionId: w.options.leadSectionId,
                groups: v,
                topicView: w,
                canEditTopicInd: u.get("AllowEdit")
            }), p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal, {});
            return false
        },
        getTopic: function(r) {
            var s = new q.Cs.TopicGroup({}, {
                topicId: r
            });
            s.fetch({
                data: {
                    id: r
                },
                async: false,
                error: function() {
                    p3.displayError("Error loading topic sections")
                }
            });
            return s
        },
        showPriorityDialog: function(r) {
            var t = this,
                s = new q.Vs.PriorityEditView({
                    leadSectionId: t.options.leadSectionId
                });
            p3.rV(s, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            s.on("priorityChanged", function() {
                t.refreshTopics()
            })
        }
    });
    q.Vs.TopicEditView = Bb.View.extend({
        template: "topic/topic.edit.template.html",
        events: {
            "click #btnSaveTopic": "saveTopic",
            "click #btnSaveAddTopic": "saveTopic",
            "click #btnSaveEditTopic": "saveTopic",
            "change #txtTitle": "removeTitleValidation",
            "click a.accordion-toggle": "accordionClick",
            initPlugins: "initPlugins"
        },
        renderTemplate: function() {
            var t = this,
                s, r;
            t.sharedGroups = [];
            t.groups = new q.Cs.TopicGroup({}, {
                topicId: t.options.topic.id
            });
            t.groups.remove(t.groups.at(0));
            if (t.options.groups.length > 0) {
                t.options.groups.each(function(u) {
                    if (t.options.topic.id > 0) {
                        if (u.get("TopicIndexId")) {
                            if (u.get("Primary")) {
                                if (u.get("PublishDate")) {
                                    u.set("PDate", u.get("PublishDate").split(" ", 1)[0]);
                                    u.set("PublishDate", u.get("PDate"));
                                    u.set("IsSelected", true)
                                }
                                if (u.get("ExpireDate")) {
                                    u.set("EDate", u.get("ExpireDate").split(" ", 1)[0]);
                                    u.set("ExpireDate", u.get("EDate"))
                                }
                                t.groups.add(u)
                            } else {
                                t.sharedGroups.push(u.toJSON())
                            }
                        }
                    } else {
                        u.set("TopicIndexId", 0);
                        u.set("SectionId", u.get("LeadSectionId"));
                        t.groups.add(u)
                    }
                })
            }
            if (t.options.topic.id > 0) {
                p3.fT(t.template, function(u) {
                    t.$el.html(u({
                        topic: t.options.topic.toJSON(),
                        defaultDate: t.options.defaultDate,
                        schoolId: p3.Data.SchoolContext.get("SchoolInfo").SchoolId,
                        canDrag: !window.head.browser.ie
                    }));
                    t.addGroupsView(true);
                    t.Containers = {};
                    t.Containers.shareContainer = $("#share-container");
                    t.addShareView()
                })
            } else {
                s = t.options.topicView.schoolYears;
                p3.fT(t.template, function(u) {
                    t.$el.html(u({
                        topic: t.options.topic.toJSON(),
                        defaultDate: t.options.defaultDate,
                        schoolId: p3.Data.SchoolContext.get("SchoolInfo").SchoolId,
                        canDrag: !window.head.browser.ie,
                        SchoolYears: s.toJSON()
                    }));
                    t.addGroupsView(false);
                    t.Containers = {};
                    t.Containers.shareContainer = $("#share-container");
                    t.addShareView()
                });
                r = s.where({
                    Current: true
                });
                if (r.length > 0) {
                    t.currentYear = r[0].get("Id")
                }
            }
            if (p3.Config.uiVersion === 3) {
                t.$el.trigger("initPlugins")
            }
        },
        initialize: function() {
            var r = this;
            p3.Layout.Containers.Modal.on("shown", function() {
                r.$el.trigger("initPlugins")
            })
        },
        initPlugins: function() {
            var r = $("#fldDescription");
            if (r.length === 0) {
                if (q._htmlEditorTimer) {
                    window.clearInterval(q._htmlEditorTimer);
                    q._htmlEditorTimer = null
                }
                q._htmlEditorTimer = window.setInterval(function() {
                    r = $("#fldDescription");
                    if (r.length > 0) {
                        p3.showHtmlEditor("fldDescription", p3.Us.Enum.HtmlEditorCategories.FULL, false, undefined, p3.Us.Enum.HtmlEditorEncoding.NUMERIC);
                        window.clearInterval(q._htmlEditorTimer);
                        q._htmlEditorTimer = null
                    }
                }, 100)
            } else {
                p3.showHtmlEditor("fldDescription", p3.Us.Enum.HtmlEditorCategories.FULL, false, undefined, p3.Us.Enum.HtmlEditorEncoding.NUMERIC)
            }
            if ($(".date-input").length < 2) {
                if (q._datepickerTimer) {
                    window.clearInterval(q._datepickerTimer);
                    q._datepickerTimer = null
                }
                q._datepickerTimer = window.setInterval(function() {
                    r = $("#fldDescription");
                    if ($("#fldDescription").length > 0) {
                        e.Us.initialize(".date-input");
                        window.clearInterval(q._datepickerTimer);
                        q._datepickerTimer = null
                    }
                }, 100)
            } else {
                e.Us.initialize(".date-input")
            }
        },
        render: function(r) {
            var s = this;
            $(r).append(this.el);
            this.renderTemplate();
            p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.jQueryUI, function() {
                p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.FileUpload, s.initializeFileUpload)
            })
        },
        dispose: function() {
            var r = tinyMCE.get("fldDescription");
            if (r) {
                r.remove()
            }
        },
        addGroupsView: function(r) {
            var s = this;
            s.groupView = new i.Vs.PublishView({
                groups: s.groups,
                defaultDate: s.options.defaultDate,
                showPublish: true,
                showExpire: true,
                isEdit: r,
                contentId: 386
            });
            window.setTimeout(function() {
                p3.rV(s.groupView, $("#groups-container"), true);
                window.setTimeout(function() {
                    p3.setModalHeight(p3.Layout.Containers.Modal)
                }, 1000)
            }, 100)
        },
        addShareView: function() {
            var r = this;
            r.shareView = new q.Vs.ShareView({
                groups: r.sharedGroups,
                topic: r.options.topic
            });
            p3.rV(r.shareView, r.Containers.shareContainer, true)
        },
        initializeFileUpload: function() {
            var t = false,
                r = $("#fileupload"),
                s = function() {
                    r.fileupload({
                        url: p3.Config.RootPath + "utilities/FileTransferHandler.ashx",
                        autoUpload: true
                    }).bind("fileuploadadd", function(v, u) {
                        t = l.Us.mediaFileSelected(v, u, "photo");
                        if (t) {
                            u.submit()
                        }
                    }).bind("fileuploaddone", function(v, u) {
                        if (t) {
                            $("#fileupload p.muted").removeClass("alert alert-error").html("Change Photo");
                            $(".topic-cover-image").attr("src", "/ftpimages/pdTemp/" + u.result[0].name)
                        } else {
                            $("#fileupload p.muted").addClass("alert alert-error").html("Unsupported image type, upload failed.")
                        }
                    })
                };
            if (r.length < 1) {
                if (q._fileuploadTimer) {
                    window.clearInterval(q._fileuploadTimer);
                    q._fileuploadTimer = null
                }
                q._fileuploadTimer = window.setInterval(function() {
                    if ($("#fldDescription").length > 0) {
                        s();
                        window.clearInterval(q._fileuploadTimer);
                        q._fileuploadTimer = null
                    }
                }, 100)
            } else {
                s()
            }
        },
        saveTopic: function(A) {
            var I = this,
                y = (A.target.id === "btnSaveAddTopic"),
                E = (A.target.id === "btnSaveEditTopic"),
                H = true,
                D = "",
                B, z, F, G, C, r = $("#btnSaveTopic"),
                s = $("#btnSaveAddTopic"),
                t = $("#btnSaveEditTopic"),
                w = (p3.Config.uiVersion === 1) ? $(".btn-gray.active") : $(".btn-layout.active"),
                x = $("#txtTitle"),
                u = $(".topic-cover-image"),
                v = $("#topic_edit_error_region");
            r.button("loading");
            s.button("loading");
            t.button("loading");
            if (w.length === 0) {
                H = false;
                D = "Please select a layout."
            }
            if (x.val().length === 0) {
                H = false;
                $(".topic-title-group").addClass("error")
            } else {
                if (H) {
                    H = I.groupView.getSelectedGroupArray();
                    if (H) {
                        B = I.groupView.selectedArray
                    } else {
                        D = I.groupView.errorMessage
                    }
                }
            }
            if (I.shareView.getSharedGroups()) {
                if (H) {
                    B = B.concat(I.shareView.sharedGroups)
                }
            } else {
                H = false;
                D += "<div>" + I.shareView.errorMessage + "<div>"
            }
            if (H) {
                z = tinyMCE.get("fldDescription");
                if (z) {
                    z.save()
                }
                F = new q.Ms.TopicSave({
                    TopicId: I.options.topic.id,
                    ContextLabelId: q.Data.contextLabelId,
                    OldThumbFilename: I.options.topic.get("ThumbFilename"),
                    AllowCopy: I.shareView.allowCopy
                });
                G = "";
                if (u.attr("src").indexOf("topicholder.png") === -1) {
                    G = u.attr("src")
                }
                F.set({
                    ShortDescription: x.val(),
                    LongDescription: $("#fldDescription").val(),
                    groups: B,
                    ThumbFilename: G,
                    LayoutId: w.data("layout")
                });
                F.save({}, {
                    error: function() {
                        p3.showModal(p3.Layout.Containers.Modal, "hide");
                        p3.displayError("Error saving topic")
                    },
                    success: function() {
                        var K, L, J;
                        if (E) {
                            I.doSaveEdit(F.get("TopicId"), I.options.topicView.options.leadSectionId)
                        } else {
                            if (y) {
                                K = new q.Ms.Topic({
                                    Id: 0
                                });
                                p3.rV(new q.Vs.TopicEditView({
                                    topic: K,
                                    groups: I.options.topicView.sections,
                                    defaultDate: I.options.defaultDate,
                                    topicView: I.options.topicView,
                                    detailPage: I.options.detailPage,
                                    callback: I.options.callback
                                }), p3.Layout.Containers.Modal, true);
                                e.Us.initialize(".date-input");
                                p3.showHtmlEditor("fldDescription", p3.Us.Enum.HtmlEditorCategories.FULL, false, undefined, p3.Us.Enum.HtmlEditorEncoding.NUMERIC);
                                p3.setModalHeight(p3.Layout.Containers.Modal)
                            } else {
                                if (!I.options.detailPage) {
                                    p3.showModal(p3.Layout.Containers.Modal, "hide")
                                }
                            }
                            if (I.options.detailPage) {
                                G = "";
                                if (I.options.topic.id > 0) {
                                    if (F.get("ThumbFilename")) {
                                        G = F.get("ThumbFilename")
                                    }
                                    K = new q.Ms.Topic({
                                        Id: I.options.topic.id,
                                        Name: F.get("ShortDescription"),
                                        Description: F.get("LongDescription"),
                                        ThumbFilename: G,
                                        LayoutId: F.get("LayoutId"),
                                        AllowCopy: I.shareView.allowCopy
                                    });
                                    I.options.topic = K;
                                    I.options.topicView.model = K;
                                    L = new q.Cs.TopicGroup({}, {
                                        topicId: I.options.topic.id
                                    });
                                    L.remove(L.at(0));
                                    I.options.topicView.options.topicGroups = L;
                                    I.options.topicView.topicGroups = L;
                                    for (C = 0; C < B.length; C++) {
                                        if (B[C].Selected) {
                                            J = new q.Ms.TopicGroup();
                                            L.add(J);
                                            if (B[C].ExpireDate) {
                                                J.set("ExpireDate", B[C].ExpireDate + " 1")
                                            }
                                            J.set("PublishDate", B[C].PublishDate + " 1");
                                            J.set("Selected", true);
                                            J.set("GroupName", B[C].GroupName);
                                            J.set("Primary", B[C].PrimaryInd);
                                            J.set("SectionId", B[C].ContextValue);
                                            J.set("TopicIndexId", 1);
                                            J.set("GroupName", B[C].GroupName);
                                            J.set("AllowEdit", B[C].AllowEdit);
                                            J.set("ContextLabelId", B[C].ContextLabelId)
                                        }
                                    }
                                    if (I.options.callback !== undefined) {
                                        I.options.callback()
                                    }
                                    p3.showModal(p3.Layout.Containers.Modal, "hide")
                                }
                            } else {
                                q.Us.refreshTopics(true, 0, I.options.topicView.options.leadSectionId, I.options.topicView)
                            }
                        }
                    }
                })
            } else {
                if (!H) {
                    r.button("reset");
                    s.button("reset");
                    t.button("reset");
                    if (D.length > 0) {
                        v.html(D);
                        v.addClass("alert").addClass("alert-error")
                    } else {
                        v.html("");
                        v.removeClass()
                    }
                }
            }
            return false
        },
        doSaveEdit: function(t, r) {
            var v = this,
                s = new q.Cs.TopicGroup({}, {
                    topicId: t
                }),
                u;
            s.fetch({
                data: {
                    id: t
                },
                success: function() {
                    if (s.length > 0) {
                        s.each(function(w) {
                            if (w.get("SectionId") == r) {
                                u = w.get("TopicIndexId")
                            }
                        })
                    }
                    p3.router().navigate("#topicdetailedit/" + t + "/" + r + "/" + v.options.topicView.options.sectionId + "/" + u + "/" + v.options.topicView.options.studentId, true)
                },
                error: function() {
                    p3.displayError("Error getting topic index id")
                }
            })
        },
        removeTitleValidation: function(r) {
            $(".topic-title-group").removeClass("error")
        },
        accordionClick: function(s) {
            var r = $(".accordion-body");
            r.fadeToggle();
            return false
        }
    });
    q.Vs.TopicDetailLayoutView = Bb.View.extend({
        template: "topic/topic.detaillayout.template.html",
        events: {
            "click .topic-back-btn": "goBack"
        },
        isFixed: false,
        renderTemplate: function() {
            var v = this,
                u, t, r, s;
            v.options.contextLabelId = -1;
            p3.fT(v.template, function(w) {
                u = new q.Cs.TopicGroup({}, {
                    topicId: v.options.topicId
                });
                v.topicGroups = u;
                t = new q.Ms.Topic({
                    Id: v.options.topicId
                });
                v.topic = t;
                u.fetch({
                    data: {
                        id: v.topicGroups.Id
                    },
                    success: function() {
                        var x;
                        if (u.length > 0) {
                            r = -1;
                            u.each(function(y) {
                                r += 1;
                                x = y.get("SectionId").toString();
                                if (x === v.options.sectionId || x === v.options.leadSectionId) {
                                    t.set("Name", y.get("Name"));
                                    t.set("Description", y.get("Description"));
                                    t.set("ThumbFilename", y.get("ThumbFilename"));
                                    t.set("LayoutId", y.get("LayoutId"));
                                    v.options.contextLabelId = y.get("ContextLabelId")
                                } else {
                                    if (r === 0) {
                                        t.set("Name", y.get("Name"));
                                        t.set("Description", y.get("Description"));
                                        t.set("ThumbFilename", y.get("ThumbFilename"));
                                        t.set("LayoutId", y.get("LayoutId"));
                                        v.options.contextLabelId = y.get("ContextLabelId")
                                    }
                                }
                            })
                        }
                        s = q.Us.buildRows(t.get("LayoutId"));
                        v.$el.html(w({
                            row: s
                        }));
                        v.outputContent(v.options.topicId, v.options.topicIndexId, t.get("ThumbFilename"), t.get("Name"), t.get("Description"))
                    },
                    error: function() {
                        p3.displayError("Error loading topic")
                    }
                })
            })
        },
        initialize: function() {
            this.enableScrollNav()
        },
        dispose: function() {
            $(document).off("scroll", this.processScroll)
        },
        render: function(r) {
            $(r).append(this.el);
            this.renderTemplate()
        },
        goBack: function(r) {
            var t = this,
                s;
            r.stopPropagation();
            r.preventDefault();
            s = q.Us.getBackToTopicsLink(t.options);
            if (s) {
                window.location = s
            } else {
                window.history.back()
            }
        },
        enableScrollNav: function(t) {
            var s = $(document),
                r = $(".subnavbar"),
                u = r.length && r.offset().top - 120;

            function v() {
                if (r.length === 0) {
                    r = $(".subnavbar");
                    u = r.length && r.offset().top - 120
                }
                var x = s.scrollTop(),
                    w = r.hasClass("subnavbar-fixed");
                if (x >= u && !w) {
                    r.addClass("subnavbar-fixed")
                } else {
                    if (x <= u && w) {
                        r.removeClass("subnavbar-fixed")
                    }
                }
            }
            s.on("scroll", v)
        },
        outputContent: function(v, w, s, t, r) {
            var x = this,
                u = new q.Cs.TopicContent({}, {
                    topicId: v,
                    topicIndexId: w
                });
            u.fetch({
                data: {
                    id: u.topicIndexId
                },
                success: function() {
                    var F, z, A, G, B, E, D = 0,
                        H = "",
                        y, C, I = (p3.Config.uiVersion === 3);
                    G = p3.Data.SchoolContext.get("SchoolInfo").SchoolId;
                    if (u.length > 0) {
                        u = q.Us.collpaseDownloads(u);
                        u.each(function(J) {
                            B = "";
                            E = true;
                            J.set("inProcessing", false);
                            J.set("AVAlbum", false);
                            J.set("FileDesc", "");
                            switch (J.get("ContentId")) {
                                case 1:
                                    break;
                                case 2:
                                    J.set("IconClass", "p3icon-topicLink");
                                    if (J.get("Url").indexOf("www.") === 0) {
                                        J.set("Url", "http://" + J.get("Url"))
                                    }
                                    if (J.get("LinkImage") && J.get("LinkImage").length > 0) {
                                        J.set("LinkImageUrl", "/ftpimages/" + G + "/link/" + J.get("LinkImage"))
                                    }
                                    if (J.get("HoverFileName") && J.get("HoverFileName").length > 0) {
                                        J.set("HoverImageUrl", "/ftpimages/" + G + "/link/" + J.get("HoverFileName"))
                                    }
                                    break;
                                case 3:
                                    J.set("IconClass", "p3icon-topicDownload");
                                    J.set("index", D);
                                    J.set("outputSubCat", true);
                                    H = J.get("GenericSettings");
                                    y = J.get("AdditionalItems");
                                    for (C = 0; C < y.length; C++) {
                                        D = D + 1;
                                        y[C].index = D;
                                        if (H != y[C].GenericSettings && y[C].SubCategory && y[C].SubCategory.length > 0) {
                                            y[C].outputSubCat = true
                                        } else {
                                            y[C].outputSubCat = false
                                        }
                                        H = y[C].GenericSettings
                                    }
                                    break;
                                case 31:
                                    J.set("IconClass", "p3icon-topicPhoto");
                                    break;
                                case 165:
                                    J.set("showViewer", true);
                                    J.set("IconClass", "p3icon-topicAudio");
                                    if (!J.get("FilesProcessed")) {
                                        E = false
                                    }
                                    if (J.get("FilesInProcessing") > 0) {
                                        J.set("inProcessing", true)
                                    }
                                    J.set("AVAlbum", true);
                                    if (J.get("TotalFiles") == 1) {
                                        J.set("FileDesc", "Clip")
                                    } else {
                                        J.set("FileDesc", "Clips")
                                    }
                                    if (J.get("FileName")) {
                                        J.set("FileName", "/ftpimages/" + G + "/audio/" + J.get("FileName"))
                                    } else {
                                        J.set("FileName", "/ftpimages/999/podium/style1/icons/audioDefault.png")
                                    }
                                    break;
                                case 167:
                                    J.set("showViewer", true);
                                    J.set("IconClass", "p3icon-topicVideo");
                                    if (!J.get("FilesProcessed")) {
                                        E = false
                                    }
                                    if (J.get("FilesInProcessing") > 0) {
                                        J.set("inProcessing", true)
                                    }
                                    J.set("AVAlbum", true);
                                    if (J.get("TotalFiles") == 1) {
                                        J.set("FileDesc", "Video")
                                    } else {
                                        J.set("FileDesc", "Videos")
                                    }
                                    if (J.get("FileName")) {
                                        J.set("FileName", "/ftpimages/" + G + "/video/" + J.get("FileName"))
                                    }
                                    break;
                                case 387:
                                    J.set("IconClass", "p3icon-topicWidget");
                                    J.set("Caption", J.get("ShortDescription"));
                                    J.set("Embed", "true");
                                    break;
                                case 404:
                                    J.set("thumb", s);
                                    break;
                                case 405:
                                    if (I) {
                                        B = '<div style="margin-bottom:10px;background-color:#fff;padding:10px;"><h2 style="margin-top:0px;">' + t + "</h2></div>"
                                    } else {
                                        B = '<div style="margin-bottom:10px;"><h2>' + t + "</h2></div>"
                                    }
                                    break;
                                case 406:
                                    if (r == null) {
                                        B = "<div></div>"
                                    } else {
                                        if (I) {
                                            B = '<div style="margin-bottom:10px;background-color:#fff;padding:10px;"><p>' + r + "</p></div>"
                                        } else {
                                            B = '<div style="margin-bottom:10px;"><p>' + r + "</p></div>"
                                        }
                                    }
                                    break;
                                case 407:
                                    B = '<div style="height:10px;">&nbsp;</div>';
                                    break;
                                case 408:
                                    B = '<div style="margin-bottom:10px;"><hr class="styleProp" /></div>';
                                    break;
                                case 415:
                                    break;
                                case p3.Us.Enum.Content.LTI.Value:
                                    J.set("IconClass", "p3icon-pageTools");
                                    J.set("Caption", J.get("ShortDescription"));
                                    J.set("Lti", "true");
                                    break;
                                default:
                                    break
                            }
                            if (B.length > 0) {
                                $("#column" + J.get("RowIndex") + "_" + J.get("ColumnIndex")).append(B)
                            } else {
                                if (J.get("ContentId") == 415) {
                                    F = p3.Data.Context.getSelectedPersona().Id;
                                    if (F == 2 || (F == 3) || F == 5 || (F == 1 && q.Data.contextLabelId == 12)) {
                                        z = new q.Cs.DiscussionItem({}, {
                                            topicIndexId: w
                                        });
                                        z.fetch({
                                            async: false,
                                            data: {
                                                topicIndexId: z.topicIndexId
                                            },
                                            success: function() {
                                                A = new q.Vs.DiscussionView({
                                                    topicIndexId: w,
                                                    row: J.get("RowIndex"),
                                                    column: J.get("ColumnIndex")
                                                });
                                                A.collection = z;
                                                p3.rV(A, "#column" + J.get("RowIndex") + "_" + J.get("ColumnIndex"), false);
                                                x.discussionView = A
                                            },
                                            error: function() {
                                                p3.displayError("Error loading discussion thread")
                                            }
                                        })
                                    }
                                } else {
                                    if (E) {
                                        p3.rV(new q.Vs.ContentView({
                                            content: J,
                                            previewInd: x.options.previewInd,
                                            topicIndexId: w
                                        }), "#column" + J.get("RowIndex") + "_" + J.get("ColumnIndex"), false)
                                    }
                                }
                            }
                        })
                    }
                },
                error: function() {
                    p3.displayError("Error loading topic content")
                }
            })
        }
    });
    q.Vs.DetailView = Bb.View.extend({
        template: "topic/topic.detail.template.html",
        events: {},
        renderTemplate: function() {
            var r = this;
            p3.fT(r.template, function(t) {
                var s = r.options.topic.get("ThumbFilename");
                if (s) {
                    s += "?ver=" + d.localDateTime().getTime()
                }
                r.$el.html(t({
                    thumb: s,
                    Description: r.options.topic.get("Description"),
                    schoolId: p3.Data.SchoolContext.get("SchoolInfo").SchoolId
                }))
            })
        },
        render: function(r) {
            $(r).append(this.el);
            this.renderTemplate()
        }
    });
    q.Vs.ContentItem = Bb.View.extend({
        className: "pages-layout-block editable",
        template: "topic/topic.block.template.html",
        events: {},
        renderTemplate: function() {
            var w = this,
                u, s, v, r, t;
            if (w.model.get("ContentId") == 3) {
                w.template = "topic/topic.download.block.template.html";
                w.model.set("outputSubCat", true);
                v = w.model.get("GenericSettings");
                r = w.model.get("AdditionalItems");
                for (t = 0; t < r.length; t++) {
                    if (v != r[t].GenericSettings && r[t].SubCategory && r[t].SubCategory.length > 0) {
                        r[t].outputSubCat = true
                    } else {
                        r[t].outputSubCat = false
                    }
                    v = r[t].GenericSettings
                }
            } else {
                if (w.model.get("ContentId") === 2) {
                    s = "optTitle";
                    if (w.model.get("GenericSettings")) {
                        u = JSON.parse(w.model.get("GenericSettings"));
                        if (u.DisplayOption) {
                            s = u.DisplayOption
                        }
                    }
                }
            }
            switch (w.model.get("ContentId")) {
                case 3:
                    w.model.set("InfoNote", "Downloads from copied topics cannot be edited.");
                    break;
                case 31:
                    w.model.set("InfoNote", "Photos from copied topics cannot be edited.");
                    break;
                case 165:
                    w.model.set("InfoNote", "Audio from copied topics cannot be edited.");
                    break;
                case 167:
                    w.model.set("InfoNote", "Video from copied topics cannot be edited.");
                    break
            }
            p3.fT(w.template, function(x) {
                w.$el.html(x({
                    contentInfo: w.model.toJSON(),
                    displayOption: s
                }))
            })
        },
        render: function(r) {
            $(r).append(this.el);
            this.renderTemplate()
        }
    });
    q.Vs.ContentView = Bb.View.extend({
        className: "sortContainer",
        template: "topic/topic.content.template.html",
        events: {
            "click .media-cover": "showMedia",
            "click .album-refresh-link": "refreshProcessing",
            "click .lti-launch": "ltiLaunch"
        },
        renderTemplate: function() {
            var u = this,
                r, s = false,
                t = true;
            if (u.options.content.get("ContentId") == 3) {
                u.template = "topic/topic.download.template.html"
            } else {
                if (u.options.content.get("ContentId") === 2) {
                    if (u.options.content.get("GenericSettings")) {
                        r = JSON.parse(u.options.content.get("GenericSettings"));
                        if (r.DisplayOption) {
                            switch (r.DisplayOption) {
                                case "optImage":
                                    t = false;
                                    s = true;
                                    break;
                                case "optTitleImage":
                                    s = true;
                                    break
                            }
                        }
                    }
                }
            }
            p3.fT(u.template, function(v) {
                u.$el.html(v({
                    content: u.options.content.toJSON(),
                    SchoolId: p3.Data.SchoolContext.get("SchoolInfo").SchoolId,
                    previewInd: u.options.previewInd,
                    showTitle: t,
                    showImage: s
                }))
            })
        },
        initialize: function() {
            p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.jQueryUI, function() {
                return true
            })
        },
        render: function(r) {
            $(r).append(this.el);
            this.renderTemplate()
        },
        ltiLaunch: function(s) {
            s.stopPropagation();
            s.preventDefault();
            var x = this,
                v, r = "27",
                w, u = 0,
                t, z = "",
                y = "";
            if (x.options.topicIndexId && x.options.content) {
                v = x.options.content.get("ContentIndexId");
                w = x.options.topicIndexId;
                u = x.options.content.get("PresentationTarget");
                if (v && w && u) {
                    t = k.Us.BuildLaunchUrl(v, u, r, w);
                    if (u === h.LtiPresentationTargets.Redirect.id) {
                        t = t + "&url=" + encodeURIComponent(window.location.pathname + window.location.hash);
                        window.location.href = t
                    } else {
                        z = x.options.content.get("Caption");
                        window.open(t, z, y)
                    }
                }
            }
        },
        showMedia: function(u) {
            var r = $(u.currentTarget).attr("data-album"),
                t = $(u.currentTarget).attr("data-type"),
                s = "";
            switch (t) {
                case "31":
                    s = "photo";
                    break;
                case "165":
                    s = "audio";
                    break;
                case "167":
                    s = "video";
                    break;
                default:
                    break
            }
            m.Us.showModal(r, s);
            return false
        },
        refreshProcessing: function(u) {
            var t = u.currentTarget.attributes.getNamedItem("aid").value,
                s, r = $("#album_processing_" + t);
            r.hide();
            s = new l.Ms.Video({}, {
                albumId: t
            });
            s.fetch({
                success: function() {
                    var A = false,
                        z = false,
                        x = s.get("Files"),
                        y, w, v;
                    for (y = 0; y < x.length; y++) {
                        if (x[y].ProcessingStatus > 0) {
                            A = true
                        } else {
                            z = true
                        }
                    }
                    if (z) {
                        $("#album_label_" + t).hide();
                        $("#viewer_link_" + t).show()
                    }
                    if (A) {
                        r.show(400)
                    } else {
                        w = r.closest("div.span11").children(".topic-content-edit-disabled");
                        if (w === undefined || w === null || w.length === 0) {
                            w = r.closest("div.col-md-11").children(".topic-content-edit-disabled")
                        }
                        v = r.closest("div.span11").children(".topic-content-delete-disabled");
                        if (v === undefined || v === null || v.length === 0) {
                            v = r.closest("div.col-md-11").children(".topic-content-delete-disabled")
                        }
                        w.removeClass("topic-content-edit-disabled");
                        w.addClass("topic-content-edit-btn");
                        w.show();
                        v.removeClass("topic-content-delete-disabled");
                        v.addClass("topic-content-delete-btn");
                        v.show()
                    }
                },
                error: function() {
                    r.show();
                    p3.displayError("Error refreshing album")
                }
            });
            return false
        }
    });
    q.Vs.DiscussionView = Bb.View.extend({
        template: "topic/topic.discussion.template.html",
        events: {
            "click #btnPostNote": "postNote",
            "keypress .note-comment-box": "postComment",
            "change #txtNote": "removeNoteValidation",
            "click .message-edit": "editMessageClick",
            "click .message-delete": "deleteMessageClick",
            "keypress .message-edit-box": "updateComment",
            "keyup .message-edit-box": "hideEditComment",
            "keypress #txtNote": "postNoteKeypress",
            "click #messageLoadButton": "displayInsertedMessages",
            "click .btn-show-more": "toggleAdditionalItems"
        },
        renderTemplate: function() {
            var v = this,
                s, r, u, t;
            p3.fT(v.template, function(w) {
                v.$el.html(w({
                    discussion: v.collection.toJSON(),
                    SchoolId: p3.Data.SchoolContext.get("SchoolInfo").SchoolId,
                    row: v.options.row,
                    column: v.options.column
                }))
            });
            if (v.collection.length > 0) {
                s = _.min(v.collection.models, function(w) {
                    return w.get("ParentDateTicks")
                });
                if (s) {
                    v.lastDate = s.get("ParentDateTicks")
                }
            }
            r = "";
            u = d.localDateTime();
            t = u.getTime() - (u.getTimezoneOffset() * 60000);
            r = (t * 10000) + 6.21355968e+17;
            v.refreshCollection = new q.Cs.DiscussionItemRefresh({}, {
                topicIndexId: v.options.topicIndexId,
                lastDate: r
            });
            v.startStream()
        },
        dispose: function() {
            $(window).unbind("scroll");
            this.stopStream()
        },
        render: function(r) {
            $(r).append(this.el);
            this.renderTemplate()
        },
        displayInsertedMessages: function() {
            var E = this,
                w, B, y, t, A, s, z, v, C, x, D, u, r = $("#message_container_" + B);
            $("#messageLoadRegion").hide();
            $(".added-comment").removeClass("added-comment");
            $(".added-note").removeClass("added-note");
            E.refreshCollection.count = 0;
            C = p3.Data.SchoolContext.get("SchoolInfo").SchoolId;
            x = p3.Data.Context.getSelectedPersona().Id == 3 || p3.Data.Context.getSelectedPersona().Id == 5;
            D = p3.Data.Context.get("UserInfo").UserId;
            u = d.localDateTime();
            for (w = 0; w < E.refreshCollection.models.length; w++) {
                y = E.refreshCollection.models[w];
                $("#message_container_" + y.get("MessageId")).remove();
                B = y.get("ParentMessageId");
                if (B > 0) {
                    t = q.Us.OutputMessage(y.toJSON(), true, C, B, false, true, D, x, u);
                    $("#child_container_" + B).append(t);
                    A = r[0].outerHTML;
                    if (A.indexOf("<hr></div>", A.length - 10) === -1) {
                        A = A.substring(0, A.length - 6) + "<hr></div>"
                    }
                    r.remove();
                    $(".topic-discussion-container").prepend(A)
                } else {
                    s = q.Us.BeginNoteRegion(y.toJSON(), true, C, E.options.row, E.options.column);
                    z = q.Us.OutputMessage(y.toJSON(), false, C, y.get("MessageId"), true, false, D, x, d.localDateTime());
                    v = q.Us.EndNoteRegion(y.get("MessageId"), true);
                    $(".topic-discussion-container").prepend(s + z + v)
                }
            }
            E.refreshCollection.remove(E.refreshCollection.models);
            return false
        },
        postNote: function(r) {
            var s = this;
            if ($("#txtNote").val().length === 0) {
                $(".discussion-note").addClass("error")
            } else {
                this.removeNoteValidation();
                this.saveDiscussionItem(0, $("#txtNote").val(), 0, s.options.topicId, s.options.topicIndexId);
                $("#txtNote").val("")
            }
        },
        postNoteKeypress: function(r) {
            var s = this;
            if (r.keyCode === 13 && !r.shiftKey && $("#txtNote").val().length > 0) {
                this.removeNoteValidation();
                this.saveDiscussionItem(0, $("#txtNote").val(), 0, s.options.topicId, s.options.topicIndexId);
                $("#txtNote").val("");
                r.preventDefault()
            }
        },
        postComment: function(r) {
            var s = this;
            if (r.keyCode === 13 && !r.shiftKey && r.currentTarget.value.length > 0) {
                this.saveDiscussionItem(0, r.currentTarget.value, r.currentTarget.attributes.getNamedItem("pmsg").value, s.options.topicId, s.options.topicIndexId);
                r.currentTarget.value = "";
                r.preventDefault()
            }
        },
        editMessageClick: function(r) {
            var s = r.currentTarget.attributes.getNamedItem("mid").value;
            if ($("#msgEdit_" + s).is(":visible")) {
                $("#msgEdit_" + s).hide();
                $("#msgDisplay_" + s).show()
            } else {
                $("#msgEdit_" + s).show();
                $("#msgEdit_" + s).find("textarea").focus();
                $("#msgDisplay_" + s).hide()
            }
            return false
        },
        updateComment: function(r) {
            var t = this,
                s = r.currentTarget.attributes.getNamedItem("mid").value;
            if (r.keyCode === 13 && !r.shiftKey && r.currentTarget.value.length > 0) {
                this.saveDiscussionItem(s, r.currentTarget.value, 0, t.options.topicId, t.options.topicIndexId);
                $("#msgDisplay_" + s).html("<p>" + r.currentTarget.value + "</p>");
                $("#msgEdit_" + s).hide();
                $("#msgDisplay_" + s).show()
            }
        },
        hideEditComment: function(r) {
            var s = r.currentTarget.attributes.getNamedItem("mid").value;
            if (r.keyCode === 27) {
                $("#msgEdit_" + s).hide();
                $("#msgDisplay_" + s).show()
            }
        },
        deleteMessageClick: function(s) {
            var u = this,
                t = s.currentTarget.attributes.getNamedItem("mid").value,
                r;
            p3.showConfirm(null, "Are you sure you want to delete this?", null, function() {
                r = new q.Ms.DiscussionItemDelete({
                    Id: t,
                    contextLabelId: 27,
                    contextValue: u.options.topicIndexId
                });
                r.destroy({
                    error: function() {
                        p3.displayError("Error deleting Note")
                    },
                    success: function() {
                        $("#message_container_" + t).remove()
                    }
                })
            });
            return false
        },
        removeNoteValidation: function(r) {
            $(".discussion-note").removeClass("error")
        },
        saveDiscussionItem: function(r, u, s, v, w) {
            var t, x = this;
            u = f.Us.removeWordMarkup(u, false);
            if (r == 0) {
                t = new q.Ms.DiscussionItemCreate({
                    MessageId: r,
                    Message: u,
                    ParentMessageId: s,
                    ContextLabelId: 27,
                    ContextValue: w,
                    ApprovalInd: true
                })
            } else {
                t = new q.Ms.DiscussionItemUpdate({
                    MessageId: r,
                    Message: u,
                    ParentMessageId: s,
                    ContextLabelId: 27,
                    ContextValue: w,
                    ApprovalInd: true
                })
            }
            t.save({}, {
                error: function() {
                    p3.displayError("Error saving Note")
                },
                success: function(C, E) {
                    var F, B, G, z, y, D, A;
                    if (!r) {
                        E.InsertDate = E.MessageDate;
                        F = p3.Data.SchoolContext.get("SchoolInfo").SchoolId;
                        B = p3.Data.Context.getSelectedPersona().Id == 3 || p3.Data.Context.getSelectedPersona().Id == 5;
                        G = p3.Data.Context.get("UserInfo").UserId;
                        if (s) {
                            z = q.Us.OutputMessage(E, false, F, s, false, true, G, B, d.localDateTime());
                            $("#child_container_" + s).append(z)
                        } else {
                            y = q.Us.BeginNoteRegion(E, false, F, x.options.row, x.options.column);
                            D = q.Us.OutputMessage(E, false, F, E.MessageId, true, false, G, B, d.localDateTime());
                            A = q.Us.EndNoteRegion(E.MessageId, true);
                            $(".topic-discussion-container").prepend(y + D + A)
                        }
                    }
                }
            })
        },
        stopStream: function() {
            var r = this;
            if (r.refreshCollection) {
                r.refreshCollection.unstream()
            }
        },
        startStream: function() {
            var r = this;
            r.refreshCollection.stream({
                interval: 60000,
                add: true
            })
        },
        toggleAdditionalItems: function(t) {
            var r = $(t.currentTarget),
                u = r.data("row"),
                s = r.data("column");
            if (r.hasClass("show-data")) {
                r.removeClass("show-data").addClass("hide-data").html("Show Less");
                $("#more-region-" + u + "-" + s).show()
            } else {
                r.removeClass("hide-data").addClass("show-data").html("Show All");
                $("#more-region-" + u + "-" + s).hide()
            }
        }
    });
    q.Vs.TopicDeleteView = Bb.View.extend({
        template: "topic/topic.delete.template.html",
        events: {
            "click #btnConfirm": "deleteTopic"
        },
        renderTemplate: function() {
            var r = this;
            p3.fT(r.template, function(s) {
                r.$el.html(s({
                    group: r.options.groups.toJSON(),
                    showRadios: r.options.showRadios
                }))
            })
        },
        render: function(r) {
            this.renderTemplate();
            $(r).append(this.el)
        },
        deleteTopic: function(u) {
            $("#btnConfirm").button("loading");
            var w = this,
                r = 1,
                t = false,
                v = "",
                s;
            if (w.options.showRadios) {
                $(".remove-section-check").each(function(y, x) {
                    if (x.checked) {
                        t = true;
                        v += "," + x.attributes.getNamedItem("sid").value
                    } else {
                        r = 0
                    }
                })
            } else {
                t = true
            }
            if (t) {
                s = new q.Ms.TopicDelete({
                    Id: this.options.topicId,
                    groupId: this.options.leadSectionId,
                    option: r,
                    sectionId: this.options.sectionId,
                    sections: v
                });
                s.destroy({
                    error: function() {
                        p3.showModal(p3.Layout.Containers.Modal, "hide");
                        p3.displayError("Error deleting topic")
                    },
                    success: function(x, y) {
                        p3.showModal(p3.Layout.Containers.Modal, "hide");
                        q.Us.refreshTopics(true, 0, w.options.leadSectionId, w.options.topicView)
                    }
                })
            } else {
                p3.showModal(p3.Layout.Containers.Modal, "hide")
            }
            return false
        }
    });
    q.Vs.TopicTextEditView = Bb.View.extend({
        template: "topic/topic.text.edit.template.html",
        events: {
            "click #btnSaveText": "saveText"
        },
        renderTemplate: function() {
            var r = this;
            p3.fT(r.template, function(s) {
                r.$el.html(s({
                    Id: r.options.Id,
                    Text: r.options.Text
                }))
            });
            window.setTimeout(function() {
                q.Us.loadHTMLEditor()
            }, 500)
        },
        dispose: function() {
            p3.Layout.Containers.Modal.off("shown", q.Us.loadHTMLEditor);
            var r = tinyMCE.get("myeditor");
            if (r) {
                r.remove()
            }
        },
        render: function(r) {
            this.renderTemplate();
            $(r).append(this.el)
        },
        saveText: function(t) {
            var v = this,
                u, s, r = $("#btnSaveText");
            r.button("loading");
            if ($("#myeditor").length > 0 && $(".editor").length > 0) {
                s = tinyMCE.get("myeditor");
                if (s) {
                    s.save()
                }
            }
            if ($("#myeditor").val().length === 0) {
                $(".alert-error").show();
                r.button("reset");
                $("#btnSaveAddText").button("reset");
                p3.Us.InfoMessage.ErrorBox("Text is required.", ".modal-body", true)
            } else {
                if (s) {
                    s.remove()
                }
                if (v.options.Id == 0) {
                    u = new p.Ms.TextCreate({
                        AlbumID: 0,
                        Description: "",
                        LongText: $("#myeditor").val(),
                        ContextLabelID: 27,
                        ContextValue: v.options.topicId,
                        SortOrder: v.options.sort
                    })
                } else {
                    u = new p.Ms.TextUpdate({
                        AlbumID: v.options.Id,
                        Description: "",
                        LongText: $("#myeditor").val(),
                        ContextLabelID: 27,
                        ContextValue: v.options.topicId,
                        SortOrder: v.options.sort
                    })
                }
                u.save({}, {
                    error: function() {
                        p3.showModal(p3.Layout.Containers.Modal, "hide");
                        p3.displayError("Error saving topic text")
                    },
                    success: function() {
                        v.trigger("textSaved")
                    }
                })
            }
            return false
        }
    });
    q.Vs.TopicWidgetEditView = Bb.View.extend({
        template: "topic/topic.widget.edit.template.html",
        mode: "Add",
        loadedId: 0,
        events: {
            "click #btnSaveWidget": "doSave"
        },
        initialize: function(r) {
            this.mode = r.mode || this.mode;
            this.loadedId = r.loadedId || this.loadedId
        },
        render: function(r) {
            $(r).append(this.el);
            this.renderTemplate()
        },
        renderTemplate: function() {
            var r = this;
            p3.fT(r.template, function(s) {
                r.$el.html(s({
                    Mode: r.mode,
                    AddAnother: (r.mode === "Add")
                }));
                $("#topic-widget-edit-text").height(110);
                if (!_.isUndefined(r.options.contentItem)) {
                    r.doLoad(r.options.contentItem.get("ShortDescription"), r.options.contentItem.get("LongDescription"))
                }
            })
        },
        doLoad: function(s, r) {
            this.$("#topic-widget-edit-title").val(s);
            this.$("#topic-widget-edit-text").val(r)
        },
        doSave: function(u) {
            var x = this,
                v = x.$("#topic-widget-edit-title").val(),
                t = x.$("#topic-widget-edit-text").val(),
                y, w = true,
                r = $("#btnSaveWidget"),
                s = $("#btnSaveAddWidget");
            r.button("loading");
            s.button("loading");
            if (typeof v !== "string" || v === "") {
                x.$("#topic-widget-edit-title").closest(".control-group").addClass("error");
                w = false
            } else {
                x.$("#topic-widget-edit-title").closest(".control-group").removeClass("error")
            }
            if (typeof t !== "string" || t === "") {
                x.$("#topic-widget-edit-text").closest(".control-group").addClass("error");
                w = false
            } else {
                x.$("#topic-widget-edit-text").closest(".control-group").removeClass("error")
            }
            if (w) {
                if (x.mode === "Add") {
                    y = new q.Ms.TopicWidgetCreate({
                        ShortDescription: v,
                        LongDescription: t,
                        ContextLabelId: 27,
                        ContextValue: x.options.ContextValue,
                        SortOrder: x.options.sortOrder
                    })
                } else {
                    y = new q.Ms.TopicWidgetUpdate({
                        WidgetId: x.loadedId,
                        ShortDescription: v,
                        LongDescription: t,
                        ContextLabelId: 27,
                        ContextValue: x.options.ContextValue,
                        SortOrder: x.options.sortOrder
                    })
                }
                y.save({}, {
                    error: function(z, A) {
                        $("#btnSaveText").button("reset")
                    },
                    success: function(z, A) {
                        x.trigger("embedSaved")
                    }
                })
            } else {
                r.button("reset");
                s.button("reset")
            }
            return false
        }
    });
    q.Vs.TopicContentDeleteView = Bb.View.extend({
        template: "topic/topic.content.delete.template.html",
        events: {
            "click #btnConfirm": "deleteContent"
        },
        renderTemplate: function() {
            var s = this,
                r = "";
            switch (s.options.ContentId) {
                case 2:
                    r = "Link";
                    break;
                case 3:
                    r = "Download";
                    break;
                case 31:
                    r = "Photo Album";
                    break;
                case 165:
                    r = "Audio Album";
                    break;
                case 167:
                    r = "Video Album";
                    break;
                case 1:
                    r = "Text";
                    break;
                case 387:
                    r = "Embed";
                    break;
                case p3.Us.Enum.Content.LTI.Value:
                    r = "Learning Tool";
                    break
            }
            p3.fT(s.template, function(t) {
                s.$el.html(t({
                    ContentType: r
                }))
            })
        },
        render: function(r) {
            this.renderTemplate();
            $(r).append(this.el)
        },
        deleteContent: function(s) {
            var t = this,
                r;
            $("#btnConfirm").button("loading");
            switch (t.options.ContentId) {
                case 1:
                    r = new p.Ms.TextDelete({
                        Id: this.options.Id,
                        contextLabelId: 27
                    });
                    break;
                case 2:
                    r = new j.Ms.LinkDelete({
                        Id: this.options.Id,
                        groupId: 0,
                        option: 1,
                        contextValue: 0
                    });
                    break;
                case 3:
                    r = new g.Ms.DownloadDelete({
                        Id: this.options.Id,
                        FileName: this.options.FileName,
                        groupId: 0,
                        option: 1,
                        contextValue: 0
                    });
                    break;
                case 31:
                    r = new l.Ms.AlbumDelete({
                        Id: this.options.Id,
                        contentId: 31,
                        groupId: 0,
                        option: 1,
                        contextValue: 0,
                        contextLabelId: 27
                    });
                    break;
                case 165:
                    r = new l.Ms.AlbumDelete({
                        Id: this.options.Id,
                        contentId: 165,
                        groupId: 0,
                        option: 1,
                        contextValue: 0,
                        contextLabelId: 27
                    });
                    break;
                case 167:
                    r = new l.Ms.AlbumDelete({
                        Id: this.options.Id,
                        contentId: 167,
                        groupId: 0,
                        option: 1,
                        contextValue: 0,
                        contextLabelId: 27
                    });
                    break;
                case 387:
                    r = new q.Ms.TopicWidgetDelete({
                        Id: this.options.Id
                    });
                    break;
                case p3.Us.Enum.Content.LTI.Value:
                    r = new k.Ms.Tool({
                        ToolId: this.options.Id
                    });
                    break;
                default:
                    break
            }
            r.destroy({
                error: function() {
                    p3.showModal(p3.Layout.Containers.Modal, "hide");
                    p3.displayError("Error deleting " + t.options.ContentType)
                },
                success: function() {
                    t.trigger("contentDeleted");
                    p3.showModal(p3.Layout.Containers.Modal, "hide")
                }
            });
            return false
        }
    });
    q.Vs.ImportWindow = Bb.View.extend({
        template: "topic/topic.import.layout.template.html",
        events: {
            "click #import-topics-save-button": "doSave",
            refreshTopics: "doRefresh"
        },
        initialize: function(t) {
            var v = this,
                s, u, r;
            t = t || {};
            this.schoolYears = t.schoolYears || 0;
            this.sections = t.sections || 0;
            this.SectionsForTeacher = t.SectionsForTeacher || new q.Cs.ExistingSections();
            this.currentSection = t.currentSection || 0;
            this.leadSection = t.leadSectionId || 0;
            this.terms = new q.Cs.SchoolYearTermGet();
            if (this.schoolYears !== 0 && this.schoolYears.length > 0) {
                s = this.schoolYears.where({
                    Current: true
                });
                if (s.length > 0) {
                    this.currentYear = s[0].get("Id");
                    this.terms.fetch({
                        data: {
                            schoolYearLabel: q.Data.SchoolYear,
                            levelNum: q.Data.LevelNum
                        },
                        async: false,
                        success: function(w, y, x) {
                            u = w.where({
                                DurationId: q.Data.DurationId
                            });
                            if (u.length > 0) {
                                q.Data.Duration = _.extend(u[0], {})
                            }
                        }
                    })
                }
                if (this.SectionsForTeacher.length < 1) {
                    r = q.Us.getAssociationFromContext(v.options.topicView.options.contextLabelId);
                    this.SectionsForTeacher.association = r;
                    this.SectionsForTeacher.fetch({
                        data: {
                            facultyUserId: p3.Data.Context.get("UserInfo").UserId,
                            schoolYear: this.currentYear,
                            associationId: r,
                            copyInd: false
                        },
                        async: false,
                        error: function(w, x) {
                            p3.displayError("Error retreiving sections.")
                        }
                    })
                }
                this.filters = new q.Vs.ImportFilters({
                    schoolYears: this.schoolYears,
                    sections: this.SectionsForTeacher,
                    leadSection: this.leadSection
                });
                this.contentView = new q.Vs.ImportContent({
                    currentSection: this.leadSection || 0
                });
                this.sectionView = new q.Vs.ImportSections({
                    sections: this.sections
                });
                this.bankFilterView = new q.Vs.ImportBankFilters({
                    schoolYears: this.schoolYears
                });
                this.bankContentView = new q.Vs.BankContent({
                    currentSection: 0
                });
                this.bankFilterView.on("sectionChange", function(w) {
                    v.bankContentView.currentSection = w;
                    v.bankContentView.updateContent()
                })
            }
        },
        render: function(r) {
            var s = this;
            $(r).html(s.el);
            p3.fT(s.template, function(t) {
                s.$el.html(t({}));
                p3.rV(s.filters, p3.Layout.Containers.Modal.find("#import-topic-filter-container"), true);
                p3.rV(s.contentView, p3.Layout.Containers.Modal.find("#import-topic-content-container"), true);
                p3.rV(s.sectionView, p3.Layout.Containers.Modal.find("#import-topic-section-container"), true);
                p3.rV(s.bankFilterView, p3.Layout.Containers.Modal.find("#import-topicbank-filter-container"), true);
                p3.rV(s.bankContentView, p3.Layout.Containers.Modal.find("#import-topicbank-content-container"), true)
            })
        },
        doSave: function(u) {
            u.preventDefault();
            u.stopPropagation();
            var x = this,
                w = x.contentView.getSelected(),
                v = x.sectionView.getSelected(),
                t = x.bankContentView.getSelected(),
                r = [],
                s;
            _.each(w, function(y) {
                var z = {
                    TopicId: y.TopicId,
                    groups: [],
                    ContextLabelId: x.options.topicView.options.contextLabelId
                };
                _.each(v, function(A) {
                    z.groups.push({
                        ContextValue: A.ContextValue,
                        PublishDate: y.PublishDate,
                        ExpireDate: y.ExpireDate,
                        PublishInd: A.notify,
                        Selected: true,
                        ContextLabelId: x.options.topicView.options.contextLabelId,
                        Sort: 1,
                        Type: 1
                    })
                });
                r.push(z)
            });
            _.each(t, function(y) {
                var z = {
                    TopicId: y.TopicId,
                    groups: [],
                    ContextLabelId: x.options.topicView.options.contextLabelId
                };
                _.each(v, function(A) {
                    z.groups.push({
                        ContextValue: A.ContextValue,
                        PublishDate: y.PublishDate,
                        ExpireDate: y.ExpireDate,
                        ContextLabelId: x.options.topicView.options.contextLabelId
                    })
                });
                r.push(z)
            });
            s = new q.Cs.TopicCopy(r);
            s.sync("update", s, {
                error: function() {
                    p3.showModal(p3.Layout.Containers.Modal, "hide");
                    p3.displayError("Error importing topic(s)")
                },
                success: function() {
                    q.Us.refreshTopics(true, 0, x.options.leadSectionId, x.options.topicView);
                    p3.showModal(p3.Layout.Containers.Modal, "hide")
                }
            })
        },
        doRefresh: function(r) {
            var s = this;
            r.preventDefault();
            r.stopPropagation();
            s.contentView.$el.trigger({
                type: "updateContent",
                section: s.filters.getSection()
            })
        }
    });
    q.Vs.ImportFilters = Bb.View.extend({
        template: "topic/topic.import.filters.template.html",
        events: {
            "change #import-years-dd": "doSelectYear",
            "change #import-sections-dd": "doSelectSection"
        },
        initialize: function(r) {
            this.schoolYears = r.schoolYears || 0;
            this.sections = r.sections || 0;
            this._selectedSection = r.leadSection || null;
            this.sections.on("reset", this.updateSections, this)
        },
        render: function(s) {
            var t = this,
                r = $("#import-sections-dd");
            $(s).html(t.el);
            p3.fT(t.template, function(u) {
                t.$el.html(u({
                    years: t.schoolYears.toJSON(),
                    sections: t.sections.toJSON()
                }));
                if (t.sections.where({
                        SectionId: t._selectedSection
                    }).length > 0) {
                    r.val(t._selectedSection)
                } else {
                    t._selectedSection = r.val()
                }
                r.trigger("change")
            })
        },
        updateSections: function(r) {
            var t = $("#import-sections-dd"),
                u = "",
                s;
            if (t.length > 0) {
                this.sections.each(function(v) {
                    u += '<option value="' + v.get("SectionId") + '">' + v.get("Name") + "</option>"
                });
                if (u === "") {
                    t.html("<option>No sections available.</option>");
                    return false
                }
                t.html(u);
                s = $.Event("change");
                s.currentTarget = t;
                t.trigger(s)
            }
        },
        doSelectYear: function(r) {
            var s = $(r.currentTarget).val();
            this.sections.fetch({
                data: {
                    facultyUserId: p3.Data.Context.get("UserInfo").UserId,
                    schoolYear: s,
                    associationId: this.sections.association,
                    copyInd: false
                },
                async: false,
                error: function(t, u) {
                    p3.displayError("Error retreiving sections.")
                }
            })
        },
        doSelectSection: function(r) {
            this._selectedSection = $(r.currentTarget).val();
            this.$el.trigger("refreshTopics")
        },
        getSection: function() {
            return this._selectedSection
        }
    });
    q.Vs.ImportBankFilters = Bb.View.extend({
        template: "topic/topic.importbank.filters.template.html",
        events: {
            "change #bank-years-dd": "doSelectYear",
            "change #bank-faculty-dd": "doSelectFaculty",
            "change #bank-sections-dd": "doSelectSection"
        },
        initialize: function(r) {
            this.associationId = q.Us.getAssociationFromContext(q.Data.contextLabelId);
            this.schoolYears = r.schoolYears;
            this.faculty = new q.Cs.CopyableFaculty();
            this.sections = new q.Cs.ExistingSections()
        },
        render: function(r) {
            var s = this;
            $(r).html(s.el);
            p3.fT(s.template, function(t) {
                s.$el.html(t({
                    years: s.schoolYears.toJSON()
                }));
                $("#bank-years-dd").trigger("change")
            })
        },
        updateSections: function(r) {
            var t = $("#import-sections-dd"),
                u = "",
                s;
            if (t.length > 0) {
                this.sections.each(function(v) {
                    u += '<option value="' + v.get("SectionId") + '">' + v.get("Name") + "</option>"
                });
                if (u === "") {
                    t.html("<option>No sections available.</option>");
                    return false
                }
                t.html(u);
                s = $.Event("change");
                s.currentTarget = t;
                t.trigger(s)
            }
        },
        doSelectYear: function(s) {
            var u = this,
                t = $(s.currentTarget).val(),
                r = $("#bank-faculty-dd");
            u.faculty.fetch({
                data: {
                    associationId: u.associationId,
                    schoolYearLabel: t
                },
                success: function() {
                    r.empty();
                    if (u.faculty.length > 0) {
                        u.faculty.each(function(v) {
                            r.append($("<option></option>").attr("value", v.get("id")).text(v.get("owner_name")))
                        })
                    } else {
                        r.html("<option>No faculty available.</option>")
                    }
                    r.trigger("change")
                },
                error: function(v, w) {
                    p3.displayError("Error retreiving teachers.")
                }
            })
        },
        doSelectSection: function(r) {
            this._selectedSection = $(r.currentTarget).val();
            this.trigger("sectionChange", this._selectedSection)
        },
        getSection: function() {
            return this._selectedSection
        },
        doSelectFaculty: function(s) {
            var v = this,
                t = $(s.currentTarget).val(),
                r = $("#bank-sections-dd"),
                u = 0;
            r.empty();
            if (t > 0) {
                v.sections.fetch({
                    data: {
                        facultyUserId: t,
                        schoolYear: $("#bank-years-dd").val(),
                        associationId: v.associationId,
                        copyInd: true
                    },
                    success: function() {
                        r.empty();
                        if (v.sections.length > 0) {
                            v.sections.each(function(w) {
                                if (u === 0) {
                                    u = w.get("SectionId")
                                }
                                r.append($("<option></option>").attr("value", w.get("SectionId")).text(w.get("Name")))
                            })
                        } else {
                            r.html("<option>No sections available.</option>")
                        }
                        v.trigger("sectionChange", u)
                    },
                    error: function(w, x) {
                        p3.displayError("Error retreiving sections.")
                    }
                })
            }
        }
    });
    q.Vs.ImportContent = Bb.View.extend({
        template: "topic/topic.import.content.list.template.html",
        events: {
            updateContent: "updateContent",
            "click #existing-search-button": "doSearch",
            "keypress #existing-search-field": "filterKeys",
            "click #topic-import-select-all-button": "doSelectAll"
        },
        initialize: function(r) {
            r = r || {};
            this.currentSection = r.currentSection || 0;
            this.collection = new q.Cs.ExistingTopic(null, {
                sectionId: 0,
                leadSectionId: this.currentSection,
                active: true,
                future: true,
                expired: true
            })
        },
        render: function(r) {
            var s = this;
            $(r).html(s.el);
            p3.fT(s.template, function(t) {
                s.$el.html(t())
            })
        },
        updateContent: function(r) {
            var s = this;
            if (_.isUndefined(s.collection)) {
                return false
            }
            if (!_.isUndefined(r.section) && r.section !== null) {
                s.currentSection = s.collection.leadSectionId = r.section
            }
            s.collection.fetch({
                async: false,
                success: function(u, y) {
                    var v = u.toJSON(),
                        A = d.localDateTime(),
                        w = d.localDateTime(),
                        x, z, B, t = $("#existing-search-field");
                    if (q.Data.Duration) {
                        A = d.getDate(q.Data.Duration.get("BeginDate"))
                    }
                    if (s.options.currentSection === 0) {
                        $("#notice-of-import-functionality").removeClass("alert-info").addClass("alert-warning");
                        $("#notice-of-import-functionality").find("i").removeClass("p3icon-notification").addClass("p3icon-warning");
                        $("#notice-of-import-functionality").find("strong").html("Whoops!");
                        $("#keep-in-mind-import").html(" At this point you do not have any existing Topics to import.")
                    } else {
                        $("#keep-in-mind-import").html(" if the term has already started then the publish date will be set automatically to today's date. If the term has not started then the publish date will be set to the first day of the next term. You will need to select the Future view to see future dated Topics.")
                    }
                    $("#notice-of-import-functionality").show();
                    x = d.getDateString((w >= A ? w : A));
                    _.each(v, function(C) {
                        C.PublishDate = x
                    });
                    if (t.length > 0 && t.val() !== "") {
                        v = [];
                        z = t.val().toLowerCase();
                        B = u.filter(function(C) {
                            return (C.get("Name").toLowerCase().indexOf(z) > -1)
                        });
                        _.each(B, function(C) {
                            v.push(C.toJSON())
                        })
                    }
                    s.renderItems(v)
                },
                error: function(t, u) {
                    p3.displayError("Error retreiving Existing Topics.")
                }
            })
        },
        renderItems: function(u) {
            var v = this,
                s, t, r = $("#import-topics-content-items");
            if (r.length < 1) {
                if (q._renderItemsTimer) {
                    window.clearInterval(q._renderItemsTimer);
                    q._renderItemsTimer = null
                }
                q._renderItemsTimer = window.setInterval(function() {
                    if ($("#import-topics-content-items").length > 0) {
                        v.renderItems(u);
                        window.clearInterval(q._renderItemsTimer);
                        q._renderItemsTimer = null
                    }
                }, 100)
            } else {
                r.html('<tr class="ignore"></tr>');
                if (!u || u.length === 0) {
                    r.append("<tr><th></th><th>No topics found.</th><th></th><th></th><th></th></tr>")
                } else {
                    for (s = 0; s < u.length; s++) {
                        t = u[s];
                        p3.rV(new q.Vs.ImportContentItem({
                            content: t
                        }), r, false)
                    }
                    if (r.find(".datepicker").length < 1) {
                        if (q._datepickerTimer) {
                            window.clearInterval(q._datepickerTimer);
                            q._datepickerTimer = null
                        }
                        q._datepickerTimer = window.setInterval(function() {
                            if (r.find(".datepicker").length > 0) {
                                e.Us.initialize(".datepicker");
                                window.clearInterval(q._datepickerTimer);
                                q._datepickerTimer = null
                            }
                        }, 100)
                    } else {
                        e.Us.initialize(".datepicker")
                    }
                }
            }
        },
        doSelectAll: function(t) {
            var s = $(t.currentTarget),
                r = $("#import-topics-content-items").find(".btn-approve");
            if (s.hasClass("active")) {
                r.each(function(u, v) {
                    $(v).removeClass("active")
                })
            } else {
                r.each(function(u, v) {
                    $(v).addClass("active")
                })
            }
        },
        doSearch: function(r) {
            this.$el.trigger("updateContent")
        },
        filterKeys: function(r) {
            var s = this;
            if (r.keyCode === 13) {
                s.$el.trigger("updateContent");
                return false
            }
        },
        getSelected: function() {
            var r = $("#import-topics-content-items").find(".btn-approve.active"),
                s = [];
            r.each(function(t, v) {
                var u = $(v).closest("tr").find("input");
                if (u.length === 2) {
                    s.push({
                        TopicId: $(v).data("topicId"),
                        PublishDate: $(u[0]).val().split(" ")[0],
                        ExpireDate: $(u[1]).val()
                    })
                }
            });
            return s
        }
    });
    q.Vs.BankContent = Bb.View.extend({
        template: "topic/topic.import.bank.list.template.html",
        events: {
            "click #bank-search-button": "doSearch",
            "keypress #bank-search-field": "filterKeys",
            "click #topic-bank-select-all-button": "doSelectAll"
        },
        initialize: function(r) {
            r = r || {};
            this.currentSection = r.currentSection || 0;
            this.collection = new q.Cs.ExistingTopic(null, {
                sectionId: 0,
                leadSectionId: this.currentSection,
                active: true,
                future: true,
                expired: true
            })
        },
        render: function(r) {
            var s = this;
            $(r).html(s.el);
            p3.fT(s.template, function(t) {
                s.$el.html(t())
            })
        },
        updateContent: function() {
            var r = this;
            if (_.isUndefined(r.collection)) {
                return false
            }
            r.collection.leadSectionId = r.currentSection;
            r.collection.fetch({
                async: false,
                success: function(t, x) {
                    var u = t.toJSON(),
                        z = d.localDateTime(),
                        v = d.localDateTime(),
                        w, y, A, s = $("#bank-search-field");
                    if (q.Data.Duration) {
                        z = d.getDate(q.Data.Duration.get("BeginDate"))
                    }
                    w = d.getDateString((v >= z ? v : z));
                    _.each(u, function(B) {
                        B.PublishDate = w
                    });
                    u = [];
                    y = s.val().toLowerCase();
                    A = t.filter(function(B) {
                        return B.get("AllowCopy") && (y.length === 0 || B.get("Name").toLowerCase().indexOf(y) > -1)
                    });
                    _.each(A, function(B) {
                        u.push(B.toJSON())
                    });
                    r.renderItems(u)
                },
                error: function(s, t) {
                    p3.displayError("Error retreiving Existing Topics.")
                }
            })
        },
        renderItems: function(u) {
            var s, t, r = $("#import-topics-bank-items");
            r.html('<tr class="ignore"></tr>');
            if (!u || u.length === 0) {
                r.append("<tr><th></th><th>No topics found.</th><th></th><th></th><th></th></tr>")
            } else {
                for (s = 0; s < u.length; s++) {
                    t = u[s];
                    p3.rV(new q.Vs.ImportContentItem({
                        content: t
                    }), r, false)
                }
                e.Us.initialize(".datepicker")
            }
        },
        doSelectAll: function(t) {
            var s = $(t.currentTarget),
                r = $("#import-topics-bank-items").find(".btn-approve");
            if (s.hasClass("active")) {
                r.each(function(u, v) {
                    $(v).removeClass("active")
                })
            } else {
                r.each(function(u, v) {
                    $(v).addClass("active")
                })
            }
        },
        doSearch: function(r) {
            this.updateContent()
        },
        filterKeys: function(r) {
            var s = this;
            if (r.keyCode === 13) {
                s.updateContent();
                return false
            }
        },
        getSelected: function() {
            var r = $("#import-topics-bank-items").find(".btn-approve.active"),
                s = [];
            r.each(function(t, v) {
                var u = $(v).closest("tr").find("input");
                if (u.length === 2) {
                    s.push({
                        TopicId: $(v).data("topicId"),
                        PublishDate: $(u[0]).val().split(" ")[0],
                        ExpireDate: $(u[1]).val()
                    })
                }
            });
            return s
        }
    });
    q.Vs.ImportContentItem = Bb.View.extend({
        template: "topic/topic.import.content.item.template.html",
        tagName: "tr",
        events: {},
        render: function(r) {
            var s = this;
            $(r).append(s.el);
            p3.fT(s.template, function(t) {
                s.$el.html(t({
                    content: s.options.content,
                    schoolId: p3.Data.SchoolContext.get("SchoolInfo").SchoolId
                }))
            })
        }
    });
    q.Vs.ImportSections = Bb.View.extend({
        template: "topic/topic.import.section.list.template.html",
        events: {},
        initialize: function(r) {
            r = r || {};
            this.sections = r.sections || null
        },
        render: function(r) {
            var s = this;
            $(r).html(s.el);
            p3.fT(s.template, function(t) {
                s.$el.html(t({}));
                s.renderItems(s.sections.toJSON())
            })
        },
        renderItems: function(u) {
            var s, t, r = $("#import-topics-section-items");
            r.html('<tr class="ignore"></tr>');
            if (!u || u.length === 0) {
                r.append("<tr><th>No sections found.</th><th></th></tr>")
            } else {
                for (s = 0; s < u.length; s++) {
                    t = u[s];
                    p3.rV(new q.Vs.ImportSectionItem({
                        content: t
                    }), r, false)
                }
                this.$el.trigger("groupsRendered")
            }
            p3.initModalHeightTimer(p3.Layout.Containers.Modal)
        },
        getSelected: function() {
            var r = $("#import-topic-section-container").find("input.section-selection-box:checked"),
                s = [];
            r.each(function(t, u) {
                s.push({
                    ContextValue: $(u).val()
                })
            });
            return s
        }
    });
    q.Vs.ImportSectionItem = Bb.View.extend({
        template: "topic/topic.import.section.item.template.html",
        tagName: "tr",
        events: {},
        render: function(r) {
            var s = this;
            $(r).append(s.el);
            p3.fT(s.template, function(t) {
                s.$el.html(t({
                    content: s.options.content
                }))
            })
        }
    });
    q.Vs.EditDetail = Bb.View.extend({
        template: "topic/topic.detail.edit.template.html",
        events: {
            "click .share-info-link": "toggleShareInfo"
        },
        initialize: function() {
            this.Containers = {};
            this.options.editMode = this.options.editMode || "content"
        },
        dispose: function() {
            p3.closeFixedSidebar();
            p3.closeFixedFooter()
        },
        render: function(r) {
            var s = this;
            s.options.studentId = s.options.studentId || 0;
            s.options.contextLabelId = -1;
            $(r).html(s.el);
            p3.fT(s.template, function(u) {
                var w, v, t;
                s.$el.html(u({}));
                s.Containers.WorkspaceWrap = $(".topic-page-wrap");
                s.Containers.Workspace = $("#topic-workspace");
                w = new q.Cs.TopicGroup({}, {
                    topicId: s.options.topicId
                });
                s.topicGroups = w;
                v = new q.Ms.Topic({
                    Id: s.options.topicId,
                    topicIndexId: s.options.topicIndexId
                });
                s.topic = v;
                t = new q.Cs.Sections({}, {
                    sectionId: s.options.sectionId
                });
                s.sections = t;
                t.fetch({
                    async: false,
                    data: {
                        sectionId: t.sectionId,
                        associationId: 1,
                        teacherId: 0
                    },
                    error: function() {
                        p3.displayError("Error loading teacher sections")
                    },
                    success: function() {
                        if (t.length > 0) {
                            t.each(function(x) {
                                s.options.contextLabelId = x.get("ContextLabelId");
                                if (x.get("SectionId") == s.options.sectionId) {
                                    x.set("Primary", true)
                                }
                            })
                        }
                    }
                });
                w.fetch({
                    data: {
                        id: s.topicGroups.Id
                    },
                    success: function() {
                        q.Data.useFullEditModal = w.useFullEditModal(s.options.leadSectionId);
                        q.Data.shareWarningDismissed = false;
                        if (w.length > 0) {
                            var x = -1;
                            w.each(function(y) {
                                x += 1;
                                if (x === 0) {
                                    v.set("Name", y.get("Name"));
                                    v.set("Description", y.get("Description"));
                                    v.set("ThumbFilename", y.get("ThumbFilename"));
                                    v.set("LayoutId", y.get("LayoutId"));
                                    v.set("AllowCopy", y.get("AllowCopy"))
                                }
                            })
                        }
                        s.renderSidebar();
                        s.renderBuilder();
                        s.renderFooter()
                    },
                    error: function() {
                        p3.displayError("Error loading topic")
                    }
                })
            })
        },
        toggleShareInfo: function(r) {
            var t = this,
                s = t.$(".share-info-text");
            r.preventDefault();
            r.stopPropagation();
            if (s.hasClass("hidden")) {
                s.show();
                s.removeClass("hidden")
            } else {
                s.hide();
                s.addClass("hidden")
            }
        },
        renderSidebar: function() {
            var s = this,
                r = {};
            s.options.sidebarView = new q.Vs.Sidebar({
                model: s.topic,
                sections: s.sections,
                topicGroups: s.topicGroups,
                editMode: s.options.editMode,
                parentView: s
            });
            p3.renderFixedSidebar(s.options.sidebarView, r)
        },
        renderBuilder: function() {
            var t = this,
                s = new q.Cs.TopicContent({}, {
                    topicId: t.topic.get("Id"),
                    topicIndexId: t.topic.get("topicIndexId")
                }),
                r = p3.Data.SchoolContext.get("SchoolInfo").SchoolId;
            s = new q.Cs.TopicContent({}, {
                topicId: t.topic.get("Id"),
                topicIndexId: t.topic.get("topicIndexId")
            });
            s.fetch({
                data: {
                    id: s.topicIndexId
                },
                success: function() {
                    if (s.length > 0) {
                        s = q.Us.collpaseDownloads(s);
                        s.each(function(v) {
                            v.set("inProcessing", false);
                            v.set("AVAlbum", false);
                            switch (v.get("ContentId")) {
                                case 165:
                                    if (v.get("FilesInProcessing") > 0) {
                                        v.set("inProcessing", true)
                                    }
                                    v.set("AVAlbum", true);
                                    break;
                                case 167:
                                    if (v.get("FilesInProcessing") > 0) {
                                        v.set("inProcessing", true)
                                    }
                                    break;
                                case 2:
                                    if (v.get("LinkImage") && v.get("LinkImage").length > 0) {
                                        v.set("LinkImageUrl", "/ftpimages/" + r + "/link/" + v.get("LinkImage"))
                                    }
                                    if (v.get("HoverFileName") && v.get("HoverFileName").length > 0) {
                                        v.set("HoverImageUrl", "/ftpimages/" + r + "/link/" + v.get("HoverFileName"))
                                    }
                                    break;
                                default:
                                    break
                            }
                            var w = b.Us.findContentById(v.get("ContentId"));
                            if (w) {
                                v.set("Name", w.Name);
                                v.set("IconClass", w.IconClass)
                            }
                        })
                    }
                    var u = new q.Vs.Builder({
                        model: t.topic,
                        content: s,
                        leadSectionId: t.options.leadSectionId
                    });
                    p3.rV(u, t.Containers.Workspace, true);
                    u.on("contentChange", function() {
                        t.renderBuilder()
                    });
                    u.on("settingsClick", function(v) {
                        t.options.sidebarView.showEditSettings(v)
                    })
                },
                error: function() {
                    p3.displayError("Error loading topic content")
                }
            })
        },
        renderFooter: function() {
            var s = this,
                r = new q.Vs.Footer({
                    topicId: s.options.topicId,
                    leadSectionId: s.options.leadSectionId,
                    sectionId: s.options.sectionId,
                    topicIndexId: s.options.topicIndexId,
                    studentId: s.options.studentId
                });
            p3.renderFixedFooter(r)
        }
    });
    q.Vs.Footer = Bb.View.extend({
        template: "topic/topic.footer.template.html",
        render: function(r) {
            var s = this;
            $(r).html(s.el);
            s.renderTemplate()
        },
        renderTemplate: function() {
            var r = this;
            p3.fT(r.template, function(s) {
                r.$el.html(s({
                    topicId: r.options.topicId,
                    leadSectionId: r.options.leadSectionId,
                    sectionId: r.options.sectionId,
                    topicIndexId: r.options.topicIndexId,
                    studentId: r.options.studentId
                }))
            })
        }
    });
    q.Vs.Sidebar = Bb.View.extend({
        template: "topic/topic.sidebar.template.html",
        shareTemplate: "topic/topic.detail.shareinfo.template.html",
        className: "workspace-sidebar",
        events: {
            "click .workspace-sidebar-tab": "tabClicked",
            "click #pages-layout-settings": "showEditSettings",
            "click .backlink": "goBack"
        },
        initialize: function() {
            this.Containers = {};
            this.leadSectionId = this.options.parentView.options.leadSectionId;
            _.bindAll(this, "publishSaveCallback", "fullEditSaveCallback")
        },
        render: function(r) {
            var s = this;
            $(r).html(s.el);
            s.loadContentData(function() {
                s.renderTemplate()
            })
        },
        renderTemplate: function() {
            var r = this;
            p3.fT(r.template, function(t) {
                var s = r.getLayoutIcon(r.model.get("LayoutId"));
                r.$el.html(t({
                    model: r.model.toJSON(),
                    layoutIcon: s,
                    groups: r.options.topicGroups.toJSON(),
                    content: r.filterContentData(16),
                    elements: r.filterContentData(32),
                    topicElements: r.filterContentData(64)
                }));
                r.selectTab(r.options.editMode);
                r.updateView()
            })
        },
        goBack: function(r) {
            var t = this,
                s;
            r.stopPropagation();
            r.preventDefault();
            s = q.Us.getBackToTopicsLink(t.options.parentView.options);
            if (s) {
                window.location = s
            } else {
                window.history.back()
            }
        },
        getLayoutIcon: function(s) {
            var r = "";
            switch (s) {
                case 0:
                    r = "p3icon-2colLeft";
                    break;
                case 1:
                    r = "p3icon-2colRight";
                    break;
                case 2:
                    r = "p3icon-2rowLeft";
                    break;
                case 3:
                    r = "p3icon-2rowRight";
                    break;
                case 4:
                    r = "p3icon-2colSplit";
                    break;
                case 5:
                    r = "p3icon-3col";
                    break
            }
            return r
        },
        tabClicked: function(t) {
            t.preventDefault();
            var u = this,
                r = $(t.currentTarget),
                s = r.data("action");
            u.selectTab(s);
            return false
        },
        selectTab: function(r) {
            var s = this;
            s.$el.find(".workspace-sidebar-tabs LI.active").removeClass("active");
            $(".workspace-sidebar-tab").removeClass("active");
            s.$el.find(".workspace-sidebar-content > div").hide();
            s.$el.find('.workspace-sidebar-tab[data-action="' + r + '"]').parent().addClass("active");
            s.$el.find('.workspace-sidebar-tab[data-action="' + r + '"]').addClass("active");
            s.$el.find('.workspace-sidebar-content > div[data-id="' + r + '"]').show()
        },
        loadContentData: function(r) {
            var t = this,
                s;
            if (t.options.contentTypes) {
                return r()
            }
            s = new q.Cs.TopicContentTypes();
            s.fetch({
                success: function() {
                    t.options.contentTypes = s.toJSON();
                    return r()
                },
                error: function() {
                    p3.displayError("Error loading content types.")
                }
            })
        },
        filterContentData: function(u) {
            var v = this,
                s = [],
                r, t;
            if (v.options.contentTypes) {
                r = v.options.contentTypes;
                _.each(r, function(w) {
                    if (w.ObjectTypeId == u) {
                        t = b.Us.findContentById(w.Id);
                        if (t) {
                            w.Name = t.Name;
                            w.IconClass = t.IconClass;
                            s.push(w)
                        }
                    }
                })
            }
            return s
        },
        getElements: function() {
            var r = [];
            r.push({
                Id: 0,
                Name: "Header",
                IconClass: "p3icon-header"
            });
            return r
        },
        getBoardElements: function() {
            var r = [];
            r.push({
                Id: 0,
                Name: "Cover Image",
                IconClass: "p3icon-image"
            });
            return r
        },
        updateView: function() {
            var u = this,
                r = $("#groups-list"),
                s = $("#groups-list-shared"),
                t;
            $("#topic-name").html(u.model.get("Name"));
            $("#layout-icon").removeClass().addClass(u.getLayoutIcon(u.model.get("LayoutId")));
            r.children().remove();
            s.children().remove();
            u.options.topicGroups.each(function(v) {
                if (v.get("Primary")) {
                    r.append("<li>" + v.get("GroupName") + "</li>")
                } else {
                    s.append("<li>" + v.get("GroupName") + "</li>")
                }
            });
            p3.fT(u.shareTemplate, function(v) {
                t = u.options.topicGroups.getShareInfo(u.options.parentView.options.leadSectionId);
                t.shareLabel = q.Us.getPluralLabel(q.Us.getAssociationFromContext(q.Data.contextLabelId));
                u.options.parentView.$(".topic-share-display-area").html(v({
                    shareInfo: t
                }));
                q.Us.checkShareWarning(t, u.model.get("topicIndexId"))
            })
        },
        showEditSettings: function(r) {
            r.preventDefault();
            var v = this,
                t = v.options.topicGroups,
                u, s;
            if (v.options.sections.length > 0) {
                v.options.sections.each(function(w) {
                    if (t.select(function(x) {
                            return x.get("SectionId") == w.get("LeadSectionId")
                        }).length === 0) {
                        u = new q.Ms.TopicGroup();
                        u.set("SectionId", w.get("LeadSectionId"));
                        u.set("IsSelected", false);
                        u.set("PublishDate", null);
                        u.set("ExpireDate", null);
                        u.set("Primary", false);
                        u.set("GroupName", w.get("GroupName"));
                        u.set("TopicIndexId", 0);
                        u.set("ContextLabelId", w.get("ContextLabelId"));
                        t.add(u)
                    }
                })
            }
            t.each(function(w) {
                w.set("LeadSectionId", w.get("SectionId"))
            });
            if (q.Data.useFullEditModal) {
                s = new q.Vs.TopicEditView({
                    topic: v.model,
                    groups: t,
                    defaultDate: d.getDateString(d.localDateTime()),
                    topicView: v,
                    detailPage: true,
                    callback: v.fullEditSaveCallback
                })
            } else {
                s = new q.Vs.PublishShareModal({
                    topicId: v.model.get("Id"),
                    leadSectionId: v.leadSectionId,
                    groups: t,
                    topicView: v,
                    callback: v.publishSaveCallback,
                    canEditTopicInd: true
                })
            }
            p3.rV(s, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal)
        },
        fullEditSaveCallback: function() {
            var s = this,
                r = s.options.model.get("Id");
            s.options.topicGroups.fetch({
                data: {
                    id: r
                },
                success: function() {
                    s.updateView();
                    s.options.parentView.topic = s.model;
                    s.options.parentView.renderBuilder()
                },
                error: function() {
                    p3.displayError("Error loading topic sections")
                }
            })
        },
        publishSaveCallback: function(s) {
            var v = this,
                u, t, r = function(w) {
                    return v.options.topicGroups.find(function(x) {
                        return x.get("LeadSectionId") === w.ContextValue
                    })
                };
            for (t = 0; t < s.length; t++) {
                u = r(s[t]);
                if (u) {
                    u.set("ExpireDate", s[t].ExpireDate);
                    u.set("PublishDate", s[t].PublishDate)
                }
            }
        },
        getBlockModel: function() {
            var w = this,
                t = w.options.parentView.options.page,
                u = t.get("PageRegions")[0],
                v = $(".style-element.selected").data("row"),
                s = $(".style-element.selected").data("column"),
                r = $(".style-element.selected").data("block");
            return u.Rows[v].Columns[s].ContentBlocks[r]
        },
        savePage: function() {
            var s = this,
                r = s.options.parentView.options.page;
            r.set("PendingInd", true);
            r.save({}, {
                dataParam: {
                    saveStructure: true,
                    returnModel: true
                },
                success: function(t, u) {
                    s.options.builderData.set({
                        PageRegions: t.get("PageRegions")
                    }, {
                        silent: true
                    });
                    s.options.builderData.trigger("save");
                    r.trigger("change")
                },
                error: function() {
                    p3.displayError("Error saving page")
                }
            })
        }
    });
    q.Vs.Builder = Bb.View.extend({
        template: "topic/topic.builder.template.html",
        events: {
            "click .pages-layout-block-delete": "deleteContent",
            "click .pages-layout-block-edit": "editContent",
            "click .pages-layout-block-add": "addAdditionalContent",
            "click .download-edit-button": "editContent",
            "click .download-delete-button": "deleteContent",
            "click .topic-detail-edit-button": "showEditSettings",
            "click .topic-options-button": "showOptions",
            "click .pages-layout-block-remove": "removeContent",
            "click .pages-layout-block-remove-share": "removeShared",
            "click .download-remove-button": "removeShared",
            "click .pages-layout-block-organize": "organizeContent"
        },
        initialize: function() {
            this.Containers = {}
        },
        render: function(r) {
            var s = this;
            $(r).html(s.el);
            s.renderTemplate()
        },
        renderTemplate: function() {
            var s = this,
                r = q.Us.buildRows(s.model.get("LayoutId"));
            p3.fT(s.template, function(v) {
                var t, u;
                s.$el.html(v({
                    rows: r
                }));
                t = $("#topic-workspace");
                t.css({
                    "background-color": "rgb(242,249,255)",
                    "background-image": "linear-gradient(90deg, transparent 28px, rgba(255,255,255,61) 38px)",
                    "background-size": "38px"
                });
                p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.jQueryUI, function() {
                    window.setTimeout(function() {
                        var w;
                        s.initDraggable();
                        s.initSortable();
                        s.options.content.each(function(x) {
                            w = x.get("ContentId");
                            if (w === p3.Us.Enum.Content.LTI.Value) {
                                x.set("canEdit", true)
                            } else {
                                if (w < 404) {
                                    x.set("canEdit", true)
                                }
                            }
                            u = new q.Vs.ContentItem({
                                model: x
                            });
                            p3.rV(u, $("#column" + x.get("RowIndex") + "_" + x.get("ColumnIndex")), false)
                        })
                    }, 400)
                })
            })
        },
        initDraggable: function() {
            $(".pages-layout-draggable-content").draggable({
                connectToSortable: ".pages-layout-col.editable",
                placeholder: "pages-layout-placeholder",
                forcePlaceholderSize: true,
                tolerance: "pointer",
                helper: "clone",
                delay: 300,
                appendTo: "body"
            }).disableSelection()
        },
        initSortable: function() {
            var r = this;
            $(".pages-layout-col").sortable({
                items: "> DIV.pages-layout-block.editable",
                connectWith: ".pages-layout-col.editable",
                handle: ".pages-layout-block-header",
                placeholder: "pages-layout-placeholder",
                forcePlaceholderSize: true,
                tolerance: "pointer",
                delay: 300,
                stop: function(B, K) {
                    var t = $(K.item),
                        s = t.closest(".pages-layout-col"),
                        w = s.data("col"),
                        G = s.data("row"),
                        x = t.data("id"),
                        I = r.model.get("Id"),
                        J = r.model.get("topicIndexId"),
                        v = t.index(),
                        C, D, y, E, z, F, u, L, H, A;
                    if (t.hasClass("workspace-draggable-item")) {
                        _.defer(function() {
                            t.remove()
                        });
                        D = r.getLayoutOrder(G, w, v);
                        if (x == 415) {
                            for (C = 0; C < D.length; C++) {
                                if (D[C].ContentId == 415) {
                                    return
                                }
                            }
                        }
                        y = new q.Ms.TopicContent({
                            topicContentId: 0,
                            shortDescription: "",
                            longDescription: "",
                            Url: "",
                            FileName: ""
                        });
                        switch (x) {
                            case 2:
                                E = j.Us.showTopicLinkDialog(0, y, I, J, 999, r.options.leadSectionId, q.Data.contextLabelId);
                                E.on("linkSaved", function(N, M) {
                                    if (!M) {
                                        M = -1
                                    }
                                    p3.showModal(p3.Layout.Containers.Modal, "hide");
                                    r.addContent(D, x, M, G, w, v, 0)
                                });
                                break;
                            case 3:
                                z = g.Us.showTopicDownloadDialog(0, y, I, J, 999, r.options.leadSectionId, q.Data.contextLabelId);
                                z.on("downloadAdded", function(M) {
                                    if (!M) {
                                        M = -1
                                    }
                                    p3.showModal(p3.Layout.Containers.Modal, "hide");
                                    r.addContent(D, x, M, G, w, v, 0)
                                });
                                break;
                            case 31:
                                F = l.Us.showTopicPhotoDialog(0, y, I, J, 999, r.options.leadSectionId, q.Data.contextLabelId);
                                F.on("photoSaved", function(M) {
                                    if (!M) {
                                        M = -1
                                    }
                                    p3.showModal(p3.Layout.Containers.Modal, "hide");
                                    r.addContent(D, x, M, G, w, v, 0)
                                });
                                break;
                            case 165:
                                u = l.Us.showTopicAudioDialog(0, y, I, J, 999, "", r.options.leadSectionId, q.Data.contextLabelId);
                                u.on("audioSaved", function(M) {
                                    if (!M) {
                                        M = -1
                                    }
                                    p3.showModal(p3.Layout.Containers.Modal, "hide");
                                    r.addContent(D, x, M, G, w, v, 0)
                                });
                                break;
                            case 167:
                                L = l.Us.showTopicVideoDialog(0, y, I, J, 999, "", r.options.leadSectionId, q.Data.contextLabelId);
                                L.on("videoSaved", function(M) {
                                    if (!M) {
                                        M = -1
                                    }
                                    p3.showModal(p3.Layout.Containers.Modal, "hide");
                                    r.addContent(D, x, M, G, w, v, 0)
                                });
                                break;
                            case 1:
                                H = new q.Vs.TopicTextEditView({
                                    Id: 0,
                                    Text: "",
                                    topicId: I,
                                    topicIndexId: J,
                                    sort: 0
                                });
                                p3.rV(H, p3.Layout.Containers.Modal, true);
                                p3.showModal(p3.Layout.Containers.Modal, {});
                                H.on("textSaved", function() {
                                    p3.showModal(p3.Layout.Containers.Modal, "hide");
                                    r.addContent(D, x, -1, G, w, v, 0)
                                });
                                break;
                            case 387:
                                A = new q.Vs.TopicWidgetEditView({
                                    mode: "Add",
                                    loadedId: 0,
                                    topicId: I,
                                    topicIndexId: J,
                                    ContextValue: I,
                                    sortOrder: 0,
                                    contentItem: y
                                });
                                p3.rV(A, p3.Layout.Containers.Modal, true);
                                p3.showModal(p3.Layout.Containers.Modal, {});
                                A.on("embedSaved", function() {
                                    p3.showModal(p3.Layout.Containers.Modal, "hide");
                                    r.addContent(D, x, -1, G, w, v, 0)
                                });
                                break;
                            case p3.Us.Enum.Content.LTI.Value:
                                k.Us.OpenToolModal("Add", 0, 27, I, false, function(M) {
                                    M.on("ltiToolSaved", function() {
                                        p3.showModal(p3.Layout.Containers.Modal, "hide");
                                        r.addContent(D, x, -1, G, w, v, 0)
                                    })
                                });
                                break;
                            default:
                                r.addContent(D, x, 0, G, w, v, 0);
                                break
                        }
                    } else {
                        D = r.getLayoutOrder(-1, -1, -1);
                        r.saveLayout(D, false)
                    }
                }
            }).disableSelection()
        },
        getLayoutOrder: function(B, t, y) {
            var u = [],
                s = -1,
                A = -1,
                z = -1,
                v, D, E = 0,
                C, w, r, x;
            $(".pages-layout-col").each(function(F, G) {
                D = false;
                A = $(G).data("row");
                s = $(G).data("col");
                z = -1;
                $(G).find(".pages-layout-block").each(function(I, H) {
                    C = null;
                    if (B == A && t == s && I == y) {
                        z += 2
                    } else {
                        z += 1
                    }
                    r = $(H).find(".pages-layout-block-header");
                    v = r.data("id");
                    x = r.data("locked");
                    if (v == 3 && $(H).find(".pages-layout-block-header").data("indexid") == "0") {
                        D = true
                    } else {
                        if (v == 3) {
                            E = $(H).find(".download-row").data("sort");
                            C = $(H).find(".download-row").data("categoryid") || 0
                        } else {
                            if (v === 2) {
                                w = r.data("display");
                                if (w) {
                                    C = {
                                        DisplayOption: w
                                    };
                                    C = C ? JSON.stringify(C) : null
                                }
                            }
                        }
                    }
                    if (!D) {
                        u.push({
                            ContentId: v,
                            ContentIndexId: $(H).find(".pages-layout-block-header").data("indexid"),
                            RowIndex: A,
                            ColumnIndex: s,
                            CellIndex: z,
                            SortOrder: E,
                            GenericSettings: C,
                            Locked: x
                        })
                    }
                    if (v == 3) {
                        $(H).find(".additional-download-item").each(function(J, K) {
                            u.push({
                                ContentId: v,
                                ContentIndexId: $(K).data("index"),
                                RowIndex: A,
                                ColumnIndex: s,
                                CellIndex: z,
                                SortOrder: $(K).data("sort"),
                                GenericSettings: $(K).data("categoryid") || 0,
                                Locked: x
                            })
                        })
                    }
                })
            });
            return u
        },
        saveLayout: function(r, s) {
            var u = this,
                t = new q.Ms.TopicContentSort({
                    TopicId: u.model.get("Id")
                });
            t.set({
                ContentItems: r
            });
            t.save({}, {
                error: function() {
                    p3.displayError("Error saving topic layout")
                },
                success: function() {
                    if (s) {
                        u.trigger("contentChange")
                    }
                }
            })
        },
        addContent: function(z, t, u, A, s, r, B) {
            var C = this,
                x, v = false,
                y, w = null;
            if (u == -1) {
                y = new q.Ms.TopicContentIndex({
                    contentId: t,
                    topicId: C.model.get("Id")
                });
                y.fetch({
                    async: false,
                    success: function() {
                        u = y.get("content_index_id")
                    },
                    error: function() {
                        p3.displayError("Error getting content index")
                    }
                })
            }
            if (t === 3) {
                w = 0;
                for (x = 0; x < z.length; x++) {
                    if (z[x].ContentId === t && z[x].RowIndex === A && z[x].ColumnIndex === s && z[x].CellIndex === r) {
                        if (v) {
                            z[x].SortOrder = z[x].SortOrder + 1
                        } else {
                            if (z[x].GenericSettings.toString() !== "0") {
                                v = true;
                                B = x;
                                z[x].SortOrder = z[x].SortOrder + 1
                            }
                        }
                    }
                }
            }
            z.push({
                ContentId: t,
                ContentIndexId: u,
                RowIndex: A,
                ColumnIndex: s,
                CellIndex: r,
                SortOrder: B,
                GenericSettings: w
            });
            C.saveLayout(z, true)
        },
        deleteContent: function(x) {
            x.preventDefault();
            var C = this,
                r = $(x.currentTarget),
                t = r.data("id"),
                v = r.data("itemid"),
                y = "",
                u, w, A, s, z, B;
            switch (t) {
                case 2:
                case 31:
                case 165:
                case 167:
                case 1:
                case 387:
                    u = q.Us.getContentItem(C.options.content, v);
                    y = u.get("FileName");
                    w = new q.Vs.TopicContentDeleteView({
                        Id: v,
                        ContentId: t,
                        TopicId: C.model.get("Id"),
                        FileName: y,
                        topicIndexId: C.model.get("topicIndexId")
                    });
                    p3.rV(w, p3.Layout.Containers.Modal, true);
                    p3.showModal(p3.Layout.Containers.Modal, {});
                    w.on("contentDeleted", function() {
                        r.parents(".pages-layout-block").remove();
                        C.saveLayout(C.getLayoutOrder(-1, -1, -1), false)
                    });
                    break;
                case p3.Us.Enum.Content.LTI.Value:
                    w = new q.Vs.TopicContentDeleteView({
                        Id: v,
                        ContentId: t,
                        TopicId: C.model.get("ToolId"),
                        FileName: y,
                        topicIndexId: C.model.get("topicIndexId")
                    });
                    p3.rV(w, p3.Layout.Containers.Modal, true);
                    p3.showModal(p3.Layout.Containers.Modal, {});
                    w.on("contentDeleted", function() {
                        r.parents(".pages-layout-block").remove();
                        C.saveLayout(C.getLayoutOrder(-1, -1, -1), false)
                    });
                    break;
                case 3:
                    A = r.data("parentid");
                    B = true;
                    if (A) {
                        s = q.Us.getContentItem(C.options.content, A).get("AdditionalItems");
                        for (z = 0; z < s.length; z++) {
                            if (s[z].ContentItemId == v) {
                                u = new q.Ms.TopicContent(s[z])
                            }
                        }
                        B = false
                    } else {
                        u = q.Us.getContentItem(C.options.content, v);
                        if (u.get("AdditionalItems") && u.get("AdditionalItems").length > 0) {
                            B = false;
                            r.parents(".pages-layout-block").find(".pages-layout-block-header").data("indexid", "0")
                        }
                    }
                    y = u.get("FileName");
                    w = new q.Vs.TopicContentDeleteView({
                        Id: v,
                        ContentId: t,
                        TopicId: C.model.get("Id"),
                        FileName: y,
                        topicIndexId: C.model.get("topicIndexId")
                    });
                    p3.rV(w, p3.Layout.Containers.Modal, true);
                    p3.showModal(p3.Layout.Containers.Modal, {});
                    w.on("contentDeleted", function() {
                        if (B) {
                            r.parents(".pages-layout-block").remove()
                        } else {
                            r.parents("tr").remove()
                        }
                        C.saveLayout(C.getLayoutOrder(-1, -1, -1), false)
                    });
                    break;
                default:
                    r.parents(".pages-layout-block").remove();
                    C.saveLayout(C.getLayoutOrder(-1, -1, -1), false);
                    break
            }
        },
        removeContent: function(r) {
            r.preventDefault();
            this.doRemoveContent(r, false)
        },
        removeShared: function(r) {
            r.preventDefault();
            this.doRemoveContent(r, true)
        },
        doRemoveContent: function(x, z) {
            x.preventDefault();
            var E = this,
                r = $(x.currentTarget),
                u = parseInt(r.data("id"), 10),
                t = r.data("column"),
                C = r.data("row"),
                s = r.data("cell"),
                D, w = [],
                y, B = true,
                A, v;
            if (z) {
                y = "Are you sure you want to remove this content from the topic?<br />The content will remain on copied versions of this topic.";
                if (u === 3) {
                    A = r.data("parentid");
                    if (A) {
                        B = false
                    } else {
                        v = q.Us.getContentItem(E.options.content, r.data("itemid"));
                        if (v.get("AdditionalItems") && v.get("AdditionalItems").length > 0) {
                            B = false;
                            r.parents(".pages-layout-block").find(".pages-layout-block-header").data("indexid", "0")
                        }
                    }
                }
            } else {
                y = "Are you sure you want to remove this copied content from the topic?"
            }
            p3.showConfirm(null, y, null, function() {
                w.push({
                    ContentId: u,
                    RowIndex: C,
                    ColumnIndex: t,
                    CellIndex: s,
                    ContentIndexId: u === 3 && z ? r.data("itemid") : null
                });
                D = new q.Ms.RemoveContent({
                    TopicId: E.model.get("Id"),
                    ContentItems: w
                });
                D.save({}, {
                    error: function() {
                        p3.displayError("Error removing copied content")
                    },
                    success: function() {
                        if (B) {
                            r.parents(".pages-layout-block").remove()
                        } else {
                            r.parents("tr").remove()
                        }
                        E.saveLayout(E.getLayoutOrder(-1, -1, -1), false)
                    }
                })
            })
        },
        editContent: function(y) {
            y.preventDefault();
            var H = this,
                r = $(y.currentTarget),
                u = r.data("id"),
                w = r.data("itemid"),
                E = H.model.get("Id"),
                F = H.model.get("topicIndexId"),
                v = q.Us.getContentItem(H.options.content, w),
                A, B, s, x, C, t, G, D, z;
            switch (u) {
                case 2:
                    B = j.Us.showTopicLinkDialog(w, v, E, F, 999, q.Data.contextLabelId);
                    B.on("linkSaved", function() {
                        p3.showModal(p3.Layout.Containers.Modal, "hide");
                        H.trigger("contentChange")
                    });
                    break;
                case 3:
                    if (!v) {
                        s = q.Us.getContentItem(H.options.content, r.data("parentid")).get("AdditionalItems");
                        for (A = 0; A < s.length; A++) {
                            if (s[A].ContentItemId == w) {
                                v = new q.Ms.TopicContent(s[A])
                            }
                        }
                    }
                    x = g.Us.showTopicDownloadDialog(w, v, E, F, 999, q.Data.contextLabelId);
                    x.on("downloadAdded", function() {
                        p3.showModal(p3.Layout.Containers.Modal, "hide");
                        H.trigger("contentChange")
                    });
                    break;
                case 31:
                    C = l.Us.showTopicPhotoDialog(w, v, E, F, 999, q.Data.contextLabelId);
                    C.on("photoSaved", function() {
                        p3.showModal(p3.Layout.Containers.Modal, "hide");
                        H.trigger("contentChange")
                    });
                    break;
                case 165:
                    t = l.Us.showTopicAudioDialog(w, v, E, F, 999, v.get("LongDescription"), q.Data.contextLabelId);
                    t.on("audioSaved", function() {
                        p3.showModal(p3.Layout.Containers.Modal, "hide");
                        H.trigger("contentChange")
                    });
                    break;
                case 167:
                    G = l.Us.showTopicVideoDialog(w, v, E, F, 999, v.get("LongDescription"), q.Data.contextLabelId);
                    G.on("videoSaved", function() {
                        p3.showModal(p3.Layout.Containers.Modal, "hide");
                        H.trigger("contentChange")
                    });
                    break;
                case 1:
                    D = new q.Vs.TopicTextEditView({
                        Id: w,
                        Text: v.get("LongDescription"),
                        topicId: E,
                        topicIndexId: F,
                        sort: 0
                    });
                    p3.rV(D, p3.Layout.Containers.Modal, true);
                    p3.showModal(p3.Layout.Containers.Modal, {});
                    D.on("textSaved", function() {
                        p3.showModal(p3.Layout.Containers.Modal, "hide");
                        H.trigger("contentChange")
                    });
                    break;
                case 387:
                    z = new q.Vs.TopicWidgetEditView({
                        mode: "Edit",
                        loadedId: w,
                        topicId: E,
                        topicIndexId: F,
                        ContextValue: E,
                        sortOrder: 0,
                        contentItem: v
                    });
                    p3.rV(z, p3.Layout.Containers.Modal, true);
                    p3.showModal(p3.Layout.Containers.Modal, {});
                    z.on("embedSaved", function() {
                        p3.showModal(p3.Layout.Containers.Modal, "hide");
                        H.trigger("contentChange")
                    });
                    break;
                case p3.Us.Enum.Content.LTI.Value:
                    k.Us.OpenToolModal("Edit", w, 27, E, false, function(I) {
                        I.on("ltiToolSaved", function() {
                            p3.showModal(p3.Layout.Containers.Modal, "hide");
                            H.trigger("contentChange")
                        })
                    });
                    break
            }
        },
        organizeContent: function(w) {
            var B = this,
                r = B.$(w.currentTarget),
                A = r.data("row"),
                t = r.data("column"),
                s = r.data("cell"),
                x, v, y = new c.Ms.GroupId(),
                z = [],
                u;
            w.preventDefault();
            u = _.filter(B.options.content.toJSON(), function(C) {
                return C.CellIndex === s && C.ColumnIndex === t && C.RowIndex === A
            })[0];
            z.push({
                id: u.ContentItemId,
                sort: u.SortOrder
            });
            if (u.AdditionalItems.length > 0) {
                _.each(u.AdditionalItems, function(C) {
                    z.push({
                        id: C.ContentItemId,
                        sort: C.SortOrder
                    })
                })
            }
            y.fetch({
                data: {
                    contextLabelId: 27,
                    contentType: "D"
                },
                success: function(C, E) {
                    x = E;
                    v = new g.Cs.Download({}, {
                        active: true,
                        future: true,
                        expired: true,
                        categoryId: x,
                        contextLabelId: 27
                    });
                    var D = new c.Vs.SubCategoryOrganize({
                        collection: v,
                        categoryId: x,
                        enumObj: p3.Us.Enum.Content.DOWNLOAD,
                        contextLabelId: 27,
                        contextValue: B.options.content.topicId,
                        topicRow: A,
                        topicColumn: t,
                        topicCell: s,
                        downloadIds: z
                    });
                    D.on("organizeDataSaved", function() {
                        B.trigger("contentChange")
                    });
                    p3.rV(D, p3.Layout.Containers.Modal, true);
                    p3.showModal(p3.Layout.Containers.Modal)
                },
                error: function() {
                    p3.displayError("Error loading group Id.")
                }
            });
            return false
        },
        addAdditionalContent: function(x) {
            x.preventDefault();
            var C = this,
                r = $(x.currentTarget),
                u = r.data("id"),
                z = r.data("row"),
                t = r.data("column"),
                s = r.data("cell"),
                A = C.model.get("Id"),
                B = C.model.get("topicIndexId"),
                v = new q.Ms.TopicContent({
                    topicContentId: 0,
                    shortDescription: "",
                    longDescription: "",
                    Url: "",
                    FileName: ""
                }),
                w, y = r.parents(".pages-layout-block").find(".download-row").length;
            switch (u) {
                case 3:
                    w = g.Us.showTopicDownloadDialog(0, v, A, B, 999, C.options.leadSectionId, q.Data.contextLabelId);
                    w.on("downloadAdded", function(D) {
                        if (!D) {
                            D = -1
                        }
                        p3.showModal(p3.Layout.Containers.Modal, "hide");
                        C.addContent(C.getLayoutOrder(-1, -1, -1), u, D, z, t, s, y)
                    });
                    break
            }
        },
        showEditSettings: function(r) {
            r.preventDefault();
            this.trigger("settingsClick", r)
        },
        showOptions: function(v) {
            var z = this,
                r = $(v.currentTarget),
                t = r.data("itemid"),
                x, s, y, u = "optTitle",
                w;
            v.preventDefault();
            s = q.Us.getContentItem(z.options.content, t);
            if (s.get("GenericSettings")) {
                y = JSON.parse(s.get("GenericSettings"));
                if (y.DisplayOption) {
                    u = y.DisplayOption
                }
            }
            x = new q.Vs.Options({
                displayOption: u
            });
            p3.rV(x, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            x.on("OptionsSaved", function(A) {
                r.parents(".pages-layout-block-header").data("display", A);
                y = {
                    DisplayOption: A
                };
                s.set("GenericSettings", JSON.stringify(y));
                w = z.getLayoutOrder(-1, -1, -1);
                z.saveLayout(w, false)
            })
        }
    });
    q.Vs.ExistingContent = Bb.View.extend({
        template: "topic/topiccontent.existing.template.html",
        events: {
            "change #existing-content-school-year-dd": "schoolYearChange",
            "change #existing-content-section-dd": "sectionChange",
            "click .existing-content-sort": "updateSort"
        },
        renderTemplate: function() {
            var s = this,
                r = new q.Cs.ExistingSchoolYears({}, {});
            r.fetch({
                success: function() {
                    var u = r.where({
                            Current: true
                        }),
                        t;
                    if (u.length > 0) {
                        s.currentYear = u[0].get("Id")
                    }
                    s.SectionsForTeacher = new q.Cs.SectionsByYear();
                    t = 1;
                    if (q.Data.contextLabelId == 12) {
                        t = 3
                    }
                    s.SectionsForTeacher.fetch({
                        data: {
                            facultyUserId: p3.Data.Context.get("UserInfo").UserId,
                            schoolYear: s.currentYear,
                            associationId: t
                        },
                        success: function(w, x) {
                            var v = w.toJSON(),
                                y;
                            v = _.uniq(v, true, function(z) {
                                return z.SectionId
                            });
                            switch (s.options.contentType) {
                                case 31:
                                case 165:
                                case 167:
                                    y = "album_filename_url";
                                    break;
                                default:
                                    y = "content_short_description";
                                    break
                            }
                            s.sortColumn = y;
                            p3.fT(s.template, function(z) {
                                s.$el.html(z({
                                    SchoolYears: r.toJSON(),
                                    Sections: v,
                                    sortColumn: y
                                }));
                                if (s.SectionsForTeacher.length > 0) {
                                    s.activeSection = s.SectionsForTeacher.models[0].get("SectionId")
                                }
                                s.getExistingContent()
                            })
                        },
                        error: function(v, w) {
                            p3.displayError("Error retrieving sections.")
                        }
                    })
                },
                error: function() {
                    p3.displayError("Error loading school years")
                }
            })
        },
        initialize: function() {
            var r = new q.Cs.ExistingSchoolYears({}, {});
            this.schoolYears = r;
            r.fetch({
                error: function() {
                    p3.displayError("Error loading school years")
                }
            })
        },
        render: function(r) {
            $(r).append(this.el);
            this.renderTemplate()
        },
        schoolYearChange: function(t) {
            var w = this,
                v, s, u, r;
            w.currentYear = $("#existing-content-school-year-dd").val();
            w.SectionsForTeacher.fetch({
                data: {
                    facultyUserId: p3.Data.Context.get("UserInfo").UserId,
                    schoolYear: w.currentYear
                },
                success: function(x, y) {
                    s = x.toJSON();
                    s = _.uniq(s, true, function(z) {
                        return z.SectionId
                    });
                    r = $("#existing-content-section-dd");
                    r.html("");
                    for (v = 0; v < s.length; v++) {
                        u = $("<option>", {
                            value: s[v].SectionId
                        }).html(s[v].Name);
                        r.append(u)
                    }
                    if (w.SectionsForTeacher.length > 0) {
                        w.activeSection = w.SectionsForTeacher.models[0].get("SectionId")
                    }
                    w.getExistingContent()
                },
                error: function(x, y) {
                    p3.displayError("Error retrieving sections.")
                }
            })
        },
        sectionChange: function(r) {
            var s = this;
            s.activeSection = $("#existing-content-section-dd").val();
            s.getExistingContent()
        },
        getExistingContent: function() {
            var s = this,
                r = false;
            if (s.activeSection <= 0) {
                s.renderItems([]);
                if (!_.isUndefined(s.ExistingContent)) {
                    s.ExistingContent.remove(s.ExistingTopics.models)
                }
                return
            }
            if (_.isUndefined(s.ExistingContent)) {
                s.ExistingContent = new q.Cs.ExistingContent({}, {
                    contentId: s.options.contentType,
                    sectionId: s.activeSection
                });
                s.ExistingContent.filters = {
                    album_filename_url: function(v, w) {
                        var t = v.get("album_filename_url") || "",
                            u = w.get("album_filename_url") || "";
                        return t < u ? -1 : t > u ? 1 : 0
                    },
                    content_insert_date: function(t) {
                        return d.getDate(t.get("content_insert_date")).getTime()
                    },
                    content_short_description: function(v, w) {
                        var t = v.get("content_short_description") || "",
                            u = w.get("content_short_description") || "";
                        return t < u ? -1 : t > u ? 1 : 0
                    },
                    album_filename_url_invert: function(v, w) {
                        var t = v.get("album_filename_url") || "",
                            u = w.get("album_filename_url") || "";
                        return t < u ? 1 : t > u ? -1 : 0
                    },
                    content_insert_date_invert: function(t) {
                        return -d.getDate(t.get("content_insert_date")).getTime()
                    },
                    content_short_description_invert: function(v, w) {
                        var t = v.get("content_short_description") || "",
                            u = w.get("content_short_description") || "";
                        return t < u ? 1 : t > u ? -1 : 0
                    }
                };
                r = true
            } else {
                s.ExistingContent.sectionId = s.activeSection
            }
            s.ExistingContent.fetch({
                success: function(t, u) {
                    if (r) {
                        s.CurrentSort = s.sortColumn;
                        s.ExistingContent.changeSort(s.sortColumn);
                        s.ExistingContent.sort()
                    }
                    s.renderItems(t.toJSON());
                    p3.setModalHeight(p3.Layout.Containers.Modal)
                },
                error: function(t, u) {
                    p3.displayError("Error retreiving Existing Content.")
                }
            })
        },
        renderItems: function(t) {
            var r = "",
                s;
            if (t && t.length > 0) {
                for (s = 0; s < t.length; s++) {
                    r += '<tr><td><label class="radio"><input type="radio" name="existing-content-options" value="' + t[s].content_item_id + '" data-index="' + t[s].content_index_id + '"></label></td>';
                    if (t[s].content_short_description == null) {
                        r += "<td>" + t[s].album_filename_url + "</td>"
                    } else {
                        r += "<td>" + t[s].content_short_description + "</td>"
                    }
                    r += "<td>" + d.getDateString(d.getDate(t[s].content_insert_date)) + "</td></tr>"
                }
                $("#existing-items-table").html(r)
            } else {
                $("#existing-items-table").html("<tr><td></td><td>There is no content to display.</td><td></td></tr>")
            }
        },
        moveContent: function() {
            var x = this,
                u = 0,
                w = x.$("input:radio[name=existing-content-options]:checked"),
                r, t, s, v;
            if (w.length) {
                r = w.val();
                t = [];
                s = w.data("index");
                t.push({
                    ContentId: x.options.contentType,
                    ContentIndexId: r
                });
                v = new q.Ms.TopicContentMove({
                    TopicId: x.options.topicId,
                    SectionId: x.activeSection,
                    ContentItems: t
                });
                v.save({}, {
                    async: false,
                    success: function(y, z) {
                        u = s
                    },
                    error: function(y, z) {
                        p3.displayError("Error moving content")
                    }
                })
            }
            return u
        },
        updateSort: function(s) {
            var u = this,
                r = $(s.currentTarget),
                t = r.data("sort");
            $(".sort-icon").removeClass("p3icon-sortDown p3icon-sortUp p3icon-sortOff");
            $(".sort-icon").addClass("p3icon-sortOff");
            $(".existing-content-sort").removeClass("sort-active").addClass("muted");
            if (t) {
                if (u.CurrentSort === t) {
                    t = t + "_invert";
                    r.removeClass("muted").addClass("sort-active");
                    r.children("i").removeClass("p3icon-sortOff").addClass("p3icon-sortUp")
                } else {
                    r.removeClass("muted").addClass("sort-active");
                    r.children("i").removeClass("p3icon-sortOff").addClass("p3icon-sortDown")
                }
                u.CurrentSort = t;
                u.ExistingContent.changeSort(t);
                u.ExistingContent.sort();
                u.renderItems(u.ExistingContent.toJSON())
            }
        }
    });
    q.Vs.PriorityEditView = Bb.View.extend({
        template: "topic/topic.priority.template.html",
        events: {
            "click #btnSave": "savePriority",
            "click .move-top-button": "moveToTop"
        },
        render: function(r) {
            var s = this;
            $(r).html(s.el);
            s.renderTemplate()
        },
        renderTemplate: function() {
            var s = this,
                r = new q.Cs.Topic({}, {
                    sectionId: 0,
                    leadSectionId: this.options.leadSectionId,
                    active: true,
                    future: true,
                    expired: true,
                    shared: true
                });
            r.fetch({
                success: function() {
                    var u = d.localDateTime(),
                        v = new Date(u.getFullYear(), u.getMonth(), u.getDate()),
                        t;
                    r.each(function(w) {
                        if (w.get("PublishDate") !== null && d.getDate(w.get("PublishDate")).getTime() > v.getTime()) {
                            w.set("inactiveMessage", "Future Publish Date")
                        } else {
                            if (w.get("ExpireDate")) {
                                if (d.getDate(w.get("ExpireDate")).getTime() < v.getTime()) {
                                    w.set("inactiveMessage", "Expired")
                                }
                            }
                        }
                    });
                    p3.fT(s.template, function(w) {
                        s.$el.html(w({
                            topic: r.toJSON(),
                            schoolId: p3.Data.SchoolContext.get("SchoolInfo").SchoolId
                        }))
                    });
                    p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.jQueryUI, function() {
                        t = function(w, x) {
                            x.children().each(function() {
                                $(this).width($(this).width())
                            });
                            return x
                        };
                        window.setTimeout(function() {
                            $(".sortContainer tbody").sortable({
                                items: "tr.postContainer",
                                helper: t
                            }).disableSelection()
                        }, 400)
                    })
                },
                error: function() {
                    p3.displayError("Error loading topics")
                }
            })
        },
        savePriority: function(r) {
            var v = this,
                u = [],
                t = 0,
                s;
            $("#btnSave").button("loading");
            $(".postContainer").each(function() {
                t += 1;
                u.push({
                    ContentIndexId: $(this).data("id"),
                    SortOrder: t
                })
            });
            s = new q.Ms.SetPriorities({
                ContentItems: u
            });
            s.save({}, {
                error: function() {
                    p3.showModal(p3.Layout.Containers.Modal, "hide");
                    p3.displayError("Error saving priority")
                },
                success: function() {
                    v.trigger("priorityChanged");
                    p3.showModal(p3.Layout.Containers.Modal, "hide")
                }
            })
        },
        moveToTop: function(t) {
            var s = $(t.currentTarget),
                r = s.parentsUntil(1, "tr"),
                v = r.data("id"),
                u = r.html();
            r.remove();
            $(".sortContainer tr:first").after('<tr class="postContainer sort-hover" data-id="' + v + '">' + u + "</tr>")
        }
    });
    q.Vs.Options = Bb.View.extend({
        template: "topic/topic.options.template.html",
        events: {
            "click #btnSave": "saveOption"
        },
        render: function(r) {
            var s = this;
            $(r).html(s.el);
            s.renderTemplate()
        },
        renderTemplate: function() {
            var r = this;
            p3.fT(r.template, function(s) {
                r.$el.html(s({
                    linkOption: r.options.displayOption
                }))
            })
        },
        saveOption: function(r) {
            var s = this;
            s.trigger("OptionsSaved", $('input[type="radio"][name=DisplayOption]:checked:first').val());
            p3.Layout.Containers.Modal.modal("hide")
        }
    });
    q.Vs.ShareView = Bb.View.extend({
        template: "topic/topic.share.template.html",
        itemTemplate: "topic/topic.share.item.template.html",
        events: {
            "click .can-edit-check": "editClick",
            "change #share-next-faculty-dropdown": "facultyChange",
            "change #share-next-section-dropdown": "sectionChange",
            "click .topic-share-remove": "removeShareRow",
            "click .share-next-link": "doAddNext",
            "click #add-bank-button": "editClick",
            "click .topic-share-delete": "deleteShareRow"
        },
        render: function(r) {
            var s = this;
            $(r).html(s.el);
            q.Us.getCurrentYearFaculty();
            s.renderTemplate()
        },
        renderTemplate: function() {
            var s = this,
                r;
            r = q.Us.getAssociationFromContext(q.Data.contextLabelId);
            p3.fT(s.template, function(t) {
                s.$el.html(t({
                    groups: s.options.groups,
                    faculty: q.Data.FacultyList.toJSON(),
                    sectionLabel: q.Us.getSectionLabel(r),
                    pluralLabel: q.Us.getPluralLabel(r),
                    ownerLabel: q.Us.getOwnerLabel(r),
                    topic: s.options.topic.toJSON()
                }));
                s.doAdjustAddAreaUI();
                p3.setModalHeight(p3.Layout.Containers.Modal)
            })
        },
        editClick: function(s) {
            var t = this,
                r = $(s.currentTarget);
            if (r.hasClass("active")) {
                r.removeClass("active");
                if (r.hasClass("share-next-can-edit")) {
                    t.selectedCanEdit = false
                }
            } else {
                r.addClass("active");
                if (r.hasClass("share-next-can-edit")) {
                    t.selectedCanEdit = true
                }
            }
        },
        facultyChange: function(s) {
            var u = this,
                r = $(s.currentTarget),
                t = parseInt(r.val(), 10);
            u.selectedFacultyId = t;
            u.selectedFacultyName = s.currentTarget.options[s.currentTarget.selectedIndex].text;
            u.selectedSectionId = 0;
            u.selectedSectionName = "";
            u.buildSectionDropdown()
        },
        sectionChange: function(s) {
            var u = this,
                r = $(s.currentTarget),
                t = parseInt(r.val(), 10);
            u.selectedSectionId = t;
            u.selectedSectionName = s.currentTarget.options[s.currentTarget.selectedIndex].text;
            u.doAdjustAddAreaUI()
        },
        addAreaIsValid: function() {
            var r = this;
            return (r.selectedFacultyId > 0 && r.selectedSectionId > 0)
        },
        addAreaIsHidden: function() {
            var r = this;
            return (r.$(".share-next-area").hasClass("hidden"))
        },
        doAdjustAddAreaUI: function() {
            var v = this,
                r = v.$(".share-next-link-active"),
                s = v.$(".share-next-link-inactive"),
                t = v.$(".share-next-link-nother"),
                u;
            u = (v.$("#shared-table").find("tr").length) - 1;
            if (v.addAreaIsValid() || !(v.addAreaIsHidden())) {
                u = u + 1
            }
            if (u === 0) {
                t.hide()
            } else {
                t.show()
            }
            if (v.addAreaIsHidden() || v.addAreaIsValid()) {
                s.hide();
                r.show()
            } else {
                r.hide();
                s.show()
            }
        },
        doAddNext: function(w) {
            var y = this,
                u = y.$(".share-next-area"),
                s = y.$("#share-next-faculty-dropdown"),
                t = y.$("#share-next-section-dropdown"),
                r = y.$(".share-next-can-edit"),
                x, v;
            w.stopPropagation();
            w.preventDefault();
            if (y.addAreaIsHidden()) {
                u.removeClass("hidden");
                u.show()
            }
            if (y.selectedFacultyId > 0 && y.selectedSectionId > 0) {
                x = new q.Ms.TopicGroup();
                x.set("GroupName", y.selectedSectionName);
                x.set("SectionId", y.selectedSectionId);
                x.set("ContextLabelId", q.Data.contextLabelId);
                x.set("AllowEdit", y.selectedCanEdit);
                p3.fT(y.itemTemplate, function(z) {
                    v = q.Us.getAssociationFromContext(q.Data.contextLabelId);
                    $("#shared-body tr:last").after(z({
                        item: x.toJSON(),
                        sectionLabel: q.Us.getSectionLabel(v),
                        pluralLabel: q.Us.getPluralLabel(v),
                        ownerLabel: q.Us.getOwnerLabel(v),
                        topic: y.options.topic.toJSON()
                    }));
                    y.selectedFacultyId = 0;
                    y.selectedFacultyName = null;
                    y.selectedSectionId = 0;
                    y.selectedSectionName = null;
                    y.selectedCanEdit = false;
                    s.val(0);
                    t.val(0);
                    t.prop("disabled", true);
                    r.removeClass("active")
                })
            }
            y.doAdjustAddAreaUI();
            p3.setModalHeight(p3.Layout.Containers.Modal)
        },
        removeShareRow: function(r) {
            var s = this;
            $(r.currentTarget).parents("tr").remove();
            s.buildSectionDropdown();
            s.doAdjustAddAreaUI();
            p3.setModalHeight(p3.Layout.Containers.Modal)
        },
        deleteShareRow: function(s) {
            var r = $(s.currentTarget).parents("tr");
            r.addClass("delete");
            r.html('<td colspan="3"><div style="margin-bottom:0px;"class="alert alert-error">This share will be removed on save.</div></td>')
        },
        getSharedSectionArray: function() {
            var s = this,
                r = [];
            s.$("tr.add-share-row[data-sectionid]").each(function(t, u) {
                r.push($(u).data("sectionid"))
            });
            return r
        },
        buildSectionDropdown: function() {
            var t = this,
                r = t.$("#share-next-section-dropdown"),
                s;
            r.empty().prop("disabled", true);
            r.append($("<option></option>").attr("value", "0").text("-- " + q.Us.getSectionLabel(q.Data.FacultyList.associationId) + " --"));
            if (t.selectedFacultyId > 0) {
                s = new q.Cs.SectionsByYear();
                s.fetch({
                    data: {
                        facultyUserId: t.selectedFacultyId,
                        schoolYear: p3.Data.SchoolContext.get("CurrentSchoolYear").SchoolYearLabel,
                        associationId: q.Data.FacultyList.associationId
                    },
                    success: function(v, x) {
                        var u = v.toJSON(),
                            w;
                        w = t.getSharedSectionArray();
                        u = _.uniq(u, true, function(y) {
                            return y.SectionId
                        });
                        if (u.length > 0) {
                            r.prop("disabled", false);
                            _.each(u, function(y) {
                                if (y.SectionId && w.indexOf(y.SectionId) < 0) {
                                    r.append($("<option></option>").attr("value", y.SectionId).text(y.Name))
                                }
                            })
                        }
                    },
                    error: function(u, v) {
                        p3.displayError("Error retrieving sections.")
                    }
                })
            }
            t.doAdjustAddAreaUI()
        },
        getSharedGroups: function() {
            var u = this,
                t = true,
                r = [],
                s = "";
            u.allowCopy = $("#add-bank-button").hasClass("active");
            $(".add-share-row").each(function(C, D) {
                var w = $(D),
                    y = w.hasClass("existing"),
                    G = !w.hasClass("delete"),
                    F, x, A, v = w.find("td"),
                    B = [],
                    E, z;
                if (y) {
                    F = w.data("sectionid");
                    x = w.data("contextlabelid");
                    A = $(v[0]).text();
                    E = w.data("publish");
                    z = w.data("expire")
                } else {
                    F = w.data("sectionid");
                    x = w.data("contextlabelid");
                    A = $(v[0]).text()
                }
                if (F === 0) {
                    w.addClass("error");
                    t = false;
                    s = "Please select a section to share with"
                } else {
                    if (F > 0) {
                        B = _.pluck(r, "ContextValue");
                        B.push(F);
                        if (_.uniq(B).length === B.length) {
                            r.push({
                                Selected: G,
                                PrimaryInd: false,
                                ContextLabelId: x,
                                ContextValue: F,
                                Sort: 1,
                                Type: 1,
                                AllowEdit: w.find(".can-edit-check").hasClass("active"),
                                GroupName: A,
                                PublishDate: E,
                                ExpireDate: z
                            });
                            w.removeClass("error")
                        }
                    } else {
                        w.removeClass("error")
                    }
                }
            });
            if (!(u.$(".share-next-area").hasClass("hidden"))) {
                if (u.selectedSectionId > 0) {
                    r.push({
                        Selected: true,
                        PrimaryInd: false,
                        ContextLabelId: q.Data.contextLabelId,
                        ContextValue: u.selectedSectionId,
                        Sort: 1,
                        Type: 1,
                        AllowEdit: u.selectedCanEdit,
                        GroupName: u.selectedSectionName,
                        PublishDate: null,
                        ExpireDate: null
                    })
                }
            }
            u.sharedGroups = r;
            u.errorMessage = s;
            return t
        }
    });
    q.Vs.ShareModal = Bb.View.extend({
        template: "topic/topic.share.modal.template.html",
        events: {
            "click #save-button": "saveTopic"
        },
        render: function(r) {
            var s = this;
            $(r).html(s.el);
            q.Us.getCurrentYearFaculty();
            s.createModel();
            s.renderTemplate()
        },
        renderTemplate: function() {
            var r = this;
            p3.fT(r.template, function(s) {
                r.$el.html(s({}));
                r.Containers = {};
                r.Containers.shareContainer = $("#share-container");
                r.addShareView()
            })
        },
        addShareView: function() {
            var r = this;
            r.shareView = new q.Vs.ShareView({
                groups: r.sharedGroups,
                topic: r.topic
            });
            p3.rV(r.shareView, r.Containers.shareContainer, true);
            p3.setModalHeight(p3.Layout.Containers.Modal)
        },
        saveTopic: function(s) {
            var t = this,
                r = $("#save-button");
            r.button("loading");
            if (t.shareView.getSharedGroups()) {
                t.groups = t.groups.concat(t.shareView.sharedGroups);
                t.topic.set("groups", t.groups);
                t.topic.set("AllowCopy", t.shareView.allowCopy);
                t.topic.save({}, {
                    error: function() {
                        p3.showModal(p3.Layout.Containers.Modal, "hide");
                        p3.displayError("Error saving topic")
                    },
                    success: function() {
                        p3.showModal(p3.Layout.Containers.Modal, "hide");
                        q.Us.refreshTopics(true, 0, t.options.topicView.options.leadSectionId, t.options.topicView)
                    }
                })
            } else {
                r.button("reset");
                $("#topic_share_error_region").html(t.shareView.errorMessage).addClass("alert").addClass("alert-error")
            }
        },
        createModel: function() {
            var r = this;
            r.topic = new q.Ms.TopicSave({
                TopicId: r.options.topicId
            });
            r.sharedGroups = [];
            r.groups = [];
            if (r.options.groups.length > 0) {
                r.options.groups.each(function(s, t) {
                    if (t === 0) {
                        r.topic.set("ShortDescription", s.get("Name"));
                        r.topic.set("LongDescription", s.get("Description"));
                        r.topic.set("OldThumbFilename", s.get("ThumbFilename"));
                        r.topic.set("LayoutId", s.get("LayoutId"));
                        r.topic.set("AllowCopy", s.get("AllowCopy"))
                    }
                    if (s.get("Primary")) {
                        r.groups.push({
                            ContextLabelId: s.get("ContextLabelId"),
                            ContextValue: s.get("SectionId"),
                            ExpireDate: s.get("ExpireDate"),
                            PrimaryInd: true,
                            PublishDate: s.get("PublishDate"),
                            Selected: true,
                            Sort: 1,
                            Type: 1
                        })
                    } else {
                        r.sharedGroups.push(s.toJSON())
                    }
                })
            }
        }
    });
    q.Vs.PublishShareModal = Bb.View.extend({
        template: "topic/topic.publish.share.template.html",
        events: {
            "click #save-button": "saveTopic"
        },
        render: function(r) {
            var s = this;
            $(r).html(s.el);
            q.Us.getCurrentYearFaculty();
            s.createModel();
            s.renderTemplate()
        },
        renderTemplate: function() {
            var r = this;
            p3.fT(r.template, function(s) {
                r.$el.html(s({
                    groups: r.sharedGroups,
                    canEditTopicInd: r.options.canEditTopicInd
                }));
                r.Containers = {};
                r.Containers.groupContainer = $("#groups-container");
                r.addGroupsView()
            })
        },
        addGroupsView: function() {
            var r = this;
            r.groupView = new i.Vs.PublishView({
                groups: r.sharedGroups,
                defaultDate: d.getDateString(d.localDateTime()),
                showPublish: true,
                showExpire: true,
                isEdit: true,
                contentId: 386
            });
            window.setTimeout(function() {
                p3.rV(r.groupView, r.Containers.groupContainer, true);
                window.setTimeout(function() {
                    $("#show-more-groups").remove();
                    r.$("h3").remove();
                    p3.setModalHeight(p3.Layout.Containers.Modal)
                }, 100)
            }, 100)
        },
        saveTopic: function(s) {
            var u = this,
                r = $("#save-button"),
                t;
            r.button("loading");
            u.groupView.getSelectedGroupArray();
            _.each(u.groupView.selectedArray, function(v) {
                t = _.filter(u.groups, function(w) {
                    return v.ContextValue === w.ContextValue
                })[0];
                if (v.Selected) {
                    t.PublishDate = v.PublishDate;
                    t.ExpireDate = v.ExpireDate
                } else {
                    t.PublishDate = null;
                    t.ExpireDate = null
                }
            });
            u.topic.set("groups", u.groups);
            u.topic.save({}, {
                error: function() {
                    p3.showModal(p3.Layout.Containers.Modal, "hide");
                    p3.displayError("Error saving topic")
                },
                success: function() {
                    if (u.options.callback !== undefined) {
                        u.options.callback(u.groups)
                    } else {
                        q.Us.refreshTopics(true, 0, u.options.topicView.options.leadSectionId, u.options.topicView)
                    }
                    p3.showModal(p3.Layout.Containers.Modal, "hide")
                }
            })
        },
        createModel: function() {
            var t = this,
                r = null,
                s = null;
            t.topic = new q.Ms.TopicSave({
                TopicId: t.options.topicId
            });
            t.sharedGroups = new Bbc();
            t.groups = [];
            if (t.options.groups.length > 0) {
                t.options.groups.each(function(u, v) {
                    if (v === 0) {
                        t.topic.set("ShortDescription", u.get("Name"));
                        t.topic.set("LongDescription", u.get("Description"));
                        t.topic.set("OldThumbFilename", u.get("ThumbFilename"));
                        t.topic.set("LayoutId", u.get("LayoutId"));
                        t.topic.set("AllowCopy", u.get("AllowCopy"))
                    }
                    if (u.get("PublishDate")) {
                        s = u.get("PublishDate").split(" ", 1)[0]
                    }
                    if (u.get("ExpireDate")) {
                        r = u.get("ExpireDate").split(" ", 1)[0]
                    }
                    if ((!u.get("Primary")) && (u.get("ViewerIsOwnerInd") || (u.get("SectionId") === t.options.leadSectionId))) {
                        u.set("LeadSectionId", u.get("SectionId"));
                        u.set("IsSelected", u.get("PublishDate") !== null);
                        u.set("PublishDate", s);
                        u.set("ExpireDate", r);
                        t.sharedGroups.add(u)
                    }
                    t.groups.push({
                        ContextLabelId: u.get("ContextLabelId"),
                        ContextValue: u.get("SectionId"),
                        ExpireDate: u.get("ExpireDate"),
                        PrimaryInd: u.get("Primary"),
                        ViewerIsOwnerInd: u.get("ViewerIsOwnerInd"),
                        ShareWarningInd: u.get("ShareWarningInd"),
                        PublishDate: u.get("PublishDate"),
                        PDate: s,
                        EDate: r,
                        Selected: true,
                        Sort: 1,
                        Type: 1,
                        AllowEdit: u.get("AllowEdit")
                    })
                })
            }
        }
    });
    q.Us.buildRows = function(s) {
        var t = [],
            r = [];
        t.push({
            rowId: 0,
            columns: r
        });
        switch (s) {
            case 0:
                r.push({
                    rowId: 0,
                    colId: 0,
                    className: "span9 col-md-9"
                });
                r.push({
                    rowId: 0,
                    colId: 1,
                    className: "span3 col-md-3"
                });
                break;
            case 1:
                r.push({
                    rowId: 0,
                    colId: 0,
                    className: "span3 col-md-3"
                });
                r.push({
                    rowId: 0,
                    colId: 1,
                    className: "span9 col-md-9"
                });
                break;
            case 2:
                r.push({
                    rowId: 0,
                    colId: 0,
                    className: "span12 col-md-12"
                });
                r = [];
                t.push({
                    rowId: 1,
                    columns: r
                });
                r.push({
                    rowId: 1,
                    colId: 0,
                    className: "span9 col-md-9"
                });
                r.push({
                    rowId: 1,
                    colId: 1,
                    className: "span3 col-md-3"
                });
                break;
            case 3:
                r.push({
                    rowId: 0,
                    colId: 0,
                    className: "span12 col-md-12"
                });
                r = [];
                t.push({
                    rowId: 1,
                    columns: r
                });
                r.push({
                    rowId: 1,
                    colId: 0,
                    className: "span3 col-md-3"
                });
                r.push({
                    rowId: 1,
                    colId: 1,
                    className: "span9 col-md-9"
                });
                break;
            case 4:
                r.push({
                    rowId: 0,
                    colId: 0,
                    className: "span6 col-md-6"
                });
                r.push({
                    rowId: 0,
                    colId: 1,
                    className: "span6 col-md-6"
                });
                break;
            case 5:
                r.push({
                    rowId: 0,
                    colId: 0,
                    className: "span4 col-md-4"
                });
                r.push({
                    rowId: 0,
                    colId: 1,
                    className: "span4 col-md-4"
                });
                r.push({
                    rowId: 0,
                    colId: 2,
                    className: "span4 col-md-4"
                });
                break
        }
        return t
    };
    q.Us.getSectionLabel = function(r) {
        var s;
        switch (r) {
            case 1:
                s = "Class Section";
                break;
            case 3:
                s = "Community";
                break;
            case 7:
                s = "Dorm";
                break;
            case 8:
                s = "Activity";
                break;
            case 9:
                s = "Advisory";
                break
        }
        return s
    };
    q.Us.getPluralLabel = function(r) {
        var s;
        switch (r) {
            case 1:
                s = "Class Sections";
                break;
            case 3:
                s = "Communities";
                break;
            case 7:
                s = "Dorms";
                break;
            case 8:
                s = "Activities";
                break;
            case 9:
                s = "Advisories";
                break
        }
        return s
    };
    q.Us.getOwnerLabel = function(r) {
        var s;
        switch (r) {
            case 1:
                s = "Teacher";
                break;
            case 3:
                s = "Owner";
                break;
            case 7:
                s = "Dorm Leader";
                break;
            case 8:
                s = "Activity Leader";
                break;
            case 9:
                s = "Advisor";
                break
        }
        return s
    };
    q.Us.refreshTopics = function(s, x, w, A) {
        var u = false,
            r = false,
            v = false,
            t = false,
            y = false,
            z;
        r = $("#chkActiveTopics").is(":checked");
        v = $("#chkFutureTopics").is(":checked");
        t = $("#chkExpiredTopics").is(":checked");
        y = $("#chkSharedTopics").is(":checked");
        if (s == false || r || v || t || y) {
            u = true
        }
        z = new q.Cs.Topic({}, {
            sectionId: x,
            leadSectionId: w,
            active: r,
            future: v,
            expired: t,
            shared: y
        });
        A.options.active = r;
        A.options.future = v;
        A.options.expired = t;
        A.options.shared = y;
        if (u) {
            z.fetch({
                success: function() {
                    A.collection = z;
                    A.renderTemplate()
                }
            })
        } else {
            z.remove(z.at(0));
            A.collection = z;
            A.renderTemplate()
        }
    };
    q.Us.loadHTMLEditor = function() {
        $(".modal-body textarea").attr("style", "height: 280px;width: 100%;");
        var r = $("#myeditor");
        if (r.length > 0) {
            p3.showHtmlEditor("myeditor", p3.Us.Enum.HtmlEditorCategories.FULL, false, undefined, p3.Us.Enum.HtmlEditorEncoding.NUMERIC);
            window.setTimeout(function() {
                var s = tinyMCE.get("myeditor");
                if (s) {
                    $("#myeditor_tbl").width("100%");
                    s.focus()
                }
            }, 100)
        }
    };
    q.Us.showEditModal = function(t, s, u) {
        var r = new o.Ms.DateTime();
        r.fetch({
            success: function() {
                var v = t.get("Id") > 0;
                p3.rV(new q.Vs.TopicEditView({
                    topic: t,
                    groups: s,
                    defaultDate: r.attributes[0].local_date.split(" ", 1)[0],
                    topicView: u,
                    detailPage: v
                }), p3.Layout.Containers.Modal, true);
                p3.showModal(p3.Layout.Containers.Modal)
            },
            error: function() {
                p3.displayError("Error loading current date")
            }
        })
    };
    q.Us.loadTopicManage = function(s, r) {
        p3.router().navigate("#academicclass/" + s + "/0/topics", false)
    };
    q.Us.getElapsedTimeString = function(r, B) {
        var v = 60 * 1000,
            u = v * 60,
            t = u * 24,
            w = t * 30,
            x = t * 365,
            y, z = "",
            A, s = r.getTime() - B.getTime();
        if (s < v) {
            y = Math.round(s / 1000);
            if (y <= 0) {
                y = 1
            }
            z = " second"
        } else {
            if (s < u) {
                y = Math.round(s / v);
                z = " minute"
            } else {
                if (s < t) {
                    y = Math.round(s / u);
                    z = " hour"
                } else {
                    if (s < w) {
                        y = Math.round(s / t);
                        z = " day"
                    } else {
                        if (s < x) {
                            y = Math.round(s / w);
                            z = " month"
                        } else {
                            y = Math.round(s / x);
                            z = " year"
                        }
                    }
                }
            }
        }
        if (y === 1) {
            A = y + z + " ago"
        } else {
            A = y + z + "s ago"
        }
        return A
    };
    q.Us.BeginNoteRegion = function(u, t, x, w, s) {
        var y = "1",
            z = "11",
            v, r = $("#column" + w + "_" + s);
        if (r.hasClass("span3") || r.hasClass("col-md-3")) {
            y = "2";
            z = "10"
        }
        v = '<div id="message_container_' + u.MessageId + '"><div class="container-fluid row-fluid"><div class="row" style="width:100%;"><div class="span12 col-md-12"><div class="container-fluid row-fluid"><div class="row" style="width:100%;"><div class="span' + y + " col-md-" + y + ' ">';
        if (u.UserPhoto) {
            v += '<img class="imgNice" src="/ftpimages/' + x + "/user/" + u.UserPhoto + '" style="max-height:40px;">'
        } else {
            v += "&nbsp;"
        }
        v += '</div><div class="span' + z + " col-md-" + z + '"><div class="arrow_box';
        if (t) {
            v += " added-note"
        }
        v += '">';
        return v
    };
    q.Us.EndNoteRegion = function(s, r) {
        var t = '</div><textarea style="width:95%;" class="note-comment-box" pmsg="' + s + '" placeholder="write a comment" rows="1"></textarea>';
        t += "</div></div></div></div></div></div></div>";
        if (r) {
            t += "<hr>"
        }
        t += "</div>";
        return t
    };
    q.Us.OutputMessage = function(w, u, z, x, r, t, A, v, s) {
        var y = "";
        if (t) {
            y += '<div id="message_container_' + w.MessageId + '" ';
            if (u) {
                y += ' class="added-comment"'
            }
            y += ">"
        }
        if (t && w.UserPhoto) {
            y += '<img class="imgNice" style="float: left;max-height:25px;" src="/ftpimages/' + z + "/user/" + w.UserPhoto + '">'
        }
        y += '<h6 class="pull-right">';
        y += q.Us.getElapsedTimeString(s, d.getDate(w.InsertDate));
        y += "</h6>";
        if (!t) {
            y += "<h4>"
        } else {
            y += "<h5>"
        }
        y += '<a href="#profile/' + w.UserId + '/contactcard">';
        y += w.FirstName + " " + w.LastName;
        y += "</a>";
        if (!t) {
            y += "</h4>"
        } else {
            y += "</h5>"
        }
        if (w.UserId == A || v) {
            y += '<a href="#" class="btn btn-default btn-mini pull-right message-delete" mid=' + w.MessageId + ' style="margin-left:3px;"><i class="p3icon-delete"></i></a>'
        }
        if (w.UserId == A) {
            y += '<a href="#" class="btn btn-default btn-mini pull-right message-edit" mid=' + w.MessageId + ' style="margin-left:3px;"><i class="p3icon-edit"></i></a>'
        }
        y += '<span id="msgDisplay_' + w.MessageId + '">';
        y += "<p>" + w.Message + "</p>";
        y += "</span>";
        y += '<div id="msgEdit_' + w.MessageId + '" style="display:none;"><textarea style="width:100%;" class=" message-edit-box" mid="' + w.MessageId + '" rows="1">' + w.Message + "</textarea></div>";
        if (r) {
            y += "<br /><br />"
        }
        if (!t) {
            y += '<div id="child_container_' + w.MessageId + '">'
        }
        if (t) {
            y += "<hr>";
            y += "</div>"
        }
        return y
    };
    q.Us.buildDiscussionOutput = function(u, z, s) {
        var t = d.localDateTime(),
            y = "",
            v, x = 0,
            r = false,
            A, w, B;
        if (u.length) {
            A = p3.Data.SchoolContext.get("SchoolInfo").SchoolId;
            w = p3.Data.Context.getSelectedPersona().Id == 3 || p3.Data.Context.getSelectedPersona().Id == 5;
            B = p3.Data.Context.get("UserInfo").UserId;
            for (v = 0; v < u.length; v++) {
                if (u[v].ChildRank == 0) {
                    if (x > 0) {
                        y += q.Us.EndNoteRegion(x, true)
                    }
                    if (v >= 9 && !r) {
                        r = true;
                        y += '<div style="display:none;" id="more-region-' + z + "-" + s + '">'
                    }
                    x = u[v].MessageId;
                    y += q.Us.BeginNoteRegion(u[v], false, A, z, s)
                }
                y += q.Us.OutputMessage(u[v], false, A, x, u[v].ChildRank == 0, u[v].ChildRank, B, w, t)
            }
            y += q.Us.EndNoteRegion(x, false);
            if (r) {
                y += "</div>";
                y += '<button class="btnn btn-default btn-show-more show-data pull-right" style="margin-top:10px;" data-row="' + z + '" data-column="' + s + '">Show All</button><div class="clear">'
            }
            return y
        }
    };
    q.Us.collpaseDownloads = function(w) {
        var v = new q.Cs.TopicContent({}, {
                topicId: w.topicId,
                topicIndexId: w.topicIndexId
            }),
            u = -1,
            s = -1,
            r = -1,
            t;
        v.remove(v.at(0));
        w.each(function(y) {
            if (y.get("ContentId") == 3) {
                if (y.get("CellIndex") == r && y.get("ColumnIndex") == s && y.get("RowIndex") == u) {
                    var x = t.get("AdditionalItems");
                    x.push(y.toJSON());
                    t.set("AdditionalItems", x)
                } else {
                    y.set("AdditionalItems", []);
                    v.add(y);
                    r = y.get("CellIndex");
                    u = y.get("RowIndex");
                    s = y.get("ColumnIndex");
                    t = y
                }
            } else {
                v.add(y)
            }
        });
        return v
    };
    q.Us.getContentItem = function(r, s) {
        var t;
        r.each(function(u) {
            if (u.get("ContentItemId") === s) {
                t = u
            }
        });
        return t
    };
    q.Us.getBackToTopicsLink = function(s) {
        var r = "";
        if (s.previewInd === "1" || s.previewInd === 1) {
            r = "#topicdetailedit/" + s.topicId + "/" + s.leadSectionId + "/" + s.sectionId + "/" + s.topicIndexId + "/" + (s.studentId || 0)
        } else {
            switch (s.contextLabelId) {
                case 2:
                    r = "#academicclass/" + s.sectionId + "/" + (s.studentId || 0) + "/topics";
                    break;
                case 12:
                    r = "#communitypage/" + s.sectionId + "/topics";
                    break;
                case 22:
                    r = "#advisorypage/" + s.sectionId + "/topics";
                    break;
                case 23:
                    r = "#dormpage/" + s.sectionId + "/topics";
                    break;
                case 24:
                    r = "#activitypage/" + s.sectionId + "/topics";
                    break;
                default:
                    r = ""
            }
        }
        return r
    };
    q.Us.getAssociationFromContext = function(s) {
        var r = 1;
        switch (s) {
            case 12:
                r = 3;
                break;
            case 24:
                r = 8;
                break;
            case 22:
                r = 9;
                break;
            case 23:
                r = 7;
                break
        }
        return r
    };
    q.Vs.ShareWarning = n.Vs.Modal2.extend({
        template: "topic/topic.sharewarning.template.html",
        messageTemplate: "topic/topic.sharewarning.message.template.html",
        selector: "id",
        modalRendered: function() {
            var r = this;
            r.renderTemplate()
        },
        renderTemplate: function() {
            p3.setModalHeight(p3.Layout.Containers.Modal)
        },
        modalUpdate: function(s) {
            var t = this,
                r = $(s.eventCurrentTarget[0]);
            if (r.hasClass("dismiss-warning")) {
                if (r.hasClass("active")) {
                    r.removeClass("active");
                    t.$("#btnShareWarningSave").hide();
                    t.$("#btnShareWarningCancel").show()
                } else {
                    r.addClass("active");
                    t.$("#btnShareWarningCancel").hide();
                    t.$("#btnShareWarningSave").show()
                }
            }
            return true
        }
    });
    q.Us.checkShareWarning = function(s, t) {
        var r;
        if ((s.shareCount > 0) && !(q.Data.shareWarningDismissed)) {
            r = new q.Vs.ShareWarning({
                model: new q.Ms.TopicWarningSave({
                    TopicIndexId: t
                }),
                variables: {
                    shareInfo: s
                }
            });
            p3.showModal(p3.Layout.Containers.Modal, {
                backOnHide: false
            });
            p3.rV(r, p3.Layout.Containers.Modal, true)
        }
        q.Data.shareWarningDismissed = true
    };
    q.Us.getCurrentYearFaculty = function() {
        var r = q.Us.getAssociationFromContext(q.Data.contextLabelId);
        if (!q.Data.FacultyList || q.Data.FacultyList.associationId !== r) {
            q.Data.FacultyList = new q.Cs.CurrentYearFaculty();
            q.Data.FacultyList.associationId = r;
            q.Data.FacultyList.fetch({
                async: false,
                data: {
                    associationId: r
                },
                error: function() {
                    p3.displayError("Error loading faculty list")
                }
            })
        }
    };
    Hb.registerHelper("discussionOutput", function(s, t, r) {
        return new Hb.SafeString(q.Us.buildDiscussionOutput(s, t, r))
    });
    p3.router().route("topicdetail/:id/:leadSectionId/:sectionId/:topicIndexId/:studentId/:previewInd", "topicdetail", function(r, s, u, w, v, t) {
        p3.renderMainPage(new q.Vs.TopicDetailLayoutView({
            topicId: r,
            sections: null,
            leadSectionId: s,
            sectionId: u,
            topicIndexId: w,
            editMode: false,
            studentId: v,
            previewInd: t
        }))
    });
    p3.router().route("topicdetailedit/:id/:leadSectionId/:sectionId/:topicIndexId/:studentId", "topicdetailedit", function(s, t, u, w, v, r) {
        p3.renderMainPage(new q.Vs.EditDetail({
            topicId: s,
            sections: null,
            leadSectionId: t,
            sectionId: u,
            topicIndexId: w,
            studentId: v,
            editMode: "content"
        }))
    })
}(p3.module("LMS/topic")));
(function(a) {
    var j = p3.module("shared/task"),
        b = p3.module("LMS/assignment"),
        g = p3.module("shared/datepicker"),
        k = p3.module("shared/timepicker"),
        h = p3.module("shared/feeds"),
        c = p3.module("LMS/Shared/assignmentcenter"),
        f = p3.Us.Culture,
        l = p3.Us.Validate,
        i = p3.module("report"),
        e = p3.module("LMS/Shared/AssignmentTools"),
        d = p3.module("lms/assignmentoptions");
    a.Cs.Assignments = Bbc.extend({
        url: function() {
            return aP + "datadirect/AssignmentsByCourse/?format=json&sectionId=" + this.sectionId + "&startDate=" + this.startDate + "&endDate=" + this.endDate + "&personaId=" + p3.Data.Context.getSelectedPersona().Id + "&statusList=" + this.statusList
        }
    });
    a.Cs.MoveAssignment = Bbc.extend({
        url: "assignment2/AssignmentMoveTimes"
    });
    a.Cs.SectionForAssignments = Bbc.extend({
        initialize: function(m, n) {
            this.AssignmentId = n.AssignmentId || 0;
            this.SectionId = n.SectionId || 0;
            this.statusList = n.statusList
        },
        url: function() {
            return aP + "assignment/SectionLinksGet/?format=json&id=" + this.AssignmentId
        }
    });
    a.Data = {};
    a.Data.orientation = "landscape-calendar ";
    a.Data.fontStyle = "cal-print-font-size-smallest ";
    a.Vs.Calendar = Bb.View.extend({
        template: "assignmentcenter/calendar.template.html",
        id: "calendar-main-view",
        events: {
            refreshEvents: "eventRefresh",
            updateAssignments: "updateAssignments",
            "click .assignmentDisplayTypeFilter": "updateFilter",
            "click #week-view": "weekView",
            "click #month-view": "monthView",
            "click #button-today": "gotoToday",
            "click #previous-button": "movePrevious",
            "click #next-button": "moveNext",
            "click #mobile-previous-button": "movePrevious",
            "click #mobile-next-button": "moveNext",
            "click #filter-status": "showStatusFilter",
            "click #filter-status-menu": "showStatusFilter",
            "click #ical-dropdown": "showICalMenu",
            "click #report-dropdown": "showReportMenu",
            "click button[data-target]": "openFeed",
            "click .report-link": "hideReportMenu",
            "click #print-button": "printCalendar",
            "click #lti-config-btn": "showLtiConfigList",
            "click #lti-config-menu": "showLtiConfigList",
            "click #add-assessment-btn": "addAssessment",
            "click #add-assessment-menu": "addAssessment",
            "click #add-assignment-btn": "addAssignment",
            "click #add-assignment-menu": "addAssignment",
            "click a.assignment-status-link": "doStatusChange",
            "click #add-discuss-btn": "addDiscussion",
            "click #add-discuss-menu": "addDiscussion",
            "click #day-view": "setDayView",
            "click #today-menu": "gotoToday"
        },
        initialize: function(m) {
            var n = this;
            a.Data.isOwner = m.isOwner;
            a.Data.isManager = m.isManager;
            a.Data.leadSectionId = b.Data.currentLeadSectionId = m.leadSectionId || 0;
            a.Data.containerName = m.containerName;
            n.collection = new a.Cs.Assignments();
            n.collection.sectionId = a.Data.leadSectionId;
            n.options.canEdit = n.options.hasFullAccess;
            if (_.isUndefined(p3.Data.LMS) || !p3.Data.LMS.OptionsDefaulted) {
                d.Us.getAssignmentOptionDefaults()
            }
            if (!_.isUndefined(p3.Data.LMS) && !_.isUndefined(p3.Data.LMS.AssignmentCenterfilter)) {
                n.options.currentFilter = m.filter || p3.Data.LMS.AssignmentCenterfilter
            } else {
                n.options.currentFilter = m.filter || 0
            }
        },
        dispose: function() {
            $('link[rel=stylesheet][href~="/ftpimages/999/podium/libs/fullcalendar/2.4.0/fullcalendar.academic.css"]').remove();
            $(window).off("resize")
        },
        render: function(m) {
            p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.jQueryUI, function() {
                return true
            });
            var o = this,
                n;
            $(m).html(o.el);
            o.options.view = o;
            p3.fT(o.template, function(p) {
                o.$el.html(p());
                p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.AcademicCalendar, o.initializeCalendar, o.options);
                o.renderHeader()
            });
            n = _.debounce(function() {
                if (o.checkWidth) {
                    o.checkWidth()
                }
            }, 500);
            $(window).resize(n)
        },
        initializeCalendar: function(m) {
            a.Us.InitializeCalendar(m);
            m.view.requestCalendarData()
        },
        renderHeader: function() {
            var n = this,
                m = new a.Vs.HeaderView({
                    studentId: n.options.studentId,
                    assignCenter: false,
                    sectionId: a.Data.leadSectionId
                });
            p3.rV(m, "#calendar-header-container", true);
            window.setTimeout(function() {
                var o = $("#calendar-container");
                if (o.length > 0 && o.fullCalendar !== undefined) {
                    a.Us.updateHeaderDisplay(o.fullCalendar("getView"))
                }
            }, 100)
        },
        eventRefresh: function() {
            var n = this,
                m = $("#calendar-container");
            if (typeof m.fullCalendar === "function") {
                m.fullCalendar("removeEvents");
                m.fullCalendar("addEventSource", n.options.events.toJSON());
                if (!_.isUndefined(p3.Data.LMS) && !_.isUndefined(p3.Data.LMS.SectionCalendarView)) {
                    m.fullCalendar("changeView", p3.Data.LMS.SectionCalendarView)
                }
            }
        },
        requestCalendarData: function(p) {
            p = p || ((!_.isUndefined(p3.Data.LMS) && !_.isUndefined(p3.Data.LMS.saCaldate)) ? p3.Data.LMS.saCaldate : undefined) || f.localDateTime();
            var s = this,
                o = p.getMonth(),
                q = new Date(p),
                n = new Date(p),
                r = a.Us.getSectionStatusFilterList(),
                m = $("#calendar-container");
            q.setMonth(o - 3);
            n.setMonth(o + 3);
            s.collection.startDate = p3.Us.DateTime.format(q, "MM/dd/yyyy");
            s.collection.endDate = p3.Us.DateTime.format(n, "MM/dd/yyyy");
            s.collection.statusList = r;
            if (typeof m.fullCalendar === "function") {
                m.fullCalendar("gotoDate", p)
            }
            s.collection.fetch({
                success: function(t, v, u) {
                    s.options.events = a.Us.GenerateEventCollection(a.Data.leadSectionId, t, s.options.currentFilter, s.options.canEdit);
                    if (typeof m.fullCalendar === "function") {
                        m.fullCalendar("removeEvents");
                        m.fullCalendar("addEventSource", s.options.events.toJSON());
                        if (!_.isUndefined(p3.Data.LMS) && !_.isUndefined(p3.Data.LMS.SectionCalendarView)) {
                            m.fullCalendar("changeView", p3.Data.LMS.SectionCalendarView)
                        }
                    }
                }
            })
        },
        updateAssignments: function(n) {
            n.stopPropagation();
            n.preventDefault();
            var m;
            if (!_.isUndefined(p3.Data.LMS) && !_.isUndefined(p3.Data.LMS.saCaldate)) {
                m = p3.Data.LMS.saCaldate
            }
            this.requestCalendarData(m)
        },
        updateFilter: function(o) {
            var p = this,
                m, n = $(o.currentTarget);
            o.stopPropagation();
            o.preventDefault();
            $(".btn-group.open").removeClass("open");
            p.options.currentFilter = p3.Data.LMS.AssignmentCenterfilter = n.data("filter");
            $(".assignmentDisplayTypeFilter").each(function(q) {
                $(this).find("i").removeClass("p3icon-radioOn").addClass("p3icon-radioOff");
                $(this).removeClass("active cal-filter-on").addClass("cal-filter-off")
            });
            if (n.hasClass("sec-75-bgc-hover")) {
                m = $(".assignmentDisplayTypeFilter[data-filter='" + p3.Data.LMS.AssignmentCenterfilter.toString() + "']")
            } else {
                m = n
            }
            m.find("i").removeClass("p3icon-radioOff").addClass("p3icon-radioOn");
            m.addClass("active cal-filter-on").removeClass("cal-filter-off");
            p.requestCalendarData($("#calendar-container").fullCalendar("getDate").toDate())
        },
        weekView: function(m) {
            var n = this;
            n.requestCalendarData($("#calendar-container").fullCalendar("getDate").toDate());
            if (_.isUndefined(p3.Data.LMS)) {
                p3.Data.LMS = {}
            }
            p3.Data.LMS.SectionCalendarView = "basicWeek"
        },
        monthView: function(m) {
            var n = this;
            n.requestCalendarData($("#calendar-container").fullCalendar("getDate").toDate());
            if (_.isUndefined(p3.Data.LMS)) {
                p3.Data.LMS = {}
            }
            p3.Data.LMS.SectionCalendarView = "month"
        },
        setDayView: function(m) {
            var n = this;
            n.requestCalendarData($("#calendar-container").fullCalendar("getDate").toDate());
            if (_.isUndefined(p3.Data.LMS)) {
                p3.Data.LMS = {}
            }
            p3.Data.LMS.SectionCalendarView = "basicDay"
        },
        gotoToday: function(m) {
            var o = this,
                n = f.localDateTime();
            if (n) {
                $("#calendar-container").fullCalendar("gotoDate", n);
                o.requestCalendarData(n);
                if (_.isUndefined(p3.Data.LMS)) {
                    p3.Data.LMS = {}
                }
                p3.Data.LMS.saCaldate = n
            }
            m.preventDefault()
        },
        movePrevious: function(o) {
            var p = this,
                n, m = $("#calendar-container");
            m.fullCalendar("prev");
            n = m.fullCalendar("getDate").toDate();
            p.requestCalendarData(n);
            if (_.isUndefined(p3.Data.LMS)) {
                p3.Data.LMS = {}
            }
            p3.Data.LMS.saCaldate = n
        },
        moveNext: function(o) {
            var p = this,
                n, m = $("#calendar-container");
            m.fullCalendar("next");
            n = m.fullCalendar("getDate").toDate();
            p.requestCalendarData(n);
            if (_.isUndefined(p3.Data.LMS)) {
                p3.Data.LMS = {}
            }
            p3.Data.LMS.saCaldate = n
        },
        addDiscussion: function(n) {
            var o = this,
                m = b.Us.AddDiscussionView();
            m.on("saveDiscussion", function(p, q) {
                setTimeout(function() {
                    $("#calendar-main-view").trigger("updateAssignments")
                }, 500)
            });
            m.on("saveAddDiscussion", function(p, q) {
                setTimeout(function() {
                    $("#calendar-main-view").trigger("updateAssignments")
                }, 500);
                o.addDiscussion()
            });
            return false
        },
        addAssessment: function(m) {
            b.Us.AddAssessmentView().on("saveAssessment", function(o, p) {
                var n = new b.Ms.Assignment();
                n.set("AssignmentId", o);
                n.fetch({
                    error: function() {
                        p3.displayError("Error loading assignment")
                    },
                    success: function(q, r) {
                        p3.router().navigate("#assessmentedit/" + o + "/" + n.get("SectionLinks")[0].AssignmentIndexId + "/0", true)
                    }
                })
            });
            m.preventDefault()
        },
        addAssignment: function(m) {
            b.Us.FetchTeacherSections(a.Data.leadSectionId, a.Data.isOwner, a.Data.isManager);
            b.Us.AddAssignmentView({
                defaultDate: f.localDateTime()
            }).on("saveAssignment", function() {
                setTimeout(function() {
                    $("#calendar-main-view").trigger("updateAssignments")
                }, 500)
            });
            m.preventDefault()
        },
        showLtiConfigList: function(m) {
            e.Us.showLtiConfigList(0, m)
        },
        showStatusFilter: function(m) {
            if (_.isUndefined(p3.Data.LMS)) {
                p3.Data.LMS = {}
            }
            if (!p3.Data.LMS.sectionFilterStatus) {
                p3.Data.LMS.sectionFilterStatus = [];
                p3.Data.LMS.sectionFilterStatus.push({
                    Status: -1,
                    Name: "Need Action",
                    LabelClass: "label-info",
                    Selected: true
                });
                p3.Data.LMS.sectionFilterStatus.push({
                    Status: 0,
                    Name: "In Progress",
                    LabelClass: "label-warning",
                    Selected: true
                });
                if (p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.ASSESSMENTS)) {
                    p3.Data.LMS.sectionFilterStatus.push({
                        Status: 6,
                        Name: "Paused",
                        LabelClass: "label-warning",
                        Selected: true
                    })
                }
                p3.Data.LMS.sectionFilterStatus.push({
                    Status: 2,
                    Name: "Overdue",
                    LabelClass: "label-important",
                    Selected: true
                });
                p3.Data.LMS.sectionFilterStatus.push({
                    Status: 1,
                    Name: "Completed",
                    LabelClass: "label-success",
                    Selected: true
                });
                if (p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADEBOOK)) {
                    p3.Data.LMS.sectionFilterStatus.push({
                        Status: 4,
                        Name: "Graded",
                        LabelClass: "label-success",
                        Selected: true
                    })
                }
            }
            var n = new a.Vs.StatusFilter({
                assignmentFilterStatus: p3.Data.LMS.sectionFilterStatus
            });
            p3.rV(n, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            n.on("statusFiltered", function() {
                $("#calendar-main-view").trigger("updateAssignments")
            });
            m.preventDefault()
        },
        showICalMenu: function(m) {
            $("#report-menu").hide();
            $("#ical-menu").toggle();
            return false
        },
        showReportMenu: function(m) {
            $("#ical-menu").hide();
            $("#report-menu").toggle();
            return false
        },
        hideReportMenu: function(m) {
            $("#report-menu").hide()
        },
        openFeed: function(m) {
            $("#ical-menu").hide();
            window.open($(m.target).data().target, "_blank")
        },
        printCalendar: function(m) {
            p3.rV(new a.Vs.PrintCalendar({
                calendarEvents: this.options.events.toJSON()
            }), p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            m.preventDefault()
        },
        doStatusChange: function(p) {
            var t = this,
                n = $(p.currentTarget),
                m = n.closest(".btn-group"),
                q = n.data("status"),
                r = m.data("status"),
                o, s;
            $(".btn-group.open").removeClass("open");
            if (q !== r) {
                o = m.data("indexid");
                s = new b.Ms.AssignmentStatusUpdate({
                    assignmentIndexId: o,
                    assignmentStatus: q
                });
                s.save({}, {
                    success: function(u, v) {
                        t.requestCalendarData()
                    },
                    error: function(u, v) {
                        p3.displayError("Error updating assignment status")
                    }
                })
            }
            return false
        },
        checkWidth: function() {
            var n = $(".assignment-calendar-menu-bar").is(":visible"),
                o = this,
                m = $("#calendar-container");
            if (n) {
                if (p3.Data.LMS.SectionCalendarView !== "basicDay") {
                    p3.Data.LMS.previousCalView = p3.Data.LMS.SectionCalendarView;
                    p3.Data.LMS.SectionCalendarView = "basicDay";
                    o.requestCalendarData(m.fullCalendar("getDate").toDate())
                }
            } else {
                if (!_.isUndefined(p3.Data.LMS.previousCalView) && p3.Data.LMS.previousCalView !== "basicDay") {
                    p3.Data.LMS.SectionCalendarView = p3.Data.LMS.previousCalView;
                    p3.Data.LMS.previousCalView = undefined;
                    o.requestCalendarData(m.fullCalendar("getDate").toDate())
                }
            }
        }
    });
    a.Vs.ConfirmMoveModal = Bb.View.extend({
        template: "AcademicCalendar/confirmation.template.html",
        events: {
            "click #assignment-move-save-button": "doSave",
            "click #assignment-move-cancel-button": "doCancel",
            "click input[type=radio]": "doSectionDisplayUpdate"
        },
        initialize: function(m) {
            this.collection = new a.Cs.SectionForAssignments({}, {
                AssignmentId: m.AssignmentId,
                SectionId: m.SectionId
            });
            this.markingPeriods = new b.Cs.MarkingPeriods()
        },
        render: function(m) {
            var n = this;
            $(m).html(n.el);
            p3.fT(n.template, function(o) {
                n.$el.html(o());
                n.collection.fetch({
                    success: function(p, s, q) {
                        n.renderItems()
                    },
                    error: function(p, s, q) {
                        p3.log("Error: the retrieval of section data failed.")
                    }
                })
            })
        },
        renderItems: function() {
            var t = this,
                m, o, s, n, r, q, p;
            if (t.collection.length < 1) {
                p3.log("Error: No sections were found for the moved Assignment, this should not happen")
            }
            t.collection.each(function(u) {
                if (u.get("SectionId") === t.collection.SectionId) {
                    m = u
                } else {
                    if (t.options.byAssigned) {
                        u.set("AssignmentDate", t.options.AssignedDate);
                        p = f.getDate(u.get("DueDate"));
                        p.setDate(p.getDate() + t.options.dayDelta);
                        u.set("DueDate", f.getDateString(p))
                    } else {
                        u.set("DueDate", t.options.DueDate);
                        p = f.getDate(u.get("AssignmentDate"));
                        p.setDate(p.getDate() + t.options.dayDelta);
                        u.set("AssignmentDate", f.getDateString(p))
                    }
                }
            });
            if (m) {
                m.set("AssignmentDate", t.options.AssignedDate);
                m.set("DueDate", t.options.DueDate);
                o = m.get("Section").Name;
                $("#confirm-box-title").html(o);
                t.collection.remove(m, {
                    silent: true
                });
                t.collection.add(m, {
                    at: 0,
                    silent: true
                })
            }
            s = $("#sections-to-update-listing");
            n = new a.Vs.SectionsForMove({
                collection: t.collection
            });
            p3.rV(n, s, true);
            r = t.collection.map(function(u) {
                return {
                    AssignmentIndexId: u.get("AssignmentIndexId"),
                    SectionId: u.get("SectionId")
                }
            });
            q = "";
            _.each(r, function(u) {
                if (q.length > 0) {
                    q += ","
                }
                q += u.SectionId
            });
            t.markingPeriods.fetch({
                data: {
                    sectionList: q
                },
                success: function(x, I, G) {
                    var J, E, K, F, H, y, u, z, v, w, A, B, C = function(L) {
                            return L.AssignmentIndexId == $(J[E]).data("assignmentIndexId")
                        },
                        D = function(L) {
                            return L.get("section_id") === K
                        };
                    t.validateDueDates();
                    J = $(".grade-book-tooltip-location");
                    for (E = 0; E < J.length; E++) {
                        K = _.find(r, C);
                        if (K && K.SectionId > 0) {
                            K = K.SectionId;
                            F = x.filter(D);
                            H = "<strong>Marking Periods:</strong><br>Due date must fall within a marking period for this assignment to be included in Grade Book.<br>";
                            for (y = 0; y < F.length; y++) {
                                u = F[y].get("begin_date");
                                z = F[y].get("end_date");
                                if (typeof u === "string" && typeof z === "string") {
                                    v = f.getDateString(f.getDate(u));
                                    w = f.getTimeString(f.getTime(u));
                                    A = f.getDateString(f.getDate(z));
                                    B = f.getTimeString(f.getTime(z));
                                    H += F[y].get("marking_period_description") + "<br><div>Begin: " + v + " " + w + "<br>End: " + A + " " + B + "<br></div>"
                                }
                            }
                            $(J[E]).tooltip({
                                title: H
                            })
                        }
                    }
                }
            })
        },
        validateDueDates: function() {
            var x = this,
                m = $("#assignment-sections-to-delete-list"),
                s = [],
                w = [],
                r = 0,
                v = x.collection.map(function(y) {
                    return {
                        AssignmentIndexId: y.get("AssignmentIndexId"),
                        SectionId: y.get("SectionId")
                    }
                }),
                n, u, t, o, q, p;
            m.find("tr").each(function(z, A) {
                var y = $(A);
                if (y.data("ignore") !== true && y.find(".datepicker:last:hidden").length === 0) {
                    n = y.data("assignmentIndexId");
                    u = _.find(v, function(B) {
                        return B.AssignmentIndexId === n
                    });
                    s.push(true);
                    t = x.markingPeriods.filter(function(B) {
                        return B.get("section_id") === u.SectionId
                    });
                    _.each(t, function(B) {
                        o = f.getDate(B.get("begin_date"));
                        q = f.getDate(B.get("end_date"));
                        p = f.getDate(y.find(".datepicker:last").val());
                        if (p >= o && p <= q) {
                            s[z - r] = false;
                            w.push(u.SectionId);
                            y.find(".datepicker:last").closest("td.control-group").removeClass("error")
                        } else {
                            if (w.indexOf(u.SectionId) === -1) {
                                y.find(".datepicker:last").closest("td.control-group").addClass("error")
                            }
                        }
                    })
                } else {
                    r++
                }
            });
            if (s.indexOf(true) !== -1) {
                p3.Us.InfoMessage.ErrorBox(p3.Us.InfoMessageLibrary.Assignment.DueDateMustBeInMarkingPeriod, "#delete-confirm-modal-errors", false)
            } else {
                $("#delete-confirm-modal-errors").removeClass("alert alert-error").html("")
            }
        },
        doSave: function(n) {
            n.preventDefault();
            n.stopPropagation();
            $("#delete-confirm-modal-errors").removeClass("alert alert-error").html("");
            var r = this,
                o = new a.Cs.MoveAssignment(),
                m = $("#assignment-sections-to-delete-list"),
                q = m.children("tr"),
                p;
            q.each(function(t, u) {
                var s = $(u),
                    v, w;
                if (!s.data("ignore") && s.data("noSave") !== true) {
                    v = s.children("td");
                    w = {};
                    w.AssignmentIndexId = s.data("assignmentIndexId");
                    w.AssignmentDate = $(v[1]).children("input").val();
                    p = $(v[2]).children("input").getTime();
                    if (p) {
                        w.AssignmentTime = p
                    }
                    w.DueDate = $(v[3]).children("input").val();
                    w.PublishInd = $(v[4]).find("input:checked").length > 0 ? true : false;
                    o.add(w)
                }
            });
            r.validateDueDates();
            if (m.find(".error").length === 0) {
                o.sync("create", o, {
                    success: function(s, u, t) {
                        p3.Layout.Containers.Modal.modal("hide")
                    },
                    error: function(s, u, t) {
                        p3.Layout.Containers.Modal.modal("hide")
                    }
                })
            }
        },
        doCancel: function(m) {
            m.preventDefault();
            m.stopPropagation();
            p3.Layout.Containers.Modal.modal("hide")
        },
        doSectionDisplayUpdate: function(m) {
            var o = this,
                n = $("#assignment-sections-to-delete-list").children("tr");
            switch ($(m.currentTarget).val()) {
                case "1":
                    n.each(function(q, r) {
                        var p = $(r);
                        if (!p.data("ignore")) {
                            p.children("td:first").removeClass("muted");
                            p.data("noSave", false);
                            p.find("input").show();
                            p.find("span").show();
                            p.find("i").show()
                        }
                    });
                    break;
                default:
                    n.each(function(q, r) {
                        var p = $(r);
                        if (!p.data("ignore") && p.data("assignmentIndexId") !== o.options.AssignmentIndexId) {
                            p.children("td:first").addClass("muted");
                            p.data("noSave", true);
                            p.find("input").hide();
                            p.find("span").hide();
                            p.find("i").hide()
                        }
                    });
                    break
            }
        }
    });
    a.Vs.SectionsForMove = Bb.View.extend({
        template: "AcademicCalendar/sections.template.html",
        events: {},
        render: function(m) {
            var n = this;
            $(m).html(n.el);
            p3.fT(n.template, function(p) {
                n.$el.html(p({
                    items: n.collection.toJSON()
                }));
                p3.setModalHeight(p3.Layout.Containers.Modal);
                g.Us.initialize(".datepicker");
                k.Us.initialize(".timepicker");
                var o = $("input[type=radio]:checked");
                if (o.length > 0) {
                    o.trigger("click")
                }
            })
        }
    });
    a.Vs.SectionFilter = Bb.View.extend({
        template: "AcademicCalendar/sectionfilter.template.html",
        events: {
            "click #btn-filter-apply": "applyChanges",
            "click #select-all-button": "selectAll",
            "click .section-button": "selectChange"
        },
        render: function(m) {
            var n = this;
            $(m).html(n.el);
            p3.fT(n.template, function(o) {
                n.$el.html(o({
                    sections: p3.Data.LMS.assignmentFilterSections.toJSON()
                }));
                p3.setModalHeight(p3.Layout.Containers.Modal);
                if ($(".section-button").length === $(".section-button.active").length) {
                    $("#select-all-button").addClass("active")
                }
            })
        },
        applyChanges: function(m) {
            p3.Data.LMS.assignmentFilterSections.each(function(n) {
                n.set("Selected", $('.section-button[data-id="' + n.get("SectionId") + '"]').hasClass("active"))
            });
            this.trigger("sectionsFiltered");
            p3.Layout.Containers.Modal.modal("hide")
        },
        selectAll: function(m) {
            if ($("#select-all-button").hasClass("active")) {
                $(".section-button").removeClass("active")
            } else {
                $(".section-button").addClass("active")
            }
        },
        selectChange: function(m) {
            if ($(m.currentTarget).hasClass("active")) {
                $("#select-all-button").removeClass("active")
            } else {
                if ($(".section-button").length === $(".section-button.active").length + 1) {
                    $("#select-all-button").addClass("active")
                }
            }
        }
    });
    a.Vs.StatusFilter = Bb.View.extend({
        template: "AcademicCalendar/statusfilter.template.html",
        events: {
            "click #btn-filter-apply": "applyChanges",
            "click #select-all-button": "selectAll",
            "click .status-button": "selectChange"
        },
        render: function(m) {
            var n = this;
            $(m).html(n.el);
            p3.fT(n.template, function(o) {
                n.$el.html(o({
                    status: n.options.assignmentFilterStatus
                }));
                p3.setModalHeight(p3.Layout.Containers.Modal);
                if ($(".status-button").length === $(".status-button.active").length) {
                    $("#select-all-button").addClass("active")
                }
            })
        },
        applyChanges: function(m) {
            var o = this,
                n;
            for (n = 0; n < o.options.assignmentFilterStatus.length; n++) {
                o.options.assignmentFilterStatus[n].Selected = $('.status-button[data-id="' + o.options.assignmentFilterStatus[n].Status + '"]').hasClass("active")
            }
            this.trigger("statusFiltered");
            p3.Layout.Containers.Modal.modal("hide")
        },
        selectAll: function(m) {
            if ($("#select-all-button").hasClass("active")) {
                $(".status-button").removeClass("active")
            } else {
                $(".status-button").addClass("active")
            }
        },
        selectChange: function(m) {
            if ($(m.currentTarget).hasClass("active")) {
                $("#select-all-button").removeClass("active")
            } else {
                if ($(".status-button").length === $(".status-button.active").length + 1) {
                    $("#select-all-button").addClass("active")
                }
            }
        }
    });
    a.Vs.AssignmentCalendar = Bb.View.extend({
        template: "assignmentcenter/calendar.template.html",
        id: "calendar-main-view",
        events: {
            refreshEvents: "eventRefresh",
            updateAssignments: "updateAssignments",
            "click .assignmentDisplayTypeFilter": "updateFilter",
            "click #day-view": "dayView",
            "click #week-view": "weekView",
            "click #month-view": "monthView",
            "click #button-today": "gotoToday",
            "click #today-menu": "gotoToday",
            "click #previous-button": "movePrevious",
            "click #next-button": "moveNext",
            "click #mobile-previous-button": "movePrevious",
            "click #mobile-next-button": "moveNext",
            "click a.assignment-status-link": "doStatusChange",
            "click .list-mode-button": "showList",
            "click #list-view-menu": "showList",
            "click #settingsButton": "editSettings",
            "click #settings-menu": "editSettings",
            "click #add-assessment-btn": "addAssessment",
            "click #add-assessment-menu": "addAssessment",
            "click #add-assignment-btn": "addAssignment",
            "click #add-assignment-menu": "addAssignment",
            "click #lti-config-btn": "showLtiConfigList",
            "click #lti-config-menu": "showLtiConfigList",
            "click #filter-teacher-sections": "showSectionFilter",
            "click #filter-student-sections": "showSectionFilter",
            "click #filter-menu": "showSectionFilter",
            "click #filter-status": "showStatusFilter",
            "click #filter-status-menu": "showStatusFilter",
            "click #missing-assignment": "showMissingAssignmentList",
            "click #missing-assignment-menu": "showMissingAssignmentList",
            "click #ical-dropdown": "showICalMenu",
            "click #report-dropdown": "showReportMenu",
            "click #lti-button": "showLtiList",
            "click button[data-target]": "openFeed",
            "click .report-link": "hideReportMenu",
            "click #print-button": "printCalendar",
            "click #add-discuss-btn": "addDiscussion",
            "click #add-discuss-menu": "addDiscussion"
        },
        initialize: function(m) {
            var o = this,
                n = o.options.studentId || p3.Data.Context.get("UserInfo").UserId;
            this.collection = new c.Cs.Assignments();
            this.options.canEdit = ((p3.Data.Context.getSelectedPersona().Id === 3 && n === p3.Data.Context.get("UserInfo").UserId) || p3.Data.Context.getSelectedPersona().Id == 5);
            if (_.isUndefined(p3.Data.LMS) || !p3.Data.LMS.OptionsDefaulted) {
                d.Us.getAssignmentOptionDefaults()
            }
            if (!_.isUndefined(p3.Data.LMS) && !_.isUndefined(p3.Data.LMS.AssignmentCenterfilter)) {
                this.options.currentFilter = m.filter || p3.Data.LMS.AssignmentCenterfilter
            } else {
                this.options.currentFilter = m.filter || 0
            }
        },
        dispose: function() {
            $('link[rel=stylesheet][href~="/ftpimages/999/podium/libs/fullcalendar/2.4.0/fullcalendar.academic.css"]').remove();
            $(window).off("resize")
        },
        render: function(m) {
            p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.jQueryUI, function() {
                return true
            });
            var o = this,
                n;
            $(m).html(o.el);
            p3.fT(o.template, function(p) {
                o.$el.html(p({
                    containerName: o.options.containerName
                }));
                o.options.view = o;
                p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.AcademicCalendar, o.initializeCalendar, o.options);
                o.renderHeader()
            });
            n = _.debounce(function() {
                if (o.checkWidth) {
                    o.checkWidth()
                }
            }, 500);
            $(window).resize(n)
        },
        initializeCalendar: function(m) {
            a.Us.InitializeCalendar(m);
            m.view.requestCalendarData()
        },
        renderHeader: function() {
            var n = this,
                m = new a.Vs.HeaderView({
                    studentId: n.options.studentId,
                    assignCenter: true,
                    sectionId: 0
                });
            p3.rV(m, "#calendar-header-container", true);
            window.setTimeout(function() {
                var o = $("#calendar-container");
                if (o.length > 0 && o.fullCalendar !== undefined) {
                    a.Us.updateHeaderDisplay(o.fullCalendar("getView"))
                }
            }, 100)
        },
        eventRefresh: function() {
            var m = $("#calendar-container");
            if (typeof m.fullCalendar === "function") {
                m.fullCalendar("removeEvents");
                m.fullCalendar("addEventSource", this.options.events.toJSON())
            }
        },
        doStatusChange: function(p) {
            var n = $(p.currentTarget),
                m = n.closest(".btn-group"),
                q = n.data("status"),
                r = m.data("status"),
                o, s;
            $(".btn-group.open").removeClass("open");
            if (q !== r) {
                o = m.data("indexid");
                s = new b.Ms.AssignmentStatusUpdate({
                    assignmentIndexId: o,
                    assignmentStatus: q
                });
                s.save({}, {
                    success: function(t, w) {
                        var u = "",
                            v;
                        switch (q) {
                            case -1:
                                if (n.text() === "Overdue") {
                                    u = "btn-danger";
                                    v = "#fbe5e4"
                                } else {
                                    u = "btn-info";
                                    v = "#d4f1fa"
                                }
                                break;
                            case 0:
                                u = "btn-warning";
                                v = "#f9ecd9";
                                break;
                            case 1:
                                u = "btn-success";
                                v = "#dcf3dc";
                                break
                        }
                        m.find(".assignment-status-button").removeClass("btn-warning").removeClass("btn-danger").removeClass("btn-success").removeClass("btn-info").addClass(u).html('<span class="caret"></span>&nbsp;' + n.text());
                        m.parents(".fc-event-inner").css("border-color", v).css("background-color", v);
                        m.parents(".fc-event").css("border-color", v).css("background-color", v);
                        n.closest(".btn-group").data("status", q)
                    },
                    error: function(t, u) {
                        p3.displayError("Error updating assignment status")
                    }
                })
            }
            return false
        },
        requestCalendarData: function(r) {
            var w = this,
                u, q, n, s = p3.Data.Context.getSelectedPersona().Id,
                p = r || p3.Data.LMS.saCaldate || f.localDateTime(),
                v, t, o, m = $("#calendar-container");
            p3.Data.LMS.saCaldate = p;
            if (m.length > 0) {
                if (!_.isUndefined(p3.Data.LMS) && !_.isUndefined(p3.Data.LMS.calendarView)) {
                    m.fullCalendar("changeView", p3.Data.LMS.calendarView)
                }
                n = m.fullCalendar("getView");
                u = n.start.toDate();
                q = n.end.toDate()
            } else {
                if (!_.isUndefined(p3.Data.LMS) && !_.isUndefined(p3.Data.LMS.calendarView)) {
                    switch (p3.Data.LMS.calendarView) {
                        case "basicDay":
                            u = p;
                            q = p;
                            break;
                        case "basicWeek":
                            u = new Date(p.getTime());
                            q = new Date(p.getTime());
                            u = new Date(u.setDate(u.getDate() - 7));
                            q = new Date(q.setDate(q.getDate() + 7));
                            break;
                        case "month":
                            u = new Date(p.getTime());
                            q = new Date(p.getTime());
                            u = new Date(u.setDate(u.getDate() - 40));
                            q = new Date(q.setDate(q.getDate() + 40));
                            break
                    }
                } else {
                    u = p;
                    q = p
                }
            }
            v = c.Us.getStatusFilterList();
            t = c.Us.getSectionFilterList();
            o = {
                filter: p3.Data.LMS.AssignmentCenterfilter,
                dateStart: (u.getMonth() + 1) + "/" + u.getDate() + "/" + u.getFullYear(),
                dateEnd: (q.getMonth() + 1) + "/" + q.getDate() + "/" + q.getFullYear(),
                persona: s,
                statusList: v,
                sectionList: t
            };
            o.filter = d.Us.verifyAssignmentCenterFilter(o.filter, b.Enum.viewByFilters.ACTIVE);
            if (w.options.studentId) {
                o.userId = w.options.studentId
            }
            if (typeof m.fullCalendar === "function") {
                m.fullCalendar("gotoDate", p)
            }
            c.Data.Assignments.fetch({
                data: o,
                success: function(x, A) {
                    var y, z;
                    x.each(function(B) {
                        y = B.get("date_ue");
                        z = B.get("date_assigned");
                        if (!l.isEmptier(y) && typeof y.substring === "function" && y.indexOf(" ") > 0) {
                            B.set("date_due", f.getDateString(f.getDate(y)))
                        }
                        if (!l.isEmptier(z) && typeof z.substring === "function" && z.indexOf(" ") > 0) {
                            B.set("date_assigned", f.getDateString(f.getDate(z)))
                        }
                        B.set("assess_assigned", z)
                    });
                    w.options.events = a.Us.GenerateCenterEventCollection(x, w.options.currentFilter, w.options.canEdit);
                    if (typeof m.fullCalendar === "function") {
                        m.fullCalendar("removeEvents");
                        m.fullCalendar("addEventSource", w.options.events.toJSON());
                        if (!_.isUndefined(p3.Data.LMS) && !_.isUndefined(p3.Data.LMS.calendarView)) {
                            m.fullCalendar("changeView", p3.Data.LMS.calendarView)
                        }
                    }
                }
            })
        },
        updateAssignments: function(n) {
            n.stopPropagation();
            n.preventDefault();
            var m;
            if (!_.isUndefined(p3.Data.LMS) && !_.isUndefined(p3.Data.LMS.AssignmentCenterDate)) {
                m = p3.Data.LMS.AssignmentCenterDate
            }
            this.requestCalendarData(m)
        },
        updateFilter: function(o) {
            var p = this,
                m, n = $(o.currentTarget);
            o.stopPropagation();
            o.preventDefault();
            $(".btn-group.open").removeClass("open");
            p.options.currentFilter = p3.Data.LMS.AssignmentCenterfilter = n.data("filter");
            $(".assignmentDisplayTypeFilter").each(function(r) {
                var q = $(this);
                q.find("i").removeClass("p3icon-radioOn").addClass("p3icon-radioOff");
                q.removeClass("active cal-filter-on").addClass("cal-filter-off")
            });
            if (n.hasClass("sec-75-bgc-hover")) {
                m = $(".assignmentDisplayTypeFilter[data-filter='" + p3.Data.LMS.AssignmentCenterfilter.toString() + "']")
            } else {
                m = n
            }
            m.find("i").removeClass("p3icon-radioOff").addClass("p3icon-radioOn");
            m.addClass("active cal-filter-on").removeClass("cal-filter-off");
            p.requestCalendarData($("#calendar-container").fullCalendar("getDate").toDate())
        },
        dayView: function(m) {
            var n = this;
            p3.Data.LMS.calendarView = "basicDay";
            n.requestCalendarData($("#calendar-container").fullCalendar("getDate").toDate());
            if (_.isUndefined(p3.Data.LMS)) {
                p3.Data.LMS = {}
            }
        },
        weekView: function(m) {
            var n = this;
            p3.Data.LMS.calendarView = "basicWeek";
            n.requestCalendarData($("#calendar-container").fullCalendar("getDate").toDate());
            if (_.isUndefined(p3.Data.LMS)) {
                p3.Data.LMS = {}
            }
        },
        monthView: function(m) {
            var n = this;
            p3.Data.LMS.calendarView = "month";
            n.requestCalendarData($("#calendar-container").fullCalendar("getDate").toDate());
            if (_.isUndefined(p3.Data.LMS)) {
                p3.Data.LMS = {}
            }
        },
        gotoToday: function(m) {
            var o = this,
                n = f.localDateTime();
            if (n) {
                $("#calendar-container").fullCalendar("gotoDate", n);
                o.requestCalendarData(n);
                if (_.isUndefined(p3.Data.LMS)) {
                    p3.Data.LMS = {}
                }
                p3.Data.LMS.AssignmentCenterDate = n
            }
            m.preventDefault()
        },
        movePrevious: function(o) {
            var p = this,
                n, m = $("#calendar-container");
            m.fullCalendar("prev");
            n = m.fullCalendar("getDate").toDate();
            p.requestCalendarData(n);
            if (_.isUndefined(p3.Data.LMS)) {
                p3.Data.LMS = {}
            }
            p3.Data.LMS.AssignmentCenterDate = n
        },
        moveNext: function(o) {
            var p = this,
                n, m = $("#calendar-container");
            m.fullCalendar("next");
            n = m.fullCalendar("getDate").toDate();
            p.requestCalendarData(n);
            if (_.isUndefined(p3.Data.LMS)) {
                p3.Data.LMS = {}
            }
            p3.Data.LMS.AssignmentCenterDate = n
        },
        showList: function(n) {
            p3.Data.LMS.DisplayCalendar = false;
            var m = "#site-main";
            if (this.options.studentId && this.options.studentId > 0) {
                m = "#child-main"
            }
            p3.rV(new c.Vs.LayoutView({
                studentId: this.options.studentId,
                containerName: "Assignments"
            }), m, true);
            return false
        },
        editSettings: function(m) {
            $(".btn-group.open").removeClass("open");
            p3.rV(new c.Vs.AssignmentSettings(), p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            return false
        },
        addDiscussion: function(n) {
            var o = this,
                m = b.Us.AddDiscussionView();
            m.on("saveDiscussion", function(p, q) {
                setTimeout(function() {
                    $("#calendar-main-view").trigger("updateAssignments")
                }, 500)
            });
            m.on("saveAddDiscussion", function(p, q) {
                setTimeout(function() {
                    $("#calendar-main-view").trigger("updateAssignments")
                }, 500);
                o.addDiscussion()
            });
            return false
        },
        addAssessment: function(m) {
            b.Us.AddAssessmentView().on("saveAssessment", function(o, p) {
                var n = new b.Ms.Assignment();
                n.set("AssignmentId", o);
                n.fetch({
                    error: function() {
                        p3.displayError("Error loading assignment")
                    },
                    success: function(q, r) {
                        p3.router().navigate("#assessmentedit/" + o + "/" + n.get("SectionLinks")[0].AssignmentIndexId + "/0", true)
                    }
                })
            });
            m.preventDefault()
        },
        addAssignment: function(m) {
            b.Us.FetchTeacherSections(a.Data.leadSectionId, a.Data.isOwner, a.Data.isManager);
            b.Us.AddAssignmentView({
                defaultDate: f.localDateTime()
            }).on("saveAssignment", function() {
                setTimeout(function() {
                    $("#calendar-main-view").trigger("updateAssignments")
                }, 500)
            });
            m.preventDefault()
        },
        showLtiConfigList: function(m) {
            e.Us.showLtiConfigList(0, m)
        },
        showSectionFilter: function(m) {
            var p, n, o;
            $(".btn-group.open").removeClass("open");
            if (_.isUndefined(p3.Data.LMS)) {
                p3.Data.LMS = {}
            }
            if (!p3.Data.LMS.assignmentFilterSections) {
                p3.Data.LMS.assignmentFilterSections = new b.Cs.ExistingSections();
                o = p3.Data.Context.get("Groups");
                for (p = 0; p < o.length; p++) {
                    if (o[p].Association == 1 && o[p].CurrentEnrollment) {
                        p3.Data.LMS.assignmentFilterSections.add({
                            SectionId: o[p].SectionId,
                            Selected: true,
                            Name: o[p].GroupName
                        })
                    }
                }
            }
            n = new a.Vs.SectionFilter();
            p3.rV(n, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            n.on("sectionsFiltered", function() {
                $("#calendar-main-view").trigger("updateAssignments")
            });
            m.preventDefault()
        },
        showStatusFilter: function(m) {
            if (_.isUndefined(p3.Data.LMS)) {
                p3.Data.LMS = {}
            }
            if (!p3.Data.LMS.assignmentFilterStatus) {
                p3.Data.LMS.assignmentFilterStatus = [];
                p3.Data.LMS.assignmentFilterStatus.push({
                    Status: -1,
                    Name: "Need Action",
                    LabelClass: "label-info",
                    Selected: true
                });
                p3.Data.LMS.assignmentFilterStatus.push({
                    Status: 0,
                    Name: "In Progress",
                    LabelClass: "label-warning",
                    Selected: true
                });
                p3.Data.LMS.assignmentFilterStatus.push({
                    Status: 2,
                    Name: "Overdue",
                    LabelClass: "label-important",
                    Selected: true
                });
                p3.Data.LMS.assignmentFilterStatus.push({
                    Status: 1,
                    Name: "Completed",
                    LabelClass: "label-success",
                    Selected: true
                });
                if (p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADEBOOK)) {
                    p3.Data.LMS.assignmentFilterStatus.push({
                        Status: 4,
                        Name: "Graded",
                        LabelClass: "label-success",
                        Selected: true
                    })
                }
            }
            var n = new a.Vs.StatusFilter({
                assignmentFilterStatus: p3.Data.LMS.assignmentFilterStatus
            });
            p3.rV(n, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            n.on("statusFiltered", function() {
                $("#calendar-main-view").trigger("updateAssignments")
            });
            m.preventDefault()
        },
        showMissingAssignmentList: function(m) {
            m.preventDefault();
            if (p3.Data.Context.getSelectedPersona().Id === 2) {
                e.Us.showStudentMissingAssignmentList()
            }
        },
        showICalMenu: function(m) {
            $("#report-menu").hide();
            $("#ical-menu").toggle();
            return false
        },
        showReportMenu: function(m) {
            $("#ical-menu").hide();
            $("#report-menu").toggle();
            return false
        },
        showLtiList: function(m) {
            m.stopPropagation();
            m.preventDefault()
        },
        hideReportMenu: function(m) {
            $("#report-menu").hide()
        },
        openFeed: function(m) {
            $("#ical-menu").hide();
            window.open($(m.target).data().target, "_blank")
        },
        printCalendar: function(m) {
            p3.rV(new a.Vs.PrintCalendar({
                calendarEvents: this.options.events.toJSON()
            }), p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            m.preventDefault()
        },
        checkWidth: function() {
            var n = $(".assignment-calendar-menu-bar").is(":visible"),
                o = this,
                m = $("#calendar-container");
            if (n) {
                if (p3.Data.LMS.calendarView !== "basicDay") {
                    p3.Data.LMS.previousCalView = p3.Data.LMS.calendarView;
                    p3.Data.LMS.calendarView = "basicDay";
                    o.requestCalendarData(m.fullCalendar("getDate").toDate())
                }
            } else {
                if (!_.isUndefined(p3.Data.LMS.previousCalView) && p3.Data.LMS.previousCalView !== "basicDay") {
                    p3.Data.LMS.calendarView = p3.Data.LMS.previousCalView;
                    p3.Data.LMS.previousCalView = undefined;
                    o.requestCalendarData(m.fullCalendar("getDate").toDate())
                }
            }
        }
    });
    a.Vs.HeaderView = Bb.View.extend({
        template: "assignmentcenter/assignmentcenter.header.template.html",
        events: {},
        initialize: function(m) {
            if (_.isUndefined(p3.Data.LMS) || !p3.Data.LMS.OptionsDefaulted) {
                d.Us.getAssignmentOptionDefaults()
            }
        },
        render: function(m) {
            var o = this,
                n = {};
            $(m).append(this.el);
            o.getRenderDataMissingAssignments(n)
        },
        getRenderDataMissingAssignments: function(n) {
            var o = this,
                m;
            n.persona = p3.Data.Context.getSelectedPersona().Id;
            n.missingAssignmentInd = false;
            if (n.persona === 2 && o.options.assignCenter) {
                m = new e.Ms.StudentMissingAssignmentCheck();
                m.fetch({
                    success: function() {
                        n.missingAssignmentInd = m.hasMissingAssignments();
                        o.renderTemplate(n)
                    },
                    error: function() {
                        p3.displayError("Error loading missing assignment information");
                        n.missingAssignmentInd = true;
                        o.renderTemplate(n)
                    }
                })
            } else {
                o.renderTemplate(n)
            }
        },
        renderTemplate: function(t) {
            var x = this,
                w = (x.options.studentId || p3.Data.Context.get("UserInfo").UserId),
                s = p3.Data.Context.getSelectedPersona().Id,
                m, p = false,
                r = false,
                q = false,
                n, o, v, u, y;
            if (!x.options.assignCenter) {
                p = true;
                r = true;
                q = true
            }
            if (p3.Data.LMS.AssignmentCenterDate) {
                m = p3.Data.LMS.AssignmentCenterDate
            } else {
                m = f.localDateTime();
                p3.Data.LMS.AssignmentCenterDate = m
            }
            n = c.Us.GetDateRange(m);
            o = new h.Ms.iCalAssignmentsGet();
            o.fetch({
                async: false,
                data: {
                    personaId: p3.Data.Context.getSelectedPersona().Id,
                    userId: p3.Data.Context.get("UserInfo").UserId,
                    sectionId: x.options.sectionId,
                    schoolYearLabel: p3.Data.SchoolContext.get("CurrentSchoolYear").SchoolYearLabel,
                    sdate: p3.Us.Tools.shortDateDisplay(n[0].getTime()),
                    edate: p3.Us.Tools.shortDateDisplay(n[1].getTime())
                }
            });
            e.Us.refreshLtiConfigSummary(0);
            v = new i.Cs.ReportList();
            if (!p3.Data.ReportList) {
                i.loadReportList({
                    success: function(z, A) {
                        v.remove(v.at(0));
                        if (x.options.assignCenter) {
                            if (i.hasAccessToReportId(261)) {
                                y = j.Us.getUrlById(1691, "__pd=gm_fv&pk=261");
                                u = new i.Ms.ReportList({
                                    ReportName: "Assignment Counts - By Section",
                                    Link: y
                                });
                                v.add(u)
                            }
                            if (i.hasAccessToReportId(328)) {
                                y = j.Us.getUrlById(1691, "__pd=gm_fv&pk=328");
                                u = new i.Ms.ReportList({
                                    ReportName: "Assignments - By Section",
                                    Link: y
                                });
                                v.add(u)
                            }
                            if (i.hasAccessToReportId(335)) {
                                y = j.Us.getUrlById(1691, "__pd=gm_fv&pk=335");
                                u = new i.Ms.ReportList({
                                    ReportName: "Assignments Due - By Department or Grade",
                                    Link: y
                                });
                                v.add(u)
                            }
                            if (i.hasAccessToReportId(80)) {
                                y = j.Us.getUrlById(1691, "__pd=gm_fv&pk=80");
                                u = new i.Ms.ReportList({
                                    ReportName: "Roster Assignments",
                                    Link: y
                                });
                                v.add(u)
                            }
                            if (i.hasAccessToReportId(215)) {
                                y = j.Us.getUrlById(1691, "pk=215&sid=" + w + "&vid=" + p3.Data.Context.get("UserInfo").UserId + "&ext=vw");
                                u = new i.Ms.ReportList({
                                    ReportName: "View Assignment Grades",
                                    Link: y
                                });
                                v.add(u)
                            }
                            if (i.hasAccessToReportId(247)) {
                                y = j.Us.getUrlById(1691, "pk=247&sid=" + w + "&vid=" + p3.Data.Context.get("UserInfo").UserId + "&ext=vw");
                                u = new i.Ms.ReportList({
                                    ReportName: "View Assignment Grades w/ comments",
                                    Link: y
                                });
                                v.add(u)
                            }
                            if (i.hasAccessToReportId(259)) {
                                y = j.Us.getUrlById(1691, "pk=259&ch=1&sid=" + w + "&vid=" + p3.Data.Context.get("UserInfo").UserId + "&ext=vw");
                                u = new i.Ms.ReportList({
                                    ReportName: "Cumulative Grades",
                                    Link: y
                                });
                                v.add(u)
                            }
                        } else {
                            if (i.hasAccessToReportId(324)) {
                                y = j.Us.getUrlById(1691, "__pd=gm_fv&pk=324&ext=vw&o_pk=" + x.options.sectionId);
                                u = new i.Ms.ReportList({
                                    ReportName: "Roster Assignments Due - By Section",
                                    Link: y
                                });
                                v.add(u)
                            }
                            if (i.hasAccessToReportId(82)) {
                                y = j.Us.getUrlById(1691, "__pd=gm_fv&pk=82&ext=vw&o_pk=" + x.options.sectionId);
                                u = new i.Ms.ReportList({
                                    ReportName: "Roster Major Assignments - By Section",
                                    Link: y
                                });
                                v.add(u)
                            }
                            if (i.hasAccessToReportId(444)) {
                                y = j.Us.getUrlById(1691, "__pd=gm_fv&pk=444&ext=vw&sid=" + x.options.sectionId);
                                u = new i.Ms.ReportList({
                                    ReportName: "Submitted Assignments - By Student",
                                    Link: y
                                });
                                v.add(u)
                            }
                            if (i.hasAccessToReportId(412)) {
                                y = j.Us.getUrlById(1691, "__pd=gm_fv&pk=412&ext=vw&sid=" + x.options.sectionId);
                                u = new i.Ms.ReportList({
                                    ReportName: "View Schedule",
                                    Link: y
                                });
                                v.add(u)
                            }
                        }
                        p3.fT(x.template, function(D) {
                            var B = v.length > 0 ? v.toJSON() : false,
                                C = x.options.studentId > 0 ? x.options.studentId : 0;
                            x.$el.html(D({
                                reports: B,
                                studentId: C,
                                filter: p3.Data.LMS.AssignmentCenterfilter,
                                isStudent: s === 2,
                                missingAssignmentInd: t.missingAssignmentInd,
                                showEdit: (s === 3 && w === p3.Data.Context.get("UserInfo").UserId),
                                showAssess: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.ASSESSMENTS),
                                view: p3.Data.LMS.calendarView,
                                iCalFeed: o.get("iCalLink"),
                                protocol: location.protocol,
                                host: location.host,
                                hideRange: true,
                                gridView: true,
                                hideDay: p,
                                hideSettings: r,
                                hideSectionFilter: q,
                                sectionId: x.options.sectionId,
                                showDiscuss: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADEDDISCUSSION),
                                lti: e.Data.LtiConfigSummary.toJSON()
                            }))
                        })
                    }
                })
            } else {
                v.remove(v.at(0));
                if (x.options.assignCenter) {
                    if (i.hasAccessToReportId(261)) {
                        y = j.Us.getUrlById(1691, "__pd=gm_fv&pk=261");
                        u = new i.Ms.ReportList({
                            ReportName: "Assignment Counts - By Section",
                            Link: y
                        });
                        v.add(u)
                    }
                    if (i.hasAccessToReportId(328)) {
                        y = j.Us.getUrlById(1691, "__pd=gm_fv&pk=328");
                        u = new i.Ms.ReportList({
                            ReportName: "Assignments - By Section",
                            Link: y
                        });
                        v.add(u)
                    }
                    if (i.hasAccessToReportId(335)) {
                        y = j.Us.getUrlById(1691, "__pd=gm_fv&pk=335");
                        u = new i.Ms.ReportList({
                            ReportName: "Assignments Due - By Department or Grade",
                            Link: y
                        });
                        v.add(u)
                    }
                    if (i.hasAccessToReportId(80)) {
                        y = j.Us.getUrlById(1691, "__pd=gm_fv&pk=80");
                        u = new i.Ms.ReportList({
                            ReportName: "Roster Assignments",
                            Link: y
                        });
                        v.add(u)
                    }
                    if (i.hasAccessToReportId(215)) {
                        y = j.Us.getUrlById(1691, "pk=215&sid=" + w + "&vid=" + p3.Data.Context.get("UserInfo").UserId + "&ext=vw");
                        u = new i.Ms.ReportList({
                            ReportName: "View Assignment Grades",
                            Link: y
                        });
                        v.add(u)
                    }
                    if (i.hasAccessToReportId(247)) {
                        y = j.Us.getUrlById(1691, "pk=247&sid=" + w + "&vid=" + p3.Data.Context.get("UserInfo").UserId + "&ext=vw");
                        u = new i.Ms.ReportList({
                            ReportName: "View Assignment Grades w/ comments",
                            Link: y
                        });
                        v.add(u)
                    }
                    if (i.hasAccessToReportId(259)) {
                        y = j.Us.getUrlById(1691, "pk=259&ch=1&sid=" + w + "&vid=" + p3.Data.Context.get("UserInfo").UserId + "&ext=vw");
                        u = new i.Ms.ReportList({
                            ReportName: "Cumulative Grades",
                            Link: y
                        });
                        v.add(u)
                    }
                } else {
                    if (i.hasAccessToReportId(324)) {
                        y = j.Us.getUrlById(1691, "__pd=gm_fv&pk=324&ext=vw&o_pk=" + x.options.sectionId);
                        u = new i.Ms.ReportList({
                            ReportName: "Roster Assignments Due - By Section",
                            Link: y
                        });
                        v.add(u)
                    }
                    if (i.hasAccessToReportId(82)) {
                        y = j.Us.getUrlById(1691, "__pd=gm_fv&pk=82&ext=vw&o_pk=" + x.options.sectionId);
                        u = new i.Ms.ReportList({
                            ReportName: "Roster Major Assignments - By Section",
                            Link: y
                        });
                        v.add(u)
                    }
                    if (i.hasAccessToReportId(444)) {
                        y = j.Us.getUrlById(1691, "__pd=gm_fv&pk=444&ext=vw&sid=" + x.options.sectionId);
                        u = new i.Ms.ReportList({
                            ReportName: "Submitted Assignments - By Student",
                            Link: y
                        });
                        v.add(u)
                    }
                    if (i.hasAccessToReportId(412)) {
                        y = j.Us.getUrlById(1691, "__pd=gm_fv&pk=412&ext=vw&sid=" + x.options.sectionId);
                        u = new i.Ms.ReportList({
                            ReportName: "View Schedule",
                            Link: y
                        });
                        v.add(u)
                    }
                }
                p3.fT(x.template, function(B) {
                    var z = v.length > 0 ? v.toJSON() : false,
                        A = x.options.studentId > 0 ? x.options.studentId : 0;
                    x.$el.html(B({
                        reports: z,
                        studentId: A,
                        filter: p3.Data.LMS.AssignmentCenterfilter,
                        isStudent: s === 2,
                        missingAssignmentInd: t.missingAssignmentInd,
                        showEdit: (s === 3 && w === p3.Data.Context.get("UserInfo").UserId),
                        showAssess: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.ASSESSMENTS),
                        view: p3.Data.LMS.calendarView,
                        iCalFeed: o.get("iCalLink"),
                        protocol: location.protocol,
                        host: location.host,
                        hideRange: true,
                        gridView: true,
                        hideDay: p,
                        hideSettings: r,
                        hideSectionFilter: q,
                        sectionId: x.options.sectionId,
                        showDiscuss: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADEDDISCUSSION),
                        lti: e.Data.LtiConfigSummary.toJSON()
                    }))
                })
            }
        }
    });
    a.Vs.PrintCalendar = Bb.View.extend({
        template: "academiccalendar/print.modal.template.html",
        events: {
            "click #btn-print": "printCal",
            "click #print-portrait": "setPortrait",
            "click #print-landscape": "setLandscape",
            "click .print-colors": "toggleColors",
            "click .cal-print-font-size li": "setFontSize"
        },
        initialize: function() {
            var m = this;
            m.calView = $("#calendar-container").fullCalendar("getView")
        },
        render: function(m) {
            var n = this;
            $(m).append(n.el);
            n.renderTemplate()
        },
        renderTemplate: function() {
            var n = this,
                m;
            m = a.Data.fontStyle.substring(a.Data.fontStyle.lastIndexOf("-") + 1);
            p3.fT(n.template, function(o) {
                n.$el.html(o({
                    orientation: a.Data.orientation,
                    fontStyle: a.Data.fontStyle,
                    fontLabel: m
                }));
                n.loadPrintPreview()
            })
        },
        loadPrintPreview: function() {
            var o = this,
                m, n;
            $("#printArea").empty();
            o.frame = $('<iframe id="print-frame" scrolling="no" border="0" frameborder="0" name="print-frame" class="' + a.Data.orientation + '"><html></html></iframe>');
            m = "<title>" + document.title + '</title><link rel="stylesheet" type="text/css" href="/app/src/css/p3.system.css" media="all" title="calStyles"><link rel="stylesheet" type="text/css" href="/app/src/css/p3.onCampus.css" media="all" title="calStyles"><link type="text/css" rel="stylesheet" href="/ftpimages/999/podium/libs/fullcalendar/2.4.0/fullcalendar.academic.css" media="all">';
            n = '<div id="cal-preview-holder" class="' + a.Data.fontStyle + '"><div id="cal-print-view" class="' + a.Data.orientation + ' bnw"></div></div>';
            o.frame.load(function() {
                var p = $(this);
                p.contents().find("head").append(m);
                p.contents().find("body").append(n);
                o.drawCal(this)
            }).appendTo("#printArea")
        },
        drawCal: function(n) {
            var o = this,
                m = $("#print-frame");
            o.printView = m.contents().find("#cal-print-view");
            o.printView.fullCalendar({
                editable: false,
                disableResizing: true,
                defaultDate: o.calView.calendar.getDate(),
                defaultView: o.calView.name,
                height: "auto",
                columnFormat: {
                    basicDay: "dddd"
                },
                events: o.options.calendarEvents,
                eventRender: function(q, p) {
                    var r = p.find(".fc-title").text(),
                        s;
                    if (r.indexOf("<a") > -1) {
                        r = r.substring(0, r.indexOf("<a"))
                    }
                    if (r.indexOf('<div class="btn-group') > -1) {
                        if (r.indexOf('"caret"></span>&nbsp;') > -1) {
                            s = r.substring(r.indexOf('"caret"></span>&nbsp;') + 21);
                            s = s.substring(0, s.indexOf("</button>"))
                        }
                        r = r.substring(0, r.indexOf('<div class="btn-group')) + "<br />" + s
                    }
                    p.find(".fc-title").html(r);
                    p.find(".calendar-title-text").addClass(a.Data.fontStyle)
                },
                eventAfterAllRender: function() {
                    window.setTimeout(function() {
                        n.style.height = 0;
                        n.style.height = n.contentWindow.document.body.scrollHeight + 25 + "px"
                    }, 500);
                    m.contents().find(".fc-center").html("<h2>" + $("#date-display-label").text() + "</h2>")
                }
            })
        },
        setPortrait: function() {
            var m = this;
            a.Data.orientation = "portrait-calendar ";
            m.frame.removeClass().addClass(a.Data.orientation);
            m.printView.removeClass().addClass(a.Data.orientation + " bnw fc fc-ltr");
            m.printView.fullCalendar("rerenderEvents")
        },
        setLandscape: function() {
            var m = this;
            a.Data.orientation = "landscape-calendar ";
            m.frame.removeClass().addClass(a.Data.orientation);
            m.printView.removeClass().addClass(a.Data.orientation + " bnw fc fc-ltr");
            m.printView.fullCalendar("rerenderEvents")
        },
        setFontSize: function(o) {
            var r = this,
                m = $(o.target),
                q = m.attr("class"),
                n = $("#print-frame").contents().find("#cal-preview-holder"),
                p = n.attr("class");
            a.Data.fontStyle = q.substr(0, q.indexOf(" "));
            $("#cal-print-font-size").removeClass(p).addClass(a.Data.fontStyle).html(m.text() + '  <span class="caret"></span>');
            n.removeClass(p).addClass(a.Data.fontStyle);
            r.printView.fullCalendar("rerenderEvents")
        },
        printCal: function() {
            if ($(".ie").length > 0) {
                var m = document.getElementById("print-frame");
                m.contentWindow.document.execCommand("print", false, null)
            } else {
                window.frames["print-frame"].focus();
                window.frames["print-frame"].print()
            }
            return false
        }
    });
    a.Us.InitializeCalendar = function(n) {
        var m = {
            editable: n.canEdit,
            disableResizing: true,
            height: "auto",
            header: {
                left: "",
                center: "title",
                right: ""
            },
            columnFormat: {
                basicDay: "dddd"
            },
            events: (!_.isUndefined(n.events) ? n.events.toJSON() : undefined),
            eventRender: function(p, o) {
                o.find(".fc-title").html(o.find(".fc-title").text())
            },
            viewRender: function(p, o) {
                $(".fc-toolbar").remove();
                a.Us.updateHeaderDisplay(p)
            },
            dayClick: function(q, r, s) {
                if (s.calendar.options.editable) {
                    var o = true,
                        p = new Date();
                    if (s.lastAdd) {
                        if (p.getTime() - s.lastAdd.getTime() < 1000) {
                            o = false
                        }
                    }
                    if (o) {
                        s.lastAdd = p;
                        b.Us.FetchTeacherSections(a.Data.leadSectionId, a.Data.isOwner, a.Data.isManager);
                        b.Us.AddAssignmentView({
                            defaultDate: q.local().toDate()
                        }).on("saveAssignment", function() {
                            setTimeout(function() {
                                $("#calendar-main-view").trigger("updateAssignments")
                            }, 500)
                        })
                    }
                }
            },
            eventClick: function(p, r, s) {
                var q, o;
                if (!(r.target.nodeName === "a" || r.target.nodeName === "A" || r.target.nodeName === "BUTTON" || r.target.nodeName === "button") && p.canEdit) {
                    if (p.assessmentInd) {
                        p3.router().navigate("#assessmentedit/" + p.assignmentId + "/" + p.assignmentIndexId + "/" + (p.assessmentLocked ? "1" : "0"), true)
                    } else {
                        if (p.discussionInd) {
                            o = new b.Ms.Assignment();
                            o.set("AssignmentId", p.assignmentId);
                            o.fetch({
                                async: false,
                                error: function() {
                                    p3.displayError("Error loading assignment")
                                },
                                success: function(u, v) {
                                    var t = b.Us.AddDiscussionView(o, 0);
                                    t.on("saveDiscussion", function() {
                                        setTimeout(function() {
                                            $("#calendar-main-view").trigger("updateAssignments")
                                        }, 500)
                                    })
                                }
                            })
                        } else {
                            q = b.Us.EditAssignmentView(p.assignmentId);
                            if (q) {
                                q.on("saveAssignment", function() {
                                    setTimeout(function() {
                                        $("#calendar-main-view").trigger("updateAssignments")
                                    }, 500)
                                }).on("deleteAssignment", function() {
                                    setTimeout(function() {
                                        $("#calendar-main-view").trigger("updateAssignments")
                                    }, 500)
                                })
                            }
                        }
                    }
                    return false
                }
            },
            eventDragStart: function(o, p, q, r) {
                a.Data.StartDate = o.start.local().toDate()
            },
            eventDrop: function(t, r, x, u, y, z) {
                var w = t.start.local().toDate(),
                    v = t.end ? t.end.toDate() : null,
                    q = {
                        AssignmentId: t.assignmentId,
                        AssignmentIndexId: t.assignmentIndexId,
                        SectionId: t.sectionId,
                        AssignedDate: f.getDateString(w),
                        AssignedTime: t.assignedTime,
                        dayDelta: r.days(),
                        byAssigned: true
                    },
                    s, o, p;
                if (l.isEmptier(v)) {
                    q.DueDate = f.getDateString(w)
                } else {
                    q.DueDate = f.getDateString(v)
                }
                if (!_.isUndefined(t.due) && t.due instanceof Date) {
                    s = t.due;
                    s.setDate(s.getDate() + r.days());
                    q.DueDate = f.getDateString(s)
                } else {
                    if (!_.isUndefined(t.assigned) && t.assigned instanceof Date) {
                        o = t.assigned;
                        o.setDate(o.getDate() + r.days());
                        q.AssignedDate = f.getDateString(o);
                        q.byAssigned = false
                    }
                }
                p3.rV(new a.Vs.ConfirmMoveModal(q), p3.Layout.Containers.Modal, true);
                p3.showModal(p3.Layout.Containers.Modal);
                p = function() {
                    $("#calendar-main-view").trigger("updateAssignments");
                    p3.Layout.Containers.Modal.off("hidden", p)
                };
                p3.Layout.Containers.Modal.on("hidden", p);
                a.Data.StartDate = undefined
            }
        };
        if (_.isUndefined(p3.Data.LMS)) {
            p3.Data.LMS = {}
        }
        if (n.leadSectionId) {
            if (_.isUndefined(p3.Data.LMS.AssignmentCenterDate)) {
                p3.Data.LMS.AssignmentCenterDate = f.localDateTime()
            }
            m.month = p3.Data.LMS.AssignmentCenterDate.getMonth();
            m.year = p3.Data.LMS.AssignmentCenterDate.getFullYear();
            m.date = p3.Data.LMS.AssignmentCenterDate.getDate();
            m.defaultDate = p3.Data.LMS.AssignmentCenterDate
        } else {
            if (_.isUndefined(p3.Data.LMS.saCaldate) || typeof p3.Data.LMS.saCaldate.getMonth !== "function") {
                p3.Data.LMS.saCaldate = f.localDateTime()
            }
            m.month = p3.Data.LMS.saCaldate.getMonth();
            m.year = p3.Data.LMS.saCaldate.getFullYear();
            m.date = p3.Data.LMS.saCaldate.getDate();
            m.defaultDate = p3.Data.LMS.saCaldate
        }
        if (_.isUndefined(p3.Data.LMS.calendarView)) {
            p3.Data.LMS.calendarView = "month"
        }
        if (n.leadSectionId) {
            p3.Data.LMS.previousCalView = p3.Data.LMS.SectionCalendarView
        } else {
            p3.Data.LMS.previousCalView = p3.Data.LMS.calendarView
        }
        if ($(window).width() < 979) {
            p3.Data.LMS.calendarView = "basicDay";
            p3.Data.LMS.sectionCalendarView = "basicDay"
        }
        m.defaultView = p3.Data.LMS.calendarView;
        $("#calendar-container").fullCalendar(m)
    };
    a.Us.updateHeaderDisplay = function(s) {
        var o = s.start.local().toDate(),
            n = s.end.local().toDate(),
            m, p = "",
            r, q;
        switch (s.name) {
            case "basicDay":
                p = f.displayDate(f.getDateString(o), "fullDate");
                q = f.displayDate(f.getDateString(o), "shortMonthDayYear");
                break;
            case "basicWeek":
                m = new Date(n.getTime() - (24 * 60 * 60 * 1000));
                p = f.getDateRangeString(o, m);
                break;
            case "month":
                m = new Date(o.getTime() + (8 * 24 * 60 * 60 * 1000));
                p = f.displayDate(f.getDateString(m), "monthYear");
                break
        }
        $("#date-display-label").html(p);
        $("#small-date-display-label").html(p);
        $("#mobile-date-display-label").html(q);
        r = f.localDateTime();
        if (r > o && r < n) {
            $("#button-today").addClass("active")
        } else {
            $("#button-today").removeClass("active")
        }
        $("#view-buttons .btn-inverseCal").removeClass("active");
        switch (s.name) {
            case "basicWeek":
                $("#week-view").addClass("active");
                break;
            case "month":
                $("#month-view").addClass("active");
                break;
            case "basicDay":
                $("#day-view").addClass("active");
                break
        }
    };
    a.Us.GenerateEventCollection = function(E, G, u, p) {
        var t = new Bbc(),
            x = "#d6d6d6",
            A = "#f3f3f3",
            B = "#c6c4c4",
            n = "#d4f1fa",
            D = "#fbe5e4",
            w = "#dcf3dc",
            y = "#f9ecd9",
            m = "",
            o = "",
            q = "",
            r = "",
            J = "",
            I = "",
            z = false,
            C = p3.Data.Context.getSelectedPersona().Id,
            F = false,
            v, H, s;
        G.each(function(Q) {
            r = "";
            q = "";
            I = "";
            F = false;
            switch (C) {
                case 1:
                    if (Q.get("Major")) {
                        m = x
                    } else {
                        m = A
                    }
                    o = B;
                    I = "<br />";
                    break;
                case 2:
                    var P = true,
                        M = true,
                        S = f.getDate(Q.get("LocalNow")),
                        N = f.getDate(Q.get("DateDue")),
                        K = f.getDate(Q.get("DateAssigned")),
                        R = "",
                        L = "",
                        O;
                    if (Q.get("DropBoxLateTime")) {
                        O = f.getDate(f.getDateString(N) + " " + f.getTimeString(f.getDate(Q.get("DropBoxLateTime"))))
                    } else {
                        O = f.getDate(f.getDateString(N))
                    }
                    z = (S > O);
                    if (Q.get("DropBoxInd") || Q.get("HasGrade") || Q.get("DiscussionInd")) {
                        P = false
                    } else {
                        if (Q.get("AssignmentStatus") == 1) {
                            if (z) {
                                P = false
                            }
                        }
                    }
                    if (Q.get("HasGrade") && !Q.get("DropBoxInd") && !Q.get("AssessmentInd")) {
                        m = w;
                        R = "Graded";
                        L = " label-success btn-success"
                    } else {
                        switch (Q.get("AssignmentStatus")) {
                            case -1:
                                m = n;
                                if (Q.get("AssessmentInd")) {
                                    if (S < K) {
                                        M = false
                                    } else {
                                        R = "Take";
                                        L = " label-info btn-info"
                                    }
                                } else {
                                    if (Q.get("DropBoxInd")) {
                                        I = '<br><a style="width:85px;text-decoration:none;" href="' + e.Us.BuildAssignmentDetailLink(Q.get("AssignmentId"), Q.get("AssignmentIndexId"), null, 0) + '"><span class="label label-info btn-info">Submit</span></a><br />';
                                        F = true
                                    } else {
                                        R = "To Do";
                                        L = " label-info btn-info"
                                    }
                                }
                                break;
                            case 3:
                                R = "Retake";
                                L = " label-info btn-info";
                                m = n;
                                break;
                            case 0:
                            case 6:
                                m = y;
                                if (Q.get("drop_box_ind")) {
                                    I = '<br><a style="width:85px;text-decoration:none;" href="' + e.Us.BuildAssignmentDetailLink(Q.get("AssignmentId"), Q.get("AssignmentIndexId"), null, 0) + '"><span class="label btn-warning">In&nbsp;Progress</span></a><br />';
                                    F = true
                                } else {
                                    R = "In&nbsp;Progress";
                                    L = " label-warning btn-warning"
                                }
                                break;
                            case 1:
                            case 4:
                                m = w;
                                if (Q.get("HasGrade")) {
                                    R = "Graded"
                                } else {
                                    R = "Completed"
                                }
                                L = " label-success btn-success";
                                break;
                            case 2:
                                m = D;
                                R = "Overdue";
                                L = " label-danger btn-danger";
                                break;
                            case 5:
                                I = '<br><span class="label">Upcoming</span><br />';
                                break
                        }
                    }
                    if (Q.get("AssessmentInd")) {
                        switch (Q.get("AssignmentStatus")) {
                            case -1:
                            case 3:
                                if (M) {
                                    I = '<br><a style="width:85px;text-decoration:none;" href="#assessment/' + Q.get("AssignmentId") + "/" + Q.get("AssignmentIndexId") + '/false"><span class="label ' + L + '">' + R + "</span></a><br />"
                                } else {
                                    I = '<br><span class="label">Upcoming</span><br />'
                                }
                                break;
                            case 0:
                                I = '<br><span class="label label-warning btn-warning">Incomplete</span><br />';
                                break;
                            case 1:
                            case 4:
                                if (Q.get("HasGrade")) {
                                    I = '<br><span class="label label-success btn-success">Graded</span><br />'
                                } else {
                                    I = '<br><span class="label label-success btn-success">Completed</span><br />'
                                }
                                break;
                            case 2:
                                I = '<br><span class="label label-warning btn-danger">Overdue</span><br />';
                                break;
                            case 6:
                                I = '<br><a style="width:85px;text-decoration:none;" href="#assessment/' + Q.get("AssignmentId") + "/" + Q.get("AssignmentIndexId") + '/true"><span class="label label-warning btn-warning"> Resume</span></a><br />';
                                break
                        }
                    } else {
                        if (P) {
                            I = '<div class="btn-group assignment-status-container" data-status="' + Q.get("AssignmentStatus") + '" data-indexId="' + Q.get("AssignmentIndexId") + '">';
                            I += '<button style="margin-top:0px;" class="btn btn-default assignment-status-button dropdown-toggle' + L + '" data-toggle="dropdown">';
                            I += ' <span class="caret"></span>&nbsp;' + R + "</button>";
                            I += '<ul class="dropdown-menu assignment-status-dropdown">';
                            if (!z) {
                                I += '<li><a href class="assignment-status-link" data-status="-1">To Do</a></li>'
                            }
                            I += '<li><a href class="assignment-status-link" data-status="0">In Progress</a></li>';
                            I += '<li><a href class="assignment-status-link" data-status="1">Completed</a></li>';
                            I += "</ul></div>"
                        } else {
                            if (I.length === 0) {
                                I = '<br><span class="label' + L + '">' + R + "</span><br />"
                            }
                        }
                    }
                    o = m;
                    break;
                case 3:
                case 5:
                    if (Q.get("GradeBookInd")) {
                        I = '<br><span class="label ';
                        v = Q.get("graded_count");
                        if (v > 0) {
                            if (v == Q.get("num_enrolled")) {
                                m = w;
                                I += 'label-success">'
                            } else {
                                m = y;
                                I += 'label-warning">'
                            }
                        } else {
                            m = D;
                            I += 'label-important label-danger">'
                        }
                        I += v + " of " + Q.get("num_enrolled") + "</span><br />"
                    } else {
                        m = n;
                        I = "<br />"
                    }
                    o = m;
                    break
            }
            if (Q.get("AssessmentInd") && Q.get("AssessmentId") > 0) {
                if (C == 3 || C == 5) {
                    q = '"#assessmentsectiondetail/' + Q.get("AssignmentId") + "/" + Q.get("AssignmentIndexId") + '/0"';
                    r = " <a href=" + q + ">More Details</a>"
                } else {
                    if ((Q.get("HasGrade") || Q.get("ShowReport")) && (Q.get("AssignmentStatus") == 1 || Q.get("AssignmentStatus") == 3 || Q.get("AssignmentStatus") == 4) && !Q.get("AssessmentLocked")) {
                        q = '"#assessmentdetail/' + Q.get("AssignmentId") + "/" + Q.get("AssignmentIndexId") + "/0/" + p3.Data.Context.get("UserInfo").UserId + '/0"';
                        r = " <a href=" + q + ">More Details</a>"
                    }
                }
            } else {
                if (Q.get("DiscussionInd")) {
                    if (C == 3 || C == 5) {
                        q = '"#discussionsectiondetail/' + Q.get("AssignmentId") + "/" + Q.get("AssignmentIndexId") + '/0"';
                        r = " <a href=" + q + ">More Details</a>"
                    } else {
                        if (C == 2) {
                            q = '"#discussiondetail/' + Q.get("AssignmentId") + "/" + Q.get("AssignmentIndexId") + '"';
                            r = " <a href=" + q + ">More Details</a>"
                        }
                    }
                } else {
                    if (!Q.get("AssessmentInd") && !F && ((Q.get("AssignmentLongDescription") != "" && Q.get("AssignmentLongDescription") != null) || Q.get("GradeBookInd") || Q.get("DropBoxInd") || Q.get("HasDownload") || Q.get("HasLink"))) {
                        q = '"' + e.Us.BuildAssignmentDetailLink(Q.get("AssignmentId"), Q.get("AssignmentIndexId"), null, 0) + '"';
                        r = " <a href=" + q + ">More Details</a>"
                    }
                }
            }
            J = '<span class="calendar-title-text">';
            if (Q.get("major")) {
                J += "Major:"
            }
            J += Q.get("AssignmentDescription");
            if (Q.get("AssessmentInd")) {
                J += '<br><span class="calendar-secondary-text">Assessment</span>'
            }
            if (Q.get("DropBoxInd")) {
                J += '<br><span class="calendar-secondary-text">Online Submission</span>'
            }
            if (Q.get("DiscussionInd")) {
                J += '<br><span class="calendar-secondary-text">Discussion</span>'
            }
            J += a.Us.ltiSecondaryText(Q.get("LtiInd"), Q.get("LtiProviderName"), Q.get("LtiConfigInd"), q, p, C);
            switch (u) {
                case 0:
                case 1:
                    J += '<br><span class="calendar-date-text">Due: ' + f.displayDate(Q.get("DateDue"), "shortDayMonthDate") + '</span><br><span class="calendar-secondary-text">Assigned: ' + f.displayDate(Q.get("DateAssigned"), "shortDayMonthDate");
                    break
            }
            J += I + r;
            H = u == 1 ? f.getDate(Q.get("DateDue")) : f.getDate(Q.get("DateAssigned"));
            s = u == 2 ? new Date(new Date(f.getDate(Q.get("DateDue"))).getTime() + 86400000) : "";
            t.add({
                assignmentId: Q.get("AssignmentId"),
                assignmentIndexId: Q.get("AssignmentIndexId"),
                title: J,
                due: u == 0 ? f.getDate(Q.get("DateDue")) : "",
                assigned: u == 1 ? f.getDate(Q.get("DateAssigned")) : "",
                assignedTime: Q.get("AssignmentTime"),
                start: H,
                end: s,
                canEdit: p,
                backgroundColor: m,
                borderColor: o,
                assessmentInd: Q.get("AssessmentInd"),
                assessmentId: Q.get("AssessmentId"),
                assessmentLocked: Q.get("AssessmentLocked"),
                sectionId: E,
                discussionInd: Q.get("DiscussionInd"),
                allDay: true
            })
        });
        return t
    };
    a.Us.GenerateCenterEventCollection = function(G, u, p) {
        var t = new Bbc(),
            y = "#d6d6d6",
            B = "#f3f3f3",
            C = "#c6c4c4",
            n = "#d4f1fa",
            E = "#fbe5e4",
            w = "#dcf3dc",
            z = "#f9ecd9",
            m = "",
            o = "",
            q = "",
            r = "",
            J = "",
            I = "",
            A = false,
            D = p3.Data.Context.getSelectedPersona().Id,
            F = false,
            v, x, H, s;
        G.each(function(Q) {
            q = "";
            r = "";
            I = "";
            F = false;
            switch (D) {
                case 1:
                    if (Q.get("major")) {
                        m = y
                    } else {
                        m = B
                    }
                    o = C;
                    I = "<br />";
                    break;
                case 2:
                    var P = true,
                        M = true,
                        S = f.getDate(Q.get("local_now")),
                        N = f.getDate(Q.get("date_due")),
                        K = f.getDate(Q.get("assess_assigned")),
                        R = "",
                        L = "",
                        O;
                    if (Q.get("drop_box_late_time")) {
                        O = f.getDate(f.getDateString(N) + " " + f.getTimeString(f.getDate(Q.get("drop_box_late_time"))))
                    } else {
                        O = f.getDate(f.getDateString(N))
                    }
                    A = (S > O);
                    if (Q.get("drop_box_ind") || Q.get("has_grade") || Q.get("discussion_ind")) {
                        P = false
                    } else {
                        if (Q.get("assignment_status") == 1) {
                            if (A) {
                                P = false
                            }
                        }
                    }
                    if (Q.get("has_grade") && !Q.get("drop_box_ind") && !Q.get("assessment_ind")) {
                        m = w;
                        R = "Graded";
                        L = " label-success btn-success"
                    } else {
                        switch (Q.get("assignment_status")) {
                            case -1:
                                m = n;
                                if (Q.get("assessment_ind")) {
                                    if (S < K) {
                                        M = false
                                    } else {
                                        R = "Take";
                                        L = " label-info btn-info"
                                    }
                                } else {
                                    if (Q.get("drop_box_ind")) {
                                        I = '<br><a style="width:85px;text-decoration:none;" href="' + e.Us.BuildAssignmentDetailLink(Q.get("assignment_id"), Q.get("assignment_index_id"), null, 0) + '"><span class="label label-info btn-info">Submit</span></a><br />';
                                        F = true
                                    } else {
                                        R = "To Do";
                                        L = " label-info btn-info"
                                    }
                                }
                                break;
                            case 3:
                                R = "Retake";
                                L = " label-info btn-info";
                                m = n;
                                break;
                            case 0:
                            case 6:
                                m = z;
                                if (Q.get("drop_box_ind")) {
                                    I = '<br><a style="width:85px;text-decoration:none;" href="' + e.Us.BuildAssignmentDetailLink(Q.get("assignment_id"), Q.get("assignment_index_id"), null, 0) + '"><span class="label btn-warning">In&nbsp;Progress</span></a><br />';
                                    F = true
                                } else {
                                    R = "In&nbsp;Progress";
                                    L = " label-warning btn-warning"
                                }
                                break;
                            case 1:
                            case 4:
                                m = w;
                                if (Q.get("has_grade")) {
                                    R = "Graded"
                                } else {
                                    R = "Completed"
                                }
                                L = " label-success btn-success";
                                break;
                            case 2:
                                m = E;
                                R = "Overdue";
                                L = " label-danger btn-danger";
                                break;
                            case 5:
                                m = n;
                                I = '<br><span class="label">Upcoming</span><br />';
                                break
                        }
                    }
                    if (Q.get("assessment_ind")) {
                        switch (Q.get("assignment_status")) {
                            case -1:
                            case 3:
                                if (M) {
                                    I = '<br><a style="width:85px;text-decoration:none;" href="#assessment/' + Q.get("assignment_id") + "/" + Q.get("assignment_index_id") + '/false"><span class="label ' + L + '">' + R + "</span></a><br />"
                                } else {
                                    I = '<br><span class="label">Upcoming</span><br />'
                                }
                                break;
                            case 0:
                                I = '<br><span class="label label-warning btn-warning">Incomplete</span><br />';
                                break;
                            case 1:
                            case 4:
                                if (Q.get("has_grade")) {
                                    I = '<br><span class="label label-success btn-success">Graded</span><br />'
                                } else {
                                    I = '<br><span class="label label-success btn-success">Completed</span><br />'
                                }
                                break;
                            case 2:
                                I = '<br><span class="label label-danger btn-danger">Overdue</span><br />';
                                break;
                            case 6:
                                I = '<br><a style="width:85px;text-decoration:none;" href="#assessment/' + Q.get("assignment_id") + "/" + Q.get("assignment_index_id") + '/true"><span class="label label-warning btn-warning">Resume</span></a><br />';
                                break
                        }
                    } else {
                        if (P) {
                            I = '<div class="btn-group assignment-status-container" data-status="' + Q.get("assignment_status") + '" data-indexId="' + Q.get("assignment_index_id") + '">';
                            I += '<button style="margin-top:0px;" class="btn btn-default assignment-status-button dropdown-toggle' + L + '" data-toggle="dropdown">';
                            I += ' <span class="caret"></span>&nbsp;' + R + "</button>";
                            I += '<ul class="dropdown-menu assignment-status-dropdown">';
                            if (!A) {
                                I += '<li><a href class="assignment-status-link" data-status="-1">To Do</a></li>'
                            }
                            I += '<li><a href class="assignment-status-link" data-status="0">In Progress</a></li>';
                            I += '<li><a href class="assignment-status-link" data-status="1">Completed</a></li>';
                            I += "</ul></div>"
                        } else {
                            if (I.length == 0) {
                                I = '<br><span class="label' + L + '">' + R + "</span><br />"
                            }
                        }
                    }
                    o = m;
                    break;
                case 3:
                case 5:
                    if (Q.get("inc_grade_book")) {
                        I = '<br><span style="padding:0px 4px;" class="label ';
                        v = Q.get("graded_count");
                        if (v > 0) {
                            if (v == Q.get("enroll_count")) {
                                m = w;
                                I += 'label-success">'
                            } else {
                                m = z;
                                I += 'label-warning">'
                            }
                        } else {
                            m = E;
                            I += 'label-important label-danger">'
                        }
                        I += v + " of " + Q.get("enroll_count") + "</span><br />"
                    } else {
                        m = n;
                        I = "<br />"
                    }
                    o = m;
                    break
            }
            if (Q.get("assessment_ind") && Q.get("assessment_id") > 0) {
                if (D == 3 || D == 5) {
                    q = '"#assessmentsectiondetail/' + Q.get("assignment_id") + "/" + Q.get("assignment_index_id") + '/0"';
                    r = " <a href=" + q + ">More Details</a>"
                } else {
                    if ((Q.get("has_grade") || Q.get("show_report")) && (Q.get("assignment_status") == 1 || Q.get("assignment_status") == 3 || Q.get("assignment_status") == 4) && !Q.get("assessment_locked")) {
                        q = '"#assessmentdetail/' + Q.get("assignment_id") + "/" + Q.get("assignment_index_id") + "/0/" + p3.Data.Context.get("UserInfo").UserId + '/0"';
                        r = " <a href=" + q + ">More Details</a>"
                    }
                }
            } else {
                if (Q.get("discussion_ind")) {
                    if (D == 3 || D == 5) {
                        q = '"#discussionsectiondetail/' + Q.get("assignment_id") + "/" + Q.get("assignment_index_id") + '/0"';
                        r = " <a href=" + q + ">More Details</a>"
                    } else {
                        if (D == 2) {
                            q = '"#discussiondetail/' + Q.get("assignment_id") + "/" + Q.get("assignment_index_id") + '"';
                            r = " <a href=" + q + ">More Details</a>"
                        } else {
                            if (D == 1) {
                                q = '"' + e.Us.BuildAssignmentDetailLink(Q.get("assignment_id"), Q.get("assignment_index_id"), null, 0) + '"';
                                r = " <a href=" + q + ">More Details</a>"
                            }
                        }
                    }
                } else {
                    if (!Q.get("assessment_ind") && !F && ((Q.get("long_description") !== "" && Q.get("long_description") !== null) || Q.get("inc_grade_book") || Q.get("drop_box_ind") || Q.get("has_download") || Q.get("has_link"))) {
                        q = '"' + e.Us.BuildAssignmentDetailLink(Q.get("assignment_id"), Q.get("assignment_index_id"), null, 0) + '"';
                        r = " <a href=" + q + ">More Details</a>"
                    }
                }
            }
            J = '<span class="calendar-title-text">';
            if (Q.get("major")) {
                J += "Major:"
            }
            J += Q.get("short_description") + '</span><br><span class="calendar-secondary-text">' + Q.get("groupname") + "</span>";
            if (Q.get("assessment_ind")) {
                J += '<br><span class="calendar-secondary-text">Assessment</span>'
            }
            if (Q.get("drop_box_ind")) {
                J += '<br><span class="calendar-secondary-text">Online Submission</span>'
            }
            if (Q.get("discussion_ind")) {
                J += '<br><span class="calendar-secondary-text">Discussion</span>'
            }
            J += a.Us.ltiSecondaryText(Q.get("lti_ind"), Q.get("lti_provider_name"), Q.get("lti_config_ind"), q, p, D);
            switch (u) {
                case 0:
                case 1:
                    J += '<br><span class="calendar-date-text">Due: ' + f.displayDate(Q.get("date_due"), "shortDayMonthDate") + '</span><br><span class="calendar-secondary-text">Assigned: ' + f.displayDate(Q.get("date_assigned"), "shortDayMonthDate");
                    break
            }
            J += I + r;
            H = u == 1 ? f.getDate(Q.get("date_due")) : f.getDate(Q.get("date_assigned"));
            s = u == 2 ? new Date(f.getDate(Q.get("date_due")).getTime() + 86400000) : "";
            x = {
                assignmentId: Q.get("assignment_id"),
                assignmentIndexId: Q.get("assignment_index_id"),
                sectionId: Q.get("section_id"),
                title: J,
                sectionName: Q.get("groupname"),
                due: u == 0 ? f.getDate(Q.get("date_due")) : "",
                assigned: u == 1 ? f.getDate(Q.get("date_assigned")) : "",
                assignedTime: Q.get("AssignmentTime"),
                start: H,
                end: s,
                canEdit: p,
                backgroundColor: m,
                borderColor: o,
                assessmentInd: Q.get("assessment_ind"),
                assessmentId: Q.get("assessment_id"),
                assessmentLocked: Q.get("assessment_locked"),
                discussionInd: Q.get("discussion_ind"),
                allDay: true
            };
            t.add(x)
        });
        return t
    };
    a.Us.getSectionStatusFilterList = function() {
        var n = "",
            o = false,
            m;
        if (p3.Data.LMS && p3.Data.LMS.sectionFilterStatus) {
            for (m = 0; m < p3.Data.LMS.sectionFilterStatus.length; m++) {
                if (p3.Data.LMS.sectionFilterStatus[m].Selected) {
                    if (n.length > 0) {
                        n += ","
                    }
                    n += p3.Data.LMS.sectionFilterStatus[m].Status
                } else {
                    o = true
                }
            }
            if (!o) {
                n = ""
            }
        }
        return n
    };
    a.Us.ltiSecondaryText = function(p, q, o, n, m, r) {
        var s = "";
        if (p || false) {
            if (!(o || false) && (m || false) && (r || 0) === 3) {
                if (n !== null && n.length > 0) {
                    s = '<br><span class="calendar-secondary-text"><i class="p3icon-warning"></i>&nbsp;' + q + "<a href=" + n + "> Setup</a></span>"
                } else {
                    s = '<br><span class="calendar-secondary-text"><i class="p3icon-warning"></i>&nbsp;' + q + "</span>"
                }
            } else {
                s = '<br><span class="calendar-secondary-text">' + q + "</span>"
            }
        }
        return s
    }
}(p3.module("LMS/shared/academiccalendar")));
(function(b) {
    var h = p3.module("shared/task"),
        c = p3.module("LMS/advisorybulletinboard"),
        f = p3.module("LMS/roster"),
        e = p3.module("LMS/groupPageEdit"),
        d = p3.module("grading"),
        g = p3.module("schedule"),
        a = p3.module("courserequestadvisorworklist"),
        i = p3.module("LMS/topic");
    b.Cs.Section = Bbc.extend({
        initialize: function(j, k) {
            this.sectionId = k.sectionId || 0
        },
        url: function() {
            return aP + "datadirect/SectionInfoView/?format=json&sectionId=" + this.sectionId + "&associationId=1"
        }
    });
    b.Pages = [{
        Id: 1,
        ContentId: 433,
        Label: "Bulletin Board",
        RoutePage: "bulletinboard",
        IconClass: "p3icon-page",
        Display: function(j) {
            var k = new e.Vs.LayoutView({
                sectionId: b.Data.sectionId,
                leadSectionId: b.Data.leadSectionId,
                content: b.Data.contentTypes,
                userHasFullAccess: b.Data.userHasFullAccess,
                isOwner: b.Data.IsOwner,
                isManager: b.Data.isManager,
                associationId: 9,
                contextLabelId: 22,
                preview: false,
                layoutId: b.Data.layoutId,
                pendingInd: false
            });
            p3.rV(k, j, true)
        },
        Active: true
    }, {
        Id: 2,
        ContentId: 386,
        Label: "Topics",
        RoutePage: "topics",
        IconClass: "p3icon-topics",
        HTMLID: "topics-btn",
        LinkId: "topics-link",
        Display: function(j) {
            p3.rV(new i.Vs.TopicManageView({
                sectionId: b.Data.sectionId,
                leadSectionId: b.Data.leadSectionId,
                active: true,
                future: false,
                expired: false,
                userHasFullAccess: b.Data.userHasFullAccess,
                isOwner: b.Data.IsOwner,
                isManager: b.Data.isManager,
                content: b.Data.contentTypes,
                levelNum: b.Data.levelNum || -1,
                durationId: b.Data.durationId,
                schoolYearLabel: b.Data.schoolYear,
                contextLabelId: 22
            }), j, true)
        },
        Active: false
    }, {
        Id: 5,
        ContentId: 87,
        Label: "Schedule",
        RoutePage: "schedule",
        IconClass: "p3icon-schedule",
        Display: function(j) {
            p3.rV(new g.Vs.MySchedule({
                data: aP + "DataDirect/ScheduleListSection/?format=json&sectionId=" + b.Data.sectionId + "&viewerPersonaId=" + p3.Data.Context.getSelectedPersona().Id,
                scheduleSectionId: b.Data.sectionId
            }), j, false)
        },
        Active: false
    }, {
        Id: 6,
        ContentId: 120,
        Label: "Grading",
        RoutePage: "grading",
        IconClass: "p3icon-grading",
        Display: function(j) {
            p3.rV(new d.Vs.LayoutView({
                sectionId: b.Data.leadSectionId,
                nonLeadsectionId: b.Data.sectionId
            }), j, true)
        },
        Active: false
    }, {
        Id: 7,
        ContentId: 111,
        Label: "Course Requests",
        RoutePage: "courserequests",
        IconClass: "p3icon-courseRequest",
        Display: function(j) {
            p3.rV(new a.Vs.LayoutView({
                sectionId: b.Data.leadSectionId
            }), j, true)
        },
        Active: false
    }, {
        Id: 8,
        ContentId: 434,
        Label: "Advisees",
        RoutePage: "advisees",
        IconClass: "p3icon-roster",
        Display: function(j) {
            p3.rV(new f.Vs.RosterView({
                sectionId: b.Data.sectionId,
                leadSectionId: b.Data.leadSectionId,
                durationId: b.Data.durationId,
                associationId: 9,
                enableSearch: true,
                isOwner: b.Data.IsOwner
            }), j, true)
        },
        Active: false
    }];
    b.Data = {};
    b.Ms.Section = Bbm.extend({
        url: function() {
            return ""
        }
    });
    b.Cs.Section = Bbc.extend({
        model: b.Ms.Section,
        initialize: function(j, k) {
            this.sectionId = k.sectionId || 0
        },
        url: function() {
            return aP + "datadirect/SectionInfoView/?format=json&sectionId=" + this.sectionId + "&associationId=9"
        }
    });
    b.Ms.Content = Bbm.extend({
        idAttribute: "ContentId",
        url: function() {
            return ""
        }
    });
    b.Cs.Content = Bbc.extend({
        model: b.Ms.Content,
        initialize: function(j, k) {
            this.sectionId = k.sectionId || 0;
            this.leadSectionId = k.leadSectionId || 0
        },
        url: function() {
            return aP + "datadirect/GroupPossibleContentGet/?format=json&leadSectionId=" + this.leadSectionId
        }
    });
    b.Data = {};
    b.Data.leadSectionId = 0;
    b.Data.durationId = 0;
    b.Data.sectionId = 0;
    b.Data.contentTypes = null;
    b.Data.MainViewRendered = false;
    b.Data.RenderedSectionId = 0;
    b.Data.teacherId = 0;
    b.Vs.MainClassView = Bb.View.extend({
        template: "GroupPage/grouppage.mainview.template.html",
        initialize: function(j) {
            this.Containers = {};
            if (j) {
                b.Data.sectionId = b.Data.RenderedSectionId = this.SectionId = j.SectionId
            } else {
                b.Data.sectionId = b.Data.RenderedSectionId = this.SectionId = 0
            }
            b.Data.MainViewRendered = true
        },
        dispose: function() {
            b.Data.MainViewRendered = false
        },
        render: function(j) {
            var k = this;
            p3.fT(k.template, function(m) {
                k.$el.html(m({}));
                $(j).html(k.el);
                k.Containers.Navigation = $("#grouppagenavmenu");
                k.Containers.MainContent = $("#grouppagemaincontainer");
                var l = new b.Cs.Section({}, {
                    sectionId: k.SectionId
                });
                p3.rV(new b.Vs.NavigationView({
                    ParentView: k,
                    collection: l
                }), k.Containers.Navigation, false);
                l.fetch({
                    error: function() {
                        p3.displayError("Error loading section information")
                    }
                })
            })
        }
    });
    b.Vs.NavigationView = Bb.View.extend({
        template: "Advisory/navigationmenu.template.html",
        initialize: function(j) {
            this.collection.bind("reset change", this.renderTemplate, this);
            this.Containers = {};
            if (j) {
                this.ParentView = j.ParentView
            }
            this.enableScrollNav()
        },
        dispose: function() {
            this.disableScrollNav()
        },
        renderTemplate: function() {
            var D = this,
                B, q, r, j, A, o, x, w, v, p, C, t, n, s, u, m, z, l = false,
                k, y = [];
            m = new Bbc(D.collection.filter(function(E) {
                return E.get("Current") === 1
            }));
            D.collection.each(function(E) {
                if ((E.get("Current") === 1) || ((m.length < 1) && (E.get("LeadSectionId") === E.get("Id")))) {
                    B = E.get("Teacher");
                    q = E.get("GroupName");
                    r = E.get("Identifier");
                    j = E.get("Block");
                    A = E.get("Room");
                    o = E.get("Duration");
                    p = E.get("DurationId");
                    n = E.get("Description");
                    x = E.get("Level");
                    if (E.get("Length") === 1) {
                        w = "1 Term"
                    } else {
                        w = E.get("Length") + " Terms"
                    }
                    B = E.get("Teacher");
                    v = E.get("LeadSectionId");
                    t = E.get("IsOwner");
                    s = E.get("IsManager");
                    C = E.get("TeacherId");
                    u = E.get("LayoutId")
                }
            });
            b.Data.IsOwner = t;
            b.Data.isManager = s;
            b.Data.leadSectionId = v;
            b.Data.durationId = p;
            b.Data.teacherId = C;
            z = p3.Data.Context.getSelectedPersona().Id;
            b.Data.userHasFullAccess = (z === 3 && b.Data.IsOwner) || b.Data.isManager;
            b.Data.layoutId = u;
            if (B !== "" || r || j || A || o || p || n || x || w) {
                l = true
            }
            k = new b.Cs.Content({}, {
                sectionId: b.Data.sectionId,
                leadSectionId: b.Data.leadSectionId
            });
            k.fetch({
                error: function() {
                    p3.displayError("Error loading available content")
                },
                success: function() {
                    b.Data.contentTypes = k;
                    k.each(function(G) {
                        var F = G.get("ContentId"),
                            I, H = true,
                            J;
                        I = _.find(b.Pages, function(K) {
                            return K.ContentId === F
                        });
                        H = G.get("ShowContentType");
                        if (H & F === 386) {
                            H = b.Data.userHasFullAccess || G.get("EditorAccess");
                            if (!H) {
                                J = new i.Cs.Topic({}, {
                                    sectionId: 0,
                                    leadSectionId: b.Data.leadSectionId,
                                    active: true,
                                    future: false,
                                    expired: false
                                });
                                J.fetch({
                                    async: false,
                                    success: function() {
                                        if (J.length > 0) {
                                            H = true
                                        }
                                    },
                                    error: function() {
                                        p3.displayError("Error loading topics")
                                    }
                                })
                            }
                        }
                        if (I && H) {
                            y.push({
                                sort: I.Id,
                                title: I.Label,
                                iconClass: I.IconClass,
                                status: I.Active ? "active" : "inactive",
                                link: h.Us.getUrlById(53063, b.Data.sectionId + "/" + I.RoutePage),
                                pId: I.Id
                            });
                            I.Enabled = true
                        } else {
                            if (I) {
                                I.Enabled = false
                            }
                        }
                    });
                    y = _.sortBy(y, "sort");
                    p3.fT(D.template, function(F) {
                        D.$el.html(F({
                            Info: l,
                            Teacher: B,
                            GroupName: q,
                            Identifier: r,
                            Block: j,
                            Room: A,
                            Duration: o,
                            Level: x,
                            Length: w,
                            Description: n,
                            navigationItems: y
                        }))
                    });
                    var E = _.find(b.Pages, function(F) {
                        return F.Active
                    });
                    if (E && E.Enabled) {
                        E.Display($("#grouppagemaincontainer"))
                    } else {
                        p3.rV(new c.Vs.ClassPageLayoutView({
                            sectionId: 0,
                            leadSectionId: k.leadSectionId,
                            content: k,
                            teacherId: C
                        }), $("#grouppagemaincontainer"), false)
                    }
                }
            });
            return this
        },
        events: {
            "click #section-description-toggle": "toggleDescription",
            "click [data-pid]": "switchTab"
        },
        render: function(j) {
            $(j).append(this.el);
            return this
        },
        toggleDescription: function(k) {
            var j = $("#section-description-content");
            if (j && j.filter(":visible").length) {
                j.hide(400)
            } else {
                j.show(400)
            }
            return false
        },
        switchTab: function(j) {
            if ($(j.currentTarget).attr("data-pid") === "4") {
                _.find(b.Pages, function(k) {
                    return k.Id === 4
                }).Display();
                return false
            }
        },
        enableScrollNav: function(l) {
            var k = $(document),
                j = $(".subnavbar"),
                m = j.length && j.offset().top - 120;

            function n() {
                if (j.length === 0) {
                    j = $(".subnavbar");
                    m = j.length && j.offset().top - 120
                }
                var p = k.scrollTop(),
                    o = j.hasClass("subnavbar-fixed");
                if (p >= m && !o) {
                    j.addClass("subnavbar-fixed")
                } else {
                    if (p <= m && o) {
                        j.removeClass("subnavbar-fixed")
                    }
                }
            }
            k.on("scroll", n)
        },
        disableScrollNav: function(k) {
            var j = $(document);
            j.off("scroll")
        }
    });
    b.Us.LoadPage = function(j, l) {
        b.Data.studentId = undefined;
        p3.loadingIcon("#grouppagemaincontainer");
        var k;
        _.each(b.Pages, function(m) {
            if (m.RoutePage.toLowerCase() === l.toLowerCase()) {
                m.Active = true;
                k = m
            } else {
                m.Active = false
            }
        });
        if (!b.Data.MainViewRendered || b.Data.RenderedSectionId !== j) {
            p3.renderMainPage(new b.Vs.MainClassView({
                SectionId: j
            }))
        } else {
            if (k && k.Enabled) {
                k.Display($("#grouppagemaincontainer"));
                b.Us.SwitchTabs(k)
            }
        }
    };
    b.Us.SwitchTabs = function(k) {
        var j = (p3.Config.uiVersion === 1) ? $(".nav-pills").children() : $(".nav-tabs").children();
        $.each(j, function() {
            var l = $(this);
            if (l.data("pid") === k.Id) {
                l.removeClass("inactive");
                l.addClass("active")
            } else {
                if (l.hasClass("active")) {
                    l.removeClass("active");
                    l.addClass("inactive")
                }
            }
        })
    };
    p3.router().route("advisorypage/:id/:page", "advisorypage", b.Us.LoadPage)
}(p3.module("advisorypage")));
(function(c) {
    var l = p3.module("shared/task"),
        i = p3.Us.Enum,
        k = p3.module("report"),
        b = p3.module("LMS/assignment"),
        h = p3.Us.DateTime,
        j = p3.module("shared/feeds"),
        a = p3.module("LMS/shared/academiccalendar"),
        f = p3.Us.Culture,
        g = p3.module("shared/datepicker"),
        e = p3.module("LMS/Shared/AssignmentTools"),
        d = p3.module("lms/assignmentoptions");
    c.Ms.AssignmentStatusUpdate = Bbm.extend({
        url: function() {
            return aP + "assignment2/assignmentstatusupdate/?format=json&assignmentIndexId=" + this.get("assignmentIndexId") + "&assignmentStatus=" + this.get("assignmentStatus")
        }
    });
    c.Ms.SaveSettings = Bbm.extend({
        urlRoot: "assignment2/AssignmentSettingsSave"
    });
    c.Cs.Assignments = Bbc.extend({
        url: function() {
            return aP + "DataDirect/AssignmentCenterAssignments/?format=json"
        },
        filters: undefined,
        comparator: function(m) {
            return m.get("groupname")
        },
        changeSort: function(m) {
            if (!_.isUndefined(this.filters)) {
                this.comparator = this.filters[m]
            }
        }
    });
    c.Data = {};
    c.Data.Assignments = new c.Cs.Assignments();
    c.Data.Assignments.filters = {
        _statusPrepHelper: function(m, n) {
            var s = {
                    red: 0,
                    blue: 1,
                    orange: 2,
                    green: 3
                },
                t = m.get("assignment_status"),
                u = n.get("assignment_status"),
                o = "",
                p = "",
                q = -1,
                r = -1;
            switch (t) {
                case -1:
                    if (m.get("assessment_ind")) {
                        o = "Take";
                        q = s.blue
                    } else {
                        o = m.get("drop_box_ind") ? "Submit" : "To Do";
                        q = s.blue
                    }
                    break;
                case 0:
                    o = "In&nbsp;Progress";
                    q = s.orange;
                    break;
                case 1:
                    o = m.get("has_grade") ? "Graded" : "Completed";
                    q = s.green;
                    break;
                case 2:
                    o = "Overdue";
                    q = s.red;
                    break;
                case 3:
                    o = "Retake";
                    q = s.blue;
                    break;
                case 4:
                    o = "Graded";
                    q = s.green;
                    break
            }
            switch (u) {
                case -1:
                    if (n.get("assessment_ind")) {
                        p = "Take";
                        r = s.blue
                    } else {
                        p = n.get("drop_box_ind") ? "Submit" : "To Do";
                        r = s.blue
                    }
                    break;
                case 0:
                    p = "In&nbsp;Progress";
                    r = s.orange;
                    break;
                case 1:
                    p = n.get("has_grade") ? "Graded" : "Completed";
                    r = s.green;
                    break;
                case 2:
                    p = "Overdue";
                    r = s.red;
                    break;
                case 3:
                    p = "Retake";
                    r = s.blue;
                    break;
                case 4:
                    p = "Graded";
                    r = s.green;
                    break
            }
            return {
                n1: o,
                n2: p,
                p1: q,
                p2: r
            }
        },
        groupname: function(o, p) {
            var m = o.get("groupname") || "",
                n = p.get("groupname") || "";
            return m < n ? -1 : m > n ? 1 : 0
        },
        assignment_id: function(m) {
            return m.get("assignment_id")
        },
        short_description: function(o, p) {
            var m = o.get("short_description") || "",
                n = p.get("short_description") || "";
            return m < n ? -1 : m > n ? 1 : 0
        },
        date_assigned: function(m) {
            return f.getDate(m.get("date_assigned")).getTime()
        },
        date_due: function(m) {
            return f.getDate(m.get("date_due")).getTime()
        },
        assignment_index_id: function(m) {
            return m.get("assignment_index_id")
        },
        assignment_type: function(o, p) {
            var m = o.get("assignment_type") || "",
                n = p.get("assignment_type") || "";
            return m < n ? -1 : m > n ? 1 : 0
        },
        graded_count: function(m) {
            if (!m.get("inc_grade_book") || m.get("enroll_count") == 0) {
                return -1
            }
            return (m.get("graded_count") / m.get("enroll_count")) * 100
        },
        assignment_status: function(m, n) {
            var o = this.filters._statusPrepHelper(m, n),
                p;
            if (o.p1 === o.p2) {
                p = o.n1 < o.n2 ? -1 : o.n1 > o.n2 ? 1 : 0
            } else {
                p = o.p1 < o.p2 ? -1 : o.p1 > o.p2 ? 1 : 0
            }
            return p
        },
        groupname_invert: function(o, p) {
            var m = o.get("groupname") || "",
                n = p.get("groupname") || "";
            return m < n ? 1 : m > n ? -1 : 0
        },
        assignment_id_invert: function(m) {
            return -m.get("assignment_id")
        },
        short_description_invert: function(o, p) {
            var m = o.get("short_description") || "",
                n = p.get("short_description") || "";
            return m < n ? 1 : m > n ? -1 : 0
        },
        date_assigned_invert: function(m) {
            return -f.getDate(m.get("date_assigned")).getTime()
        },
        date_due_invert: function(m) {
            return -f.getDate(m.get("date_due")).getTime()
        },
        assignment_index_id_invert: function(m) {
            return -m.get("assignment_index_id")
        },
        assignment_type_invert: function(o, p) {
            var m = o.get("assignment_type") || "",
                n = p.get("assignment_type") || "";
            return m < n ? 1 : m > n ? -1 : 0
        },
        graded_count_invert: function(m) {
            if (!m.get("inc_grade_book") || m.get("enroll_count") == 0) {
                return 1
            }
            return -((m.get("graded_count") / m.get("enroll_count")) * 100)
        },
        assignment_status_invert: function(m, n) {
            var o = this.filters._statusPrepHelper(m, n),
                p;
            if (o.p1 === o.p2) {
                p = o.n1 < o.n2 ? 1 : o.n1 > o.n2 ? -1 : 0
            } else {
                p = o.p1 < o.p2 ? 1 : o.p1 > o.p2 ? -1 : 0
            }
            return p
        }
    };
    c.Vs.LayoutView = Bb.View.extend({
        template: "assignmentcenter/assignmentcenter.layout.template.html",
        id: "assignment-center",
        className: "pill-pane",
        events: {},
        initialize: function(m) {
            this.containerName = m.containerName && m.containerName.length > 0 ? m.containerName : "Assignments"
        },
        render: function(m) {
            $(m).append(this.el);
            var n = this;
            p3.fT(n.template, function(q) {
                n.$el.html(q({
                    printMode: n.options.print,
                    containerName: n.containerName && n.containerName.length > 0 ? n.containerName : "Assignments"
                }));
                if (n.options.print && p3.Data.LMS.AssignmentCenterSort && p3.Data.LMS.AssignmentCenterSort.length > 0) {
                    c.Data.Assignments.changeSort(p3.Data.LMS.AssignmentCenterSort)
                }
                var o = new c.Vs.ContentView({
                        studentId: n.options.studentId,
                        print: n.options.print
                    }),
                    p = new c.Vs.HeaderView({
                        studentId: n.options.studentId,
                        print: n.options.print
                    });
                p3.rV(o, $("#assignment-center-content-view"), false);
                p3.rV(p, $("#assignment-center-header-view"), false)
            })
        }
    });
    c.Vs.ContentView = Bb.View.extend({
        template: "assignmentcenter/assignmentcenter.content.template.html",
        events: {},
        render: function(m) {
            $(m).append(this.el);
            var n = this;
            p3.fT(n.template, function(p) {
                n.$el.html(p({}));
                var o = new c.Vs.AssignmentListView({
                    studentId: n.options.studentId,
                    print: n.options.print
                });
                p3.rV(o, $("#assignment-center-list-view"), false)
            })
        },
        listRefresh: function(m) {
            var n = jQuery.Event("listRefresh");
            n.date = m;
            $("#assignment-center-assignment-items").trigger(n)
        }
    });
    c.Vs.HeaderView = Bb.View.extend({
        template: "assignmentcenter/assignmentcenter.header.template.html",
        events: {
            "click .assignment-calendar-view": "showCalendar",
            "click .assignmentDisplayTypeFilter": "updateFilter",
            "click #lti-config-menu": "showLtiConfigList",
            "click #lti-config-btn": "showLtiConfigList",
            "click #add-assignment-btn": "addAssignment",
            "click #add-assignment-menu": "addAssignment",
            "click #add-assessment-btn": "addAssessment",
            "click #add-assessment-menu": "addAssessment",
            "click #add-discuss-btn": "addDiscussion",
            "click #add-discuss-menu": "addDiscussion",
            "click #settingsButton": "editSettings",
            "click #settings-menu": "editSettings",
            "click #filter-teacher-sections": "showSectionFilter",
            "click #filter-student-sections": "showSectionFilter",
            "click #filter-menu": "showSectionFilter",
            "click #filter-status": "showStatusFilter",
            "click #missing-assignment": "showMissingAssignmentList",
            "click #missing-assignment-menu": "showMissingAssignmentList",
            "click #filter-status-menu": "showStatusFilter",
            "click #previous-button": "movePrevious",
            "click #mobile-previous-button": "movePrevious",
            "click #next-button": "moveNext",
            "click #mobile-next-button": "moveNext",
            "click #button-today": "goToToday",
            "click #today-menu": "goToToday",
            "click #day-view": "setDayView",
            "click #week-view": "setWeekView",
            "click #month-view": "setMonthView",
            "click #ical-dropdown": "showICalMenu",
            "click #report-dropdown": "showReportMenu",
            "click button[data-target]": "openFeed",
            "click .report-link": "hideReportMenu",
            "click #print-button": "setPrintUrl",
            "click .dropdown-menu.range-dropdown": "rangeClick",
            "change #range-start-date": "setDateRange",
            "change #range-end-date": "setDateRange",
            "click #custom-view": "showDateRange"
        },
        initialize: function(m) {
            if (_.isUndefined(p3.Data.LMS) || !p3.Data.LMS.OptionsDefaulted) {
                d.Us.getAssignmentOptionDefaults()
            }
            if (m.print) {
                this.template = "assignmentcenter/assignmentcenter.printheader.template.html"
            }
        },
        render: function(m) {
            var o = this,
                n = {};
            $(m).append(this.el);
            o.getRenderDataMissingAssignments(n)
        },
        getRenderDataMissingAssignments: function(n) {
            var o = this,
                m;
            n.persona = p3.Data.Context.getSelectedPersona().Id;
            n.missingAssignmentInd = false;
            if (n.persona === 2) {
                m = new e.Ms.StudentMissingAssignmentCheck();
                m.fetch({
                    success: function() {
                        n.missingAssignmentInd = m.hasMissingAssignments();
                        o.renderTemplate(n)
                    },
                    error: function() {
                        p3.displayError("Error loading missing assignment information");
                        n.missingAssignmentInd = true;
                        o.renderTemplate(n)
                    }
                })
            } else {
                o.renderTemplate(n)
            }
        },
        renderTemplate: function(r) {
            var w = this,
                u = (w.options.studentId || p3.Data.Context.get("UserInfo").UserId),
                q = p3.Data.Context.getSelectedPersona().Id,
                m, v = "",
                o = "",
                n, p, t, s, x;
            if (p3.Data.LMS.startRange) {
                v = f.getDateString(p3.Data.LMS.startRange)
            }
            if (p3.Data.LMS.endRange) {
                o = f.getDateString(p3.Data.LMS.endRange)
            }
            if (p3.Data.LMS.AssignmentCenterDate) {
                m = p3.Data.LMS.AssignmentCenterDate
            } else {
                m = f.localDateTime();
                p3.Data.LMS.AssignmentCenterDate = m
            }
            n = c.Us.GetDateRange(m);
            p = new j.Ms.iCalAssignmentsGet();
            p.fetch({
                async: false,
                data: {
                    personaId: p3.Data.Context.getSelectedPersona().Id,
                    userId: u,
                    sectionId: 0,
                    schoolYearLabel: p3.Data.SchoolContext.get("CurrentSchoolYear").SchoolYearLabel,
                    sdate: f.getDateString(n[0]).ApiFormat(),
                    edate: f.getDateString(n[2]).ApiFormat()
                }
            });
            e.Us.refreshLtiConfigSummary(0);
            t = new k.Cs.ReportList();
            if (!p3.Data.ReportList) {
                k.loadReportList({
                    success: function(y, z) {
                        t.remove(t.at(0));
                        if (k.hasAccessToReportId(261)) {
                            x = l.Us.getUrlById(1691, "__pd=gm_fv&pk=261");
                            s = new k.Ms.ReportList({
                                ReportName: "Assignment Counts - By Section",
                                Link: x
                            });
                            t.add(s)
                        }
                        if (k.hasAccessToReportId(328)) {
                            x = l.Us.getUrlById(1691, "__pd=gm_fv&pk=328");
                            s = new k.Ms.ReportList({
                                ReportName: "Assignments - By Section",
                                Link: x
                            });
                            t.add(s)
                        }
                        if (k.hasAccessToReportId(335)) {
                            x = l.Us.getUrlById(1691, "__pd=gm_fv&pk=335");
                            s = new k.Ms.ReportList({
                                ReportName: "Assignments Due - By Department or Grade",
                                Link: x
                            });
                            t.add(s)
                        }
                        if (k.hasAccessToReportId(80)) {
                            x = l.Us.getUrlById(1691, "__pd=gm_fv&pk=80");
                            s = new k.Ms.ReportList({
                                ReportName: "Roster Assignments",
                                Link: x
                            });
                            t.add(s)
                        }
                        if (k.hasAccessToReportId(215)) {
                            x = l.Us.getUrlById(1691, "pk=215&sid=" + u + "&vid=" + p3.Data.Context.get("UserInfo").UserId + "&ext=vw");
                            s = new k.Ms.ReportList({
                                ReportName: "View Assignment Grades",
                                Link: x
                            });
                            t.add(s)
                        }
                        if (k.hasAccessToReportId(247)) {
                            x = l.Us.getUrlById(1691, "pk=247&sid=" + u + "&vid=" + p3.Data.Context.get("UserInfo").UserId + "&ext=vw");
                            s = new k.Ms.ReportList({
                                ReportName: "View Assignment Grades w/ comments",
                                Link: x
                            });
                            t.add(s)
                        }
                        if (k.hasAccessToReportId(259)) {
                            x = l.Us.getUrlById(1691, "pk=259&ch=1&sid=" + u + "&vid=" + p3.Data.Context.get("UserInfo").UserId + "&ext=vw");
                            s = new k.Ms.ReportList({
                                ReportName: "Cumulative Grades",
                                Link: x
                            });
                            t.add(s)
                        }
                        p3.fT(w.template, function(C) {
                            var A = t.length > 0 ? t.toJSON() : false,
                                B = w.options.studentId > 0 ? w.options.studentId : 0;
                            w.$el.html(C({
                                reports: A,
                                studentId: B,
                                filter: p3.Data.LMS.AssignmentCenterfilter,
                                isStudent: q === 2,
                                missingAssignmentInd: r.missingAssignmentInd,
                                showEdit: (q === 3 && u === p3.Data.Context.get("UserInfo").UserId),
                                showAssess: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.ASSESSMENTS),
                                view: p3.Data.LMS.calendarView,
                                iCalFeed: p.get("iCalLink"),
                                protocol: location.protocol,
                                host: location.host,
                                start: v,
                                end: o,
                                showDiscuss: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADEDDISCUSSION),
                                lti: e.Data.LtiConfigSummary.toJSON()
                            }))
                        })
                    }
                })
            } else {
                t.remove(t.at(0));
                if (k.hasAccessToReportId(261)) {
                    x = l.Us.getUrlById(1691, "__pd=gm_fv&pk=261");
                    s = new k.Ms.ReportList({
                        ReportName: "Assignment Counts - By Section",
                        Link: x
                    });
                    t.add(s)
                }
                if (k.hasAccessToReportId(328)) {
                    x = l.Us.getUrlById(1691, "__pd=gm_fv&pk=328");
                    s = new k.Ms.ReportList({
                        ReportName: "Assignments - By Section",
                        Link: x
                    });
                    t.add(s)
                }
                if (k.hasAccessToReportId(335)) {
                    x = l.Us.getUrlById(1691, "__pd=gm_fv&pk=335");
                    s = new k.Ms.ReportList({
                        ReportName: "Assignments Due - By Department or Grade",
                        Link: x
                    });
                    t.add(s)
                }
                if (k.hasAccessToReportId(80)) {
                    x = l.Us.getUrlById(1691, "__pd=gm_fv&pk=80");
                    s = new k.Ms.ReportList({
                        ReportName: "Roster Assignments",
                        Link: x
                    });
                    t.add(s)
                }
                if (k.hasAccessToReportId(215)) {
                    x = l.Us.getUrlById(1691, "pk=215&sid=" + u + "&vid=" + p3.Data.Context.get("UserInfo").UserId + "&ext=vw");
                    s = new k.Ms.ReportList({
                        ReportName: "View Assignment Grades",
                        Link: x
                    });
                    t.add(s)
                }
                if (k.hasAccessToReportId(247)) {
                    x = l.Us.getUrlById(1691, "pk=247&sid=" + u + "&vid=" + p3.Data.Context.get("UserInfo").UserId + "&ext=vw");
                    s = new k.Ms.ReportList({
                        ReportName: "View Assignment Grades w/ comments",
                        Link: x
                    });
                    t.add(s)
                }
                if (k.hasAccessToReportId(259)) {
                    x = l.Us.getUrlById(1691, "pk=259&ch=1&sid=" + u + "&vid=" + p3.Data.Context.get("UserInfo").UserId + "&ext=vw");
                    s = new k.Ms.ReportList({
                        ReportName: "Cumulative Grades",
                        Link: x
                    });
                    t.add(s)
                }
                p3.fT(w.template, function(A) {
                    var y = t.length > 0 ? t.toJSON() : false,
                        z = w.options.studentId > 0 ? w.options.studentId : 0;
                    w.$el.html(A({
                        reports: y,
                        studentId: z,
                        filter: p3.Data.LMS.AssignmentCenterfilter,
                        isStudent: q === 2,
                        missingAssignmentInd: r.missingAssignmentInd,
                        showEdit: (q === 3 && u === p3.Data.Context.get("UserInfo").UserId),
                        showAssess: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.ASSESSMENTS),
                        view: p3.Data.LMS.calendarView,
                        iCalFeed: p.get("iCalLink"),
                        protocol: location.protocol,
                        host: location.host,
                        start: v,
                        end: o,
                        showDiscuss: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADEDDISCUSSION),
                        lti: e.Data.LtiConfigSummary.toJSON()
                    }))
                })
            }
            window.setTimeout(function() {
                g.Us.initialize(".date-input")
            }, 400)
        },
        showLtiConfigList: function(m) {
            e.Us.showLtiConfigList(0, m)
        },
        showMissingAssignmentList: function(m) {
            var n = p3.Data.Context.getSelectedPersona().Id;
            m.preventDefault();
            if (n === 2) {
                e.Us.showStudentMissingAssignmentList()
            }
        },
        showCalendar: function(o) {
            p3.Data.LMS.DisplayCalendar = true;
            var n = "#assignment-center",
                m;
            if (this.options.studentId && this.options.studentId > 0) {
                n = "#child-main"
            }
            if (!p3.Data.LMS.calendarView) {
                p3.Data.LMS.calendarView = "month"
            } else {
                if (p3.Data.LMS.calendarView == "custom") {
                    p3.Data.LMS.calendarView = "month";
                    p3.Data.LMS.AssignmentCenterDate = f.localDateTime()
                }
            }
            m = new a.Vs.AssignmentCalendar({
                studentId: this.options.studentId,
                containerName: "Assignments"
            });
            p3.rV(m, $(n), true);
            return false
        },
        updateFilter: function(n) {
            var o = jQuery.Event("listRefresh"),
                m;
            $(".btn-group.open").removeClass("open");
            n.stopPropagation();
            n.preventDefault();
            p3.Data.LMS.AssignmentCenterfilter = parseInt($(n.currentTarget).data("filter"), 10);
            $(".assignmentDisplayTypeFilter").each(function(p) {
                $(this).find("i").removeClass("p3icon-radioOn").addClass("p3icon-radioOff");
                $(this).removeClass("active cal-filter-on").addClass("cal-filter-off")
            });
            if ($(n.currentTarget).hasClass("sec-75-bgc-hover")) {
                m = $(".assignmentDisplayTypeFilter[data-filter='" + p3.Data.LMS.AssignmentCenterfilter.toString() + "']")
            } else {
                m = $(n.currentTarget)
            }
            m.find("i").removeClass("p3icon-radioOff").addClass("p3icon-radioOn");
            m.addClass("active cal-filter-on").removeClass("cal-filter-off");
            o.filter = p3.Data.LMS.AssignmentCenterfilter.toString();
            $("#assignment-center-assignment-items").trigger(o)
        },
        addAssessment: function(m) {
            $(".btn-group.open").removeClass("open");
            b.Us.AddAssessmentView().on("saveAssessment", function(o, p) {
                var n = new b.Ms.Assignment();
                n.set("AssignmentId", o);
                n.fetch({
                    error: function() {
                        p3.displayError("Error loading assignment")
                    },
                    success: function(q, r) {
                        p3.router().navigate("#assessmentedit/" + o + "/" + n.get("SectionLinks")[0].AssignmentIndexId + "/0", true)
                    }
                })
            });
            return false
        },
        addDiscussion: function(n) {
            var o = this,
                m = b.Us.AddDiscussionView();
            $(".btn-group.open").removeClass("open");
            m.on("saveDiscussion", function(p, q) {
                setTimeout(function() {
                    $("#assignment-center-assignment-items").trigger($.Event("listRefresh"))
                }, 500)
            });
            m.on("saveAddDiscussion", function(p, q) {
                setTimeout(function() {
                    $("#assignment-center-assignment-items").trigger($.Event("listRefresh"))
                }, 500);
                o.addDiscussion()
            });
            return false
        },
        editSettings: function(m) {
            $(".btn-group.open").removeClass("open");
            p3.rV(new c.Vs.AssignmentSettings(), p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            return false
        },
        addAssignment: function() {
            $(".btn-group.open").removeClass("open");
            b.Us.AddAssignmentView().on("saveAssignment", function() {
                setTimeout(function() {
                    $("#assignment-center-assignment-items").trigger($.Event("listRefresh"))
                }, 500)
            });
            return false
        },
        showSectionFilter: function(m) {
            var p, o, n;
            $(".btn-group.open").removeClass("open");
            m.preventDefault();
            if (_.isUndefined(p3.Data.LMS)) {
                p3.Data.LMS = {}
            }
            if (!p3.Data.LMS.assignmentFilterSections) {
                p3.Data.LMS.assignmentFilterSections = new b.Cs.ExistingSections();
                o = p3.Data.Context.get("Groups");
                for (p = 0; p < o.length; p++) {
                    if (o[p].Association == 1 && o[p].CurrentEnrollment) {
                        if (p3.Data.LMS.assignmentFilterSections.pluck("SectionId").indexOf(o[p].SectionId) == -1) {
                            p3.Data.LMS.assignmentFilterSections.add({
                                SectionId: o[p].SectionId,
                                Selected: true,
                                Name: o[p].GroupName
                            })
                        }
                    }
                }
            }
            n = new a.Vs.SectionFilter();
            p3.rV(n, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            n.on("sectionsFiltered", function() {
                var q = jQuery.Event("listRefresh");
                q.filter = p3.Data.LMS.AssignmentCenterfilter.toString();
                $("#assignment-center-assignment-items").trigger(q)
            })
        },
        showStatusFilter: function(m) {
            if (_.isUndefined(p3.Data.LMS)) {
                p3.Data.LMS = {}
            }
            if (!p3.Data.LMS.assignmentFilterStatus) {
                p3.Data.LMS.assignmentFilterStatus = [];
                p3.Data.LMS.assignmentFilterStatus.push({
                    Status: -1,
                    Name: "Need Action",
                    LabelClass: "label-info",
                    Selected: true
                });
                p3.Data.LMS.assignmentFilterStatus.push({
                    Status: 0,
                    Name: "In Progress",
                    LabelClass: "label-warning",
                    Selected: true
                });
                if (p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.ASSESSMENTS)) {
                    p3.Data.LMS.assignmentFilterStatus.push({
                        Status: 6,
                        Name: "Paused",
                        LabelClass: "label-warning",
                        Selected: true
                    })
                }
                p3.Data.LMS.assignmentFilterStatus.push({
                    Status: 2,
                    Name: "Overdue",
                    LabelClass: "label-important",
                    Selected: true
                });
                p3.Data.LMS.assignmentFilterStatus.push({
                    Status: 1,
                    Name: "Completed",
                    LabelClass: "label-success",
                    Selected: true
                });
                if (p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADEBOOK)) {
                    p3.Data.LMS.assignmentFilterStatus.push({
                        Status: 4,
                        Name: "Graded",
                        LabelClass: "label-success",
                        Selected: true
                    })
                }
            }
            var n = new a.Vs.StatusFilter({
                assignmentFilterStatus: p3.Data.LMS.assignmentFilterStatus
            });
            p3.rV(n, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            n.on("statusFiltered", function() {
                $("#assignment-center-assignment-items").trigger($.Event("listRefresh"))
            });
            m.preventDefault()
        },
        movePrevious: function(m) {
            var o, p, n;
            switch (p3.Data.LMS.calendarView) {
                case "basicDay":
                    o = new Date(p3.Data.LMS.AssignmentCenterDate.setDate(p3.Data.LMS.AssignmentCenterDate.getDate() - 1));
                    break;
                case "basicWeek":
                    o = new Date(p3.Data.LMS.AssignmentCenterDate.setDate(p3.Data.LMS.AssignmentCenterDate.getDate() - 7));
                    break;
                case "month":
                    p = p3.Data.LMS.AssignmentCenterDate.getFullYear();
                    n = p3.Data.LMS.AssignmentCenterDate.getMonth();
                    if (n == 0) {
                        n = 11;
                        p -= 1
                    } else {
                        n -= 1
                    }
                    o = new Date(p, n, 1);
                    break;
                case "custom":
                    break
            }
            if (o) {
                p3.Data.LMS.AssignmentCenterDate = o;
                $("#assignment-center-assignment-items").trigger(jQuery.Event("listRefresh"))
            }
        },
        moveNext: function(m) {
            var o, p, n;
            switch (p3.Data.LMS.calendarView) {
                case "basicDay":
                    o = new Date(p3.Data.LMS.AssignmentCenterDate.setDate(p3.Data.LMS.AssignmentCenterDate.getDate() + 1));
                    break;
                case "basicWeek":
                    o = new Date(p3.Data.LMS.AssignmentCenterDate.setDate(p3.Data.LMS.AssignmentCenterDate.getDate() + 7));
                    break;
                case "month":
                    p = p3.Data.LMS.AssignmentCenterDate.getFullYear();
                    n = p3.Data.LMS.AssignmentCenterDate.getMonth();
                    if (n == 11) {
                        n = 0;
                        p += 1
                    } else {
                        n += 1
                    }
                    o = new Date(p, n, 1);
                    break;
                case "custom":
                    break
            }
            if (o) {
                p3.Data.LMS.AssignmentCenterDate = o;
                $("#assignment-center-assignment-items").trigger(jQuery.Event("listRefresh"))
            }
        },
        goToToday: function(m) {
            switch (p3.Data.LMS.calendarView) {
                case "basicDay":
                case "basicWeek":
                case "month":
                    if (!$("#button-today").hasClass("active")) {
                        $("#button-today").addClass("active");
                        p3.Data.LMS.AssignmentCenterDate = f.localDateTime();
                        $("#assignment-center-assignment-items").trigger(jQuery.Event("listRefresh"))
                    }
                    break;
                case "custom":
                    break
            }
            m.preventDefault()
        },
        setDayView: function(m) {
            $("#view-buttons .btn-inverseCal").removeClass("active");
            $("#day-view").addClass("active");
            p3.Data.LMS.calendarView = "basicDay";
            $("#assignment-center-assignment-items").trigger(jQuery.Event("listRefresh"))
        },
        setWeekView: function(m) {
            $("#view-buttons .btn-inverseCal").removeClass("active");
            $("#week-view").addClass("active");
            p3.Data.LMS.calendarView = "basicWeek";
            $("#assignment-center-assignment-items").trigger(jQuery.Event("listRefresh"))
        },
        setMonthView: function(m) {
            $("#view-buttons .btn-inverseCal").removeClass("active");
            $("#month-view").addClass("active");
            p3.Data.LMS.calendarView = "month";
            $("#assignment-center-assignment-items").trigger(jQuery.Event("listRefresh"))
        },
        showICalMenu: function(m) {
            $("#report-menu").hide();
            $(".range-dropdown").hide();
            $("#ical-menu").toggle();
            return false
        },
        showReportMenu: function(m) {
            $("#ical-menu").hide();
            $(".range-dropdown").hide();
            $("#report-menu").toggle();
            return false
        },
        showDateRange: function(m) {
            if (!$("#custom-view").hasClass("active") && !_.isUndefined(p3.Data.LMS.startRange) && !_.isUndefined(p3.Data.LMS.endRange)) {
                $("#view-buttons .btn-inverseCal").removeClass("active");
                $("#custom-view").addClass("active");
                p3.Data.LMS.calendarView = "custom";
                $("#assignment-center-assignment-items").trigger(jQuery.Event("listRefresh"))
            }
            $("#ical-menu").hide();
            $("#report-menu").hide();
            $(".range-dropdown").toggle();
            return false
        },
        hideReportMenu: function(m) {
            $("#report-menu").hide()
        },
        openFeed: function(m) {
            $("#ical-menu").hide();
            window.open($(m.target).data().target, "_blank")
        },
        setPrintUrl: function(o) {
            var n = "",
                m, q, p;
            n = "&acf=" + p3.Data.LMS.AssignmentCenterfilter;
            n += "&cv=";
            if (_.isUndefined(p3.Data.LMS.calendarView)) {
                n += "month"
            } else {
                n += p3.Data.LMS.calendarView
            }
            if (!_.isUndefined(p3.Data.LMS.AssignmentCenterDate) && p3.Data.LMS.calendarView != "custom") {
                n += "&acd=" + p3.Data.LMS.AssignmentCenterDate.toJSON()
            } else {
                if (p3.Data.LMS.calendarView == "custom") {
                    n += "&rs=" + p3.Data.LMS.startRange.toJSON();
                    n += "&re=" + p3.Data.LMS.endRange.toJSON()
                }
            }
            if (!_.isUndefined(p3.Data.LMS.assignmentFilterSections)) {
                m = false;
                q = "";
                p3.Data.LMS.assignmentFilterSections.each(function(r) {
                    if (r.get("Selected")) {
                        if (q.length) {
                            q += ","
                        }
                        q += r.get("SectionId")
                    } else {
                        m = true
                    }
                });
                if (m) {
                    n += "&sf=" + q
                }
            }
            if (!_.isUndefined(p3.Data.LMS.assignmentFilterStatus)) {
                m = false;
                q = "";
                for (p = 0; p < p3.Data.LMS.assignmentFilterStatus.length; p++) {
                    if (p3.Data.LMS.assignmentFilterStatus[p].Selected) {
                        if (q.length) {
                            q += ","
                        }
                        q += p3.Data.LMS.assignmentFilterStatus[p].Status
                    } else {
                        m = true
                    }
                }
                if (m) {
                    n += "&fs=" + q
                }
            }
            if (this.options.studentId) {
                n += "&sid=" + this.options.studentId
            }
            if (p3.Data.LMS.AssignmentCenterSort && p3.Data.LMS.AssignmentCenterSort.length > 0) {
                n += "&acs=" + p3.Data.LMS.AssignmentCenterSort
            }
            $(o.currentTarget).attr("href", location.href.replace("#", "?pl=1" + n + "#"))
        },
        setDateRange: function(m) {
            var p = true,
                o, n;
            if ($("#range-start-date").val() == "") {
                p = false
            } else {
                o = f.getDate($("#range-start-date").val())
            }
            if ($("#range-end-date").val() == "") {
                p = false
            } else {
                n = f.getDate($("#range-end-date").val())
            }
            if (p) {
                $("#view-buttons .btn-inverseCal").removeClass("active");
                $("#custom-view").addClass("active");
                p3.Data.LMS.calendarView = "custom";
                p3.Data.LMS.startRange = o;
                p3.Data.LMS.endRange = n;
                $("#assignment-center-assignment-items").trigger(jQuery.Event("listRefresh"));
                $(".range-dropdown").hide()
            }
        },
        rangeClick: function(m) {
            m.preventDefault();
            m.stopPropagation()
        }
    });
    c.Vs.AssignmentListView = Bb.View.extend({
        template: "assignmentcenter/assignmentcenter.listview.template.html",
        itemTemplate: "assignmentcenter/assignmentcenter.listitem.template.html",
        events: {
            "click .assignment-table-sort": "updateFilter",
            "click .assignment-list-edit-button": "doAssignmentEdit",
            "click .assignment-list-delete-button": "doAssignmentDelete",
            "listRefresh #assignment-center-assignment-items": "updateList",
            "click .assignment-status-link": "doStatusChange",
            "click .assignment-list-copy-button": "doAssignmentCopy"
        },
        initialize: function(m) {
            var n = p3.Data.Context.getSelectedPersona().Id;
            if (n === 3 || n === 5) {
                b.Us.FetchAssignmentTypes()
            }
        },
        render: function(m) {
            var n = this;
            Hb.registerHelper("AssignmentStatus", function(w, u) {
                var y = "",
                    q = true,
                    p = "",
                    z = "",
                    x = false,
                    A = f.getDate(w.local_now),
                    s = f.getDate(w.date_due),
                    o = f.getDate(w.assess_assigned),
                    r = true,
                    t, v;
                if (w.drop_box_late_time) {
                    t = f.getDate(f.getDateString(s) + " " + f.getTimeString(f.getDate(w.drop_box_late_time)))
                } else {
                    t = f.getDate(f.getDateString(s))
                }
                if (A > t) {
                    x = true
                }
                if (w.drop_box_ind || w.discussion_ind) {
                    q = false
                } else {
                    if (w.assignment_status == 1) {
                        if (x) {
                            q = false
                        }
                    }
                }
                switch (w.assignment_status) {
                    case -1:
                        if (w.assessment_ind) {
                            if (A < o) {
                                r = false
                            } else {
                                z = "Take";
                                p = " btn-info"
                            }
                        } else {
                            if (w.drop_box_ind) {
                                z = "Submit"
                            } else {
                                z = "To Do"
                            }
                            p = " btn-info"
                        }
                        break;
                    case 0:
                        z = "In&nbsp;Progress";
                        p = " btn-warning";
                        break;
                    case 1:
                        z = "Completed";
                        p = " btn-success";
                        break;
                    case 2:
                        z = "Overdue";
                        p = " btn-danger";
                        break;
                    case 3:
                        z = "Retake";
                        p = " btn-info";
                        break;
                    case 5:
                        z = "Upcoming";
                        break
                }
                if (w.assessment_ind) {
                    switch (w.assignment_status) {
                        case -1:
                        case 3:
                            if (r) {
                                y = '<a class="btn btn-default ' + p + '" style="width:85px;text-align:left;" href="#assessment/' + w.assignment_id + "/" + w.assignment_index_id + '/false"><h5><i class="p3icon-notification iconColor"></i> ' + z + "</h5></a>"
                            } else {
                                y = '<button style="margin-top:0px;width:107px;" class="btn">Upcoming</button>'
                            }
                            break;
                        case 0:
                            y = '<button style="margin-top:0px;" class="btn btn-default assignment-status-button btn-warning"><h5><i class="p3icon-notification iconColor"></i>&nbsp;Incomplete</h5></button>';
                            break;
                        case 1:
                        case 4:
                            if (w.has_grade) {
                                y = '<button style="margin-top:0px;" class="btn btn-default assignment-status-button btn-success"><h5><i class="p3icon-ok iconColor"></i>&nbsp;Graded</h5></button>'
                            } else {
                                y = '<button style="margin-top:0px;" class="btn btn-default assignment-status-button btn-success"><h5><i class="p3icon-check iconColor p3Green"></i>&nbsp;Completed</h5></button>'
                            }
                            break;
                        case 2:
                            y = '<button style="margin-top:0px;" class="btn btn-default assignment-status-button btn-danger"><h5><i class="p3icon-notification iconColor"></i> Overdue</h5></button>';
                            break;
                        case 6:
                            y = '<a class="btn btn-default btn-warning" style="width:85px;text-align:left;" href="#assessment/' + w.assignment_id + "/" + w.assignment_index_id + '/true"><h5><i class="p3icon-notification iconColor"></i> Resume</h5></a>';
                            break
                    }
                } else {
                    if (q) {
                        if (w.has_grade) {
                            y = '<button style="margin-top:0px;" class="btn btn-default assignment-status-button btn-success"><h5><i class="p3icon-ok iconColor"></i>&nbsp;Graded</h5></button>'
                        } else {
                            y = '<div class="btn-group assignment-status-container" data-status="' + w.assignment_status + '" data-indexId="' + w.assignment_index_id + '">';
                            y += '<button style="margin-top:0px;" class="btn btn-default assignment-status-button dropdown-toggle' + p + '" data-toggle="dropdown">';
                            y += ' <span class="caret"></span>&nbsp;' + z + "</button>";
                            y += '<ul class="dropdown-menu assignment-status-dropdown">';
                            if (!x) {
                                y += '<li><a href class="assignment-status-link" data-status="-1">To Do</a></li>'
                            }
                            y += '<li><a href class="assignment-status-link" data-status="0">In Progress</a></li>';
                            y += '<li><a href class="assignment-status-link" data-status="1">Completed</a></li>';
                            y += "</ul></div>"
                        }
                    } else {
                        if (w.has_grade) {
                            y = '<button style="margin-top:0px;" class="btn btn-default assignment-status-button btn-success"><h5><i class="p3icon-ok iconColor"></i>&nbsp;Graded</h5></button>'
                        } else {
                            if (w.drop_box_ind) {
                                v = "p3icon-assignmentUpload";
                                if (w.assignment_status == 1) {
                                    v = "p3icon-check"
                                }
                                y = '<button style="margin-top:0px;" class="btn btn-default assignment-status-button' + p + '"> <i class="' + v + ' iconColor"></i>&nbsp;' + z + "</button>"
                            } else {
                                if (w.assignment_status === 1 && w.discussion_ind) {
                                    y = '<button style="margin-top:0px;" class="btn btn-default assignment-status-button' + p + '"><i class="p3icon-check iconColor p3Green"></i>&nbsp;' + z + "</button>"
                                } else {
                                    if (z == "Upcoming") {
                                        y = '<button style="margin-top:0px;width:107px;" class="btn">' + z + "</button>"
                                    } else {
                                        y = '<button style="margin-top:0px;" class="btn btn-default assignment-status-button' + p + '">' + z + "</button>"
                                    }
                                }
                            }
                        }
                    }
                }
                return y
            });
            $(m).append(this.el);
            p3.fT(n.template, function(u) {
                var r = p3.Data.Context.getSelectedPersona().Id,
                    v = n.options.studentId || p3.Data.Context.get("UserInfo").UserId,
                    s = "groupname",
                    t = false,
                    p, o, q;
                if (p3.Data.LMS.AssignmentCenterSort && p3.Data.LMS.AssignmentCenterSort.length > 0) {
                    if (p3.Data.LMS.AssignmentCenterSort.indexOf("invert") > -1) {
                        s = p3.Data.LMS.AssignmentCenterSort.substring(0, p3.Data.LMS.AssignmentCenterSort.indexOf("invert") - 1);
                        t = true
                    } else {
                        s = p3.Data.LMS.AssignmentCenterSort
                    }
                }
                n.$el.html(u({
                    showGraded: (r == 3 && p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADEBOOK)),
                    showStatus: r == 2,
                    showEdit: (r === 3 && v === p3.Data.Context.get("UserInfo").UserId),
                    sort: s,
                    sortInvert: t
                }));
                if (!p3.Data.LMS.calendarView) {
                    p3.Data.LMS.calendarView = "basicDay"
                }
                p = p3.Data.LMS.AssignmentCenterDate || h.localDateTime();
                q = c.Us.GetDateRange(p);
                o = {
                    filter: p3.Data.LMS.AssignmentCenterfilter,
                    dateStart: (q[0].getMonth() + 1) + "/" + q[0].getDate() + "/" + q[0].getFullYear(),
                    dateEnd: (q[1].getMonth() + 1) + "/" + q[1].getDate() + "/" + q[1].getFullYear(),
                    persona: r,
                    statusList: c.Us.getStatusFilterList(),
                    sectionList: c.Us.getSectionFilterList()
                };
                o.filter = d.Us.verifyAssignmentCenterFilter(o.filter, b.Enum.viewByFilters.ACTIVE);
                if (n.options.studentId) {
                    o.userId = n.options.studentId
                }
                c.Data.Assignments.fetch({
                    data: o,
                    success: function(w, x) {
                        w.each(function(A) {
                            var y = A.get("date_due"),
                                z = A.get("date_assigned");
                            if (y && typeof y.substring === "function" && y.indexOf(" ") > 0) {
                                A.set("date_due", y.substring(0, y.indexOf(" ")))
                            }
                            if (z && typeof z.substring === "function" && z.indexOf(" ") > 0) {
                                A.set("date_assigned", z.substring(0, z.indexOf(" ")))
                            }
                            A.set("assess_assigned", z)
                        });
                        n.renderItems(w.toJSON());
                        n.updateToday(q[0], q[1]);
                        n.setDateLabel(q[0], q[1])
                    }
                })
            })
        },
        renderItems: function(m) {
            var p = this,
                n = p3.Data.Context.getSelectedPersona().Id,
                o = p.options.studentId || p3.Data.Context.get("UserInfo").UserId;
            p3.fT(p.itemTemplate, function(u) {
                var q = $("#assignment-center-assignment-items"),
                    r, s, t;
                if (m && m.length > 0) {
                    _.each(m, function(v) {
                        if (v.graded_count === 0) {
                            v.btnStyle = "important"
                        } else {
                            if (v.graded_count < v.enroll_count) {
                                v.btnStyle = "warning"
                            } else {
                                v.btnStyle = "success"
                            }
                        }
                        if (v.assessment_ind) {
                            if (v.assessment_id > 0) {
                                if (n == 3 || n == 5) {
                                    v.showDetail = true
                                } else {
                                    if (n < 3) {
                                        if ((v.has_grade || v.show_report) && (v.assignment_status == 1 || v.assignment_status == 3 || v.assignment_status == 4) && !v.assessment_locked) {
                                            v.showDetail = true;
                                            v.studentId = p3.Data.Context.get("UserInfo").UserId
                                        }
                                    }
                                }
                            }
                        } else {
                            if (v.discussion_ind) {
                                v.showDetail = true
                            } else {
                                if ((v.hasOwnProperty("long_description") && v.long_description !== null && v.long_description && v.long_description.length > 0) || v.has_link || v.has_download || v.drop_box_ind || (v.lti_ind && (n == 2 || n == 3)) || (v.inc_grade_book && (n == 3 || n == 5)) || (v.inc_grade_book && v.publish_grade && n < 3)) {
                                    v.showDetail = true
                                }
                            }
                        }
                        if (p.options.studentId) {
                            v.studentId = p.options.studentId
                        }
                    });
                    q.html(u({
                        assignments: m,
                        showGraded: (n === 3 && p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADEBOOK)),
                        showStatus: n === 2,
                        showEdit: (n === 3 && o === p3.Data.Context.get("UserInfo").UserId),
                        parent: n === 1,
                        faculty: n === i.AppPersona.FACULTY.Value,
                        printMode: p.options.print
                    }))
                } else {
                    r = $(".add-existing-items-header").children().length || 6;
                    s = "<tr>";
                    for (t = 0; t < r; t++) {
                        if (t === 2) {
                            s += "<td>There are no assignments to display.</td>"
                        } else {
                            s += "<td></td>"
                        }
                    }
                    s += "</tr>";
                    q.html(s)
                }
            })
        },
        updateFilter: function(n) {
            var q = this,
                m = $(n.currentTarget),
                p = m.data("sort"),
                o;
            $(".sort-icon").removeClass("p3icon-sortDown p3icon-sortUp p3icon-sortOff").addClass("p3icon-sortOff");
            $(".assignment-table-sort").removeClass("sort-active").addClass("muted");
            if (p) {
                if (q.CurrentSort === p) {
                    p = p + "_invert";
                    m.removeClass("muted").addClass("sort-active");
                    m.children("i").removeClass("p3icon-sortOff").addClass("p3icon-sortUp")
                } else {
                    m.removeClass("muted").addClass("sort-active");
                    m.children("i").removeClass("p3icon-sortOff").addClass("p3icon-sortDown")
                }
                q.CurrentSort = p;
                c.Data.Assignments.changeSort(p);
                c.Data.Assignments.sort();
                p3.Data.LMS.AssignmentCenterSort = p;
                o = c.Data.Assignments.toJSON();
                q.renderItems(o)
            }
            return false
        },
        doAssignmentEdit: function(o) {
            var p = $(o.currentTarget).data("assignmentId"),
                q = ($(o.currentTarget).data("assessment") == 1),
                r = ($(o.currentTarget).data("discussion") == 1),
                s = this,
                m, n;
            if (q) {
                p3.router().navigate("#assessmentedit/" + p + "/" + $(o.currentTarget).data("index") + "/" + $(o.currentTarget).data("locked"), true)
            } else {
                if (r) {
                    m = new b.Ms.Assignment();
                    m.set("AssignmentId", p);
                    m.fetch({
                        async: false,
                        error: function() {
                            p3.displayError("Error loading assignment")
                        },
                        success: function(u, v) {
                            var t = b.Us.AddDiscussionView(m, 0);
                            t.on("saveDiscussion", function() {
                                setTimeout(function() {
                                    $("#assignment-center-assignment-items").trigger($.Event("listRefresh"))
                                }, 500)
                            })
                        }
                    })
                } else {
                    n = b.Us.EditAssignmentView(p);
                    if (n) {
                        n.on("saveAssignment", function() {
                            setTimeout(function() {
                                s.updateList(o)
                            }, 500)
                        }).on("deleteAssignment", function() {
                            setTimeout(function() {
                                $("#assignment-center-assignment-items").trigger($.Event("listRefresh"))
                            }, 500)
                        })
                    }
                }
            }
            return false
        },
        doAssignmentCopy: function(o) {
            var m = $(o.currentTarget).data("assignmentId"),
                p = this,
                n = b.Us.AddAssessmentView(undefined, m);
            if (n) {
                n.on("saveAssessment", function(q, r) {
                    setTimeout(function() {
                        p.updateList(o)
                    }, 500)
                });
                n.on("saveEditAssessment", function(r, s) {
                    var q = new b.Ms.Assignment();
                    q.set("AssignmentId", r);
                    q.fetch({
                        error: function() {
                            p3.displayError("Error loading assignment")
                        },
                        success: function(t, u) {
                            p3.router().navigate("#assessmentedit/" + r + "/" + q.get("SectionLinks")[0].AssignmentIndexId + "/0", true)
                        }
                    })
                })
            }
            return false
        },
        doAssignmentDelete: function(n) {
            var o = $(n.currentTarget).data("assignmentId"),
                p = ($(n.currentTarget).data("assessment") == 1),
                r = this,
                q = new b.Cs.SectionForAssignments({}, {
                    assignmentId: o
                }),
                m = new b.Vs.DeleteAssignmentModalView({
                    collection: q,
                    assignmentId: o,
                    isAssessment: p
                });
            p3.rV(m, p3.Layout.Containers.Modal, true);
            m.on("assignmentDeleted", function() {
                r.updateList()
            });
            p3.showModal(p3.Layout.Containers.Modal);
            q.fetch({
                error: function() {
                    p3.displayError("Error loading Sections associated with the assignment")
                }
            });
            return false
        },
        updateList: function(p) {
            var r = this,
                q, n, o, m;
            if (!_.isUndefined(p) && !_.isUndefined(p.filter)) {
                q = p.filter
            } else {
                if (!_.isUndefined(p3.Data.LMS.AssignmentCenterfilter)) {
                    q = p3.Data.LMS.AssignmentCenterfilter
                }
            }
            if (q === null) {
                q = b.Enum.viewByFilters.ACTIVE
            }
            if (!_.isUndefined(p) && !_.isUndefined(p.date)) {
                n = new Date(p.date)
            } else {
                if (p3.Data.LMS.AssignmentCenterDate) {
                    n = p3.Data.LMS.AssignmentCenterDate
                } else {
                    n = h.localDateTime()
                }
            }
            o = c.Us.GetDateRange(n);
            m = {
                filter: q,
                dateStart: (o[0].getMonth() + 1) + "/" + o[0].getDate() + "/" + o[0].getFullYear(),
                dateEnd: (o[1].getMonth() + 1) + "/" + o[1].getDate() + "/" + o[1].getFullYear(),
                persona: p3.Data.Context.getSelectedPersona().Id,
                statusList: c.Us.getStatusFilterList(),
                sectionList: c.Us.getSectionFilterList()
            };
            m.filter = d.Us.verifyAssignmentCenterFilter(m.filter, b.Enum.viewByFilters.ACTIVE);
            if (r.options.studentId) {
                m.userId = r.options.studentId
            }
            c.Data.Assignments.fetch({
                data: m,
                success: function(s, t) {
                    s.each(function(w) {
                        var u = w.get("date_due"),
                            v = w.get("date_assigned");
                        if (u && typeof u.substring === "function" && u.indexOf(" ") > 0) {
                            w.set("date_due", u.substring(0, u.indexOf(" ")))
                        }
                        if (v && typeof v.substring === "function" && v.indexOf(" ") > 0) {
                            w.set("date_assigned", v.substring(0, v.indexOf(" ")))
                        }
                        w.set("assess_assigned", v)
                    });
                    r.renderItems(s.toJSON());
                    r.updateToday(o[0], o[1]);
                    r.setDateLabel(o[0], o[1])
                }
            });
            return false
        },
        doStatusChange: function(n) {
            $(".btn-group.open").removeClass("open");
            var o = $(n.currentTarget).data("status"),
                p = $(n.currentTarget).closest(".btn-group").data("status"),
                m, q;
            if (p == 2 && o == -1) {
                p = -1
            }
            if (o != p) {
                m = $(n.currentTarget).closest(".btn-group").data("indexid");
                q = new c.Ms.AssignmentStatusUpdate({
                    assignmentIndexId: m,
                    assignmentStatus: o
                });
                q.save({}, {
                    success: function(r, t) {
                        var s = "";
                        switch (o) {
                            case -1:
                                if ($(n.currentTarget).text() == "Overdue") {
                                    s = "btn-danger"
                                } else {
                                    s = "btn-info"
                                }
                                break;
                            case 0:
                                s = "btn-warning";
                                break;
                            case 1:
                                s = "btn-success";
                                break
                        }
                        $(n.currentTarget).closest(".btn-group").find(".assignment-status-button").removeClass("btn-warning").removeClass("btn-danger").removeClass("btn-success").removeClass("btn-info").addClass(s).html('<span class="caret"></span>&nbsp;' + $(n.currentTarget).text());
                        $(n.currentTarget).closest(".btn-group").data("status", o)
                    },
                    error: function(r, s) {
                        p3.displayError("Error updating assignment status")
                    }
                })
            }
            return false
        },
        updateToday: function(n, m) {
            var p = f.localDateTime(),
                r = new Date(p.getFullYear(), p.getMonth(), p.getDate()),
                q = new Date(n.getFullYear(), n.getMonth(), n.getDate()),
                o = new Date(m.getFullYear(), m.getMonth(), m.getDate());
            o = new Date(o.setHours(23));
            o = new Date(o.setMinutes(59));
            o = new Date(o.setSeconds(59));
            if (r.getTime() >= q.getTime() && r.getTime() <= o.getTime()) {
                $("#button-today").addClass("active")
            } else {
                $("#button-today").removeClass("active")
            }
        },
        setDateLabel: function(n, m) {
            var o = "";
            switch (p3.Data.LMS.calendarView) {
                case "basicDay":
                    o = f.displayDate(f.getDateString(n), "fullDate");
                    break;
                case "basicWeek":
                case "custom":
                    o = f.getDateRangeString(n, m);
                    break;
                case "month":
                    o = f.displayDate(f.getDateString(n), "monthYear");
                    break
            }
            $("#date-display-label").html(o);
            $("#small-date-display-label").html(o);
            $("#mobile-date-display-label").html(o)
        }
    });
    c.Vs.AssignmentSettings = Bb.View.extend({
        template: "assignmentcenter/assignmentsettings.template.html",
        events: {
            "click #btnSave": "saveSettings"
        },
        render: function(m) {
            $(m).append(this.el);
            var n = this;
            p3.fT(n.template, function(o) {
                n.$el.html(o({
                    gradeBookDefault: p3.Data.Context.get("UserInfo").GradebookDefaultInd
                }))
            })
        },
        saveSettings: function(m) {
            var n = $("#gb-on-radio").hasClass("active"),
                o = new c.Ms.SaveSettings();
            o.save({
                gradebookInd: n
            }, {
                success: function() {
                    p3.Data.Context.forceRefresh()
                },
                error: function() {
                    p3.displayError("Error saving assignment settings")
                }
            });
            p3.Layout.Containers.Modal.modal("hide");
            return false
        }
    });
    c.Us.GetNextWeek = function(p) {
        var m = p.day + 7,
            o = p.month,
            q = p.year,
            n = c.Us.DaysInMonth(o - 1, q);
        if (m > n) {
            o = o === 12 ? 1 : o + 1;
            if (o === 1) {
                q += 1
            }
            m = m - n
        }
        return {
            dayName: p3.Us.DataLibrary.DayNames[1],
            month: o,
            day: m,
            year: q,
            date: o + "/" + m + "/" + q,
            active: true
        }
    };
    c.Us.GetPrevWeek = function(o) {
        var m = o.day - 7,
            n = o.month,
            q = o.year,
            p = c.Us.DaysInMonth(o.month - 2, q);
        if (n === 1) {
            p = c.Us.DaysInMonth(11, q - 1)
        }
        if (m < 1) {
            n = n === 1 ? 12 : n - 1;
            if (n === 12) {
                q -= 1
            }
            m = p + m
        }
        return {
            dayName: p3.Us.DataLibrary.DayNames[1],
            month: n,
            day: m,
            year: q,
            date: n + "/" + m + "/" + q,
            active: true
        }
    };
    c.Us.DaysInMonth = function(m, p) {
        switch (m) {
            case 0:
            case 2:
            case 4:
            case 6:
            case 7:
            case 9:
            case 11:
                return 31;
            case 3:
            case 5:
            case 8:
            case 10:
                return 30;
            case 1:
                var o = p || h.localDateTime().GetFullYear(),
                    n;
                if (new Date("2/29/" + o.toString()).getMonth() === 1) {
                    n = 29
                } else {
                    n = 28
                }
                return n;
            default:
                return -1
        }
    };
    c.Us.GetDateRange = function(m) {
        var q = [],
            o, n, p;
        if (p3.Data.LMS.calendarView) {
            switch (p3.Data.LMS.calendarView) {
                case "basicDay":
                    o = m;
                    n = m;
                    break;
                case "basicWeek":
                    p = m.getDay();
                    if (p == 0) {
                        o = m
                    } else {
                        o = new Date(m.getTime());
                        o = new Date(o.setDate(o.getDate() - p))
                    }
                    if (p == 6) {
                        n = m
                    } else {
                        n = new Date(m.getTime());
                        n = new Date(n.setDate(n.getDate() + (6 - p)))
                    }
                    break;
                case "month":
                    o = new Date(m.getFullYear(), m.getMonth(), 1);
                    n = new Date(m.getFullYear(), m.getMonth(), c.Us.DaysInMonth(m.getMonth(), m.getYear()));
                    break;
                case "custom":
                    o = p3.Data.LMS.startRange;
                    n = p3.Data.LMS.endRange;
                    break
            }
        } else {
            o = m;
            n = m
        }
        q.push(o);
        q.push(n);
        return q
    };
    c.Us.printList = function(o) {
        var n = o.split("&"),
            m, t, q, s, r, p;
        p3.Data.LMS = {};
        p3.Data.LMS.OptionsDefaulted = true;
        for (q = 0; q < n.length; q++) {
            m = n[q].split("=");
            switch (m[0]) {
                case "acf":
                    p3.Data.LMS.AssignmentCenterfilter = parseInt(m[1], 10);
                    break;
                case "cv":
                    p3.Data.LMS.calendarView = m[1];
                    break;
                case "acd":
                    p3.Data.LMS.AssignmentCenterDate = new Date(m[1]);
                    break;
                case "rs":
                    p3.Data.LMS.startRange = new Date(m[1]);
                    break;
                case "re":
                    p3.Data.LMS.endRange = new Date(m[1]);
                    break;
                case "fs":
                    s = m[1].split(",");
                    p3.Data.LMS.assignmentFilterStatus = [];
                    p3.Data.LMS.assignmentFilterStatus.push({
                        Status: -1,
                        Name: "Need Action",
                        LabelClass: "label-info",
                        Selected: s.indexOf("-1") > -1
                    });
                    p3.Data.LMS.assignmentFilterStatus.push({
                        Status: 0,
                        Name: "In Progress",
                        LabelClass: "label-warning",
                        Selected: s.indexOf("0") > -1
                    });
                    p3.Data.LMS.assignmentFilterStatus.push({
                        Status: 2,
                        Name: "Overdue",
                        LabelClass: "label-important",
                        Selected: s.indexOf("2") > -1
                    });
                    p3.Data.LMS.assignmentFilterStatus.push({
                        Status: 1,
                        Name: "Completed",
                        LabelClass: "label-success",
                        Selected: s.indexOf("1") > -1
                    });
                    if (p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADEBOOK)) {
                        p3.Data.LMS.assignmentFilterStatus.push({
                            Status: 4,
                            Name: "Graded",
                            LabelClass: "label-success",
                            Selected: s.indexOf("4") > -1
                        })
                    }
                    break;
                case "sf":
                    s = m[1].split(",");
                    p3.Data.LMS.assignmentFilterSections = new b.Cs.ExistingSections();
                    p = p3.Data.Context.get("Groups");
                    for (r = 0; r < p.length; r++) {
                        if (p[r].Association == 1 && p[r].CurrentEnrollment) {
                            if (p3.Data.LMS.assignmentFilterSections.pluck("SectionId").indexOf(p[r].SectionId) == -1) {
                                p3.Data.LMS.assignmentFilterSections.add({
                                    SectionId: p[r].SectionId,
                                    Selected: s.indexOf(p[r].SectionId.toString()) > -1,
                                    Name: p[r].GroupName
                                })
                            }
                        }
                    }
                    break;
                case "acs":
                    p3.Data.LMS.AssignmentCenterSort = m[1];
                    break;
                case "sid":
                    t = m[1];
                    break
            }
        }
        p3.Data.LMS.DisplayCalendar = false;
        p3.rV(new c.Vs.LayoutView({
            studentId: t,
            print: true,
            containerName: "Assignments"
        }), "#app", true)
    };
    c.Us.getStatusFilterList = function() {
        var n = "",
            o = false,
            m;
        if (p3.Data.LMS.assignmentFilterStatus) {
            for (m = 0; m < p3.Data.LMS.assignmentFilterStatus.length; m++) {
                if (p3.Data.LMS.assignmentFilterStatus[m].Selected) {
                    if (n.length > 0) {
                        n += ","
                    }
                    n += p3.Data.LMS.assignmentFilterStatus[m].Status
                } else {
                    o = true
                }
            }
            if (!o) {
                n = ""
            }
        }
        return n
    };
    c.Us.getSectionFilterList = function() {
        var m = "",
            n = false;
        if (p3.Data.LMS.assignmentFilterSections) {
            p3.Data.LMS.assignmentFilterSections.each(function(o) {
                if (o.get("Selected")) {
                    if (m.length > 0) {
                        m += ","
                    }
                    m += o.get("SectionId")
                } else {
                    n = true
                }
            });
            if (!n) {
                m = ""
            }
        }
        return m
    }
}(p3.module("LMS/Shared/assignmentcenter")));
(function(a) {
    var g = p3.module("gradebook"),
        c = p3.module("LMS/classpage"),
        f = p3.module("shared/fileselection"),
        h = p3.module("shared/ltitool"),
        b = p3.module("LMS/Shared/AssignmentTools"),
        d = p3.Us.Culture,
        e = p3.Us.Enum;
    a.Ms.Assignment = Bbm.extend({
        idAttribute: "AssignmentId",
        url: function() {
            return aP + "assignment2/read/" + this.get("AssignmentId") + "/?format=json"
        }
    });
    a.Ms.DropBoxSave = Bbm.extend({
        idAttribute: "",
        url: "assignment2/DropBoxSave/?format=json"
    });
    a.Ms.FileRemove = Bbm.extend({
        idAttribute: "",
        url: "assignment2/DropBoxFileRemove/?format=json"
    });
    a.Ms.UserFolder = Bbm.extend({
        url: "datadirect/getuserfolder/",
        idAttribute: "user_id"
    });
    a.Ms.AssignmentStatusUpdate = Bbm.extend({
        url: "assignment2/assignmentstatusupdate/?format=json"
    });
    a.Ms.AssignmentRoster = Bbm.extend({
        idAttribute: "user_id"
    });
    a.Ms.DropBoxAnnotate = Bbm.extend({
        url: function() {
            return aP + "assignment2/dropboxfileannotate/?format=json"
        }
    });
    a.Ms.DropBoxView = Bbm.extend({
        url: function() {
            return aP + "assignment2/dropboxfileview/?format=json"
        }
    });
    a.Cs.Attachments = Bbc.extend({
        url: "datadirect/AssignmentAttachments/?format=json"
    });
    a.Cs.AssignmentRoster = Bbc.extend({
        url: "datadirect/AssignmentIndexGrades/?format=json",
        model: a.Ms.AssignmentRoster
    });
    a.Cs.AssignmentDropboxItems = Bbc.extend({
        url: "datadirect/AssignmentDropboxItems/?format=json"
    });
    a.Cs.MarkingPeriods = Bbc.extend({
        url: function() {
            return aP + "datadirect/AssignmentMarkingPeriods/?format=json"
        }
    });
    a.Cs.StudentAssignmentDetail = Bbc.extend({
        url: "datadirect/AssignmentStudentDetail/?format=json"
    });
    a.Cs.LtiTools = Bbc.extend({
        url: "assignment2/LtiTools/?format=json"
    });
    a.Cs.UserFolder = Bbc.extend({
        url: "datadirect/getuserfolder/?format=json",
        model: a.Ms.UserFolder
    });
    a.Data = {};
    a.Vs.LayoutView = Bb.View.extend({
        template: "assignmentdetails/layoutview.template.html",
        events: {
            "click #BackButton": "doBack"
        },
        initialize: function(i) {
            this.gradebookInd = p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.GRADEBOOK);
            this.dropboxInd = p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.ASSIGNMENTDROPBOX);
            if (i !== undefined) {
                a.Data.DropBoxItems = new a.Cs.AssignmentDropboxItems();
                a.Data.Assignment = new a.Ms.Assignment();
                a.Data.Assignment.set("AssignmentId", i.aid);
                a.Data.Aiid = i.aiid;
                a.Data.Aid = i.aid;
                a.Data.SchoolYear = p3.Data.SchoolContext.get("CurrentSchoolYear").SchoolYearLabel;
                a.Data.MarkingPeriods = new a.Cs.MarkingPeriods();
                a.Data.Gradebook = new g.Cs.Gradebook();
                a.Data.UserFolders = new a.Cs.UserFolder();
                a.Data.DropBoxItems.fetch({
                    data: {
                        schoolYear: a.Data.SchoolYear,
                        assignmentId: i.aid
                    },
                    success: function(k, l) {
                        var j = $("#assignment-detail-extras div:first");
                        if (j !== undefined && j.length > 0) {
                            j.trigger("updateRosterFiles")
                        }
                    },
                    error: function(j, k) {
                        p3.displayError("Error loading Drop box items.")
                    }
                });
                if (Hb.helpers.DetailLinksList == undefined && Hb.helpers.DetailDownloadsList === undefined) {
                    a.Us.RegisterHelpers()
                }
            }
        },
        dispose: function() {
            delete a.Data.CurrentField;
            delete a.Data.GradedCount;
            $("#site-main").addClass("container")
        },
        render: function(i) {
            $(i).append(this.el);
            var j = this;
            p3.fT(j.template, function(k) {
                j.$el.html(k({
                    print: a.Data.Print,
                    BackButtonText: "< Back",
                    imagePath: p3.Config.CssImagePath
                }));
                a.Data.Assignment.fetch({
                    success: function(v, y) {
                        var q = v.get("DropboxInd"),
                            s = v.get("IncGradeBook"),
                            x = v.get("PublishGrade"),
                            u;
                        a.Data.GradeBookIndicator = s;
                        a.Data.DropBoxIndicator = q;
                        a.Data.PublishGradeInd = x;
                        var p = new a.Vs.AssignmentDetailView(),
                            z, t, E, w = p3.Data.Context.getSelectedPersona().Id,
                            l = false,
                            o = "#assignment-detail-assignment",
                            A = "#assignment-detail-extras",
                            n;
                        if (w === 3) {
                            var B;
                            var C = a.Data.Assignment.get("SectionLinks");
                            for (u = 0; u < C.length; u++) {
                                if (C[u].AssignmentIndexId == a.Data.Aiid) {
                                    B = C[u].SectionId;
                                    if (C[u].Section !== undefined && C[u].Section.Duration !== undefined) {
                                        a.Data.SchoolYear = C[u].Section.Duration.SchoolYearLabel;
                                        j.getDropboxItems(v)
                                    }
                                    break
                                }
                            }
                            var D = new c.Cs.Sections({}, {
                                sectionId: B
                            });
                            l = j.getTeacherEdit(D, B);
                            if (l) {
                                z = new a.Cs.AssignmentRoster();
                                if ((j.gradebookInd !== false && s !== false) || (j.dropboxInd !== false && q !== false)) {
                                    $("#original-layout-container").remove();
                                    $("#new-layout-container").show();
                                    $("#BackButton").remove();
                                    o = "#new-detail-container";
                                    A = "#roster-sidebar";
                                    p = new a.Vs.AssignmentDetailViewNew({
                                        collection: z
                                    });
                                    $("#site-main").removeClass("container");
                                    a.Data.UserFolders.fetch({
                                        data: {
                                            sectionId: B
                                        },
                                        error: function(m, F) {
                                            p3.displayError("Error loading user folders.")
                                        }
                                    })
                                }
                                t = new a.Vs.AssignmentGradesViewNew({
                                    collection: z,
                                    gradebookInd: (j.gradebookInd && s),
                                    dropboxInd: q
                                });
                                z.comparator = function(F, G) {
                                    var m = F.get("lastname"),
                                        r = G.get("lastname");
                                    if (m === undefined) {
                                        return 1
                                    }
                                    if (m !== undefined) {
                                        m = m.toUpperCase()
                                    }
                                    if (r === undefined) {
                                        return -1
                                    }
                                    if (r !== undefined) {
                                        r = r.toUpperCase()
                                    }
                                    if (m === r) {
                                        m = F.get("firstname");
                                        r = G.get("firstname")
                                    }
                                    return m < r ? -1 : m > r ? 1 : 0
                                }
                            }
                        } else {
                            if (w === 1) {
                                n = new a.Cs.StudentAssignmentDetail();
                                n.fetch({
                                    data: {
                                        studentId: a.Data.CurrentStudent || p3.Data.Context.get("UserInfo").UserId,
                                        AssignmentIndexId: a.Data.Aiid,
                                        personaId: w
                                    },
                                    success: function(m, F) {
                                        if (m.length > 0) {
                                            var G = true;
                                            if (m.at(0).get("readyInd") === true || w === 1 || (w === 1 && j.gradebookInd !== false && s !== false) || (w === 2 && q === false && s === true)) {
                                                E = new a.Vs.StudentSubmittedDropBox({
                                                    collection: m,
                                                    onlyGraded: (s && !q),
                                                    gradebook: s,
                                                    gradesPublished: a.Data.PublishGradeInd
                                                });
                                                if (!a.Data.PublishGradeInd) {
                                                    G = false
                                                }
                                            } else {
                                                E = new a.Vs.StudentDropBox({
                                                    dropboxInd: q,
                                                    collection: m
                                                })
                                            }
                                            if (G) {
                                                $("#assignment-detail-assignment").removeClass("span12 col-md-12").addClass("span6 col-md-6");
                                                $("#assignment-detail-extras").addClass("span6 col-md-6")
                                            } else {
                                                $("#assignment-detail-assignment").removeClass("span6 col-md-6").addClass("span12 col-md-12");
                                                $("#assignment-detail-extras").removeClass("span6 col-md-6")
                                            }
                                        }
                                        if (((j.dropboxInd !== false && q !== false) || (j.gradebookInd !== false && s !== false)) && E !== undefined) {
                                            p3.rV(E, $("#assignment-detail-extras"), false)
                                        }
                                    }
                                });
                                if (E === undefined) {
                                    E = new a.Vs.StudentDropBox({
                                        dropboxInd: q
                                    })
                                }
                            } else {
                                if (w === 2) {
                                    n = new a.Cs.StudentAssignmentDetail();
                                    n.fetch({
                                        data: {
                                            studentId: a.Data.CurrentStudent || p3.Data.Context.get("UserInfo").UserId,
                                            AssignmentIndexId: a.Data.Aiid
                                        },
                                        success: function(m) {
                                            if (m.length > 0) {
                                                var F = $("#assignment-detail-extras").html(),
                                                    r = false;
                                                if (F.length > 1) {
                                                    r = true
                                                }
                                                p3.rV(new a.Vs.StudentAssignmentInformation({
                                                    model: m.at(0),
                                                    assignment: v,
                                                    files: m,
                                                    gradebook: s,
                                                    onlineSubmit: q,
                                                    gradesPublished: a.Data.PublishGradeInd
                                                }), $("#assignment-detail-extras"), r);
                                                if (r) {
                                                    $("#assignment-detail-extras").append(F);
                                                    $("#assignment-detail-linked-content").addClass("mt-10")
                                                }
                                            }
                                        }
                                    })
                                }
                            }
                        }
                        if (l) {
                            a.Us.RenderLtiRegion(true)
                        }
                        p3.rV(p, $(o), false);
                        if (l && ((j.gradebookInd !== false && s !== false) || (j.dropboxInd !== false && q !== false))) {
                            p3.rV(t, $(A), false)
                        } else {
                            if (w === 2 && j.dropboxInd !== false && q !== false && E !== undefined) {
                                p3.rV(E, $("#assignment-detail-extras"), false)
                            }
                        }
                        $("#BackButton").show();
                        $("#assignment-detail-extras div").trigger("assignmentload");
                        if (l) {
                            z.fetch({
                                data: {
                                    aiid: a.Data.Aiid,
                                    viewerId: p3.Data.Context.get("UserInfo").UserId
                                },
                                error: function(m, F) {
                                    p3.displayError("Error loading Roster.")
                                }
                            })
                        }
                    },
                    error: function(l, m) {
                        j.$el.html("<strong>Error getting assignment details</strong>")
                    }
                })
            })
        },
        doBack: function(i) {
            i.preventDefault();
            if (a.Data.Back != null && a.Data.Back.length > 0 && a.Data.Back !== "X" && a.Data.Back !== "x") {
                window.location.href = "#" + a.Data.Back.split("--").join("/")
            } else {
                window.history.back()
            }
        },
        getDropboxItems: function(i) {
            a.Data.DropBoxItems.fetch({
                data: {
                    schoolYear: a.Data.SchoolYear,
                    assignmentId: i.get("AssignmentId")
                },
                success: function(k, l) {
                    var j = $("#assignment-detail-extras div:first");
                    if (j !== undefined && j.length > 0) {
                        j.trigger("updateRosterFiles")
                    }
                },
                error: function(j, k) {
                    p3.displayError("Error loading Drop box items.")
                }
            })
        },
        getTeacherEdit: function(k, j) {
            var i = false;
            k.fetch({
                async: false,
                data: {
                    sectionId: k.sectionId,
                    associationId: 1,
                    teacherId: 0
                },
                error: function() {
                    p3.displayError("Error loading teacher sections")
                },
                success: function() {
                    if (k.length > 0) {
                        k.each(function(l) {
                            if (l.get("SectionId") == j) {
                                i = l.get("AssignmentEdit")
                            }
                        })
                    }
                }
            });
            return i
        }
    });
    a.Vs.AssignmentDetailView = Bb.View.extend({
        template: "assignmentdetails/detailview.template.html",
        render: function(i) {
            $(i).append(this.el);
            var j = this;
            p3.fT(j.template, function(r) {
                var p = a.Data.Assignment,
                    q = _.find(p.get("SectionLinks"), function(m) {
                        return m.AssignmentIndexId == a.Data.Aiid
                    }),
                    o = p.get("LinkItems"),
                    n = p.get("DownloadItems"),
                    k = $("#assignment-detail-assignment");
                a.Data.DueDate = d.getDate(q.DueDate);
                if (q.SectionId !== undefined && q.SectionId > 0) {
                    a.Data.SectionId = q.SectionId;
                    a.Data.DurationId = q.Section.Duration.Id;
                    if (a.Data.MarkingPeriods === undefined) {
                        a.Data.MarkingPeriods = new a.Cs.MarkingPeriods()
                    }
                    if (a.Data.MarkingPeriods.length <= 0) {
                        a.Data.MarkingPeriods.fetch({
                            data: {
                                sectionList: a.Data.SectionId
                            },
                            error: function(m, s) {
                                p3.displayError("Error retreiving Marking Period Information.")
                            }
                        })
                    }
                }
                j.$el.html(r({
                    print: a.Data.Print,
                    rootUrl: p3.Config.RootPath,
                    aid: p.get("AssignmentId"),
                    aiid: a.Data.Aiid,
                    title: p.get("ShortDescription"),
                    adate: q.AssignmentDate,
                    ddate: q.DueDate,
                    onlineSubmission: p.get("DropboxInd"),
                    sectionName: q.Section.Name || "",
                    description: p.get("LongDescription"),
                    links: o,
                    downloads: n,
                    linkedContentTotal: (o.length + n.length)
                }));
                if (((p.get("IncGradeBook") === false || p.get("PublishGrade")) === false && p3.Data.Context.getSelectedPersona().Id < 3) && p.get("DropboxInd") === false) {
                    var l = $("#assignment-detail-linked-content");
                    l.remove();
                    $("#assignment-detail-extras").append(l);
                    if (k.hasClass("span12") || k.hasClass("col-md-12")) {
                        $("#assignment-detail-assignment").removeClass("span12 col-md-12").addClass("span6 col-md-6");
                        $("#assignment-detail-extras").addClass("span6 col-md-6")
                    }
                }
                a.Us.RenderLtiRegion(false)
            })
        }
    });
    a.Vs.AssignmentDetailViewNew = Bb.View.extend({
        template: "assignmentdetails/detailview.new.template.html",
        initialize: function(i) {
            this.collection.on("reset", this.renderTemplate, this)
        },
        events: {
            "click #ltiConfigButton": "showLtiConfigList"
        },
        showLtiConfigList: function(i) {
            b.Us.showLtiConfigList(a.Data.Aiid, i, a.Data.Back)
        },
        render: function(i) {
            $(i).append(this.el)
        },
        renderTemplate: function() {
            var i = this;
            p3.fT(i.template, function(q) {
                var o = a.Data.Assignment,
                    p = _.find(o.get("SectionLinks"), function(m) {
                        return m.AssignmentIndexId == a.Data.Aiid
                    }),
                    n = o.get("LinkItems"),
                    l = o.get("DownloadItems"),
                    j = $("#assignment-detail-assignment");
                a.Data.DueDate = d.getDate(p.DueDate);
                if (p.SectionId !== undefined && p.SectionId > 0) {
                    a.Data.SectionId = p.SectionId;
                    a.Data.DurationId = p.Section.Duration.Id;
                    if (a.Data.MarkingPeriods === undefined) {
                        a.Data.MarkingPeriods = new a.Cs.MarkingPeriods()
                    }
                    if (a.Data.MarkingPeriods.length <= 0) {
                        a.Data.MarkingPeriods.fetch({
                            data: {
                                sectionList: a.Data.SectionId
                            },
                            error: function(m, s) {
                                p3.displayError("Error retreiving Marking Period Information.")
                            }
                        })
                    }
                }
                b.Us.refreshLtiConfigSummary(a.Data.Aiid);
                i.$el.html(q({
                    print: a.Data.Print,
                    rootUrl: p3.Config.RootPath,
                    aid: o.get("AssignmentId"),
                    aiid: a.Data.Aiid,
                    title: o.get("ShortDescription"),
                    adate: p.AssignmentDate,
                    ddate: p.DueDate,
                    sectionName: p.Section.Name || "",
                    description: o.get("LongDescription"),
                    links: n,
                    downloads: l,
                    linkedContentTotal: (n.length + l.length),
                    graded: ((i.collection.length > 0) ? (i.collection.at(0).get("graded_count")) : null),
                    enrolled: ((i.collection.length > 0) ? (i.collection.at(0).get("enrollment_count")) : null),
                    average: a.Us.getAverageGrade(o.get("MaxPoints"), i.collection),
                    gradebookInd: o.get("IncGradeBook"),
                    lti: b.Data.LtiConfigSummary.toJSON()
                }));
                if (((o.get("IncGradeBook") === false || o.get("PublishGrade") === false) && p3.Data.Context.getSelectedPersona().Id < 3) && o.get("DropboxInd") === false) {
                    var k = $("#assignment-detail-linked-content");
                    k.remove();
                    $("#assignment-detail-extras").append(k);
                    if (j.hasClass("span12") || j.hasClass("col-md-12")) {
                        $("#assignment-detail-assignment").removeClass("span12 col-md-12").addClass("span6 col-md-6");
                        $("#assignment-detail-extras").addClass("span6 col-md-6")
                    }
                }
            })
        }
    });
    a.Vs.AssignmentDetailLtiView = Bb.View.extend({
        areaTemplate: "assignmentdetails/detailview.lti.area.template.html",
        frameTemplate: "assignmentdetails/detailview.lti.frame.template.html",
        events: {
            "click #lti-launch": "ltiLaunch",
            "click #lti-msg-toggle": "toggleMessage"
        },
        initialize: function(i) {
            var j = this;
            j.lti = j.options.lti;
            j.settings = j.options.persona === 3 && !(j.lti.LaunchTypeId === 1);
            if (j.lti.AllowLaunchInd) {
                if ((j.options.persona === 3) || (j.options.persona !== 3 && j.lti.LtiConfigInd)) {
                    j.launchable = true;
                    j.launchableMsg = ""
                } else {
                    j.launchable = true;
                    j.launchableMsg = "This learning tool has not been configured yet"
                }
            } else {
                j.launchable = false;
                j.launchableMsg = j.lti.AllowLaunchMsg
            }
            j.noconfig = (j.options.persona === 3 && !(j.lti.LtiConfigInd));
            j.autoLaunch = j.launchable && (j.lti.LaunchTypeId === 1);
            j.assignmentId = j.options.assignmentId;
            j.assignmentIndexId = j.options.assignmentIndexId;
            j.logMessages = false
        },
        dispose: function() {
            var i = this;
            i.removeWindowMessageListener(i.ltiHandleMessage)
        },
        render: function(i) {
            var j = this;
            $(i).append(j.el);
            j.renderTemplate()
        },
        renderTemplate: function() {
            var i = this;
            p3.fT(i.areaTemplate, function(j) {
                i.$el.html(j({
                    lti: i.lti,
                    settings: i.settings,
                    autoLaunch: i.autoLaunch,
                    launchable: i.launchable,
                    launchableMsg: i.launchableMsg,
                    imagePath: p3.Config.CssImagePath,
                    noconfig: i.noconfig
                }));
                i.ltiButtons("initial");
                if (i.autoLaunch) {
                    i.ltiLaunch()
                }
            })
        },
        listenForWindowMessage: function(l, i) {
            var k = window.addEventListener ? "addEventListener" : "attachEvent",
                j = window[k],
                m = (k === "attachEvent") ? "onmessage" : "message";
            j(m, function(n) {
                l.call(i || this, n)
            }, false)
        },
        removeWindowMessageListener: function(k) {
            var j = window.removeEventListener ? "removeEventListener" : "detachEvent",
                i = window[j],
                l = (j === "detachEvent") ? "onmessage" : "message";
            i(l, k)
        },
        ltiLaunch: function(m) {
            var o = this,
                k = 5,
                l = o.assignmentIndexId,
                n, i, j, q = "",
                p = "";
            if (m) {
                m.preventDefault()
            }
            o.removeWindowMessageListener(o.ltiHandleMessage);
            if (o.lti.ToolIndexId && k && l) {
                n = h.Us.BuildLaunchUrl(o.lti.ToolIndexId, o.lti.PresentationTarget, k, l);
                if (o.lti.PresentationTarget === e.LtiPresentationTargets.Embed.id) {
                    p3.fT(o.frameTemplate, function(r) {
                        i = $("#lti-frame-area");
                        i.empty();
                        i.html(r({
                            lti: o.lti
                        }));
                        o.ltiButtons("launching");
                        j = $("#lti-frame")[0];
                        j.onload = function() {
                            o.ltiFrameLoaded(this)
                        };
                        o.listenForWindowMessage(o.ltiHandleMessage, o);
                        j.contentWindow.location.replace(n);
                        i.show()
                    })
                } else {
                    if (o.lti.PresentationTarget === e.LtiPresentationTargets.New.id) {
                        q = o.lti.ToolTitle;
                        window.open(n, q, p)
                    } else {
                        p3.displayError("The third party tool must open in place or in a new window.")
                    }
                }
            } else {
                p3.displayError("Error loading third party tool.")
            }
        },
        ltiClose: function(i) {
            var j = this;
            j.removeWindowMessageListener(j.ltiHandleMessage);
            $("#lti-frame-area").hide();
            $("#lti-frame").remove();
            j.ltiButtons("closed")
        },
        ltiHandleMessage: function(j) {
            var l = this,
                k;
            if (j && j.data) {
                if (l.logMessages) {
                    $("#lti-log-area").append(j.data.toString() + "<br />")
                }
                if (j.data === "ltiClose") {
                    l.ltiClose()
                } else {
                    try {
                        k = JSON.parse(j.data)
                    } catch (i) {
                        return false
                    }
                    if (k.hasOwnProperty("id") && k.id === "ltiMessage") {
                        $("#lti-msg-text").text(k.text + " ");
                        if (k.type === "error") {
                            $("#lti-msg-text").removeClass("alert-info");
                            $("#lti-msg-text").addClass("alert-error")
                        } else {
                            $("#lti-msg-text").removeClass("alert-error");
                            $("#lti-msg-text").addClass("alert-info")
                        }
                        $("#lti-msg-area").show(100);
                        l.ltiButtons("openmessage")
                    }
                }
            }
        },
        ltiFrameLoaded: function(i) {
            var j = this;
            j.ltiButtons("launched");
            j.updateLtiConfig()
        },
        updateLtiConfig: function() {
            var i;
            b.Us.refreshLtiConfigSummary(a.Data.Aiid, function(j) {
                if (j.get("IsFaculty") && j.get("IsLtiInstalled")) {
                    i = $("#ltiConfigButton");
                    if (i) {
                        if (j.get("NeedsConfigCount") > 0) {
                            i.show()
                        } else {
                            i.hide()
                        }
                    }
                    $("#lti-noconfig").remove()
                }
            })
        },
        ltiButtons: function(l) {
            var m = this,
                i = $("#lti-launch"),
                j = $("#lti-processing"),
                k = ($("#lti-msg-area").filter(":visible").length > 0);
            if (l === "initial" || (l === "closemessage")) {
                if (m.autoLaunch) {
                    m.showButton(j, false);
                    m.showButton(i, false)
                } else {
                    m.showButton(j, false);
                    m.showButton(i, m.launchable)
                }
            } else {
                if (l === "launching") {
                    m.showButton(i, false);
                    m.showButton(j, true)
                } else {
                    if (l === "launched") {
                        m.showButton(i, false);
                        m.showButton(j, false)
                    } else {
                        if (l === "openmessage") {
                            m.showButton(i, false);
                            m.showButton(j, false)
                        } else {
                            if (l === "closed") {
                                if (m.autoLaunch) {
                                    m.showButton(j, false);
                                    m.showButton(i, false)
                                } else {
                                    m.showButton(j, false);
                                    m.showButton(i, m.launchable && !k)
                                }
                            }
                        }
                    }
                }
            }
        },
        showButton: function(i, j) {
            if (i !== undefined && i !== null && i) {
                if (j) {
                    i.show()
                } else {
                    i.hide()
                }
            }
        },
        toggleMessage: function(j) {
            var i = $("#lti-msg-area");
            if (i) {
                if (i.filter(":visible").length > 0) {
                    i.hide();
                    this.ltiButtons("closemessage")
                }
            }
        }
    });
    a.Vs.AssignmentGradesViewNew = Bb.View.extend({
        template: "assignmentdetails/gradeview.new.template.html",
        events: {
            assignmentload: "getSettings",
            updateRosterFiles: "renderTemplate",
            "click .dropdown-menu": "setMaxPoint",
            "click .select-student": "showStudentDetail",
            "click #details-link": "showDetails"
        },
        initialize: function(i) {
            a.Data.Scale = new g.Cs.Scale();
            this.collection.on("reset", this.renderTemplate, this);
            a.Data.SaveCollection = new g.Cs.Gradebook()
        },
        getSettings: function() {
            if (a.Data.Assignment !== undefined) {
                var i = _.find(a.Data.Assignment.get("SectionLinks"), function(j) {
                    return j.AssignmentIndexId == a.Data.Aiid
                });
                if (i.SectionId !== undefined && i.SectionId > 0) {
                    a.Data.SectionId = i.SectionId
                }
            } else {
                p3.displayError("ERROR: the Assignment hasn't been loaded yet.")
            }
            this.settings = new g.Ms.GradebookOptions({
                sectionId: a.Data.SectionId,
                markingPeriodId: 1177
            });
            this.settings.on("reset change", this.renderTemplate, this)
        },
        render: function(i) {
            var j = this;
            $(i).html(this.el);
            this.collection.fetch({
                data: {
                    aiid: a.Data.Aiid,
                    viewerId: p3.Data.Context.get("UserInfo").UserId
                },
                success: function(k, l) {
                    j.renderTemplate()
                },
                error: function(k, l) {
                    p3.displayError("Error loading Roster.")
                }
            })
        },
        renderTemplate: function() {
            var j = this,
                i = j.collection.at(0);
            if (j.collection.length <= 0 || i === undefined) {
                return
            }
            if (a.Data.GradeBookIndicator) {
                a.Data.Scale.fetch({
                    success: function(k, o) {
                        var n = false,
                            l = false,
                            p = false;
                        if (a.Data.Assignment !== undefined) {
                            n = a.Data.Assignment.get("MaxPoints");
                            l = a.Data.Assignment.get("DropboxInd")
                        }
                        p = k.toJSON();
                        p = _.filter(p, function(r) {
                            return r.ScaleId == i.get("scale_id")
                        });
                        if (j.options.discussionInd) {
                            var q = _.find(a.Data.Assignment.get("SectionLinks"), function(r) {
                                return r.AssignmentIndexId == a.Data.Aiid
                            });
                            var m = d.getDate(q.DueDate);
                            j.collection.each(function(s) {
                                if (s.get("message_count") > 0) {
                                    var r = d.getDate(s.get("first_post"));
                                    r = new Date(r.getFullYear(), r.getMonth(), r.getDate());
                                    if (r > m) {
                                        s.set("isLate", true)
                                    }
                                }
                            })
                        } else {
                            if (j.options.dropboxInd) {
                                j.collection.each(function(r) {
                                    a.Us.buildFilesList(r)
                                })
                            }
                        }
                        a.Data.ScaleId = i.get("scale_id");
                        if (a.Data.GradedCount === undefined || a.Data.GradedCount < 0) {
                            a.Data.GradedCount = i.get("graded_count")
                        }
                        p3.fT(j.template, function(r) {
                            j.$el.html(r({
                                graded: a.Data.GradedCount,
                                enrolled: i.get("enrollment_count"),
                                assignmentId: a.Data.Aid,
                                schoolId: p3.Data.SchoolContext.get("SchoolInfo").SchoolId,
                                sectionId: a.Data.SectionId,
                                MaxPoints: n == -2 ? false : n,
                                ScaleId: i.get("scale_id") == -1 ? false : i.get("scale_id"),
                                Scale: p,
                                DropBoxInd: l,
                                GradeBookInd: a.Data.GradeBookIndicator,
                                roster: j.collection.toJSON(),
                                DiscussionInd: j.options.discussionInd
                            }));
                            j.outputGradeCells()
                        })
                    },
                    error: function() {
                        p3.displayError("Error grade scale")
                    }
                })
            } else {
                if (j.options.dropboxInd) {
                    j.collection.each(function(k) {
                        a.Us.buildFilesList(k)
                    })
                }
                p3.fT(j.template, function(k) {
                    j.$el.html(k({
                        graded: i.get("graded_count"),
                        enrolled: i.get("enrollment_count"),
                        assignmentId: a.Data.Aid,
                        schoolId: p3.Data.SchoolContext.get("SchoolInfo").SchoolId,
                        sectionId: a.Data.SectionId,
                        MaxPoints: false,
                        ScaleId: false,
                        Scale: -1,
                        DropBoxInd: a.Data.DropBoxIndicator,
                        GradeBookInd: a.Data.GradeBookIndicator,
                        roster: j.collection.toJSON()
                    }))
                })
            }
        },
        outputGradeCells: function() {
            var j = this,
                i;
            j.collection.each(function(k) {
                if (k.get("scale_id") > 0) {
                    i = new a.Vs.GradeSelectView({
                        model: k,
                        collection: a.Data.Scale
                    })
                } else {
                    i = new a.Vs.GradeInputView({
                        model: k
                    })
                }
                p3.rV(i, "#grade-container-" + k.get("user_id"), false);
                i.on("gradeChange", function() {
                    j.collection.fetch({
                        silent: true,
                        data: {
                            aiid: a.Data.Aiid,
                            viewerId: p3.Data.Context.get("UserInfo").UserId
                        },
                        success: function(l, m) {
                            $("#grade-average").text(a.Us.getAverageGrade(a.Data.Assignment.get("MaxPoints"), j.collection));
                            $("#current-graded-total").text(j.collection.at(0).get("graded_count"));
                            $("#current-graded-count").text(j.collection.at(0).get("graded_count"));
                            if ($("#student-detail-region").is(":visible") && j.selectedUser && j.selectedUser == k.get("user_id")) {
                                j.outputStudent()
                            }
                        },
                        error: function(l, m) {
                            p3.displayError("Error loading Roster.")
                        }
                    })
                })
            })
        },
        setMaxPoint: function(k) {
            var s = this,
                j = $(k.target),
                p = 0,
                l, q, n;
            p = _.find(a.Data.Assignment.get("SectionLinks"), function(i) {
                return i.SectionId == a.Data.SectionId
            });
            if (j.html() !== "Add") {
                return false
            }
            var r = j.siblings("select").val() || "-1",
                o = j.siblings('input[type="text"]').val() || "-2";
            var m = new g.Ms.Gradebook({
                status: "save",
                DaysLate: 0,
                ScaleId: -1,
                AssignmentId: a.Data.Aid,
                ValueId: r,
                PointsEarned: o
            });
            if (m.isValid()) {
                for (l = 0; l < s.collection.length; l++) {
                    q = s.collection.at(l).get("user_id");
                    n = new g.Ms.GradebookSave({
                        AssignmentId: a.Data.Aid,
                        StudentUserId: q,
                        PointsEarned: o,
                        ValueId: r,
                        Exempt: false,
                        Incomplete: false,
                        Late: false,
                        DaysLate: 0,
                        Comment: "",
                        status: "save"
                    });
                    j.closest(".control-group").removeClass("error");
                    j.closest(".controls").removeAttr("data-original-title");
                    a.Data.SaveCollection.add(n, {
                        silent: true
                    })
                }
                if (a.Data.SaveCollection.length > 0) {
                    new g.Ms.GradebookSave().save({
                        sectionId: a.Data.SectionId,
                        markingPeriodId: p.MarkingPeriodId,
                        xmlData: JSON.stringify(a.Data.SaveCollection)
                    }, {
                        success: function(u, v) {
                            a.Data.SaveCollection.reset(null, {
                                silent: true
                            });
                            $(".grade-input").each(function(y) {
                                var x = $(this);
                                if (o === "-2") {
                                    o = ""
                                }
                                if (x.is("input")) {
                                    x.val(o)
                                } else {
                                    if (x.is("select")) {
                                        x.val(r)
                                    }
                                }
                            });
                            a.Data.GradedCount = s.collection.length;
                            $("#current-graded-count").html(a.Data.GradedCount);
                            $("#current-graded-total").html(a.Data.GradedCount);
                            var i = "";
                            if (a.Data.Assignment.get("MaxPoints") > 0) {
                                if (r > 0) {
                                    var w = a.Data.Scale.toJSON(),
                                        t;
                                    for (t = 0; t < w.length; t++) {
                                        if (w[t].ValueId == r) {
                                            o = w[t].ScaleValue;
                                            break
                                        }
                                    }
                                }
                                if (o > 0) {
                                    i = Math.round((o / a.Data.Assignment.get("MaxPoints")) * 100);
                                    i = i.toString() + "%"
                                } else {
                                    i = "0%"
                                }
                                $("#grade-average").html(i)
                            }
                        },
                        error: function(i, t) {
                            p3.displayError("Error on Grade Book save");
                            a.Data.SaveCollection.reset(null, {
                                silent: true
                            })
                        }
                    })
                }
            }
        },
        showStudentDetail: function(j) {
            var l = this,
                i = $(j.currentTarget),
                k = i.data("id");
            $("#details-region").hide();
            $("#student-detail-region").show();
            $("ul.roster-list li").removeClass("pri-100-bgc selected");
            $(".roster-listing").removeClass("white-fgc");
            $(".roster-submitted").removeClass("white-fgc");
            $(".assign-detail-desc").removeClass("white-fgc");
            i.parents("li").addClass("pri-100-bgc selected");
            i.find(".roster-listing").addClass("white-fgc");
            i.find(".roster-submitted").addClass("white-fgc");
            l.selectedUser = k;
            if (l.options.discussionInd) {
                l.trigger("studentSelected", k)
            }
            l.outputStudent();
            j.preventDefault()
        },
        outputStudent: function() {
            var j = this,
                i = new a.Vs.GradeEdit({
                    model: j.collection.get(j.selectedUser),
                    discussionInd: j.options.discussionInd
                });
            if (j.options.dropboxInd) {
                j.collection.each(function(k) {
                    a.Us.buildFilesList(k)
                })
            }
            p3.rV(i, "#student-detail-region", true);
            i.on("detailEdited", function() {
                j.collection.fetch({
                    silent: true,
                    data: {
                        aiid: a.Data.Aiid,
                        viewerId: p3.Data.Context.get("UserInfo").UserId
                    },
                    success: function(k, l) {
                        $("#grade-average").html(a.Us.getAverageGrade(a.Data.Assignment.get("MaxPoints"), j.collection));
                        $("#current-graded-total").html(j.collection.at(0).get("graded_count"));
                        j.outputGradeCells()
                    },
                    error: function(k, l) {
                        p3.displayError("Error loading Roster.")
                    }
                })
            })
        },
        showDetails: function(j) {
            var k = this,
                i = $(j.currentTarget);
            $("#details-region").show();
            $("#student-detail-region").hide();
            $("ul.roster-list li").removeClass("pri-100-bgc selected");
            $(".roster-listing").removeClass("white-fgc");
            $(".roster-submitted").removeClass("white-fgc");
            i.parents("li").addClass("pri-100-bgc selected");
            i.find(".roster-listing").addClass("white-fgc");
            $(".assign-detail-desc").addClass("white-fgc");
            if (k.options.discussionInd) {
                k.trigger("detailsSelected")
            }
            j.preventDefault()
        }
    });
    a.Vs.RosterCellView = Bb.View.extend({
        template: "assignmentdetails/rostercell.template.html",
        tagName: "td",
        events: {
            "click .detail-expand-button": "doDetailToggle",
            "click .drop-box-remove-file": "doRemoveFile",
            "click .resubmit-link": "doResubmit",
            keydown: "doKeyFilter",
            refreshfiles: "buildFilesList"
        },
        render: function(i) {
            $(i).html(this.el)
        },
        renderTemplate: function() {
            var i = this;
            p3.fT(i.template, function(j) {
                i.$el.html(j({
                    dropbox: i.options.dropbox,
                    grades: i.options.gradebook,
                    student: i.model.toJSON(),
                    aiid: a.Data.Aiid
                }));
                if (i.model.get("scale_id") > 0) {
                    p3.rV(new a.Vs.GradeSelectView({
                        model: i.model,
                        collection: a.Data.Scale
                    }), i.$el.find(".controls"), false)
                } else {
                    p3.rV(new a.Vs.GradeInputView({
                        model: i.model
                    }), i.$el.find(".controls"), false)
                }
            })
        },
        doDetailToggle: function(i) {
            $(i.currentTarget).siblings(".assignment-details-student-files-detail").toggle()
        },
        doResubmit: function(l) {
            var i = $(l.currentTarget),
                m = i.data("sid"),
                k = i.data("dbid"),
                j = new a.Vs.ResubmitConfirmation({
                    dbid: k,
                    sid: m,
                    aiid: a.Data.Aiid,
                    collection: this.collection
                });
            p3.rV(j, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            return false
        },
        doRemoveFile: function(l) {
            var i = $(l.currentTarget),
                m = i.data("fileId"),
                n = i.data("sid"),
                k = i.data("dbid"),
                j = new a.Vs.RemoveConfirmation({
                    fileId: m,
                    dbid: k,
                    sid: n,
                    aiid: a.Data.Aiid,
                    target: i.closest(".attached-file-container")
                });
            p3.rV(j, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            return false
        },
        buildFilesList: function() {
            var j = this,
                i = this.model;
            a.Us.buildFilesList(i, j)
        },
        doKeyFilter: function(k) {
            var j = $(k.target),
                i = j.closest("tr");
            switch (k.keyCode) {
                case 9:
                case 13:
                case 40:
                    i = i.next();
                    if (i !== undefined && i.length > 0) {
                        i.find(".grade-input").focus();
                        k.preventDefault()
                    } else {
                        j.blur().focus()
                    }
                    break;
                case 38:
                    i = i.prev();
                    if (i !== undefined && i.length > 0) {
                        i.find(".grade-input").focus();
                        k.preventDefault()
                    } else {
                        j.blur().focus()
                    }
                    break;
                case 32:
                    j.dblclick();
                    return false;
                default:
                    break
            }
        }
    });
    a.Vs.GradeInputView = Bb.View.extend({
        events: {
            mouseenter: "inputEnter",
            mouseleave: "inputLeave",
            dblclick: "doGradeDetail",
            change: "doSave"
        },
        render: function(j) {
            var i, k = (p3.Config.uiVersion === 3) ? "width:55px;" : "height:15px; width:50px;";
            $(j).html(this.el);
            i = $("<input>", {
                type: "text",
                "class": "pull-right grade-input form-control",
                style: k,
                placeholder: "Grade",
                maxlength: "6"
            }).appendTo(this.$el);
            i.val((this.model.get("points_earned") > -1) ? this.model.get("points_earned") : "")
        },
        inputEnter: function() {
            this.$el.tooltip("show")
        },
        inputLeave: function() {
            this.$el.tooltip("hide")
        },
        doSave: function(k) {
            var q = this,
                j = $(k.currentTarget).find("input"),
                i = j.parent(),
                n = q.model.get("user_id"),
                o = j.val(),
                m = 0;
            m = _.find(a.Data.Assignment.get("SectionLinks"), function(r) {
                return r.SectionId == a.Data.SectionId
            });
            if ((o || o === "")) {
                if (q.model.get("points_earned") != o) {
                    var l = new g.Ms.GradebookSave();
                    var p = new g.Ms.Gradebook();
                    l.set({
                        AssignmentId: a.Data.Aid,
                        StudentUserId: n,
                        PointsEarned: o || -2,
                        ValueId: -1,
                        Exempt: false,
                        Incomplete: false,
                        Late: false,
                        DaysLate: 0,
                        Comment: q.model.get("comment"),
                        status: "save"
                    });
                    p.on("error", q.itemError, q);
                    p.set({
                        ScaleId: -1,
                        DaysLate: 0,
                        AssignmentId: a.Data.Aid,
                        StudentUserId: n
                    });
                    if (!p.set({
                            status: "save",
                            PointsEarned: o
                        })) {
                        return false
                    }
                    j.closest(".control-group").removeClass("error");
                    j.closest(".controls").removeAttr("data-original-title");
                    p3.loadingIcon(i);
                    a.Data.SaveCollection.add(l);
                    new g.Ms.GradebookSave().save({
                        sectionId: a.Data.SectionId,
                        markingPeriodId: m.MarkingPeriodId,
                        xmlData: JSON.stringify(a.Data.SaveCollection)
                    }, {
                        success: function(s, t) {
                            i.children(".textcenter").replaceWith(j);
                            a.Data.SaveCollection.reset(null, {
                                silent: true
                            });
                            if (l.get("PointsEarned") !== -2) {
                                a.Data.GradedCount += 1
                            }
                            $("#current-graded-count").html(a.Data.GradedCount);
                            $(".resubmit-link[data-sid='" + n + "']").remove();
                            q.trigger("gradeChange")
                        },
                        error: function(s, t) {
                            p3.displayError("Error on Grade Book save");
                            a.Data.SaveCollection.reset(null, {
                                silent: true
                            });
                            i.children(".textcenter").replaceWith(j)
                        }
                    })
                }
            }
        },
        itemError: function(k, j) {
            var i = this.find("input").closest(".control-group");
            if (i !== undefined) {
                j.each(function(l) {
                    if (l.get("item") === "PointsEarned") {
                        i.addClass("error").find(".controls").attr("data-original-title", l.get("message"))
                    }
                })
            }
        },
        doGradeDetail: function(i) {
            var k = this,
                j = k.model.get("user_id");
            if (a.Data.MarkingPeriods === undefined) {
                a.Data.MarkingPeriods = new a.Cs.MarkingPeriods()
            }
            if (a.Data.MarkingPeriods.length <= 0) {
                a.Data.MarkingPeriods.fetch({
                    data: {
                        sectionList: a.Data.SectionId
                    },
                    success: function(l, m) {
                        k.launchGradeDetail(j)
                    },
                    error: function(l, m) {
                        p3.displayError("Error retreiving Marking Period Information.")
                    }
                })
            } else {
                k.launchGradeDetail(j, i)
            }
        },
        launchGradeDetail: function(l, i) {
            var n = this,
                k = _.find(a.Data.Assignment.get("SectionLinks"), function(o) {
                    return o.SectionId == a.Data.SectionId
                });
            var j = new g.Ms.Gradebook({
                    AssignmentId: a.Data.Aid,
                    StudentUserId: l
                }).on("change", function() {
                    if (j.get("status") === "save") {
                        a.Data.SaveCollection.add(j);
                        new g.Ms.GradebookSave().save({
                            sectionId: a.Data.SectionId,
                            markingPeriodId: k.MarkingPeriodId,
                            xmlData: JSON.stringify(a.Data.SaveCollection)
                        }, {
                            success: function(o, p) {
                                $(i.currentTarget).find("input").val(j.get("PointsEarned") == -2 ? "" : j.get("PointsEarned"));
                                a.Data.SaveCollection.reset(null, {
                                    silent: true
                                });
                                p3.showModal(p3.Layout.Containers.Modal, "hide");
                                if (j.get("ValueId") !== -1) {
                                    a.Data.GradedCount += 1
                                }
                                $("#current-graded-count").html(a.Data.GradedCount);
                                $(".resubmit-link[data-sid='" + l + "']").remove();
                                n.trigger("gradeChange")
                            },
                            error: function(o, p) {
                                p3.displayError("Error on Grade Book save");
                                a.Data.SaveCollection.reset(null, {
                                    silent: true
                                })
                            }
                        })
                    }
                }, this),
                m = new Bbm({
                    sectionId: a.Data.SectionId,
                    markingPeriodId: k.MarkingPeriodId
                });
            p3.rV(new g.Vs.Detail({
                model: j,
                values: m
            }), p3.Layout.Containers.Modal, true);
            p3.Layout.Containers.Modal.on("hide  hide.bs.modal", function() {
                $(i.currentTarget).find("input").focus();
                $(this).off("hide hide.bs.modal")
            })
        }
    });
    a.Vs.GradeSelectView = Bb.View.extend({
        events: {
            dblclick: "doGradeDetail",
            "change select": "doSave"
        },
        initialize: function(i) {
            a.Data.Scale.on("reset", this.renderTemplate, this)
        },
        render: function(i) {
            $(i).html(this.el);
            $("<SELECT>", {
                "class": "input-mini grade-input",
                "data-model-member": "ValueId"
            }).append($("<option>", {
                value: "-1"
            })).appendTo(this.$el);
            this.renderTemplate()
        },
        renderTemplate: function() {
            var j = this,
                i = this.$el.find("select");
            a.Data.Scale.each(function(k) {
                if (k.get("ScaleId") === j.model.get("scale_id")) {
                    i.append($("<option>", {
                        value: k.get("ValueId")
                    }).append(k.get("ScaleLetter")))
                }
            });
            i.val(this.model.get("value_id"))
        },
        doSave: function(k) {
            var q = this,
                j = $(k.currentTarget),
                i = j.parent(),
                n = q.model.get("user_id"),
                o = j.val(),
                m = 0;
            m = _.find(a.Data.Assignment.get("SectionLinks"), function(r) {
                return r.SectionId == a.Data.SectionId
            });
            if ((o || o === "")) {
                if (q.model.get("points_earned") != o) {
                    var l = new g.Ms.GradebookSave();
                    var p = new g.Ms.Gradebook();
                    l.set({
                        AssignmentId: a.Data.Aid,
                        StudentUserId: n,
                        PointsEarned: -2,
                        ValueId: o || -1,
                        ScaleId: q.model.get("scale_id"),
                        Exempt: false,
                        Incomplete: false,
                        Late: false,
                        DaysLate: 0,
                        Comment: q.model.get("comment"),
                        status: "save"
                    });
                    p.on("error", q.itemError, q);
                    p.set({
                        ScaleId: q.model.get("scale_id"),
                        DaysLate: 0,
                        AssignmentId: a.Data.Aid,
                        StudentUserId: n
                    });
                    if (!p.set({
                            status: "save",
                            PointsEarned: 2,
                            ValueId: o
                        })) {
                        return false
                    }
                    j.closest(".control-group").removeClass("error");
                    j.closest(".controls").removeAttr("data-original-title");
                    p3.loadingIcon(i);
                    a.Data.SaveCollection.add(l);
                    new g.Ms.GradebookSave().save({
                        sectionId: a.Data.SectionId,
                        markingPeriodId: m.MarkingPeriodId,
                        xmlData: JSON.stringify(a.Data.SaveCollection)
                    }, {
                        success: function(s, t) {
                            i.children(".textcenter").replaceWith(j);
                            a.Data.SaveCollection.reset(null, {
                                silent: true
                            });
                            a.Data.GradedCount += 1;
                            $("#current-graded-count").html(a.Data.GradedCount);
                            $(".resubmit-link[data-sid='" + n + "']").remove();
                            q.trigger("gradeChange")
                        },
                        error: function(s, t) {
                            p3.displayError("Error on Grade Book save");
                            a.Data.SaveCollection.reset(null, {
                                silent: true
                            });
                            i.children(".textcenter").replaceWith(j)
                        }
                    })
                }
            }
        },
        doGradeDetail: function(i) {
            var k = this,
                j = k.model.get("user_id");
            if (a.Data.MarkingPeriods === undefined) {
                a.Data.MarkingPeriods = new a.Cs.MarkingPeriods()
            }
            if (a.Data.MarkingPeriods.length <= 0) {
                a.Data.MarkingPeriods.fetch({
                    data: {
                        sectionList: a.Data.SectionId
                    },
                    success: function(l, m) {
                        k.launchGradeDetail(j)
                    },
                    error: function(l, m) {
                        p3.displayError("Error retreiving Marking Period Information.")
                    }
                })
            } else {
                k.launchGradeDetail(j, i)
            }
        },
        launchGradeDetail: function(n, j) {
            var p = this,
                i = $(j.currentTarget),
                m = _.find(a.Data.Assignment.get("SectionLinks"), function(q) {
                    return q.SectionId == a.Data.SectionId
                }),
                l = new Bbc();
            a.Data.Scale.each(function(q) {
                if (q.get("ScaleId") === a.Data.ScaleId) {
                    l.add(q)
                }
            });
            var k = new g.Ms.Gradebook({
                    AssignmentId: a.Data.Aid,
                    StudentUserId: n,
                    ScaleId: a.Data.ScaleId
                }).on("change", function() {
                    if (k.get("status") === "save") {
                        a.Data.SaveCollection.add(k);
                        new g.Ms.GradebookSave().save({
                            sectionId: a.Data.SectionId,
                            markingPeriodId: m.MarkingPeriodId,
                            xmlData: JSON.stringify(a.Data.SaveCollection)
                        }, {
                            success: function(q, s) {
                                i.find("option").removeAttr("selected");
                                var t = "option[value=" + k.get("ValueId") + "]";
                                i.find(t).attr("selected", true);
                                a.Data.SaveCollection.reset(null, {
                                    silent: true
                                });
                                p3.showModal(p3.Layout.Containers.Modal, "hide");
                                a.Data.GradedCount += 1;
                                $("#current-graded-count").html(a.Data.GradedCount);
                                p.trigger("gradeChange")
                            },
                            error: function(q, s) {
                                p3.displayError("Error on Grade Book save");
                                a.Data.SaveCollection.reset(null, {
                                    silent: true
                                })
                            }
                        })
                    }
                }, this),
                o = new Bbm({
                    sectionId: a.Data.SectionId,
                    markingPeriodId: m.MarkingPeriodId,
                    scale: l
                });
            p3.rV(new g.Vs.Detail({
                model: k,
                values: o
            }), p3.Layout.Containers.Modal, true);
            p3.Layout.Containers.Modal.on("hide hide.bs.modal", function() {
                $(j.currentTarget).focus();
                $(this).off("hide hide.bs.modal")
            })
        }
    });
    a.Vs.StudentSubmittedDropBox = Bb.View.extend({
        template: "assignmentdetails/submitted.template.html",
        events: {
            "click .file-annotate-btn": "showFile"
        },
        render: function(i) {
            var j = this;
            $(i).append(this.el);
            p3.fT(j.template, function(o) {
                if (j.collection !== undefined && j.collection.length > 0) {
                    var l = j.collection.at(0),
                        n = " Completed",
                        m = j.collection.length;
                    if (l.get("readyInd") === true) {
                        n = " Completed"
                    } else {
                        if (l.get("readyInd") === false && l.get("dbid") !== null) {
                            n = " In Progress"
                        } else {
                            n = " To Do"
                        }
                    }
                    if (!j.options.onlyGraded || (j.options.onlyGraded && j.options.gradesPublished)) {
                        j.$el.html(o({
                            points: l.get("pointsEarned") || false,
                            maxPoints: l.get("maxPoints") || false,
                            letterGrade: l.get("Letter") || false,
                            parent: p3.Data.Context.getSelectedPersona().Id === 1,
                            status: n,
                            todo: n === " To Do",
                            inProgress: n === " In Progress",
                            submittedTime: a.Us.DateParse(l.get("lastSubmitDate")),
                            details: l.get("dbDetail"),
                            hasFiles: l.get("dbFileId") || false,
                            gradebook: j.options.gradebook || false,
                            onlyGraded: j.options.onlyGraded || false,
                            gradesPublished: j.options.gradesPublished || false
                        }))
                    }
                    var k = $("#drop-box-attached-files");
                    var p = new a.Ms.UserFolder();
                    p.fetch({
                        data: {
                            uid: a.Data.CurrentStudent || p3.Data.Context.get("UserInfo").UserId
                        },
                        success: function() {
                            var r, q, v, t, s, u;
                            v = '<table class="table table-striped table-condensed"><tbody>';
                            for (t = 0; t < m; t++) {
                                s = j.collection.at(t);
                                u = "/app/file/DropBoxFile?aiid=" + a.Data.Aiid + "&uTolken=" + s.get("uuid") + "&tolken=" + s.get("tolken");
                                q = "";
                                r = a.Us.canAnnotate(s.get("dbFileName"));
                                if (r) {
                                    q = '<a href="#" class="btn btn-default btn-mini file-annotate-btn pull-right" data-id="' + s.get("dbFileId") + '" style="margin-right:5px;"><h5><i class="p3icon-reviewReady p3Blue"></i> View</h5></a>'
                                }
                                v += '<tr><td data-name="' + s.get("dbFileName") + '" data-orig-name="' + s.get("dbFileName") + '" data-size="' + s.get("fileSize") + '" data-file-id="' + s.get("dbFileId") + '">' + s.get("dbFileName") + "</td>";
                                v += '<td align="right"><a target="_blank" href="' + u + '" class="attachment-view-link btn btn-default btn-mini pull-right"><i class="p3icon-topicDownload"></i></a>' + q + "</td></tr>"
                            }
                            v += "</tbody></table>";
                            k.html(v)
                        }
                    })
                }
            })
        },
        showFile: function(i) {
            a.Us.showStudentFile(i, this.collection)
        }
    });
    a.Vs.StudentDropBox = Bb.View.extend({
        template: "assignmentdetails/dropbox.template.html",
        events: {
            "click #assignment-dropbox-save": "doSave",
            "click #assignment-dropbox-submit": "doSubmit",
            "click .attachment-remove-link": "doRemove",
            "fileuploaddone .dragRegion": "handleFileDone",
            "fileuploadprogressall .dragRegion": "handleFileProgress",
            "fileuploadfail .dragRegion": "handleFileFail"
        },
        initialize: function(i) {
            this.dropboxInd = i.dropboxInd;
            this.dbid = i.dbid;
            this.fileCount = 0;
            this.uploadedFileCount = 0
        },
        dispose: function() {
            var i = tinyMCE.get("drop-box-text-edit");
            if (i) {
                i.remove();
                i = null
            }
        },
        render: function(i) {
            $(i).append(this.el);
            this.renderTemplate()
        },
        renderTemplate: function() {
            var i = this;
            p3.fT(i.template, function(k) {
                var j = a.Data.Assignment.get("DropboxNumFiles");
                i.$el.html(k({
                    maxFiles: j,
                    multiple: j > 1,
                    allowFiles: j !== 0
                }));
                p3.showHtmlEditor("drop-box-text-edit", p3.Us.Enum.HtmlEditorCategories.LIMITED2LINE, false, undefined, p3.Us.Enum.HtmlEditorEncoding.NUMERIC);
                if (i.collection !== undefined) {
                    i.doLoad()
                } else {
                    p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.jQueryUI, function() {
                        p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.FileUpload, i.initFileUpload, i)
                    })
                }
            })
        },
        doLoad: function() {
            var t = this,
                m = t.collection,
                s = a.Data.Assignment.get("DropboxNumFiles"),
                q, p, r;
            if (m.length > 0 && m.at(0).get("dbid") !== null) {
                var l = m.at(0),
                    k = $("#drop-box-text-edit"),
                    j = $("#attached-files tbody"),
                    n = m.length;
                if (l.get("dbid")) {
                    t.dbid = l.get("dbid")
                } else {
                    t.dbid = undefined
                }
                if (!l.get("readyInd")) {
                    if (l.get("lastSubmitDate")) {
                        $("#submission-status-label").html("Saved: " + a.Us.DateParse(l.get("lastSubmitDate")));
                        $("#status-indicator-label").html("In Progress");
                        $("#status-indicator-button").addClass("btn-warning")
                    }
                    var o = tinyMCE.get("drop-box-text-edit");
                    if (o !== undefined) {
                        o.setContent(l.get("dbDetail") || "")
                    }
                    k.val(l.get("dbDetail"))
                }
                for (q = 0; q < n; q++) {
                    p = m.at(q);
                    r = "/app/file/DropBoxFile?aiid=" + a.Data.Aiid + "&uTolken=" + p.get("uuid") + "&tolken=" + p.get("tolken");
                    if (p !== undefined && p.get("dbFileId") !== null) {
                        j.append('<tr data-name="' + p.get("dbFileName") + '" data-orig-name="' + p.get("dbFileName") + '" data-size="' + p.get("fileSize") + '" data-file-id="' + p.get("dbFileId") + '" data-dbid="' + p.get("dbid") + '"><td><a href ="' + r + '" target="__new">' + p.get("dbFileName") + '</a></td><td class="pull-right"><a href="#" class="attachment-remove-link pull-right btn btn-default btn-small" data-toggle="tooltip" title="Remove/Replace"><i class="p3icon-remove"></i></a></td></tr>');
                        t.fileCount += 1
                    }
                }
                if (t.fileCount >= s) {
                    $(".dragRegion").hide()
                } else {
                    $(".dragRegion").show()
                }
            }
            p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.jQueryUI, function() {
                p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.FileUpload, t.initFileUpload, t)
            })
        },
        doSave: function(j) {
            var n = $("#assignment-dropbox-submit"),
                l = $("#assignment-dropbox-save"),
                o = tinyMCE.get("drop-box-text-edit"),
                p = this;
            l.attr("disabled", "disabled");
            n.attr("disabled", "disabled");
            if (o) {
                o.save()
            }
            var i = $("#drop-box-text-edit").val(),
                k = [],
                m = new a.Ms.DropBoxSave({});
            _.each($("#attached-files tbody").children("tr"), function(q) {
                k.push({
                    Id: $(q).data("fileId") || 0,
                    Type: 0,
                    Name: $(q).data("name"),
                    FullPath: $(q).data("origName"),
                    Size: $(q).data("size")
                })
            });
            m.save({
                DropBoxId: p.dbid !== undefined ? p.dbid : null,
                StudentUserId: a.Data.CurrentStudent || p3.Data.Context.get("UserInfo").UserId,
                AssignmentIndexId: a.Data.Aiid,
                ReadyInd: 0,
                Detail: i,
                Files: k
            }, {
                error: function() {
                    p3.displayError("Error saving Assignment");
                    l.removeAttr("disabled");
                    n.removeAttr("disabled")
                },
                success: function(s, t) {
                    p.dbid = t;
                    var q = new a.Cs.StudentAssignmentDetail();
                    q.fetch({
                        data: {
                            studentId: a.Data.CurrentStudent || p3.Data.Context.get("UserInfo").UserId,
                            AssignmentIndexId: a.Data.Aiid
                        },
                        error: function() {
                            l.removeAttr("disabled");
                            n.removeAttr("disabled")
                        },
                        success: function(v, w) {
                            var x, u = $("#assignment-detail-assignment");
                            if (v.length > 0) {
                                if (v.at(0).get("readyInd") === true) {
                                    x = new a.Vs.StudentSubmittedDropBox({
                                        collection: v
                                    })
                                } else {
                                    x = new a.Vs.StudentDropBox({
                                        dropboxInd: p.options.dropBoxInd,
                                        collection: v
                                    })
                                }
                                if (u.hasClass("span12") || u.hasClass("col-md-12")) {
                                    $("#assignment-detail-assignment").removeClass("span12 col-md-12").addClass("span6 col-md-6");
                                    $("#assignment-detail-extras").addClass("span6 col-md-6")
                                }
                                $(".dragRegion").off("fileuploaddone").off("fileuploadadd")
                            }
                            p3.rV(x, $("#assignment-detail-extras"), true);
                            l.removeAttr("disabled");
                            n.removeAttr("disabled")
                        }
                    })
                }
            })
        },
        doSubmit: function(j) {
            var k = this;
            var i = new a.Vs.SubmitConfirmation({
                dbid: k.dbid,
                form: k
            });
            p3.rV(i, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal)
        },
        doRemove: function(l) {
            var n = this,
                i = $(l.currentTarget),
                m = i.closest("tr").data("fileId"),
                k = i.closest("tr").data("dbid");
            if (m !== undefined && m > 0) {
                var j = new a.Vs.RemoveConfirmation({
                    fileId: m,
                    target: i.closest("tr"),
                    view: n,
                    dbid: k,
                    sid: p3.Data.Context.get("UserInfo").UserId,
                    aiid: a.Data.Aiid
                });
                p3.rV(j, p3.Layout.Containers.Modal, true);
                p3.showModal(p3.Layout.Containers.Modal)
            } else {
                i.closest("tr").remove();
                n.fileCount -= 1;
                $(".dragRegion").show()
            }
            return false
        },
        initFileUpload: function(i) {
            $(".dragRegion").fileupload({
                url: p3.Config.RootPath + "utilities/FileTransferHandler.ashx",
                autoUpload: true,
                dropZone: ".dragRegion"
            })
        },
        handleFileDone: function(j, i) {
            var n = this,
                l = a.Data.Assignment.get("DropboxNumFiles");
            if (n.fileCount < l) {
                var k = i.result[0];
                var m = '<tr data-name="' + k.name + '" data-orig-name="' + k.original_name + '" data-size="' + k.size + '"><td>' + k.original_name + '</td><td class="pull-right"><a href="#" class="attachment-remove-link pull-right btn btn-default btn-small"><i class="p3icon-remove"></i></a></td></tr>';
                $("#attached-files tbody:last").append(m);
                n.fileCount += 1
            }
            if (n.fileCount == l) {
                $(".dragRegion").hide()
            }
            if (i.originalFiles.length == ++n.uploadedFileCount) {
                $("#progress_container").hide();
                $("#assignment-dropbox-save").removeAttr("disabled");
                $("#assignment-dropbox-submit").removeAttr("disabled");
                n.uploadedFileCount = 0
            }
        },
        handleFileFail: function(j, i) {
            var l = this,
                k = document.createElement("a").appendChild(document.createTextNode(i.files[0].name)).parentNode.innerHTML;
            if ($("#Failed_file_upload_msg").length === 0) {
                $("#progress_container").after($("<div>").addClass("alert alert-error").attr("id", "Failed_file_upload_msg").html('<button type="button" class="close" data-dismiss="alert">&times;</button>The file ' + k + " failed to upload. Please make sure the file name does not include special characters"))
            } else {
                $("#Failed_file_upload_msg").append("<br>The file " + k + " failed to upload. Please make sure the file name does not include special characters")
            }
            $("#progress_container").hide();
            $("#assignment-dropbox-save").removeAttr("disabled");
            $("#assignment-dropbox-submit").removeAttr("disabled");
            l.uploadedFileCount = 0
        },
        handleFileAdd: function(j, i) {
            var l = this,
                k = a.Data.Assignment.get("DropboxNumFiles");
            i.files[0].isValidUpload = p3.Us.FileTools.isValidFile(p3.Us.Enum.UploadType.All, i.files[0].name);
            if (l.fileCount == k) {
                return false
            }
            if (i.files[0].isValidUpload) {
                $("#progress_bar").attr("style", "width: 0%");
                $("#progress_container").show();
                $("#assignment-dropbox-save").attr("disabled", "disabled");
                $("#assignment-dropbox-submit").attr("disabled", "disabled");
                i.submit()
            } else {
                $(".drop-box-area > div > .dragRegion").before(p3.Us.FileTools.validateFiles(p3.Us.Enum.UploadType.All, i))
            }
            l.uploadedFileCount = 0
        },
        handleFileProgress: function(j, i) {
            var k = parseInt(i.loaded / i.total * 100, 10);
            $("#progress_bar").attr("style", "width: " + k + "%")
        }
    });
    a.Vs.SubmitConfirmation = Bb.View.extend({
        template: "assignmentdetails/confirm.template.html",
        events: {
            "click #resubmit-cancel-button": "doCancel",
            "click #resubmit-confirm-button": "doSubmit"
        },
        renderTemplate: function() {
            var i = this;
            p3.fT(i.template, function(j) {
                i.$el.html(j({
                    title: "Submit Assignment"
                }));
                p3.Us.InfoMessage.ErrorBox(p3.Us.InfoMessageLibrary.Assignment.AssignmentDetailDropBoxSubmit, ".modal-body", false)
            })
        },
        render: function(i) {
            var j = this;
            $(i).append(this.el);
            j.renderTemplate()
        },
        doSubmit: function(j) {
            if (typeof this.options.submitCallback === "function") {
                p3.showModal(p3.Layout.Containers.Modal, "hide");
                this.options.submitCallback.call(this.options.form, j, true)
            } else {
                $("#resubmit-confirm-button").attr("disabled", "disabled");
                var m = tinyMCE.get("drop-box-text-edit");
                if (m) {
                    m.save()
                }
                var n = this,
                    i = $("#drop-box-text-edit").val(),
                    k = [],
                    l = new a.Ms.DropBoxSave();
                _.each($("#attached-files tbody").children("tr"), function(o) {
                    k.push({
                        Id: $(o).data("fileId") || 0,
                        Type: 0,
                        Name: $(o).data("name"),
                        FullPath: $(o).data("origName"),
                        Size: $(o).data("size")
                    })
                });
                l.save({
                    DropBoxId: n.options.dbid !== undefined ? n.options.dbid : null,
                    StudentUserId: p3.Data.Context.get("UserInfo").UserId,
                    AssignmentIndexId: a.Data.Aiid,
                    ReadyInd: 1,
                    Detail: i,
                    Files: k
                }, {
                    error: function() {
                        p3.displayError("Error saving Assignment");
                        $("#resubmit-confirm-button").removeAttr("disabled")
                    },
                    success: function(p, q) {
                        if (n.options !== undefined) {
                            n.options.form.dbid = q
                        }
                        p3.showModal(p3.Layout.Containers.Modal, "hide");
                        var o = new a.Cs.StudentAssignmentDetail();
                        o.fetch({
                            data: {
                                studentId: p3.Data.Context.get("UserInfo").UserId,
                                AssignmentIndexId: a.Data.Aiid
                            },
                            success: function(s) {
                                var t, r = $("#assignment-detail-assignment");
                                if (s.length > 0) {
                                    if (s.at(0).get("readyInd") === true) {
                                        t = new a.Vs.StudentSubmittedDropBox({
                                            collection: s
                                        })
                                    } else {
                                        t = new a.Vs.StudentDropBox({
                                            dropboxInd: n.options.dropBoxInd,
                                            collection: s
                                        })
                                    }
                                    if (r.hasClass("span12") || r.hasClass("col-md-12")) {
                                        $("#assignment-detail-assignment").removeClass("span12 col-md-12").addClass("span6 col-md-6");
                                        $("#assignment-detail-extras").addClass("span6 col-md-6")
                                    }
                                }
                                p3.rV(t, $("#assignment-detail-extras"), true)
                            }
                        })
                    }
                });
                return false
            }
            j.preventDefault()
        },
        doCancel: function() {
            $("#site-modal").modal("hide");
            return false
        }
    });
    a.Vs.RemoveConfirmation = Bb.View.extend({
        template: "assignmentdetails/confirm.template.html",
        events: {
            "click #resubmit-cancel-button": "doCancel",
            "click #resubmit-confirm-button": "doRemove"
        },
        renderTemplate: function() {
            var i = this;
            p3.fT(i.template, function(j) {
                i.$el.html(j({
                    title: "Remove File"
                }));
                p3.Us.InfoMessage.ErrorBox(p3.Us.InfoMessageLibrary.Assignment.AssignmentDetailRemoveConfirm, ".modal-body", false)
            })
        },
        render: function(i) {
            var j = this;
            $(i).append(this.el);
            j.renderTemplate()
        },
        doRemove: function(i) {
            var k = this;
            var j = new a.Ms.FileRemove();
            j.save({
                fileId: k.options.fileId,
                dropBoxId: k.options.dbid,
                studentId: k.options.sid,
                assignmentIndexId: k.options.aiid
            }, {
                error: function() {
                    p3.showModal(p3.Layout.Containers.Modal, "hide");
                    p3.displayError("Error Removing File.")
                },
                success: function() {
                    p3.showModal(p3.Layout.Containers.Modal, "hide");
                    if (k.options.target !== undefined) {
                        var l = k.options.target.closest(".attachment-bucket"),
                            m = k.options.target.siblings(".attached-file-container");
                        k.options.target.remove();
                        if (k.options.view) {
                            k.options.view.fileCount -= 1;
                            $(".dragRegion").show()
                        } else {
                            if (m.length === 0) {
                                l.siblings("hr").remove();
                                l.remove()
                            }
                        }
                    }
                    a.Data.DropBoxItems.fetch({
                        data: {
                            schoolYear: a.Data.SchoolYear,
                            assignmentId: a.Data.Aid
                        },
                        error: function(n, o) {
                            p3.displayError("Error loading Drop box items.")
                        }
                    })
                }
            });
            return false
        },
        doCancel: function() {
            $("#site-modal").modal("hide");
            return false
        }
    });
    a.Vs.ResubmitConfirmation = Bb.View.extend({
        template: "assignmentdetails/confirm.template.html",
        events: {
            "click #resubmit-cancel-button": "doCancel",
            "click #resubmit-confirm-button": "doResubmit"
        },
        renderTemplate: function() {
            var i = this;
            p3.fT(i.template, function(j) {
                i.$el.html(j({
                    title: "Allow Resubmit"
                }));
                p3.Us.InfoMessage.ErrorBox(p3.Us.InfoMessageLibrary.Assignment.AssignmentDetailAllowResubmit, ".modal-body", false)
            })
        },
        render: function(i) {
            var j = this;
            $(i).append(this.el);
            j.renderTemplate()
        },
        doResubmit: function(i) {
            var k = this;
            var j = new a.Ms.DropBoxSave();
            j.save({
                DropBoxId: k.options.dbid,
                StudentUserId: k.options.sid,
                AssignmentIndexId: k.options.aiid,
                ReadyInd: 0,
                Detail: null,
                FileDetail: null
            }, {
                error: function() {
                    p3.showModal(p3.Layout.Containers.Modal, "hide");
                    p3.displayError("Error Allowing Resubmission")
                },
                success: function() {
                    k.trigger("Resubmit");
                    p3.showModal(p3.Layout.Containers.Modal, "hide")
                }
            });
            if (k.options.collection) {
                k.options.collection.fetch({
                    data: {
                        aiid: a.Data.Aiid,
                        viewerId: p3.Data.Context.get("UserInfo").UserId
                    },
                    error: function(l, m) {
                        p3.displayError("Error loading Drop box items.")
                    }
                })
            }
            a.Data.DropBoxItems.fetch({
                data: {
                    schoolYear: a.Data.SchoolYear,
                    assignmentId: a.Data.Aid
                },
                error: function(l, m) {
                    p3.displayError("Error loading Drop box items.")
                }
            });
            return false
        },
        doCancel: function() {
            $("#site-modal").modal("hide");
            return false
        }
    });
    a.Vs.StudentAssignmentInformation = Bb.View.extend({
        template: "AssignmentDetails/studentassignmentinfo.template.html",
        events: {
            "click #save-button": "doSave",
            "click #sub-button": "doSubmit"
        },
        initialize: function() {
            this.children = {}
        },
        render: function(i) {
            $(i).append(this.el);
            this.renderTemplate()
        },
        renderTemplate: function() {
            var i = this;
            p3.fT(i.template, function(k) {
                var j = ((i.model.get("assignmentStatus") === 4 && i.model.get("readyInd")) || i.model.get("assignmentStatus") === 1 || !i.options.assignment.get("DropboxInd"));
                i.$el.html(k({
                    hideFooter: j
                }));
                i.children.header = new a.Vs.StudentInformationHeader({
                    model: i.model,
                    assignment: i.options.assignment
                });
                i.children.files = new a.Vs.StudentFileAttachments({
                    model: i.model,
                    assignment: i.options.assignment,
                    collection: i.options.files
                });
                i.children.textedit = new a.Vs.StudentSubmissionText({
                    model: i.model,
                    assignment: i.options.assignment
                });
                p3.rV(i.children.header, "#assignment-info-header", true);
                p3.rV(i.children.files, "#assignment-info-files", true);
                p3.rV(i.children.textedit, "#assignment-info-textedit", true);
                if (!i.options.onlineSubmit) {
                    $("#assignment-info-files").hide();
                    $("#assignment-info-textedit").hide()
                }
            })
        },
        refreshView: function() {
            var i = this;
            this.options.files.fetch({
                data: {
                    studentId: a.Data.CurrentStudent || p3.Data.Context.get("UserInfo").UserId,
                    AssignmentIndexId: a.Data.Aiid
                },
                success: function(j) {
                    if (j.length > 0) {
                        i.model = j.at(0);
                        i.renderTemplate()
                    }
                }
            })
        },
        doSave: function(j, m) {
            var q = this,
                i = q.children.textedit.getText(),
                p = $("#sub-button"),
                n = $("#save-button"),
                k = $(".assignment-file-attach-box .btn"),
                l = q.children.files.getFiles(),
                o = new a.Ms.DropBoxSave({});
            n.attr("disabled", "disabled");
            p.attr("disabled", "disabled");
            k.attr("disabled", "disabled");
            o.save({
                DropBoxId: q.model.get("dbid") !== undefined ? q.model.get("dbid") : null,
                StudentUserId: p3.Data.Context.get("UserInfo").UserId,
                AssignmentIndexId: a.Data.Aiid,
                ReadyInd: m ? 1 : 0,
                Detail: i,
                Files: l
            }, {
                error: function() {
                    p3.displayError("Error saving Assignment");
                    n.removeAttr("disabled");
                    p.removeAttr("disabled");
                    k.removeAttr("disabled")
                },
                success: function() {
                    q.refreshView();
                    n.removeAttr("disabled");
                    p.removeAttr("disabled");
                    k.removeAttr("disabled")
                }
            })
        },
        doSubmit: function(j) {
            var k = this;
            var i = new a.Vs.SubmitConfirmation({
                dbid: k.dbid,
                form: k,
                submitCallback: k.doSave
            });
            p3.rV(i, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal)
        }
    });
    a.Vs.StudentInformationHeader = Bb.View.extend({
        template: "",
        tagName: "div",
        className: "assignment-detail-header",
        events: {
            statusChange: "doChangeStatus"
        },
        render: function(i) {
            $(i).html(this.el);
            var j = new a.Vs.HeaderStatusIndicator({
                userManaged: !this.options.assignment.get("DropboxInd"),
                model: this.model,
                assignment: this.options.assignment
            });
            p3.rV(j, this.$el, false);
            if (this.$el.find(".assignment-detail-header-info").length === 0) {
                this.$el.append($("<span>").addClass("assignment-detail-header-info"))
            }
        },
        doChangeStatus: function(n) {
            var o = n.statusCode,
                i = this.$el.find(".assignment-detail-header-info"),
                m = this.model.get("ddate"),
                q = this.model.get("lastSubmitDate"),
                l = m ? d.getDate(m) : undefined,
                p = q ? d.getDate(q) : undefined,
                k = Math.round(((l.getTime() - d.localDateTime().getTime()) / (24 * 60 * 60 * 1000))),
                j = ["Sun", "Mon", "Tues", "Wed", "Thur", "Fri", "Sat"];
            this.$el.removeClass("todo inprogress overdue completed");
            if (i.length === 0) {
                this.$el.append($("<span>").addClass("assignment-detail-header-info"));
                i = this.$el.find(".assignment-detail-header-info")
            }
            if (k > 0) {
                i.text(k > 1 ? ("Due in " + k + " Days") : "Due Tomorrow")
            } else {
                if (k < 0) {
                    i.text("Overdue by " + Math.abs(k) + " Day" + (k < -1 ? "s" : ""))
                } else {
                    i.text("Due Today")
                }
            }
            switch (o) {
                case -1:
                    this.$el.addClass("todo");
                    break;
                case 0:
                    this.$el.addClass("inprogress");
                    break;
                case 1:
                    this.$el.addClass("completed");
                    if (this.model.get("lastSubmitDate") !== undefined && this.model.get("lastSubmitDate") !== null) {
                        p = d.getDate(this.model.get("lastSubmitDate"));
                        i.text("Submitted on " + j[p.getDay()] + " " + a.Us.DateParse(this.model.get("lastSubmitDate")))
                    } else {
                        i.text("")
                    }
                    break;
                case 2:
                    this.$el.addClass("overdue");
                    break;
                case 3:
                    break;
                case 4:
                    this.$el.addClass("completed");
                    if (this.model.get("readyInd") == 0) {
                        i.text("Not Submitted")
                    } else {
                        if (this.model.get("lastSubmitDate") !== undefined && this.model.get("lastSubmitDate") !== null) {
                            i.text("Submitted on " + j[p.getDay()] + " " + a.Us.DateParse(this.model.get("lastSubmitDate")))
                        } else {
                            i.text("")
                        }
                    }
                    break;
                default:
                    this.$el.addClass("todo");
                    break
            }
        }
    });
    a.Vs.HeaderStatusIndicator = Bb.View.extend({
        template: "",
        tagName: "div",
        className: "indicator-parent",
        events: {
            "click .assignment-status-link": "doStatusChange"
        },
        initialize: function() {
            this.isSelfManaged = this.options.userManaged || false
        },
        render: function(j) {
            var i = $("<div>").addClass("indicator-field p3formWhite");
            if (this.isSelfManaged && !this.model.get("readyInd") && !(this.model.get("assignmentStatus") == 4)) {
                this.$el.addClass("dropdown");
                i.addClass("dropdown-toggle assignment-status-button");
                i.append($("<span>").addClass("caret"));
                i.dropdown()
            } else {
                i.append($("<i>").addClass("iconColor"))
            }
            i.append($("<span>").addClass("assignment-detail-status-label"));
            this.$el.html(i);
            if (this.isSelfManaged && !this.model.get("readyInd") && !(this.model.get("assignmentStatus") == 4)) {
                this.renderStatusMenu(this.el, this.model.get("assignmentStatus"))
            }
            $(j).append(this.el);
            this.setStatus(this.model.get("assignmentStatus"))
        },
        renderStatusMenu: function(i, k) {
            var l = $("<ul>").addClass("dropdown-menu"),
                j = d.getDate(this.model.get("ddate"));
            if (j > d.localDateTime()) {
                l.append($("<li>", {
                    "class": "status-needs-action"
                }).append($("<a>", {
                    "class": "assignment-status-link",
                    href: "#",
                    "data-status": "-1",
                    text: "To Do"
                })))
            } else {
                l.append($("<li>", {
                    "class": "status-overdue"
                }).append($("<a>", {
                    "class": "assignment-status-link",
                    href: "#",
                    "data-status": "2",
                    text: "Overdue"
                })))
            }
            l.append($("<li>", {
                "class": "status-in-progress"
            }).append($("<a>", {
                "class": "assignment-status-link",
                href: "#",
                "data-status": "0",
                text: "In Progress"
            })));
            l.append($("<li>", {
                "class": "status-completed"
            }).append($("<a>", {
                "class": "assignment-status-link",
                href: "#",
                "data-status": "1",
                text: "Completed"
            })));
            $(i).append(l)
        },
        setStatus: function(k) {
            if (typeof k !== "number") {
                k = $(k.currentTarget).data("status")
            }
            var j = this.$el.find(".assignment-detail-status-label"),
                i = this.$el.find("i");
            i.attr("class", "");
            if (this.model.get("pointsEarned") || this.model.get("Letter")) {
                i.attr("class", "p3icon-ok iconColor")
            } else {
                if (this.model.get("readyInd")) {
                    i.attr("class", "p3icon-check iconColor")
                } else {
                    if (this.options.assignment.get("AssessmentInd")) {
                        i.attr("class", "p3icon-notification iconColor")
                    } else {
                        if (this.options.assignment.get("DropboxInd")) {
                            i.attr("class", "p3icon-assignmentUpload iconColor")
                        }
                    }
                }
            }
            switch (k) {
                case -1:
                    if (this.options.assignment.get("DropboxInd")) {
                        j.text(" Submit")
                    } else {
                        j.text(" To Do")
                    }
                    break;
                case 0:
                    j.text(" In Progress");
                    break;
                case 1:
                    j.text(" Completed");
                    i.attr("class", "p3icon-check iconColor");
                    break;
                case 2:
                    j.text(" Overdue");
                    break;
                case 3:
                    break;
                case 4:
                    if (this.model.get("pointsEarned") && this.options.assignment.get("PublishGrade")) {
                        j.text(" Graded: " + this.model.get("pointsEarned") + " of " + this.model.get("maxPoints"))
                    } else {
                        if (this.model.get("Letter") && this.options.assignment.get("PublishGrade")) {
                            j.text(" Graded: " + this.model.get("Letter"))
                        } else {
                            j.text(" Graded")
                        }
                    }
                    i.attr("class", "p3icon-ok iconColor");
                    break
            }
            this.$el.trigger(jQuery.Event("statusChange", {
                statusCode: k
            }))
        },
        doStatusChange: function(j) {
            var i = a.Data.Aiid,
                k = $(j.currentTarget).data("status"),
                m = this;
            if (this.model.get("assignmentStatus") !== k) {
                var l = new a.Ms.AssignmentStatusUpdate();
                l.save({
                    assignmentIndexId: i,
                    assignmentStatus: k
                }, {
                    success: function() {
                        m.model.set("assignmentStatus", k);
                        m.setStatus(k)
                    },
                    error: function() {
                        p3.displayError("Error updating assignment status")
                    }
                })
            }
            j.preventDefault()
        }
    });
    a.Vs.StudentFileAttachments = Bb.View.extend({
        template: "AssignmentDetails/FileAttachment.template.html",
        events: {
            "click .attachment-button": "launchAttachmentBrowser",
            "click .assignment-attachment-remove": "doRemoveFiles",
            "click .file-viewer-button": "showFile"
        },
        initialize: function() {
            var i = this;
            i.attachedFiles = new Bbc();
            if (i.collection !== undefined) {
                i.collection.each(function(j) {
                    if (j.get("dbFileName") !== undefined && j.get("dbFileName") !== null) {
                        i.attachedFiles.push(new Bbm({
                            fileName: j.get("dbFileName"),
                            size: j.get("fileSize"),
                            id: j.get("dbFileId"),
                            googleDocInd: j.get("googleDocInd"),
                            googleExternalId: j.get("googleExternalId"),
                            googleExternalUrl: j.get("googleExternalUrl")
                        }))
                    }
                    j.set("link", "/app/file/DropBoxFile?aiid=" + a.Data.Aiid + "&uTolken=" + j.get("uuid") + "&tolken=" + j.get("tolken"))
                })
            }
            i.attachedFileCount = i.attachedFiles.length;
            i.model.on("change", i.renderTemplate, i);
            _.bindAll(this, "doAttachFiles")
        },
        dispose: function() {
            this.model.off("change")
        },
        render: function(i) {
            $(i).append(this.el);
            this.renderTemplate()
        },
        renderTemplate: function() {
            var i = this;
            p3.fT(i.template, function(o) {
                var k = (i.attachedFileCount > 0 && i.collection !== undefined) ? i.collection.toJSON() : null,
                    m = i.options.assignment !== undefined ? i.attachedFileCount < i.options.assignment.get("DropboxNumFiles") : false,
                    l;
                if (i.model.get("readyInd") && k) {
                    for (l = 0; l < k.length; l++) {
                        k[l].canAnnotate = a.Us.canAnnotate(k[l].dbFileName);
                        k[l].FileSizeDisplay = a.Us.FileSizeDisplay(k[l].fileSize)
                    }
                }
                if (k || m) {
                    var n = i.model.get("readyInd");
                    var j = false;
                    if (!n) {
                        j = i.options.assignment !== undefined ? i.attachedFileCount < i.options.assignment.get("DropboxNumFiles") : false
                    }
                    i.$el.html(o({
                        files: k,
                        attachMore: j,
                        submitted: n,
                        attached: i.attachedFileCount,
                        max: i.options.assignment.get("DropboxNumFiles")
                    }))
                }
            })
        },
        launchAttachmentBrowser: function(i) {
            var l = this,
                j, k;
            k = l.options.assignment.get("DropboxNumFiles") > 0 ? l.options.assignment.get("DropboxNumFiles") : 0;
            k = k - (l.attachedFileCount > 0 ? l.attachedFileCount : 0);
            j = new f.Vs.AttachFilesModal({
                googleDriveAllowed: true,
                googleLinksPermitted: true,
                permittedFileCount: k,
                visibleFileLimit: true,
                receiveFilesCallback: l.doAttachFiles
            });
            p3.rV(j, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            p3.initModalHeightTimer(p3.Layout.Containers.Modal)
        },
        getFiles: function() {
            var i = [];
            this.attachedFiles.each(function(j) {
                if (j.get("tempName") && j.get("fileName")) {
                    i.push({
                        Id: j.get("id") || 0,
                        Type: 0,
                        Name: j.get("tempName"),
                        FullPath: j.get("fileName"),
                        Size: j.get("size") || 0,
                        GoogleDocInd: j.get("GoogleDocInd"),
                        GoogleExternalId: j.get("googleExternalId"),
                        GoogleExternalUrl: j.get("googleExternalUrl")
                    })
                } else {
                    i.push({
                        Id: j.get("id") || 0,
                        Type: 0,
                        Name: j.get("fileName"),
                        Size: j.get("size") || 0,
                        GoogleDocInd: j.get("GoogleDocInd"),
                        GoogleExternalId: j.get("googleExternalId"),
                        GoogleExternalUrl: j.get("googleExternalUrl")
                    })
                }
            });
            return i
        },
        getUniqueFileName: function(m) {
            var o = this,
                n = m,
                l = function() {
                    return o.attachedFiles.find(function(p) {
                        return p.get("fileName") === n
                    })
                },
                k = m.substr(0, m.lastIndexOf(".")),
                j = m.substr(m.lastIndexOf(".") + 1, m.length),
                i = 0;
            while (l() && i < 25) {
                i++;
                n = k + " (" + i + ")." + j
            }
            return n
        },
        doAttachFiles: function(i) {
            var n = this,
                m, k, j, l;
            p3.fT("AssignmentDetails/fileattachment.file.detail.template.html", function(o) {
                i.each(function(p) {
                    m = n.getUniqueFileName(p.getFileName());
                    l = p.isGoogleDoc();
                    k = new Bbm({
                        fileName: m,
                        size: p.getFileSize(),
                        tempName: p.getTempFileName(),
                        googleDocInd: l,
                        googleExternalId: (l ? p.getGoogleFileId() : null),
                        googleExternalUrl: (l ? p.getGoogleFileUrl() : null)
                    });
                    n.attachedFiles.push(k);
                    j = o({
                        model: k.toJSON()
                    });
                    $("#online-submission-attached-files").append(j);
                    n.attachedFileCount++
                });
                if (n.attachedFileCount === n.options.assignment.get("DropboxNumFiles")) {
                    $("#assignment-attachment-button").hide()
                }
                $("#assignment-detail-attached-files").show();
                $("#files-attached-count").text(n.attachedFileCount)
            })
        },
        doRemoveFiles: function(j) {
            var m = this,
                k = $(j.currentTarget).data("file"),
                l = this.attachedFiles.find(function(n) {
                    return n.get("fileName") === k
                }),
                i = this.collection.find(function(n) {
                    return n.get("dbFileId") === l.get("id")
                });
            if (l !== undefined && l !== null) {
                if (l.get("id") !== undefined && l.get("id") !== null && l.get("id") > 0) {
                    p3.rV(new a.Vs.FileRemoveConfirmation({
                        model: i,
                        deletedCallback: function() {
                            m.attachedFiles.remove(l);
                            $(j.currentTarget).closest("tr").remove();
                            m.attachedFileCount--;
                            if (m.attachedFileCount < m.options.assignment.get("DropboxNumFiles")) {
                                $("#assignment-attachment-button").show()
                            }
                            if (m.attachedFileCount === 0) {
                                $("#assignment-detail-attached-files").hide()
                            }
                            $("#files-attached-count").text(m.attachedFileCount)
                        },
                        context: m
                    }), p3.Layout.Containers.Modal, true);
                    p3.showModal(p3.Layout.Containers.Modal)
                } else {
                    this.attachedFiles.remove(l);
                    $(j.currentTarget).closest("tr").remove();
                    m.attachedFileCount--;
                    if (m.attachedFileCount < m.options.assignment.get("DropboxNumFiles")) {
                        $("#assignment-attachment-button").show()
                    }
                    if (m.attachedFileCount === 0) {
                        $("#assignment-detail-attached-files").hide()
                    }
                    $("#files-attached-count").text(m.attachedFileCount)
                }
            }
        },
        showFile: function(i) {
            a.Us.showStudentFile(i, this.collection)
        }
    });
    a.Vs.StudentSubmissionText = Bb.View.extend({
        template: "",
        events: {},
        initialize: function() {
            if (this.options.assignment !== undefined) {
                this.editMode = this.options.assignment.get("DropboxInd") && !this.model.get("readyInd")
            } else {
                this.editMode = this.options.editmode || false
            }
        },
        dispose: function() {
            var i = tinyMCE.get("online-submission-text");
            if (i) {
                i.remove();
                i = null
            }
        },
        render: function(i) {
            var k = "online-submission-text",
                j = this.model.get("dbDetail") || "";
            $(i).append(this.el);
            if (this.editMode) {
                this.$el.addClass("online-submission-text-container");
                var l = $("<textarea>", {
                    id: k,
                    "class": "assignment-detail-text-editor",
                    value: j
                });
                this.$el.append($("<h5>", {
                    "class": "muted",
                    text: "Online Submission Text"
                }));
                this.$el.append(l);
                p3.showHtmlEditor(k, p3.Us.Enum.HtmlEditorCategories.LIMITED2LINE, false, function() {
                    tinyMCE.get(k).setContent(j)
                }, p3.Us.Enum.HtmlEditorEncoding.NUMERIC)
            } else {
                if (j !== undefined && j !== null && j !== "") {
                    this.$el.addClass("online-submission-text-container")
                } else {
                    $("#assignment-info-textedit").hide()
                }
                this.$el.html(j)
            }
        },
        getText: function() {
            if (this.editMode) {
                var i = tinyMCE.get("online-submission-text");
                if (i !== undefined && i !== null) {
                    i.save()
                }
                return $("#online-submission-text").val()
            }
            return this.$el.html()
        }
    });
    a.Vs.FileRemoveConfirmation = Bb.View.extend({
        template: "assignmentdetails/confirm.template.html",
        events: {
            "click #resubmit-cancel-button": "doCancel",
            "click #resubmit-confirm-button": "doRemove"
        },
        renderTemplate: function() {
            var i = this;
            p3.fT(i.template, function(j) {
                i.$el.html(j({
                    title: "Remove File"
                }));
                p3.Us.InfoMessage.ErrorBox(p3.Us.InfoMessageLibrary.Assignment.AssignmentDetailRemoveConfirm, ".modal-body", false)
            })
        },
        render: function(i) {
            var j = this;
            $(i).append(this.el);
            j.renderTemplate()
        },
        doRemove: function(i) {
            var k = this;
            var j = new a.Ms.FileRemove();
            j.save({
                fileId: k.model.get("dbFileId"),
                dropBoxId: k.model.get("dbid"),
                studentId: p3.Data.Context.get("UserInfo").UserId,
                assignmentIndexId: a.Data.Aiid
            }, {
                error: function() {
                    p3.showModal(p3.Layout.Containers.Modal, "hide");
                    p3.displayError("Error Removing File.")
                },
                success: function() {
                    p3.showModal(p3.Layout.Containers.Modal, "hide");
                    if (typeof k.options.deletedCallback === "function") {
                        k.options.deletedCallback.call(k.options.context)
                    }
                }
            });
            return false
        },
        doCancel: function() {
            $("#site-modal").modal("hide");
            return false
        }
    });
    a.Vs.GradeEdit = Bb.View.extend({
        template: "assignmentdetails/grade.edit.template.html",
        events: {
            "change #scale-dropdown": "scaleChange",
            "click #exempt-btn": "exemptChange",
            "click #incomplete-btn": "incompleteChange",
            "click #late-button": "lateChange",
            "click #missing-btn": "missingChange",
            "change #days-box": "daysChange",
            "change #points-box": "pointsChange",
            "click .drop-box-remove-file": "doRemoveFile",
            "click #comment-btn": "commentClick",
            "click .file-annotate-btn": "showFile",
            "click #resubmit-button": "resubmitClick"
        },
        renderTemplate: function() {
            var k = this,
                j;
            j = _.find(a.Data.Assignment.get("SectionLinks"), function(l) {
                return l.SectionId == a.Data.SectionId
            });
            k.section = j;
            if (a.Data.GradeBookIndicator) {
                var i = new g.Ms.Detail();
                k.details = i;
                i.fetch({
                    data: {
                        sectionId: a.Data.SectionId,
                        markingPeriodId: j.MarkingPeriodId,
                        studentUserId: k.model.get("user_id"),
                        assignmentId: a.Data.Aid
                    },
                    success: function(l, m) {
                        p3.fT(k.template, function(n) {
                            k.$el.html(n({
                                rosterItem: k.options.model.toJSON(),
                                details: i.toJSON(),
                                schoolId: p3.Data.SchoolContext.get("SchoolInfo").SchoolId,
                                scale: a.Data.Scale.toJSON(),
                                dropBox: a.Data.DropBoxIndicator,
                                gradebook: a.Data.GradeBookIndicator,
                                imagePath: p3.Config.CssImagePath,
                                discussionInd: k.options.discussionInd
                            }));
                            if (i.get("PointsEarned") == null) {
                                i.set("PointsEarned", -2)
                            }
                            if (i.get("ValueId") == null) {
                                i.set("ValueId", -1)
                            }
                            if (i.get("Exempt") == null) {
                                i.set("Exempt", false)
                            }
                            if (i.get("Incomplete") == null) {
                                i.set("Incomplete", false)
                            }
                            if (i.get("Late") == null) {
                                i.set("Late", false)
                            }
                            if (i.get("Missing") == null) {
                                i.set("Missing", false)
                            }
                            if (i.get("DaysLate") == null) {
                                i.set("DaysLate", 0)
                            }
                            if (i.get("Comment") == null) {
                                i.set("Comment", "")
                            }
                            if (i.get("ScaleId") == null) {
                                i.set("ScaleId", 0)
                            }
                            i.set("status", "save");
                            i.set("StudentUserId", k.model.get("user_id"));
                            i.set("AssignmentId", a.Data.Aid)
                        })
                    },
                    error: function() {
                        p3.displayError("Error gradebook detail")
                    }
                })
            } else {
                p3.fT(k.template, function(l) {
                    k.$el.html(l({
                        rosterItem: k.options.model.toJSON(),
                        schoolId: p3.Data.SchoolContext.get("SchoolInfo").SchoolId,
                        scale: a.Data.Scale.toJSON(),
                        dropBox: a.Data.DropBoxIndicator,
                        gradebook: a.Data.GradeBookIndicator,
                        imagePath: p3.Config.CssImagePath,
                        discussionInd: k.options.discussionInd
                    }))
                })
            }
        },
        render: function(i) {
            var j = this;
            $(i).append(this.el);
            j.renderTemplate()
        },
        scaleChange: function(i) {
            var j = this;
            j.details.set("ValueId", $("#scale-dropdown").val());
            j.saveDetails()
        },
        exemptChange: function(i) {
            var j = this;
            j.details.set("Exempt", !$("#exempt-btn").hasClass("active"));
            j.saveDetails()
        },
        incompleteChange: function(i) {
            var j = this;
            j.details.set("Incomplete", !$("#incomplete-btn").hasClass("active"));
            j.saveDetails()
        },
        lateChange: function(i) {
            var j = this;
            j.details.set("Late", !$("#late-button").hasClass("active"));
            j.saveDetails()
        },
        missingChange: function(i) {
            var j = this;
            j.details.set("Missing", !$("#missing-btn").hasClass("active"));
            j.saveDetails()
        },
        daysChange: function(i) {
            var j = this;
            j.details.set("DaysLate", $("#days-box").val());
            j.saveDetails()
        },
        pointsChange: function(i) {
            var j = this;
            if ($("#points-box").val()) {
                j.details.set("PointsEarned", $("#points-box").val());
                $("#resubmit-button").hide()
            } else {
                j.details.set("PointsEarned", -2);
                $("#resubmit-button").show()
            }
            j.saveDetails()
        },
        saveDetails: function() {
            var k = this,
                j = new g.Ms.GradebookSave(),
                i = new Bbc();
            i.add(k.details);
            j.save({
                sectionId: a.Data.SectionId,
                markingPeriodId: k.section.MarkingPeriodId,
                xmlData: JSON.stringify(i)
            }, {
                error: function(l, n) {
                    p3.displayError("Error on Grade Book save")
                },
                success: function() {
                    k.trigger("detailEdited")
                }
            })
        },
        doRemoveFile: function(l) {
            var i = $(l.currentTarget),
                m = i.data("fileId"),
                n = i.data("sid"),
                k = i.data("dbid"),
                j = new a.Vs.RemoveConfirmation({
                    fileId: m,
                    dbid: k,
                    sid: n,
                    aiid: a.Data.Aiid,
                    target: i.closest(".attached-file-container")
                });
            p3.rV(j, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            return false
        },
        commentClick: function(i) {
            var o = this,
                l = _.find(a.Data.Assignment.get("SectionLinks"), function(p) {
                    return p.SectionId == a.Data.SectionId
                }),
                k = new Bbc(),
                m = o.model.get("user_id");
            a.Data.Scale.each(function(p) {
                if (p.get("ScaleId") === a.Data.ScaleId) {
                    k.add(p)
                }
            });
            var j = new g.Ms.Gradebook({
                    AssignmentId: a.Data.Aid,
                    StudentUserId: m,
                    ScaleId: a.Data.ScaleId || -1
                }).on("change", function() {
                    if (j.get("status") === "save") {
                        a.Data.SaveCollection.add(j);
                        new g.Ms.GradebookSave().save({
                            sectionId: a.Data.SectionId,
                            markingPeriodId: l.MarkingPeriodId,
                            xmlData: JSON.stringify(a.Data.SaveCollection)
                        }, {
                            success: function(p, q) {
                                a.Data.SaveCollection.reset(null, {
                                    silent: true
                                });
                                p3.showModal(p3.Layout.Containers.Modal, "hide");
                                a.Data.GradedCount += 1;
                                $("#current-graded-count").html(a.Data.GradedCount);
                                o.trigger("detailEdited");
                                o.renderTemplate()
                            },
                            error: function(p, q) {
                                p3.displayError("Error on Grade Book save");
                                a.Data.SaveCollection.reset(null, {
                                    silent: true
                                })
                            }
                        })
                    }
                }, this),
                n = new Bbm({
                    sectionId: a.Data.SectionId,
                    markingPeriodId: l.MarkingPeriodId,
                    scale: k
                });
            p3.rV(new g.Vs.Detail({
                model: j,
                values: n
            }), p3.Layout.Containers.Modal, true);
            p3.Layout.Containers.Modal.on("hide hide.bs.modal", function() {
                $(i.currentTarget).focus();
                $(this).off("hide hide.bs.modal")
            })
        },
        showFile: function(m) {
            var u = this,
                k = $("#processing-message"),
                j = $("#croc-frame"),
                l = $(m.currentTarget),
                p = l.data("id"),
                q = u.options.model.get("files"),
                o, n = "",
                r, t, s = "";
            k.show();
            for (r = 0; r < q.length; r++) {
                if (q[r].drop_box_file_id == p) {
                    o = q[r];
                    break
                }
            }
            if (!o.SessionId) {
                window.setTimeout(function() {
                    if (o.external_id) {
                        n = o.external_id
                    }
                    t = new a.Ms.DropBoxAnnotate();
                    t.fetch({
                        async: false,
                        data: {
                            fileId: p,
                            externalId: n,
                            dropBoxId: u.options.model.get("dbid"),
                            assignmentIndexId: u.options.model.get("aiid")
                        },
                        success: function(i, v) {
                            if (v && v.statusMessage) {
                                s = " [" + v.statusMessage + "]"
                            }
                            o.SessionId = v.SessionId;
                            if (o.SessionId) {
                                u.options.model.set("files", q);
                                k.hide();
                                j.attr("src", "https://crocodoc.com/view/" + o.SessionId).show()
                            } else {
                                k.hide();
                                p3.displayError("Error getting document session" + s)
                            }
                        },
                        error: function(i, v) {
                            if (v && v.statusMessage) {
                                s = " [" + v.statusMessage + "]"
                            }
                            p3.displayError("Error getting document session" + s);
                            j.hide();
                            k.hide()
                        }
                    })
                }, 100)
            } else {
                k.hide();
                j.attr("src", "https://crocodoc.com/view/" + o.SessionId).show()
            }
            m.preventDefault()
        },
        resubmitClick: function(j) {
            var k = this;
            var i = new a.Vs.ResubmitConfirmation({
                dbid: k.model.get("dbid"),
                sid: k.model.get("user_id"),
                aiid: a.Data.Aiid,
                collection: k.collection
            });
            p3.rV(i, p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            i.on("Resubmit", function() {
                k.model.set("ready_ind", false);
                k.model.set("files", []);
                k.model.set("detail", "");
                k.renderTemplate()
            });
            return false
        }
    });
    a.Us.RegisterHelpers = function() {
        if (Hb.helpers.OnlineSubmissionDateFormat === undefined) {
            Hb.registerHelper("OnlineSubmissionDateFormat", function(i) {
                var j = "";
                if (i.length) {
                    j += a.Us.DateParse(i)
                }
                return j
            })
        }
        if (Hb.helpers.DetailLinksList === undefined) {
            Hb.registerHelper("DetailLinksList", function(j, m) {
                var n = "",
                    k, l;
                if (j.length) {
                    n += '<div class="well well-sm" style="margin:10px 0px 5px 0px"><h3>Links</h3>';
                    for (k = 0; k < j.length; k++) {
                        l = j[k];
                        n += '<a href="' + l.Url + '" target="_blank">' + l.ShortDescription + "</a>";
                        if (l.Description !== undefined && l.Description !== "" && l.Description !== null) {
                            n += "<p>" + l.Description + "</p>"
                        }
                        if (k < j.length - 1) {
                            n += "<hr>"
                        }
                    }
                    n += "</div>"
                }
                return n
            })
        }
        if (Hb.helpers.DetailDownloadsList === undefined) {
            Hb.registerHelper("DetailDownloadsList", function(j, m) {
                var n = "",
                    k, l;
                if (j.length) {
                    n += '<div class="well well-sm" style="margin:10px 0px 5px 0px"><h3>Downloads</h3>';
                    for (k = 0; k < j.length; k++) {
                        l = j[k];
                        n += '<a href="' + l.DownloadUrl + "?ver=" + d.localDateTime().getTime() + '" target="_blank">' + l.ShortDescription + "</a>";
                        if (l.Description !== undefined && l.Description !== "" && l.Description !== null) {
                            n += "<p>" + l.Description + "</p>"
                        }
                        if (k < j.length - 1) {
                            n += "<hr>"
                        }
                    }
                    n += "</div>"
                }
                return n
            })
        }
    };
    a.Us.FileSizeDisplay = function(j) {
        if (j == null) {
            return ""
        }
        var k = j,
            i = 0,
            l = "",
            m = ["B", "KB", "MB", "GB", "TB", "PB"];
        while (k > 1024) {
            k = (k / 1024);
            i++
        }
        l = m[i];
        return Math.round(k * 100) / 100 + " " + l
    };
    a.Us.DateParse = function(m) {
        if (!m) {
            return ""
        }
        if (m.indexOf("AM") > -1 || m.indexOf("PM") > -1) {
            return m
        }
        var o = m.substring(m.indexOf(" ") + 1),
            l = m.substring(0, m.indexOf(" ")),
            j = o.substring(0, o.indexOf(":")),
            k = parseInt(o.substring(o.indexOf(":") + 1), 10),
            i = true;
        if (l.substring(1, 0) === "0") {
            l = l.substring(1)
        }
        if (j.substring(0, 1) === "0") {
            j = parseInt(j.substring(1), 10)
        } else {
            j = parseInt(j, 10)
        }
        if (j > 11) {
            j -= 12;
            i = false
        }
        if (j === 0) {
            j = 12
        }
        var n = l + " at " + j + ":" + (k < 10 ? ("0" + k) : k) + " " + (i === true ? "AM" : "PM");
        return n
    };
    a.Us.getAverageGrade = function(k, j) {
        var i = "--",
            n = 0,
            o = 0,
            l, m = (j.length > 0) ? j.models[0].get("scale_id") : null;
        if (m) {
            if (!a.Data.Scale.length) {
                a.Data.Scale.fetch({
                    async: false
                })
            }
            l = a.Data.Scale.toJSON();
            l = _.filter(l, function(p) {
                return p.ScaleId == m
            })
        }
        j.each(function(q) {
            var p;
            if (q.get("points_earned") !== null) {
                o += k;
                n += q.get("points_earned")
            } else {
                if (q.get("value_id")) {
                    o += k;
                    for (p = 0; p < l.length; p++) {
                        if (l[p].ValueId == q.get("value_id")) {
                            n += l[p].ScaleValue;
                            break
                        }
                    }
                }
            }
        });
        if (o > 0) {
            if (n > 0) {
                i = Math.round((n / o) * 100);
                i = i.toString() + "%"
            } else {
                i = "0%"
            }
        }
        return i
    };
    a.Us.buildFilesList = function(o, s) {
        var m;
        o.set("submit_date", a.Us.DateParse(o.get("last_submit_date")).replace(" ", " at "), {
            silent: true
        });
        o.set("aiid", a.Data.Aiid, {
            silent: true
        });
        o.set("urlRoot", p3.Config.FtpImagePath, {
            silent: true
        });
        var q, i = d.localDateTime(),
            p = false;
        if (a.Data.DueDate !== undefined) {
            q = d.getDate(o.get("drop_box_late_time"));
            q = new Date(a.Data.DueDate.getFullYear(), a.Data.DueDate.getMonth(), a.Data.DueDate.getDate(), q.getHours(), q.getMinutes())
        }
        if (o.get("last_submit_date") === null && q !== undefined && i.getTime() > q.getTime()) {
            p = true
        }
        if (o.get("ready_ind") && a.Data.DropBoxItems.length > 0) {
            var n = o.get("user_id"),
                l = a.Data.DropBoxItems.filter(function(t) {
                    return t.get("student_user_id") === n
                }),
                k = [],
                j = 0;
            if (l !== undefined && l.length > 0) {
                _.each(l, function(u) {
                    var t = u.toJSON();
                    if (t.file_size !== undefined) {
                        t.file_size = a.Us.FileSizeDisplay(t.file_size)
                    }
                    t.canAnnotate = a.Us.canAnnotate(t.file_name);
                    j = t.drop_box_id;
                    if (t.file_name !== null) {
                        k.push(t);
                        $("#download-all-materials-label").hide();
                        $("#download-all-materials-link").show()
                    }
                });
                if (k.length > 0) {
                    o.set("files", k, {
                        silent: true
                    })
                }
                if (j != 0) {
                    o.set("dbid", j, {
                        silent: true
                    })
                }
            } else {
                o.set("files", k, {
                    silent: true
                })
            }
            if (q !== undefined && d.getDate(o.get("last_submit_date")).getTime() < q.getTime()) {
                p = false
            } else {
                if (q !== undefined && d.getDate(o.get("last_submit_date")).getTime() > q.getTime()) {
                    p = true
                }
            }
        }
        o.set("isLate", p, {
            silent: true
        });
        m = a.Data.UserFolders.get(o.get("user_id"));
        if (m) {
            o.set("dbLink", "/ftpimages/" + p3.Data.SchoolContext.get("SchoolInfo").SchoolId + "/dropbox/" + a.Data.Aiid + "/" + m.get("FolderName") + "/");
            if (s) {
                s.renderTemplate()
            }
        } else {
            var r = new a.Ms.UserFolder();
            r.fetch({
                async: false,
                data: {
                    uid: o.get("user_id")
                },
                success: function(u, v) {
                    var t = "/ftpimages/" + p3.Data.SchoolContext.get("SchoolInfo").SchoolId + "/dropbox/" + a.Data.Aiid + "/" + u.get("FolderName") + "/";
                    r.set("user_id", o.get("user_id"));
                    a.Data.UserFolders.add(r);
                    o.set("dbLink", t);
                    if (s) {
                        s.renderTemplate()
                    }
                },
                error: function(t, u) {
                    o.set("dbLink", "");
                    s.renderTemplate()
                }
            })
        }
    };
    a.Us.canAnnotate = function(j) {
        var k = false,
            i;
        if (j && j.indexOf(".") > -1) {
            i = j.split(".").pop();
            i = i.toLowerCase();
            switch (i) {
                case "doc":
                case "docx":
                case "ppt":
                case "pptx":
                case "pdf":
                    k = true;
                    break
            }
        }
        return k
    };
    a.Us.showStudentFile = function(m, l) {
        var k = $(m.currentTarget),
            p = k.data("id"),
            o, n = "",
            j = $("#student-processing-message"),
            i = $("#student-croc-frame"),
            q;
        m.preventDefault();
        j.show();
        l.each(function(r) {
            if (r.get("dbFileId") == p) {
                o = r
            }
        });
        if (!o.get("sessionId")) {
            window.setTimeout(function() {
                if (o.get("externalId")) {
                    n = o.get("externalId")
                }
                var r = new a.Ms.DropBoxView();
                r.fetch({
                    async: false,
                    data: {
                        fileId: p,
                        externalId: n,
                        dropBoxId: o.get("dbid"),
                        assignmentIndexId: a.Data.Aiid
                    },
                    success: function(s, t) {
                        if (t && t.statusMessage) {
                            q = " [" + t.statusMessage + "]"
                        }
                        if (t.SessionId) {
                            o.set("sessionId", t.SessionId);
                            j.hide();
                            i.attr("src", "https://crocodoc.com/view/" + t.SessionId).show()
                        } else {
                            i.hide();
                            j.hide();
                            p3.displayError("Error getting document session" + q)
                        }
                    },
                    error: function(s, t) {
                        if (t && t.statusMessage) {
                            q = " [" + t.statusMessage + "]"
                        }
                        i.hide();
                        j.hide();
                        p3.displayError("Error getting document session" + q)
                    }
                })
            }, 100)
        } else {
            j.hide();
            i.attr("src", "https://crocodoc.com/view/" + o.get("sessionId")).show()
        }
    };
    a.Us.RenderLtiRegion = function(i) {
        var j;
        j = new a.Cs.LtiTools();
        j.fetch({
            data: {
                assignmentIndexId: a.Data.Aiid
            },
            success: function(k, l) {
                a.Data.Assignment.set("Lti", j.toJSON());
                a.Us.DisplayLtiRegion(i)
            },
            error: function(k, l) {
                p3.displayError("Error loading Learning Tools")
            }
        })
    };
    a.Us.DisplayLtiRegion = function(j) {
        var k = a.Data.Assignment.get("Lti"),
            i = $((j ? "#inner-lti-region" : "#outer-lti-region"));
        i.html("");
        if (p3.Data.Context.getSelectedPersona().Id === 2 || p3.Data.Context.getSelectedPersona().Id === 3) {
            if (k != null && k.length > 0 && k[0].ToolIndexId) {
                p3.rV(new a.Vs.AssignmentDetailLtiView({
                    lti: k[0],
                    persona: p3.Data.Context.getSelectedPersona().Id,
                    assignmentId: a.Data.Aid,
                    assignmentIndexId: a.Data.Aiid
                }), i, true)
            }
        }
    };
    p3.router().route("assignmentdetail/:aid/:aiid/:print/:back", "Assignmentdetail", function(i, j, l, k) {
        a.Data.Back = k;
        if (l == 1) {
            a.Data.Print = true;
            p3.rV(new a.Vs.LayoutView({
                aid: i,
                aiid: j
            }), $("#app"), true)
        } else {
            a.Data.Print = false;
            p3.renderMainPage(new a.Vs.LayoutView({
                aid: i,
                aiid: j
            }))
        }
    });
    p3.router().route("assignmentdetail/:aid/:aiid/:studentid/:print/:back", "Assignmentdetail", function(i, j, m, l, k) {
        a.Data.Back = k;
        a.Data.CurrentStudent = m;
        if (l == 1) {
            a.Data.Print = true;
            p3.rV(new a.Vs.LayoutView({
                aid: i,
                aiid: j
            }), $("#app"), true)
        } else {
            a.Data.Print = false;
            p3.renderMainPage(new a.Vs.LayoutView({
                aid: i,
                aiid: j
            }))
        }
    })
}(p3.module("LMS/Shared/assignmentdetail")));
(function(a) {
    var b = p3.Us.Enum,
        e = p3.module("utilities/sort"),
        d = p3.module("utilities/smodal"),
        c = p3.module("shared/ltitool");
    a.Ms.StudentMissingAssignmentCheck = Bbm.extend({
        url: "datadirect/StudentMissingAssignmentCheck",
        hasMissingAssignments: function() {
            return (this.get("MissingCount") > 0) || false
        }
    });
    a.Ms.AdvisorMissingAssignmentCheck = Bbm.extend({
        url: "datadirect/AdvisorMissingAssignmentCheck",
        hasMissingAssignments: function() {
            return (this.get("MissingCount") > 0) || false
        }
    });
    a.Ms.LtiConfigSummary = Bbm.extend({
        url: "datadirect/LtiConfigSummary",
        initialize: function(f) {
            this.set("IsLtiInstalled", c.Us.IsLtiInstalled());
            this.set("UserId", p3.Data.Context.get("UserInfo").UserId);
            this.set("IsFaculty", (p3.Data.Context.getSelectedPersona().Id === b.AppPersona.FACULTY.Value));
            this.set("NeedsConfigCount", 0);
            this.set("AssignmentIndexId", 0);
            this.set("NeedsConfigInd", 0)
        }
    });
    a.Cs.StudentMissingAssignmentList = Bbc.extend({
        url: "DataDirect/StudentMissingAssignmentList",
        initialize: function() {
            _.extend(this, $.extend(true, {}, e.Us.CollectionSort))
        }
    });
    a.Cs.AdvisorMissingAssignmentList = Bbc.extend({
        url: "DataDirect/AdvisorMissingAssignmentList"
    });
    a.Cs.UnconfiguredList = Bbc.extend({
        url: "datadirect/LtiUnconfiguredList"
    });
    a.Data = {};
    a.Vs.StudentMissingModal = Bb.View.extend({
        template: "assignmentcenter/assignmentcenter.missing.layout.template.html",
        listTemplate: "assignmentcenter/assignmentcenter.missing.item.template.html",
        initialize: function() {
            var f = this;
            f.hash = f.options.hash;
            f.columns = [{
                SortName: "DateDue",
                DisplayName: "Due Date",
                Sortable: true,
                Width: "16%"
            }, {
                SortName: "AssignmentTitle",
                DisplayName: "Title",
                Sortable: true,
                Width: "42%"
            }, {
                SortName: "GroupName",
                DisplayName: "Class",
                Sortable: true,
                Width: "42%"
            }]
        },
        events: {
            "click .closeModal": "closeModal",
            "click th.sortable": "sort"
        },
        render: function(f) {
            var g = this;
            $(f).html(g.el);
            g.renderTemplate()
        },
        renderTemplate: function() {
            var h = this,
                g = h.collection.sortDirection === "asc" ? "p3icon-sortDown" : "p3icon-sortUp",
                f;
            p3.fT(h.template, function(i) {
                h.$el.html(i({}));
                p3.fT(h.listTemplate, function(j) {
                    h.$("tbody").html(j({
                        columns: h.columns,
                        entries: h.collection.toJSON(),
                        hash: h.hash
                    }));
                    f = h.$("th[data-sort=" + h.collection.sortProp + "]");
                    f.removeClass("muted");
                    f.find("i").removeClass("p3icon-sortOff").addClass(g);
                    p3.setModalHeight(p3.Layout.Containers.Modal)
                })
            })
        },
        sort: function(g) {
            var i = this,
                h = "",
                f;
            p3.fT(i.listTemplate, function(j) {
                i.collection.setSort($(g.currentTarget).data("sort"));
                i.$("tbody").html(j({
                    columns: i.columns,
                    entries: i.collection.toJSON(),
                    hash: i.hash
                }));
                h = i.collection.sortDirection === "asc" ? "p3icon-sortDown" : "p3icon-sortUp";
                f = i.$("th[data-sort=" + i.collection.sortProp + "]");
                f.removeClass("muted");
                f.find("i").removeClass("p3icon-sortOff").addClass(h)
            })
        }
    });
    a.Vs.AdvisorMissingModal = Bb.View.extend({
        template: "assignmentcenter/assignmentcenter.missing.advisor.layout.template.html",
        listTemplate: "assignmentcenter/assignmentcenter.missing.advisor.item.template.html",
        initialize: function() {
            var f = this;
            f.hash = f.options.hash
        },
        events: {
            "click .closeModal": "closeModal",
            "click .studentToggle": "toggleStudent"
        },
        render: function(f) {
            var g = this;
            $(f).html(g.el);
            g.renderTemplate()
        },
        renderTemplate: function() {
            var f = this;
            p3.fT(f.template, function(g) {
                f.$el.html(g({}));
                p3.fT(f.listTemplate, function(h) {
                    f.$(".form-horizontal").html(h({
                        entries: f.collection.toJSON(),
                        hash: f.hash
                    }));
                    p3.setModalHeight(p3.Layout.Containers.Modal)
                })
            })
        },
        toggleStudent: function(h) {
            var g = $(h.target),
                f;
            $(g.closest("div.student-block").attr("data-target")).slideToggle(0, function() {
                p3.setModalHeight(p3.Layout.Containers.Modal)
            });
            f = g.closest("div.student-block").find(".swaparrow");
            if (f.hasClass("p3icon-sideArrow")) {
                p3.slideArrowS(f)
            } else {
                p3.slideArrowE(f)
            }
        }
    });
    a.Us.isStudentDetailLinkAvailable = function(f, h) {
        var g = false;
        if (f.AssessmentInd) {
            if ((f.PublishGrade || !f.GradeBookInd) && (f.HasGrade || f.ShowReport) && (f.AssignmentStatus === 1 || f.AssignmentStatus === 3 || f.AssignmentStatus === 4) && !f.AssessmentLocked) {
                g = true
            }
        } else {
            if (f.DiscussionInd) {
                g = true
            } else {
                if ((f.AssignmentLongDescription !== undefined && f.AssignmentLongDescription !== null && f.AssignmentLongDescription.length > 0) || f.HasLinks || f.HasDownloads || f.DropBoxInd) {
                    g = true
                } else {
                    if (f.LtiInd && (h === 2 || h === 3)) {
                        g = true
                    } else {
                        if (f.GradeBookInd) {
                            if (h === 3 || h === 5) {
                                g = true
                            } else {
                                if (f.PublishGrade && h < 3) {
                                    g = true
                                }
                            }
                        }
                    }
                }
            }
        }
        return g
    };
    a.Us.GetAssignmentDetailReturnHash = function(f) {
        var g;
        if (f.toString() === "1") {
            g = "X"
        } else {
            g = window.location.hash;
            g = g.split("/").join("--");
            if (g.charAt(0) === "#") {
                g = g.slice(1)
            }
        }
        return encodeURIComponent(g)
    };
    a.Us.BuildAssignmentDetailLink = function(f, g, j, h) {
        var i;
        if (j === null || j === 0) {
            i = "#assignmentdetail/" + f + "/" + g + "/" + h + "/"
        } else {
            i = "#assignmentdetail/" + f + "/" + g + "/" + j + "/" + h + "/"
        }
        if (h.toString() === "1") {
            i = i + "X"
        } else {
            i = i + a.Us.GetAssignmentDetailReturnHash(h)
        }
        return i
    };
    a.Us.showStudentMissingAssignmentList = function() {
        var f, g = "X",
            h, i = p3.Data.Context.getSelectedPersona().Id;
        f = new a.Cs.StudentMissingAssignmentList();
        f.fetch({
            cache: false,
            success: function() {
                f.each(function(j) {
                    j.set("ShowLink", a.Us.isStudentDetailLinkAvailable(j.toJSON(), i));
                    j.set("Hash", g)
                });
                h = new a.Vs.StudentMissingModal({
                    collection: f,
                    hash: g
                });
                p3.showModal(p3.Layout.Containers.Modal, {
                    backOnHide: false
                });
                p3.rV(h, p3.Layout.Containers.Modal, true)
            }
        })
    };
    a.Us.showAdvisorMissingAssignmentList = function(l) {
        var f, g = "X",
            i, j = p3.Data.Context.getSelectedPersona().Id,
            h = 0,
            m = 0,
            k = null;
        f = new a.Cs.AdvisorMissingAssignmentList();
        f.fetch({
            data: {
                id: l
            },
            cache: false,
            success: function() {
                f.each(function(n) {
                    m = n.get("StudentUserId");
                    if (m !== h) {
                        n.set("StudentStart", true);
                        if (k !== null) {
                            k.set("StudentEnd", true)
                        }
                        h = m
                    }
                    n.set("ShowLink", a.Us.isStudentDetailLinkAvailable(n.toJSON(), j));
                    n.set("Hash", g);
                    k = n
                });
                if (k !== null) {
                    k.set("StudentEnd", true)
                }
                i = new a.Vs.AdvisorMissingModal({
                    collection: f,
                    hash: g
                });
                p3.showModal(p3.Layout.Containers.Modal, {
                    backOnHide: false
                });
                p3.rV(i, p3.Layout.Containers.Modal, true)
            }
        })
    };
    a.Us.refreshLtiConfigSummary = function(f, g) {
        f = f || 0;
        a.Data.LtiConfigSummary = new a.Ms.LtiConfigSummary();
        if (a.Data.LtiConfigSummary.get("IsFaculty") && a.Data.LtiConfigSummary.get("IsLtiInstalled")) {
            a.Data.LtiConfigSummary.fetch({
                data: {
                    aiid: f
                },
                async: false,
                success: function() {
                    if (g) {
                        g(a.Data.LtiConfigSummary)
                    }
                },
                error: function() {
                    a.Data.LtiConfigSummary = new a.Ms.LtiConfigSummary();
                    if (g) {
                        g(a.Data.LtiConfigSummary)
                    }
                }
            })
        }
    };
    a.Us.showLtiConfigList = function(f, i, h) {
        i.stopPropagation();
        i.preventDefault();
        var g, j, l = p3.Data.Context.get("UserInfo").UserId,
            k;
        f = f || 0;
        j = (h || a.Us.GetAssignmentDetailReturnHash(0));
        g = new a.Cs.UnconfiguredList();
        g.fetch({
            cache: false,
            data: {
                TeacherUserId: l
            },
            success: function() {
                if (g.length > 0) {
                    k = d.Vs.Modal2.extend({
                        template: "lti/lti.tool.unconfig.layout.template.html",
                        collection: g,
                        events: {
                            "click .closeModal": "closeModal"
                        },
                        modalRendered: function() {
                            var n = this,
                                o = n.$("tbody"),
                                m = "lti/lti.tool.unconfig.item.template.html";
                            p3.fT(m, function(p) {
                                o.append(p({
                                    entries: g.toJSON(),
                                    hash: j,
                                    aiid: f
                                }));
                                p3.setModalHeight(p3.Layout.Containers.Modal)
                            })
                        },
                        modalUpdate: function(m) {
                            return false
                        },
                        closeModal: function(m) {
                            m.stopPropagation();
                            m.preventDefault();
                            p3.Layout.Containers.Modal.modal("hide")
                        }
                    });
                    p3.showModal(p3.Layout.Containers.Modal, {
                        backOnHide: false
                    });
                    p3.rV(new k(), p3.Layout.Containers.Modal, true)
                }
            }
        })
    };
    if (!Hb.helpers.buildAssignmentDetailLink) {
        Hb.registerHelper("buildAssignmentDetailLink", function(f, g, i, h) {
            return a.Us.BuildAssignmentDetailLink(f, g, i, h)
        })
    }
}(p3.module("LMS/Shared/AssignmentTools")));
(function(b) {
    var a = p3.module("LMS/athleticschedule"),
        d = p3.module("LMS/athleticteam"),
        c = p3.module("LMS/Shared/AthleticsLiteScoreBoard");
    b.Ms = {
        SportsTeamsOffer: Bbm.extend({
            url: "athletics/TeamBulkUpdate"
        })
    };
    b.Cs = {
        Content: Bbc.extend({
            initialize: function(e, f) {
                this.sectionId = f.sectionId || 0;
                this.leadSectionId = f.leadSectionId || 0
            },
            url: function() {
                return aP + "datadirect/GroupPossibleContentGet/?format=json&leadSectionId=" + this.sectionId
            }
        }),
        SchoolYears: Bbc.extend({
            url: "DataDirect/SchoolYearsGet?display=0"
        }),
        SportSections: Bbc.extend({
            initialize: function(e, f) {
                f = f || {};
                this.schoolYearLabel = f.schoolYearLabel || ""
            },
            url: function() {
                return aP + "datadirect/SportsTeamsForYearGet/?format=json&schoolYearLabel=" + this.schoolYearLabel
            }
        }),
        SportsTeams: Bbc.extend({
            url: function() {
                return aP + "datadirect/OfferTeamsListGet/?schoolYearLabel=" + this.schoolYearLabel
            }
        }),
        SportsLevels: Bbc.extend({
            url: "datadirect/SchoolLevelGet/?offeringType=9"
        }),
        SportsSeasons: Bbc.extend({
            url: "datadirect/AthleticSeasonGet"
        }),
        Section: Bbc.extend({
            initialize: function(e, f) {
                f = f || {};
                this.sectionId = f.sectionId || b.Data.sectionId || 0
            },
            url: function() {
                return aP + "datadirect/SectionInfoView/?format=json&sectionId=" + this.sectionId + "&associationId=2"
            }
        })
    };
    b.Data = {
        MainViewRendered: false,
        RenderedSectionId: null,
        sectionId: -1,
        leadSectionId: -1,
        content: null,
        durationId: null,
        schoolYear: "",
        FullAccess: true,
        IsOwner: 0,
        isManager: 1,
        currentSection: null
    };
    b.Pages = [{
        Id: 1,
        ContentId: -1,
        Label: "Schedule",
        RoutePage: "schedule",
        IconClass: "p3icon-schedule",
        HTMLID: "schedule-btn",
        LinkId: "schedule-link",
        Display: function(e) {
            p3.rV(new a.Vs.TeamScheduleView({
                sectionId: b.Data.sectionId,
                leadSectionId: b.Data.sectionId,
                durationId: b.Data.durationId,
                content: d.Data.contentTypes,
                userHasFullAccess: b.Data.FullAccess,
                isOwner: b.Data.IsOwner,
                isManager: b.Data.isManager,
                hideCalendar: true,
                hideBulkPractices: true
            }), e, true)
        },
        Active: true
    }, {
        Id: 2,
        ContentId: -1,
        Label: "Scoreboard",
        RoutePage: "scoreboard",
        IconClass: "p3icon-scoreboard",
        HTMLID: "scoreboard-btn",
        LinkId: "scoreboard-link",
        Display: function(e) {
            p3.rV(new c.Vs.Scoreboard({
                section: b.Data.currentSection
            }), e, true)
        },
        Active: false
    }];
    b.Vs = {
        Layout: Bb.View.extend({
            template: "athleticslite/layout.template.html",
            events: {
                emptyyear: "doNoTeams",
                offered: "doOfferedTeams",
                offerCourse: "doOfferCourse",
                refreshTeams: "doRefreshTeamsData",
                detailView: "doDetailView"
            },
            initialize: function(e) {
                var f = this;
                f.Containers = {};
                b.Data.MainViewRendered = true;
                b.Data.RenderedSectionId = b.Data.sectionId = e.SectionId || b.Data.sectionId;
                f.currentTeams = new b.Cs.SportsTeams();
                f.currentTeams.schoolYearLabel = p3.Data.SchoolContext.get("CurrentSchoolYear").SchoolYearLabel;
                f.currentTeams.comparator = function(g) {
                    return g.get("season") + " - " + g.get("group_name")
                };
                f.schoolYears = new b.Cs.SchoolYears();
                f.teams = new b.Cs.SportsTeams();
                f.teams.schoolYearLabel = p3.Data.SchoolContext.get("CurrentSchoolYear").SchoolYearLabel;
                f.teams.comparator = function(g) {
                    return g.get("department") + " - " + g.get("group_name")
                };
                f.displayTeams = new b.Cs.SportsTeams();
                f.displayTeams.schoolYearLabel = p3.Data.SchoolContext.get("CurrentSchoolYear").SchoolYearLabel;
                f.activeView = ""
            },
            dispose: function() {
                b.Data.MainViewRendered = false
            },
            render: function(e) {
                var f = this;
                $(e).html(this.el);
                this.picker = new b.Vs.TeamPicker({
                    schoolYears: f.schoolYears,
                    currentTeams: f.currentTeams
                });
                this.navigation = undefined;
                p3.fT(f.template, function(g) {
                    f.$el.html(g({}));
                    f.Containers.picker = $("#athletics-lite-team-picker");
                    f.Containers.information = $("#athletics-lite-information");
                    f.Containers.content = $("#athletics-lite-content-area");
                    if (!f.currentTeams) {
                        f.currentTeams = new b.Cs.SportSections()
                    }
                    p3.rV(f.picker, f.Containers.picker, true);
                    if (b.Data.sectionId) {
                        f.content = new b.Vs.TeamDetail();
                        p3.rV(f.content, f.Containers.information, true);
                        f.activeView = "TeamDetail"
                    }
                })
            },
            doNoTeams: function(f) {
                this.content = new b.Vs.Empty();
                p3.rV(this.content, this.Containers.content, true);
                this.Containers.information.html("");
                p3.router().navigate("#athleticslite/schedule/0/0");
                this.activeView = "Empty"
            },
            doOfferedTeams: function(f) {
                this.displayTeams.schoolYearLabel = b.Data.schoolYear;
                if (this.activeView !== "TeamListing") {
                    this.content = new b.Vs.TeamListing({
                        collection: this.displayTeams
                    });
                    p3.rV(this.content, this.Containers.content, true);
                    this.content.renderTemplate();
                    if (this.activeView === "Empty" || this.activeView === "OfferedListing") {
                        this.currentTeams.fetch()
                    }
                }
                this.displayTeams.fetch();
                this.Containers.information.html("");
                p3.router().navigate("#athleticslite/schedule/0/0");
                this.activeView = "TeamListing"
            },
            doOfferCourse: function(f) {
                var h = this,
                    g = new b.Vs.OfferedListing({
                        collection: this.teams,
                        schoolYears: this.schoolYears
                    });
                h.activeView = "OfferedListing";
                this.teams.schoolYearLabel = b.Data.schoolYear;
                p3.rV(g, p3.Layout.Containers.Modal, true);
                p3.showModal(p3.Layout.Containers.Modal);
                $(p3.Layout.Containers.Modal).on("refreshTeams", function() {
                    h.doRefreshTeamsData()
                });
                $(p3.Layout.Containers.Modal).on("hide", function() {
                    $(p3.Layout.Containers.Modal).off("refreshTeams");
                    $(p3.Layout.Containers.Modal).off("hide")
                });
                this.teams.fetch()
            },
            doRefreshTeamsData: function() {
                if (this.$el.find(".p3icon-trash").length > 0) {
                    this.$el.trigger("offered")
                } else {
                    this.teams.fetch();
                    this.displayTeams.fetch();
                    this.currentTeams.fetch()
                }
            },
            doDetailView: function() {
                this.content = new b.Vs.TeamDetail();
                p3.rV(this.content, this.Containers.information, true)
            }
        }),
        TeamDetail: Bb.View.extend({
            template: "athleticslite/navigation.template.html",
            events: {},
            initialize: function(e) {
                this.collection = new b.Cs.Section();
                this.collection.on("reset", this.renderTemplate, this)
            },
            dispose: function() {
                this.collection.off("reset")
            },
            render: function(e) {
                $(e).html(this.el);
                this.collection.fetch()
            },
            renderTemplate: function() {
                var g = this,
                    f = g.collection.at(0).toJSON(),
                    e;
                b.Data.currentSection = f;
                f.navigationItems = [];
                if (g.collection.length === 0) {
                    $("#athletics-lite-content-area").html("");
                    return
                }
                for (e = 0; e < b.Pages.length; e++) {
                    f.navigationItems.push({
                        sort: b.Pages[e].Id,
                        title: b.Pages[e].Label,
                        iconClass: b.Pages[e].IconClass,
                        status: b.Pages[e].Active ? "active" : "inactive",
                        link: "#athleticslite/" + b.Pages[e].RoutePage + "/" + b.Data.sectionId + "/0",
                        pId: b.Pages[e].Id,
                        HTMLID: b.Pages[e].HTMLID
                    })
                }
                p3.fT(g.template, function(i) {
                    g.$el.html(i(f));
                    var h = _.find(b.Pages, function(j) {
                        return j.Active
                    });
                    if (h) {
                        h.Display($("#athletics-lite-content-area"))
                    }
                })
            }
        }),
        TeamPicker: Bb.View.extend({
            template: "athleticslite/teampicker.template.html",
            events: {
                "change #athletics-lite-year-ddl": "updateTeamSelector",
                "change #athletics-lite-team-ddl": "updateActiveTeam",
                "click .athletics-lite-offer": "doTeamOffer"
            },
            initialize: function(e) {
                if (e === "undefined" || e.schoolYears === "undefined" || e.currentTeams === "undefined") {
                    throw "The Team Picker must be initialized with a collection for both currentTeams and schoolYears"
                }
                var f = this;
                f.schoolYears = e.schoolYears;
                f.currentTeams = e.currentTeams;
                f.currentTeams.on("reset", f.renderTeams, f);
                f.schoolYears.on("reset", f.renderTemplate, f);
                f.schoolYears.fetch({
                    success: function(g, i, h) {
                        var j;
                        if (b.Data.schoolYear) {
                            j = g.find(function(k) {
                                return k.get("Label") === b.Data.schoolYear
                            })
                        } else {
                            j = g.find(function(k) {
                                return k.get("Current")
                            })
                        }
                        if (j) {
                            f.currentTeams.schoolYearLabel = b.Data.schoolYear = j.get("Label");
                            $("#athletics-lite-year-ddl").val(f.currentTeams.schoolYearLabel);
                            f.currentTeams.fetch()
                        }
                    }
                })
            },
            dispose: function() {
                this.schoolYears.off("reset")
            },
            render: function(e) {
                $(e).html(this.el)
            },
            renderTemplate: function() {
                var e = this;
                p3.fT(e.template, function(f) {
                    e.$el.html(f({
                        years: e.schoolYears.toJSON(),
                        seasons: []
                    }))
                })
            },
            updateTeamSelector: function(f) {
                var g = $(f.currentTarget).val();
                b.Data.sectionId = 0;
                this.currentTeams.schoolYearLabel = b.Data.schoolYear = g;
                this.currentTeams.fetch()
            },
            updateActiveTeam: function(f) {
                var g = $(f.currentTarget).val();
                p3.router().navigate("#athleticslite/schedule/" + (g === "-1" ? "0" : g) + "/0", {
                    trigger: true
                })
            },
            renderTeams: function(f, i, h) {
                var k = this,
                    e, g, j = function(l, n, m) {
                        var p;
                        if (l.length === 0) {
                            this.$el.trigger($.Event("emptyyear"));
                            e = $("#athletics-lite-team-ddl");
                            e.html('<option value="-1"> -- No Teams Available -- </option>')
                        } else {
                            p = new b.Cs.SportsTeams(l.models);
                            p.comparator = function(o) {
                                return o.get("group_name")
                            };
                            p.sort();
                            e = $("#athletics-lite-team-ddl");
                            g = true;
                            e.html('<option value="-1"> -- All Teams -- </option>');
                            p.each(function(o) {
                                if (o.get("team_id") !== "undefined" && o.get("team_id") > 0) {
                                    e.append('<option value="' + o.get("team_id") + '">' + o.get("group_name") + "</option>");
                                    g = false
                                }
                            });
                            if (g) {
                                e.html('<option value="-1"> -- No Teams Available -- </option>');
                                k.$el.trigger($.Event("emptyyear"));
                                return
                            }
                            if (b.Data.sectionId === 0) {
                                k.$el.trigger($.Event("offered", {
                                    schoolYearLabel: l.schoolYearLabel
                                }))
                            } else {
                                e.val(b.Data.sectionId);
                                if (e.val() !== "undefined" && parseInt(e.val(), 10) !== b.Data.sectionId) {
                                    k.$el.trigger($.Event("offered", {
                                        schoolYearLabel: l.schoolYearLabel
                                    }))
                                } else {
                                    k.$el.trigger($.Event("detailView"))
                                }
                            }
                        }
                    };
                if ($("#athletics-lite-team-ddl").length === 0) {
                    if (b._teamPickerTimer) {
                        window.clearInterval(b._teamPickerTimer);
                        b._teamPickerTimer = null
                    }
                    b._teamPickerTimer = window.setInterval(function() {
                        if (k.schoolYears !== "undefined" && k.schoolYears.length > 0) {
                            j(f, i, h);
                            window.clearInterval(b._teamPickerTimer);
                            b._teamPickerTimer = null
                        } else {
                            if (k.schoolYears === "undefined") {
                                window.clearInterval(b._teamPickerTimer);
                                b._teamPickerTimer = null
                            }
                        }
                    }, 100)
                } else {
                    j(f, i, h)
                }
            },
            forcedTeamRender: function(f) {
                var e;
                if (f.length === 0) {
                    this.$el.trigger($.Event("emptyyear"));
                    e = $("#athletics-lite-team-ddl");
                    e.html('<option value="-1"> -- No Teams Available -- </option>')
                } else {
                    e = $("#athletics-lite-team-ddl");
                    e.html('<option value="-1"> -- All Teams -- </option>');
                    f.each(function(g) {
                        if (g.get("team_id") !== "undefined" && g.get("team_id") > 0) {
                            e.append('<option value="' + g.get("team_id") + '">' + g.get("group_name") + "</option>")
                        }
                    });
                    e.val(-1)
                }
            },
            doTeamOffer: function(f) {
                f.preventDefault();
                this.$el.trigger($.Event("offerCourse"))
            }
        }),
        Empty: Bb.View.extend({
            template: "athleticslite/empty.template.html",
            events: {
                "click .btn": "doTeamOffer"
            },
            render: function(e) {
                var f = this;
                $(e).html(this.el);
                p3.fT(f.template, function(g) {
                    f.$el.html(g())
                })
            },
            doTeamOffer: function(f) {
                f.preventDefault();
                this.$el.trigger($.Event("offerCourse"))
            }
        }),
        TeamListing: Bb.View.extend({
            template: "athleticslite/offered.template.html",
            events: {},
            initialize: function(e) {
                if (this.collection.schoolYearLabel === "") {
                    this.collection.schoolYearLabel = p3.Data.SchoolContext.get("CurrentSchoolYear").SchoolYearLabel
                }
                this.collection.on("reset", this.renderTemplate, this)
            },
            dispose: function() {
                this.collection.off("reset", this.renderTemplate)
            },
            render: function(e) {
                $(e).html(this.el)
            },
            renderTemplate: function() {
                var e = this;
                e.doTeamsSort();
                p3.fT(e.template, function(f) {
                    e.$el.html(f({
                        seasons: e.formattedCollection.toJSON()
                    }))
                })
            },
            doTeamOffer: function(f) {
                f.preventDefault();
                this.$el.trigger($.Event("offerCourse"))
            },
            doTeamsSort: function() {
                var i = this,
                    h, f, g, e;
                i.formattedCollection = new Bbc();
                h = (new Bbc(i.collection.filter(function(j) {
                    return j.get("team_id") !== "undefined" && j.get("team_id") > 0
                }))).groupBy(function(j) {
                    return j.get("season")
                });
                for (f in h) {
                    if (h.hasOwnProperty(f)) {
                        g = new Bbc(h[f], {
                            comparator: "group_name"
                        });
                        e = new Bbm({
                            Label: f,
                            seasonColumnClass: "span4 col-md-4",
                            teams: g.toJSON()
                        });
                        i.formattedCollection.add(e)
                    }
                }
            }
        }),
        OfferedListing: Bb.View.extend({
            template: "athleticslite/offer.modal.template.html",
            events: {
                "click .modal-body .btn": "doButtonClick",
                "change #offering-level-dd": "doLevelFilter",
                "change #offering-season-dd": "doSeasonFilter",
                "change #offering-year-dd": "doYearFilter",
                "click #offering-team-save-button": "doOfferTeamSave"
            },
            initialize: function(e) {
                var f = this;
                e = e || {};
                this.collection.on("reset", f.updateRenderedSports, this);
                this.SportLevels = new b.Cs.SportsLevels();
                this.SportLevels.on("reset", f.renderLevels, this);
                this.Seasons = new b.Cs.SportsSeasons();
                this.Seasons.on("reset", f.renderSeasons, this);
                this.SchoolYears = e.schoolYears;
                this.filters = {
                    levels: undefined,
                    seasons: undefined
                }
            },
            dispose: function() {
                this.$el.find(".collapse").off("hidden");
                this.collection.off("reset", this.updateRenderedSports);
                this.SportLevels.off("reset", this.renderLevels);
                this.Seasons.off("reset", this.renderSeasons)
            },
            render: function(e) {
                $(e).html(this.el)
            },
            renderTemplate: function() {
                var e = this;
                p3.fT(e.template, function(g) {
                    e.$el.html(g({
                        sports: e.formattedCollection.toJSON(),
                        schoolYears: e.SchoolYears.toJSON()
                    }));
                    e.$el.find(".collapse").on("hidden", function(h) {
                        h.stopPropagation()
                    });
                    $("#offering-year-dd").val(e.collection.schoolYearLabel);
                    if ($('button[data-team-button="true"].active').length === $('button[data-team-button="true"]').length) {
                        var f = ($('button[data-team-button="true"].active').length === 0 ? "No teams to offer" : "All teams have been offered");
                        $(".grayContainer > h3").html(f).siblings("button").hide();
                        $('div[data-section="true"]').hide();
                        $("#offering-team-save-button").hide()
                    } else {
                        $(".grayContainer > h3").html("Offer ALL Teams").siblings("button").show();
                        $('div[data-section="true"]').show();
                        $("#offering-team-save-button").show()
                    }
                    e.SportLevels.fetch();
                    e.Seasons.fetch()
                })
            },
            preventClose: function(f) {
                f.stopPropagation()
            },
            doButtonClick: function(g) {
                var f = $(g.currentTarget);
                g.stopPropagation();
                if (f.find(".p3icon-lock").length === 0) {
                    f.toggleClass("active")
                } else {
                    return
                }
                if (f.data("all") !== undefined && f.data("all") === true) {
                    $('button[data-team-button="true"]:has(.p3icon-check)').each(function(e, h) {
                        if ($(h).attr("disabled") === undefined) {
                            if (f.hasClass("active")) {
                                $(h).addClass("active")
                            } else {
                                $(h).removeClass("active")
                            }
                        }
                    });
                    $('div[data-section="true"]').each(function(e, h) {
                        if ($(h).attr("disabled") === undefined) {
                            if (f.hasClass("active")) {
                                $(h).addClass("active")
                            } else {
                                $(h).removeClass("active")
                            }
                        }
                    })
                } else {
                    if (f.data("section") !== undefined && f.data("section") === true && f.data("id") !== undefined && f.data("id") > 0) {
                        $('button[data-sport-id="' + f.data("id") + '"]:has(.p3icon-check)').each(function(e, h) {
                            if ($(h).attr("disabled") === undefined) {
                                if (f.hasClass("active")) {
                                    $(h).addClass("active")
                                } else {
                                    $(h).removeClass("active")
                                }
                            }
                        })
                    } else {
                        if (f.data("sportId") !== undefined && f.data("sportId") > 0 && f.data("id") !== undefined && f.data("id") > 0) {
                            if (f.hasClass("active")) {
                                if ($('button[data-sport-id="' + f.data("sportId") + '"]:not(.active)').length === 0) {
                                    $('div[data-section="true"][data-id="' + f.data("sportId") + '"]').addClass("active")
                                }
                            } else {
                                if ($('button[data-all="true"]').hasClass("active")) {
                                    $('button[data-all="true"]').removeClass("active")
                                }
                                if ($('div[data-id="' + f.data("sportId") + '"]').hasClass("active")) {
                                    $('div[data-id="' + f.data("sportId") + '"]').removeClass("active")
                                }
                            }
                        }
                    }
                }
                if ($('button[data-all="true"]').hasClass("active")) {
                    $('button[data-team-button="true"]').each(function(e, h) {
                        if ($(h).attr("disabled") === undefined) {
                            if (!$(h).hasClass("active")) {
                                $('button[data-all="true"]').removeClass("active")
                            }
                        }
                    })
                }
                if (!$('button[data-team-button="true"]:not(.active)').length && !$('div[data-section="true"]:not(.active)').length) {
                    $('button[data-all="true"]').addClass("active")
                }
            },
            doOfferTeamSave: function(f) {
                var j = this,
                    k = $("#offering-year-dd").val(),
                    i = $('button[data-team-button="true"]:has(.p3icon-check).active'),
                    g = [],
                    h = new b.Ms.SportsTeamsOffer();
                i.each(function(e, l) {
                    g.push(parseInt($(l).data("id"), 10))
                });
                if (g.length > 0) {
                    h.set("offeringIds", g);
                    h.set("schoolYearLabel", k);
                    h.on("sync", function() {
                        j.$el.trigger($.Event("refreshTeams"));
                        $(p3.Layout.Containers.Modal).modal("hide")
                    });
                    h.save({
                        error: function() {
                            p3.displayError("Error Offering teams.")
                        }
                    })
                } else {
                    $(p3.Layout.Containers.Modal).modal("hide")
                }
            },
            renderLevels: function(g) {
                var f = $("#offering-level-dd");
                if (this.SportLevels.length !== 1) {
                    f.html("<option value=-1>All</option>")
                } else {
                    f.html("")
                }
                this.SportLevels.each(function(e) {
                    f.append("<option value=" + e.get("DdId") + ">" + e.get("DdDescription") + "</option>")
                });
                if (this.SportLevels.length !== 1) {
                    f.val(typeof this.filters.levels === "number" ? this.filters.levels : -1)
                }
            },
            renderSeasons: function(g) {
                var f = $("#offering-season-dd").html("<option value=-1>All</option>");
                this.Seasons.each(function(e) {
                    f.append("<option value=" + e.get("DdId") + ">" + e.get("DdDescription") + "</option>")
                });
                f.val(typeof this.filters.seasons === "number" ? this.filters.seasons : -1)
            },
            doLevelFilter: function(f) {
                this.filters.levels = $(f.currentTarget).val();
                if (typeof this.filters.levels === "string") {
                    this.filters.levels = parseInt(this.filters.levels, 10)
                }
                if (this.filters.levels < 1) {
                    this.filters.levels = undefined
                }
                this.updateRenderedSports()
            },
            doSeasonFilter: function(f) {
                this.filters.seasons = $(f.currentTarget).val();
                if (typeof this.filters.seasons === "string") {
                    this.filters.seasons = parseInt(this.filters.seasons, 10)
                }
                if (this.filters.seasons < 1) {
                    this.filters.seasons = undefined
                }
                this.updateRenderedSports()
            },
            doYearFilter: function(f) {
                this.collection.schoolYearLabel = $(f.currentTarget).val();
                this.collection.fetch()
            },
            updateRenderedSports: function() {
                var l = this,
                    f = {},
                    g = false,
                    k, e = 0,
                    i, j, h;
                l.formattedCollection = new Bbc();
                if (l.filters.levels) {
                    f.level_num = l.filters.levels;
                    g = true
                }
                if (l.filters.seasons) {
                    f.season_id = l.filters.seasons;
                    g = true
                }
                if (g) {
                    g = (new Bbc(l.collection.where(f)))
                } else {
                    g = l.collection
                }
                k = g.groupBy(function(m) {
                    return m.get("department")
                });
                for (i in k) {
                    if (k.hasOwnProperty(i)) {
                        j = new Bbc(k[i]);
                        h = new Bbm({
                            Label: i,
                            SportId: j.at(0).get("department_id"),
                            Id: "Sport" + e++,
                            teams: j.toJSON()
                        });
                        l.formattedCollection.add(h)
                    }
                }
                l.renderTemplate();
                l.renderLevels();
                l.renderSeasons();
                p3.initModalHeightTimer(p3.Layout.Containers.Modal)
            }
        }),
        Schedule: Bb.View.extend({
            template: "",
            render: function(e) {
                $(e).html(this.el)
            }
        })
    };
    b.Us = {
        LoadPage: function(h, i, f) {
            var e, g;
            if (typeof i === "string") {
                i = parseInt(i, 10)
            }
            if (typeof f === "string") {
                f = parseInt(f, 10)
            }
            b.Data.durationId = f;
            b.Data.sectionId = i;
            if (!b.Data.content || b.Data.content.length > 1) {
                e = new b.Cs.Content(null, {
                    sectionId: i
                });
                e.fetch({
                    async: false,
                    success: function(j, l, k) {
                        b.Data.content = j
                    }
                })
            }
            p3.loadingIcon("#athletics-lite-content-area");
            _.each(b.Pages, function(j) {
                if (j.RoutePage.toLowerCase() === h.toLowerCase()) {
                    j.Active = true
                } else {
                    j.Active = false
                }
                if (j.Active) {
                    g = j
                }
            });
            if (!b.Data.MainViewRendered || b.Data.RenderedSectionId !== i) {
                p3.renderMainPage(new b.Vs.Layout({
                    SectionId: i
                }))
            } else {
                if (g) {
                    g.Display($("#athletics-lite-content-area"));
                    b.Us.SwitchTabs(g)
                } else {
                    b.Pages[0].Display($("#athletics-lite-content-area"));
                    b.Pages[0].Active = true;
                    b.Us.SwitchTabs(b.Pages[0])
                }
            }
        },
        SwitchTabs: function(e) {
            $(".nav-pills").children().removeClass("active").addClass("inactive");
            $(".nav-pills").children("[data-pid='" + e.Id + "']").removeClass("inactive").addClass("active")
        }
    };
    p3.router().route("athleticslite/:page/:teamId/:durationId", "athleticslite", b.Us.LoadPage)
}(p3.module("LMS/shared/AthleticsLite")));
(function(a) {
    var b = p3.module("LMS/teampage");
    a.Ms = {
        News: Bbm.extend({
            idAttribute: "Id",
            initialize: function(c, d) {
                this.newsId = d.newsId || 0
            },
            url: function() {
                return aP + "news/AthleticLiteDetail/" + this.newsId + "/?format=json"
            }
        })
    };
    a.Cs = {
        Results: Bbc.extend({
            initialize: function(c, d) {
                this.sectionId = d.sectionId || 0
            },
            url: function() {
                return aP + "datadirect/athleticresultsget/?format=json&sectionId=" + this.sectionId
            }
        })
    };
    a.Vs.Scoreboard = Bb.View.extend({
        template: "athleticslite/scoreboard.template.html",
        events: {
            "click button.edit": "doDetailEdit"
        },
        initialize: function(c) {
            c = c || {};
            this.collection = new a.Cs.Results(null, {
                sectionId: this.options.section.Id
            });
            this.collection.on("reset", this.renderTemplate, this);
            this.options.sections = new b.Cs.Sections(null, {
                sectionId: this.options.section.Id
            })
        },
        dispose: function() {
            if (this.collection !== undefined) {
                this.collection.off("reset")
            }
        },
        render: function(c) {
            $(c).html(this.el);
            this.collection.fetch()
        },
        renderTemplate: function() {
            var d = this,
                c = d.processResults();
            p3.fT(d.template, function(e) {
                d.$el.html(e(c))
            })
        },
        processResults: function() {
            var j = this,
                g = {
                    wins: 0,
                    losses: 0,
                    ties: 0,
                    percentage: 0
                },
                h = {
                    wins: 0,
                    losses: 0,
                    ties: 0,
                    percentage: 0
                },
                c = [],
                e = -1,
                f = 0,
                d;
            j.collection.each(function(i) {
                var l = (i.get("result") || i.get("score") || i.get("news_id")),
                    o, p = "",
                    q = "",
                    m, k, r, n;
                m = i.get("league_ind");
                o = i.get("result");
                if (o) {
                    o = o.toUpperCase()
                }
                switch (o) {
                    case "WIN":
                        p = "teamWin";
                        q = "W";
                        if (m) {
                            g.wins += 1
                        } else {
                            h.wins += 1
                        }
                        break;
                    case "LOSS":
                        p = "teamLoss";
                        q = "L";
                        if (m) {
                            g.losses += 1
                        } else {
                            h.losses += 1
                        }
                        break;
                    case "TIE":
                        p = "teamTie";
                        q = "T";
                        if (m) {
                            g.ties += 1
                        } else {
                            h.ties += 1
                        }
                        break
                }
                if (i.get("ath_schedule_id") !== f) {
                    e += 1;
                    f = i.get("ath_schedule_id");
                    k = new Date(i.get("schedule_date"));
                    r = "";
                    n = "";
                    if (i.get("schedule_type") === "Game") {
                        if (i.get("short_description")) {
                            n += "<h4>" + i.get("short_description") + "</h4>"
                        }
                        r = i.get("score");
                        if (i.get("site_ind") === 0) {
                            n += "vs "
                        } else {
                            if (i.get("site_ind") === 1) {
                                n += "@ "
                            }
                        }
                    } else {
                        if (i.get("short_description")) {
                            r = "<br />";
                            n += "<h4>" + i.get("short_description") + "</h4>"
                        }
                        if (i.get("score") !== null) {
                            r += i.get("score")
                        }
                    }
                    if (i.get("opponent_id") !== null || i.get("schedule_type") === "Meet") {
                        n += i.get("name")
                    }
                    c.push({
                        gameId: f,
                        gameDate: k.toString(),
                        resultClass: p,
                        resultText: q,
                        isMeet: (i.get("schedule_type") === "Meet"),
                        score: r,
                        opponent: n,
                        newsId: i.get("news_id"),
                        haveResult: l,
                        siteInd: i.get("site_ind")
                    })
                } else {
                    if (i.get("schedule_type") === "Game") {
                        if (c[e].score && c[e].score.length > 0 && i.get("score") && i.get("score").length > 0) {
                            c[e].score += " - " + i.get("score")
                        }
                        if (o) {
                            c[e].resultClass = p;
                            c[e].resultText = q
                        } else {
                            c[e].opponent += i.get("name")
                        }
                    } else {
                        if (i.get("score") !== null) {
                            c[e].score += "<br />" + i.get("score")
                        }
                        c[e].opponent += "<br />" + i.get("name");
                        if (o) {
                            c[e].resultClass = p;
                            c[e].resultText = q
                        }
                    }
                }
            });
            for (d = 0; d < c.length; d++) {
                c[d].opponent = c[d].opponent.replace(/vs $/, "");
                c[d].opponent = c[d].opponent.replace(/@ $/, "")
            }
            j.setPercentage(g);
            j.setPercentage(h);
            return {
                leagueStats: g,
                nonLeagueStats: h,
                game: c,
                sectionId: j.options.section.Id
            }
        },
        setPercentage: function(c) {
            c.percentage = "-";
            if (c.wins + c.losses + c.ties > 0) {
                if (c.wins === 0) {
                    c.percentage = ".000"
                } else {
                    if (c.losses === 0) {
                        c.percentage = "1.000"
                    } else {
                        c.percentage = (c.wins / (c.wins + c.losses)).toFixed(3).substring(1)
                    }
                }
            }
        },
        doDetailEdit: function(d) {
            var h = this,
                c = $(d.currentTarget),
                f = c.text() === " Edit",
                g = new Bbm({
                    GroupName: h.options.section.GroupName,
                    IsSelected: 1,
                    SectionId: h.options.section.Id,
                    LeadSectionId: h.options.section.Id,
                    ContextLabelId: 3,
                    AssociationId: 2,
                    Association: "Athletics",
                    Primary: true
                });
            h.options.sections = new b.Cs.Sections(null, {
                sectionId: h.options.section.Id
            });
            h.options.sections.add(g);
            h.parentView = {
                newsView: false
            };
            p3.rV(new b.Vs.EditResultsView({
                gameId: c.data("id"),
                existingData: f,
                parentView: h,
                newsId: c.data("newsId"),
                siteInd: c.data("siteInd"),
                isLite: true
            }), p3.Layout.Containers.Modal, true);
            p3.showModal(p3.Layout.Containers.Modal);
            return false
        }
    })
}(p3.module("LMS/Shared/AthleticsLiteScoreBoard")));
(function(a) {
    var e = p3.module("report"),
        f = p3.module("sis/schedulemaker"),
        c = p3.module("shared/datepicker"),
        d = p3.Us.InfoMessageLibrary,
        g = p3.module("shared/task"),
        b = p3.module("shared/customfields");
    a.Cs.SchoolYears = Bbc.extend({
        url: "datadirect/SchoolYearsGet/"
    });
    a.Cs.SchoolLevels = Bbc.extend({
        url: "datadirect/SchoolLevelGet/"
    });
    a.Cs.SchoolTerms = Bbc.extend({
        url: "datadirect/DurationGet/"
    });
    a.Cs.CourseSections = Bbc.extend({
        url: "datadirect/OfferCourseSectionGet/"
    });
    a.Cs.BlockListActive = Bbc.extend({
        url: "block/listactive/"
    });
    a.Cs.Rooms = Bbc.extend({
        url: "datadirect/roomget/"
    });
    a.Cs.Teachers = Bbc.extend({
        url: "datadirect/employeeget/"
    });
    a.Cs.Roles = Bbc.extend({
        url: "datadirect/FacultyRoleTypeGet/"
    });
    a.Cs.Students = Bbc.extend({
        url: "datadirect/offercoursestudentget/"
    });
    a.Ms.Teacher = Bbm.extend({
        defaults: {
            Role: 1
        },
        validation: {
            FacultyUserId: function(j, h, i) {
                if (!i["delete"] && (!j || j == 0)) {
                    return d.P3.RequiredInfoNotEntered
                }
            },
            Role: function(j, h, i) {
                if (!i["delete"] && (!j || j == 0)) {
                    return d.P3.RequiredInfoNotEntered
                }
            }
        }
    });
    a.Ms.Student = Bbm.extend({
        validation: {
            EnrollDate: {
                required: true,
                msg: d.P3.RequiredInfoNotEntered
            },
            DropDate: function(k, h, i) {
                var j;
                if (i.DeleteInd) {
                    if (i.DropType > 0 && !k) {
                        j = d.P3.RequiredInfoNotEntered
                    } else {
                        if (new Date(k) < new Date(i.EnrollDate)) {
                            j = "Drop Date must fall after the Enroll Date"
                        } else {
                            if (new Date(k) < new Date(i.DurationBeginDate) || new Date(i.DurationEndDate) < new Date(k)) {
                                j = "Drop Date must fall between the begining and end date of the term."
                            }
                        }
                    }
                }
                return j
            }
        }
    });
    a.Ms.ScheduleMakerSection = Bbm.extend({
        idAttribute: "SectionId",
        urlRoot: "Academics/Section/",
        defaults: {
            HasGrades: false,
            CanDelete: true,
            TeacherList: [],
            StudentList: []
        },
        validation: {
            SectionIdentifier: {
                required: true,
                msg: d.P3.RequiredInfoNotEntered
            },
            "TeacherList.FacultyUserId": function(j, h, i) {
                if (!i.DeleteSection && !_.isEmpty(i.TeacherList) && _.isEmpty(_.find(i.TeacherList, function(k) {
                        return k.FacultyUserId > 0
                    }))) {
                    return "false"
                }
            },
            "TeacherList.Role": function(j, h, i) {
                if (!i.DeleteSection && !_.isEmpty(i.TeacherList) && _.isEmpty(_.find(i.TeacherList, function(k) {
                        return k.Role > 0
                    }))) {
                    return "false"
                }
            },
            "TeacherList.Head": function(j, h, i) {
                if (!i.DeleteSection && !_.isEmpty(i.TeacherList) && _.isEmpty(_.find(i.TeacherList, function(k) {
                        return k.Head
                    }))) {
                    return "false"
                }
            },
            "StudentList.EnrollDate": function(j, h, i) {
                if (!i.DeleteSection && !_.isEmpty(i.StudentList) && _.isEmpty(_.find(i.StudentList, function(k) {
                        return k.EnrollDate
                    }))) {
                    return "false"
                }
            },
            "StudentList.DropDate": function(j, h, i) {
                if (!i.DeleteSection && !_.isEmpty(i.StudentList) && !_.isEmpty(_.find(i.StudentList, function(k) {
                        return k.DeleteInd && k.DropType > 0 && (!k.DropDate || new Date(k.DropDate) < new Date(k.EnrollDate) || new Date(k.DropDate) < new Date(i.DurationBeginDate) || new Date(i.DurationEndDate) < new Date(k.DropDate))
                    }))) {
                    return "false"
                }
            }
        }
    });
    a.Cs.OfferCourseSectionDetailGet = Bbc.extend({
        url: "datadirect/OfferCourseSectionDetailGet/"
    });
    a.Ms.OfferSectionSave = Bbm.extend({
        url: "Academics/OfferSectionSave/"
    });
    a.Cs.DepartmentWithCourse = Bbc.extend({
        url: "department/DepartmentWithOfferdCourse/"
    });
    a.Ms.BulkSectionCreateCheck = Bbm.extend({
        url: "Academics/BulkSectionCreateCheck/"
    });
    a.Ms.BulkSectionCreate = Bbm.extend({
        url: "Academics/BulkSectionCreate/",
        validation: {
            CreateCourseSection: [{
                fn: function(h) {
                    if (_.isNaN(h)) {
                        return "Please select a value"
                    }
                }
            }],
            CalculatedLowerMin: [{
                fn: function(j, h, i) {
                    if (i.CreateCourseSection === 1 && _.isNaN(j)) {
                        return "Please select a value"
                    }
                }
            }],
            CalculatedHigherMax: [{
                fn: function(j, h, i) {
                    if (i.CreateCourseSection === 1 && _.isNaN(j)) {
                        return "Please select a value"
                    }
                }
            }],
            CourseWithoutRequest: [{
                fn: function(j, h, i) {
                    if (_.isNaN(j)) {
                        return "Please select a value"
                    }
                }
            }],
            DepartmentList: [{
                fn: function(j, h, i) {
                    if (!_.isNull(j) && j.length === 0) {
                        return "Please select a value"
                    }
                }
            }]
        }
    });
    a.Vs.LayoutView = Bb.View.extend({
        template: "page/page.1col.wide.header.template.html",
        initialize: function(h) {
            h.settings = new Bbm({
                InactiveInd: -1,
                openDeptList: []
            });
            if (p3.Config.uiVersion === 3) {
                this.template = "coursesection/coursesection.layout.template.html"
            }
        },
        render: function(h) {
            p3.setTitle("Course Sections");
            var i = this;
            p3.fT(i.template, function(j) {
                i.$el.appendTo(h).html(j());
                i.Containers = {
                    Header: i.$("#header"),
                    MainColumn: i.$("#col-main")
                };
                p3.rV(new a.Vs.Filter(i.options), i.Containers.Header, false);
                p3.rV(new a.Vs.CourseSections(i.options), i.Containers.MainColumn, false)
            });
            f.Us.LoadNavigatorMenu()
        },
        dispose: function() {
            this.options.settings.off()
        }
    });
    a.Vs.AlertBox = Bb.View.extend({
        className: "alert alert-error p3Red bb-emphasized",
        attributes: {
            style: "margin-bottom: -10px; background-color: #F9D8D8; min-height: 25px; padding-bottom: 5px; padding-left: 15px; padding-right: 15px; padding-top: 15px; box-sizing: content-box;"
        },
        initialize: function(h) {
            h.collection.on("reset", this.renderTemplate, this)
        },
        render: function(h) {
            this.$el.appendTo(h).hide().append($("<i>", {
                "class": "p3icon-warning p3Red iconMedium pull-left",
                style: "margin:0px 10px 0px 0px; font-size:20px; text-shadow:0 3px 0 rgba(255,255,255,.5);"
            }), $("<h1>", {
                "class": "pull-left",
                style: "margin:-10px 10px 0px 0px; font-size:26px; font-weight:200"
            }), $("<p>", {
                "class": "pull-left p3Red",
                style: "font-size:16px;"
            }).html("Courses need teachers and/or sections added"))
        },
        renderTemplate: function(h) {
            var i = 0;
            if (h.length) {
                i = h.first().get("TotalNumCoursesWithoutTeacherOrSection");
                this.$("h1").html(i);
                this.$el.show()
            }
            if (i == 0) {
                this.$el.hide()
            }
        },
        dispose: function() {
            this.collection.off()
        }
    });
    a.Vs.CourseSections = Bb.View.extend({
        className: "accordion",
        events: {},
        initialize: function(h) {
            h.settings.on("change:DurationId", this.fetchCourseSections, this).on("change:InactiveInd", this.fetchCourseSections, this);
            this.collection = new a.Cs.CourseSections().on("reset", this.renderTemplate, this)
        },
        render: function(h) {
            this.Containers = {
                El: this.el,
                Top: $("<div>").appendTo(h)
            };
            if (p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.SCHEDULEMAKER)) {
                p3.rV(new a.Vs.AlertBox({
                    collection: this.collection
                }), this.Containers.Top, false)
            }
            this.$el.appendTo(h)
        },
        renderTemplate: function(h) {
            if (h.length) {
                _.each(_.sortBy(h.groupBy(function(j, i, k) {
                    return j.get("DepartmentId")
                }), function(i) {
                    return _.first(i).get("SortOrder")
                }), function(i) {
                    p3.rV(new a.Vs.Department({
                        model: _.first(i),
                        collection: new Bbc(i),
                        settings: this.options.settings
                    }), this.Containers.El, false)
                }, this)
            } else {
                this.$el.append($("<div>", {
                    style: "margin-left: 20px;"
                }).html("No Courses to display."))
            }
        },
        fetchCourseSections: function(h) {
            if (!h.has("DurationId") || h.hasChanged("InactiveInd")) {
                p3.clearContainer(this.Containers.El)
            }
            if (h.has("DurationId") || h.hasChanged("InactiveInd")) {
                this.collection.fetch({
                    data: {
                        levelNum: h.get("LevelNum"),
                        durationId: h.get("DurationId"),
                        inactiveInd: h.get("InactiveInd")
                    }
                })
            }
        },
        dispose: function() {
            this.collection.off()
        }
    });
    a.Vs.Department = Bb.View.extend({
        className: "accordion-group",
        attributes: {
            style: "border: none;"
        },
        template: "coursesection/coursesection.department.template.html",
        events: {
            "show .collapse": "showCollapse",
            "hide .collapse": "hideCollapse"
        },
        render: function(h) {
            var i = this;
            p3.fT(i.template, function(j) {
                i.$el.appendTo(h).html(j({
                    model: i.model.toJSON(),
                    collection: i.collection.toJSON(),
                    openDept: i.options.settings.get("openDeptList")[i.model.get("DepartmentId")],
                    smInstalled: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.SCHEDULEMAKER),
                    osInstalled: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.ONLINESIGNUP)
                }));
                i.Containers = {
                    Tbody: i.$("tbody")
                };
                i.collection.each(function(l, k, m) {
                    p3.rV(new a.Vs.Course({
                        model: l.set({
                            SchoolYearLabel: this.options.settings.get("SchoolYearLabel"),
                            LevelNum: this.options.settings.get("LevelNum"),
                            DurationId: this.options.settings.get("DurationId"),
                            DurationLabel: this.options.settings.get("DurationLabel")
                        }),
                        reload: function(n) {
                            i.reload(n)
                        },
                        sectionList: m
                    }), i.Containers.Tbody, false)
                }, i);
                p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.TableSort, function(k) {
                    k.$("#sort-table").stupidtable()
                }, i)
            })
        },
        showCollapse: function(h) {
            p3.slideArrowS(this.$("I.change-arrow"));
            this.options.settings.get("openDeptList")[this.model.get("DepartmentId")] = true
        },
        hideCollapse: function(h) {
            p3.slideArrowE(this.$("I.change-arrow"));
            this.options.settings.get("openDeptList")[this.model.get("DepartmentId")] = false
        },
        reload: function(h) {
            this.options.settings.unset("DurationId");
            this.options.settings.set({
                DurationId: h
            })
        }
    });
    a.Vs.Course = Bb.View.extend({
        tagName: "TR",
        template: "coursesection/coursesection.course.template.html",
        events: {
            "click button": "manageSections"
        },
        render: function(h) {
            var i = this;
            p3.fT(i.template, function(j) {
                i.$el.appendTo(h).html(j({
                    model: i.model.toJSON(),
                    smInstalled: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.SCHEDULEMAKER),
                    osInstalled: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.ONLINESIGNUP)
                }))
            })
        },
        manageSections: function(h) {
            this.showModal(this.model)
        },
        showNext: function(h) {
            this.showModal(h)
        },
        showModal: function(h) {
            var i = this;
            p3.rV(new a.Vs.ManageCourseModal({
                schoolYear: h.get("SchoolYearLabel"),
                levelNum: h.get("LevelNum"),
                durationId: h.get("DurationId"),
                offeringId: h.get("OfferingId"),
                parentSectionId: h.get("ParentSectionId"),
                durationLabel: h.get("DurationLabel"),
                reload: this.options.reload,
                nextSection: this.options.sectionList[_.indexOf(this.options.sectionList, h) + 1],
                showNext: function(j) {
                    i.showNext(j)
                }
            }), p3.Layout.Containers.Modal, true)
        },
        dispose: function() {
            this.model.off()
        }
    });
    a.Vs.ManageCourseModal = Bb.View.extend({
        template: "schedulemaker/courses/courses.modal.template.html",
        attributes: {
            id: "coursesection-modal"
        },
        events: {
            'click [data-action="section"]': "addSection",
            'click [data-action="save"]': "saveAll",
            'click [data-action="save-tab"]': "saveTab",
            'click [data-action="save-next"]': "saveAll"
        },
        initialize: function(h) {
            this.collection = new Bbc().on("add", this.addTab, this).on("remove", this.removeTab, this);
            h.section = new a.Cs.OfferCourseSectionDetailGet().once("reset", this.renderTemplate, this);
            h.blocks = new a.Cs.BlockListActive();
            h.rooms = new a.Cs.Rooms();
            h.teachers = new a.Cs.Teachers();
            h.roles = new a.Cs.Roles();
            h.students = new a.Cs.Students();
            h.section.fetch({
                data: {
                    durationId: h.durationId,
                    offeringId: h.offeringId,
                    parentSectionId: h.parentSectionId
                }
            });
            h.blocks.fetch({
                data: {
                    offeringType: 1,
                    levelNum: h.levelNum
                }
            });
            h.teachers.fetch({
                data: {
                    offeringType: 1,
                    durationId: h.durationId,
                    schoolYearLabel: h.schoolYear,
                    limitLevel: false
                }
            });
            h.rooms.fetch({
                data: {
                    offeringType: 1
                }
            });
            h.roles.fetch({
                data: {
                    offeringType: 1
                }
            });
            h.students.fetch({
                data: {
                    schoolYearLabel: h.schoolYear
                }
            });
            Bb.Validation.bind(this);
            if (p3.Data.Context.findByTaskId(53441)) {
                this.useAdminFields = true
            } else {
                this.useAdminFields = false
            }
        },
        render: function(h) {
            this.$el.appendTo(h)
        },
        renderTemplate: function(h) {
            var i = this;
            p3.fT(i.template, function(l) {
                var j = h.first(),
                    k;
                if (j) {
                    k = {
                        CourseTitle: j.get("CourseTitle"),
                        CourseLength: j.get("CourseLength")
                    };
                    switch (j.get("WarningColorInd")) {
                        case 2:
                            k.warningClass = "progress-warning progress-bar-warning";
                            break;
                        case 1:
                            k.warningClass = "progress-success progress-bar-success";
                            break;
                        default:
                            k.warningClass = "progress-danger progress-bar-danger";
                            break
                    }
                    if (!j.get("SectionId") && !j.get("SectionIdentifier") && h.length === 1) {
                        j.set("SectionIdentifier", 1)
                    }
                    k.warningText = j.get("WarningText");
                    i.$el.html(l({
                        model: k,
                        blockColor: i.options.blockColor,
                        canCreate: j.get("CanCreate"),
                        term: i.options.durationLabel,
                        smInstalled: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.SCHEDULEMAKER),
                        hasNext: !_.isEmpty(i.options.nextSection)
                    }));
                    i.Containers = {
                        Tabs: i.$("#add-section"),
                        TabContent: i.$(".tab-content")
                    };
                    _.each(_.sortBy(h.groupBy(function(m) {
                        return m.get("SectionId")
                    }), function(m) {
                        return _.first(m).get("SectionIdentifier")
                    }), function(o, m, n) {
                        if (m !== "null") {
                            this.collection.add(new a.Ms.ScheduleMakerSection(_.first(o).toJSON()).set({
                                TeacherList: _.map(_.groupBy(_.filter(o, function(p) {
                                    return p.has("FacultyUserId")
                                }), function(p) {
                                    return p.get("FacultyUserId")
                                }), function(r, p, q) {
                                    return _.first(r)
                                }),
                                StudentList: _.map(_.groupBy(_.filter(o, function(p) {
                                    return p.has("StudentUserId")
                                }), function(p) {
                                    return p.get("StudentUserId")
                                }), function(r, p, q) {
                                    return _.first(r)
                                })
                            }), {
                                active: (_.isUndefined(this.options.openSection)) ? this.collection.length === 0 : parseInt(m, 10) === this.options.openSection
                            })
                        }
                    }, i);
                    p3.showModal(p3.Layout.Containers.Modal)
                }
            })
        },
        addTab: function(i, h, j) {
            p3.rV(new a.Vs.SectionTab({
                model: i,
                collection: h
            }), this.Containers.Tabs, false);
            p3.rV(new a.Vs.SectionTabContent({
                model: i,
                attributes: {
                    id: i.cid
                },
                blocks: this.options.blocks,
                rooms: this.options.rooms,
                teachers: this.options.teachers,
                students: this.options.students,
                roles: this.options.roles,
                useAdminFields: this.useAdminFields
            }), this.Containers.TabContent, false);
            if (j.active) {
                this.$(".nav.nav-tabs a").eq(h.indexOf(i)).tab("show")
            }
        },
        addSection: function(h) {
            this.collection.add(new a.Ms.ScheduleMakerSection({
                showTab: true,
                SectionIdentifier: this.setIdentifier()
            }), {
                active: true
            })
        },
        removeTab: function(i, h, j) {
            this.$(".nav.nav-tabs a").eq((j.index == 0) ? 0 : j.index - 1).tab("show");
            if (h.length === 0) {
                this.$(".tab-pane").addClass("active")
            }
        },
        setIdentifier: function(h) {
            h = (h || this.collection.length) + 1;
            return _.contains(this.collection.pluck("SectionIdentifier"), h.toString()) ? this.setIdentifier(h) : h.toString()
        },
        saveAll: function(i) {
            var j = true,
                l = this,
                h, k = false;
            this.collection.each(function(m) {
                if (!m.isValid(true)) {
                    j = false
                }
                if (l.useAdminFields) {
                    h = m.adminView;
                    if (!h.validateFields()) {
                        j = false;
                        if (!k) {
                            k = true;
                            l.$(".nav.nav-tabs a").eq(l.collection.indexOf(m)).tab("show")
                        }
                    } else {
                        m.set("CustomFields", h.saveModel.get("Fields"))
                    }
                }
            });
            if (j) {
                this.saveModal(false, i, this.collection, ($(i.currentTarget).attr("data-action") === "save-next"))
            }
        },
        saveTab: function(i) {
            var j = true,
                k = new Bbc(this.collection.filter(function(m) {
                    return m.get("showTab")
                })),
                l = this,
                h;
            k.each(function(m) {
                if (!m.isValid(true)) {
                    j = false
                }
                if (l.useAdminFields) {
                    h = m.adminView;
                    if (!h.validateFields()) {
                        j = false
                    } else {
                        m.set("CustomFields", h.saveModel.get("Fields"))
                    }
                }
            });
            if (j) {
                this.saveModal(true, i, k)
            }
        },
        buildSectionList: function(h) {
            var i = [];
            _.each(h, function(j) {
                var k = {
                    SectionId: j.SectionId,
                    LeadSectionId: j.LeadSectionId,
                    SectionIdentifier: j.SectionIdentifier,
                    BlockId: j.BlockId,
                    RoomId: j.RoomId,
                    SectionIdentifier_UpdateInd: !!j.SectionIdentifier_UpdateInd,
                    BlockId_UpdateInd: !!j.BlockId_UpdateInd,
                    RoomId_UpdateInd: !!j.RoomId_UpdateInd,
                    DeleteSection: j.DeleteSection
                };
                if (j.TeacherList_UpdateInd) {
                    if (j.TeacherList && !j.TeacherList.length) {
                        k.ClearTeachers = true
                    } else {
                        k.TeacherList = j.TeacherList
                    }
                }
                if (j.StudentList_UpdateInd) {
                    k.StudentList = j.StudentList
                }
                if (j.CustomFields && !j.CustomFields.length) {
                    k.ClearCustomFields = true
                } else {
                    k.CustomFields = j.CustomFields
                }
                i.push(k)
            });
            return i
        },
        saveModal: function(k, h, i, j) {
            var l = this;
            new a.Ms.OfferSectionSave().save({
                durationId: this.options.durationId,
                offeringId: this.options.offeringId,
                parentSectionId: this.options.parentSectionId,
                sectionList: l.buildSectionList(i.toJSON()),
                singleSave: k
            }, {
                wait: true,
                section: i.first(),
                courses: l.options.section,
                reload: l.options.reload,
                reloadSingleSave: l.options.reloadSingleSave,
                showNext: l.options.showNext,
                nextSection: l.options.nextSection,
                beforeSend: function(m, o, n) {
                    $(h.currentTarget).button("loading")
                },
                success: function(o, p, m) {
                    p3.displaySiteMessage("Changes made will be applied to this and all future terms.", "alert-success");
                    if (o.get("singleSave")) {
                        $(h.currentTarget).button("reset");
                        if (m.section === undefined) {
                            m.section = new Bbm()
                        }
                        if (m.section.get("DeleteSection")) {
                            m.reload(o.get("durationId"));
                            m.section.collection.remove(m.section)
                        } else {
                            var n = m.section.has("SectionId");
                            m.section.set({
                                SectionId: parseInt(p, 10)
                            });
                            m.courses.fetch({
                                data: {
                                    durationId: o.get("durationId"),
                                    offeringId: o.get("offeringId"),
                                    parentSectionId: o.get("parentSectionId")
                                },
                                success: function(q) {
                                    var t = q.filter(function(u) {
                                            return u.get("SectionId") == p
                                        }),
                                        s = m.section.get("TeacherList_UpdateInd"),
                                        r = m.section.get("StudentList_UpdateInd");
                                    m.section.set({
                                        TeacherList: _.map(_.groupBy(_.filter(t, function(u) {
                                            return u.has("FacultyUserId")
                                        }), function(u) {
                                            return u.get("FacultyUserId")
                                        }), function(w, u, v) {
                                            return _.first(w)
                                        }),
                                        StudentList: _.map(_.groupBy(_.filter(t, function(u) {
                                            return u.has("StudentUserId")
                                        }), function(u) {
                                            return u.get("StudentUserId")
                                        }), function(w, u, v) {
                                            return _.first(w)
                                        })
                                    });
                                    m.section.set({
                                        TeacherList_UpdateInd: s,
                                        StudentList_UpdateInd: r
                                    });
                                    if (m.reloadSingleSave || !n) {
                                        m.reload(o.get("durationId"))
                                    }
                                }
                            })
                        }
                    } else {
                        m.reload(o.get("durationId"));
                        f.Us.LoadNavigatorMenu();
                        p3.showModal(p3.Layout.Containers.Modal, "hide");
                        if (j) {
                            m.showNext(m.nextSection)
                        }
                    }
                }
            })
        },
        dispose: function() {
            this.collection.off();
            Bb.Validation.unbind(this)
        }
    });
    a.Vs.SectionTab = Bb.View.extend({
        tagName: "LI",
        events: {
            "show a": "showTab"
        },
        initialize: function(h) {
            this.model.on("change:SectionIdentifier", this.changeLabel, this).on("remove", this.deleteSection, this).on("validated", this.validateSection, this)
        },
        render: function(h) {
            h.before(this.$el.append($("<a>", {
                href: "#".concat(this.model.cid),
                "data-toggle": "tab",
                "data-bypass": "1"
            })));
            this.changeLabel(this.model)
        },
        changeLabel: function(i) {
            var h = (i.get("SectionIdentifier") || "---");
            if (i.get("SectionLinked")) {
                h += '<div class="pull-right" style="margin:0px"><i class="p3icon-topicLink iconColor"></i></div>'
            }
            this.$("a").html(h)
        },
        deleteSection: function() {
            this.remove()
        },
        validateSection: function(j, i, h) {
            if (_.isEmpty(h)) {
                this.$("a").removeClass("alert alert-error")
            } else {
                this.$("a").addClass("alert alert-error")
            }
        },
        showTab: function(i, h) {
            _.each(this.collection.where({
                showTab: true
            }), function(j) {
                j.set("showTab", false)
            }, this);
            this.model.set("showTab", true)
        },
        changeModel: function(h, j, i) {
            return null
        },
        dispose: function() {
            this.model.off()
        }
    });
    a.Vs.SectionTabContent = Bb.View.extend({
        className: "tab-pane",
        template: "schedulemaker/courses/courses.model.section.template.html",
        events: {
            'change [name="SectionIdentifier"]': "changeInput",
            'keyup [name="SectionIdentifier"]': "changeInput",
            'click [data-action="section-remove"]': "clickRemove",
            'click [data-action="section-delete"]': "clickDelete"
        },
        initialize: function(h) {
            this.model.on("remove", this.deleteSection, this).on("validated", this.validateSection, this).on("change:SectionId", this.setDelete, this)
        },
        render: function(i) {
            var j = this,
                h;
            p3.fT(j.template, function(k) {
                j.$el.html(k({
                    model: j.model.toJSON()
                }));
                j.Containers = {
                    Form: j.$("form"),
                    Rooms: j.$("#rooms"),
                    Blocks: j.$("#blocks")
                };
                p3.rV(new a.Vs.SelectOptions({
                    collection: j.options.blocks,
                    model: j.model,
                    value: "BlockId",
                    label: "BlockName",
                    updateInd: "BlockId_UpdateInd"
                }), j.Containers.Blocks, false);
                p3.rV(new a.Vs.SelectOptions({
                    collection: j.options.rooms,
                    model: j.model,
                    value: "RoomId",
                    label: "Fullname",
                    updateInd: "RoomId_UpdateInd"
                }), j.Containers.Rooms, false);
                j.Containers.Form.append($("<hr>"));
                p3.rV(new a.Vs.Teachers(j.options), j.Containers.Form, false);
                j.Containers.Form.append($("<hr>"));
                p3.rV(new a.Vs.Students(j.options), j.Containers.Form, false);
                if (j.options.useAdminFields) {
                    j.Containers.Form.append($("<hr>"));
                    j.getAdminFields(function() {
                        h = new b.Vs.EditDataView({
                            locationIndexId: 10,
                            adminData: j.adminFields,
                            usageId: j.model.get("SectionId") || 0
                        });
                        j.model.adminView = h;
                        p3.rV(h, j.Containers.Form, false);
                        p3.setModalHeight(p3.Layout.Containers.Modal)
                    })
                }
            });
            this.$el.appendTo(i)
        },
        changeInput: function(h) {
            this.model.set("SectionIdentifier", $(h.currentTarget).val());
            this.model.set("SectionIdentifier_UpdateInd", true)
        },
        clickDelete: function(h) {
            this.model.set({
                DeleteSection: !$(h.currentTarget).is(".active")
            }, {
                silten: true
            })
        },
        clickRemove: function(h) {
            this.model.destroy()
        },
        deleteSection: function() {
            this.remove()
        },
        validateSection: function(j, i, h) {
            this.$("#infomessage-error").remove();
            if (_.isEmpty(h) || h.SectionIdentifier) {
                this.$("a").removeClass("alert alert-error")
            } else {
                this.$("a").addClass("alert alert-error");
                p3.Us.InfoMessage.ErrorBox("Please complete all required fields.", this.$el, false);
                p3.setModalHeight(p3.Layout.Containers.Modal)
            }
            if (h.SectionIdentifier) {
                this.$('[name="SectionIdentifier"]').addClass("box-validate").tooltip({
                    title: h.SectionIdentifier
                }).tooltip("enable").closest(".control-group").addClass("error")
            } else {
                this.$('[name="SectionIdentifier"]').removeClass("box-validate").tooltip("disable").closest(".control-group").removeClass("error")
            }
        },
        setDelete: function(h) {
            if (h.has("SectionId")) {
                this.$('[data-action="section-remove"]').attr("data-action", "section-delete")
            }
        },
        dispose: function() {
            this.model.off()
        },
        getAdminFields: function(h) {
            var i = this;
            i.adminFields = new b.Cs.UserFieldData();
            if (i.model.get("SectionId") > 0) {
                i.adminFields.fetch({
                    data: {
                        locationIndexId: 10,
                        usageId: i.model.get("SectionId")
                    },
                    success: h,
                    error: function() {
                        p3.displayError("Error loading admin fields")
                    }
                })
            } else {
                h()
            }
        }
    });
    a.Vs.Teachers = Bb.View.extend({
        tagName: "fieldset",
        initialize: function(h) {
            this.Containers = {
                Table: $("<table>", {
                    "class": "table table-striped table-condensed"
                }).hide(),
                El: this.$el,
                Message: $("<h6>").html("There are currently no teachers in this section.")
            };
            this.model.on("validated", this.validateTeacher, this).on("change:TeacherList", this.changeTeacherList, this);
            this.collection = new Bbc().on("add", this.addTeacherRow, this).on("remove", this.removeTeacherRow, this).on("change:Head", this.changeTeacher, this).on("change:delete", this.changeTeacher, this).on("change:Role", this.changeTeacher, this);
            this.teachers = new Bbc([], {
                comparator: "FacultyName"
            }).on("change:Selected", this.selectTeacher, this);
            if (h.teachers.length > 0) {
                this.renderTeachers(h.teachers)
            } else {
                h.teachers.once("reset", this.renderTeachers, this)
            }
        },
        render: function(h) {
            this.$el.appendTo(h).append(this.Containers.Message, this.Containers.Table.append(this.Containers.Tbody))
        },
        renderTeachers: function(h, i) {
            var j = this;
            j.teachers.reset(h.toJSON());
            p3.rV(new a.Vs.PeopleSearch({
                collection: j.teachers,
                Label: "FacultyName",
                Value: "FacultyUserId",
                Header: "Teacher"
            }), j.Containers.El, false);
            j.changeTeacherList(j.model);
            j.collection.on("change add remove reset", function() {
                j.model.set("TeacherList_UpdateInd", true)
            });
            p3.setModalHeight(p3.Layout.Containers.Modal)
        },
        changeTeacherList: function(h) {
            this.collection.update(_.map(h.get("TeacherList"), function(i, l, j) {
                var k = _.first(this.teachers.where({
                    FacultyUserId: i.get("FacultyUserId")
                }));
                return new a.Ms.Teacher({
                    FacultyUserId: i.get("FacultyUserId"),
                    FacultyName: k ? k.set({
                        Selected: true
                    }, {
                        silent: true
                    }).get("FacultyName") : "???",
                    Head: i.get("Head"),
                    Role: i.get("Role")
                })
            }, this), {
                show: true
            })
        },
        addTeacherRow: function(i, h, j) {
            if (j.show) {
                this.Containers.Message.hide();
                this.Containers.Table.show()
            }
            this.setTeacherList();
            p3.rV(new a.Vs.TeacherRow({
                model: i,
                roles: this.options.roles
            }), this.Containers.Table, false)
        },
        removeTeacherRow: function(i, h) {
            if (h.length === 0) {
                this.Containers.Message.show();
                this.Containers.Table.hide()
            }
            _.first(this.teachers.where({
                FacultyUserId: i.get("FacultyUserId")
            })).unset("Selected", {
                silent: true
            });
            this.setTeacherList()
        },
        changeTeacher: function(h) {
            if (h.get("Head") && h.hasChanged("Head")) {
                _.each(this.collection.reject(function(i) {
                    return !(i.get("Head") && h.cid != i.cid)
                }), function(i) {
                    i.set({
                        Head: false
                    })
                })
            }
            this.setTeacherList()
        },
        setTeacherList: function() {
            this.model.set({
                TeacherList: _.filter(this.collection.toJSON(), function(h) {
                    return !h["delete"]
                })
            }, {
                silent: true
            })
        },
        selectTeacher: function(h) {
            if (h.get("Selected")) {
                this.collection.add(new a.Ms.Teacher({
                    FacultyUserId: h.get("FacultyUserId"),
                    FacultyName: h.get("FacultyName"),
                    Head: (this.collection.length === 0) ? true : false,
                    canRemove: true
                }), {
                    show: this.collection.length === 0
                })
            }
        },
        validateTeacher: function(j, i, h) {
            this.collection.each(function(k) {
                k.isValid(true)
            });
            if (h["TeacherList.Head"] == "false") {
                this.$('[data-action="head"]').addClass("box-validate").css("background-image", "none")
            } else {
                this.$('[data-action="head"]').removeClass("box-validate").css("background-image", "initial")
            }
            if (h.hasTeacherList) {
                this.$('[name="Teacher"]').addClass("box-validate").tooltip({
                    title: h.hasTeacherList
                }).tooltip("enable")
            } else {
                this.$('[name="Teacher"]').removeClass("box-validate").tooltip("disable")
            }
        },
        dispose: function() {
            this.model.off();
            this.collection.off();
            this.teachers.off()
        }
    });
    a.Vs.TeacherRow = Bb.View.extend({
        tagName: "TR",
        template: "schedulemaker/courses/courses.model.addsectionteacher.row.template.html",
        events: {
            'click [data-action="remove"]': "removeTeacher",
            'click [data-action="delete"]': "deleteTeacher",
            'click [data-action="head"]:not(.active)': "headTeacherOn"
        },
        initialize: function(h) {
            Bb.Validation.bind(this);
            this.model.on("remove", this.removeRow, this).on("change:Head", this.markHead, this).on("validated", this.validateTeacher, this)
        },
        render: function(h) {
            var i = this;
            p3.fT(i.template, function(j) {
                i.$el.appendTo(h).html(j({
                    model: i.model.toJSON()
                }));
                i.Containers = {
                    Roles: i.$("#select-role")
                };
                p3.rV(new a.Vs.SelectOptions({
                    collection: i.options.roles,
                    model: i.model,
                    value: "Role",
                    label: "RoleType"
                }), i.Containers.Roles, false)
            })
        },
        deleteTeacher: function(h) {
            this.model.set({
                "delete": !$(h.currentTarget).is(".active")
            })
        },
        removeTeacher: function(h) {
            this.model.destroy()
        },
        removeRow: function(h) {
            this.remove()
        },
        headTeacherOn: function(h) {
            this.model.set({
                Head: true
            })
        },
        markHead: function(h) {
            if (h.get("Head")) {
                this.$('[data-action="head"]').addClass("active").removeClass("box-validate").css("background-image", "initial")
            } else {
                this.$('[data-action="head"]').removeClass("active")
            }
        },
        dispose: function() {
            this.model.off();
            Bb.Validation.unbind(this)
        }
    });
    a.Vs.Students = Bb.View.extend({
        tagName: "fieldset",
        initialize: function(h) {
            this.Containers = {
                Table: $("<table>", {
                    "class": "table table-striped table-condensed"
                }).hide(),
                El: this.$el,
                Message: $("<h6>").html("There are currently no students in this section.")
            };
            this.model.on("validated", this.validateStudent, this).on("change:StudentList", this.changeStudentList, this);
            this.collection = new Bbc().on("add", this.addStudentRow, this).on("remove", this.removeStudentRow, this).on("change:EnrollDate", this.changeStudent, this).on("change:DeleteInd", this.changeStudent, this).on("change:DropType", this.changeStudent, this).on("change:DropDate", this.changeStudent, this);
            this.students = new Bbc([], {
                comparator: "StudentName"
            }).on("change:Selected", this.selectStudent, this);
            if (h.students.length > 0) {
                this.renderStudents(h.students)
            } else {
                h.students.once("reset", this.renderStudents, this)
            }
        },
        render: function(h) {
            this.$el.appendTo(h).append(this.Containers.Message, this.Containers.Table.append(this.Containers.Tbody))
        },
        renderStudents: function(h) {
            var i = this;
            i.students.reset(h.toJSON());
            p3.rV(new a.Vs.PeopleSearch({
                collection: this.students,
                Label: "StudentName",
                Value: "StudentUserId",
                Header: "Student"
            }), i.Containers.El, false);
            i.changeStudentList(i.model);
            i.collection.on("change add remove reset", function() {
                i.model.set("StudentList_UpdateInd", true)
            });
            p3.setModalHeight(p3.Layout.Containers.Modal)
        },
        changeStudentList: function(h) {
            this.collection.update(_.map(_.sortBy(h.get("StudentList"), function(i) {
                return i.get("StudentName")
            }), function(i) {
                var j = _.first(this.students.where({
                    StudentUserId: i.get("StudentUserId")
                }));
                if (j) {
                    j.set({
                        Selected: true
                    }, {
                        silent: true
                    })
                }
                return new a.Ms.Student({
                    StudentUserId: i.get("StudentUserId"),
                    StudentName: i.get("StudentName"),
                    EnrollDate: p3.Us.DateTime.format(i.get("BeginDate"), "M/d/yyyy"),
                    DropDate: p3.Us.DateTime.format(p3.Us.DateTime.localDateTime(), "M/d/yyyy"),
                    HasGrades: i.get("HasGrades"),
                    DurationBeginDate: i.get("DurationBeginDate"),
                    DurationEndDate: i.get("DurationEndDate")
                })
            }, this), {
                show: true
            })
        },
        changeStudent: function() {
            this.model.set({
                StudentList: this.collection.toJSON()
            }, {
                silent: true
            })
        },
        addStudentRow: function(i, h, j) {
            if (j.show) {
                this.Containers.Message.hide();
                this.Containers.Table.show()
            }
            this.changeStudent();
            p3.rV(new a.Vs.StudentRow({
                model: i
            }), this.Containers.Table, false)
        },
        removeStudentRow: function(i, h) {
            if (h.length === 0) {
                this.Containers.Message.show();
                this.Containers.Table.hide()
            }
            var j = this.students.find(function(k) {
                return k.get("StudentUserId") == i.get("StudentUserId")
            });
            if (j) {
                j.unset("Selected", {
                    silent: true
                })
            }
        },
        selectStudent: function(h) {
            if (h.get("Selected")) {
                this.collection.add(new a.Ms.Student({
                    StudentUserId: h.get("StudentUserId"),
                    StudentName: h.get("StudentName"),
                    EnrollDate: p3.Us.DateTime.format(p3.Us.DateTime.localDateTime(), "M/d/yyyy"),
                    canRemove: true
                }), {
                    show: this.collection.length === 0
                })
            }
        },
        validateStudent: function(j, i, h) {
            this.collection.each(function(k) {
                k.isValid(true)
            })
        },
        dispose: function() {
            this.model.off();
            this.collection.off();
            this.students.off()
        }
    });
    a.Vs.StudentRow = Bb.View.extend({
        tagName: "TR",
        template: "schedulemaker/courses/courses.model.addsectionstudent.row.template.html",
        events: {
            'click [data-action="remove"]': "removeStudent",
            'click [data-action="drop"].active': "keepStudent",
            'click [data-action="drop"]:not(.active):not(.disabled)': "dropStudent",
            "hidden .collapse": "hideCollapse",
            "shown .collapse": "hideCollapse",
            'blur [name="DropDate"]': "changeDropDate"
        },
        initialize: function(h) {
            Bb.Validation.bind(this);
            this.model.on("remove", this.removeRow, this)
        },
        render: function(h) {
            var i = this;
            p3.fT(i.template, function(j) {
                i.$el.appendTo(h).html(j({
                    model: i.model.toJSON()
                }));
                i.Containers = {
                    StartDate: i.$(".span7,.col-md-7")
                };
                if (i.model.get("canRemove")) {
                    i.editDate()
                } else {
                    i.editDisplay()
                }
                c.Us.initialize(i.$('[name="DropDate"]'), {
                    numberOfMonths: 1,
                    stepMonths: 1,
                    dateFormat: "m/d/yy",
                    minDate: i.model.get("DurationBeginDate"),
                    maxDate: i.model.get("DurationEndDate")
                }, i.model.get("DropDate"))
            })
        },
        removeStudent: function(h) {
            this.model.destroy()
        },
        removeRow: function(h) {
            this.remove()
        },
        changeDropDate: function(h) {
            var i = $(h.currentTarget).datepicker("getDate");
            this.model.set({
                DropDate: i ? p3.Us.DateTime.format(i, "M/d/yyyy") : null
            })
        },
        dropStudent: function(h) {
            this.$('[data-action="drop"]').removeClass("active");
            $(h.currentTarget).addClass("active");
            this.$(".collapse:not(.in)").collapse("show");
            this.model.set({
                DeleteInd: true,
                DropType: $(h.currentTarget).val()
            });
            if ($(h.currentTarget).val() == "0") {
                this.$('[name="DropDate"]').attr("disabled", "disabled")
            } else {
                this.$('[name="DropDate"]').removeAttr("disabled")
            }
        },
        keepStudent: function(h) {
            $(h.currentTarget).removeClass("active");
            this.$(".collapse").collapse("hide");
            this.model.set({
                DeleteInd: false
            })
        },
        hideCollapse: function(h) {
            h.stopPropagation()
        },
        editDate: function(h) {
            p3.rV(new a.Vs.StartDateEdit({
                model: this.model
            }), this.Containers.StartDate, true)
        },
        editDisplay: function(h) {
            p3.rV(new a.Vs.StartDateDisplay({
                model: this.model
            }), this.Containers.StartDate, true)
        },
        dispose: function() {
            this.model.off();
            Bb.Validation.unbind(this)
        }
    });
    a.Vs.StartDateDisplay = Bb.View.extend({
        tagName: "UL",
        className: "inline mb-0 list-inline",
        render: function(h) {
            this.$el.appendTo(h).append($("<li>", {
                "class": "pl-0 pr-0"
            }).html(this.model.get("EnrollDate")))
        }
    });
    a.Vs.StartDateEdit = Bb.View.extend({
        tagName: "UL",
        className: "inline mb-0 list-inline",
        events: {
            "blur input": "changeEnrollDate"
        },
        render: function(h) {
            this.$el.appendTo(h).append($("<li>", {
                "class": "pl-0 pr-0"
            }).append($("<input>", {
                type: "text",
                "class": "input-mini",
                name: "EnrollDate"
            })));
            c.Us.initialize(this.$("input"), {
                numberOfMonths: 1,
                stepMonths: 1,
                dateFormat: "m/d/yy"
            }, this.model.get("EnrollDate"))
        },
        changeEnrollDate: function(h) {
            var i = $(h.currentTarget).datepicker("getDate");
            this.model.set({
                EnrollDate: i ? p3.Us.DateTime.format(i, "M/d/yyyy") : null
            })
        }
    });
    a.Vs.SelectOptions = Bb.View.extend({
        tagName: "select",
        className: "input-medium input-sm",
        events: {
            change: "changeSelect"
        },
        initialize: function(h) {
            this.collection.once("reset", this.setOptions, this)
        },
        render: function(h) {
            this.$el.appendTo(h).attr("name", this.options.value).append($("<option>", {
                value: 0
            }).html("--Not Set--"));
            this.setOptions(this.collection)
        },
        setOptions: function(h) {
            h.each(function(i) {
                this.$el.append($("<option>", {
                    value: i.get(this.options.value)
                }).html(i.get(this.options.label)))
            }, this);
            this.$el.val(this.model.get(this.options.value))
        },
        changeSelect: function(h) {
            this.model.set(this.options.value, parseInt($(h.currentTarget).val(), 10));
            this.model.set(this.options.updateInd, true)
        },
        dispose: function() {
            this.collection.off()
        }
    });
    a.Vs.PeopleSearch = Bb.View.extend({
        className: "clearfix",
        template: "schedulemaker/courses/courses.model.addsectionteacher.template.html",
        events: {
            'click [data-action="search"]': "searchAll"
        },
        render: function(h) {
            var i = this;
            p3.fT(i.template, function(j) {
                i.$el.prependTo(h).html(j({
                    Header: i.options.Header
                }));
                _.defer(function() {
                    p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.jQueryUI, a.Us.initializeAutoComplete, i)
                })
            })
        },
        searchAll: function(h) {
            this.$("input").focus().val("").autocomplete("search", "display-all")
        }
    });
    a.Us.initializeAutoComplete = function(h) {
        h.$("input").autocomplete({
            delay: 0,
            appendTo: h.$(".input-append"),
            source: function(i, j) {
                j(_.map($.grep(_.reject(h.collection.toJSON(), function(k) {
                    return k.Selected
                }), function(k) {
                    return new RegExp($.ui.autocomplete.escapeRegex((i.term === "display-all") ? "" : i.term), "i").test(k[h.options.Label])
                }), function(k) {
                    return {
                        label: k[h.options.Label],
                        id: k[h.options.Value]
                    }
                }, this))
            },
            select: function(i, j) {
                $(i.target).val("");
                h.collection.find(function(k) {
                    return k.get(h.options.Value) == j.item.id
                }).set({
                    Selected: true
                });
                return false
            },
            change: function(i, j) {
                $(i.target).val("")
            }
        })
    };
    a.Vs.Filter = Bb.View.extend({
        className: p3.Config.uiVersion === 1 ? "popContainerStraight containerTop pt-10 pr-10 pl-20 mb-15 clearfix" : "",
        template: "coursesection/coursesection.filter.template.html",
        events: {
            'change [name="SchoolYearLabel"]': "changeSchoolYear",
            'change [name="InactiveInd"]': "changeInactiveInd",
            'click [value="bluk-section-add"]': "clickBulkSectionAdd"
        },
        initialize: function(h) {
            this.collection = new a.Cs.SchoolYears().once("reset", this.renderTemplate);
            this.collection.fetch({
                data: {
                    display: 2
                },
                view: this,
                success: function(i, k, j) {
                    if (!p3.getSessionState("SMLoadMenu")) {
                        if (i.length) {
                            j.view.setSchoolYear(_.findWhere(k, {
                                Current: true
                            }).Id)
                        }
                    }
                }
            });
            this.listenTo(h.settings, "change:DurationId", this.setDuration)
        },
        render: function(h) {
            this.$el.appendTo(h)
        },
        renderTemplate: function(h, i) {
            var j = p3.getSessionState("SMLoadMenu");
            if (j) {
                if (h.length > 0) {
                    _.first(h.where({
                        Id: p3.getSessionState("SMSchoolYearId")
                    })).set({
                        Selected: true
                    });
                    i.view.setSchoolYear(p3.getSessionState("SMSchoolYearId"))
                }
            } else {
                _.first(h.where({
                    Current: true
                })).set({
                    Selected: true
                })
            }
            p3.fT(i.view.template, function(k) {
                i.view.$el.html(k({
                    collection: h.toJSON(),
                    disfilters: j,
                    hasSchedule: p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.SCHEDULE)
                }));
                i.view.setDuration(i.view.options.settings);
                i.view.Containers = {
                    SchoolLevel: i.view.$("#school-level"),
                    SchoolTerm: i.view.$("#school-term"),
                    Report: i.view.$(".report-container")
                };
                p3.rV(new a.Vs.FilterSchoolLevel(i.view.options), i.view.Containers.SchoolLevel, false);
                p3.rV(new a.Vs.FilterSchoolTerm(i.view.options), i.view.Containers.SchoolTerm, false);
                p3.rV(new a.Vs.Reports(i.view.options), i.view.Containers.Report, false)
            })
        },
        changeSchoolYear: function(h) {
            this.setSchoolYear($(h.currentTarget).val())
        },
        setSchoolYear: function(h) {
            this.options.settings.set("SchoolYearLabel", h)
        },
        changeInactiveInd: function(h) {
            this.options.settings.set("InactiveInd", parseInt($(h.currentTarget).val(), 10))
        },
        clickBulkSectionAdd: function() {
            p3.rV(new a.Vs.BulkSectionAddModal(this.options), p3.Layout.Containers.Modal, true)
        },
        setDuration: function(h) {
            if (h.has("DurationId")) {
                this.$('[value="bluk-section-add"]').removeAttr("disabled")
            } else {
                this.$('[value="bluk-section-add"]').attr("disabled", "disabled")
            }
        }
    });
    a.Vs.BulkSectionAddModal = Bb.View.extend({
        template: "coursesection/coursesection.modal.bulksectionadd.template.html",
        events: {
            'change [name="SelectDepartment"]': "changeDepartment",
            'click [data-action="save"]': "clickSave",
            'change [name="CreateCourseSection"]': "changeCreateCourseSection"
        },
        initialize: function() {
            this.model = new a.Ms.BulkSectionCreate();
            this.collection = new a.Cs.DepartmentWithCourse();
            this.listenTo(this.collection, "change:Selected", this.selectDepartment);
            this.listenTo(this.model, "validated:valid", this.saveValid);
            Bb.Validation.bind(this)
        },
        render: function(h) {
            var i = this;
            p3.fT(i.template, function(j) {
                i.$el.html(j({
                    schoolYear: i.options.settings.get("SchoolYearLabel"),
                    schoolLevel: i.options.settings.get("schoolLevelLabel"),
                    term: i.options.settings.get("DurationLabel")
                }));
                i.Containers = {
                    SelectDepartment: i.$("#select-department"),
                    Modal: i.$("#modal-modal")
                };
                i.collection.fetch({
                    data: {
                        levelNum: i.options.settings.get("LevelNum"),
                        durationId: i.options.settings.get("DurationId")
                    },
                    success: function() {
                        i.selectDepartment(undefined, undefined, {
                            addNew: true
                        });
                        i.$('[name="CreateCourseSection"]').change();
                        i.$('[value="all"]').click()
                    }
                });
                p3.showModal(p3.Layout.Containers.Modal)
            });
            this.$el.appendTo(h)
        },
        selectDepartment: function(h, j, i) {
            if (i.addNew) {
                p3.rV(new a.Vs.SelectDepartment({
                    collection: this.collection
                }), this.Containers.SelectDepartment, false)
            }
        },
        changeDepartment: function(h) {
            if ($(h.currentTarget).val() === "all") {
                this.$("#select-department > select").attr("disabled", "disabled")
            } else {
                this.$("#select-department > select").removeAttr("disabled")
            }
        },
        changeCreateCourseSection: function(h) {
            if ($(h.currentTarget).val() === "1") {
                this.$('select[name^="Calculated"]').removeAttr("disabled")
            } else {
                this.$('select[name^="Calculated"]').attr("disabled", "disabled")
            }
        },
        clickSave: function() {
            this.model.set({
                CreateCourseSection: parseInt(this.$('[name="CreateCourseSection"]').val(), 10),
                CalculatedLowerMin: parseInt(this.$('[name="CalculatedLowerMin"]').val(), 10),
                CalculatedHigherMax: parseInt(this.$('[name="CalculatedHigherMax"]').val(), 10),
                CourseWithoutRequest: parseInt(this.$('[name="CourseWithoutRequest"]').val(), 10),
                ClearExisting: this.$('[name="ClearExisting"]').is(":checked"),
                DepartmentList: this.$('[value="select-dept"]').is(":checked") ? this.collection.where({
                    Selected: true
                }) : null
            }, {
                validate: true
            })
        },
        runBulkSection: function() {
            var i = this,
                h = this.$('[data-action="save"]');
            h.button("loading");
            this.model.save({
                LevelNum: this.options.settings.get("LevelNum"),
                DurationId: this.options.settings.get("DurationId")
            }, {
                validate: false,
                success: function(j) {
                    i.options.settings.unset("DurationId");
                    i.options.settings.set({
                        DurationId: j.get("DurationId")
                    });
                    p3.Layout.Containers.Modal.modal("hide")
                },
                error: function(k, j) {
                    h.button("reset");
                    i.$("#infomessage-error").remove();
                    if (j.responseText.indexOf("ERR_CLEAR_COURSE_HAS_GRADE") > -1 || j.responseText.indexOf("ERR_CLEAR_COURSE_HAS_ATTENDANCE") > -1) {
                        p3.Us.InfoMessage.ErrorBox("Existing sections can not be cleared because attendance and/or grades have been recorded.", ".modal-body", false);
                        p3.setModalHeight(p3.Layout.Containers.Modal)
                    }
                }
            })
        },
        saveValid: function(i) {
            var j = this,
                h = this.$('[data-action="save"]');
            if (i.get("ClearExisting")) {
                h.button("loading");
                new a.Ms.BulkSectionCreateCheck().fetch({
                    data: {
                        levelNum: this.options.settings.get("LevelNum"),
                        durationId: this.options.settings.get("DurationId"),
                        departments: JSON.stringify(_.map(i.get("DepartmentList"), function(k) {
                            return {
                                DepartmentId: k.get("DepartmentId")
                            }
                        }))
                    },
                    success: function(k) {
                        h.button("reset");
                        var l = "Clearing sections will remove the following data:<br>";
                        if (k.get("HasFaculty")) {
                            l = l + "Teachers<br>"
                        }
                        if (k.get("HasEnrollment")) {
                            l = l + "Students<br>"
                        }
                        if (k.get("HasMeetingTime")) {
                            l = l + "Meeting Times<br>"
                        }
                        if (k.get("HasCustomFields")) {
                            l = l + "Custom Fields<br>"
                        }
                        if (k.get("HasRooms")) {
                            l = l + "Rooms<br>"
                        }
                        if (l.length === 52) {
                            j.runBulkSection()
                        } else {
                            p3.showConfirm("Are you sure you want to clear existing sections?", l, null, function() {
                                j.runBulkSection()
                            }, j.Containers.Modal);
                            p3.setModalHeight(j.Containers.Modal)
                        }
                    }
                })
            } else {
                this.runBulkSection()
            }
        },
        dispose: function() {
            Bb.Validation.unbind(this)
        }
    });
    a.Vs.SelectDepartment = Bb.View.extend({
        tagName: "select",
        className: "input-xlarge mb-10 form-control",
        attributes: {
            name: "DepartmentList"
        },
        events: {
            change: "changeDepartment"
        },
        initialize: function() {
            this.selectDepartment();
            this.listenTo(this.collection, "change:Selected", this.selectDepartment)
        },
        render: function(h) {
            this.$el.appendTo(h);
            p3.setModalHeight(p3.Layout.Containers.Modal)
        },
        changeDepartment: function(h) {
            var j = parseInt($(h.currentTarget).val(), 10),
                i = !_.isUndefined(this.departmentId),
                k = this.collection.filter(function(l) {
                    return !l.get("Selected") || l.get("Selected") === false
                });
            if (i) {
                this.collection.findWhere({
                    DepartmentId: this.departmentId
                }).set({
                    Selected: false
                }, {
                    silent: !_.isNaN(j),
                    addNew: _.isEmpty(k)
                })
            }
            if (!_.isNaN(j)) {
                this.departmentId = j;
                this.collection.findWhere({
                    DepartmentId: j
                }).set({
                    Selected: true
                }, {
                    addNew: !i && k.length > 1
                })
            } else {
                this.remove();
                p3.setModalHeight(p3.Layout.Containers.Modal)
            }
        },
        selectDepartment: function() {
            this.$el.empty();
            this.$el.append($("<option>").html("Select a value"));
            this.collection.each(function(h) {
                if (!h.get("Selected") || this.departmentId === h.get("DepartmentId")) {
                    this.$el.append($("<option>", {
                        value: h.get("DepartmentId")
                    }).html(h.get("ShortDescription")))
                }
            }, this);
            if (this.departmentId) {
                this.$el.val(this.departmentId)
            }
        }
    });
    a.Vs.FilterSchoolLevel = Bb.View.extend({
        tagName: "select",
        className: "input-medium input-sm",
        events: {
            change: "changeSchoolLevel"
        },
        initialize: function(h) {
            this.listenTo(h.settings, "change:LevelNum", this.setSchoolLevelLabel);
            this.collection = new a.Cs.SchoolLevels().on("add", this.renderOption, this);
            this.collection.fetch({
                view: this,
                update: true,
                success: function(i, k, j) {
                    if (i.length) {
                        j.view.container.html(j.view.el);
                        j.view.setSchoolLevel(_.first(k).LevelNum)
                    }
                }
            })
        },
        render: function(h) {
            this.container = h;
            if (p3.getSessionState("SMLoadMenu")) {
                this.$el.attr("disabled", true)
            }
        },
        renderOption: function(h) {
            this.$el.append($("<option>", {
                value: h.get("LevelNum")
            }).html(h.get("DdDescription")))
        },
        changeSchoolLevel: function(h) {
            this.setSchoolLevel($(h.currentTarget).val())
        },
        setSchoolLevel: function(h) {
            if (p3.getSessionState("SMLoadMenu")) {
                this.options.settings.set("LevelNum", p3.getSessionState("SMSchoolLevelId"));
                this.$el.find("[value='" + p3.getSessionState("SMSchoolLevelId") + "']").attr("selected", "selected")
            } else {
                this.options.settings.set("LevelNum", h)
            }
        },
        setSchoolLevelLabel: function(h, i) {
            h.set({
                schoolLevelLabel: this.collection.findWhere({
                    LevelNum: parseInt(i, 10)
                }).get("DdDescription")
            })
        },
        dispose: function() {
            this.collection.off()
        }
    });
    a.Vs.FilterSchoolTerm = Bb.View.extend({
        tagName: "span",
        events: {
            "change select": "changeSchoolTerm"
        },
        initialize: function(h) {
            h.settings.on("change:SchoolYearLabel", this.fetchTerms, this).on("change:LevelNum", this.fetchTerms, this);
            this.collection = new a.Cs.SchoolTerms().on("add", this.renderOption, this)
        },
        render: function(h) {
            this.$el.appendTo(h).append($("<div>", {
                style: "display: inline-block;",
                "class": "input-medium"
            }).append($("<label>", {
                "class": "pull-left mr-5 mt-5"
            }).append($("<em>").html("No Terms")), $("<select>", {
                "class": "input-medium input-sm"
            }).hide()))
        },
        renderOption: function(i) {
            var h = {
                value: i.get("DdId")
            };
            if (i.get("CurrentDuration")) {
                h.selected = "selected"
            }
            this.$("select").append($("<option>", h).html(i.get("DdDescription")))
        },
        fetchTerms: function(h) {
            this.$("select").empty().hide();
            this.$("label").show();
            this.unsetSchoolTerms();
            if (h.has("SchoolYearLabel") && h.has("LevelNum")) {
                this.collection.fetch({
                    view: this,
                    update: true,
                    data: {
                        schoolYearLabel: h.get("SchoolYearLabel"),
                        levelNum: h.get("LevelNum"),
                        offeringType: 1
                    },
                    success: function(i, l, k) {
                        if (i.length) {
                            k.view.$("select").show();
                            k.view.$("label").hide();
                            var j = i.where({
                                CurrentDuration: true
                            });
                            if (_.isEmpty(j)) {
                                k.view.setSchoolTerms(i.at(0).get("DdId"))
                            } else {
                                k.view.setSchoolTerms(_.first(j).get("DdId"))
                            }
                        }
                    }
                })
            }
        },
        changeSchoolTerm: function(h) {
            this.unsetSchoolTerms();
            this.setSchoolTerms($(h.currentTarget).val(), true)
        },
        setSchoolTerms: function(i, h) {
            if (!h && p3.getSessionState("SMLoadMenu") && p3.getSessionState("SMTermId") != -1) {
                this.options.settings.set("DurationId", p3.getSessionState("SMTermId"));
                this.$("select").val(p3.getSessionState("SMTermId"))
            } else {
                this.options.settings.set("DurationId", i)
            }
            this.options.settings.set("DurationLabel", _.first(this.collection.where({
                DdId: parseInt(this.options.settings.get("DurationId"), 10)
            })).get("DdDescription"))
        },
        unsetSchoolTerms: function() {
            if (this.options.settings.has("DurationId")) {
                this.options.settings.unset("DurationId");
                this.options.settings.unset("DurationLabel")
            }
        },
        dispose: function() {
            this.collection.off()
        }
    });
    a.Vs.Reports = Bb.View.extend({
        template: "ScheduleMaker/reports.template.html",
        attributes: {
            "class": "pull-right",
            id: "report-ddlb"
        },
        render: function(h) {
            $(h).append(this.el);
            var i = this;
            if (!p3.Data.ReportList) {
                e.loadReportList({
                    success: function(j, k) {
                        i.renderTemplate()
                    }
                })
            } else {
                i.renderTemplate()
            }
        },
        renderTemplate: function() {
            var h = new e.Cs.ReportList(),
                i = this;
            if (e.hasAccessToReportId(126)) {
                h.add(new e.Ms.ReportList({
                    ReportName: "Free Rooms by Block (Manager)",
                    Link: g.Us.getUrlById(1691, "__pd=gm_fv&pk=126")
                }))
            }
            if (e.hasAccessToReportId(127)) {
                h.add(new e.Ms.ReportList({
                    ReportName: "Free Teachers by Block (Manager)",
                    Link: g.Us.getUrlById(1691, "__pd=gm_fv&pk=127")
                }))
            }
            if (e.hasAccessToReportId(216)) {
                h.add(new e.Ms.ReportList({
                    ReportName: "Course Roster by Teacher",
                    Link: g.Us.getUrlById(1691, "__pd=gm_fv&pk=216")
                }))
            }
            if (e.hasAccessToReportId(240)) {
                h.add(new e.Ms.ReportList({
                    ReportName: "Course Sections by School Year",
                    Link: g.Us.getUrlById(1691, "__pd=gm_fv&pk=240")
                }))
            }
            if (e.hasAccessToReportId(345)) {
                h.add(new e.Ms.ReportList({
                    ReportName: "Parent Contact Information by Section",
                    Link: g.Us.getUrlById(1691, "__pd=gm_fv&pk=345")
                }))
            }
            if (e.hasAccessToReportId(236)) {
                h.add(new e.Ms.ReportList({
                    ReportName: "Course Enrollments",
                    Link: g.Us.getUrlById(1691, "__pd=gm_fv&pk=236")
                }))
            }
            if (e.hasAccessToReportId(233)) {
                h.add(new e.Ms.ReportList({
                    ReportName: "Course Enrollments by Gender",
                    Link: g.Us.getUrlById(1691, "__pd=gm_fv&pk=233")
                }))
            }
            p3.fT(i.template, function(j) {
                i.$el.html(j({
                    collection: h.toJSON()
                }))
            })
        },
        slideContent: function(i) {
            var h = $(i.target).closest("a").next("div.data-box");
            h.slideToggle(500)
        }
    });
    p3.router().route("coursesections", "coursesections", function() {
        p3.renderMainPage(new a.Vs.LayoutView({}))
    })
}(p3.module("LMS/Shared/coursesections")));
(function(a) {
    var d = p3.module("shared/task"),
        b = p3.module("LMS/groupPageEdit"),
        e = p3.module("LMS/topic"),
        c = p3.module("LMS/roster");
    a.Pages = [{
        Id: 1,
        ContentId: 433,
        Label: "Bulletin Board",
        RoutePage: "bulletinboard",
        IconClass: "p3icon-page",
        Display: function(f) {
            var g = new b.Vs.LayoutView({
                sectionId: a.Data.sectionId,
                leadSectionId: a.Data.leadSectionId,
                content: a.Data.contentTypes,
                userHasFullAccess: a.Data.userHasFullAccess,
                isOwner: a.Data.IsOwner,
                isManager: a.Data.isManager,
                associationId: 7,
                contextLabelId: 23,
                preview: false,
                layoutId: a.Data.layoutId,
                pendingInd: false
            });
            p3.rV(g, f, true)
        },
        Active: true
    }, {
        Id: 2,
        ContentId: 386,
        Label: "Topics",
        RoutePage: "topics",
        IconClass: "p3icon-topics",
        HTMLID: "topics-btn",
        LinkId: "topics-link",
        Display: function(f) {
            p3.rV(new e.Vs.TopicManageView({
                sectionId: a.Data.sectionId,
                leadSectionId: a.Data.leadSectionId,
                active: true,
                future: false,
                expired: false,
                userHasFullAccess: a.Data.userHasFullAccess,
                isOwner: a.Data.IsOwner,
                isManager: a.Data.isManager,
                content: a.Data.contentTypes,
                levelNum: a.Data.levelNum || -1,
                durationId: a.Data.durationId,
                schoolYearLabel: a.Data.schoolYear,
                contextLabelId: 23
            }), f, true)
        },
        Active: false
    }, {
        Id: 8,
        ContentId: 434,
        Label: "Residents",
        RoutePage: "residents",
        IconClass: "p3icon-roster",
        Display: function(f) {
            p3.rV(new c.Vs.RosterView({
                sectionId: a.Data.sectionId,
                leadSectionId: a.Data.leadSectionId,
                durationId: a.Data.durationId,
                associationId: 7,
                enableSearch: true,
                isOwner: a.Data.IsOwner,
                buildingId: a.Data.buildingId
            }), f, true)
        },
        Active: false
    }];
    a.Data = {};
    a.Ms.Section = Bbm.extend({
        url: function() {
            return ""
        }
    });
    a.Cs.Section = Bbc.extend({
        model: a.Ms.Section,
        initialize: function(f, g) {
            this.sectionId = g.sectionId || 0
        },
        url: function() {
            return aP + "datadirect/SectionInfoView/?format=json&sectionId=" + this.sectionId + "&associationId=7"
        }
    });
    a.Ms.Content = Bbm.extend({
        idAttribute: "ContentId",
        url: function() {
            return ""
        }
    });
    a.Cs.Content = Bbc.extend({
        model: a.Ms.Content,
        initialize: function(f, g) {
            this.sectionId = g.sectionId || 0;
            this.leadSectionId = g.leadSectionId || 0
        },
        url: function() {
            return aP + "datadirect/GroupPossibleContentGet/?format=json&leadSectionId=" + this.leadSectionId
        }
    });
    a.Data = {};
    a.Data.leadSectionId = 0;
    a.Data.durationId = 0;
    a.Data.sectionId = 0;
    a.Data.contentTypes = null;
    a.Data.MainViewRendered = false;
    a.Data.RenderedSectionId = 0;
    a.Data.teacherId = 0;
    a.Vs.MainClassView = Bb.View.extend({
        template: "GroupPage/grouppage.mainview.template.html",
        initialize: function(f) {
            this.Containers = {};
            if (f) {
                a.Data.sectionId = a.Data.RenderedSectionId = this.SectionId = f.SectionId
            } else {
                a.Data.sectionId = a.Data.RenderedSectionId = this.SectionId = 0
            }
            a.Data.MainViewRendered = true
        },
        dispose: function() {
            a.Data.MainViewRendered = false
        },
        render: function(f) {
            var g = this;
            p3.fT(g.template, function(i) {
                g.$el.html(i({}));
                $(f).html(g.el);
                g.Containers.Navigation = $("#grouppagenavmenu");
                g.Containers.MainContent = $("#grouppagemaincontainer");
                var h = new a.Cs.Section({}, {
                    sectionId: g.SectionId
                });
                p3.rV(new a.Vs.NavigationView({
                    ParentView: g,
                    collection: h
                }), g.Containers.Navigation, false);
                h.fetch({
                    error: function() {
                        p3.displayError("Error loading section information")
                    }
                })
            })
        }
    });
    a.Vs.NavigationView = Bb.View.extend({
        template: "DormGroup/navigationmenu.template.html",
        initialize: function(f) {
            this.collection.bind("reset change", this.renderTemplate, this);
            this.Containers = {};
            if (f) {
                this.ParentView = f.ParentView
            }
            this.enableScrollNav()
        },
        dispose: function() {
            this.disableScrollNav()
        },
        renderTemplate: function() {
            var A = this,
                y, n, o, f, x, l, u, t, s, m, z, g, q, k, p, r, j, w, i = false,
                h, v = [];
            j = new Bbc(A.collection.filter(function(B) {
                return B.get("Current") === 1
            }));
            A.collection.each(function(B) {
                if ((B.get("Current") === 1) || ((j.length < 1) && (B.get("LeadSectionId") === B.get("Id")))) {
                    y = B.get("Teacher");
                    n = B.get("GroupName");
                    o = B.get("Identifier");
                    f = B.get("Block");
                    x = B.get("Room");
                    l = B.get("Duration");
                    m = B.get("DurationId");
                    k = B.get("Description");
                    u = B.get("Level");
                    if (B.get("Length") === 1) {
                        t = "1 Term"
                    } else {
                        t = B.get("Length") + " Terms"
                    }
                    s = B.get("LeadSectionId");
                    q = B.get("IsOwner");
                    p = B.get("IsManager");
                    z = B.get("TeacherId");
                    r = B.get("LayoutId");
                    g = B.get("building_id")
                }
            });
            a.Data.IsOwner = q;
            a.Data.isManager = p;
            a.Data.leadSectionId = s;
            a.Data.durationId = m;
            a.Data.teacherId = z;
            w = p3.Data.Context.getSelectedPersona().Id;
            a.Data.userHasFullAccess = (w === 3 && a.Data.IsOwner) || a.Data.isManager;
            a.Data.layoutId = r;
            a.Data.buildingId = g;
            if (y !== "" || o || f || x || l || m || k || u || t) {
                i = true
            }
            h = new a.Cs.Content({}, {
                sectionId: a.Data.sectionId,
                leadSectionId: a.Data.leadSectionId
            });
            h.fetch({
                error: function() {
                    p3.displayError("Error loading available content")
                },
                success: function() {
                    a.Data.contentTypes = h;
                    h.each(function(D) {
                        var C = D.get("ContentId"),
                            F, E = true,
                            G;
                        F = _.find(a.Pages, function(H) {
                            return H.ContentId === C
                        });
                        E = D.get("ShowContentType");
                        if (E & C === 386) {
                            E = a.Data.userHasFullAccess || D.get("EditorAccess");
                            if (!E) {
                                G = new e.Cs.Topic({}, {
                                    sectionId: 0,
                                    leadSectionId: a.Data.leadSectionId,
                                    active: true,
                                    future: false,
                                    expired: false
                                });
                                G.fetch({
                                    async: false,
                                    success: function() {
                                        if (G.length > 0) {
                                            E = true
                                        }
                                    },
                                    error: function() {
                                        p3.displayError("Error loading topics")
                                    }
                                })
                            }
                        }
                        if (F && E) {
                            v.push({
                                sort: F.Id,
                                title: F.Label,
                                iconClass: F.IconClass,
                                status: F.Active ? "active" : "inactive",
                                link: d.Us.getUrlById(23110, a.Data.sectionId + "/" + F.RoutePage),
                                pId: F.Id
                            });
                            F.Enabled = true
                        } else {
                            if (F) {
                                F.Enabled = false
                            }
                        }
                    });
                    v = _.sortBy(v, "sort");
                    p3.fT(A.template, function(C) {
                        A.$el.html(C({
                            Info: i,
                            Teacher: y,
                            GroupName: n,
                            Identifier: o,
                            Block: f,
                            Room: x,
                            Duration: l,
                            Level: u,
                            Length: t,
                            Description: k,
                            navigationItems: v
                        }))
                    });
                    var B = _.find(a.Pages, function(C) {
                        return C.Active
                    });
                    if (B && B.Enabled) {
                        B.Display($("#grouppagemaincontainer"))
                    }
                }
            });
            return this
        },
        events: {
            "click #section-description-toggle": "toggleDescription",
            "click [data-pid]": "switchTab"
        },
        render: function(f) {
            $(f).append(this.el);
            return this
        },
        toggleDescription: function(g) {
            var f = $("#section-description-content");
            if (f && f.filter(":visible").length) {
                f.hide(400)
            } else {
                f.show(400)
            }
            return false
        },
        switchTab: function(f) {
            if ($(f.currentTarget).attr("data-pid") === "4") {
                _.find(a.Pages, function(g) {
                    return g.Id === 4
                }).Display();
                return false
            }
        },
        enableScrollNav: function(h) {
            var g = $(document),
                f = $(".subnavbar"),
                i = f.length && f.offset().top - 120;

            function j() {
                if (f.length === 0) {
                    f = $(".subnavbar");
                    i = f.length && f.offset().top - 120
                }
                var l = g.scrollTop(),
                    k = f.hasClass("subnavbar-fixed");
                if (l >= i && !k) {
                    f.addClass("subnavbar-fixed")
                } else {
                    if (l <= i && k) {
                        f.removeClass("subnavbar-fixed")
                    }
                }
            }
            g.on("scroll", j)
        },
        disableScrollNav: function(g) {
            var f = $(document);
            f.off("scroll")
        }
    });
    a.Us.LoadPage = function(f, h) {
        a.Data.studentId = undefined;
        p3.loadingIcon("#grouppagemaincontainer");
        var g;
        _.each(a.Pages, function(i) {
            if (i.RoutePage.toLowerCase() === h.toLowerCase()) {
                i.Active = true;
                g = i
            } else {
                i.Active = false
            }
        });
        if (!a.Data.MainViewRendered || a.Data.RenderedSectionId !== f) {
            p3.renderMainPage(new a.Vs.MainClassView({
                SectionId: f
            }))
        } else {
            if (g) {
                g.Display($("#grouppagemaincontainer"));
                a.Us.SwitchTabs(g)
            } else {
                if (g && g.Enabled) {
                    g.Display($("#grouppagemaincontainer"));
                    a.Us.SwitchTabs(g)
                }
            }
        }
    };
    a.Us.SwitchTabs = function(g) {
        var f = (p3.Config.uiVersion === 1) ? $(".nav-pills").children() : $(".nav-tabs").children();
        $.each(f, function() {
            var h = $(this);
            if (h.data("pid") === g.Id) {
                h.removeClass("inactive");
                h.addClass("active")
            } else {
                if (h.hasClass("active")) {
                    h.removeClass("active");
                    h.addClass("inactive")
                }
            }
        })
    };
    p3.router().route("dormpage/:id/:page", "dormpage", a.Us.LoadPage)
}(p3.module("dormpage")));
(function(a) {
    var b = p3.module("shared/task");
    a.Cs.GroupsByYear = Bbc.extend({
        url: "datadirect/GroupFinderByYear"
    });
    a.Cs.SchoolYears = Bbc.extend({
        url: "datadirect/SchoolYearsGet"
    });
    a.Data = {
        selectedSchoolYear: "",
        selectedMode: "",
        yearSuffix: " groups",
        yearSuffixCurrent: " groups (current term)",
        yearSuffixAll: " groups (all terms)"
    };
    a.Vs.Layout = Bb.View.extend({
        template: "GroupFinder/groupfinder.layout.template.html",
        itemTemplate: "GroupFinder/groupfinder.item.template.html",
        className: "group-finder-ch",
        events: {
            click: "preventClickHandlers",
            "change #group-finder-year-selector": "setYear"
        },
        initialize: function() {
            var c = this;
            a.Data.selectedSchoolYear = p3.Data.SchoolContext.get("CurrentSchoolYear").SchoolYearLabel;
            a.Data.selectedMode = "current";
            c.SchoolYears = new a.Cs.SchoolYears();
            c.collection = new a.Cs.GroupsByYear();
            a.Us.getCurrentGroups(c.collection)
        },
        render: function(c) {
            var d = this;
            $(c).html(d.el);
            this.SchoolYears.fetch({
                success: function(e) {
                    d.renderTemplate()
                }
            })
        },
        renderTemplate: function() {
            var e = this,
                d, c = b.Us.getUrlById(53549, "");
            p3.fT(e.itemTemplate, function(f) {
                e.itemTmpl = f;
                p3.fT(e.template, function(g) {
                    e.$el.html(g({
                        years: e.SchoolYears.toJSON(),
                        yearSuffix: a.Data.yearSuffix,
                        yearSuffixCurrent: a.Data.yearSuffixCurrent,
                        yearSuffixAll: a.Data.yearSuffixAll,
                        listHash: c
                    }));
                    p3.Us.PluginManager.Load(p3.Us.PluginManager.Plugins.jQueryUI, function() {
                        e.initializeAutoComplete()
                    });
                    d = (a.Data.selectedMode === "current") ? a.Data.selectedSchoolYear + a.Data.yearSuffixCurrent : ((a.Data.selectedMode === "all") ? a.Data.selectedSchoolYear + a.Data.yearSuffixAll : a.Data.selectedSchoolYear + a.Data.yearSuffix);
                    $("#group-finder-year-selector").val(d)
                })
            })
        },
        initializeAutoComplete: function() {
            var d = this,
                c = $("#group-finder-search-box");
            if (c.length < 1) {
                if (a._autocompleteTimer) {
                    window.clearInterval(a._autocompleteTimer);
                    a._autocompleteTimer = null
                }
                a._autocompleteTimer = window.setInterval(function() {
                    if (c.length > 0) {
                        d.OnReadyAutoComplete();
                        window.clearInterval(a._autocompleteTimer);
                        a._autocompleteTimer = null
                    }
                }, 100)
            } else {
                d.OnReadyAutoComplete()
            }
        },
        OnReadyAutoComplete: function() {
            var e = this,
                f, d = "#group-finder-search-box",
                c = $(d);
            c.autocomplete({
                appendTo: c.parent(),
                userAll: null,
                minLength: 2,
                previousSearch: "",
                source: function(i, j) {
                    var h = new RegExp($.ui.autocomplete.escapeRegex(this.term), "i"),
                        g = -1;
                    j($.map(e.collection.toJSON(), function(k) {
                        if (k.group_name.match(h) && ((a.Data.selectedMode !== "current") || (a.Data.selectedMode === "current" && k.current_ind === 1))) {
                            if (k.association_id !== g) {
                                k.showHeader = true;
                                g = k.association_id
                            }
                            return {
                                value: k.group_name,
                                object: k
                            }
                        }
                    }))
                },
                select: function(g, h) {
                    a.Us.accessGroupPage(h.item.object.lead_pk, h.item.object.association_id);
                    c.val("");
                    return false
                }
            });
            f = c.autocomplete({}).data("ui-autocomplete");
            if (f) {
                f._renderItem = function(h, g) {
                    return $("<li>").attr("data-value", g.value).append(e.itemTmpl({
                        item: g
                    })).appendTo(h)
                };
                f._resizeMenu = function() {
                    var l = $(d).width(),
                        g = $("#GroupFinderContainer li"),
                        k = 8,
                        m = (g.length < k) ? g.length : k,
                        j = 0,
                        h;
                    if (m > 0) {
                        for (h = 0; h < m; h++) {
                            j = j + $(g[h]).height()
                        }
                        this.menu.element.css({
                            minWidth: l + "px",
                            minHeight: j + "px"
                        })
                    } else {
                        this.menu.element.css({
                            minWidth: l + "px"
                        })
                    }
                }
            }
        },
        preventClickHandlers: function(c) {
            if (!$(c.target).closest("ul").hasClass("ui-autocomplete") && $(c.curretTarget).find(c.target).length === 0) {
                c.stopPropagation()
            }
        },
        setYear: function(f) {
            var d = $(f.currentTarget),
                c, g;
            c = $("option:selected", d);
            g = c.data("label");
            a.Data.selectedMode = c.data("mode");
            if (g !== a.Data.selectedSchoolYear) {
                a.Data.selectedSchoolYear = g;
                a.Us.getCurrentGroups(this.collection)
            }
        }
    });
    a.Us.getCurrentGroups = function(c) {
        c.fetch({
            data: {
                schoolYearLabel: a.Data.selectedSchoolYear
            }
        })
    };
    a.Us.accessGroupPage = function(d, c) {
        var e, g = p3.Config.AppMode === p3.Us.Enum.AppModes.WEBAPP,
            f;
        if (c === 2) {
            e = {
                id: 4,
                name: "Team Page",
                type: "route",
                method: undefined,
                route: "teampage"
            }
        } else {
            e = {
                id: 2,
                name: "Bulletin Board",
                type: "route",
                method: undefined,
                route: "bulletinboard"
            }
        }
        switch (c) {
            case 1:
                if (g) {
                    p3.router().navigate("academicclass/" + d + "/0/" + e.route, true)
                } else {
                    window.location.href = p3.Config.RootPath + "#academicclass/" + d + "/0/" + e.route
                }
                break;
            case 2:
                if (g) {
                    p3.router().navigate("athleticteam/" + d + "/" + e.route, true)
                } else {
                    window.location.href = p3.Config.RootPath + "#athleticteam/" + d + "/" + e.route
                }
                break;
            case 9:
                if (e.route === "roster") {
                    e.route = "advisees"
                }
                if (g) {
                    p3.router().navigate("advisorypage/" + d + "/" + e.route, true)
                } else {
                    window.location.href = p3.Config.RootPath + "#advisorypage/" + d + "/" + e.route
                }
                break;
            case 3:
                if (g) {
                    p3.router().navigate("communitypage/" + d + "/" + e.route, true)
                } else {
                    window.location.href = p3.Config.RootPath + "#communitypage/" + d + "/" + e.route
                }
                break;
            case 8:
                if (g) {
                    p3.router().navigate("activitypage/" + d + "/" + e.route, true)
                } else {
                    window.location.href = p3.Config.RootPath + "#activitypage/" + d + "/" + e.route
                }
                break;
            case 7:
                if (e.route === "roster") {
                    e.route = "residents"
                }
                if (g) {
                    p3.router().navigate("dormpage/" + d + "/" + e.route, true)
                } else {
                    window.location.href = p3.Config.RootPath + "#dormpage/" + d + "/" + e.route
                }
                break;
            default:
                f = 247;
                if (c === 4) {
                    f = 250
                } else {
                    if (c === 5) {
                        f = 456
                    } else {
                        if (c === 3) {
                            f = 247
                        } else {
                            if (c === 8) {
                                f = 23139
                            }
                        }
                    }
                }
                window.location = b.Us.getUrlById(f) + "&pk=" + d + "&cs=1&glt=0&cuid=0&cid=-1";
                break
        }
    }
}(p3.module("LMS/shared/GroupFinder")));
(function(c) {
    var a = p3.Us.Enum,
        b = p3.Us.InfoMessageLibrary,
        d = p3.module("utilities/smodal");
    c.Ms.Tool = Bbm.extend({
        idAttribute: "ToolId",
        urlRoot: "LtiTool/Edit/",
        defaults: {
            ToolTitle: "",
            ToolDescription: "",
            LaunchUrl: null,
            ConsumerKey: null,
            SharedSecret: null,
            ProviderId: 0,
            ConsentScreenInd: null,
            OutcomesInd: null,
            MessagesInd: null,
            SendUserName: null,
            SendUserEmail: null,
            SendUserRole: null,
            SendUserImage: null,
            PresentationTarget: null,
            PresentationHeight: null,
            PresentationWidth: null
        },
        validation: {
            ProviderId: [{
                min: 1,
                msg: b.P3.RequiredInfoNotEntered
            }],
            ToolTitle: [{
                required: true,
                msg: b.P3.RequiredInfoNotEntered
            }],
            LaunchUrl: [{
                required: function(g, e, f) {
                    return !(this.determineCredentialsTypeId(f).toString() === a.LtiCredentialsType.FIXED.toString())
                },
                msg: b.P3.RequiredInfoNotEntered
            }],
            ConsumerKey: [{
                required: function(g, e, f) {
                    return this.determineCredentialsTypeId(f).toString() === a.LtiCredentialsType.PERLINK.toString()
                },
                msg: b.P3.RequiredInfoNotEntered
            }]
        },
        determineCredentialsTypeId: function(e) {
            var f = -1;
            if (e.CredentialsTypeId !== null && e.CredentialsTypeId !== undefined) {
                f = e.CredentialsTypeId
            }
            return f
        },
        modifyLaunchUrl: function() {
            var e = true,
                f;
            f = this.get("CredentialsTypeId");
            if (f !== null && f !== undefined) {
                e = f.toString() !== a.LtiCredentialsType.FIXED.toString()
            }
            return e
        },
        changeProvider: function(e) {
            var f = this;
            f.set("ProviderId", null);
            f.set("ToolTitle", null);
            f.set("ToolDescription", null);
            f.set("LtiVersionId", null);
            f.set("LaunchUrl", null);
            f.set("ConsumerKey", null);
            f.set("SharedSecret", null);
            f.set("ConsentScreenInd", null);
            f.set("OutcomesInd", null);
            f.set("MessagesInd", null);
            f.set("SendUserName", null);
            f.set("SendUserEmail", null);
            f.set("SendUserRole", null);
            f.set("SendUserImage", null);
            f.set("PresentationTarget", null);
            f.set("PresentationHeight", null);
            f.set("PresentationWidth", null);
            f.set("CredentialsTypeId", null);
            if (e) {
                f.set("ProviderId", e.get("ProviderId"));
                this.syncWithProvider(e)
            }
        },
        syncWithProvider: function(e) {
            var f = this;
            if (e && e.get("ProviderId")) {
                f.set("CredentialsTypeId", e.get("CredentialsTypeId"));
                f.syncProperty(e, "ChangePresentationFlag", "PresentationTarget");
                f.syncProperty(e, "ChangePresentationFlag", "PresentationHeight");
                f.syncProperty(e, "ChangePresentationFlag", "PresentationWidth");
                f.syncProperty(e, "ChangeMessagesFlag", "MessagesInd");
                f.syncProperty(e, "ChangeConsentScreenFlag", "ConsentScreenInd");
                f.syncProperty(e, "ChangePrivacyFlag", "SendUserName");
                f.syncProperty(e, "ChangePrivacyFlag", "SendUserEmail");
                f.syncProperty(e, "ChangePrivacyFlag", "SendUserRole");
                f.syncProperty(e, "ChangePrivacyFlag", "SendUserImage");
                f.syncProperty(e, "ChangeParameterFlag", "ParameterInd");
                f.syncProperty(e, "ChangeXmlFlag", "XmlInd")
            }
        },
        syncProperty: function(h, e, g) {
            var i = this,
                f;
            f = (h.get(e).toString() === a.LtiChangeFlag.TOOLLEVEL.toString());
            if (!f) {
                i.set(g, null)
            } else {
                if (this.get(g) === null) {
                    i.set(g, h.get(g))
                }
            }
        },
        processXml: function(p, j) {
            var k = this,
                q, f, g, m = [],
                n, h, o, l = false;
            if (p) {
                try {
                    q = $.parseXML(p);
                    if (q) {
                        f = $(q).find("cartridge_basiclti_link");
                        if (f.length > 0) {
                            f.each(function(e, r) {
                                if (!l) {
                                    k.set("ToolTitle", $(r).find("blti\\:title, title").text());
                                    k.set("ToolDescription", $(r).find("blti\\:description, description").text());
                                    if (k.modifyLaunchUrl()) {
                                        k.set("LaunchUrl", $(r).find("blti\\:launch_url, launch_url").text())
                                    }
                                    g = $(r).find("blti\\:custom, custom");
                                    if (g.length > 0) {
                                        g.each(function(s, t) {
                                            h = $(t).find("lticm\\:property, property");
                                            o = h.text();
                                            n = h.attr("name");
                                            if (o && n) {
                                                m.push({
                                                    PName: n,
                                                    PVal: o
                                                })
                                            }
                                        })
                                    }
                                    k.set("Parameters", m);
                                    l = true
                                }
                            })
                        } else {
                            p3.displayError("Cannot locate Learning Tool in XML")
                        }
                    }
                } catch (i) {
                    p3.displayError("Cannot parse the XML")
                }
            }
            return l
        }
    });
    c.Ms.Provider = Bbm.extend({
        placementsHaveEditableLaunchUrl: function() {
            var e = this;
            return (e.get("CredentialsTypeId") === 0 || e.get("CredentialsTypeId") === 1)
        },
        placementsHaveEditableConsumerKey: function() {
            var e = this;
            return (e.get("CredentialsTypeId") === 0)
        },
        placementsHaveEditableSharedSecret: function() {
            var e = this;
            return (e.get("CredentialsTypeId") === 0)
        },
        placementsHaveEditableParameters: function() {
            var e = this;
            return (e.get("ParameterInd") || false)
        }
    });
    c.Cs.ltiProviderPicklist = Bbc.extend({
        model: c.Ms.Provider,
        url: "LtiTool/ProviderList/",
        createPickList: function(e) {
            e = e || 0;
            var f = new c.Cs.ltiProviderPicklist(this.filter(function(g) {
                return (g.get("ActiveInd") === true || g.get("ProviderId") === e)
            }));
            return [{
                ProviderName: "-- select a provider --",
                ProviderId: 0,
                ActiveInd: true
            }].concat(f.toJSON())
        },
        locateProvider: function(g) {
            var f, e;
            e = parseInt(g, 10);
            f = _.first(this.where({
                ProviderId: e
            }));
            if (!f) {
                f = new Bbm()
            }
            return f
        },
        firstActiveProvider: function() {
            var e;
            e = _.first(this.where({
                ActiveInd: true
            }));
            if (!e) {
                e = new Bbm()
            }
            return e
        },
        ltiProvidersAvailableCount: function(e) {
            e = e || 0;
            var f = new c.Cs.ltiProviderPicklist(this.filter(function(g) {
                return (g.get("ActiveInd") === true || g.get("ProviderId") === e)
            }));
            return (f.length)
        }
    });
    c.Vs.EditTool = d.Vs.Modal2.extend({
        template: "lti/lti.tool.edit.layout.template.html",
        selector: "id",
        loadedId: 0,
        modalRendered: function() {
            var f = this,
                e;
            switch (f.model.get("ContextLabelId")) {
                case 27:
                    e = a.LtiProviderScope.TOPIC;
                    break;
                case 5:
                    e = a.LtiProviderScope.ASSIGNMENT;
                    break;
                default:
                    e = a.LtiProviderScope.ALL;
                    break
            }
            f.ltiProviders = new c.Cs.ltiProviderPicklist();
            f.ltiProviders.fetch({
                data: {
                    scope: e
                },
                success: function() {
                    f.selectedProvider = f.ltiProviders.locateProvider(f.model.get("ProviderId"));
                    f.model.syncWithProvider(f.selectedProvider);
                    f.renderTemplate()
                },
                error: function() {
                    p3.displayError("Error loading the provider list")
                }
            })
        },
        renderTemplate: function() {
            var e = this;
            e.generalView = new c.Vs.EditToolGeneral({
                parentView: e,
                model: e.model
            });
            p3.rV(e.generalView, e.$("#general"), true);
            p3.setModalHeight(p3.Layout.Containers.Modal)
        },
        modalUpdate: function(g) {
            var j = this,
                e = $(g.eventCurrentTarget),
                h, k, f, i = true;
            f = e.attr(j.selector);
            if (f === "ProviderId") {
                h = parseInt(e.val(), 10);
                j.selectedProvider = j.ltiProviders.locateProvider(h);
                $(".tooltip").remove();
                j.model.changeProvider(j.selectedProvider);
                j.renderTemplate();
                i = false
            } else {
                if (f === "XmlValue") {
                    k = e.val();
                    if (k.length > 0) {
                        if (j.model.processXml(k, j.ltiProviders) === true) {
                            $(".tooltip").remove();
                            j.renderTemplate()
                        }
                    }
                }
            }
            return i
        },
        modalSave: function() {
            var f = this,
                e;
            e = f.model.isValid(true);
            e = c.Us.ValidateParameterList(f, f.model, "Parameters", e);
            return e
        },
        modalSavedError: function(e) {
            p3.displayError("There was an error saving the Learning Tool. (" + e.error.responseText + ")")
        },
        modalSavedSucess: function(e) {
            var f = this;
            f.trigger("ltiToolSaved")
        }
    });
    c.Vs.EditToolGeneral = Bb.View.extend({
        template: "lti/lti.tool.edit.general.template.html",
        initialize: function(e) {
            var f = this;
            f.parentView = f.options.parentView
        },
        render: function(e) {
            var f = this;
            $(e).html(f.el);
            f.renderData()
        },
        renderData: function() {
            var f = this,
                e;
            e = c.Us.PresentationTargetPickList(f.parentView.selectedProvider.get("PresentationTargetOptions"));
            p3.fT(f.template, function(g) {
                f.$el.html(g({
                    model: f.model.toJSON(),
                    provider: f.parentView.selectedProvider.toJSON(),
                    providerlist: f.parentView.ltiProviders.createPickList(f.model.get("ProviderId")),
                    targets: e.toJSON()
                }));
                if (f.parentView.selectedProvider.get("ChangeParameterFlag") === 2) {
                    f.listView = new c.Vs.EditToolGeneralList({
                        model: f.model
                    });
                    p3.rV(f.listView, f.$("#param-list-area"), true);
                    p3.setModalHeight(p3.Layout.Containers.Modal)
                }
            })
        }
    });
    c.Vs.EditToolGeneralList = Bb.View.extend({
        id: "param-list",
        initialize: function() {
            this.paramList = this.model.get("Parameters")
        },
        events: {
            "blur .param-input-field": "appendEmptyListItemIfNeeded"
        },
        render: function(e) {
            var f = this;
            $(e).html(f.el);
            f.renderData()
        },
        renderData: function() {
            var f = this,
                e;
            _.each(f.paramList, function(g) {
                e = new c.Vs.EditToolGeneralListItem({
                    model: g
                });
                p3.rV(e, f.$el, false)
            });
            f.appendEmptyListItem();
            p3.setModalHeight(p3.Layout.Containers.Modal)
        },
        appendEmptyListItemIfNeeded: function(g) {
            var m = this,
                f = m.$el,
                h = $(f).children(":last"),
                j, l, i, k;
            if (h) {
                j = $(h).find("input.pname-field");
                l = $(h).find("input.pval-field");
                i = j ? j.val() : null;
                k = l ? l.val() : null;
                if (i.length > 0 || k.length > 0) {
                    $(h).find(".param-delete-button").show();
                    m.appendEmptyListItem()
                }
            }
        },
        appendEmptyListItem: function() {
            var f = this,
                e;
            e = new c.Vs.EditToolGeneralListItem();
            p3.rV(e, f.$el, false)
        }
    });
    c.Vs.EditToolGeneralListItem = Bb.View.extend({
        template: "lti/lti.tool.edit.general.param.template.html",
        className: "param-entry",
        events: {
            "click .param-delete-button": "removeListItem"
        },
        render: function(e) {
            var f = this;
            $(e).append(f.el);
            f.renderData()
        },
        renderData: function() {
            var e = this;
            p3.fT(e.template, function(f) {
                e.$el.html(f({
                    model: (e.model || null)
                }));
                p3.setModalHeight(p3.Layout.Containers.Modal)
            })
        },
        removeListItem: function(f) {
            f.preventDefault();
            this.unbind();
            this.remove();
            p3.setModalHeight(p3.Layout.Containers.Modal)
        }
    });
    c.Us.IsLtiInstalled = function() {
        return p3.Data.SchoolContext.hasAppCategory(p3.Us.Enum.AppCategories.LTI)
    };
    c.Us.ValidateParameterList = function(m, h, f, g) {
        var e, k, l, i = [],
            j = true;
        m.$el.find("#param-area").removeClass("error");
        m.$el.find(".pname-field").removeClass("box-validate");
        m.$el.find(".pval-field").removeClass("box-validate");
        e = $(".param-entry");
        if (e.length > 0) {
            _.each(e, function(n) {
                k = $(n).find(".pname-field").val();
                l = $(n).find(".pval-field").val();
                if (k || l) {
                    if (k && l) {
                        i.push(new Bbm({
                            PName: k,
                            PVal: l
                        }))
                    } else {
                        if (!k) {
                            $(n).find(".pname-field").addClass("box-validate")
                        }
                        if (!l) {
                            $(n).find(".pval-field").addClass("box-validate")
                        }
                        j = false
                    }
                }
            })
        }
        if (!j) {
            m.$el.find("#param-area").addClass("error")
        }
        h.set(f, i);
        return (g && j)
    };
    c.Us.BuildLaunchUrl = function(i, h, e, f) {
        var g;
        g = window.location.protocol + "//" + window.location.host + "/Api/Lti/Launch";
        g = g + "?tid=" + encodeURIComponent(i);
        g = g + "&pt=" + encodeURIComponent(h);
        g = g + "&cid=" + encodeURIComponent(e);
        g = g + "&cvl=" + encodeURIComponent(f);
        g = g + "&format=html";
        return g
    };
    c.Us.PresentationTargetPickList = function(f) {
        var e = new Bbc();
        if (!(f > 0)) {
            f = 0
        }
        if ((f & 8) > 0) {
            e.push(new Bbm({
                targetId: a.LtiPresentationTargets.Embed.id,
                targetTitle: a.LtiPresentationTargets.Embed.name
            }))
        }
        if ((f & 2) > 0) {
            e.push(new Bbm({
                targetId: a.LtiPresentationTargets.New.id,
                targetTitle: a.LtiPresentationTargets.New.name
            }))
        }
        if ((f & 4) > 0) {
            e.push(new Bbm({
                targetId: a.LtiPresentationTargets.Popup.id,
                targetTitle: a.LtiPresentationTargets.Popup.name
            }))
        }
        if ((f & 1) > 0) {
            e.push(new Bbm({
                targetId: a.LtiPresentationTargets.Redirect.id,
                targetTitle: a.LtiPresentationTargets.Redirect.name
            }))
        }
        return e
    };
    c.Us.OpenToolModal = function(j, l, f, g, h, e) {
        var k, i;
        if ((j === "Add" || j === "Edit") && f > 0 && g > 0) {
            if (j === "Add") {
                k = new c.Ms.Tool({
                    ContextLabelId: f,
                    ContextValue: g,
                    Gradeable: h
                });
                i = new c.Vs.EditTool({
                    model: k
                });
                p3.rV(i, p3.Layout.Containers.Modal, true);
                p3.showModal(p3.Layout.Containers.Modal, {});
                if (e) {
                    e(i)
                }
            } else {
                k = new c.Ms.Tool();
                k.fetch({
                    data: {
                        id: l
                    },
                    success: function() {
                        k.set("ContextLabelId", f);
                        k.set("ContextValue", g);
                        k.set("Gradeable", h);
                        i = new c.Vs.EditTool({
                            model: k
                        });
                        p3.rV(i, p3.Layout.Containers.Modal, true);
                        p3.showModal(p3.Layout.Containers.Modal, {});
                        if (e) {
                            e(i)
                        }
                    },
                    error: function() {
                        p3.displayError("Error loading the learning tool")
                    }
                })
            }
        } else {
            p3.displayError("Error opening the learning tool")
        }
    }
}(p3.module("shared/ltitool")));
(function(b) {
    var a = p3.module("shared/filterableviews/filterableviews");
    b.Vs.Layout = Bb.View.extend({
        template: "UserGroupList/usergrouplist.layout.template.html",
        render: function(c) {
            var e = this,
                d = "Group finder";
            p3.setTitle(d);
            p3.fT(e.template, function(f) {
                e.$el.appendTo(c).html(f());
                e.Containers = {
                    Header: e.$("#header"),
                    List: e.$("#group-list-container")
                };
                e.Containers.Header.addClass("subhead").append($('<H1 class="was-jmbtrn">').html(d));
                e.filterView = a.Us.RenderList({
                    Container: e.Containers.List,
                    DefinitionUrl: "FilterableViews/UserGroupListDefintion/",
                    ResultUrl: "FilterableViews/UserGroupListGet/",
                    Title: "group",
                    DataKey: "usergrouplist",
                    HideTitle: true
                })
            })
        }
    });
    p3.router().route("usergrouplist", "usergrouplist", function() {
        p3.setTitle("Groups List");
        p3.renderMainPage(new b.Vs.Layout())
    })
}(p3.module("LMS/shared/UserGroupList")));
var podiumApp = p3,
    aP = p3.Config.ApiRootPath;
p3.Utilities = p3.Us;
